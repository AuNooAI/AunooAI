{% extends "base.html" %}

{% block title %}Auspex Status{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="fas fa-robot me-2" style="color: #FF69B4;"></i>
        Auspex 2.0 Status
    </h1>

    <div class="row">
        <!-- System Status -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>System Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="systemStatus">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Checking system status...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Status -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tools me-2"></i>Tools Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="toolsStatus">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Testing tools...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Chat Sessions -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>Chat Sessions
                    </h5>
                </div>
                <div class="card-body">
                    <div id="chatStatus">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Checking chat sessions...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Test -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-vial me-2"></i>Quick Test
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary mb-3" onclick="createTestChat()">
                        <i class="fas fa-plus me-2"></i>Create Test Chat
                    </button>
                    <button class="btn btn-success" onclick="runFullTest()">
                        <i class="fas fa-play me-2"></i>Run Full Test
                    </button>
                    <div id="testResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- How to Use -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>How to Use Auspex 2.0
                    </h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li><strong>Open Auspex Chat:</strong> Click the floating chat button (ðŸ¤–) in the bottom-right corner</li>
                        <li><strong>Select Topic & Model:</strong> Choose a topic and AI model from the dropdowns</li>
                        <li><strong>Start Chatting:</strong> Ask questions about your topic - Auspex will automatically use tools to gather data</li>
                        <li><strong>Tool Keywords:</strong> Use words like "latest", "recent", "sentiment", "categories" to trigger specific tools</li>
                        <li><strong>Chat History:</strong> Your conversations are saved and will reload when you return to the same topic</li>
                        <li><strong>Manage Prompts:</strong> Click the brain icon (ðŸ§ ) in the chat header to customize Auspex's behavior</li>
                    </ol>
                    
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-lightbulb me-2"></i>Example Queries:</h6>
                        <ul class="mb-0">
                            <li>"What's the latest news on AI?"</li>
                            <li>"How do people feel about this topic?"</li>
                            <li>"What categories of articles do we have?"</li>
                            <li>"Analyze the sentiment trends this month"</li>
                            <li>"Show me recent developments"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load status when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStatus();
    loadToolsStatus();
    loadChatStatus();
});

async function loadSystemStatus() {
    try {
        const response = await fetch('/api/auspex/system/info');
        const data = await response.json();
        
        document.getElementById('systemStatus').innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Version:</span>
                <span class="badge bg-primary">${data.version}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Status:</span>
                <span class="badge bg-success">${data.status}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Topics:</span>
                <span class="badge bg-info">${data.available_topics?.length || 0}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Prompts:</span>
                <span class="badge bg-warning">${data.available_prompts}</span>
            </div>
            <hr>
            <h6>Features:</h6>
            ${Object.entries(data.features).map(([key, value]) => `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small>${key.replace(/_/g, ' ')}:</small>
                    <span class="badge ${value ? 'bg-success' : 'bg-danger'}">${value ? 'âœ“' : 'âœ—'}</span>
                </div>
            `).join('')}
        `;
    } catch (error) {
        document.getElementById('systemStatus').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading system status: ${error.message}
            </div>
        `;
    }
}

async function loadToolsStatus() {
    try {
        const response = await fetch('/api/test/auspex-tools');
        const data = await response.json();
        
        let html = `<div class="d-flex justify-content-between align-items-center mb-3">
            <span>Tools Tested:</span>
            <span class="badge bg-primary">${data.tools_tested}</span>
        </div>`;
        
        Object.entries(data.results).forEach(([tool, result]) => {
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${tool.replace(/_/g, ' ')}:</span>
                    <span class="badge ${result.success ? 'bg-success' : 'bg-warning'}">
                        ${result.success ? 'âœ“' : 'âš '}
                    </span>
                </div>
                ${!result.success && result.error ? `<small class="text-muted">${result.error}</small>` : ''}
                ${result.article_count !== undefined ? `<small class="text-muted">Articles: ${result.article_count}</small>` : ''}
            `;
        });
        
        document.getElementById('toolsStatus').innerHTML = html;
    } catch (error) {
        document.getElementById('toolsStatus').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error testing tools: ${error.message}
            </div>
        `;
    }
}

async function loadChatStatus() {
    try {
        const response = await fetch('/api/test/auspex-chat-sessions');
        const data = await response.json();
        
        let html = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>User ID:</span>
                <span class="badge bg-info">${data.user_id}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Sessions:</span>
                <span class="badge bg-primary">${data.session_count}</span>
            </div>
        `;
        
        if (data.sessions && data.sessions.length > 0) {
            html += '<hr><h6>Recent Sessions:</h6>';
            data.sessions.forEach(session => {
                html += `
                    <div class="mb-2 p-2 bg-light rounded">
                        <small><strong>${session.title}</strong></small><br>
                        <small class="text-muted">Topic: ${session.topic}</small><br>
                        <small class="text-muted">Created: ${new Date(session.created_at).toLocaleString()}</small>
                    </div>
                `;
            });
        }
        
        document.getElementById('chatStatus').innerHTML = html;
    } catch (error) {
        document.getElementById('chatStatus').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading chat status: ${error.message}
            </div>
        `;
    }
}

async function createTestChat() {
    try {
        const response = await fetch('/api/test/create-test-chat', { method: 'POST' });
        const data = await response.json();
        
        if (data.status === 'success') {
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check me-2"></i>
                    Test chat created successfully! Chat ID: ${data.chat_id}
                </div>
            `;
            loadChatStatus(); // Refresh chat status
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    } catch (error) {
        document.getElementById('testResults').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error creating test chat: ${error.message}
            </div>
        `;
    }
}

async function runFullTest() {
    document.getElementById('testResults').innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Running full test...
        </div>
    `;
    
    // Reload all status panels
    await Promise.all([
        loadSystemStatus(),
        loadToolsStatus(),
        loadChatStatus()
    ]);
    
    document.getElementById('testResults').innerHTML = `
        <div class="alert alert-success">
            <i class="fas fa-check me-2"></i>
            Full test completed! Check the status panels above.
        </div>
    `;
}
</script>

<style>
.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75em;
}

.alert {
    border: none;
    border-radius: 8px;
}

.bg-light {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %} 