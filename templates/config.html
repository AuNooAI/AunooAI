{% extends "base.html" %}

{% block content %}
<h1>Configuration</h1>

<!-- Add tab navigation -->
<ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="providers-tab" data-bs-toggle="tab" data-bs-target="#providers" type="button" role="tab">
            <i class="fas fa-plug"></i> Providers
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="ai-models-tab" data-bs-toggle="tab" data-bs-target="#ai-models" type="button" role="tab">
            <i class="fas fa-robot"></i> AI Models
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab">
            <i class="fas fa-database"></i> Database
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
            <i class="fas fa-lock"></i> Security
        </button>
    </li>
</ul>

<!-- Tab content -->
<div class="tab-content" id="configTabContent">
    <!-- Database Management Tab -->
    <div class="tab-pane fade show active" id="database" role="tabpanel">
        <div class="config-layout">
            <div class="left-panel">
                <h2>Database Management</h2>
                <div class="config-item">
                    <h3>Active Database</h3>
                    <select id="active-database">
                        <option value="">Select active database</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="config-item">
                    <h3>Available Databases</h3>
                    <ul id="database-list">
                        <!-- Database list will be populated dynamically -->
                    </ul>
                </div>
                <div class="config-item">
                    <h3>New Database</h3>
                    <form id="create-database-form">
                        <input type="text" id="database-name" placeholder="Enter database name" required>
                        <button type="submit">Create Database</button>
                    </form>
                </div>
                <div class="config-item">
                    <h3>Database Operations</h3>
                    <div class="database-operations">
                        <button id="backup-database" onclick="backupDatabase()">Backup Database</button>
                        <button id="download-database" onclick="showDownloadDialog()">Download Database</button>
                        <button id="reset-database" class="danger" onclick="resetDatabase()">Reset Database</button>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <h2>Database Information</h2>
                <div id="database-info" class="info-panel">
                    <div class="info-group">
                        <div class="info-item">
                            <span class="info-label">Database Name:</span>
                            <span class="info-value" id="db-name">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Size:</span>
                            <span class="info-value" id="db-size">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Articles:</span>
                            <span class="info-value" id="total-articles">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Last Entry:</span>
                            <span class="info-value" id="last-entry">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">First Entry:</span>
                            <span class="info-value" id="first-entry">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Topics:</span>
                            <span class="info-value" id="total-topics">Loading...</span>
                        </div>
                    </div>
                    
                    <h3 class="mt-4">Database Tables</h3>
                    <div class="table-info">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Table Name</th>
                                    <th>Row Count</th>
                                </tr>
                            </thead>
                            <tbody id="table-info">
                                <tr>
                                    <td colspan="2">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Models Tab -->
    <div class="tab-pane fade" id="ai-models" role="tabpanel">
        <div class="config-layout">
            <div class="left-panel">
                <h2>AI Model Configuration</h2>
                <form id="add-model-form">
                    <select id="model-name" required>
                        <option value="">Select a model</option>
                        {% for model in models %}
                            <option value="{{ model.name }}" data-provider="{{ model.provider }}">{{ model.name }} ({{ model.provider }})</option>
                        {% endfor %}
                    </select>
                    <input type="text" id="api-key" placeholder="API Key" required>
                    <button type="submit">Add Model</button>
                </form>
            </div>
            <div class="right-panel">
                <h2>Available Models</h2>
                <ul id="model-list">
                    <!-- This will be populated dynamically -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Providers Tab -->
    <div class="tab-pane fade" id="providers" role="tabpanel">
        <div class="config-layout">
            <div class="left-panel">
                <h2>Article Provider Configuration</h2>
                <form id="provider-config-form">
                    <select id="provider-name" required>
                        <option value="">Select a provider</option>
                        <!-- Will be populated dynamically -->
                    </select>
                    <input type="text" id="provider-key" placeholder="API Key" required>
                    <button type="submit">Add Provider</button>
                </form>
            </div>
            <div class="right-panel">
                <h2>Available Providers</h2>
                <ul id="provider-list">
                    <!-- Will be populated dynamically -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Security Tab -->
    <div class="tab-pane fade" id="security" role="tabpanel">
        <div class="config-layout">
            <div class="left-panel">
                <h2>Change Password</h2>
                <form id="change-password-form">
                    <input type="password" id="current-password" placeholder="Current Password" required>
                    <input type="password" id="new-password" placeholder="New Password" required>
                    <input type="password" id="confirm-password" placeholder="Confirm New Password" required>
                    <button type="submit">Change Password</button>
                </form>
            </div>
            <div class="right-panel">
                <h2>Password Requirements</h2>
                <ul>
                    <li>At least 8 characters long</li>
                    <li>Must contain at least one uppercase letter</li>
                    <li>Must contain at least one number</li>
                    <li>Must contain at least one special character</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Add the download dialog -->
<div id="downloadDialog" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Select Database to Download</h3>
        <select id="download-database-select">
            <!-- Will be populated dynamically -->
        </select>
        <div class="modal-buttons">
            <button onclick="downloadSelectedDatabase()">Download</button>
            <button onclick="closeDownloadDialog()">Cancel</button>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-color: #0d6efd;  /* Bootstrap primary blue */
        --primary-dark: #0a58ca;   /* Darker blue */
        --text-color: #333;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #343a40;
        --light-bg: #ffffff;
    }

    h1 {
        color: var(--dark-gray);
        margin-bottom: 20px;
    }

    h2 {
        color: var(--dark-gray);
        border-bottom: 1px solid rgba(13, 110, 253, 0.2);
        padding-bottom: 10px;
    }

    h3 {
        color: var(--dark-gray);
    }

    .left-panel, .right-panel {
        background-color: var(--light-bg);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid var(--medium-gray);
    }

    button {
        background-color: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.2);
        color: var(--primary-color);
        transition: all 0.2s ease;
        padding: 8px 16px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    button:hover {
        background-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    .database-operations button#backup-database {
        background-color: rgba(40, 167, 69, 0.1);
        border: 1px solid rgba(40, 167, 69, 0.2);
        color: #28a745;
    }

    .database-operations button#backup-database:hover {
        background-color: #28a745;
        color: white;
    }

    .database-operations button#download-database {
        background-color: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.2);
        color: var(--primary-color);
    }

    .database-operations button#download-database:hover {
        background-color: var(--primary-color);
        color: white;
    }

    .database-operations button#reset-database,
    .danger {
        background-color: rgba(220, 53, 69, 0.1) !important;
        border: 1px solid rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
    }

    .database-operations button#reset-database:hover,
    .danger:hover {
        background-color: #dc3545 !important;
        color: white !important;
    }

    input, select {
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 20px;
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }

    input:focus, select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
        outline: none;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.35em 0.8em;
        font-size: 0.75em;
        font-weight: 500;
        line-height: 1.4;
        border-radius: 20px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .status-badge.configured {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .status-badge.not-configured {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    #database-list li, #model-list li, #provider-list li {
        background-color: var(--light-gray);
        border: 1px solid var(--medium-gray);
        border-radius: 20px;
        transition: transform 0.2s ease;
        padding: 12px 20px;
    }

    #database-list li:hover, #model-list li:hover, #provider-list li:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .info-item {
        border-left: 4px solid rgba(13, 110, 253, 0.2);
        border-radius: 15px;
    }

    .info-value {
        color: var(--primary-color);
    }

    /* Add these layout styles back while keeping the new visual styling */
    .config-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    .left-panel, .right-panel {
        flex: 1;
        min-width: 300px;
        padding: 20px;
    }

    .config-item {
        margin-bottom: 20px;
    }

    #database-list, #model-list, #provider-list {
        padding-left: 0;
        list-style-type: none;
    }

    #database-list li, #model-list li, #provider-list li {
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
    }

    #create-database-form, #add-model-form, #provider-config-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .database-operations {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .database-operations button {
        flex: 1;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        width: 300px;
    }

    .modal-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    /* Info panel styles */
    .info-panel {
        background: var(--light-bg);
        padding: 20px;
        border-radius: 8px;
    }

    .info-group {
        display: grid;
        gap: 15px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: white;
        border-radius: 6px;
    }

    .info-label {
        font-weight: 600;
        color: var(--dark-gray);
    }

    .info-value {
        font-family: monospace;
    }

    .table-info {
        margin-top: 15px;
        background: white;
        border-radius: 6px;
        padding: 10px;
    }

    .table-info table {
        margin-bottom: 0;
    }

    /* Tab styles */
    .nav-tabs {
        border-bottom: 2px solid var(--medium-gray);
    }

    .nav-tabs .nav-link {
        border: none;
        color: var(--dark-gray);
        padding: 12px 20px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        margin-bottom: -2px;
    }

    @media (max-width: 768px) {
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
        }
    }
</style>

<script>
    // JavaScript functions related to database and model management
    let activeDatabase = '';

    // Function to load existing databases
    function loadDatabases() {
        fetch('/api/databases')
            .then(response => response.json())
            .then(databases => {
                const databaseList = document.getElementById('database-list');
                const activeDatabaseSelect = document.getElementById('active-database');
                databaseList.innerHTML = '';
                activeDatabaseSelect.innerHTML = '<option value="">Select active database</option>';
                
                databases.forEach(db => {
                    const li = document.createElement('li');
                    li.textContent = db.name;
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = () => deleteDatabase(db.name);
                    li.appendChild(deleteButton);
                    databaseList.appendChild(li);

                    const option = document.createElement('option');
                    option.value = db.name;
                    option.textContent = db.name;
                    if (db.name === activeDatabase) {
                        option.selected = true;
                    }
                    activeDatabaseSelect.appendChild(option);
                });
            });
    }

    // Function to create a new database
    document.getElementById('create-database-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const databaseName = document.getElementById('database-name').value;
        fetch('/api/databases', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: databaseName }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Database created:', data);
            loadDatabases();
            document.getElementById('database-name').value = '';
        });
    });

    // Function to select active database
    document.getElementById('active-database').addEventListener('change', function(e) {
        const databaseName = e.target.value;
        fetch('/api/active-database', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: databaseName }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Active database set:', data);
            activeDatabase = databaseName;
            loadDatabaseInfo();
        });
    });

    // Function to load database information
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    function formatFileSize(bytes) {
        if (!bytes) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function loadDatabaseInfo() {
        fetch('/api/database-info')
            .then(response => response.json())
            .then(data => {
                // Update basic info
                document.getElementById('db-name').textContent = data.name || 'N/A';
                document.getElementById('db-size').textContent = formatFileSize(data.size);
                document.getElementById('total-articles').textContent = (data.total_articles || 0).toLocaleString();
                document.getElementById('last-entry').textContent = formatDate(data.last_entry);
                document.getElementById('first-entry').textContent = formatDate(data.first_entry);
                document.getElementById('total-topics').textContent = (data.total_topics || 0).toLocaleString();
                
                // Update table information
                const tableBody = document.getElementById('table-info');
                if (data.tables && data.tables.length > 0) {
                    tableBody.innerHTML = data.tables
                        .map(table => `
                            <tr>
                                <td>${table.name}</td>
                                <td>${table.rows.toLocaleString()}</td>
                            </tr>
                        `)
                        .join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="2">No tables found</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading database info:', error);
                document.getElementById('database-info').innerHTML = 
                    '<div class="alert alert-danger">Error loading database information</div>';
            });
    }

    // Function to delete a database
    function deleteDatabase(name) {
        if (confirm(`Are you sure you want to delete the database "${name}"?`)) {
            fetch(`/api/databases/${name}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                console.log('Database deleted:', data);
                loadDatabases();
            });
        }
    }

    // Load active database information
    fetch('/api/active-database')
        .then(response => response.json())
        .then(data => {
            activeDatabase = data.name;
            loadDatabases();
            loadDatabaseInfo();
        });

    // Function to load AI models from ai_config.json
    function loadAIModels() {
        fetch('/api/ai_models_config')
            .then(response => response.json())
            .then(data => {
                const modelSelect = document.getElementById('model-name');
                modelSelect.innerHTML = '<option value="">Select a model</option>';
                data.ai_models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.provider})`;
                    option.dataset.provider = model.provider;  // Set the data-provider attribute
                    modelSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading AI models:', error));
    }

    // Function to load available models
    function loadAvailableModels() {
        fetch('/api/ai_models')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(models => {
                const modelList = document.getElementById('model-list');
                modelList.innerHTML = '';
                if (models.length === 0) {
                    modelList.innerHTML = '<li>No models configured.</li>';
                } else {
                    models.forEach(model => {
                        const li = document.createElement('li');
                        li.textContent = `${model.name} (${model.provider})`;
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Remove';
                        deleteButton.onclick = () => removeModel(model.name, model.provider);
                        li.appendChild(deleteButton);
                        modelList.appendChild(li);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading available models:', error);
                const modelList = document.getElementById('model-list');
                modelList.innerHTML = '<li>Error loading models. Please try again later.</li>';
            });
    }

    document.getElementById('add-model-form').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Form submission started');
        const modelSelect = document.getElementById('model-name');
        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        const modelName = selectedOption.value;
        const provider = selectedOption.dataset.provider;
        const apiKey = document.getElementById('api-key').value;
        
        console.log('Selected option:', selectedOption);
        console.log('Model Name:', modelName);
        console.log('Provider:', provider);
        console.log('API Key length:', apiKey.length);
        
        if (!modelName || !provider || !apiKey) {
            alert('Please fill in all required fields');
            return;
        }
        
        console.log('Sending request to add model:', { model_name: modelName, provider: provider });
        
        fetch('/config/add_model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_name: modelName,
                provider: provider,
                api_key: apiKey
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json().then(data => ({status: response.status, body: data}));
        })
        .then(({status, body}) => {
            console.log('Response body:', body);
            if (status === 422) {
                throw new Error(body.error || 'Missing required fields');
            } else if (status === 400) {
                throw new Error(body.error || 'Invalid model configuration');
            } else if (status !== 200) {
                throw new Error(body.error || 'Unknown server error');
            }
            if (body.error) {
                throw new Error(body.error);
            }
            console.log('Model added successfully:', body.message);
            alert(body.message);
            loadAvailableModels();
        })
        .catch(error => {
            console.error('Error adding model:', error);
            alert('Error adding model: ' + error.message);
        });
    });

    function removeModel(modelName, provider) {
        if (confirm(`Are you sure you want to remove the model "${modelName}"?`)) {
            fetch('/config/remove_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_name: modelName,
                    provider: provider
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Model removed:', data);
                loadAvailableModels();  // Refresh the list of available models
            })
            .catch(error => {
                console.error('Error removing model:', error);
                alert('Error removing model. Please try again.');
            });
        }
    }

    // Load AI models and available models when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');  // Debug log
        loadAIModels();
        loadAvailableModels();
    });

    // Consolidated DOMContentLoaded event listener at the bottom
    document.addEventListener('DOMContentLoaded', function() {
        // Load all configurations
        loadAIModels();
        loadAvailableModels();
        loadProviderOptions();
        loadAvailableProviders();
    });

    // Update the provider config form submission handler
    document.getElementById('provider-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const providerName = document.getElementById('provider-name').value;
        const key = document.getElementById('provider-key').value;
        
        if (!providerName || !key) {
            alert('Please select a provider and enter an API key');
            return;
        }
        
        try {
            const response = await fetch(`/config/${providerName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: key })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || `Failed to save ${providerName} key`);
            }
            
            alert(`${providerName} key saved successfully`);
            document.getElementById('provider-key').value = '';
            await loadAvailableProviders();
            
        } catch (error) {
            console.error(`Error saving ${providerName} key:`, error);
            alert(`Error saving ${providerName} key: ${error.message}`);
        }
    });

    // Update loadAvailableProviders with the correct URL
    async function loadAvailableProviders() {
        try {
            const response = await fetch('/api/providers');
            const data = await response.json();
            const providerList = document.getElementById('provider-list');
            providerList.innerHTML = '';
            
            for (const provider of data.providers.filter(p => p.config_type === 'api_key')) {
                const configResponse = await fetch(`/config/${provider.name}`);
                const configData = await configResponse.json();
                
                const li = document.createElement('li');
                li.innerHTML = `
                    ${provider.display_name}
                    <span class="status-badge ${configData.configured ? 'configured' : 'not-configured'}">
                        ${configData.configured ? 'Configured' : 'Not Configured'}
                    </span>
                    ${configData.configured ? 
                        `<button onclick="removeProviderConfig('${provider.name}')">Remove</button>` : 
                        ''}
                `;
                providerList.appendChild(li);
            }
        } catch (error) {
            console.error('Error loading providers:', error);
            document.getElementById('provider-list').innerHTML = 
                '<li>Error loading providers. Please try again later.</li>';
        }
    }

    // Update removeProviderConfig to match removeModel pattern
    async function removeProviderConfig(providerName) {
        if (confirm(`Are you sure you want to remove the ${providerName} key?`)) {
            try {
                const response = await fetch(`/config/${providerName}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to remove ${providerName} key`);
                }
                
                await loadAvailableProviders();
            } catch (error) {
                console.error(`Error removing ${providerName} key:`, error);
                alert(`Error removing ${providerName} key: ${error.message}`);
            }
        }
    }

    // Add this function to load providers from provider_config.json
    async function loadProviderOptions() {
        try {
            const response = await fetch('/api/providers');
            const data = await response.json();
            const providerSelect = document.getElementById('provider-name');
            providerSelect.innerHTML = '<option value="">Select a provider</option>';
            
            data.providers
                .filter(provider => provider.config_type === 'api_key')  // Only show providers needing API key
                .forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.name;
                option.textContent = provider.display_name;
                option.dataset.configType = provider.config_type;
                providerSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading providers:', error);
        }
    }

    // Add password change functionality
    document.getElementById('change-password-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match');
            return;
        }
        
        try {
            const response = await fetch('/api/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to change password');
            }
            
            alert('Password changed successfully');
            document.getElementById('change-password-form').reset();
            
        } catch (error) {
            console.error('Error changing password:', error);
            alert(`Error changing password: ${error.message}`);
        }
    });

    // Function to backup the database
    function backupDatabase() {
        if (confirm('Do you want to create a backup of the current database?')) {
            fetch('/api/databases/backup', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadDatabases();  // Refresh the database list
            })
            .catch(error => {
                console.error('Error backing up database:', error);
                alert('Error backing up database. Please try again.');
            });
        }
    }

    // Function to reset the database
    function resetDatabase() {
        if (confirm('WARNING: This will delete all articles, tags, and reports from the database. This action cannot be undone. Are you sure you want to proceed?')) {
            if (confirm('Last chance: Are you absolutely sure? All data will be permanently deleted.')) {
                fetch('/api/databases/reset', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadDatabaseInfo();  // Refresh the database info
                })
                .catch(error => {
                    console.error('Error resetting database:', error);
                    alert('Error resetting database. Please try again.');
                });
            }
        }
    }

    // Add this to handle tab persistence
    document.addEventListener('DOMContentLoaded', function() {
        // Get active tab from localStorage if it exists
        const activeTab = localStorage.getItem('configActiveTab');
        if (activeTab) {
            const tab = new bootstrap.Tab(document.querySelector(`#configTabs button[data-bs-target="${activeTab}"]`));
            tab.show();
        }

        // Store active tab in localStorage when changed
        document.querySelectorAll('#configTabs button').forEach(button => {
            button.addEventListener('shown.bs.tab', function(e) {
                localStorage.setItem('configActiveTab', e.target.dataset.bsTarget);
            });
        });
    });

    // Add this function with the other database functions
    function showDownloadDialog() {
        const dialog = document.getElementById('downloadDialog');
        const select = document.getElementById('download-database-select');
        
        // Clear and populate the select
        select.innerHTML = '';
        fetch('/api/databases')
            .then(response => response.json())
            .then(databases => {
                databases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db.name;
                    option.textContent = db.name;
                    select.appendChild(option);
                });
                dialog.style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading databases:', error);
                alert('Error loading databases. Please try again.');
            });
    }

    function closeDownloadDialog() {
        document.getElementById('downloadDialog').style.display = 'none';
    }

    function downloadSelectedDatabase() {
        const select = document.getElementById('download-database-select');
        const dbName = select.value;
        
        if (!dbName) {
            alert('Please select a database');
            return;
        }

        // Show loading state
        const downloadButton = document.querySelector('#downloadDialog button');
        downloadButton.disabled = true;
        downloadButton.textContent = 'Downloading...';

        fetch(`/api/databases/download/${encodeURIComponent(dbName)}`)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to download database');
                    });
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = dbName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                closeDownloadDialog();
            })
            .catch(error => {
                console.error('Error downloading database:', error);
                alert(`Error downloading database: ${error.message}`);
            })
            .finally(() => {
                // Reset button state
                downloadButton.disabled = false;
                downloadButton.textContent = 'Download';
            });
    }

    // Update the existing downloadDatabase function to use the dialog
    function downloadDatabase() {
        showDownloadDialog();
    }
</script>
{% endblock %}
