{% extends "base.html" %}

{% block content %}
<h1>Configuration</h1>

<div class="config-layout">
    <div class="left-panel">
        <h2>Database Management</h2>
        <div class="config-item">
            <h3>Active Database</h3>
            <select id="active-database">
                <option value="">Select active database</option>
                <!-- Options will be populated dynamically -->
            </select>
        </div>
        <div class="config-item">
            <h3>Available Databases</h3>
            <ul id="database-list">
                <!-- Database list will be populated dynamically -->
            </ul>
        </div>
        <div class="config-item">
            <h3>New Database</h3>
            <form id="create-database-form">
                <input type="text" id="database-name" placeholder="Enter database name" required>
                <button type="submit">Create Database</button>
            </form>
        </div>
    </div>
    <div class="right-panel">
        <h2>Database Information</h2>
        <div id="database-info">
            <!-- This will be populated dynamically -->
        </div>
    </div>
</div>

<!-- AI Model Configuration Section -->
<div class="config-layout mt-5">
    <div class="left-panel">
        <h2>AI Model Configuration</h2>
        <form id="add-model-form">
            <select id="model-name" required>
                <option value="">Select a model</option>
                {% for model in models %}
                    <option value="{{ model.name }}" data-provider="{{ model.provider }}">{{ model.name }} ({{ model.provider }})</option>
                {% endfor %}
            </select>
            <input type="text" id="api-key" placeholder="API Key" required>
            <button type="submit">Add Model</button>
        </form>
    </div>
    <div class="right-panel">
        <h2>Available Models</h2>
        <ul id="model-list">
            <!-- This will be populated dynamically -->
        </ul>
    </div>
</div>

<!-- Replace the Article Provider Configuration section with this updated version -->
<div class="config-layout mt-5">
    <div class="left-panel">
        <h2>Article Provider Configuration</h2>
        <form id="provider-config-form">
            <select id="provider-name" required>
                <option value="">Select a provider</option>
                <!-- Will be populated dynamically -->
            </select>
            <input type="text" id="provider-key" placeholder="API Key" required>
            <button type="submit">Add Provider</button>
        </form>
    </div>
    <div class="right-panel">
        <h2>Available Providers</h2>
        <ul id="provider-list">
            <!-- Will be populated dynamically -->
        </ul>
    </div>
</div>

<!-- Add bottom spacing -->
<div class="mt-5"></div>

<!-- Add Prompt Management Section -->
<div class="config-layout mt-5">
    <div class="left-panel">
        <h2>Prompt Management</h2>
        <div class="prompt-selector">
            <select id="prompt-type">
                <option value="">Select Prompt Type</option>
                <option value="title_extraction">Title Extraction</option>
                <option value="content_analysis">Content Analysis</option>
            </select>
            <select id="prompt-version" disabled>
                <option value="">Select Version</option>
            </select>
        </div>
        <div class="prompt-editor">
            <h3>System Prompt</h3>
            <textarea id="system-prompt" rows="5" placeholder="System prompt..."></textarea>
            
            <h3>User Prompt</h3>
            <textarea id="user-prompt" rows="10" placeholder="User prompt..."></textarea>
            
            <div class="prompt-actions">
                <button id="save-prompt">Save New Version</button>
                <button id="restore-version" disabled>Restore Selected Version</button>
                <button id="compare-versions" disabled>Compare with Current</button>
            </div>
        </div>
    </div>
    <div class="right-panel">
        <h2>Version History</h2>
        <div id="version-history">
            <!-- Will be populated dynamically -->
        </div>
        <div id="version-comparison" class="hidden">
            <h3>Version Comparison</h3>
            <div class="comparison-view">
                <div class="version-a">
                    <h4>Version A</h4>
                    <pre id="version-a-content"></pre>
                </div>
                <div class="version-b">
                    <h4>Version B</h4>
                    <pre id="version-b-content"></pre>
                </div>
            </div>
            <button id="close-comparison">Close Comparison</button>
        </div>
    </div>
</div>

<!-- Add Instructions Section -->
<div class="config-layout mt-5">
    <div class="left-panel">
        <h2>Prompt Writing Instructions</h2>
        <div class="instructions">
            <p>When writing prompts, you can use the following variables:</p>
            
            <h3>Basic Article Information</h3>
            <ul>
                <li><strong>{article_text}</strong>: The main content of the article</li>
                <li><strong>{title}</strong>: The article's title</li>
                <li><strong>{source}</strong>: Source of the article</li>
                <li><strong>{uri}</strong>: URL of the article</li>
            </ul>

            <h3>Summary Configuration</h3>
            <ul>
                <li><strong>{summary_length}</strong>: Number of words for the summary</li>
                <li><strong>{summary_voice}</strong>: The voice/style to use for summarization</li>
                <li><strong>{summary_type}</strong>: Type of summary format</li>
            </ul>

            <h3>Classification Options</h3>
            <ul>
                <li><strong>{categories}</strong>: Available category options</li>
                <li><strong>{future_signals}</strong>: List of future signal options</li>
                <li><strong>{sentiment_options}</strong>: Available sentiment classifications</li>
                <li><strong>{time_to_impact_options}</strong>: Time to impact options</li>
                <li><strong>{driver_types}</strong>: Available driver type classifications</li>
            </ul>

            <p class="mt-3">Use these placeholders to dynamically insert information into your prompts. The system will automatically replace them with actual values during processing.</p>
        </div>
    </div>
</div>

<script>
    let activeDatabase = '';

    // Function to load existing databases
    function loadDatabases() {
        fetch('/api/databases')
            .then(response => response.json())
            .then(databases => {
                const databaseList = document.getElementById('database-list');
                const activeDatabaseSelect = document.getElementById('active-database');
                databaseList.innerHTML = '';
                activeDatabaseSelect.innerHTML = '<option value="">Select active database</option>';
                
                databases.forEach(db => {
                    const li = document.createElement('li');
                    li.textContent = db.name;
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = () => deleteDatabase(db.name);
                    li.appendChild(deleteButton);
                    databaseList.appendChild(li);

                    const option = document.createElement('option');
                    option.value = db.name;
                    option.textContent = db.name;
                    if (db.name === activeDatabase) {
                        option.selected = true;
                    }
                    activeDatabaseSelect.appendChild(option);
                });
            });
    }

    // Function to create a new database
    document.getElementById('create-database-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const databaseName = document.getElementById('database-name').value;
        fetch('/api/databases', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: databaseName }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Database created:', data);
            loadDatabases();
            document.getElementById('database-name').value = '';
        });
    });

    // Function to select active database
    document.getElementById('active-database').addEventListener('change', function(e) {
        const databaseName = e.target.value;
        fetch('/api/active-database', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: databaseName }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Active database set:', data);
            activeDatabase = databaseName;
            loadDatabaseInfo();
        });
    });

    // Function to load database information
    function loadDatabaseInfo() {
        fetch('/api/database-info')
            .then(response => response.json())
            .then(data => {
                const databaseInfo = document.getElementById('database-info');
                databaseInfo.innerHTML = `
                    <p><strong>Tables:</strong> ${data.tables.join(', ')}</p>
                    <p><strong>Article Count:</strong> ${data.article_count}</p>
                    <p><strong>Last Entry:</strong> ${data.last_entry}</p>
                `;
            });
    }

    // Function to delete a database
    function deleteDatabase(name) {
        if (confirm(`Are you sure you want to delete the database "${name}"?`)) {
            fetch(`/api/databases/${name}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                console.log('Database deleted:', data);
                loadDatabases();
            });
        }
    }

    // Load active database information
    fetch('/api/active-database')
        .then(response => response.json())
        .then(data => {
            activeDatabase = data.name;
            loadDatabases();
            loadDatabaseInfo();
        });

    // Function to load AI models from ai_config.json
    function loadAIModels() {
        fetch('/api/ai_models_config')
            .then(response => response.json())
            .then(data => {
                const modelSelect = document.getElementById('model-name');
                modelSelect.innerHTML = '<option value="">Select a model</option>';
                data.ai_models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.provider})`;
                    option.dataset.provider = model.provider;  // Set the data-provider attribute
                    modelSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading AI models:', error));
    }

    // Function to load available models
    function loadAvailableModels() {
        fetch('/api/ai_models')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(models => {
                const modelList = document.getElementById('model-list');
                modelList.innerHTML = '';
                if (models.length === 0) {
                    modelList.innerHTML = '<li>No models configured.</li>';
                } else {
                    models.forEach(model => {
                        const li = document.createElement('li');
                        li.textContent = `${model.name} (${model.provider})`;
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Remove';
                        deleteButton.onclick = () => removeModel(model.name, model.provider);
                        li.appendChild(deleteButton);
                        modelList.appendChild(li);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading available models:', error);
                const modelList = document.getElementById('model-list');
                modelList.innerHTML = '<li>Error loading models. Please try again later.</li>';
            });
    }

    document.getElementById('add-model-form').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Form submission started');
        const modelSelect = document.getElementById('model-name');
        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        const modelName = selectedOption.value;
        const provider = selectedOption.dataset.provider;
        const apiKey = document.getElementById('api-key').value;
        
        console.log('Selected option:', selectedOption);
        console.log('Model Name:', modelName);
        console.log('Provider:', provider);
        console.log('API Key length:', apiKey.length);
        
        if (!modelName || !provider || !apiKey) {
            alert('Please fill in all required fields');
            return;
        }
        
        console.log('Sending request to add model:', { model_name: modelName, provider: provider });
        
        fetch('/config/add_model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_name: modelName,
                provider: provider,
                api_key: apiKey
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json().then(data => ({status: response.status, body: data}));
        })
        .then(({status, body}) => {
            console.log('Response body:', body);
            if (status === 422) {
                throw new Error(body.error || 'Missing required fields');
            } else if (status === 400) {
                throw new Error(body.error || 'Invalid model configuration');
            } else if (status !== 200) {
                throw new Error(body.error || 'Unknown server error');
            }
            if (body.error) {
                throw new Error(body.error);
            }
            console.log('Model added successfully:', body.message);
            alert(body.message);
            loadAvailableModels();
        })
        .catch(error => {
            console.error('Error adding model:', error);
            alert('Error adding model: ' + error.message);
        });
    });

    function removeModel(modelName, provider) {
        if (confirm(`Are you sure you want to remove the model "${modelName}"?`)) {
            fetch('/config/remove_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_name: modelName,
                    provider: provider
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Model removed:', data);
                loadAvailableModels();  // Refresh the list of available models
            })
            .catch(error => {
                console.error('Error removing model:', error);
                alert('Error removing model. Please try again.');
            });
        }
    }

    // Load AI models and available models when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');  // Debug log
        loadAIModels();
        loadAvailableModels();
    });

    // Consolidated DOMContentLoaded event listener at the bottom
    document.addEventListener('DOMContentLoaded', function() {
        // Load all configurations
        loadAIModels();
        loadAvailableModels();
        loadProviderOptions();
        loadAvailableProviders();
    });

    // Update the provider config form submission handler
    document.getElementById('provider-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const providerName = document.getElementById('provider-name').value;
        const key = document.getElementById('provider-key').value;
        
        if (!providerName || !key) {
            alert('Please select a provider and enter an API key');
            return;
        }
        
        try {
            const response = await fetch(`/config/${providerName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: key })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || `Failed to save ${providerName} key`);
            }
            
            alert(`${providerName} key saved successfully`);
            document.getElementById('provider-key').value = '';
            await loadAvailableProviders();
            
        } catch (error) {
            console.error(`Error saving ${providerName} key:`, error);
            alert(`Error saving ${providerName} key: ${error.message}`);
        }
    });

    // Update loadAvailableProviders with the correct URL
    async function loadAvailableProviders() {
        try {
            const response = await fetch('/api/providers');
            const data = await response.json();
            const providerList = document.getElementById('provider-list');
            providerList.innerHTML = '';
            
            for (const provider of data.providers.filter(p => p.config_type === 'api_key')) {
                const configResponse = await fetch(`/config/${provider.name}`);
                const configData = await configResponse.json();
                
                const li = document.createElement('li');
                li.innerHTML = `
                    ${provider.display_name}
                    <span class="status-badge ${configData.configured ? 'configured' : 'not-configured'}">
                        ${configData.configured ? 'Configured' : 'Not Configured'}
                    </span>
                    ${configData.configured ? 
                        `<button onclick="removeProviderConfig('${provider.name}')">Remove</button>` : 
                        ''}
                `;
                providerList.appendChild(li);
            }
        } catch (error) {
            console.error('Error loading providers:', error);
            document.getElementById('provider-list').innerHTML = 
                '<li>Error loading providers. Please try again later.</li>';
        }
    }

    // Update removeProviderConfig to match removeModel pattern
    async function removeProviderConfig(providerName) {
        if (confirm(`Are you sure you want to remove the ${providerName} key?`)) {
            try {
                const response = await fetch(`/config/${providerName}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to remove ${providerName} key`);
                }
                
                await loadAvailableProviders();
            } catch (error) {
                console.error(`Error removing ${providerName} key:`, error);
                alert(`Error removing ${providerName} key: ${error.message}`);
            }
        }
    }

    // Add this function to load providers from provider_config.json
    async function loadProviderOptions() {
        try {
            const response = await fetch('/api/providers');
            const data = await response.json();
            const providerSelect = document.getElementById('provider-name');
            providerSelect.innerHTML = '<option value="">Select a provider</option>';
            
            data.providers
                .filter(provider => provider.config_type === 'api_key')  // Only show providers needing API key
                .forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.name;
                option.textContent = provider.display_name;
                option.dataset.configType = provider.config_type;
                providerSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading providers:', error);
        }
    }

    // Prompt Management Functions
    function loadPromptTypes() {
        const promptTypeSelect = document.getElementById('prompt-type');
        
        fetch('/api/prompts/types')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                promptTypeSelect.innerHTML = '<option value="">Select Prompt Type</option>';
                if (data.types && Array.isArray(data.types)) {
                    data.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.name;
                        option.textContent = type.display_name;
                        promptTypeSelect.appendChild(option);
                    });
                    promptTypeSelect.disabled = false;
                } else {
                    throw new Error('Invalid response format');
                }
            })
            .catch(error => {
                console.error('Error loading prompt types:', error);
                promptTypeSelect.innerHTML = '<option value="">Error loading prompt types</option>';
                promptTypeSelect.disabled = true;
            });
    }

    function loadPromptVersions(promptType) {
        if (!promptType) {
            console.error('No prompt type specified');
            return;
        }

        const versionSelect = document.getElementById('prompt-version');
        versionSelect.innerHTML = '<option value="">Loading versions...</option>';
        versionSelect.disabled = true;

        fetch(`/api/prompts/${promptType}/versions`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                versionSelect.innerHTML = '<option value="">Select Version</option>';
                if (data.versions && Array.isArray(data.versions)) {
                    data.versions.forEach(version => {
                        const option = document.createElement('option');
                        option.value = version.hash;
                        option.textContent = `${version.version} (${new Date(version.created_at).toLocaleString()})`;
                        versionSelect.appendChild(option);
                    });
                    versionSelect.disabled = false;
                    
                    // Load the current version in the editor
                    loadPromptContent(promptType, 'current');
                } else {
                    throw new Error('Invalid response format');
                }
            })
            .catch(error => {
                console.error('Error loading prompt versions:', error);
                versionSelect.innerHTML = '<option value="">Error loading versions</option>';
                versionSelect.disabled = true;
                document.getElementById('system-prompt').value = '';
                document.getElementById('user-prompt').value = '';
            });
    }

    function loadPromptContent(promptType, versionHash) {
        fetch(`/api/prompts/${promptType}/${versionHash}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('system-prompt').value = data.system_prompt;
                document.getElementById('user-prompt').value = data.user_prompt;
                
                // Enable/disable buttons based on version
                document.getElementById('restore-version').disabled = versionHash === 'current';
                document.getElementById('compare-versions').disabled = versionHash === 'current';
            })
            .catch(error => console.error('Error loading prompt content:', error));
    }

    function savePromptVersion(promptType) {
        const promptData = {
            system_prompt: document.getElementById('system-prompt').value,
            user_prompt: document.getElementById('user-prompt').value
        };

        fetch(`/api/prompts/${promptType}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(promptData)
        })
        .then(response => response.json())
        .then(data => {
            alert('Prompt version saved successfully');
            loadPromptVersions(promptType);
        })
        .catch(error => {
            console.error('Error saving prompt version:', error);
            alert('Error saving prompt version');
        });
    }

    function restoreVersion(promptType, versionHash) {
        fetch(`/api/prompts/${promptType}/${versionHash}/restore`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert('Version restored successfully');
            loadPromptVersions(promptType);
        })
        .catch(error => {
            console.error('Error restoring version:', error);
            alert('Error restoring version');
        });
    }

    function compareVersions(promptType, versionHashA, versionHashB) {
        Promise.all([
            fetch(`/api/prompts/${promptType}/${versionHashA}`).then(r => r.json()),
            fetch(`/api/prompts/${promptType}/${versionHashB}`).then(r => r.json())
        ])
        .then(([versionA, versionB]) => {
            document.getElementById('version-a-content').textContent = 
                `System Prompt:\n${versionA.system_prompt}\n\nUser Prompt:\n${versionA.user_prompt}`;
            document.getElementById('version-b-content').textContent = 
                `System Prompt:\n${versionB.system_prompt}\n\nUser Prompt:\n${versionB.user_prompt}`;
            document.getElementById('version-comparison').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error comparing versions:', error);
            alert('Error comparing versions');
        });
    }

    // Event Listeners
    document.getElementById('prompt-type').addEventListener('change', function(e) {
        if (e.target.value) {
            loadPromptVersions(e.target.value);
        }
    });

    document.getElementById('prompt-version').addEventListener('change', function(e) {
        const promptType = document.getElementById('prompt-type').value;
        if (e.target.value) {
            loadPromptContent(promptType, e.target.value);
        }
    });

    document.getElementById('save-prompt').addEventListener('click', function() {
        const promptType = document.getElementById('prompt-type').value;
        if (promptType) {
            savePromptVersion(promptType);
        }
    });

    document.getElementById('restore-version').addEventListener('click', function() {
        const promptType = document.getElementById('prompt-type').value;
        const versionHash = document.getElementById('prompt-version').value;
        if (promptType && versionHash) {
            restoreVersion(promptType, versionHash);
        }
    });

    document.getElementById('compare-versions').addEventListener('click', function() {
        const promptType = document.getElementById('prompt-type').value;
        const versionHash = document.getElementById('prompt-version').value;
        if (promptType && versionHash) {
            compareVersions(promptType, versionHash, 'current');
        }
    });

    document.getElementById('close-comparison').addEventListener('click', function() {
        document.getElementById('version-comparison').classList.add('hidden');
    });

    // Initialize prompt management
    document.addEventListener('DOMContentLoaded', function() {
        const promptTypeSelect = document.getElementById('prompt-type');
        promptTypeSelect.innerHTML = '<option value="">Loading prompt types...</option>';
        promptTypeSelect.disabled = true;

        loadPromptTypes();
    });
</script>

<style>
    .config-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    .left-panel, .right-panel {
        flex: 1;
        min-width: 300px;
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .config-item {
        margin-bottom: 20px;
    }

    #database-list, #model-list, #provider-list {
        padding-left: 0;
        list-style-type: none;
    }

    #database-list li, #model-list li, #provider-list li {
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }

    #create-database-form, #add-model-form, #provider-config-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    input, select, button {
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
    }

    button {
        background-color: #FF1493;
        color: white;
        cursor: pointer;
    }

    button:hover {
        background-color: #FF69B4;
    }

    h2 {
        color: #333;
        border-bottom: 2px solid #FF1493;
        padding-bottom: 10px;
    }

    h3 {
        color: #FF1493;
    }

    .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
    }

    .status-badge.configured {
        background-color: #32CD32;
        color: white;
    }

    .status-badge.not-configured {
        background-color: #ff6b6b;
        color: white;
    }

    .prompt-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .prompt-selector select {
        flex: 1;
    }

    .prompt-editor {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .prompt-editor textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        font-family: monospace;
        resize: vertical;
    }

    .prompt-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .version-history {
        max-height: 400px;
        overflow-y: auto;
    }

    .comparison-view {
        display: flex;
        gap: 20px;
        margin: 20px 0;
    }

    .version-a, .version-b {
        flex: 1;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    .version-a pre, .version-b pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: monospace;
    }

    .hidden {
        display: none;
    }
</style>
{% endblock %}
