{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Configuration</h1>

    <!-- Add tab navigation -->
    <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="providers-tab" data-bs-toggle="tab" data-bs-target="#providers" type="button" role="tab">
                <i class="fas fa-plug"></i> Providers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-models-tab" data-bs-toggle="tab" data-bs-target="#ai-models" type="button" role="tab">
                <i class="fas fa-robot"></i> AI Models
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab">
                <i class="fas fa-database"></i> Database
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="datasets-tab" data-bs-toggle="tab" data-bs-target="#datasets" type="button" role="tab">
                <i class="fas fa-table"></i> Datasets
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                <i class="fas fa-lock"></i> Security
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                <i class="fas fa-users"></i> Users
            </button>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content" id="configTabContent">
        <!-- Database Management Tab -->
        <div class="tab-pane fade show active" id="database" role="tabpanel">
            <div class="config-layout">
                <div class="left-panel">
                    <h2>Database Management</h2>
                    <p class="text-muted mb-4">Manage your databases and configure active database settings.</p>

                    <!-- Database Type Info Panels -->
                    <div id="postgresql-info" class="alert alert-info database-type-info" style="display: none;">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-database me-2"></i>
                            <strong>PostgreSQL Database</strong>
                            <span class="badge bg-primary ms-2">Production Database</span>
                        </div>
                        <p class="mb-2">This instance is using PostgreSQL. Database creation, switching, and file downloads
                           should be managed through PostgreSQL admin tools (psql, pgAdmin, etc.).</p>
                        <p class="mb-2"><small>
                            <strong>Connection:</strong> <code id="postgresql-connection-string"></code>
                        </small></p>
                        <p class="mb-0"><small>
                            <strong>Connection Pool:</strong>
                            <span id="postgresql-pool-info" class="text-muted">
                                20 base + 10 overflow = 30 max concurrent connections
                            </span>
                        </small></p>
                        <p class="mb-0 mt-2" id="postgresql-health-status" style="display: none;">
                            <small>
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                <span id="postgresql-health-message"></span>
                            </small>
                        </p>
                    </div>

                    <div id="sqlite-info" class="alert alert-info database-type-info" style="display: none;">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-database me-2"></i>
                            <strong>SQLite Database</strong>
                            <span class="badge bg-info ms-2">File-Based Database</span>
                        </div>
                        <p class="mb-0">This instance is using SQLite file-based databases. You can create, switch,
                           and download database files from this interface.</p>
                    </div>

                    <div class="config-item sqlite-only">
                        <h3>Active Database</h3>
                        <div class="form-group">
                            <select id="active-database" class="form-select"
                                    data-tooltip="Select the database you want to use">
                                <option value="">Select active database</option>
                            </select>
                            <small class="form-text text-muted">The currently active database for storing articles and analysis</small>
                        </div>
                    </div>

                    <div class="config-item sqlite-only">
                        <h3>Available Databases</h3>
                        <ul id="database-list">
                            <!-- Database list will be populated dynamically -->
                        </ul>
                    </div>

                    <div class="config-item sqlite-only">
                        <h3>New Database</h3>
                        <form id="create-database-form">
                            <div class="form-group">
                                <input type="text" id="database-name" 
                                       placeholder="Enter database name" required
                                       class="form-control"
                                       data-tooltip="Enter a name for the new database">
                                <small class="form-text text-muted">Create a new database for a different set of articles</small>
                            </div>
                            <button type="submit" class="mt-2">
                                <i class="fas fa-plus"></i> Create Database
                            </button>
                        </form>
                    </div>

                    <div class="config-item">
                        <h3>Database Operations</h3>
                        <p class="text-muted small mb-3">Manage your database backups and maintenance.</p>
                        <div class="database-operations">
                            <button id="backup-database" onclick="backupDatabase()"
                                    data-tooltip="Create a backup of the current database">
                                <i class="fas fa-save"></i> Backup
                            </button>
                            <button id="download-database" class="sqlite-only" onclick="showDownloadDialog()"
                                    data-tooltip="Download a database file (SQLite only)">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button id="reset-database" class="danger" onclick="resetDatabase()"
                                    data-tooltip="WARNING: This will delete all data">
                                <i class="fas fa-trash"></i> Reset
                            </button>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <h3>Database Hygiene</h3>
                        <p class="text-muted small mb-3">Clean up orphaned data and maintain database integrity.</p>
                        <div class="database-operations">
                            <button id="clean-all-btn" onclick="cleanAllOrphaned()"
                                    data-tooltip="Clean up all orphaned topics and articles at once">
                                <i class="fas fa-magic"></i> Clean All Orphaned
                            </button>
                            <button id="clean-topics-btn" onclick="cleanOrphanedTopics()"
                                    data-tooltip="Find and remove orphaned topic data">
                                <i class="fas fa-broom"></i> Clean Topics
                            </button>
                            <button id="clean-articles-btn" onclick="cleanOrphanedArticles()"
                                    data-tooltip="Find and delete orphaned articles">
                                <i class="fas fa-newspaper"></i> Clean Articles
                            </button>
                        </div>
                    </div>

                    <div class="config-item">
                        <h3>ChromaDB Vector Store</h3>
                        <p class="text-muted small mb-3">Manage the ChromaDB vector database used for semantic search and similarity.</p>
                        <div class="database-operations">
                            <button id="reindex-chromadb-btn" onclick="reindexChromaDB()"
                                    data-tooltip="Re-index all articles into ChromaDB for semantic search">
                                <i class="fas fa-sync-alt"></i> Reindex ChromaDB
                            </button>
                        </div>
                    </div>

                    <div class="config-item">
                        <h3>Clear Articles by Topic</h3>
                        <p class="text-muted small mb-3">Remove all articles for a specific topic without deleting the topic configuration.</p>
                        <div class="form-group">
                            <select id="clear-topic-select" class="form-select">
                                <option value="">Select a topic...</option>
                            </select>
                        </div>
                        <div class="database-operations">
                            <button id="clear-topic-articles-btn" onclick="clearTopicArticlesFromConfig()"
                                    data-tooltip="Clear all articles for the selected topic">
                                <i class="fas fa-eraser"></i> Clear Topic Articles
                            </button>
                        </div>
                    </div>

                    <div class="config-item">
                        <h3>Database Content Reset</h3>
                        <p class="text-muted small mb-3">Clear specific types of data from the database while keeping the structure.</p>
                        <div class="database-operations">
                            <button id="reset-articles-btn" class="danger" onclick="resetArticlesData()"
                                    data-tooltip="WARNING: Delete all articles and related data (including ChromaDB)">
                                <i class="fas fa-trash-alt"></i> Reset Articles
                            </button>
                            <button id="reset-auspex-btn" class="danger" onclick="resetAuspexChats()"
                                    data-tooltip="WARNING: Delete all Auspex chat history">
                                <i class="fas fa-comments"></i> Reset Auspex Chats
                            </button>
                        </div>
                    </div>

                    <div class="config-item">
                        <h3>Topic Configuration Export/Import</h3>
                        <p class="text-muted small mb-3">Export or import your topic monitoring configurations for backup or sharing.</p>
                        <div class="database-operations">
                            <button id="export-topics" onclick="exportTopicConfigurations()"
                                    data-tooltip="Export topic configurations to JSON file">
                                <i class="fas fa-download"></i> Export Topics
                            </button>
                            <button id="import-topics" onclick="showTopicImportDialog()"
                                    data-tooltip="Import topic configurations from JSON file">
                                <i class="fas fa-upload"></i> Import Topics
                            </button>
                        </div>
                    </div>

                    <div class="config-item">
                        <h3>Article Data Export/Import</h3>
                        <p class="text-muted small mb-3">Export or import your article data for backup, migration, or analysis.</p>
                        <div class="database-operations">
                            <button id="export-enriched-articles" onclick="exportEnrichedArticles()"
                                    data-tooltip="Export articles with AI-enriched data (categories, summaries, etc.)">
                                <i class="fas fa-download"></i> Export Enriched Data
                            </button>
                            <button id="export-raw-articles" onclick="exportRawArticles()"
                                    data-tooltip="Export complete article data including raw content">
                                <i class="fas fa-file-export"></i> Export Raw Data
                            </button>
                            <button id="import-articles" onclick="showArticleImportDialog()"
                                    data-tooltip="Import article data from JSON file">
                                <i class="fas fa-upload"></i> Import Articles
                            </button>
                        </div>
                    </div>
                </div>
                <div class="right-panel">
                    <h2>Database Information</h2>
                    <p class="text-muted mb-4">Current database statistics and details.</p>
                    <div id="database-info" class="info-panel">
                        <div class="info-group">
                            <div class="info-item">
                                <span class="info-label">Database Type:</span>
                                <span class="info-value" id="db-type">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Database Name:</span>
                                <span class="info-value" id="db-name">Loading...</span>
                            </div>
                            <div class="info-item" id="db-location-item">
                                <span class="info-label" id="db-location-label">Location:</span>
                                <span class="info-value" id="db-location">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Size:</span>
                                <span class="info-value" id="db-size">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Total Articles:</span>
                                <span class="info-value" id="total-articles">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Last Entry:</span>
                                <span class="info-value" id="last-entry">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">First Entry:</span>
                                <span class="info-value" id="first-entry">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Total Topics:</span>
                                <span class="info-value" id="total-topics">Loading...</span>
                            </div>
                        </div>
                        
                        <h3 class="mt-4">Database Tables</h3>
                        <div class="table-info">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Table Name</th>
                                        <th>Row Count</th>
                                    </tr>
                                </thead>
                                <tbody id="table-info">
                                    <tr>
                                        <td colspan="2">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Models Tab -->
        <div class="tab-pane fade" id="ai-models" role="tabpanel">
            <div class="config-layout">
                <div class="left-panel">
                    <h2>AI Model Configuration</h2>
                    <p class="text-muted mb-4">Configure API keys for different AI models used for analysis.</p>
                    <p class="text-muted">Need an API key? <a href="https://platform.openai.com/" target="_blank" rel="noopener">OpenAI&nbsp;API</a> · <a href="https://www.anthropic.com/api" target="_blank" rel="noopener">Anthropic&nbsp;API</a>.</p>
                    
                    <form id="add-model-form">
                        <div class="form-group">
                            <label for="model-name" class="form-label">AI Model</label>
                            <select id="model-name" required class="form-select"
                                    data-tooltip="Select the AI model you want to configure">
                                <option value="">Select a model</option>
                                {% for model in models %}
                                    <option value="{{ model.name }}" data-provider="{{ model.provider }}">
                                        {{ model.name }} ({{ model.provider }})
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Choose an AI model to add or update its API key</small>
                        </div>

                        <div class="form-group mt-3">
                            <label for="api-key" class="form-label">API Key</label>
                            <input type="text" id="api-key" placeholder="Enter API key" required 
                                   class="form-control"
                                   data-tooltip="Enter your API key from the model provider">
                            <small class="form-text text-muted">Find your API key in your model provider's dashboard</small>
                        </div>

                        <button type="submit" class="mt-3">
                            <i class="fas fa-plus"></i> Add Model
                        </button>
                    </form>
                    
                    <div class="config-item mt-4">
                        <h3>Environment Management</h3>
                        <p class="text-muted small mb-3">Reload environment variables without restarting the server.</p>
                        <div class="environment-operations">
                            <button id="reload-environment-ai" onclick="reloadEnvironment()"
                                    data-tooltip="Reload API keys and configuration from the .env file">
                                <i class="fas fa-sync"></i> Reload Environment
                            </button>
                            <span id="reload-status-ai" class="ms-2"></span>
                        </div>
                        <small class="form-text text-muted mt-2">Use this to refresh AI model API keys after making changes to the .env file</small>
                    </div>
                </div>
                <div class="right-panel">
                    <h2>Available Models</h2>
                    <p class="text-muted mb-4">Currently configured AI models and their status.</p>
                    <ul id="model-list" class="model-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Providers Tab -->
        <div class="tab-pane fade" id="providers" role="tabpanel">
            <div class="config-layout">
                <div class="left-panel">
                    <h2>Article Provider Configuration</h2>
                    <p class="text-muted mb-4">Configure API keys for different news and article providers.</p>
                    <p class="text-muted">Need an API key? <a href="https://newsapi.org/register" target="_blank" rel="noopener">NewsAPI free developer tier</a> · <a href="https://newsdata.io/pricing" target="_blank" rel="noopener">NewsData.io free tier</a> · <a href="https://www.firecrawl.dev/pricing" target="_blank" rel="noopener">Firecrawl free plan</a> · <a href="https://elevenlabs.io/pricing" target="_blank" rel="noopener">ElevenLabs free tier</a>.</p>
                    
                    <!-- Standard API Key Provider Form -->
                    <form id="provider-config-form">
                        <div class="form-group">
                            <label for="provider-name" class="form-label">Provider</label>
                            <select id="provider-name" required class="form-select" 
                                    data-tooltip="Select the news provider you want to configure">
                                <option value="">Select a provider</option>
                            </select>
                            <small class="form-text text-muted">Choose a provider to add or update its API key</small>
                        </div>

                        <div class="form-group mt-3">
                            <label for="provider-key" class="form-label">API Key</label>
                            <input type="text" id="provider-key" placeholder="Enter API key" required 
                                   class="form-control"
                                   data-tooltip="Enter the API key from your provider account">
                            <small class="form-text text-muted">You can find your API key in your provider's dashboard</small>
                        </div>

                        <button type="submit" class="mt-3">
                            <i class="fas fa-plus"></i> Add Provider
                        </button>
                    </form>
                    
                    <!-- Bluesky-specific Provider Form -->
                    <form id="bluesky-config-form" class="mt-5">
                        <h3>Bluesky Configuration</h3>
                        <p class="text-muted small mb-3">Configure your Bluesky credentials for post collection</p>
                        
                        <div class="form-group">
                            <label for="bluesky-username" class="form-label">Bluesky Username</label>
                            <input type="text" id="bluesky-username" placeholder="Enter your Bluesky handle" required 
                                   class="form-control"
                                   data-tooltip="Your Bluesky handle (e.g. username.bsky.social or email)">
                            <small class="form-text text-muted">Enter your Bluesky handle or email</small>
                        </div>

                        <div class="form-group mt-3">
                            <label for="bluesky-password" class="form-label">Bluesky Password</label>
                            <input type="password" id="bluesky-password" placeholder="Enter your Bluesky password" required 
                                   class="form-control"
                                   data-tooltip="Your Bluesky account password">
                            <small class="form-text text-muted">Account password or app-specific password</small>
                        </div>

                        <button type="submit" class="mt-3">
                            <i class="fas fa-plus"></i> Set Bluesky Credentials
                        </button>
                    </form>
                    
                    <div class="config-item mt-4">
                        <h3>Environment Management</h3>
                        <p class="text-muted small mb-3">Reload environment variables without restarting the server.</p>
                        <div class="environment-operations">
                            <button id="reload-environment" onclick="reloadEnvironment()"
                                    data-tooltip="Reload API keys and configuration from the .env file">
                                <i class="fas fa-sync"></i> Reload Environment
                            </button>
                            <span id="reload-status" class="ms-2"></span>
                        </div>
                        <small class="form-text text-muted mt-2">Use this to refresh API keys after making changes to the .env file</small>
                    </div>
                </div>
                <div class="right-panel">
                    <h2>Available Providers</h2>
                    <p class="text-muted mb-4">Currently configured news and article providers.</p>
                    <ul id="provider-list" class="provider-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Datasets Tab -->
        <div class="tab-pane fade" id="datasets" role="tabpanel">
            {% include 'datasets_config.html' %}
        </div>

        <!-- Security Tab -->
        <div class="tab-pane fade" id="security" role="tabpanel">
            <div class="config-layout">
                <div class="left-panel">
                    <h2>Change Password</h2>
                    <p class="text-muted mb-4">Update your account password. Make sure to use a strong password.</p>
                    
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="current-password" class="form-label">Current Password</label>
                            <input type="password" id="current-password" 
                                   placeholder="Enter current password" required
                                   class="form-control"
                                   data-tooltip="Enter your current password">
                        </div>

                        <div class="form-group">
                            <label for="new-password" class="form-label">New Password</label>
                            <input type="password" id="new-password" 
                                   placeholder="Enter new password" required
                                   class="form-control"
                                   data-tooltip="Enter a strong password that meets the requirements">
                        </div>

                        <div class="form-group">
                            <label for="confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" id="confirm-password" 
                                   placeholder="Confirm new password" required
                                   class="form-control"
                                   data-tooltip="Re-enter your new password">
                        </div>

                        <button type="submit" class="mt-3">
                            <i class="fas fa-key"></i> Update Password
                        </button>
                    </form>
                </div>
                <div class="right-panel">
                    <h2>Password Requirements</h2>
                    <p class="text-muted mb-4">Your password must meet the following requirements:</p>
                    <ul class="requirements-list">
                        <li class="requirement-item">
                            <i class="fas fa-check-circle text-success"></i>
                            At least 8 characters long
                        </li>
                        <li class="requirement-item">
                            <i class="fas fa-check-circle text-success"></i>
                            Must contain at least one uppercase letter
                        </li>
                        <li class="requirement-item">
                            <i class="fas fa-check-circle text-success"></i>
                            Must contain at least one number
                        </li>
                        <li class="requirement-item">
                            <i class="fas fa-check-circle text-success"></i>
                            Must contain at least one special character
                        </li>
                    </ul>
                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle"></i>
                        For maximum security, use a unique password that you don't use elsewhere.
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Management Tab (Added 2025-10-21) -->
        <div class="tab-pane fade" id="users" role="tabpanel">
            <div class="config-layout">
                <div class="left-panel">
                    <h2>User Management</h2>
                    <p class="text-muted mb-4">Manage user accounts and permissions. <span id="current-user-role-display"></span></p>

                    <!-- Admin-only section for creating users -->
                    <div id="admin-user-management" style="display: none;">
                        <h3>Create New User</h3>
                        <form id="create-user-form" class="mb-5">
                            <div class="form-group">
                                <label for="create-username" class="form-label">Username</label>
                                <input type="text" id="create-username" name="create-username" class="form-control"
                                       placeholder="Enter username" autocomplete="off" required>
                            </div>

                            <div class="form-group">
                                <label for="create-email" class="form-label">Email</label>
                                <input type="email" id="create-email" name="create-email" class="form-control"
                                       placeholder="user@example.com" autocomplete="off" required>
                            </div>

                            <div class="form-group">
                                <label for="create-password" class="form-label">Password</label>
                                <input type="password" id="create-password" name="create-password" class="form-control"
                                       placeholder="Enter password (min 8 characters)"
                                       autocomplete="new-password" required>
                            </div>

                            <div class="form-group">
                                <label for="create-role" class="form-label">Role</label>
                                <select id="create-role" name="create-role" class="form-control" required>
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="force-password-change" name="force-password-change"
                                           class="form-check-input" checked>
                                    <label for="force-password-change" class="form-check-label">
                                        <i class="fas fa-key text-warning"></i> Require password change on first login
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        User must change their password when they first log in
                                    </small>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="skip-onboarding" name="skip-onboarding"
                                           class="form-check-input">
                                    <label for="skip-onboarding" class="form-check-label">
                                        <i class="fas fa-forward text-info"></i> Skip onboarding wizard
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Mark onboarding as completed (user won't see the welcome wizard)
                                    </small>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary mt-3">
                                <i class="fas fa-user-plus"></i> Create User
                            </button>
                        </form>
                    </div>

                    <h3>All Users</h3>
                    <div id="users-list-container">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Loading users...</p>
                        </div>
                    </div>
                </div>

                <div class="right-panel">
                    <h2>User Roles</h2>
                    <p class="text-muted mb-4">Understanding user permissions:</p>

                    <div class="alert alert-info mb-4">
                        <h5><i class="fas fa-user-shield"></i> Admin</h5>
                        <p class="mb-0">Full system access including:</p>
                        <ul class="mt-2 mb-0">
                            <li>Create and manage user accounts</li>
                            <li>Access all configuration settings</li>
                            <li>View and manage all content</li>
                            <li>Change system-wide settings</li>
                        </ul>
                    </div>

                    <div class="alert alert-secondary mb-4">
                        <h5><i class="fas fa-user"></i> User</h5>
                        <p class="mb-0">Standard access including:</p>
                        <ul class="mt-2 mb-0">
                            <li>View and create content</li>
                            <li>Change own password</li>
                            <li>Access research features</li>
                            <li>Cannot manage other users</li>
                        </ul>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Shared Workspace:</strong> All users have access to view and manage all topics and content.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add the download dialog -->
<div id="downloadDialog" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Select Database to Download</h3>
        <select id="download-database-select">
            <!-- Will be populated dynamically -->
        </select>
        <div class="modal-buttons">
            <button onclick="downloadSelectedDatabase()">Download</button>
            <button onclick="closeDownloadDialog()">Cancel</button>
        </div>
    </div>
</div>

<!-- Topic Import Dialog Template -->
<template id="topic-import-dialog-template">
    <div class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Topic Configurations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Upload Configuration File</h6>
                        <input type="file"
                               id="topic-config-upload"
                               class="form-control"
                               accept=".json"
                               aria-label="Upload topic configuration file">
                        <small class="form-text text-muted mt-2">Select a JSON file containing topic configurations</small>
                    </div>

                    <div class="mb-3">
                        <h6>Import Mode</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="importMode" id="replace-mode" value="replace" checked>
                            <label class="form-check-label" for="replace-mode">
                                <strong>Replace existing configurations</strong>
                                <small class="form-text text-muted d-block">This will delete all current topic configurations and replace them with the imported ones.</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="importMode" id="merge-mode" value="merge">
                            <label class="form-check-label" for="merge-mode">
                                <strong>Merge with existing configurations</strong>
                                <small class="form-text text-muted d-block">This will add new configurations without removing existing ones. Duplicates will be skipped.</small>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="importTopicConfigurations()">Import</button>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Article Import Dialog Template -->
<template id="article-import-dialog-template">
    <div class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Article Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Upload Article Data File</h6>
                        <input type="file"
                               id="article-data-upload"
                               class="form-control"
                               accept=".json"
                               aria-label="Upload article data file">
                        <small class="form-text text-muted mt-2">Select a JSON file containing exported article data</small>
                    </div>

                    <div class="mb-3">
                        <h6>Import Mode</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="articleImportMode" id="article-merge-mode" value="merge" checked>
                            <label class="form-check-label" for="article-merge-mode">
                                <strong>Merge with existing articles</strong>
                                <small class="form-text text-muted d-block">Add new articles without removing existing ones. Duplicates will be skipped by default.</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="articleImportMode" id="article-replace-mode" value="replace">
                            <label class="form-check-label" for="article-replace-mode">
                                <strong>Replace all existing articles</strong>
                                <small class="form-text text-muted d-block text-danger">⚠️ WARNING: This will delete all current articles and replace them with the imported ones.</small>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Duplicate Handling</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="article-skip-duplicates" checked>
                            <label class="form-check-label" for="article-skip-duplicates">
                                Skip duplicate URIs (leave existing articles unchanged)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="article-update-existing">
                            <label class="form-check-label" for="article-update-existing">
                                Update existing articles with new data from import
                            </label>
                        </div>
                        <small class="form-text text-muted mt-2">If both are unchecked, duplicates will be skipped.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="importArticleData()">Import</button>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Add an alert container -->
<div class="alert-container position-fixed top-0 end-0 p-3" style="z-index: 1100;"></div>

<style>
    :root {
        --primary-color: #FF69B4;  /* Hot Pink - match global brand color */
        --primary-dark: #FF1493;   /* Deep Pink */
        --secondary-color: #32CD32;  /* Lime Green */
        --secondary-dark: #228B22;   /* Forest Green */
        --text-color: #333;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #343a40;
        --light-bg: #ffffff;
    }

    h1 {
        color: var(--primary-color);
        margin-bottom: 20px;
    }

    h2 {
        color: var(--primary-color);
        border-bottom: 1px solid rgba(255, 105, 180, 0.2);
        padding-bottom: 10px;
    }

    h3 {
        color: var(--dark-gray);
    }

    .left-panel, .right-panel {
        background-color: var(--light-bg);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid var(--medium-gray);
    }

    button {
        background-color: rgba(255, 105, 180, 0.1);
        border: 1px solid rgba(255, 105, 180, 0.2);
        color: var(--primary-color);
        transition: all 0.2s ease;
        padding: 8px 16px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    button:hover {
        background-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    .database-operations button#backup-database {
        background-color: rgba(50, 205, 50, 0.1);
        border: 1px solid rgba(50, 205, 50, 0.2);
        color: var(--secondary-color);
    }

    .database-operations button#backup-database:hover {
        background-color: var(--secondary-color);
        color: white;
    }

    .database-operations button#download-database {
        background-color: rgba(255, 105, 180, 0.1);
        border: 1px solid rgba(255, 105, 180, 0.2);
        color: var(--primary-color);
    }

    .database-operations button#download-database:hover {
        background-color: var(--primary-color);
        color: white;
    }

    .database-operations button#reset-database,
    .danger {
        background-color: rgba(220, 53, 69, 0.1) !important;
        border: 1px solid rgba(220, 53, 69, 0.2) !important;
        color: #dc3545 !important;
    }

    .database-operations button#reset-database:hover,
    .danger:hover {
        background-color: #dc3545 !important;
        color: white !important;
    }

    input, select {
        border: 1px solid rgba(255, 105, 180, 0.2);
        border-radius: 20px;
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }

    input:focus, select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.15);
        outline: none;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.35em 0.8em;
        font-size: 0.75em;
        font-weight: 500;
        line-height: 1.4;
        border-radius: 20px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .status-badge.configured {
        background-color: rgba(50, 205, 50, 0.1);
        color: var(--secondary-color);
        border: 1px solid rgba(50, 205, 50, 0.2);
    }

    .status-badge.not-configured {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    #database-list li, #model-list li, #provider-list li {
        background-color: var(--light-gray);
        border: 1px solid var(--medium-gray);
        border-radius: 20px;
        transition: transform 0.2s ease;
        padding: 12px 20px;
    }

    #database-list li:hover, #model-list li:hover, #provider-list li:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .info-item {
        border-left: 4px solid rgba(255, 105, 180, 0.2);
        border-radius: 15px;
    }

    .info-value {
        color: var(--primary-color);
    }

    /* Add these layout styles back while keeping the new visual styling */
    .config-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    .left-panel, .right-panel {
        flex: 1;
        min-width: 300px;
        padding: 20px;
    }

    .config-item {
        margin-bottom: 20px;
    }

    #database-list, #model-list, #provider-list {
        padding-left: 0;
        list-style-type: none;
    }

    #database-list li, #model-list li, #provider-list li {
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
    }

    #create-database-form, #add-model-form, #provider-config-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .database-operations {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .database-operations button {
        flex: 1;
    }

    /* Modal styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1045;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        outline: 0;
    }

    .modal-dialog {
        position: relative;
        width: auto;
        margin: 1.75rem auto;
        pointer-events: auto;
        max-width: 600px;
    }

    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: translate(0, -50px);
    }

    .modal.show .modal-dialog {
        transform: translate(0, 0);
    }

    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        background-color: #fff;
        border-radius: 0.3rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        outline: 0;
    }

    .modal-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: calc(0.3rem - 1px);
        border-top-right-radius: calc(0.3rem - 1px);
    }

    .modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        padding: 0.75rem;
        border-top: 1px solid #dee2e6;
        gap: 0.5rem;
    }

    /* Ensure the modal and its contents are clickable */
    .modal, 
    .modal-dialog,
    .modal-content,
    .modal-header,
    .modal-body,
    .modal-footer {
        pointer-events: auto;
    }

    .info-panel {
        background: var(--light-bg);
        padding: 20px;
        border-radius: 8px;
    }

    .info-group {
        display: grid;
        gap: 15px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: white;
        border-radius: 6px;
    }

    .info-label {
        font-weight: 600;
        color: var(--dark-gray);
    }

    .info-value {
        font-family: monospace;
    }

    .table-info {
        margin-top: 15px;
        background: white;
        border-radius: 6px;
        padding: 10px;
    }

    .table-info table {
        margin-bottom: 0;
    }

    /* Tab styles */
    .nav-tabs {
        border-bottom: 2px solid var(--medium-gray);
        margin-bottom: 25px;
        gap: 4px;
    }

    .nav-tabs .nav-link {
        border: none;
        color: var(--dark-gray);
        padding: 12px 24px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        border-radius: 12px 12px 0 0;
        background-color: var(--light-gray);
        margin-bottom: -2px;
        transition: all 0.2s ease;
    }

    .nav-tabs .nav-link:hover {
        background-color: rgba(255, 105, 180, 0.05);
        color: var(--primary-color);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background-color: white;
        border: 2px solid var(--medium-gray);
        border-bottom: 2px solid white;
        font-weight: 600;
    }

    .nav-tabs .nav-link i {
        font-size: 1.1em;
        opacity: 0.7;
    }

    .nav-tabs .nav-link.active i {
        opacity: 1;
    }

    .tab-content {
        background: white;
        border: 2px solid var(--medium-gray);
        border-radius: 0 12px 12px 12px;
        padding: 25px;
        margin-top: -2px;
    }

    @media (max-width: 768px) {
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
        }
    }

    /* Add tooltip styles */
    [data-tooltip] {
        position: relative;
    }

    [data-tooltip]:hover::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 12px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        font-size: 0.8rem;
        border-radius: 6px;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 5px;
    }

    [data-tooltip]:hover::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.8);
        margin-bottom: -6px;
    }

    .form-text {
        font-size: 0.85rem;
        color: var(--dark-gray);
        margin-top: 0.25rem;
        opacity: 0.8;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--dark-gray);
    }

    /* Info icon for additional help */
    .info-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background-color: rgba(255, 105, 180, 0.1);
        color: var(--primary-color);
        font-size: 12px;
        margin-left: 6px;
        cursor: help;
    }

    /* Status indicator styles */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.85rem;
    }

    .status-indicator::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-indicator.active::before {
        background-color: #28a745;
    }

    .status-indicator.inactive::before {
        background-color: #dc3545;
    }

    .provider-separator {
        margin: 20px 0;
        border-top: 1px solid var(--medium-gray);
        padding-top: 15px;
        list-style-type: none;
    }
    
    .provider-separator h4 {
        margin-bottom: 10px;
        color: var(--dark-gray);
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .special-provider {
        background-color: rgba(255, 105, 180, 0.05) !important;
        border-left: 3px solid var(--primary-color) !important;
    }
    
    .provider-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .provider-name {
        font-weight: 600;
    }
    
    .provider-note {
        display: block;
        font-size: 0.8rem;
        color: var(--dark-gray);
        margin-bottom: 10px;
        opacity: 0.7;
    }

    .provider-placeholder {
        padding: 10px;
        color: #6c757d;
        font-style: italic;
        background-color: rgba(0, 0, 0, 0.02);
        border-radius: 6px;
        text-align: center;
        margin-bottom: 15px;
        font-size: 0.9rem;
    }

    .provider-category {
        margin: 20px 0 10px 0;
        padding: 0;
        list-style-type: none;
        border-bottom: 1px solid var(--medium-gray);
    }
    
    .provider-category:first-child {
        margin-top: 0;
    }
    
    .provider-category h4 {
        color: var(--primary-color);
        font-size: 1rem;
        margin-bottom: 8px;
        font-weight: 600;
    }

    /* Database Type Info Panels */
    .database-type-info {
        border-radius: 12px;
        border-left: 4px solid;
        margin-bottom: 20px;
    }

    .database-type-info.alert-info {
        border-left-color: var(--primary-color);
        background-color: rgba(255, 105, 180, 0.05);
    }

    .database-type-info code {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .database-type-info .badge {
        font-size: 0.75em;
        padding: 0.35em 0.65em;
    }

    /* Hide elements with sqlite-only class when not needed */
    .sqlite-only.hidden {
        display: none !important;
    }
</style>

<script>
    // JavaScript functions related to database and model management
    let activeDatabase = '';

    // Function to load existing databases
    function loadDatabases() {
        return fetch('/api/databases')
            .then(response => response.json())
            .then(data => {
                const databaseList = document.getElementById('database-list');
                const activeSelect = document.getElementById('active-database');
                
                // Clear existing options
                databaseList.innerHTML = '';
                activeSelect.innerHTML = '<option value="">Select active database</option>';
                
                data.forEach(db => {
                    // Add to list
                    const li = document.createElement('li');
                    li.className = 'database-item';
                    li.innerHTML = `
                        <span class="database-name">${db.name}</span>
                        <button class="btn-icon delete-database" 
                                onclick="deleteDatabase('${db.id}')"
                                data-tooltip="Delete this database">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    databaseList.appendChild(li);
                    
                    // Add to select
                    const option = document.createElement('option');
                    option.value = db.id;
                    option.textContent = db.name;
                    activeSelect.appendChild(option);
                });
                
                // Set current active database
                return fetch('/api/active-database')
                    .then(response => response.json())
                    .then(activeData => {
                        if (activeData.name) {
                            activeSelect.value = activeData.name;
                        }
                    });
            });
    }

    // Function to create a new database
    document.getElementById('create-database-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        let databaseName = document.getElementById('database-name').value.trim();
        
        if (!databaseName) {
            showAlert('Database name cannot be empty', 'danger');
            return;
        }
        
        // Remove .db extension if user included it
        if (databaseName.endsWith('.db')) {
            databaseName = databaseName.slice(0, -3);
        }
        
        try {
            setDatabaseInfoLoading(true);
            
            // Create database
            const createResponse = await fetch('/api/databases', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: databaseName }),
            });

            if (!createResponse.ok) {
                const error = await createResponse.json();
                throw new Error(error.detail || 'Failed to create database');
            }

            const data = await createResponse.json();
            console.log('Database created:', data);
            
            // Clear input
            document.getElementById('database-name').value = '';
            
            // Set as active database with retry
            let retries = 3;
            while (retries > 0) {
                try {
                    const activeResponse = await fetch('/api/active-database', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: data.id }), // Use full name with .db extension
                    });
                    
                    if (!activeResponse.ok) {
                        const error = await activeResponse.json();
                        throw new Error(error.detail || 'Failed to set active database');
                    }
                    
                    const activeData = await activeResponse.json();
                    console.log('Active database set:', activeData);
                    break; // Success, exit retry loop
                    
                } catch (error) {
                    retries--;
                    if (retries === 0) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s between retries
                }
            }
            
            // Refresh UI
            await loadDatabases();
            await loadDatabaseInfo();
            
            showAlert(`Successfully created database: ${data.name}`, 'success');
        } catch (error) {
            console.error('Error:', error);
            showAlert(error.message, 'danger');
        } finally {
            setDatabaseInfoLoading(false);
        }
    });

    // Function to select active database
    document.getElementById('active-database').addEventListener('change', async function(e) {
        const databaseName = e.target.value;
        try {
            setDatabaseInfoLoading(true);
            
            const response = await fetch('/api/active-database', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: databaseName }),
            });

            if (!response.ok) {
                throw new Error('Failed to set active database');
            }

            const data = await response.json();
            console.log('Active database set:', data);
            
            // Add a small delay before loading the new database info
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Wait for database info to update
            await loadDatabaseInfo();
            await loadDatabases();
            
            showAlert(`Successfully switched to database: ${databaseName}`, 'success');
        } catch (error) {
            console.error('Error setting active database:', error);
            showAlert(`Failed to switch database: ${error.message}`, 'danger');
            loadDatabases(); // Refresh list to ensure correct selection
        } finally {
            setDatabaseInfoLoading(false);
        }
    });

    // Add loading state handler
    function setDatabaseInfoLoading(isLoading) {
        const loadingText = 'Loading...';
        if (isLoading) {
            document.getElementById('db-name').textContent = loadingText;
            document.getElementById('db-size').textContent = loadingText;
            document.getElementById('total-articles').textContent = loadingText;
            document.getElementById('last-entry').textContent = loadingText;
            document.getElementById('first-entry').textContent = loadingText;
            document.getElementById('total-topics').textContent = loadingText;
            document.getElementById('table-info').innerHTML = 
                '<tr><td colspan="2">Loading table information...</td></tr>';
        }
    }

    // Update loadDatabaseInfo to use async/await and add error handling
    async function loadDatabaseInfo() {
        try {
            const response = await fetch('/api/database-info');
            if (!response.ok) {
                throw new Error('Failed to load database info');
            }

            const data = await response.json();
            console.log('Loaded database info:', data);

            // Update database type
            const dbType = data.db_type || 'sqlite';
            document.getElementById('db-type').textContent = dbType.toUpperCase();

            // Show/hide database type info panels
            if (dbType === 'postgresql') {
                document.getElementById('postgresql-info').style.display = 'block';
                document.getElementById('sqlite-info').style.display = 'none';

                // Set PostgreSQL connection string
                const connString = `${data.host || 'localhost'}:${data.port || 5432}/${data.name}`;
                document.getElementById('postgresql-connection-string').textContent = connString;

                // Hide SQLite-only UI elements
                document.querySelectorAll('.sqlite-only').forEach(el => {
                    el.style.display = 'none';
                });

                // Update backup button tooltip
                const backupBtn = document.getElementById('backup-database');
                backupBtn.setAttribute('data-tooltip', 'Create a PostgreSQL backup using pg_dump');

                // Check for stuck transactions (PostgreSQL only)
                try {
                    const healthResponse = await fetch('/api/database-health');
                    if (healthResponse.ok) {
                        const healthData = await healthResponse.json();

                        if (healthData.stuck_transactions > 0) {
                            // Show warning
                            const healthStatus = document.getElementById('postgresql-health-status');
                            const healthMessage = document.getElementById('postgresql-health-message');
                            healthStatus.style.display = 'block';
                            healthMessage.textContent =
                                `Warning: ${healthData.stuck_transactions} stuck transaction(s) detected. ` +
                                `They will auto-terminate after 60 seconds.`;
                        }
                    }
                } catch (error) {
                    console.warn('Could not check database health:', error);
                }

            } else {
                document.getElementById('postgresql-info').style.display = 'none';
                document.getElementById('sqlite-info').style.display = 'block';

                // Show SQLite-only UI elements
                document.querySelectorAll('.sqlite-only').forEach(el => {
                    el.style.display = '';
                });

                // Update backup button tooltip
                const backupBtn = document.getElementById('backup-database');
                backupBtn.setAttribute('data-tooltip', 'Create a backup copy of the database file');
            }

            // Update basic info
            document.getElementById('db-name').textContent = data.name || 'N/A';

            // Update location based on database type
            const locationLabel = document.getElementById('db-location-label');
            const locationValue = document.getElementById('db-location');

            if (dbType === 'postgresql') {
                locationLabel.textContent = 'Host:';
                locationValue.textContent = `${data.host || 'localhost'}:${data.port || 5432}`;
            } else {
                locationLabel.textContent = 'Path:';
                locationValue.textContent = data.path || 'N/A';
            }

            document.getElementById('db-size').textContent = formatFileSize(data.size);
            document.getElementById('total-articles').textContent =
                (data.total_articles || 0).toLocaleString();
            document.getElementById('last-entry').textContent = formatDate(data.last_entry);
            document.getElementById('first-entry').textContent = formatDate(data.first_entry);
            document.getElementById('total-topics').textContent =
                (data.total_topics || 0).toLocaleString();

            // Update table information
            const tableBody = document.getElementById('table-info');
            if (data.tables && data.tables.length > 0) {
                tableBody.innerHTML = data.tables
                    .map(table => `
                        <tr>
                            <td>${table.name}</td>
                            <td>${table.rows.toLocaleString()}</td>
                        </tr>
                    `)
                    .join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="2">No tables found</td></tr>';
            }
        } catch (error) {
            console.error('Error loading database info:', error);
            document.getElementById('database-info').innerHTML =
                '<div class="alert alert-danger">Error loading database information</div>';
            throw error;
        }
    }

    // Helper function to format file size
    function formatFileSize(bytes) {
        if (!bytes) return 'N/A';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        return `${size.toFixed(2)} ${units[unitIndex]}`;
    }

    // Helper function to format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString();
    }

    // Function to delete a database
    async function deleteDatabase(dbName) {
        if (!confirm(`Are you sure you want to delete database "${dbName}"? This cannot be undone.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/databases/${dbName}`, {
                method: 'DELETE',
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to delete database');
            }
            
            // Refresh the database lists
            await loadDatabases();
            showAlert(`Successfully deleted database: ${dbName}`, 'success');
        } catch (error) {
            console.error('Error deleting database:', error);
            showAlert(error.message, 'danger');
        }
    }

    // Load active database information
    fetch('/api/active-database')
        .then(response => response.json())
        .then(data => {
            activeDatabase = data.name;
            loadDatabases();
            loadDatabaseInfo();
        });

    // Function to load AI models from ai_config.json
    function loadAIModels() {
        fetch('/api/ai_models_config')
            .then(response => response.json())
            .then(data => {
                const modelSelect = document.getElementById('model-name');
                modelSelect.innerHTML = '<option value="">Select a model</option>';
                data.ai_models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.provider})`;
                    option.dataset.provider = model.provider;  // Set the data-provider attribute
                    modelSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading AI models:', error));
    }

    // Function to load available models
    function loadAvailableModels() {
        fetch('/api/ai_models')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(models => {
                const modelList = document.getElementById('model-list');
                modelList.innerHTML = '';
                if (models.length === 0) {
                    modelList.innerHTML = '<li>No models configured.</li>';
                } else {
                    models.forEach(model => {
                        const li = document.createElement('li');
                        li.textContent = `${model.name} (${model.provider})`;
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Remove';
                        deleteButton.onclick = () => removeModel(model.name, model.provider);
                        li.appendChild(deleteButton);
                        modelList.appendChild(li);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading available models:', error);
                const modelList = document.getElementById('model-list');
                modelList.innerHTML = '<li>Error loading models. Please try again later.</li>';
            });
    }

    document.getElementById('add-model-form').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Form submission started');
        const modelSelect = document.getElementById('model-name');
        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        const modelName = selectedOption.value;
        const provider = selectedOption.dataset.provider;
        const apiKey = document.getElementById('api-key').value;
        
        console.log('Selected option:', selectedOption);
        console.log('Model Name:', modelName);
        console.log('Provider:', provider);
        console.log('API Key length:', apiKey.length);
        
        if (!modelName || !provider || !apiKey) {
            alert('Please fill in all required fields');
            return;
        }
        
        console.log('Sending request to add model:', { model_name: modelName, provider: provider });
        
        fetch('/config/add_model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_name: modelName,
                provider: provider,
                api_key: apiKey
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json().then(data => ({status: response.status, body: data}));
        })
        .then(({status, body}) => {
            console.log('Response body:', body);
            if (status === 422) {
                throw new Error(body.error || 'Missing required fields');
            } else if (status === 400) {
                throw new Error(body.error || 'Invalid model configuration');
            } else if (status !== 200) {
                throw new Error(body.error || 'Unknown server error');
            }
            if (body.error) {
                throw new Error(body.error);
            }
            console.log('Model added successfully:', body.message);
            alert(body.message);
            loadAvailableModels();
        })
        .catch(error => {
            console.error('Error adding model:', error);
            alert('Error adding model: ' + error.message);
        });
    });

    function removeModel(modelName, provider) {
        if (confirm(`Are you sure you want to remove the model "${modelName}"?`)) {
            fetch('/config/remove_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_name: modelName,
                    provider: provider
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Model removed:', data);
                loadAvailableModels();  // Refresh the list of available models
            })
            .catch(error => {
                console.error('Error removing model:', error);
                alert('Error removing model. Please try again.');
            });
        }
    }

    // Load topics for the clear topic articles dropdown
    async function loadTopicsForClear() {
        try {
            console.log('Loading topics for clear dropdown...');
            const response = await fetch('/api/topics');

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const topics = await response.json();
            console.log('Topics loaded:', topics);

            const select = document.getElementById('clear-topic-select');

            if (!select) {
                console.error('clear-topic-select element not found!');
                return;
            }

            select.innerHTML = '<option value="">Select a topic...</option>';

            if (topics && topics.length > 0) {
                console.log(`Adding ${topics.length} topics to dropdown`);
                topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.name;
                    option.textContent = topic.name;
                    select.appendChild(option);
                });
                console.log('Topics loaded successfully');
            } else {
                console.warn('No topics found');
            }
        } catch (error) {
            console.error('Error loading topics:', error);
        }
    }

    // Clear articles for a specific topic from config page
    async function clearTopicArticlesFromConfig() {
        const topicSelect = document.getElementById('clear-topic-select');
        const topicName = topicSelect.value;

        if (!topicName) {
            alert('Please select a topic first');
            return;
        }

        if (!confirm(`Are you sure you want to clear ALL articles for topic "${topicName}"?\n\nThis will:\n• Delete all articles for this topic\n• Keep the topic configuration\n• Reclaim disk space\n\nThis action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/clear-topic-articles/${encodeURIComponent(topicName)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Failed to clear articles: ${response.statusText}`);
            }

            const result = await response.json();

            alert(`${result.message}\n\n${result.articles_deleted} article(s) deleted.`);

            // Refresh database info
            await loadDatabaseInfo();

            // Reset selection
            topicSelect.value = '';

        } catch (error) {
            console.error('Error clearing topic articles:', error);
            alert(`Failed to clear articles: ${error.message}`);
        }
    }

    // Load AI models and available models when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');  // Debug log
        loadAIModels();
        loadAvailableModels();
        loadProviderOptions();
        loadAvailableProviders();
        loadBlueskyCredentials();
        loadTopicsForClear();  // Load topics for clear articles dropdown
    });

    // Add this function to reload the configuration after key changes
    async function reloadConfiguration() {
        await loadAIModels();
        await loadAvailableModels();
        await loadProviderOptions();
        await loadAvailableProviders();
    }

    // Update the provider config form submission handler
    document.getElementById('provider-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const providerName = document.getElementById('provider-name').value;
        const key = document.getElementById('provider-key').value;
        
        if (!providerName || !key) {
            alert('Please select a provider and enter an API key');
            return;
        }
        
        try {
            const response = await fetch(`/config/${providerName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: key })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || `Failed to save ${providerName} key`);
            }
            
            alert(`${providerName} key saved successfully`);
            document.getElementById('provider-key').value = '';
            
            // Reload the configuration after saving
            await reloadConfiguration();
            
        } catch (error) {
            console.error(`Error saving ${providerName} key:`, error);
            alert(`Error saving ${providerName} key: ${error.message}`);
        }
    });

    // Update loadAvailableProviders with special handling for Bluesky
    async function loadAvailableProviders() {
        try {
            const response = await fetch('/api/providers');
            const data = await response.json();
            const providerList = document.getElementById('provider-list');
            providerList.innerHTML = '';
            
            // Define provider categories and order
            const categories = [
                {
                    name: "News Feeds",
                    providers: ["newsapi", "thenewsapi", "newsdata"]
                },
                {
                    name: "Scrapers",
                    providers: ["firecrawl"]
                },
                {
                    name: "Text-to-Speech",
                    providers: ["elevenlabs", "dia"]
                },
                {
                    name: "Social Media",
                    providers: ["bluesky"]
                }
            ];
            
            // Group providers by category
            for (const category of categories) {
                // Create category header - always show headers even if empty
                const categoryHeader = document.createElement('li');
                categoryHeader.className = 'provider-category';
                categoryHeader.innerHTML = `<h4>${category.name}</h4>`;
                providerList.appendChild(categoryHeader);
                
                // Flag to track if we found any providers in this category
                let foundProviders = false;
                
                // Add providers in this category
                for (const providerName of category.providers) {
                    // Try to find the provider in the data
                    const provider = data.providers.find(p => p.name === providerName);
                    if (!provider) continue;
                    
                    // Mark that we found at least one provider
                    foundProviders = true;
                    
                    // Special handling for Bluesky
                    if (provider.name === 'bluesky') {
                        try {
                            const blueskyResponse = await fetch('/config/bluesky');
                            const blueskyData = await blueskyResponse.json();
                            
                            const blueskyLi = document.createElement('li');
                            blueskyLi.className = 'special-provider';
                            blueskyLi.innerHTML = `
                                <div class="provider-info">
                                    <span class="provider-name">Bluesky</span>
                                    <span class="status-badge ${blueskyData.configured ? 'configured' : 'not-configured'}">
                                        ${blueskyData.configured ? 'Configured' : 'Not Configured'}
                                    </span>
                                </div>
                                <small class="provider-note">Uses username/password authentication</small>
                                ${blueskyData.configured ? 
                                    `<button onclick="removeBlueskyConfig()" class="mt-2">Remove Credentials</button>` : 
                                    ''}
                            `;
                            providerList.appendChild(blueskyLi);
                        } catch (error) {
                            console.error('Error loading Bluesky status:', error);
                            // Add a placeholder for Bluesky with error state
                            const errorLi = document.createElement('li');
                            errorLi.className = 'special-provider';
                            errorLi.innerHTML = `
                                <div class="provider-info">
                                    <span class="provider-name">Bluesky</span>
                                    <span class="status-badge not-configured">Error</span>
                                </div>
                                <small class="provider-note text-danger">Error loading Bluesky status</small>
                            `;
                            providerList.appendChild(errorLi);
                        }
                        continue;
                    }
                    
                    // Standard API key providers
                    if (provider.config_type === 'api_key') {
                        try {
                            const configResponse = await fetch(`/config/${provider.name}`);
                            const configData = await configResponse.json();
                            
                            const li = document.createElement('li');
                            li.innerHTML = `
                                ${provider.display_name}
                                <span class="status-badge ${configData.configured ? 'configured' : 'not-configured'}">
                                    ${configData.configured ? 'Configured' : 'Not Configured'}
                                </span>
                                ${configData.configured ? 
                                    `<button onclick="removeProviderConfig('${provider.name}')">Remove</button>` : 
                                    ''}
                            `;
                            providerList.appendChild(li);
                        } catch (error) {
                            console.error(`Error loading status for ${provider.name}:`, error);
                        }
                    }
                }
                
                // If no providers were found in this category, add a placeholder
                if (!foundProviders) {
                    const placeholderLi = document.createElement('li');
                    placeholderLi.className = 'provider-placeholder';
                    placeholderLi.textContent = 'No providers configured in this category';
                    providerList.appendChild(placeholderLi);
                }
            }
        } catch (error) {
            console.error('Error loading providers:', error);
            document.getElementById('provider-list').innerHTML = 
                '<li>Error loading providers. Please try again later.</li>';
        }
    }
    
    // Add function to remove Bluesky credentials
    async function removeBlueskyConfig() {
        if (confirm('Are you sure you want to remove the Bluesky credentials?')) {
            try {
                const response = await fetch('/config/bluesky', {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to remove Bluesky credentials');
                }
                
                // Clear the username field
                document.getElementById('bluesky-username').value = '';
                
                // Remove info message if present
                const infoDiv = document.querySelector('#bluesky-config-form .credentials-info');
                if (infoDiv) {
                    infoDiv.remove();
                }
                
                await loadAvailableProviders();
                showAlert('Bluesky credentials removed successfully', 'success');
            } catch (error) {
                console.error('Error removing Bluesky credentials:', error);
                showAlert(`Error removing Bluesky credentials: ${error.message}`, 'danger');
            }
        }
    }

    // Add Bluesky form submission handler
    document.getElementById('bluesky-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('bluesky-username').value;
        const password = document.getElementById('bluesky-password').value;
        
        if (!username || !password) {
            alert('Please enter both username and password for Bluesky');
            return;
        }
        
        try {
            const response = await fetch('/config/bluesky', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to save Bluesky credentials');
            }
            
            showAlert('Bluesky credentials saved successfully', 'success');
            document.getElementById('bluesky-password').value = '';
            
            // Reload the configuration after saving
            await reloadConfiguration();
            
        } catch (error) {
            console.error('Error saving Bluesky credentials:', error);
            showAlert(`Error saving Bluesky credentials: ${error.message}`, 'danger');
        }
    });

    // Update removeProviderConfig to match removeModel pattern
    async function removeProviderConfig(providerName) {
        if (confirm(`Are you sure you want to remove the ${providerName} key?`)) {
            try {
                const response = await fetch(`/config/${providerName}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to remove ${providerName} key`);
                }
                
                await loadAvailableProviders();
                showAlert(`Successfully removed ${providerName} key`, 'success');
            } catch (error) {
                console.error(`Error removing ${providerName} key:`, error);
                showAlert(`Error removing ${providerName} key: ${error.message}`, 'danger');
            }
        }
    }

    // Add password change functionality
    document.getElementById('change-password-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match');
            return;
        }
        
        try {
            const response = await fetch('/api/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to change password');
            }
            
            alert('Password changed successfully');
            document.getElementById('change-password-form').reset();
            
        } catch (error) {
            console.error('Error changing password:', error);
            alert(`Error changing password: ${error.message}`);
        }
    });

    // Function to backup the database
    function backupDatabase() {
        if (confirm('Do you want to create a backup of the current database?')) {
            fetch('/api/databases/backup', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadDatabases();  // Refresh the database list
            })
            .catch(error => {
                console.error('Error backing up database:', error);
                alert('Error backing up database. Please try again.');
            });
        }
    }

    // Function to reset the database
    function resetDatabase() {
        if (confirm('WARNING: This will delete all articles, tags, and reports from the database. This action cannot be undone. Are you sure you want to proceed?')) {
            if (confirm('Last chance: Are you absolutely sure? All data will be permanently deleted.')) {
                fetch('/api/databases/reset', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadDatabaseInfo();  // Refresh the database info
                })
                .catch(error => {
                    console.error('Error resetting database:', error);
                    alert('Error resetting database. Please try again.');
                });
            }
        }
    }

    // Add this to handle tab persistence
    document.addEventListener('DOMContentLoaded', function() {
        // Get active tab from localStorage if it exists
        const activeTab = localStorage.getItem('configActiveTab');
        if (activeTab) {
            const tab = new bootstrap.Tab(document.querySelector(`#configTabs button[data-bs-target="${activeTab}"]`));
            tab.show();
        }

        // Store active tab in localStorage when changed
        document.querySelectorAll('#configTabs button').forEach(button => {
            button.addEventListener('shown.bs.tab', function(e) {
                localStorage.setItem('configActiveTab', e.target.dataset.bsTarget);
            });
        });
    });

    // Add this function with the other database functions
    function showDownloadDialog() {
        const dialog = document.getElementById('downloadDialog');
        const select = document.getElementById('download-database-select');
        
        // Clear and populate the select
        select.innerHTML = '';
        fetch('/api/databases')
            .then(response => response.json())
            .then(databases => {
                databases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db.name;
                    option.textContent = db.name;
                    select.appendChild(option);
                });
                dialog.style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading databases:', error);
                alert('Error loading databases. Please try again.');
            });
    }

    function closeDownloadDialog() {
        document.getElementById('downloadDialog').style.display = 'none';
    }

    function downloadSelectedDatabase() {
        const select = document.getElementById('download-database-select');
        const dbName = select.value;
        
        if (!dbName) {
            alert('Please select a database');
            return;
        }

        // Show loading state
        const downloadButton = document.querySelector('#downloadDialog button');
        downloadButton.disabled = true;
        downloadButton.textContent = 'Downloading...';

        fetch(`/api/databases/download/${encodeURIComponent(dbName)}`)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to download database');
                    });
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = dbName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                closeDownloadDialog();
            })
            .catch(error => {
                console.error('Error downloading database:', error);
                alert(`Error downloading database: ${error.message}`);
            })
            .finally(() => {
                // Reset button state
                downloadButton.disabled = false;
                downloadButton.textContent = 'Download';
            });
    }

    // Update the existing downloadDatabase function to use the dialog
    function downloadDatabase() {
        showDownloadDialog();
    }

    // Add tooltips to all elements with data-tooltip attribute
    document.addEventListener('DOMContentLoaded', function() {
        // Add info icons to form labels
        const labels = document.querySelectorAll('.form-label');
        labels.forEach(label => {
            if (label.dataset.info) {
                const infoIcon = document.createElement('span');
                infoIcon.className = 'info-icon';
                infoIcon.innerHTML = '<i class="fas fa-info"></i>';
                infoIcon.dataset.tooltip = label.dataset.info;
                label.appendChild(infoIcon);
            }
        });
    });

    // Database reset functions
    async function resetArticlesData() {
        const confirmed = confirm(
            'WARNING: This will permanently delete ALL of the following data:\n\n' +
            '• Articles (enriched and raw)\n' +
            '• Article annotations\n' +
            '• Keyword alerts and matches\n' +
            '• Keyword groups and monitored keywords\n' +
            '• Podcasts\n' +
            '• Feed items and sources\n' +
            '• Model bias arena data\n' +
            '• Analysis versions and cache\n' +
            '• Signal alerts and incidents\n' +
            '• ChromaDB vector store\n\n' +
            'This action CANNOT be undone. Are you absolutely sure?'
        );

        if (!confirmed) return;

        const doubleConfirm = confirm('Last chance! Type confirmation not available - click OK to proceed with deletion.');
        if (!doubleConfirm) return;

        try {
            const button = document.getElementById('reset-articles-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';

            const response = await fetch('/api/reset-articles-data', {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to reset articles data');
            }

            const result = await response.json();
            showAlert(result.message, 'success');

            // Refresh database info
            await loadDatabaseInfo();

        } catch (error) {
            console.error('Error resetting articles data:', error);
            showAlert('Error resetting articles data: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('reset-articles-btn');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-trash-alt"></i> Reset Articles';
        }
    }

    async function resetAuspexChats() {
        const confirmed = confirm(
            'WARNING: This will permanently delete ALL Auspex chat history:\n\n' +
            '• All chat conversations\n' +
            '• All messages\n\n' +
            'This action CANNOT be undone. Continue?'
        );

        if (!confirmed) return;

        try {
            const button = document.getElementById('reset-auspex-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';

            const response = await fetch('/api/reset-auspex-chats', {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to reset Auspex chats');
            }

            const result = await response.json();
            showAlert(result.message, 'success');

        } catch (error) {
            console.error('Error resetting Auspex chats:', error);
            showAlert('Error resetting Auspex chats: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('reset-auspex-btn');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-comments"></i> Reset Auspex Chats';
        }
    }

    async function reindexChromaDB() {
        const confirmed = confirm(
            'This will re-index all articles from the database into ChromaDB.\n\n' +
            'The existing ChromaDB collection will be deleted and recreated.\n\n' +
            'Note: ChromaDB uses its own SQLite database (separate from main database).\n\n' +
            'This may take several minutes depending on the number of articles.\n\n' +
            'Continue?'
        );

        if (!confirmed) return;

        try {
            const button = document.getElementById('reindex-chromadb-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reindexing...';

            const response = await fetch('/api/reindex-chromadb', {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to reindex ChromaDB');
            }

            const result = await response.json();
            showAlert(
                `${result.message}\n\nIndexed: ${result.indexed}, Failed: ${result.failed}, Total: ${result.total}`,
                'success'
            );

        } catch (error) {
            console.error('Error reindexing ChromaDB:', error);
            showAlert('Error reindexing ChromaDB: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('reindex-chromadb-btn');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-sync-alt"></i> Reindex ChromaDB';
        }
    }

    // Add showAlert function if not already defined
    if (typeof showAlert === 'undefined') {
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const alertContainer = document.querySelector('.alert-container') || document.body;
            alertContainer.appendChild(alertDiv);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    }

    // Function to reload environment variables (updated to handle multiple status elements)
    function reloadEnvironment() {
        const statusElements = [
            document.getElementById('reload-status'),
            document.getElementById('reload-status-ai')
        ];
        
        // Update all status elements
        statusElements.forEach(el => {
            if (el) el.innerHTML = '<span class="text-info">Reloading...</span>';
        });
        
        fetch('/api/reload_environment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                // Get available keys
                const availableKeys = Object.entries(data.keys_available || {})
                    .filter(([_, isAvailable]) => isAvailable)
                    .map(([provider]) => provider);
                
                const successMessage = `<span class="text-success">Environment reloaded successfully! Keys available: ${availableKeys.join(', ')}</span>`;
                
                // Update all status elements
                statusElements.forEach(el => {
                    if (el) el.innerHTML = successMessage;
                });
                
                // Refresh the provider lists after reload
                setTimeout(() => {
                    loadProviders();
                    loadAIModels();
                    
                    // Clear all status elements
                    statusElements.forEach(el => {
                        if (el) el.innerHTML = '';
                    });
                }, 3000);
            }
        })
        .catch(error => {
            const errorMessage = `<span class="text-danger">Error: ${error.message}</span>`;
            
            // Update all status elements
            statusElements.forEach(el => {
                if (el) el.innerHTML = errorMessage;
            });
            
            setTimeout(() => {
                // Clear all status elements
                statusElements.forEach(el => {
                    if (el) el.innerHTML = '';
                });
            }, 3000);
        });
    }

    // Add a function to load the current Bluesky credentials
    async function loadBlueskyCredentials() {
        try {
            const response = await fetch('/config/bluesky');
            const data = await response.json();
            
            if (response.ok && data.configured) {
                // If credentials exist, show a message but don't populate the password field for security
                document.getElementById('bluesky-username').value = data.username || '';
                // Don't populate password field for security reasons
                
                const blueskyForm = document.getElementById('bluesky-config-form');
                if (!blueskyForm.querySelector('.credentials-info')) {
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'alert alert-info mt-3 credentials-info';
                    infoDiv.innerHTML = `
                        <i class="fas fa-info-circle me-2"></i>
                        Bluesky credentials are configured. You can update them by entering new values.
                    `;
                    blueskyForm.insertBefore(infoDiv, blueskyForm.querySelector('button'));
                }
            }
        } catch (error) {
            console.error('Error loading Bluesky credentials:', error);
        }
    }

    // Add this function to load providers from provider_config.json
    async function loadProviderOptions() {
        try {
            const response = await fetch('/api/providers');
            const data = await response.json();
            const providerSelect = document.getElementById('provider-name');
            providerSelect.innerHTML = '<option value="">Select a provider</option>';
            
            // Define provider categories and order (same as in loadAvailableProviders)
            const categories = [
                {
                    name: "News Feeds",
                    providers: ["newsapi", "thenewsapi", "newsdata"]
                },
                {
                    name: "Scrapers",
                    providers: ["firecrawl"]
                },
                {
                    name: "Text-to-Speech",
                    providers: ["elevenlabs", "dia"]
                }
                // Don't include Social Media/Bluesky here since it uses a different auth method
            ];
            
            // Loop through categories and add options in groups
            for (const category of categories) {
                // Create option group
                const optgroup = document.createElement('optgroup');
                optgroup.label = category.name;
                
                // Add providers from this category
                let hasProvidersInCategory = false;
                for (const providerName of category.providers) {
                    const provider = data.providers.find(p => 
                        p.name === providerName && 
                        p.config_type === 'api_key' && 
                        p.name !== 'bluesky'
                    );
                    
                    if (provider) {
                        const option = document.createElement('option');
                        option.value = provider.name;
                        option.textContent = provider.display_name;
                        option.dataset.configType = provider.config_type;
                        optgroup.appendChild(option);
                        hasProvidersInCategory = true;
                    }
                }
                
                // Only add the optgroup if it contains providers
                if (hasProvidersInCategory) {
                    providerSelect.appendChild(optgroup);
                }
            }
        } catch (error) {
            console.error('Error loading providers:', error);
        }
    }

    // Functions for topic export/import
    async function exportTopicConfigurations() {
        try {
            const button = document.getElementById('export-topics');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

            const response = await fetch('/api/export-topics');
            if (!response.ok) {
                throw new Error('Failed to export topic configurations');
            }

            const data = await response.json();

            // Create and download JSON file
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `topic-configurations-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showAlert('Topic configurations exported successfully', 'success');
        } catch (error) {
            console.error('Error exporting topic configurations:', error);
            showAlert('Error exporting topic configurations: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('export-topics');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-download"></i> Export Topics';
        }
    }

    async function showTopicImportDialog() {
        try {
            // Create modal from template
            const template = document.getElementById('topic-import-dialog-template');
            const modalContainer = template.content.cloneNode(true);
            document.body.appendChild(modalContainer);

            // Get the modal element - use the one we just added
            const modalElement = document.body.querySelector('.modal:last-child');

            // Create backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);

            // Initialize Bootstrap modal
            const modal = new bootstrap.Modal(modalElement);

            // Add cleanup handler
            modalElement.addEventListener('hidden.bs.modal', () => {
                modal.dispose();
                modalElement.remove();
                backdrop.remove();
            });

            // Show modal
            modal.show();

        } catch (error) {
            console.error('Error showing topic import dialog:', error);
            showAlert('Failed to show topic import dialog: ' + error.message, 'danger');
        }
    }

    async function importTopicConfigurations() {
        const modalElement = document.querySelector('.modal');
        if (!modalElement) {
            console.error('Modal element not found');
            return;
        }

        const fileInput = modalElement.querySelector('#topic-config-upload');
        const importButton = modalElement.querySelector('.modal-footer .btn-primary');
        const mergeMode = modalElement.querySelector('#merge-mode').checked;

        if (!fileInput.files[0]) {
            showAlert('Please select a configuration file to import', 'warning');
            return;
        }

        try {
            if (importButton) {
                importButton.disabled = true;
                importButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importing...';
            }

            // Read the JSON file
            const file = fileInput.files[0];
            const fileContent = await file.text();
            const configData = JSON.parse(fileContent);

            // Send to API
            const response = await fetch(`/api/import-topics?merge_mode=${mergeMode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(configData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }

            const result = await response.json();
            showAlert(result.message || 'Successfully imported topic configurations', 'success');

            // Close modal and refresh
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
            location.reload();

        } catch (error) {
            console.error('Error importing topic configurations:', error);
            showAlert('Failed to import topic configurations: ' + error.message, 'danger');
        } finally {
            if (importButton) {
                importButton.disabled = false;
                importButton.innerHTML = 'Import';
            }
        }
    }

    // Functions for article export/import
    async function exportEnrichedArticles() {
        try {
            const button = document.getElementById('export-enriched-articles');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

            const response = await fetch('/api/export-articles-enriched');
            if (!response.ok) {
                throw new Error('Failed to export enriched articles');
            }

            const data = await response.json();

            // Create and download JSON file
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `articles-enriched-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showAlert(`Successfully exported ${data.total_articles} enriched articles`, 'success');
        } catch (error) {
            console.error('Error exporting enriched articles:', error);
            showAlert('Error exporting enriched articles: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('export-enriched-articles');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-download"></i> Export Enriched Data';
        }
    }

    async function exportRawArticles() {
        try {
            const button = document.getElementById('export-raw-articles');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

            const response = await fetch('/api/export-articles-raw');
            if (!response.ok) {
                throw new Error('Failed to export raw articles');
            }

            const data = await response.json();

            // Create and download JSON file
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `articles-raw-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showAlert(`Successfully exported ${data.total_articles} raw articles`, 'success');
        } catch (error) {
            console.error('Error exporting raw articles:', error);
            showAlert('Error exporting raw articles: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('export-raw-articles');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-file-export"></i> Export Raw Data';
        }
    }

    async function showArticleImportDialog() {
        try {
            // Create modal from template
            const template = document.getElementById('article-import-dialog-template');
            const modalContainer = template.content.cloneNode(true);
            document.body.appendChild(modalContainer);

            // Get the modal element
            const modalElement = document.body.querySelector('.modal:last-child');

            // Create backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);

            // Initialize Bootstrap modal
            const modal = new bootstrap.Modal(modalElement);

            // Add cleanup handler
            modalElement.addEventListener('hidden.bs.modal', () => {
                modal.dispose();
                modalElement.remove();
                backdrop.remove();
            });

            // Show modal
            modal.show();

        } catch (error) {
            console.error('Error showing article import dialog:', error);
            showAlert('Failed to show article import dialog: ' + error.message, 'danger');
        }
    }

    async function importArticleData() {
        const modalElement = document.querySelector('.modal');
        if (!modalElement) {
            console.error('Modal element not found');
            return;
        }

        const fileInput = modalElement.querySelector('#article-data-upload');
        const importButton = modalElement.querySelector('.modal-footer .btn-primary');
        const mergeMode = modalElement.querySelector('#article-merge-mode').checked;
        const skipDuplicates = modalElement.querySelector('#article-skip-duplicates').checked;
        const updateExisting = modalElement.querySelector('#article-update-existing').checked;

        if (!fileInput.files[0]) {
            showAlert('Please select an article data file to import', 'warning');
            return;
        }

        // Extra confirmation for replace mode
        if (!mergeMode) {
            const confirmed = confirm(
                'WARNING: You are about to REPLACE ALL existing articles with the imported data. ' +
                'This will permanently delete all current articles. Are you absolutely sure?'
            );
            if (!confirmed) {
                return;
            }
        }

        try {
            if (importButton) {
                importButton.disabled = true;
                importButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importing...';
            }

            // Read the JSON file
            const file = fileInput.files[0];
            const fileContent = await file.text();
            const articleData = JSON.parse(fileContent);

            // Validate data structure
            if (!articleData.articles || !Array.isArray(articleData.articles)) {
                throw new Error('Invalid article data file: missing or invalid "articles" array');
            }

            // Send to API with query parameters
            const params = new URLSearchParams({
                merge_mode: mergeMode,
                skip_duplicates: skipDuplicates,
                update_existing: updateExisting
            });

            const response = await fetch(`/api/import-articles?${params}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(articleData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to import articles');
            }

            const result = await response.json();

            // Build detailed message
            let message = result.message;
            if (result.statistics && result.statistics.errors && result.statistics.errors.length > 0) {
                message += `\n\nErrors encountered (${result.statistics.errors.length}):\n`;
                // Show first 5 errors
                const errorsToShow = result.statistics.errors.slice(0, 5);
                message += errorsToShow.join('\n');
                if (result.statistics.errors.length > 5) {
                    message += `\n... and ${result.statistics.errors.length - 5} more errors`;
                }
            }

            // Show success/warning based on results
            if (result.statistics && result.statistics.failed > 0) {
                showAlert(message, 'warning');
            } else {
                showAlert(result.message, 'success');
            }

            // Close modal and refresh
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();

            // Refresh database info
            await loadDatabaseInfo();

        } catch (error) {
            console.error('Error importing articles:', error);
            showAlert('Failed to import articles: ' + error.message, 'danger');
        } finally {
            if (importButton) {
                importButton.disabled = false;
                importButton.innerHTML = 'Import';
            }
        }
    }

    // Functions for cleaning orphaned data
    async function cleanOrphanedTopics() {
        if (!confirm('This will find and remove orphaned topic data from the system. Continue?')) {
            return;
        }

        try {
            const button = document.getElementById('clean-topics-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cleaning...';

            const response = await fetch('/api/keyword-monitor/clean-orphaned-topics', {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to clean orphaned topics');
            }

            const result = await response.json();

            if (result && result.orphaned_topics && result.orphaned_topics.length > 0) {
                showAlert(`Successfully cleaned up ${result.orphaned_topics.length} orphaned topics`, 'success');
                loadDatabaseInfo(); // Refresh database info
            } else {
                showAlert('No orphaned topics found', 'info');
            }
        } catch (error) {
            console.error('Error cleaning orphaned topics:', error);
            showAlert('Error cleaning orphaned topics: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('clean-topics-btn');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-broom"></i> Clean Topics';
        }
    }

    async function cleanOrphanedArticles() {
        if (!confirm('This will find and delete orphaned articles no longer associated with active topics. Continue?')) {
            return;
        }
        
        try {
            const button = document.getElementById('clean-articles-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cleaning...';
            
            const response = await fetch('/api/keyword-monitor/clean-orphaned-articles', {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to clean orphaned articles');
            }

            const result = await response.json();
            
            if (result && result.orphaned_count > 0) {
                showAlert(`Successfully cleaned up ${result.orphaned_count} orphaned articles and ${result.alerts_deleted} associated alerts`, 'success');
                loadDatabaseInfo(); // Refresh database info
            } else {
                showAlert('No orphaned articles found', 'info');
            }
        } catch (error) {
            console.error('Error cleaning orphaned articles:', error);
            showAlert('Error cleaning orphaned articles: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('clean-articles-btn');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-newspaper"></i> Clean Articles';
        }
    }

    async function cleanAllOrphaned() {
        if (!confirm('This will find and clean up ALL orphaned topics and articles. Continue?')) {
            return;
        }
        
        try {
            const button = document.getElementById('clean-all-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cleaning...';
            
            const response = await fetch('/api/keyword-monitor/clean-all-orphaned', {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to clean orphaned data');
            }

            const result = await response.json();

            // Check for errors or partial success
            if (result.status === 'error') {
                throw new Error(result.message || 'Failed to clean orphaned data');
            }

            // Format a nice summary
            let message = '';

            if (result.status === 'partial') {
                message = '⚠️ Clean-up completed with some errors:\n\n';
                if (result.message) {
                    message += `Errors: ${result.message}\n\n`;
                }
            } else {
                message = 'Clean-up completed successfully:\n\n';
            }

            // Topics summary
            const topicsResult = result && result.topics_result;
            if (topicsResult && topicsResult.status === 'error') {
                message += `❌ Topics cleanup failed: ${topicsResult.message}\n`;
            } else if (topicsResult && topicsResult.orphaned_topics && topicsResult.orphaned_topics.length > 0) {
                message += `✅ Removed ${topicsResult.orphaned_topics.length} orphaned topics\n`;

                if (topicsResult.cleanup_results) {
                    let totalGroups = 0;
                    let totalKeywords = 0;
                    let totalAlerts = 0;

                    Object.values(topicsResult.cleanup_results).forEach(result => {
                        totalGroups += result.groups_deleted || 0;
                        totalKeywords += result.keywords_deleted || 0;
                        totalAlerts += result.alerts_deleted || 0;
                    });

                    message += `   - ${totalGroups} groups\n`;
                    message += `   - ${totalKeywords} keywords\n`;
                    message += `   - ${totalAlerts} alerts\n`;
                }
            } else {
                message += '✓ No orphaned topics found\n';
            }

            // Articles summary
            const articlesResult = result && result.articles_result;
            if (articlesResult && articlesResult.status === 'error') {
                message += `❌ Articles cleanup failed: ${articlesResult.message}\n`;
            } else if (articlesResult && articlesResult.orphaned_count > 0) {
                message += `✅ Removed ${articlesResult.orphaned_count} orphaned articles and ${articlesResult.alerts_deleted || 0} associated alerts\n`;
            } else {
                message += '✓ No orphaned articles found\n';
            }

            alert(message);
            loadDatabaseInfo(); // Refresh database info
        } catch (error) {
            console.error('Error cleaning orphaned data:', error);
            showAlert('Error cleaning orphaned data: ' + error.message, 'danger');
        } finally {
            const button = document.getElementById('clean-all-btn');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-magic"></i> Clean All Orphaned';
        }
    }

    // ==================== User Management Functions (Added 2025-10-21) ====================

    console.log('=== USER MANAGEMENT SCRIPT LOADED ===');
    let currentUserInfo = null;

    // Load current user info and initialize user management
    async function loadCurrentUserInfo() {
        try {
            console.log('[Users] Loading current user info...');
            const response = await fetch('/api/users/me');
            console.log('[Users] /api/users/me response status:', response.status);

            if (!response.ok) {
                console.error('[Users] Failed to load current user info, status:', response.status);
                const text = await response.text();
                console.error('[Users] Response:', text);
                return;
            }

            currentUserInfo = await response.json();
            console.log('[Users] Current user info:', currentUserInfo);

            // Update role display
            const roleDisplay = document.getElementById('current-user-role-display');
            if (roleDisplay) {
                const roleClass = currentUserInfo.role === 'admin' ? 'badge bg-primary' : 'badge bg-secondary';
                roleDisplay.innerHTML = `<span class="${roleClass}">${currentUserInfo.role}</span>`;
                console.log('[Users] Updated role display');
            } else {
                console.warn('[Users] Role display element not found');
            }

            // Show admin section if user is admin
            console.log('[Users] User role:', currentUserInfo.role);
            if (currentUserInfo.role === 'admin') {
                console.log('[Users] User is admin, showing admin section...');
                const adminSection = document.getElementById('admin-user-management');
                if (adminSection) {
                    adminSection.style.display = 'block';
                    console.log('[Users] Admin section displayed');
                } else {
                    console.error('[Users] Admin section element not found!');
                }
            } else {
                console.log('[Users] User is not admin, hiding admin section');
            }

        } catch (error) {
            console.error('[Users] Error loading current user info:', error);
        }
    }

    // Load users list
    async function loadUsers() {
        try {
            const response = await fetch('/api/users/');

            // Handle non-admin users gracefully
            if (response.status === 403) {
                const container = document.getElementById('users-list-container');
                if (container) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Access Restricted</strong><br>
                            Only administrators can view the full user list.
                            If you need access to user management features, please contact your system administrator.
                        </div>
                    `;
                }
                return;
            }

            if (!response.ok) {
                throw new Error('Failed to load users');
            }

            const data = await response.json();
            const users = data.users || [];

            const container = document.getElementById('users-list-container');
            if (!container) return;

            if (users.length === 0) {
                container.innerHTML = '<p class="text-muted">No users found.</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped">';
            html += '<thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>';

            for (const user of users) {
                const statusBadge = user.is_active ?
                    '<span class="badge bg-success">Active</span>' :
                    '<span class="badge bg-danger">Inactive</span>';

                const roleBadge = user.role === 'admin' ?
                    '<span class="badge bg-primary">Admin</span>' :
                    '<span class="badge bg-secondary">User</span>';

                const oauthBadge = user.is_oauth ?
                    ' <span class="badge bg-info">OAuth</span>' : '';

                const isCurrentUser = currentUserInfo && user.username === currentUserInfo.username;

                let actions = '';
                if (currentUserInfo && currentUserInfo.role === 'admin') {
                    if (isCurrentUser) {
                        actions = '<span class="text-muted">You</span>';
                    } else {
                        actions = `
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.username}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        `;
                    }
                }

                html += `<tr>
                    <td>${user.username}${isCurrentUser ? ' <strong>(You)</strong>' : ''}</td>
                    <td>${user.email}</td>
                    <td>${roleBadge}${oauthBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                </tr>`;
            }

            html += '</tbody></table></div>';
            container.innerHTML = html;

        } catch (error) {
            console.error('Error loading users:', error);
            const container = document.getElementById('users-list-container');
            if (container) {
                container.innerHTML = `<div class="alert alert-danger">Error loading users: ${error.message}</div>`;
            }
        }
    }

    // Delete user function (needs to be global for onclick handlers)
    async function deleteUser(username) {
        if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/users/${username}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to delete user');
            }

            showAlert('User deleted successfully', 'success');
            loadUsers();

        } catch (error) {
            console.error('Error deleting user:', error);
            showAlert('Error deleting user: ' + error.message, 'danger');
        }
    }

    // Initialize user management when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[Users] DOM loaded, setting up user management...');

        // Attach create user form handler
        const createUserForm = document.getElementById('create-user-form');
        if (createUserForm) {
            console.log('[Users] Attaching create user form handler...');
            createUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Use FormData API for more reliable value extraction (especially for password fields)
                const formData = new FormData(e.target);
                const username = formData.get('create-username') || '';
                const email = formData.get('create-email') || '';
                const password = formData.get('create-password') || '';
                const role = formData.get('create-role') || '';
                const forcePasswordChange = formData.get('force-password-change') === 'on';
                const skipOnboarding = formData.get('skip-onboarding') === 'on';

                console.log('[Users] Form submitted via FormData!');
                console.log('[Users] Username:', username);
                console.log('[Users] Email:', email);
                console.log('[Users] Password length:', password.length);
                console.log('[Users] Password value (first 3 chars):', password.substring(0, 3) + '...');
                console.log('[Users] Role:', role);
                console.log('[Users] Force password change:', forcePasswordChange);
                console.log('[Users] Skip onboarding:', skipOnboarding);

                if (password.length < 8) {
                    console.error('[Users] Password too short! Length is', password.length, 'but need 8+');
                    showAlert('Password must be at least 8 characters (current length: ' + password.length + ')', 'danger');
                    return;
                }

                console.log('[Users] Password validation passed, creating user...');

                try {
                    const response = await fetch('/api/users/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username,
                            email,
                            password,
                            role,
                            force_password_change: forcePasswordChange,
                            completed_onboarding: skipOnboarding
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to create user');
                    }

                    showAlert('User created successfully', 'success');

                    // Reset form
                    createUserForm.reset();

                    // Reload users list
                    loadUsers();

                } catch (error) {
                    console.error('Error creating user:', error);
                    showAlert('Error creating user: ' + error.message, 'danger');
                }
            });
        } else {
            console.warn('[Users] Create user form not found!');
        }

        // Setup tab event listener
        const usersTabButton = document.getElementById('users-tab');
        console.log('[Users] Users tab button element:', usersTabButton);

        if (usersTabButton) {
            console.log('[Users] Attaching event listeners to users tab...');

            // Use Bootstrap's shown.bs.tab event (fires after tab is fully shown)
            usersTabButton.addEventListener('shown.bs.tab', function (event) {
                console.log('[Users] Users tab shown event fired!');
                loadCurrentUserInfo();
                loadUsers();
            });

            console.log('[Users] Event listeners attached successfully');
        } else {
            console.error('[Users] ERROR: Users tab button NOT FOUND! Check HTML.');
        }

        // Load user info if Users tab is already active on page load
        const usersTab = document.getElementById('users');
        if (usersTab && usersTab.classList.contains('active')) {
            console.log('[Users] Users tab is already active, loading data...');
            loadCurrentUserInfo();
            loadUsers();
        }
    });

    // ==================== End User Management Functions ====================
</script>{% endblock %}

