{% extends "base.html" %}
{% block title %}Topic Wizard - AuNoo AI{% endblock %}

{% block extra_css %}
<style>
    .step {
        display: none;
    }
    .step.active {
        display: block;
    }
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
    }
    .step-dot {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .step-dot.active {
        background-color: var(--primary-color);
        color: white;
    }
    .step-dot.completed {
        background-color: var(--secondary-color);
        color: white;
    }
    .step-line {
        flex: 1;
        height: 2px;
        background-color: #e9ecef;
        margin: 15px 10px;
    }
    .step-line.completed {
        background-color: var(--secondary-color);
    }
    .api-key-status {
        display: none;
        margin-top: 0.5rem;
    }
    .topic-suggestions {
        display: none;
        margin-top: 1rem;
    }
    .example-value {
        display: inline-block;
        padding: 0.35em 0.8em;
        margin: 0.2rem;
        background-color: rgba(255, 105, 180, 0.15);
        color: var(--primary-color);
        border: 1px solid rgba(255, 105, 180, 0.3);
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
        position: relative;
    }

    .example-value:hover {
        background-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .example-value:hover::after {
        content: "Click to add";
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        white-space: nowrap;
    }

    .tags-input {
        border: 1px solid rgba(255, 105, 180, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        min-height: 100px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: flex-start;
        background-color: white;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        background-color: rgba(255, 105, 180, 0.1);
        color: var(--primary-color);
        padding: 0.35em 0.8em;
        border-radius: 12px;
        font-size: 0.75em;
        border: 1px solid rgba(255, 105, 180, 0.2);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .tag .remove {
        margin-left: 0.5rem;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s;
    }

    .tag .remove:hover {
        opacity: 1;
    }

    .tags-input input {
        border: none;
        outline: none;
        padding: 0.2rem;
        flex-grow: 1;
        min-width: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h2 class="text-center mb-4">Welcome to AuNoo AI</h2>
                    
                    <!-- Step Indicators -->
                    <div class="step-indicator mb-4">
                        <div class="step-dot active" data-step="1">1</div>
                        <div class="step-line"></div>
                        <div class="step-dot" data-step="2">2</div>
                        <div class="step-line"></div>
                        <div class="step-dot" data-step="3">3</div>
                    </div>

                    <!-- Step 1: API Keys -->
                    <div class="step active" id="step1">
                        <h4>Step 1: Configure API Keys</h4>
                        <p class="text-muted">Set up your API keys for AI and news services</p>

                        <!-- LLM Provider Selection -->
                        <div class="mb-3">
                            <label for="llm-provider" class="form-label">AI Provider</label>
                            <select class="form-select" id="llm-provider" name="llm-provider" onchange="updateLLMProviderUI()">
                                <option value="">Select an AI provider</option>
                                <option value="openai">OpenAI (GPT-4, GPT-4o, etc.)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="gemini">Google Gemini</option>
                            </select>
                            <small class="text-muted">Choose your AI provider - one key works for all models from that provider.</small>
                        </div>

                        <!-- LLM API Key -->
                        <div class="mb-3" id="llm-key-section" style="display: none;">
                            <label for="llm-key" class="form-label"><span id="llm-provider-name">AI Provider</span> API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="llm-key" name="llm-key" placeholder="Enter API key">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('llm-key')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" onclick="testApiKey('llm')">Test</button>
                            </div>
                            <div id="llm-status" class="api-key-status"></div>
                            <small class="text-muted"><span id="llm-help-text">Enter your API key</span>. <a href="#" id="llm-register-link" target="_blank" rel="noopener">Get API key&nbsp;↗</a></small>
                        </div>

                        <!-- News Provider Selection -->
                        <div class="mb-3">
                            <label for="news-provider" class="form-label">News Provider</label>
                            <select class="form-select" id="news-provider" name="news-provider" onchange="updateNewsProviderUI()">
                                <option value="">Select a news provider</option>
                                <option value="newsapi">NewsAPI</option>
                                <option value="thenewsapi">TheNewsAPI</option>
                                <option value="newsdata">NewsData.io</option>
                            </select>
                            <small class="text-muted">Choose your news data provider.</small>
                        </div>

                        <!-- News API Key -->
                        <div class="mb-3" id="news-key-section" style="display: none;">
                            <label for="news-key" class="form-label"><span id="news-provider-name">News Provider</span> API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="news-key" name="news-key" placeholder="Enter API key">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('news-key')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" onclick="testApiKey('news')">Test</button>
                            </div>
                            <div id="news-status" class="api-key-status"></div>
                            <small class="text-muted">Required for fetching news articles. <a href="#" id="news-register-link" target="_blank" rel="noopener">Register here&nbsp;↗</a></small>
                        </div>

                        <!-- Firecrawl Key -->
                        <div class="mb-3">
                            <label for="firecrawl-key" class="form-label">Firecrawl Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="firecrawl-key" name="firecrawl-key" placeholder="Enter API key">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('firecrawl-key')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" onclick="testApiKey('firecrawl')">Test</button>
                            </div>
                            <div id="firecrawl-status" class="api-key-status"></div>
                            <small class="text-muted">Required for web scraping and data collection. <a href="https://www.firecrawl.dev/pricing" target="_blank" rel="noopener">Free plan&nbsp;↗</a>.</small>
                        </div>
                    </div>

                    <!-- Step 2: Topic Setup -->
                    <div class="step" id="step2">
                        <h4>Step 2: Set Up Your First Topic</h4>
                        <p class="text-muted">Create a topic to start monitoring</p>
                        
                        <div class="alert alert-secondary small">
                            <p>At the core of <strong>AuNoo AI</strong> are <strong>topics</strong>—flexible constructs that can represent markets, knowledge fields, organizations, or even specific strategic questions. For instance:</p>
                            <ul class="mb-2">
                                <li><strong>Markets</strong>: Cloud Service Providers, EV Battery Suppliers, or Threat Intelligence Providers.</li>
                                <li><strong>Knowledge Fields</strong>: Neurology, AI, or Archeology.</li>
                                <li><strong>Organizations or People</strong>: AI researchers, competitors, or even a favorite sports team.</li>
                                <li><strong>Scenarios</strong>: Questions like "Is AI hype?" or "How strong is the Cloud Repatriation movement?"</li>
                            </ul>
                            <p class="mb-0" id="categories-intro" style="display:none;"><strong>Categories:</strong> Each topic is broken down into categories, making it easier to organize and analyze data. For example, a topic on AI might include sub-categories like <em>AI in Finance</em> or <em>Cloud Quarterly Earnings</em>.</p>
                        </div>

                        <div class="mb-3">
                            <label for="topic-name" class="form-label">Topic Name</label>
                            <input type="text" class="form-control" id="topic-name" name="topic-name">
                            <small class="text-muted">Enter a descriptive name for your topic</small>
                        </div>

                        <div class="mb-3">
                            <label for="topic-description" class="form-label">Topic Description (Optional)</label>
                            <textarea class="form-control" id="topic-description" name="topic-description" rows="3" placeholder="Provide additional details about this topic to improve attribute suggestions"></textarea>
                            <small class="text-muted">A brief description helps the AI provide better suggestions</small>
                        </div>

                        <div class="mb-3">
                            <button class="btn btn-outline-primary" type="button" onclick="suggestAttributes()">
                                <i class="fas fa-magic"></i> Suggest Categories
                            </button>
                        </div>

                        <div id="topic-suggestions" class="topic-suggestions">
                            <div class="mb-4">
                                <label for="future-signals" class="form-label">Future Signals</label>
                                <p class="text-muted mb-2">Future Signals are scenarios that suggest potential directions for a topic. For instance, signals for an AI hype model could range from <span class="text-blue-600">"AI is hype"</span> and <span class="text-blue-600">"AI is evolving gradually"</span>, to <span class="text-blue-600">"AI is accelerating"</span>.</p>
                                <div class="tags-input" id="futureSignalsContainer">
                                    <input type="text" id="futureSignalsInput" placeholder="Type and press Enter to add">
                                </div>
                                <small class="text-muted">Add signals that indicate future developments. Examples:</small>
                                <div class="example-list mt-2">
                                    {% for signal in example_signals[:5] %}
                                        <span class="example-value text-blue-600" onclick="addExampleValue('futureSignalsInput', '{{ signal }}')">{{ signal }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="categories" class="form-label">Categories</label>
                                <p class="text-muted mb-2">Each topic is broken down into categories, making it easier to organize and analyze data. For example, a topic on AI might include subcategories like <span class="text-blue-600">AI in Finance</span> or <span class="text-blue-600">Cloud Quarterly Earnings</span>.</p>
                                <div class="tags-input" id="categoriesContainer">
                                    <input type="text" id="categoriesInput" placeholder="Type and press Enter to add">
                                </div>
                                <small class="text-muted">Add categories that describe your topic. Examples:</small>
                                <div class="example-list mt-2">
                                    {% for category in example_categories[:5] %}
                                        <span class="example-value text-blue-600" onclick="addExampleValue('categoriesInput', '{{ category }}')">{{ category }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="sentiment" class="form-label">Sentiment Options</label>
                                <p class="text-muted mb-2">AuNoo goes beyond basic positive, neutral, and negative sentiment analysis. It can detect tones such as <span class="text-blue-600">mocking</span>, <span class="text-blue-600">critical</span>, <span class="text-blue-600">hyperbolic</span>, or <span class="text-blue-600">optimistic</span>, providing a nuanced understanding of public and media sentiment.</p>
                                <div class="tags-input" id="sentimentsContainer">
                                    <input type="text" id="sentimentsInput" placeholder="Type and press Enter to add">
                                </div>
                                <small class="text-muted">Add sentiment categories for tracking articles. Common options:</small>
                                <div class="example-list mt-2">
                                    {% for sentiment in example_sentiments %}
                                        <span class="example-value text-blue-600" onclick="addExampleValue('sentimentsInput', '{{ sentiment }}')">{{ sentiment }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="time-to-impact" class="form-label">Time to Impact</label>
                                <p class="text-muted mb-2">Time to Impact helps assess when the impact of a trend is expected—<span class="text-blue-600">immediate</span>, <span class="text-blue-600">short-term (3–18 months)</span>, <span class="text-blue-600">mid-term (18–60 months)</span>, or <span class="text-blue-600">long-term (5+ years)</span>. This allows decision-makers to prioritize their strategies effectively. It is based on the Three Horizon Model.</p>
                                <div class="tags-input" id="timeToImpactContainer">
                                    <input type="text" id="timeToImpactInput" placeholder="Type and press Enter to add">
                                </div>
                                <small class="text-muted">Add time ranges for expected impact. Common ranges:</small>
                                <div class="example-list mt-2">
                                    {% for time in example_time_to_impact %}
                                        <span class="example-value text-blue-600" onclick="addExampleValue('timeToImpactInput', '{{ time }}')">{{ time }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="driver-types" class="form-label">Driver Types</label>
                                <p class="text-muted mb-2">AuNoo categorizes data points based on their impact on a topic, using types like:
                                    <br>• <span class="text-blue-600"><strong>Accelerator</strong>: Speeds up the development or impact of a trend.</span>
                                    <br>• <span class="text-blue-600"><strong>Delayer</strong>: Slows down progress.</span>
                                    <br>• <span class="text-blue-600"><strong>Blocker</strong>: Prevents a trend from advancing.</span>
                                    <br>• <span class="text-blue-600"><strong>Catalyst</strong>: Significantly amplifies or transforms the trajectory of a trend.</span>
                                </p>
                                <div class="tags-input" id="driverTypesContainer">
                                    <input type="text" id="driverTypesInput" placeholder="Type and press Enter to add">
                                </div>
                                <small class="text-muted">Add types of drivers that influence the topic. Common types:</small>
                                <div class="example-list mt-2">
                                    {% for driver in example_driver_types %}
                                        <span class="example-value text-blue-600" onclick="addExampleValue('driverTypesInput', '{{ driver }}')">{{ driver }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Explanation</label>
                                <p id="suggestion-explanation" class="text-muted"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Keywords -->
                    <div class="step" id="step3">
                        <h4>Step 3: Set Up Keywords</h4>
                        <p class="text-muted">Add keywords to monitor for your topic</p>
                        
                        <div class="mb-4">
                            <label class="form-label">Keywords</label>
                            <p class="text-muted">Enter keywords to monitor. You can separate multiple keywords with commas.</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Companies & Organizations</label>
                                    <div class="tags-input" id="companiesContainer">
                                        <input type="text" id="companiesInput" placeholder="Add companies (comma-separated)">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Technologies</label>
                                    <div class="tags-input" id="technologiesContainer">
                                        <input type="text" id="technologiesInput" placeholder="Add technologies (comma-separated)">
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">General Keywords</label>
                                    <div class="tags-input" id="generalKeywordsContainer">
                                        <input type="text" id="generalKeywordsInput" placeholder="Add general keywords (comma-separated)">
                                    </div>
                                    <small class="text-muted">Keywords that don't fit into specific categories above</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">People</label>
                                    <div class="tags-input" id="peopleContainer">
                                        <input type="text" id="peopleInput" placeholder="Add people (comma-separated)">
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Exclusion Keywords</label>
                                    <div class="tags-input" id="exclusionKeywordsContainer">
                                        <input type="text" id="exclusionKeywordsInput" placeholder="Add exclusions (prefix with - or NOT)">
                                    </div>
                                    <small class="text-muted">Prefix with minus (-) or "NOT" to exclude terms from search results</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Suggested keywords for your topic:</label>
                            <div id="keyword-suggestions" class="example-list mt-2"></div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-secondary" onclick="prevStep()" id="prevBtn" style="display: none;">
                            Previous
                        </button>
                        <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
const totalSteps = 3;

// Global variable to store keywords from step 2
let storedKeywords = null;

// Add this function for password visibility toggle
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Add this after the style definitions and before the functions
let validatedKeys = {
    llm: false,
    news: false,
    firecrawl: false
};

// Provider configuration
const providerInfo = {
    openai: {
        name: 'OpenAI',
        link: 'https://platform.openai.com/api-keys',
        help: 'Supports GPT-4, GPT-4o, GPT-4.1-mini, and more'
    },
    anthropic: {
        name: 'Anthropic',
        link: 'https://console.anthropic.com/settings/keys',
        help: 'Supports Claude 3.5 Sonnet, Claude 4 Sonnet, and more'
    },
    gemini: {
        name: 'Google Gemini',
        link: 'https://aistudio.google.com/app/apikey',
        help: 'Supports Gemini Pro, Gemini 2.0 Flash, and more'
    },
    newsapi: {
        name: 'NewsAPI',
        link: 'https://newsapi.org/register'
    },
    thenewsapi: {
        name: 'TheNewsAPI',
        link: 'https://www.thenewsapi.com/register'
    },
    newsdata: {
        name: 'NewsData.io',
        link: 'https://newsdata.io/register'
    }
};

// Update UI when LLM provider is selected
function updateLLMProviderUI() {
    const provider = document.getElementById('llm-provider').value;
    const section = document.getElementById('llm-key-section');
    const nameSpan = document.getElementById('llm-provider-name');
    const helpText = document.getElementById('llm-help-text');
    const link = document.getElementById('llm-register-link');

    if (provider && providerInfo[provider]) {
        section.style.display = 'block';
        nameSpan.textContent = providerInfo[provider].name;
        helpText.textContent = providerInfo[provider].help;
        link.href = providerInfo[provider].link;
    } else {
        section.style.display = 'none';
    }
}

// Update UI when news provider is selected
function updateNewsProviderUI() {
    const provider = document.getElementById('news-provider').value;
    const section = document.getElementById('news-key-section');
    const nameSpan = document.getElementById('news-provider-name');
    const link = document.getElementById('news-register-link');

    if (provider && providerInfo[provider]) {
        section.style.display = 'block';
        nameSpan.textContent = providerInfo[provider].name;
        link.href = providerInfo[provider].link;
    } else {
        section.style.display = 'none';
    }
}

// Modify the testApiKey function to track successful validations
async function testApiKey(type) {
    const statusDiv = document.getElementById(`${type}-status`);
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = 'Testing...';
    statusDiv.className = 'api-key-status text-muted';

    let provider;
    let api_key;

    if (type === 'llm') {
        provider = document.getElementById('llm-provider').value;
        if (!provider) {
            statusDiv.innerHTML = 'Please select an AI provider first';
            statusDiv.className = 'api-key-status text-danger';
            return;
        }
        api_key = document.getElementById('llm-key').value;
    } else if (type === 'news') {
        provider = document.getElementById('news-provider').value;
        if (!provider) {
            statusDiv.innerHTML = 'Please select a news provider first';
            statusDiv.className = 'api-key-status text-danger';
            return;
        }
        api_key = document.getElementById('news-key').value;
    } else if (type === 'firecrawl') {
        provider = 'firecrawl';
        api_key = document.getElementById('firecrawl-key').value;
    }

    try {
        const response = await fetch('/api/onboarding/validate-api-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                provider: provider,
                api_key: api_key
            })
        });

        const data = await response.json();
        if (response.ok && data.configured) {
            statusDiv.innerHTML = 'Key configured ✓';
            statusDiv.className = 'api-key-status text-success';

            // Track successful validation
            validatedKeys[type] = true;

            // Update the input field with masked key
            const inputField = document.getElementById(`${type}-key`);
            inputField.value = data.masked_key;
            inputField.placeholder = 'Key configured - click to view/edit';
        } else {
            statusDiv.innerHTML = data.detail || 'Invalid key';
            statusDiv.className = 'api-key-status text-danger';
            validatedKeys[type] = false;
        }
    } catch (error) {
        statusDiv.innerHTML = `Error: ${error.message}`;
        statusDiv.className = 'api-key-status text-danger';
        validatedKeys[type] = false;
    }
}

// Check existing keys and pre-populate if configured
async function checkExistingKeys() {
    try {
        const response = await fetch('/api/onboarding/check-keys');
        const keyStatus = await response.json();
        console.log("API Key status:", keyStatus);

        // Check OpenAI
        if (keyStatus.openai) {
            validatedKeys.llm = true;
            document.getElementById('llm-provider').value = 'openai';
            updateLLMProviderUI();
            const statusDiv = document.getElementById('llm-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'OpenAI key configured ✓';
            statusDiv.className = 'api-key-status text-success';
            document.getElementById('llm-key').value = keyStatus.openai_key || '';
            document.getElementById('llm-key').placeholder = 'Key configured - click to view/edit';
        } else if (keyStatus.anthropic) {
            validatedKeys.llm = true;
            document.getElementById('llm-provider').value = 'anthropic';
            updateLLMProviderUI();
            const statusDiv = document.getElementById('llm-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'Anthropic key configured ✓';
            statusDiv.className = 'api-key-status text-success';
            document.getElementById('llm-key').value = keyStatus.anthropic_key || '';
            document.getElementById('llm-key').placeholder = 'Key configured - click to view/edit';
        } else if (keyStatus.gemini) {
            validatedKeys.llm = true;
            document.getElementById('llm-provider').value = 'gemini';
            updateLLMProviderUI();
            const statusDiv = document.getElementById('llm-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'Gemini key configured ✓';
            statusDiv.className = 'api-key-status text-success';
            document.getElementById('llm-key').value = keyStatus.gemini_key || '';
            document.getElementById('llm-key').placeholder = 'Key configured - click to view/edit';
        }

        // Check news providers
        if (keyStatus.newsapi) {
            validatedKeys.news = true;
            document.getElementById('news-provider').value = 'newsapi';
            updateNewsProviderUI();
            const statusDiv = document.getElementById('news-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'NewsAPI key configured ✓';
            statusDiv.className = 'api-key-status text-success';
            document.getElementById('news-key').value = keyStatus.newsapi_key || '';
            document.getElementById('news-key').placeholder = 'Key configured - click to view/edit';
        } else if (keyStatus.thenewsapi) {
            validatedKeys.news = true;
            document.getElementById('news-provider').value = 'thenewsapi';
            updateNewsProviderUI();
            const statusDiv = document.getElementById('news-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'TheNewsAPI key configured ✓';
            statusDiv.className = 'api-key-status text-success';
            document.getElementById('news-key').value = keyStatus.thenewsapi_key || '';
            document.getElementById('news-key').placeholder = 'Key configured - click to view/edit';
        } else if (keyStatus.newsdata) {
            validatedKeys.news = true;
            document.getElementById('news-provider').value = 'newsdata';
            updateNewsProviderUI();
            const statusDiv = document.getElementById('news-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'NewsData.io key configured ✓';
            statusDiv.className = 'api-key-status text-success';
            document.getElementById('news-key').value = keyStatus.newsdata_key || '';
            document.getElementById('news-key').placeholder = 'Key configured - click to view/edit';
        }

        // Check firecrawl
        if (keyStatus.firecrawl) {
            validatedKeys.firecrawl = true;
            const statusDiv = document.getElementById('firecrawl-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'Firecrawl key configured ✓';
            statusDiv.className = 'api-key-status text-success';
            document.getElementById('firecrawl-key').value = keyStatus.firecrawl_key || '';
            document.getElementById('firecrawl-key').placeholder = 'Key configured - click to view/edit';
        }
    } catch (error) {
        console.error("Error checking API keys:", error);
    }
}

// Validate all required keys before proceeding
async function validateAllKeys() {
    const required = ['llm', 'news', 'firecrawl'];

    for (const type of required) {
        if (!validatedKeys[type]) {
            const key = document.getElementById(`${type}-key`)?.value;
            const provider = document.getElementById(`${type}-provider`)?.value;

            if (type === 'llm' && !provider) {
                showErrorMessage("Please select an AI provider");
                return false;
            }

            if (type === 'news' && !provider) {
                showErrorMessage("Please select a news provider");
                return false;
            }

            if (!key) {
                const name = type === 'llm' ? 'AI provider' : type === 'news' ? 'news provider' : type;
                showErrorMessage(`Please enter ${name} API key`);
                return false;
            }

            // Auto-test the key if not already validated
            try {
                await testApiKey(type);

                if (!validatedKeys[type]) {
                    showErrorMessage(`Please test and validate the ${type === 'llm' ? 'AI provider' : type === 'news' ? 'news provider' : type} key`);
                    return false;
                }
            } catch (error) {
                console.error(`Error validating ${type} key:`, error);
                showErrorMessage(`Error validating ${type} key: ${error.message}`);
                return false;
            }
        }
    }

    return true;
}

// Update the styling for suggestions
const styleUpdate = document.createElement('style');
styleUpdate.textContent = `
    .keyword-category {
        margin-bottom: 1rem;
        border-left: 3px solid var(--primary-color);
        padding-left: 10px;
    }
    
    .keyword-category h6 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .example-value {
        display: inline-flex;
        align-items: center;
        padding: 0.35em 0.8em;
        margin: 0.2rem;
        background-color: rgba(255, 105, 180, 0.15);
        color: var(--primary-color);
        border: 1px solid rgba(255, 105, 180, 0.3);
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
        position: relative;
    }
    
    .example-value:before {
        content: attr(data-category);
        display: none;
        position: absolute;
        top: -18px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.65rem;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        white-space: nowrap;
    }
    
    .example-value:hover:before {
        display: block;
    }

    .example-value:hover {
        background-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .example-value:hover::after {
        content: "Click to add";
        position: absolute;
        bottom: -18px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        white-space: nowrap;
    }
    
    .companies-tag { border-color: #4285f4; }
    .companies-tag:before { content: "Company"; }
    
    .technologies-tag { border-color: #ea4335; }
    .technologies-tag:before { content: "Technology"; }
    
    .general-tag { border-color: #fbbc05; }
    .general-tag:before { content: "General"; }
    
    .people-tag { border-color: #34a853; }
    .people-tag:before { content: "Person"; }
    
    .exclusions-tag { border-color: #ff6d01; }
    .exclusions-tag:before { content: "Exclusion"; }
`;
document.head.appendChild(styleUpdate);

function createTagInput(containerId, inputId) {
    const container = document.getElementById(containerId);
    const input = document.getElementById(inputId);
    const tags = new Set();

    function clearTags() {
        console.log(`Clearing tags for ${containerId}`);
        tags.clear();
        const existingTags = container.querySelectorAll('.tag');
        existingTags.forEach(tag => tag.remove());
    }

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const value = this.value.trim();
            if (value) {
                addTag(value);
                this.value = '';
            }
        }
    });

    // Also add tag when input loses focus
    input.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value) {
            addTag(value);
            this.value = '';
        }
    });

    function addTag(value) {
        console.log(`Adding tag "${value}" to ${containerId}`);
        if (tags.has(value)) {
            console.log(`Tag "${value}" already exists in ${containerId}`);
            return;
        }
        tags.add(value);
        
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.setAttribute('data-value', value);
        
        // Create a text node for the value
        const textNode = document.createTextNode(value);
        tag.appendChild(textNode);
        
        // Create the remove button as a separate element
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove';
        removeBtn.textContent = '×';
        tag.appendChild(removeBtn);
        
        tag.querySelector('.remove').addEventListener('click', function() {
            console.log(`Removing tag "${value}" from ${containerId}`);
            container.removeChild(tag);
            tags.delete(value);
        });
        
        container.insertBefore(tag, input);
        console.log(`Successfully added tag "${value}" to ${containerId}`);
    }

    return {
        getTags: () => Array.from(tags),
        clearTags: clearTags,
        addTag: addTag
    };
}

// Initialize tag inputs - make sure this happens after DOM is ready
let categoriesInput, futureSignalsInput, sentimentsInput, timeToImpactInput, driverTypesInput;
let companiesInput, technologiesInput, generalKeywordsInput, peopleInput, exclusionKeywordsInput;

function initializeTagInputs() {
    console.log("Initializing tag inputs...");
    categoriesInput = createTagInput('categoriesContainer', 'categoriesInput');
    futureSignalsInput = createTagInput('futureSignalsContainer', 'futureSignalsInput');
    sentimentsInput = createTagInput('sentimentsContainer', 'sentimentsInput');
    timeToImpactInput = createTagInput('timeToImpactContainer', 'timeToImpactInput');
    driverTypesInput = createTagInput('driverTypesContainer', 'driverTypesInput');
    companiesInput = createTagInput('companiesContainer', 'companiesInput');
    technologiesInput = createTagInput('technologiesContainer', 'technologiesInput');
    generalKeywordsInput = createTagInput('generalKeywordsContainer', 'generalKeywordsInput');
    peopleInput = createTagInput('peopleContainer', 'peopleInput');
    exclusionKeywordsInput = createTagInput('exclusionKeywordsContainer', 'exclusionKeywordsInput');
    console.log("Tag inputs initialized successfully");
}

function addExampleValue(inputId, value) {
    const input = document.getElementById(inputId);
    if (!input) {
        console.warn(`Input element not found: ${inputId}`);
        return;
    }
    
    input.value = value;
    // Trigger the enter key event to add the tag
    const event = new KeyboardEvent('keydown', {
        key: 'Enter',
        code: 'Enter',
        keyCode: 13,
        bubbles: true
    });
    input.dispatchEvent(event);
}

async function suggestAttributes() {
    const topicName = document.getElementById('topic-name').value;
    const topicDescription = document.getElementById('topic-description').value;
    if (!topicName) {
        alert('Please enter a topic name first');
        return;
    }

    try {
        const response = await fetch('/api/onboarding/suggest-topic-attributes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ topic_name: topicName, topic_description: topicDescription })
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Suggest attributes response:", data);
            
            // Ensure tag inputs are initialized
            if (!categoriesInput) {
                console.log("Tag inputs not initialized, initializing now...");
                initializeTagInputs();
            }
            
            // Clear existing tags
            categoriesInput.clearTags();
            futureSignalsInput.clearTags();
            sentimentsInput.clearTags();
            timeToImpactInput.clearTags();
            driverTypesInput.clearTags();
            
            // Add new tags with validation
            if (data.categories && Array.isArray(data.categories)) {
                console.log("Adding categories:", data.categories);
                data.categories.forEach(category => {
                    categoriesInput.addTag(category);
                });
            }

            if (data.future_signals && Array.isArray(data.future_signals)) {
                console.log("Adding future signals:", data.future_signals);
                data.future_signals.forEach(signal => {
                    futureSignalsInput.addTag(signal);
                });
            }

            // Store keywords for Step 3 and show preview
            if (data.keywords) {
                console.log("Storing keywords for Step 3:", data.keywords);
                storedKeywords = data.keywords;
                
                // Show a preview of keywords that will be used in Step 3
                const keywordSuggestions = document.getElementById('keyword-suggestions');
                if (keywordSuggestions) {
                    keywordSuggestions.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Keywords have been generated and will be applied in Step 3.</div>';
                    
                    // Show a preview of what will be added
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'mt-2';
                    previewDiv.innerHTML = '<small class="text-muted">Preview of keywords for Step 3:</small>';
                    
                    const keywordPreview = document.createElement('div');
                    keywordPreview.className = 'd-flex flex-wrap gap-1 mt-1';
                    
                    Object.entries(data.keywords).forEach(([cat, arr]) => {
                        if (Array.isArray(arr) && arr.length > 0) {
                            arr.slice(0, 3).forEach(keyword => { // Show first 3 of each category
                                const span = document.createElement('span');
                                span.className = `badge bg-light text-dark ${cat}-preview`;
                                span.textContent = keyword;
                                keywordPreview.appendChild(span);
                            });
                        }
                    });
                    
                    previewDiv.appendChild(keywordPreview);
                    keywordSuggestions.appendChild(previewDiv);
                }
            }

            // Update explanation
            document.getElementById('suggestion-explanation').textContent = data.explanation;

            // Show the suggestions section
            document.getElementById('topic-suggestions').style.display = 'block';

            // Add default values and hide their sections
            const defaultSentiment = ['Positive', 'Negative', 'Neutral'];
            const defaultTimeToImpact = ['Immediate (0-6 months)', 'Short-term (6-18 months)', 
                                       'Mid-term (18-60 months)', 'Long-term (60+ months)'];
            const defaultDriverTypes = ['Initiator', 'Accelerator', 'Catalyst', 
                                      'Inhibitor', 'Blocker'];

            // Add default values
            defaultSentiment.forEach(s => sentimentsInput.addTag(s));
            defaultTimeToImpact.forEach(t => timeToImpactInput.addTag(t));
            defaultDriverTypes.forEach(d => driverTypesInput.addTag(d));

            // Hide the sections
            document.querySelector('label[for="sentiment"]').parentElement.style.display = 'none';
            document.querySelector('label[for="time-to-impact"]').parentElement.style.display = 'none';
            document.querySelector('label[for="driver-types"]').parentElement.style.display = 'none';

            const categoriesIntro = document.getElementById('categories-intro');
            if (categoriesIntro) {
                categoriesIntro.style.display = 'block';
            }

        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        console.error("Error in suggestAttributes:", error);
        alert(`Error: ${error.message}`);
    }
}

// Function to populate Step 3 keywords from stored data
function populateStep3Keywords() {
    console.log("=== POPULATING STEP 3 KEYWORDS ===");
    
    if (!storedKeywords) {
        console.log("No stored keywords found");
        return;
    }
    
    console.log("Stored keywords object:", JSON.stringify(storedKeywords, null, 2));
    
    // Ensure tag inputs are initialized
    if (!companiesInput || !technologiesInput || !generalKeywordsInput || !peopleInput || !exclusionKeywordsInput) {
        console.log("Tag inputs not initialized for Step 3, initializing now...");
        initializeTagInputs();
        
        // Double-check after initialization
        if (!companiesInput) {
            console.error("companiesInput still not initialized!");
            return;
        }
    }
    
    // Clear existing keywords
    console.log("Clearing existing keywords...");
    companiesInput.clearTags();
    technologiesInput.clearTags();
    generalKeywordsInput.clearTags();
    peopleInput.clearTags();
    exclusionKeywordsInput.clearTags();
    
    // Auto-populate fields with stored keywords
    console.log("Starting population of keyword fields...");
    
    // Companies
    if (storedKeywords.companies && Array.isArray(storedKeywords.companies) && storedKeywords.companies.length > 0) {
        console.log(`Adding ${storedKeywords.companies.length} companies:`, storedKeywords.companies);
        storedKeywords.companies.slice(0, 3).forEach((k, index) => {
            console.log(`Adding company ${index + 1}: "${k}"`);
            companiesInput.addTag(k);
        });
    } else {
        console.log("No companies to add:", storedKeywords.companies);
    }
    
    // Technologies
    if (storedKeywords.technologies && Array.isArray(storedKeywords.technologies) && storedKeywords.technologies.length > 0) {
        console.log(`Adding ${storedKeywords.technologies.length} technologies:`, storedKeywords.technologies);
        storedKeywords.technologies.slice(0, 3).forEach((k, index) => {
            console.log(`Adding technology ${index + 1}: "${k}"`);
            technologiesInput.addTag(k);
        });
    } else {
        console.log("No technologies to add:", storedKeywords.technologies);
    }
    
    // General keywords
    if (storedKeywords.general && Array.isArray(storedKeywords.general) && storedKeywords.general.length > 0) {
        console.log(`Adding ${storedKeywords.general.length} general keywords:`, storedKeywords.general);
        storedKeywords.general.slice(0, 3).forEach((k, index) => {
            console.log(`Adding general keyword ${index + 1}: "${k}"`);
            generalKeywordsInput.addTag(k);
        });
    } else {
        console.log("No general keywords to add:", storedKeywords.general);
    }
    
    // People
    if (storedKeywords.people && Array.isArray(storedKeywords.people) && storedKeywords.people.length > 0) {
        console.log(`Adding ${storedKeywords.people.length} people:`, storedKeywords.people);
        storedKeywords.people.slice(0, 2).forEach((k, index) => {
            console.log(`Adding person ${index + 1}: "${k}"`);
            peopleInput.addTag(k);
        });
    } else {
        console.log("No people to add:", storedKeywords.people);
    }
    
    // Exclusions
    if (storedKeywords.exclusions && Array.isArray(storedKeywords.exclusions) && storedKeywords.exclusions.length > 0) {
        console.log(`Adding ${storedKeywords.exclusions.length} exclusions:`, storedKeywords.exclusions);
        storedKeywords.exclusions.slice(0, 2).forEach((k, index) => {
            console.log(`Adding exclusion ${index + 1}: "${k}"`);
            exclusionKeywordsInput.addTag(k);
        });
    } else {
        console.log("No exclusions to add:", storedKeywords.exclusions);
    }
    
    console.log("=== POPULATION COMPLETE ===");
    
    // Show success message
    const keywordSuggestions = document.getElementById('keyword-suggestions');
    if (keywordSuggestions) {
        keywordSuggestions.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Keywords from Step 2 have been applied to their respective fields.</div>';
        
        // Add "Get More Suggestions" button
        const moreBtn = document.createElement('button');
        moreBtn.className = 'btn btn-sm btn-outline-primary mt-2';
        moreBtn.innerHTML = '<i class="fas fa-sync"></i> Get Different Suggestions';
        moreBtn.onclick = suggestKeywords;
        keywordSuggestions.appendChild(moreBtn);
    }
}

function showStep(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${step}`).classList.add('active');
    
    document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'block';
    document.getElementById('nextBtn').textContent = step === totalSteps ? 'Finish' : 'Next';
    
    updateStepIndicators();
    
    // Special handling for Step 3 - populate keywords from Step 2
    if (step === 3) {
        console.log("Entering Step 3, populating keywords...");
        // Small delay to ensure DOM is ready
        setTimeout(() => {
            populateStep3Keywords();
        }, 100);
    }
}

// Update suggestKeywords to work as "get different suggestions"
async function suggestKeywords() {
    const topicName = document.getElementById('topic-name').value;
    const topicDescription = document.getElementById('topic-description').value;
    if (!topicName) {
        alert('Please enter a topic name first');
        return;
    }

    // Enhanced prompt for backend
    const prompt = `Suggest relevant keywords for the topic "${topicName}". Organize them into these categories: Companies & Organizations, Technologies, General Keywords, People, and Exclusion Keywords (misinformation, unrelated terms). Provide only the most relevant and high-quality keywords for each category. Use real company and technology names where possible. Exclusion keywords should help filter out noise or unrelated results. Topic description: ${topicDescription}`;

    try {
        // Show loading indicator
        const keywordSuggestions = document.getElementById('keyword-suggestions');
        keywordSuggestions.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Finding new keyword suggestions...</div>';
        
        const response = await fetch('/api/onboarding/suggest-topic-attributes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                topic_name: topicName,
                topic_description: topicDescription,
                keyword_prompt: prompt
            })
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Backend response:", data);
            console.log("Keywords received:", JSON.stringify(data.keywords, null, 2));
            
            // Check if we got generic placeholders or real data with improved detection
            let isGeneric = false;
            const genericPatterns = [
                { category: 'companies', pattern: new RegExp(`${topicName}\\s*(Corp|Inc|LLC|Ltd)`, 'i') },
                { category: 'technologies', pattern: new RegExp(`${topicName}\\s*(Tech|Platform|API|System)`, 'i') },
                { category: 'people', pattern: new RegExp(`${topicName}\\s*(Expert|Specialist|Guru)`, 'i') },
                { category: 'exclusions', pattern: /^(-scam|-unrelated)$/ }
            ];
            
            // If all categories follow generic patterns, consider it generic
            let genericMatches = 0;
            let totalCategories = 0;
            
            Object.entries(data.keywords).forEach(([cat, arr]) => {
                if (Array.isArray(arr) && arr.length > 0) {
                    totalCategories++;
                    
                    const pattern = genericPatterns.find(p => p.category === cat)?.pattern;
                    if (pattern && arr.some(item => pattern.test(item))) {
                        console.warn(`Found generic pattern in ${cat}: ${arr[0]}`);
                        genericMatches++;
                    }
                }
            });
            
            if (genericMatches > 0 && genericMatches === totalCategories) {
                console.warn(`All categories (${genericMatches}/${totalCategories}) contain generic patterns`);
                isGeneric = true;
            }
                
            if (isGeneric) {
                console.warn("Got generic/fallback keywords from backend");
                keywordSuggestions.innerHTML = '<div class="alert alert-warning">No verified keywords found for this topic. Please try:</div>';
                
                // Provide helpful suggestions
                const helpList = document.createElement('ul');
                helpList.className = 'mb-3';
                const suggestions = [
                    'Add more details to your topic description',
                    'Be more specific about the type of keywords you need',
                    'Try a different topic name',
                    'Enter keywords manually based on your knowledge'
                ];
                
                suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.textContent = suggestion;
                    helpList.appendChild(li);
                });
                
                keywordSuggestions.appendChild(helpList);
                
                // Add a retry button
                const retryBtn = document.createElement('button');
                retryBtn.className = 'btn btn-sm btn-outline-primary';
                retryBtn.innerHTML = '<i class="fas fa-redo"></i> Try Again';
                retryBtn.onclick = suggestKeywords;
                keywordSuggestions.appendChild(retryBtn);
                
                return; // Don't use the generic placeholders
            }
            
            // Replace current keywords with new suggestions
            console.log("Replacing keywords with new suggestions");
            
            // Clear existing keywords from input fields
            companiesInput.clearTags();
            technologiesInput.clearTags();
            generalKeywordsInput.clearTags();
            peopleInput.clearTags();
            exclusionKeywordsInput.clearTags();
            
            // Auto-populate fields with new suggestions
            if (data.keywords.companies && data.keywords.companies.length > 0) {
                data.keywords.companies.slice(0, 3).forEach(k => {
                    companiesInput.addTag(k);
                });
            }
            
            if (data.keywords.technologies && data.keywords.technologies.length > 0) {
                data.keywords.technologies.slice(0, 3).forEach(k => {
                    technologiesInput.addTag(k);
                });
            }
            
            if (data.keywords.general && data.keywords.general.length > 0) {
                data.keywords.general.slice(0, 3).forEach(k => {
                    generalKeywordsInput.addTag(k);
                });
            }
            
            if (data.keywords.people && data.keywords.people.length > 0) {
                data.keywords.people.slice(0, 2).forEach(k => {
                    peopleInput.addTag(k);
                });
            }
            
            if (data.keywords.exclusions && data.keywords.exclusions.length > 0) {
                data.keywords.exclusions.slice(0, 2).forEach(k => {
                    exclusionKeywordsInput.addTag(k);
                });
            }
            
            // Update stored keywords
            storedKeywords = data.keywords;
            
            // Show success message
            keywordSuggestions.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> New keywords have been applied to their respective fields.</div>';
            
            // Add "Get More Suggestions" button
            const moreBtn = document.createElement('button');
            moreBtn.className = 'btn btn-sm btn-outline-primary mt-2';
            moreBtn.innerHTML = '<i class="fas fa-sync"></i> Get Different Suggestions';
            moreBtn.onclick = suggestKeywords;
            keywordSuggestions.appendChild(moreBtn);
            
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail}`);
        }
    } catch (error) {
        console.error("Error suggesting keywords:", error);
        alert(`Error: ${error.message}`);
    }
}

// Modify loadAvailableModels to load flat list of models instead of providers
async function loadAvailableModels() {
    try {
        const response = await fetch('/api/onboarding/available-models');
        const data = await response.json();
        
        const modelSelect = document.getElementById('llm-model');
        modelSelect.innerHTML = '<option value="">Select a model</option>';
        
        // Add all available models to the dropdown
        data.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.name;
            option.textContent = `${model.name} (${model.provider})`;
            option.dataset.provider = model.provider;
            modelSelect.appendChild(option);
        });

        // Add event listener to update guidance text when model changes
        modelSelect.addEventListener('change', function() {
            updateApiKeyGuidance();
        });
    } catch (error) {
        console.error("Error loading available models:", error);
    }
}

// Add function to update the API key format guidance based on selected model
function updateApiKeyGuidance() {
    const modelSelect = document.getElementById('llm-model');
    const selectedOption = modelSelect.options[modelSelect.selectedIndex];
    const guidanceText = document.getElementById('model-key-format');
    
    if (!selectedOption || !selectedOption.value) {
        guidanceText.innerHTML = "Enter API key for the selected model.";
        return;
    }
    
    const provider = selectedOption.dataset.provider;
    
    if (provider === 'openai') {
        guidanceText.innerHTML = "Format must be exactly as shown in OpenAI dashboard. <a href=\"https://platform.openai.com/\" target=\"_blank\" rel=\"noopener\">Get an API key</a>.";
    } else if (provider === 'anthropic') {
        guidanceText.innerHTML = "Enter the full Anthropic API key from your dashboard. <a href=\"https://www.anthropic.com/api\" target=\"_blank\" rel=\"noopener\">Sign up here</a>.";
    } else {
        guidanceText.innerHTML = `Enter the API key for ${provider}.`;
    }
}

// Modify the init() function to include tag input initialization
async function init() {
    try {
        console.log("Starting initialization...");
        
        // Initialize validatedKeys
        validatedKeys = {
            llm: false,
            news: false,
            firecrawl: false
        };

        // Initialize tag inputs first
        initializeTagInputs();

        // Check existing keys first
        await checkExistingKeys();
        
        // Check if all required keys are present and valid
        const allKeysPresent = validatedKeys.llm && validatedKeys.news && validatedKeys.firecrawl;
        
        // If all keys are present, start from step 2
        if (allKeysPresent) {
            currentStep = 2;
            // Hide step 1 dot and line
            document.querySelector('.step-dot[data-step="1"]').classList.add('completed');
            document.querySelector('.step-line').classList.add('completed');
        }
        
        showStep(currentStep);
        console.log("Initialization completed successfully");
    } catch (error) {
        console.error("Initialization error:", error);
    }
}

// Call init function when the page loads
document.addEventListener('DOMContentLoaded', init);

async function saveTopic() {
    try {
        // Gather all selected inputs
        const topicName = document.getElementById('topic-name').value;
        const topicDescription = document.getElementById('topic-description').value;
        const categories = getTagsFromContainer('categoriesContainer');
        const futureSignals = getTagsFromContainer('futureSignalsContainer');
        const sentiment = getTagsFromContainer('sentimentsContainer');
        const timeToImpact = getTagsFromContainer('timeToImpactContainer');
        const driverTypes = getTagsFromContainer('driverTypesContainer');
        const keywords = getAllKeywords();
        
        // Validate required fields
        if (!topicName) {
            showErrorMessage("Please enter a topic name");
            return false;
        }

        // API keys were already validated in Step 1, no need to check again here
        
        // Prepare data
        const topicData = {
            name: topicName,
            description: topicDescription,
            categories: categories,
            future_signals: futureSignals,
            sentiment: sentiment,
            time_to_impact: timeToImpact,
            driver_types: driverTypes,
            keywords: keywords
        };
        
        console.log("Saving topic data:", JSON.stringify(topicData, null, 2));
        
        // Send POST request
        const response = await fetch('/api/onboarding/save-topic', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(topicData)
        });
        
        console.log("Response status:", response.status);
        
        // Handle the response
        const result = await response.json();
        console.log("Response data:", JSON.stringify(result, null, 2));
        
        // Check if confirmation is required (status code 409)
        if (response.status === 409 && result.requires_confirmation) {
            if (confirm(result.message)) {
                console.log("User confirmed overwrite");
                
                // User confirmed, send another request with confirmation flag
                topicData.requires_confirmation = true;
                topicData.confirmed = true;
                
                console.log("Sending confirmation request:", JSON.stringify(topicData, null, 2));
                
                const confirmResponse = await fetch('/api/onboarding/save-topic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(topicData)
                });
                
                console.log("Confirmation response status:", confirmResponse.status);
                
                const confirmResult = await confirmResponse.json();
                console.log("Confirmation response data:", JSON.stringify(confirmResult, null, 2));
                
                if (confirmResponse.ok) {
                    showSuccessMessage(confirmResult.message || "Topic saved successfully");
                    return true;
                } else {
                    showErrorMessage(confirmResult.detail || "Error saving topic");
                    return false;
                }
            } else {
                console.log("User canceled overwrite");
            }
            return false;
        }
        
        if (response.ok) {
            showSuccessMessage(result.message || "Topic saved successfully");
            return true;
        } else {
            showErrorMessage(result.detail || "Error saving topic");
            return false;
        }
    } catch (error) {
        console.error('Error saving topic:', error);
        showErrorMessage("Error saving topic: " + error.message);
        return false;
    }
}

function updateStepIndicators() {
    document.querySelectorAll('.step-dot').forEach((dot, index) => {
        const step = index + 1;
        dot.className = 'step-dot' + 
            (step === currentStep ? ' active' : '') +
            (step < currentStep ? ' completed' : '');
    });

    document.querySelectorAll('.step-line').forEach((line, index) => {
        line.className = 'step-line' + (index + 1 < currentStep ? ' completed' : '');
    });
}

async function nextStep() {
    if (currentStep === 1) {
        // Validate all keys before proceeding
        const keysValid = await validateAllKeys();
        if (!keysValid) {
            showErrorMessage("Please ensure all API keys are valid before proceeding");
            return;
        }
    }
    
    if (currentStep < totalSteps) {
        // If we're on step 2, save the topic first
        if (currentStep === 2) {
            const saved = await saveTopic();
            if (!saved) return; // If save failed, don't move to next step
        }
        
        currentStep++;
        showStep(currentStep);
    } else {
        // We're on the final step - save keywords by updating the topic
        const topicName = document.getElementById('topic-name').value;
        const topicDescription = document.getElementById('topic-description').value;
        const categories = getTagsFromContainer('categoriesContainer');
        const futureSignals = getTagsFromContainer('futureSignalsContainer');
        const sentiment = getTagsFromContainer('sentimentsContainer');
        const timeToImpact = getTagsFromContainer('timeToImpactContainer');
        const driverTypes = getTagsFromContainer('driverTypesContainer');
        const keywords = getAllKeywords();
        
        if (keywords.length === 0) {
            if (!confirm("No keywords added. Continue anyway?")) {
                return;
            }
        }
        
        try {
            // Include ALL topic data from both step 2 and step 3
            const topicData = {
                name: topicName,
                description: topicDescription,
                categories: categories,
                future_signals: futureSignals,
                sentiment: sentiment,
                time_to_impact: timeToImpact,
                driver_types: driverTypes,
                keywords: keywords,
                requires_confirmation: true,
                confirmed: true
            };
            
            console.log("Saving complete topic with keywords:", JSON.stringify(topicData, null, 2));
            
            // Update the topic with all data
            const response = await fetch('/api/onboarding/save-topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(topicData)
            });
            
            console.log("Topic save response:", response.status);
            const result = await response.json();
            console.log("Topic save result:", JSON.stringify(result, null, 2));
            
            if (!response.ok) {
                showErrorMessage("Failed to save topic: " + (result.detail || "Unknown error"));
                return;
            }
            
            showSuccessMessage("Topic saved successfully");
            
            // Continue with onboarding completion
            await completeOnboarding();
        } catch (error) {
            console.error("Error saving topic:", error);
            showErrorMessage("Error saving topic: " + error.message);
        }
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
}

// Helper functions for showing messages
function showSuccessMessage(message) {
    const successMsg = document.createElement('div');
    successMsg.className = 'alert alert-success mt-3';
    successMsg.innerHTML = `
        <i class="fas fa-check-circle"></i>
        ${message}
    `;
    document.querySelector('.card-body').appendChild(successMsg);
    
    // Remove message after 3 seconds
    setTimeout(() => {
        successMsg.remove();
    }, 3000);
}

function showErrorMessage(message) {
    const errorMsg = document.createElement('div');
    errorMsg.className = 'alert alert-danger mt-3';
    errorMsg.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        ${message}
    `;
    document.querySelector('.card-body').appendChild(errorMsg);
    
    // Remove message after 5 seconds
    setTimeout(() => {
        errorMsg.remove();
    }, 5000);
}

// Helper functions for getting tags
function getTagsFromContainer(containerId) {
    const container = document.getElementById(containerId);
    const tags = [];
    container.querySelectorAll('.tag').forEach(tag => {
        // Use the data-value attribute instead of textContent
        tags.push(tag.getAttribute('data-value'));
    });
    return tags;
}

function getSelectedTags(containerId) {
    const container = document.getElementById(containerId);
    const selectedTags = [];
    container.querySelectorAll('.tag.selected').forEach(tag => {
        // Use the data-value attribute instead of textContent
        selectedTags.push(tag.getAttribute('data-value'));
    });
    return selectedTags;
}

async function completeOnboarding() {
    try {
        // Get the selected news provider from Step 1
        const newsProvider = document.getElementById('news-provider').value;

        const response = await fetch('/api/onboarding/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                news_provider: newsProvider
            })
        });

        if (response.ok) {
            showSuccessMessage("Onboarding completed successfully!");

            // Redirect to keyword alerts page after a short delay
            setTimeout(() => {
                window.location.href = '/keyword-alerts';
            }, 2000);
        } else {
            const error = await response.json();
            throw new Error(error.detail || "Failed to complete onboarding");
        }
    } catch (error) {
        console.error('Error completing onboarding:', error);
        showErrorMessage("Error completing onboarding: " + error.message);
    }
}

function moveToNextStep() {
    const currentStep = getCurrentStep();
    if (currentStep < 3) {
        showStep(currentStep + 1);
    }
}

function getCurrentStep() {
    const visibleStep = document.querySelector('.step.active');
    if (visibleStep && visibleStep.id) {
        return parseInt(visibleStep.id.replace('step', ''));
    }
    return 1; // Default to first step
}

function getAllKeywords() {
    console.log("=== COLLECTING KEYWORDS FOR SAVING ===");
    
    // Get keywords from each category
    const companies = getTagsFromContainer('companiesContainer');
    const technologies = getTagsFromContainer('technologiesContainer'); 
    const general = getTagsFromContainer('generalKeywordsContainer');
    const people = getTagsFromContainer('peopleContainer');
    const exclusions = getTagsFromContainer('exclusionKeywordsContainer');
    
    console.log("Companies:", companies);
    console.log("Technologies:", technologies);
    console.log("General:", general);
    console.log("People:", people);
    console.log("Exclusions:", exclusions);
    
    // Flatten all keywords into a single array
    const allKeywords = [
        ...companies,
        ...technologies,
        ...general,
        ...people,
        ...exclusions
    ].filter(keyword => keyword && keyword.trim() !== ''); // Remove empty values
    
    console.log("Flattened keywords to save:", allKeywords);
    console.log("=== KEYWORD COLLECTION COMPLETE ===");
    
    return allKeywords;
}
</script>
{% endblock %} 