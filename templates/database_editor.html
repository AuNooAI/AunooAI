{% extends "base.html" %}
{% block title %}FNA - Database Editor{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #FF69B4;  /* Hot Pink */
        --primary-dark: #FF1493;   /* Deep Pink */
        --secondary-color: #32CD32;  /* Lime Green */
        --secondary-dark: #228B22;   /* Forest Green */
        --text-color: #333;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #343a40;
    }

    .editor-panel {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 20px;
        border: 1px solid var(--primary-color);
    }

    .filter-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 8px;
        margin-bottom: 15px;
        border: 1px solid var(--primary-color);
        border-radius: 4px;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-dark);
        box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
    }

    #articleList {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid var(--primary-color);
        border-radius: 5px;
        padding: 10px;
    }

    .table-responsive {
        max-height: 500px;
        overflow-y: auto;
    }

    .pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
    }

    .date-inputs {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .date-separator {
        margin: 0 5px;
        color: var(--text-color);
    }

    .date-inputs input[type="date"] {
        min-width: 130px;
    }

    .date-buttons {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 5px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .input-group {
        display: flex;
        gap: 5px;
    }

    .filter-panel {
        background-color: var(--light-gray);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .date-section {
        margin-bottom: 20px;
    }

    .date-buttons {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }

    .date-inputs {
        display: grid;
        grid-template-columns: auto 1fr auto 1fr;
        gap: 10px;
        align-items: center;
    }

    .search-section {
        margin-top: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .form-group label {
        font-size: 0.9em;
        color: var(--text-color);
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--medium-gray);
    }

    .pagination-info {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .results-count {
        color: var(--text-color);
        font-size: 0.9em;
    }

    .pagination {
        display: flex;
        align-items: center;
        gap: 10px;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Database Editor</h2>
    
    <!-- Topic Selection -->
    <div class="editor-panel">
        <div class="form-group mb-4">
            <label for="topicSelect">Select Topic:</label>
            <select class="form-select" id="topicSelect">
                <option value="">Select a topic</option>
                {% for topic in topics %}
                <option value="{{ topic.name }}">{{ topic.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Topic Stats -->
        <div id="topicStats" class="mb-4">
            <!-- Stats will be populated by JavaScript -->
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="editor-panel" id="filtersPanel" style="display: none;">
        <h5>Filters</h5>
        <div class="filter-panel">
            <h6 class="mb-3">FILTERS</h6>
            
            <!-- Top row of filters -->
            <div class="filter-row">
                <div class="form-group">
                    <label>Categories</label>
                    <select class="form-select select2-multiple" id="categoryFilter" multiple="multiple">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sentiment</label>
                    <select class="form-select select2-multiple" id="sentimentFilter" multiple="multiple">
                        <option value="">All Sentiments</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Future Signal</label>
                    <select class="form-select select2-multiple" id="futureSignalFilter" multiple="multiple">
                        <option value="">All Future Signals</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Time to Impact</label>
                    <select class="form-select select2-multiple" id="timeImpactFilter" multiple="multiple">
                        <option value="">All Time to Impact</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Driver Type</label>
                    <select class="form-select select2-multiple" id="driverTypeFilter" multiple="multiple">
                        <option value="">All Driver Types</option>
                    </select>
                </div>
            </div>

            <!-- Date Range section -->
            <div class="date-section">
                <label>Date Range</label>
                <div class="date-buttons">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange('today')">1 Day</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange('week')">7 Days</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange('month')">30 Days</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange('quarter')">90 Days</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange('year')">365 Days</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange('all')">All</button>
                </div>
                <div class="date-inputs">
                    <label>From:</label>
                    <input type="date" class="form-control" id="dateFrom" max="{{ today_date }}" onchange="updateEndDateMin(this.value)">
                    <label>To:</label>
                    <input type="date" class="form-control" id="dateTo" max="{{ today_date }}">
                </div>
            </div>

            <!-- Search section -->
            <div class="search-section">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search titles and summaries...">
                    <button class="btn btn-primary" id="searchButton">Search</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articles Panel -->
    <div class="editor-panel">
        <div class="panel-header">
            <h6>ARTICLES</h6>
            <div class="pagination-info">
                <span class="results-count">
                    Showing <span id="startCount">0</span> - <span id="endCount">0</span> of <span id="totalCount">0</span> articles
                </span>
                <div class="pagination">
                    <button class="btn btn-sm btn-outline-secondary" id="prevPage" disabled>Previous</button>
                    <span class="mx-2">
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                    <button class="btn btn-sm btn-outline-secondary" id="nextPage" disabled>Next</button>
                </div>
            </div>
        </div>

        <div id="articleList" class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Publication Date</th>
                        <th>Category</th>
                        <th>Sentiment</th>
                        <th>Future Signal</th>
                        <th>Time to Impact</th>
                        <th>Driver Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="articleTableBody">
                    <!-- Articles will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Analysis Result Panel -->
    <div class="editor-panel" id="analysisResult" style="display: none;">
        <div class="panel-header">
            <h6>EDIT ARTICLE</h6>
        </div>
        <div class="analysis-result">
            <div class="mb-3">
                <label class="form-label">Title</label>
                <input type="text" id="analysisTitle" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">Source</label>
                <input type="text" id="analysisSource" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">URL</label>
                <input type="url" id="analysisUrl" class="form-control" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Summary <span id="summaryWordCount">(0 words)</span></label>
                <textarea class="form-control" id="analysisSummary" rows="3"></textarea>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select id="analysisCategory" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sentiment</label>
                        <select id="analysisSentiment" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sentiment Explanation</label>
                        <textarea id="analysisSentimentExplanation" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Future Signal</label>
                        <select id="analysisFutureSignal" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Future Signal Explanation</label>
                        <textarea id="analysisFutureSignalExplanation" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Time to Impact</label>
                        <select id="analysisTimeToImpact" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Time to Impact Explanation</label>
                        <textarea id="analysisTimeToImpactExplanation" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Driver Type</label>
                        <select id="analysisDriverType" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Driver Type Explanation</label>
                        <textarea id="analysisDriverTypeExplanation" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Publication Date</label>
                        <input type="date" id="analysisPublicationDate" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Submission Date</label>
                        <input type="datetime-local" id="analysisSubmissionDate" class="form-control">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Tags</label>
                <input type="text" id="analysisTags" class="form-control" placeholder="Enter tags separated by commas">
            </div>
            <div class="button-group">
                <button onclick="saveArticle()" class="btn btn-primary">Save Changes</button>
                <button onclick="clearForm()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Article</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="editTitle">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" id="editCategory">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sentiment</label>
                        <select class="form-select" id="editSentiment">
                            <option value="Positive">Positive</option>
                            <option value="Neutral">Neutral</option>
                            <option value="Negative">Negative</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Future Signal</label>
                        <select class="form-select" id="editFutureSignal">
                            <option value="Strong">Strong</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Weak">Weak</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Time to Impact</label>
                        <select class="form-select" id="editTimeImpact">
                            <option value="Short-term">Short-term</option>
                            <option value="Medium-term">Medium-term</option>
                            <option value="Long-term">Long-term</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveArticleChanges">Save changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
let currentTopic = '';
let currentPage = 1;
const itemsPerPage = 10;
let allArticles = [];
let filteredArticles = [];

// Topic selection handler
document.getElementById('topicSelect').addEventListener('change', handleTopicChange);

async function handleTopicChange(event) {
    const topicName = event.target.value;
    const filtersPanel = document.getElementById('filtersPanel');
    
    if (!topicName) {
        filtersPanel.style.display = 'none';
        allArticles = [];
        filteredArticles = [];
        document.getElementById('topicStats').innerHTML = '';
        document.getElementById('articleTableBody').innerHTML = '';
        return;
    }

    filtersPanel.style.display = 'block';
    await refreshDropdownsForTopic(topicName);
    
    // Set default date range and fetch articles
    await setDateRange('week');
}

async function refreshDropdownsForTopic(topicName) {
    try {
        console.log('Refreshing dropdowns for topic:', topicName);
        if (!topicName) {
            console.warn('No topic name provided to refreshDropdownsForTopic');
            return;
        }

        // Add topic parameter to the API calls
        const responses = await Promise.all([
            fetch(`/api/categories?topic=${encodeURIComponent(topicName)}`),
            fetch(`/api/future_signals?topic=${encodeURIComponent(topicName)}`),
            fetch(`/api/sentiments?topic=${encodeURIComponent(topicName)}`),
            fetch(`/api/time_to_impact?topic=${encodeURIComponent(topicName)}`),
            fetch(`/api/driver_types?topic=${encodeURIComponent(topicName)}`)
        ]);

        // Check if any response is not ok
        for (let i = 0; i < responses.length; i++) {
            if (!responses[i].ok) {
                console.error(`Error fetching data for endpoint ${i}:`, responses[i].statusText);
                continue;
            }
        }

        const [categories, futureSignals, sentiments, timeToImpact, driverTypes] = await Promise.all(
            responses.map(response => response.json())
        );

        console.log('Received updated values for topic:', topicName);
        
        // Update each dropdown with new values
        updateDropdownOptions('analysisCategory', categories);
        updateDropdownOptions('analysisFutureSignal', futureSignals);
        updateDropdownOptions('analysisSentiment', sentiments);
        updateDropdownOptions('analysisTimeToImpact', timeToImpact);
        updateDropdownOptions('analysisDriverType', driverTypes);
    } catch (error) {
        console.error('Error refreshing dropdowns:', error);
    }
}

function updateDropdownOptions(dropdownId, options) {
    const dropdown = document.getElementById(dropdownId);
    if (dropdown) {
        dropdown.innerHTML = '';
        if (!Array.isArray(options) || options.length === 0) {
            console.warn(`No options received for ${dropdownId}`);
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'No options available';
            dropdown.appendChild(defaultOption);
            return;
        }
        
        options.forEach(option => {
            if (option) {  // Only add non-null/undefined options
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                dropdown.appendChild(optionElement);
            }
        });
    } else {
        console.error(`Dropdown element not found: ${dropdownId}`);
    }
}

async function fetchArticlesForTopic(topicName) {
    try {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        const params = new URLSearchParams({
            start_date: dateFrom,
            end_date: dateTo,
            limit: 1000
        });
        
        const response = await fetch(`/api/topics/${encodeURIComponent(topicName)}/articles?${params}`);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();
        allArticles = data.articles;
        
        // Store current filter values before applying them
        const currentFilters = {
            categories: $('#categoryFilter').val() || [],
            sentiments: $('#sentimentFilter').val() || [],
            futureSignals: $('#futureSignalFilter').val() || [],
            timeImpacts: $('#timeImpactFilter').val() || [],
            driverTypes: $('#driverTypeFilter').val() || []
        };

        // Apply filters to new articles
        filteredArticles = allArticles;
        if (Object.values(currentFilters).some(arr => arr.length > 0)) {
            applyFilters();
        } else {
            displayArticles();
            updatePaginationInfo();
        }
        
        console.log(`Loaded ${allArticles.length} articles`);
    } catch (error) {
        console.error('Error loading articles:', error);
        alert('Error loading articles');
    }
}

function initializeFilters() {
    const filters = {
        search: document.getElementById('searchInput').value,
        categories: Array.from(document.getElementById('categoryFilter').selectedOptions).map(opt => opt.value).filter(v => v),
        sentiments: Array.from(document.getElementById('sentimentFilter').selectedOptions).map(opt => opt.value).filter(v => v),
        futureSignals: Array.from(document.getElementById('futureSignalFilter').selectedOptions).map(opt => opt.value).filter(v => v),
        timeImpacts: Array.from(document.getElementById('timeImpactFilter').selectedOptions).map(opt => opt.value).filter(v => v),
        driverTypes: Array.from(document.getElementById('driverTypeFilter').selectedOptions).map(opt => opt.value).filter(v => v),
        dateFrom: document.getElementById('dateFrom').value,
        dateTo: document.getElementById('dateTo').value
    };
    return filters;
}

function applyFilters() {
    if (!allArticles.length) {
        filteredArticles = [];
        displayArticles();
        updatePaginationInfo();
        return;
    }

    const filters = {
        search: document.getElementById('searchInput').value.toLowerCase(),
        categories: ($('#categoryFilter').val() || []).filter(val => val !== ''),
        sentiments: ($('#sentimentFilter').val() || []).filter(val => val !== ''),
        futureSignals: ($('#futureSignalFilter').val() || []).filter(val => val !== ''),
        timeImpacts: ($('#timeImpactFilter').val() || []).filter(val => val !== ''),
        driverTypes: ($('#driverTypeFilter').val() || []).filter(val => val !== '')
    };

    console.log('All articles before filtering:', allArticles.length);
    console.log('Applying filters:', filters);
    
    filteredArticles = allArticles.filter(article => {
        const matchesSearch = !filters.search || 
            article.title?.toLowerCase().includes(filters.search) ||
            article.summary?.toLowerCase().includes(filters.search);
            
        const matchesCategory = !filters.categories.length || 
            (article.category && filters.categories.includes(article.category));
            
        const matchesSentiment = !filters.sentiments.length || 
            (article.sentiment && filters.sentiments.includes(article.sentiment));
            
        const matchesFutureSignal = !filters.futureSignals.length || 
            (article.future_signal && filters.futureSignals.includes(article.future_signal));
            
        const matchesTimeImpact = !filters.timeImpacts.length || 
            (article.time_to_impact && filters.timeImpacts.includes(article.time_to_impact));
            
        const matchesDriverType = !filters.driverTypes.length || 
            (article.driver_type && filters.driverTypes.includes(article.driver_type));

        return matchesSearch && matchesCategory && matchesSentiment && 
               matchesFutureSignal && matchesTimeImpact && matchesDriverType;
    });

    currentPage = 1;
    displayArticles();
    updatePaginationInfo();
    
    console.log('Filtered articles:', filteredArticles.length);
    console.log('Applied filters:', filters);
}

// Add event listeners for Select2 dropdowns
$(document).ready(function() {
    $('.select2-multiple').select2({
        placeholder: "Select options",
        allowClear: true,
        width: '100%'
    }).on('change', function() {
        applyFilters();
    });

    $('#searchInput').on('input', debounce(() => applyFilters(), 300));
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function displayArticles() {
    const tableBody = document.getElementById('articleTableBody');
    tableBody.innerHTML = '';
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const displayedArticles = filteredArticles.slice(startIndex, endIndex);
    
    displayedArticles.forEach(article => {
        const row = document.createElement('tr');
        // Ensure URI is properly escaped and never null
        const articleUri = article.uri ? encodeURIComponent(article.uri) : '';
        
        row.innerHTML = `
            <td>${escapeHTML(article.title || '')}</td>
            <td>${formatDate(article.publication_date)}</td>
            <td>${escapeHTML(article.category || '')}</td>
            <td>${escapeHTML(article.sentiment || '')}</td>
            <td>${escapeHTML(article.future_signal || '')}</td>
            <td>${escapeHTML(article.time_to_impact || '')}</td>
            <td>${escapeHTML(article.driver_type || '')}</td>
            <td>
                ${articleUri ? `
                    <button class="btn btn-sm btn-primary" onclick="editArticle('${articleUri}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteArticle('${articleUri}')">Delete</button>
                ` : '<span class="text-muted">No URI</span>'}
            </td>
        `;
        tableBody.appendChild(row);
    });
    
    updatePaginationInfo();
}

function updatePagination() {
    updatePaginationInfo();
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Invalid Date';
        return date.toLocaleDateString();
    } catch (e) {
        return 'Invalid Date';
    }
}

// Add article edit/delete handlers
document.getElementById('articleTableBody').addEventListener('click', async function(e) {
    if (!currentTopic) return;
    
    if (e.target.classList.contains('edit-article')) {
        const uri = e.target.dataset.uri;
        window.location.href = `/research?uri=${encodeURIComponent(uri)}`;
    } else if (e.target.classList.contains('delete-article')) {
        if (!confirm('Are you sure you want to delete this article?')) return;
        
        const uri = e.target.dataset.uri;
        try {
            const response = await fetch(`/api/article?uri=${encodeURIComponent(uri)}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                e.target.closest('tr').remove();
                // Refresh topic stats after deletion
                loadTopicData(currentTopic);
            } else {
                const error = await response.json();
                alert(`Failed to delete article: ${error.detail || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error deleting article:', error);
            alert('Error deleting article');
        }
    }
});

function populateDropdowns() {
    populateDropdown('categoryFilter', '/api/categories');
    populateDropdown('futureSignalFilter', '/api/future_signals');
    populateDropdown('sentimentFilter', '/api/sentiments');
    populateDropdown('timeImpactFilter', '/api/time_to_impact');
    populateDropdown('driverTypeFilter', '/api/driver_types');
}

async function populateDropdown(elementId, apiUrl) {
    try {
        const response = await fetch(apiUrl);
        const data = await response.json();
        const select = document.getElementById(elementId);
        select.innerHTML = ''; // Clear existing options
        
        // Add placeholder option
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = `All ${elementId.replace('Filter', '')}`;
        select.appendChild(placeholder);
        
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            select.appendChild(option);
        });
    } catch (error) {
        console.error(`Error populating ${elementId}:`, error);
    }
}

function setupDateFilter() {
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');

    if (dateFrom && dateTo) {
        dateFrom.addEventListener('change', () => applyFilters());
        dateTo.addEventListener('change', () => applyFilters());
    }
}

// Update the DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    const articleTableBody = document.getElementById('articleTableBody');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');

    // Only set up event listeners if elements exist
    if (prevPageBtn && nextPageBtn) {
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayArticles();
                updatePaginationInfo();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredArticles.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayArticles();
                updatePaginationInfo();
            }
        });
    }

    // Initialize dropdowns with API data
    fetchOptions('/api/categories', 'category');
    fetchOptions('/api/future_signals', 'futureSignal');
    fetchOptions('/api/sentiments', 'sentiment');
    fetchOptions('/api/time_to_impact', 'timeImpact');
    fetchOptions('/api/driver_types', 'driverType');

    // Initialize select2 for multiple select dropdowns
    $('.select2-multiple').select2({
        placeholder: 'Select options',
        allowClear: true,
        width: '100%'
    });

    // Set up filter event listeners
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(() => applyFilters(), 300));
    }

    // Set up date filter
    setupDateFilter();

    // Initial load of articles
    applyFilters();
});

// Add some styling for multiple select
document.addEventListener('DOMContentLoaded', function() {
    const multiSelects = document.querySelectorAll('select[multiple]');
    multiSelects.forEach(select => {
        select.style.height = '120px'; // Show multiple options
    });
});

async function fetchOptions(apiUrl, elementId) {
    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        
        const select = document.getElementById(`${elementId}Filter`);
        select.innerHTML = `<option value="">All ${elementId}s</option>`;
        
        data.forEach(option => {
            const optElement = document.createElement('option');
            optElement.value = option;
            optElement.textContent = option;
            select.appendChild(optElement);
        });
    } catch (error) {
        console.error(`Error fetching ${elementId} options:`, error);
    }
}

function updatePaginationInfo() {
    const startCountEl = document.getElementById('startCount');
    const endCountEl = document.getElementById('endCount');
    const totalCountEl = document.getElementById('totalCount');
    const currentPageEl = document.getElementById('currentPage');
    const totalPagesEl = document.getElementById('totalPages');
    const prevButton = document.getElementById('prevPage');
    const nextButton = document.getElementById('nextPage');

    if (!startCountEl || !endCountEl || !totalCountEl || 
        !currentPageEl || !totalPagesEl || !prevButton || !nextButton) {
        console.warn('Pagination elements not found');
        return;
    }

    const start = (currentPage - 1) * itemsPerPage + 1;
    const end = Math.min(currentPage * itemsPerPage, filteredArticles.length);
    const total = filteredArticles.length;
    const totalPages = Math.ceil(total / itemsPerPage);

    startCountEl.textContent = total ? start : 0;
    endCountEl.textContent = total ? end : 0;
    totalCountEl.textContent = total;
    currentPageEl.textContent = currentPage;
    totalPagesEl.textContent = totalPages;

    prevButton.disabled = currentPage === 1;
    nextButton.disabled = currentPage === totalPages || total === 0;
}

function updateEndDateMin(startDate) {
    const endDateInput = document.getElementById('dateTo');
    endDateInput.min = startDate;
    if (endDateInput.value && endDateInput.value < startDate) {
        endDateInput.value = startDate;
    }
}

async function setDateRange(range) {
    const today = new Date();
    const startDate = document.getElementById('dateFrom');
    const endDate = document.getElementById('dateTo');
    
    // Always set end date to today
    endDate.value = today.toISOString().split('T')[0];
    
    let start = new Date(today);
    
    switch(range) {
        case 'today':
            start = today;
            break;
        case 'week':
            start.setDate(today.getDate() - 7);
            break;
        case 'month':
            start.setDate(today.getDate() - 30);
            break;
        case 'quarter':
            start.setDate(today.getDate() - 90);
            break;
        case 'year':
            start.setDate(today.getDate() - 365);
            break;
        case 'all':
            start = new Date('2000-01-01');
            break;
    }
    
    startDate.value = start.toISOString().split('T')[0];
    
    // Get the current topic and fetch new articles with date range
    const topicName = document.getElementById('topicSelect').value;
    if (topicName) {
        await fetchArticlesForTopic(topicName);
    }
}

// Add date input change handlers
$(document).ready(function() {
    // ... existing Select2 initialization ...

    // Add date input change handlers
    $('#dateFrom, #dateTo').on('change', async function() {
        const topicName = document.getElementById('topicSelect').value;
        if (topicName) {
            await fetchArticlesForTopic(topicName);
        }
    });
});

async function editArticle(uri) {
    if (!uri) {
        console.error('No URI provided for article editing');
        alert('Cannot edit article: No URI provided');
        return;
    }

    try {
        const response = await fetch(`/api/article?uri=${uri}`);
        if (response.status === 404) {
            throw new Error('Article not found');
        }
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const article = await response.json();
        if (!article) {
            throw new Error('No article data received');
        }
        
        // First refresh the dropdowns for the article's topic
        await refreshDropdownsForTopic(article.topic);
        
        // Then display the article data
        displayAnalysisResult(article);
        
        // Show the analysis result panel
        const analysisResultDiv = document.getElementById('analysisResult');
        analysisResultDiv.style.display = 'block';
        analysisResultDiv.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error('Error editing article:', error);
        alert(`Error editing article: ${error.message}`);
    }
}

async function deleteArticle(uri) {
    if (confirm('Are you sure you want to delete this article?')) {
        try {
            // Decode the URI first in case it's already encoded, then encode it once
            const decodedUri = decodeURIComponent(uri);
            const response = await fetch(`/api/article?uri=${encodeURIComponent(decodedUri)}`, { 
                method: 'DELETE' 
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to delete article');
            }
            
            const result = await response.json();
            console.log('Delete result:', result);
            alert('Article deleted successfully');
            
            // Refresh the articles list
            const topicSelect = document.getElementById('topicSelect');
            await fetchArticles(topicSelect.value);
        } catch (error) {
            console.error('Error deleting article:', error);
            alert(`Error deleting article: ${error.message}`);
        }
    }
}
function displayAnalysisResult(result) {
    const analysisResultDiv = document.getElementById('analysisResult');
    if (analysisResultDiv) {
        document.getElementById('analysisTitle').value = result.title || '';
        document.getElementById('analysisSource').value = result.news_source || '';
        document.getElementById('analysisUrl').value = result.uri || '';
        document.getElementById('analysisSummary').value = result.summary || '';
        document.getElementById('analysisSentiment').value = result.sentiment || '';
        document.getElementById('analysisSentimentExplanation').value = result.sentiment_explanation || '';
        document.getElementById('analysisTimeToImpact').value = result.time_to_impact || '';
        document.getElementById('analysisTimeToImpactExplanation').value = result.time_to_impact_explanation || '';
        document.getElementById('analysisCategory').value = result.category || '';
        document.getElementById('analysisFutureSignal').value = result.future_signal || '';
        document.getElementById('analysisFutureSignalExplanation').value = result.future_signal_explanation || '';
        document.getElementById('analysisDriverType').value = result.driver_type || '';
        document.getElementById('analysisDriverTypeExplanation').value = result.driver_type_explanation || '';
        
        // Handle dates
        if (result.publication_date) {
            document.getElementById('analysisPublicationDate').value = result.publication_date.split('T')[0];
        }
        if (result.submission_date) {
            document.getElementById('analysisSubmissionDate').value = result.submission_date.slice(0, 16);
        }
        
        // Handle tags
        document.getElementById('analysisTags').value = Array.isArray(result.tags) ? result.tags.join(', ') : result.tags || '';
        
        updateSummaryWordCount();
    }
}

function clearForm() {
    const inputs = document.querySelectorAll('#analysisResult input, #analysisResult textarea, #analysisResult select');
    inputs.forEach(input => {
        input.value = '';
    });
    document.getElementById('analysisResult').style.display = 'none';
}

async function saveArticle() {
    const articleData = {
        title: document.getElementById('analysisTitle').value,
        news_source: document.getElementById('analysisSource').value,
        uri: document.getElementById('analysisUrl').value,
        publication_date: document.getElementById('analysisPublicationDate').value,
        summary: document.getElementById('analysisSummary').value,
        category: document.getElementById('analysisCategory').value,
        future_signal: document.getElementById('analysisFutureSignal').value,
        future_signal_explanation: document.getElementById('analysisFutureSignalExplanation').value,
        sentiment: document.getElementById('analysisSentiment').value,
        sentiment_explanation: document.getElementById('analysisSentimentExplanation').value,
        time_to_impact: document.getElementById('analysisTimeToImpact').value,
        time_to_impact_explanation: document.getElementById('analysisTimeToImpactExplanation').value,
        tags: document.getElementById('analysisTags').value.split(',').map(tag => tag.trim()),
        driver_type: document.getElementById('analysisDriverType').value,
        driver_type_explanation: document.getElementById('analysisDriverTypeExplanation').value,
        submission_date: document.getElementById('analysisSubmissionDate').value,
        topic: document.getElementById('topicSelect').value
    };

    try {
        const response = await fetch('/api/save_article', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(articleData),
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const result = await response.json();
        console.log('Success:', result);
        alert('Article saved successfully!');
        
        // Clear the form first
        clearForm();
        
        // Then refresh the articles list
        if (articleData.topic) {
            await fetchArticles(articleData.topic);
        } else {
            console.warn('No topic selected for refresh');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving article. Please try again.');
    }
}

function updateSummaryWordCount() {
    const summary = document.getElementById('analysisSummary').value;
    const wordCount = summary.trim().split(/\s+/).length;
    document.getElementById('summaryWordCount').textContent = `(${wordCount} words)`;
}

// Add event listener for summary textarea
document.addEventListener('DOMContentLoaded', function() {
    const summaryTextarea = document.getElementById('analysisSummary');
    if (summaryTextarea) {
        summaryTextarea.addEventListener('input', updateSummaryWordCount);
    }
});

// Add a helper function to safely escape HTML
function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, 
        tag => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            "'": '&#39;',
            '"': '&quot;'
        }[tag] || tag)
    );
}

async function fetchArticles(topicName) {
    if (!topicName) {
        console.warn('No topic name provided for fetching articles');
        return;
    }

    try {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        const params = new URLSearchParams({
            start_date: dateFrom,
            end_date: dateTo,
            limit: 1000
        });
        
        const response = await fetch(`/api/topics/${encodeURIComponent(topicName)}/articles?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        allArticles = data.articles || [];
        filteredArticles = allArticles;
        
        // Apply any existing filters
        applyFilters();
        
        // Display the articles
        currentPage = 1;
        displayArticles();
        updatePaginationInfo();
        
        console.log(`Loaded ${allArticles.length} articles for topic ${topicName}`);
    } catch (error) {
        console.error('Error fetching articles:', error);
        alert('Error loading articles. Please try again.');
    }
}

// Add this to your existing event listeners
document.addEventListener('DOMContentLoaded', function() {
    // ... existing DOMContentLoaded code ...
    
    // Add topic change handler if not already present
    const topicSelect = document.getElementById('topicSelect');
    if (topicSelect) {
        topicSelect.addEventListener('change', async function() {
            const selectedTopic = this.value;
            if (selectedTopic) {
                await fetchArticles(selectedTopic);
            }
        });
    }
});
</script>
{% endblock %} 