{% extends "base.html" %}

{% block content %}
<!-- TTS key alert (hidden by default) -->
<div id="ttsKeyAlert" class="alert alert-warning text-center mb-0" style="display:none; border-radius:0;">
    <i class="fas fa-exclamation-triangle me-1"></i>
    No Text-to-Speech API keys configured. Set up <a href="/config#providers" class="alert-link">ElevenLabs</a> or <a href="/config#dia-config" class="alert-link">Dia</a> in the Configuration page.
</div>
<!-- Import the media bias component -->
{% include "components/media_bias_display.html" %}
<div class="container mt-4">
    <h1>Podcast Director</h1>
    
    <!-- Two-column layout for search and results -->
    <div class="row">
        <!-- Left column: Search form -->
        <div class="col-md-4">
            <div id="searchForm" class="card">
                <div class="card-header">
                    <h5 class="mb-0">Search Articles</h5>
                </div>
                <div class="card-body">
                    <form id="articleSearchForm">
                        <div class="mb-3">
                            <label for="topicSelect" class="form-label" data-bs-toggle="tooltip" title="Select the main topic to filter articles">Topic</label>
                            <select id="topicSelect" name="topic" class="form-select">
                                <option value="">Select a topic</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="category" class="form-label" data-bs-toggle="tooltip" title="Filter articles by one or more categories">Categories</label>
                            <small class="form-text text-muted">Categories are loaded based on the selected topic.</small>
                            <select id="category" name="category" class="form-select" multiple disabled>
                                <!-- Categories will be populated based on selected topic -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="futureSignal" class="form-label" data-bs-toggle="tooltip" title="Filter by future signals identified in articles">Future Signals</label>
                            <small class="form-text text-muted">Select one or more future signals to narrow your search.</small>
                            <select id="futureSignal" name="future_signal" class="form-select" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="sentiment" class="form-label" data-bs-toggle="tooltip" title="Filter by sentiment (positive, negative, neutral)">Sentiments</label>
                            <small class="form-text text-muted">Choose sentiments to focus on articles with a particular tone.</small>
                            <select id="sentiment" name="sentiment" class="form-select" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="tags" class="form-label" data-bs-toggle="tooltip" title="Filter by tags (comma-separated)">Tags</label>
                            <small class="form-text text-muted">Enter tags separated by commas to filter articles.</small>
                            <input type="text" id="tags" name="tags" class="form-control" placeholder="Enter tags separated by commas">
                        </div>

                        <div class="mb-3">
                            <label for="keyword" class="form-label" data-bs-toggle="tooltip" title="Search for a specific keyword in articles">Keyword</label>
                            <small class="form-text text-muted">Type a keyword to search within article titles and summaries.</small>
                            <input type="text" id="keyword" name="keyword" class="form-control" placeholder="Enter keyword">
                        </div>

                        <div class="mb-3">
                            <label for="dateRange" class="form-label" data-bs-toggle="tooltip" title="Select a date range for articles">Date Range</label>
                            <small class="form-text text-muted">Choose a preset or custom date range for your search.</small>
                            <select id="dateRange" name="dateRange" class="form-select">
                                <option value="all">All Time</option>
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <div id="customDateRange" style="display: none;">
                            <div class="mb-3">
                                <label for="startDate" class="form-label" data-bs-toggle="tooltip" title="Start date for custom range">Start Date</label>
                                <input type="date" id="startDate" name="startDate" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="endDate" class="form-label" data-bs-toggle="tooltip" title="End date for custom range">End Date</label>
                                <input type="date" id="endDate" name="endDate" class="form-control">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="dateType" class="form-label" data-bs-toggle="tooltip" title="Choose which date field to use for filtering">Date Type</label>
                            <small class="form-text text-muted">Publication date is when the article was published; submission date is when it was added to the system.</small>
                            <select id="dateType" name="date_type" class="form-select">
                                <option value="publication">Publication Date</option>
                                <option value="submission">Submission Date</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Search for articles using the selected filters">Search</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Right column: Search results -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Search Results <span id="totalCount"></span></h5>
                    <small class="form-text text-muted">Add articles to include them in your podcast script.</small>
                    <button id="selectAllBtn" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" title="Select or deselect all visible articles">Select All</button>
                </div>
                <div id="articleList" class="article-list-container">
                    <!-- Articles will be displayed here -->
                </div>
                <div id="loadingIndicator" class="text-center p-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Podcast Configuration Section -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Podcast Configuration</h5>
        </div>
        <div class="card-body">
            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" id="podcastTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tts-tab" data-bs-toggle="tab" data-bs-target="#tts" type="button" role="tab">
                        ElevenLabs TTS
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dia-config-tab" data-bs-toggle="tab" data-bs-target="#dia-config" type="button" role="tab">
                        Dia Settings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dia-tts-tab" data-bs-toggle="tab" data-bs-target="#dia-tts" type="button" role="tab">
                        Dia TTS (with Script)
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="podcastTabsContent">
                <!-- TTS with Script Tab -->
                <div class="tab-pane fade show active" id="tts" role="tabpanel">
                    <form id="ttsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="podcastName" class="form-label" data-bs-toggle="tooltip" title="Name of the overall podcast series">Podcast Name</label>
                                    <small class="form-text text-muted">This will appear as the main title of your podcast series.</small>
                                    <input type="text" class="form-control" id="podcastName" required placeholder="Enter the name of your podcast series" value="Aunoo News">
                                </div>

                                <div class="mb-3">
                                    <label for="episodeTitle" class="form-label" data-bs-toggle="tooltip" title="Title of the specific episode">Episode Title</label>
                                    <small class="form-text text-muted">Give each episode a unique, descriptive title.</small>
                                    <input type="text" class="form-control" id="episodeTitle" required placeholder="Enter the title for this episode" value="Latest Debate">
                                </div>

                                <div class="mb-3">
                                    <label for="hostName" class="form-label" data-bs-toggle="tooltip" title="Name of the host">Host Name</label>
                                    <small class="form-text text-muted">The host will introduce and guide the podcast.</small>
                                    <input type="text" class="form-control" id="hostName" value="Aunoo" placeholder="Enter the host's name">
                                </div>

                                <div class="mb-3">
                                    <label for="ttsHostVoice" class="form-label" data-bs-toggle="tooltip" title="Voice of the host">Host Voice</label>
                                    <small class="form-text text-muted">Choose a synthetic voice for the host narration.</small>
                                    <select class="form-control" id="ttsHostVoice"></select>
                                </div>

                                <div class="mb-3">
                                    <label for="guestName" class="form-label" data-bs-toggle="tooltip" title="Name of the guest">Guest Name</label>
                                    <small class="form-text text-muted">The guest will participate in conversation mode podcasts.</small>
                                    <input type="text" class="form-control" id="guestName" required placeholder="Enter the guest's name" value="Auspex">
                                </div>

                                <div class="mb-3">
                                    <label for="guestTitle" class="form-label" data-bs-toggle="tooltip" title="Title of the guest">Guest Title</label>
                                    <small class="form-text text-muted">Select a predefined title or enter a custom one for your guest.</small>
                                    <select class="form-control mb-2" id="guestTitle" onchange="toggleCustomTitle()">
                                        <option value="chief_futurist">Chief Futurist at Aunoo</option>
                                        <option value="special_correspondent">Special Correspondent</option>
                                        <option value="industry_expert">Industry Expert</option>
                                        <option value="research_analyst">Research Analyst</option>
                                        <option value="custom">Custom…</option>
                                    </select>
                                    <input type="text" class="form-control" id="guestTitleCustom" placeholder="Enter custom guest title" style="display:none;">
                                </div>

                                <div class="mb-3" id="ttsGuestVoiceSection">
                                    <label for="ttsGuestVoice" class="form-label" data-bs-toggle="tooltip" title="Voice of the guest">Guest Voice</label>
                                    <small class="form-text text-muted">Choose a synthetic voice for the guest (conversation mode only).</small>
                                    <select class="form-control" id="ttsGuestVoice"></select>
                                </div>

                                <div class="mb-3">
                                    <label for="llmModel" class="form-label" data-bs-toggle="tooltip" title="Script generation model">Script Generation Model</label>
                                    <small class="form-text text-muted">Select the AI model used to generate the podcast script.</small>
                                    <select class="form-control" id="llmModel">
                                        <option value="gpt-4o">GPT-4 Optimized</option>
                                        <option value="claude-3-5-sonnet-latest">Claude 3.5 Sonnet</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="ttsMode" class="form-label" data-bs-toggle="tooltip" title="Conversation uses host + guest. Bulletin uses only the host voice">Podcast Mode</label>
                                    <small class="form-text text-muted">Conversation mode features a host and guest; bulletin mode is a solo host.</small>
                                    <select class="form-control" id="ttsMode" onchange="toggleTTSGuestVoice()">
                                        <option value="conversation" selected>Conversation</option>
                                        <option value="bulletin">Bulletin</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="ttsDuration" class="form-label" data-bs-toggle="tooltip" title="Short: ~2 min, Medium: ~4 min, Long: ~7+ min">Duration</label>
                                    <small class="form-text text-muted">Choose the approximate length of the podcast episode.</small>
                                    <select class="form-control" id="ttsDuration">
                                        <option value="short">Short (~2 min)</option>
                                        <option value="medium" selected>Medium (~4 min)</option>
                                        <option value="long">Long (~7+ min)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="voiceSpeed" class="form-label" data-bs-toggle="tooltip" title="Voice speed multiplier — 1.0 is normal, lower is slower, higher is faster">Voice Speed</label>
                                    <small class="form-text text-muted">Adjust the speaking speed of the generated voices.</small>
                                    <input type="number" class="form-control" id="voiceSpeed" step="0.05" min="0.5" max="1.5" value="0.9">
                                </div>

                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" data-bs-toggle="tooltip" title="Choose a template for the podcast script structure">Script Template</label>
                                    <small class="form-text text-muted">Templates define the structure and style of your podcast script.</small>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <select class="form-control me-2" id="scriptTemplate"></select>
                                        <button type="button" class="btn btn-secondary" id="editTemplate" data-bs-toggle="tooltip" title="Edit the selected script template">Edit Template</button>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="scriptPreview" class="form-label" data-bs-toggle="tooltip" title="Preview or edit the generated script">Generated Script</label>
                                    <small class="form-text text-muted">Review or edit the script before generating audio.</small>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <button type="button" class="btn btn-primary" id="generateScript" data-bs-toggle="tooltip" title="Generate a podcast script using the selected articles and settings">Generate Script</button>
                                        <button type="button" class="btn btn-secondary" id="editScript" data-bs-toggle="tooltip" title="Edit the generated script in a full editor">Edit Script</button>
                                    </div>
                                    <!-- Preview / inline editor container -->
                                    <div id="scriptPreview" class="border rounded p-3 bg-light" style="min-height: 300px;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Generate the podcast audio using ElevenLabs TTS">Generate TTS Podcast</button>
                            <button type="button" class="btn btn-outline-secondary" id="saveDefaultsBtn" data-bs-toggle="tooltip" title="Save current selections as defaults for this mode">Save Defaults</button>
                        </div>
                    </form>
                </div>

                <!-- Dia Config Tab -->
                <div class="tab-pane fade" id="dia-config" role="tabpanel">
                    <form id="diaConfigForm" class="mt-3" style="max-width: 500px;">
                        <div class="mb-3">
                            <label for="diaApiKey" class="form-label" data-bs-toggle="tooltip" title="Your Dia API key for TTS generation">Dia API Key</label>
                            <small class="form-text text-muted">Required for using Dia TTS features.</small>
                            <input type="text" class="form-control" id="diaApiKey" placeholder="Enter Dia API Key" required>
                        </div>
                        <div class="mb-3">
                            <label for="diaApiUrl" class="form-label" data-bs-toggle="tooltip" title="Base URL for your Dia TTS server">Dia Base URL</label>
                            <small class="form-text text-muted">Example: http://localhost:8000/v1/tts</small>
                            <input type="text" class="form-control" id="diaApiUrl" placeholder="http://localhost:8000/v1/tts" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Save Dia TTS configuration">Save</button>
                            <button type="button" id="diaDeleteBtn" class="btn btn-danger" data-bs-toggle="tooltip" title="Remove Dia TTS configuration">Remove</button>
                        </div>
                        <div id="diaConfigStatus" class="mt-2"></div>
                    </form>
                </div>

                <!-- Dia TTS with Script Tab -->
                <div class="tab-pane fade" id="dia-tts" role="tabpanel">
                    <form id="diaTtsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="diaPodcastName" class="form-label" data-bs-toggle="tooltip" title="Name of the podcast series for Dia TTS">Podcast Name</label>
                                    <small class="form-text text-muted">This will be used as the main title for Dia-generated podcasts.</small>
                                    <input type="text" class="form-control" id="diaPodcastName" placeholder="Enter podcast name" value="Aunoo News">
                                </div>
                                <div class="mb-3">
                                    <label for="diaEpisodeTitle" class="form-label" data-bs-toggle="tooltip" title="Title of the episode for Dia TTS">Episode Title</label>
                                    <small class="form-text text-muted">Provide a unique title for this episode.</small>
                                    <input type="text" class="form-control" id="diaEpisodeTitle" placeholder="Enter episode title" value="Latest Debate">
                                </div>
                                <div class="mb-3">
                                    <label for="diaHostName" class="form-label" data-bs-toggle="tooltip" title="Name of the host for Dia TTS">Host Name</label>
                                    <small class="form-text text-muted">The host will narrate the podcast.</small>
                                    <input type="text" class="form-control" id="diaHostName" value="Aunoo">
                                </div>
                                <div class="mb-3">
                                    <label for="diaGuestName" class="form-label" data-bs-toggle="tooltip" title="Name of the guest for Dia TTS">Guest Name</label>
                                    <small class="form-text text-muted">The guest will participate in the conversation.</small>
                                    <input type="text" class="form-control" id="diaGuestName" value="Auspex">
                                </div>
                                <div class="mb-3">
                                    <label for="diaGuestTitle" class="form-label" data-bs-toggle="tooltip" title="Title of the guest for Dia TTS">Guest Title</label>
                                    <small class="form-text text-muted">Specify the guest's title or role.</small>
                                    <input type="text" class="form-control" id="diaGuestTitle" value="Chief Futurist">
                                </div>
                                <div class="mb-3">
                                    <label for="diaDuration" class="form-label" data-bs-toggle="tooltip" title="Select the duration for the Dia TTS podcast">Duration</label>
                                    <small class="form-text text-muted">Choose how long the generated podcast should be.</small>
                                    <select class="form-control" id="diaDuration">
                                        <option value="short">Short (~2 min)</option>
                                        <option value="medium" selected>Medium (~4 min)</option>
                                        <option value="long">Long (~7+ min)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="diaLlmModel" class="form-label" data-bs-toggle="tooltip" title="Select the AI model for script generation in Dia TTS">Script Generation Model</label>
                                    <small class="form-text text-muted">Choose the AI model for generating the podcast script.</small>
                                    <select class="form-control" id="diaLlmModel">
                                        <option value="gpt-4o">GPT-4 Optimized</option>
                                        <option value="claude-3-5-sonnet-latest">Claude 3.5 Sonnet</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" data-bs-toggle="tooltip" title="Choose a template for the Dia TTS script structure">Script Template</label>
                                    <small class="form-text text-muted">Templates define the structure and style of your Dia TTS script.</small>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <select class="form-control me-2" id="diaScriptTemplate"></select>
                                        <button type="button" class="btn btn-secondary" id="diaEditTemplate" data-bs-toggle="tooltip" title="Edit the selected Dia script template">Edit Template</button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-bs-toggle="tooltip" title="Preview or edit the generated Dia script">Generated Script</label>
                                    <small class="form-text text-muted">Review or edit the script before generating Dia audio.</small>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <button type="button" class="btn btn-primary" id="diaGenerateScript" data-bs-toggle="tooltip" title="Generate a Dia podcast script using the selected articles and settings">Generate Script</button>
                                        <button type="button" class="btn btn-secondary" id="diaEditScript" data-bs-toggle="tooltip" title="Edit the generated Dia script in a full editor">Edit Script</button>
                                    </div>
                                    <div id="diaScriptPreview" class="border rounded p-3 bg-light" style="min-height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="mb-3 col-md-3">
                                <label for="diaOutputFormat" class="form-label" data-bs-toggle="tooltip" title="Choose the output audio format for Dia TTS">Output Format</label>
                                <small class="form-text text-muted">Select mp3 for most use cases; wav for higher quality.</small>
                                <select class="form-control" id="diaOutputFormat">
                                    <option value="mp3" selected>mp3</option>
                                    <option value="wav">wav</option>
                                </select>
                            </div>
                            <div class="mb-3 col-md-3">
                                <label for="diaSpeedFactor" class="form-label" data-bs-toggle="tooltip" title="Playback speed multiplier – 1.0 = normal, lower is slower">Speed&nbsp;Factor</label>
                                <small class="form-text text-muted">Adjust the playback speed of the generated audio.</small>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range flex-grow-1" id="diaSpeedFactor" min="0.8" max="1.0" step="0.02" value="0.94">
                                    <span id="diaSpeedValue" style="width:3rem;">0.94</span>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary mt-auto" data-bs-toggle="tooltip" title="Generate the podcast audio using Dia TTS">Generate Dia Podcast</button>
                            <span id="diaTtsStatus" class="ms-3"></span>
                        </div>
                        <div class="mt-4" id="diaTtsPlayerContainer" style="display:none;">
                            <audio id="diaTtsAudio" controls class="w-100"></audio>
                            <a id="diaTtsDownload" class="btn btn-success mt-2" download="dia_podcast.mp3">Download</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="card mt-4" id="progressSection" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0">Generation Progress</h5>
        </div>
        <div class="card-body">
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <div id="progressStatus" class="text-center">Initializing...</div>
        </div>
    </div>

    <!-- Result Section -->
    <div class="card mt-4" id="resultSection" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0">Generated Podcast</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <audio id="podcastPlayer" controls class="w-100"></audio>
            </div>
            <div class="mb-3">
                <h6>Transcript</h6>
                <div id="transcript" class="border p-3 bg-light"></div>
            </div>
            <div class="mb-3">
                <button class="btn btn-success" onclick="downloadPodcast()" data-bs-toggle="tooltip" title="Download the generated podcast audio">Download Podcast</button>
                <button class="btn btn-info" onclick="downloadTranscript()" data-bs-toggle="tooltip" title="Download the transcript as a text file">Download Transcript</button>
            </div>
        </div>
    </div>

    <!-- Past Podcasts Section -->
    <div class="card mt-4" id="pastPodcastsSection">
        <div class="card-header">
            <h5 class="mb-0">Past Podcasts</h5>
        </div>
        <div class="card-body">
            <div id="pastPodcasts" class="list-group">
                <!-- Past podcasts will be displayed here -->
            </div>
            <div id="noPodcasts" class="text-center text-muted" style="display: none;">
                <p>No podcasts found</p>
            </div>
        </div>
    </div>
</div>

<!-- Script Editor Modal -->
<div class="modal fade" id="scriptEditorModal" tabindex="-1" aria-labelledby="scriptEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scriptEditorModalLabel">Edit Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="scriptEditorTextarea" rows="15"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveScript">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Template Editor Modal -->
<div class="modal fade" id="templateEditorModal" tabindex="-1" aria-labelledby="templateEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateEditorModalLabel">Edit Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Available placeholders: <code>{podcast_name}</code>, <code>{episode_title}</code>, <code>{guest_name}</code>, <code>{guest_title}</code>, <code>{articles_discussion}</code></p>
                <textarea class="form-control" id="templateEditor" rows="15"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTemplate">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Then add Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Add Monaco Editor -->
<script>
    // Monaco Editor initialization
    let editor;
    let diaEditor;
    (function() {
        // Load Monaco Editor
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js';
        script.onload = function() {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                editor = monaco.editor.create(document.getElementById('scriptPreview'), {
                    value: '',
                    language: 'markdown',
                    theme: 'vs-light',
                    minimap: { enabled: false },
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    automaticLayout: true
                });

                // Create Dia editor
                diaEditor = monaco.editor.create(document.getElementById('diaScriptPreview'), {
                    value: '',
                    language: 'markdown',
                    theme: 'vs-light',
                    minimap: { enabled: false },
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    automaticLayout: true
                });

                // Prefill script from localStorage if present
                const draft = localStorage.getItem('podcast_draft_script');
                if (draft) {
                    editor.setValue(draft);
                    diaEditor.setValue(draft);
                    localStorage.removeItem('podcast_draft_script');
                }
            });
        };
        document.head.appendChild(script);
    })();
</script>

<script>
let selectedArticles = [];
let currentPage = 1;
let hasMoreArticles = true;
let isLoading = false;
let selectedArticleData = {};
let currentGeneratedPodcast = null;

// Initialize dropdowns and event listeners
document.addEventListener('DOMContentLoaded', function() {
    initializeDropdowns();
    initializeEventListeners();
    loadTopics();
    
    // Initialize Bootstrap modals
    const scriptEditorModal = new bootstrap.Modal(document.getElementById('scriptEditorModal'));
    const templateEditorModal = new bootstrap.Modal(document.getElementById('templateEditorModal'));
    
    // Handle script editing
    document.getElementById('editScript').addEventListener('click', () => {
        if (editor) {
            const scriptContent = editor.getValue();
            document.getElementById('scriptEditorTextarea').value = scriptContent;
            scriptEditorModal.show();
        }
    });

    // Handle script saving
    document.getElementById('saveScript').addEventListener('click', () => {
        if (editor) {
            const scriptContent = document.getElementById('scriptEditorTextarea').value;
            editor.setValue(scriptContent);
            scriptEditorModal.hide();
        }
    });

    // Handle template editing
    document.getElementById('editTemplate').addEventListener('click', async () => {
        try {
            const templateName = document.getElementById('scriptTemplate').value;
            const response = await fetch(`/api/podcast_templates/${templateName}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            document.getElementById('templateEditor').value = data.template;
            templateEditorModal.show();
            // When saving, post to same endpoint then reload list
            document.getElementById('saveTemplate').onclick = async () => {
                try {
                    const content = document.getElementById('templateEditor').value;
                    const res = await fetch('/api/podcast_templates', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ name: templateName, content })
                    });
                    if (!res.ok) throw new Error('Save failed');
                    templateEditorModal.hide();
                    await loadTemplates();
                    alert('Template saved');
                } catch (err) { console.error('Save fail', err); alert('Error'); }
            };
        } catch (err) { console.error('Error loading template', err); alert('Error loading template'); }
    });

    // Dia template edit
    document.getElementById('diaEditTemplate').addEventListener('click', async () => {
        try {
            const templateName = document.getElementById('diaScriptTemplate').value;
            const response = await fetch(`/api/podcast_templates/${templateName}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            document.getElementById('templateEditor').value = data.template;
            templateEditorModal.show();
            // When saving, post to same endpoint then reload list
            document.getElementById('saveTemplate').onclick = async () => {
                try {
                    const content = document.getElementById('templateEditor').value;
                    const res = await fetch('/api/podcast_templates', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ name: templateName, content })
                    });
                    if (!res.ok) throw new Error('Save failed');
                    templateEditorModal.hide();
                    await loadTemplates();
                    alert('Template saved');
                } catch (err) { console.error('Save fail', err); alert('Error'); }
            };
        } catch (err) { console.error('Error loading template', err); alert('Error loading template'); }
    });

    // At DOMContentLoaded
    // 1. populate LLM model select
    // 2. fetch ElevenLabs voices for host / guest dropdowns
    // 3. load past podcasts list

    fetch('/api/ai_models')
        .then(res => res.json())
        .then(models => {
            const llmSelect = document.getElementById('llmModel');
            const diaSelect = document.getElementById('diaLlmModel');
            if (llmSelect) {
                llmSelect.innerHTML = '<option value="">Select a model</option>';
            }
            if (diaSelect) {
                diaSelect.innerHTML = '<option value="">Select a model</option>';
            }
            models.forEach(m => {
                const opt1 = new Option(`${m.name} (${m.provider})`, m.name, false, false);
                if (llmSelect) llmSelect.appendChild(opt1);
                if (diaSelect) diaSelect.appendChild(opt1.cloneNode(true));
            });

            // Auto-select the first real model if nothing selected yet
            if (llmSelect && llmSelect.options.length > 1 && !llmSelect.value) {
                llmSelect.selectedIndex = 1; // index 0 = placeholder
            }
            if (diaSelect && diaSelect.options.length > 1 && !diaSelect.value) {
                diaSelect.selectedIndex = 1;
            }
        })
        .catch(err => console.error('Error loading AI models', err));

    // Fetch voices for dropdowns
    fetch('/api/available_voices')
        .then(res => res.json())
        .then(voices => {
            const hostSel = document.getElementById('ttsHostVoice');
            const guestSel = document.getElementById('ttsGuestVoice');

            hostSel.innerHTML = '';
            guestSel.innerHTML = '';

            voices.forEach(v => {
                const label = `${v.name} (${v.category || 'TTS'})`;
                const opt1 = new Option(label, v.voice_id, false, false);
                const opt2 = new Option(label, v.voice_id, false, false);
                hostSel.appendChild(opt1);
                guestSel.appendChild(opt2);
            });

            // Pre‑select first voice as host, second as guest (if available)
            if (hostSel.options.length) hostSel.selectedIndex = 0;
            if (guestSel.options.length > 1) guestSel.selectedIndex = 1;

            // Now that voices are loaded, load saved defaults
            loadDefaults();
        })
        .catch(err => console.error('Error loading voices', err));

    // Reload defaults when mode changes
    document.getElementById('ttsMode').addEventListener('change', loadDefaults);

    // Load past podcasts immediately
    loadPastPodcasts();

    // Activate bootstrap tooltips globally
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Load templates list
    async function loadTemplates() {
        try {
            const res = await fetch('/api/podcast_templates');
            if (!res.ok) throw new Error('Failed template list');
            const templates = await res.json();
            const sel = document.getElementById('scriptTemplate');
            const diaSel = document.getElementById('diaScriptTemplate');
            sel.innerHTML = '';
            diaSel.innerHTML = '';
            const eleTemplates = templates.filter(t => !t.name.startsWith('dia_conversation_') && t.name !== 'default');
            const diaTemplates = templates.filter(t => t.name.startsWith('dia_conversation_'));

            eleTemplates.forEach((t, idx) => {
                sel.appendChild(new Option(t.name, t.name, false, idx === 0));
            });

            diaTemplates.forEach((t, idx) => {
                diaSel.appendChild(new Option(t.name, t.name, false, idx === 0));
            });
        } catch (err) { console.error('Error loading templates', err); }
    }

    loadTemplates();
});

function initializeDropdowns() {
    // Initialize Select2 for multiple select dropdowns
    $('#category').select2({
        placeholder: "Select categories",
        allowClear: true,
        multiple: true,
        width: '100%'
    });

    $('#futureSignal').select2({
        placeholder: "Select future signals",
        allowClear: true,
        multiple: true,
        width: '100%'
    });

    $('#sentiment').select2({
        placeholder: "Select sentiments",
        allowClear: true,
        multiple: true,
        width: '100%'
    });

    // Initialize topic select
    $('#topicSelect').select2({
        placeholder: "Select a topic",
        allowClear: true,
        width: '100%'
    }).on('change', function(e) {
        const topic = $(this).val();
        const categorySelect = $('#category');
        
        // Clear and disable categories if no topic selected
        if (!topic) {
            categorySelect.prop('disabled', true)
                        .val(null)
                        .trigger('change');
            return;
        }
        
        // Enable and load categories for selected topic
        categorySelect.prop('disabled', false);
        
        // Load categories for the selected topic
        fetch(`/api/categories/${encodeURIComponent(topic)}`)
            .then(response => response.json())
            .then(categories => {
                categorySelect.empty();
                categories.forEach(category => {
                    categorySelect.append(new Option(category, category, false, false));
                });
                categorySelect.trigger('change');
            })
            .catch(error => console.error('Error loading categories:', error));
    });

    // Load initial dropdowns data
    Promise.all([
        fetch('/api/future_signals').then(res => res.json()),
        fetch('/api/sentiments').then(res => res.json())
    ]).then(([futureSignals, sentiments]) => {
        const futureSignalSelect = $('#futureSignal');
        const sentimentSelect = $('#sentiment');

        futureSignals.forEach(signal => {
            futureSignalSelect.append(new Option(signal, signal, false, false));
        });

        sentiments.forEach(sentiment => {
            sentimentSelect.append(new Option(sentiment, sentiment, false, false));
        });

        // Trigger change to update Select2
        futureSignalSelect.trigger('change');
        sentimentSelect.trigger('change');
    }).catch(error => console.error('Error loading dropdown data:', error));
}

function initializeEventListeners() {
    // Form submission
    document.getElementById('articleSearchForm').addEventListener('submit', handleSearch);

    // Date range toggle
    document.getElementById('dateRange').addEventListener('change', toggleCustomDateRange);

    // Select all button
    document.getElementById('selectAllBtn').addEventListener('click', toggleSelectAll);

    // Infinite scroll
    document.getElementById('articleList').addEventListener('scroll', handleScroll);

    // Handle Dia script editing
    document.getElementById('diaEditScript').addEventListener('click', () => {
        if (diaEditor) {
            document.getElementById('scriptEditorTextarea').value = diaEditor.getValue();
            scriptEditorModal.show();
            // Rewire save button temporarily
            document.getElementById('saveScript').onclick = () => {
                diaEditor.setValue(document.getElementById('scriptEditorTextarea').value);
                scriptEditorModal.hide();
            };
        }
    });

    // Dia generate script (uses same backend endpoint)
    document.getElementById('diaGenerateScript').addEventListener('click', async () => {
        const podcastName = document.getElementById('diaPodcastName').value;
        const episodeTitle = document.getElementById('diaEpisodeTitle').value;
        const model = document.getElementById('diaLlmModel').value;
        const duration = document.getElementById('diaDuration').value;
        const guestTitle = document.getElementById('diaGuestTitle').value;
        const guestName = document.getElementById('diaGuestName').value;
        const hostName = document.getElementById('diaHostName').value;
        const articles = Object.values(selectedArticleData);
        if (!podcastName || !episodeTitle || articles.length === 0) {
            alert('Fill podcast name/title and select articles first');
            return;
        }
        try {
            const res = await fetch('/api/generate_podcast_script', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    podcast_name: podcastName,
                    episode_title: episodeTitle,
                    model,
                    mode: 'dia_conversation',
                    duration,
                    host_name: hostName,
                    guest_title: guestTitle,
                    guest_name: guestName,
                    articles
                })
            });
            if (!res.ok) throw new Error('Failed');
            const data = await res.json();
            // Convert to Dia format so user sees final payload
            const conv = await fetch('/api/dia/convert', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({script: data.script})
            });
            const dia = conv.ok? await conv.json(): {script:data.script};
            diaEditor.setValue(dia.script);
        } catch (err) { console.error(err); alert('Script generation failed'); }
    });

    // Dia-TTS form submit
    document.getElementById('diaTtsForm').addEventListener('submit', async e => {
        e.preventDefault();
        if (!diaEditor) { alert('Editor not ready'); return; }
        const text = diaEditor.getValue();
        if (!text.trim()) { alert('Generate or write a script first'); return; }
        // Show global progress section similar to ElevenLabs flow
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        progressSection.style.display = 'block';
        resultSection.style.display = 'none';

        try {
            const payload = {
                podcast_name: $('#diaPodcastName').val(),
                episode_title: $('#diaEpisodeTitle').val(),
                text,
                speed_factor: parseFloat($('#diaSpeedFactor').val() || '1'),
                output_format: $('#diaOutputFormat').val(),
                topic: document.getElementById('topicSelect').value || null,
                model: document.getElementById('diaLlmModel').value,
                duration: document.getElementById('diaDuration').value,
                host_name: document.getElementById('diaHostName').value,
                guest_name: document.getElementById('diaGuestName').value,
                guest_title: document.getElementById('diaGuestTitle').value,
                mode: "conversation"
            };

            const res = await fetch('/api/dia/generate_podcast', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Failed');
            const data = await res.json();
            pollPodcastStatus(data.podcast_id);
        } catch (err) {
            console.error(err);
            document.getElementById('progressStatus').innerHTML = `<div class="alert alert-danger">Dia generation failed</div>`;
        }
    });

    // Update Dia speed value label
    $('#diaSpeedFactor').on('input', function(){
        $('#diaSpeedValue').text(parseFloat(this.value).toFixed(2));
    });
}

async function loadTopics() {
    try {
        const response = await fetch('/api/topics');
        const topics = await response.json();
        const topicSelect = document.getElementById('topicSelect');
        
        topics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic.name;
            option.textContent = topic.name;
            topicSelect.appendChild(option);
        });

        // Initialize Select2 after populating options
        $(topicSelect).trigger('change');
    } catch (error) {
        console.error('Error loading topics:', error);
    }
}

function handleSearch(event) {
    event.preventDefault();
    currentPage = 1;
    hasMoreArticles = true;
    const articleList = document.getElementById('articleList');
    articleList.innerHTML = '';
    fetchArticles();
}

async function fetchArticles() {
    if (isLoading || !hasMoreArticles) return;

    isLoading = true;
    document.getElementById('loadingIndicator').style.display = 'block';

    try {
        const formData = new FormData(document.getElementById('articleSearchForm'));
        const searchParams = new URLSearchParams(formData);
        
        // Add pagination
        searchParams.append('page', currentPage);
        searchParams.append('per_page', 20);
        
        // Request all necessary fields
        searchParams.append('include_fields', 'title,summary,url,uri,publication_date,submission_date,category,sentiment,news_source,analyzed,ai_impact,future_signal');

        const response = await fetch(`/api/search_articles?${searchParams}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.articles) {
            displaySearchResults(data.articles);
            updateTotalCount(data.total_count || 0);
            currentPage++;
            hasMoreArticles = data.articles.length === 20;
        } else {
            displaySearchResults([]);
            updateTotalCount(0);
            hasMoreArticles = false;
        }
    } catch (error) {
        console.error('Error fetching articles:', error);
        // Show error message to user
        const articleList = document.getElementById('articleList');
        articleList.innerHTML = `
            <div class="alert alert-danger m-3" role="alert">
                Error loading articles. Please try again.
            </div>
        `;
        updateTotalCount(0);
        hasMoreArticles = false;
    } finally {
        isLoading = false;
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

function displaySearchResults(articles) {
    const container = document.getElementById('articleList');
    
    if (!articles || articles.length === 0) {
        if (currentPage === 1) {
            container.innerHTML = `
                <div class="text-center text-muted p-4">
                    No articles found matching your criteria.
                </div>
            `;
        }
        return;
    }
    
    articles.forEach(article => {
        const item = document.createElement('div');
        item.className = 'article-item p-3 border-bottom';
        
        const isSelected = selectedArticles.includes(article.uri);
        
        // Store the full article data when displaying
        if (isSelected && !selectedArticleData[article.uri]) {
            selectedArticleData[article.uri] = article;
        }
        
        // Create media bias HTML if available
        let mediaBiasHtml = '';
        if (article.bias || article.factual_reporting) {
            mediaBiasHtml = `<div class="mt-1">`;
            
            if (article.bias) {
                mediaBiasHtml += `<span class="bias-badge ${getBiasClass(article.bias)} me-2">${article.bias}</span>`;
            }
            
            if (article.factual_reporting) {
                mediaBiasHtml += `<span class="bias-badge ${getFactualClass(article.factual_reporting)} me-2">${article.factual_reporting}</span>`;
            }
            
            // Add tooltip with additional bias data
            mediaBiasHtml += `
                <span class="source-tooltip">
                    <i class="fas fa-info-circle"></i>
                    <div class="tooltip-content">
                        <div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Media Bias Info</div>
                        <div><strong>Source:</strong> ${article.news_source || 'Unknown'}</div>
                        ${article.bias ? `<div><strong>Bias:</strong> ${article.bias}</div>` : ''}
                        ${article.factual_reporting ? `<div><strong>Factual Reporting:</strong> ${article.factual_reporting}</div>` : ''}
                        ${article.mbfc_credibility_rating ? `<div><strong>MBFC Rating:</strong> ${article.mbfc_credibility_rating}</div>` : ''}
                        ${article.bias_country ? `<div><strong>Country:</strong> ${article.bias_country}</div>` : ''}
                        ${article.press_freedom ? `<div><strong>Press Freedom:</strong> ${article.press_freedom}</div>` : ''}
                        ${article.media_type ? `<div><strong>Media Type:</strong> ${article.media_type}</div>` : ''}
                        ${article.popularity ? `<div><strong>Popularity:</strong> ${article.popularity}</div>` : ''}
                    </div>
                </span>
            `;
            
            mediaBiasHtml += `</div>`;
        }
        
        // Create the article display element
        item.innerHTML = `
            <div class="d-flex justify-content-between">
                <div class="flex-grow-1">
                    <h5 class="mb-2">${article.title || 'Untitled'}</h5>
                    <div class="mb-2">
                        <span class="badge bg-primary me-1">${article.sentiment || 'N/A'}</span>
                        <span class="badge bg-success me-1">${article.category || 'N/A'}</span>
                        <span class="badge bg-info">${article.future_signal || 'N/A'}</span>
                    </div>
                    <p class="mb-2">${article.summary || 'No summary available'}</p>
                    <small class="text-muted">
                        Source: ${article.news_source || 'Unknown'} | 
                        Published: ${article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'Unknown date'}
                    </small>
                    ${mediaBiasHtml}
                </div>
                <div class="ms-3">
                    <button class="btn btn-sm ${isSelected ? 'btn-danger' : 'btn-primary'}" 
                            data-article-uri="${article.uri}">
                        ${isSelected ? 'Remove' : 'Add'}
                    </button>
                </div>
            </div>
        `;

        // Safely attach the click handler once the button element is found
        const button = item.querySelector('button');
        if (button) {
            button.addEventListener('click', () => {
                toggleArticleSelection(article);
            });
        } else {
            // This should not normally happen but guards against malformed HTML
            console.warn('displaySearchResults: <button> not found for article', article);
        }
        
        container.appendChild(item);
    });
}

function updateTotalCount(count) {
    document.getElementById('totalCount').textContent = count > 0 ? ` (${count} articles found)` : '';
}

function toggleArticleSelection(article) {
    const uri = article.uri;
    const index = selectedArticles.indexOf(uri);
    if (index === -1) {
        selectedArticles.push(uri);
        selectedArticleData[uri] = article;
    } else {
        selectedArticles.splice(index, 1);
        delete selectedArticleData[uri];
    }

    // Update all buttons for this article
    document.querySelectorAll(`button[data-article-uri="${uri}"]`).forEach(button => {
        const isSelected = selectedArticles.includes(uri);
        button.className = `btn btn-sm ${isSelected ? 'btn-danger' : 'btn-primary'}`;
        button.textContent = isSelected ? 'Remove' : 'Add';
    });
}

function toggleSelectAll() {
    const btn = document.getElementById('selectAllBtn');
    const isSelectAll = btn.textContent === 'Select All';
    
    if (isSelectAll) {
        // Select all visible articles
        document.querySelectorAll('.article-item').forEach(item => {
            const uri = item.querySelector('button').dataset.articleUri;
            if (!selectedArticles.includes(uri)) {
                selectedArticles.push(uri);
            }
        });
        btn.textContent = 'Deselect All';
    } else {
        selectedArticles = [];
        btn.textContent = 'Select All';
    }
    
    // Refresh display
    const articleList = document.getElementById('articleList');
    articleList.innerHTML = '';
    currentPage = 1;
    fetchArticles();
}

function handleScroll(e) {
    const element = e.target;
    if (element.scrollHeight - element.scrollTop === element.clientHeight) {
        fetchArticles();
    }
}

function toggleCustomDateRange() {
    const dateRange = document.getElementById('dateRange');
    const customDateRange = document.getElementById('customDateRange');
    customDateRange.style.display = dateRange.value === 'custom' ? 'block' : 'none';
}

function toggleGuestVoice() {
    const modeSel = document.getElementById('podcastMode');
    if (!modeSel) return;
    const guestVoiceSection = document.getElementById('guestVoiceSection');
    if (guestVoiceSection) guestVoiceSection.style.display = modeSel.value === 'conversation' ? 'block' : 'none';
}

const podcastFormEl = document.getElementById('podcastForm');
if (podcastFormEl) podcastFormEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (selectedArticles.length === 0) {
        alert('Please select at least one article for the podcast.');
        return;
    }

    const formData = {
        title: document.getElementById('podcastTitle').value,
        mode: document.getElementById('podcastMode').value,
        host_voice_id: document.getElementById('hostVoice').value,
        guest_voice_id: document.getElementById('podcastMode').value === 'conversation' ? 
            document.getElementById('guestVoice').value : null,
        duration_scale: document.getElementById('durationScale').value,
        quality_preset: document.getElementById('qualityPreset').value,
        article_uris: selectedArticles
    };

    console.log('Submitting podcast creation with data:', formData);

    try {
        // Show progress section
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        progressSection.style.display = 'block';
        resultSection.style.display = 'none';

        // Generate TTS podcast (new flow)
        const response = await fetch('/api/generate_tts_podcast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                podcast_name: formData.title,
                episode_title: formData.title, // legacy mapping – could refine
                article_uris: formData.article_uris,
                host_voice_id: formData.host_voice_id,
                guest_voice_id: formData.guest_voice_id,
                mode: formData.mode,
                script: '', // let backend auto‑generate from articles
            })
        });

        const responseText = await response.text();
        console.log('Raw response:', responseText);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}, message: ${responseText}`);
        }

        let result;
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            console.error('Error parsing response:', e);
            throw new Error('Invalid JSON response from server');
        }
        
        console.log('Podcast creation response:', result);

        if (!result.podcast_id) {
            throw new Error('No podcast ID received');
        }
        
        // Start polling for status
        pollPodcastStatus(result.podcast_id);
    } catch (error) {
        console.error('Error creating podcast:', error);
        document.getElementById('progressStatus').innerHTML = `
            <div class="alert alert-danger">
                Error creating podcast: ${error.message}
            </div>
        `;
    }
});

async function pollPodcastStatus(podcastId) {
    if (!podcastId) {
        console.error('No podcast ID provided for status polling');
        return;
    }

    const progressBar = document.querySelector('.progress-bar');
    const progressStatus = document.getElementById('progressStatus');
    
    try {
        const response = await fetch(`/api/podcast/status/${podcastId}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // Update progress bar
        const progress = data.progress * 100;
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        
        switch (data.status) {
            case 'completed':
                progressBar.style.width = '100%';
                progressStatus.innerHTML = '<div class="alert alert-success">Generation completed!</div>';
                
                // Cache current generated podcast info
                currentGeneratedPodcast = {
                    id: podcastId,
                    title: data.title || '',
                    audioUrl: data.audio_url || ''
                };
                
                // Show result section
                document.getElementById('resultSection').style.display = 'block';
                
                // Update audio player
                const audioPlayer = document.getElementById('podcastPlayer');
                audioPlayer.src = data.audio_url;
                
                // Update transcript
                document.getElementById('transcript').textContent = data.transcript;
                
                // Refresh past podcasts
                loadPastPodcasts();
                break;
                
            case 'failed':
                progressStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Podcast generation failed</strong>
                        ${data.error ? `<br><br>${data.error}` : ''}
                    </div>
                `;
                break;
                
            case 'processing':
            default:
                progressStatus.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">Processing... ${Math.round(progress)}%</div>
                    </div>
                `;
                // Poll again in 5 seconds
                setTimeout(() => pollPodcastStatus(podcastId), 5000);
                break;
        }
    } catch (error) {
        console.error('Error checking podcast status:', error);
        progressStatus.innerHTML = `
            <div class="alert alert-danger">
                Error checking status: ${error.message}
            </div>
        `;
    }
}

async function loadPastPodcasts() {
    try {
        const pastPodcastsContainer = document.getElementById('pastPodcasts');
        const noPodcastsMessage = document.getElementById('noPodcasts');
        
        if (!pastPodcastsContainer || !noPodcastsMessage) {
            console.error('Required DOM elements not found');
            return;
        }

        const response = await fetch('/api/podcast/list');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const podcasts = await response.json();
        
        pastPodcastsContainer.innerHTML = '';
        
        if (!podcasts || podcasts.length === 0) {
            noPodcastsMessage.style.display = 'block';
            return;
        }

        noPodcastsMessage.style.display = 'none';
        
        podcasts.forEach(podcast => {
            const item = document.createElement('div');
            item.className = 'list-group-item';
            const created = new Date(podcast.created_at).toLocaleString();
            const completed = podcast.completed_at ? new Date(podcast.completed_at).toLocaleString() : '—';
            const meta = podcast.metadata || {};
            const metaBadges = [];
            if (meta.duration) metaBadges.push(`<span class='badge bg-info me-1'>${meta.duration} min</span>`);
            if (meta.podcast_name) metaBadges.push(`<span class='badge bg-primary me-1'>🎙️ ${meta.podcast_name}</span>`);
            if (meta.episode_title) metaBadges.push(`<span class='badge bg-primary me-1'>${meta.episode_title}</span>`);
            if (meta.mode) metaBadges.push(`<span class='badge bg-warning text-dark me-1'>${meta.mode}</span>`);
            if (meta.guest_title) metaBadges.push(`<span class='badge bg-secondary me-1'>${meta.guest_title}</span>`);
            if (meta.guest) metaBadges.push(`<span class='badge bg-secondary me-1'>Guest: ${meta.guest}</span>`);
            if (meta.topic) metaBadges.push(`<span class="badge bg-dark">${meta.topic}</span>`);
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-start flex-wrap">
                    <div class="me-2">
                        <h6 class="mb-1">${podcast.title}</h6>
                        <small class="text-muted">Created: ${created}</small><br>
                        <small class="text-muted">Completed: ${completed}</small><br>
                        <span class="badge bg-${podcast.status === 'completed' ? 'success' : (podcast.status === 'error' ? 'danger' : 'warning')} text-uppercase">${podcast.status}</span>
                        ${metaBadges.join(' ')}
                    </div>
                    <div class="btn-group mt-2 mt-md-0">
                        <button class="btn btn-sm btn-primary play-btn" data-bs-toggle="tooltip" title="Play this podcast episode"><i class="fas fa-play"></i> Play</button>
                        <button class="btn btn-sm btn-info transcript-btn" data-bs-toggle="tooltip" title="Download the transcript for this episode"><i class="fas fa-file-alt"></i> Transcript</button>
                        <button class="btn btn-sm btn-success download-btn" data-bs-toggle="tooltip" title="Download the audio for this episode"><i class="fas fa-download"></i> Download</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-bs-toggle="tooltip" title="Delete this podcast episode"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
            
            // Add event listeners after creating the element
            const playBtn = item.querySelector('.play-btn');
            playBtn.addEventListener('click', () => playPodcast(podcast.audio_url));
            
            const transcriptBtn = item.querySelector('.transcript-btn');
            transcriptBtn.addEventListener('click', () => downloadTranscript(podcast.podcast_id, podcast.title));
            
            const downloadBtn = item.querySelector('.download-btn');
            downloadBtn.addEventListener('click', () => downloadPodcast(podcast.audio_url));
            
            const deleteBtn = item.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', () => deletePodcast(podcast.podcast_id));
            
            pastPodcastsContainer.appendChild(item);
        });
    } catch (error) {
        console.error('Error loading past podcasts:', error);
        const noPodcastsMessage = document.getElementById('noPodcasts');
        if (noPodcastsMessage) {
            noPodcastsMessage.style.display = 'block';
            noPodcastsMessage.innerHTML = '<p class="text-danger">Error loading podcasts</p>';
        }
    }
}

function playPodcast(audioUrl) {
    const player = document.getElementById('podcastPlayer');
    player.src = audioUrl;
    player.play();
}

function downloadPodcast(audioUrl) {
    // Allow call without param – use currentGeneratedPodcast or player src
    if (!audioUrl) {
        if (currentGeneratedPodcast && currentGeneratedPodcast.audioUrl) {
            audioUrl = currentGeneratedPodcast.audioUrl;
        } else {
            const player = document.getElementById('podcastPlayer');
            audioUrl = player ? player.src : null;
        }
    }
    if (audioUrl) {
        window.open(audioUrl, '_blank');
    } else {
        alert('Audio URL not available');
    }
}

async function downloadTranscript(podcastId, title) {
    if (!podcastId) {
        if (currentGeneratedPodcast) {
            podcastId = currentGeneratedPodcast.id;
            title = currentGeneratedPodcast.title;
        }
    }
    try {
        const response = await fetch(`/api/podcast/${podcastId}/transcript`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Get the blob from the response
        const blob = await response.blob();
        
        // Create a URL for the blob
        const url = window.URL.createObjectURL(blob);
        
        // Create a temporary link and click it
        const a = document.createElement('a');
        a.href = url;
        a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_transcript.txt`;
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error downloading transcript:', error);
        alert('Error downloading transcript. Please try again.');
    }
}

function deletePodcast(podcastId) {
    if (confirm('Are you sure you want to delete this podcast?')) {
        fetch(`/api/podcast/${podcastId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert('Podcast deleted successfully');
                loadPastPodcasts();
            } else {
                console.error('Error deleting podcast');
                alert('Error deleting podcast. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error deleting podcast:', error);
            alert('Error deleting podcast. Please try again.');
        });
    }
}

// Handle script generation
document.getElementById('generateScript').addEventListener('click', async () => {
    const podcastName = document.getElementById('podcastName').value;
    const episodeTitle = document.getElementById('episodeTitle').value;
    const model = document.getElementById('llmModel').value;
    const mode = document.getElementById('ttsMode').value;
    let guestTitle = document.getElementById('guestTitle').value;
    if (guestTitle === 'custom') guestTitle = document.getElementById('guestTitleCustom').value;
    const guestName = document.getElementById('guestName').value;
    const hostName = document.getElementById('hostName').value;
    const duration = document.getElementById('ttsDuration').value;
    const selectedArticles = Object.values(selectedArticleData);

    if (!podcastName || !episodeTitle) {
        alert('Please enter both podcast name and episode title');
        return;
    }

    if (selectedArticles.length === 0) {
        alert('Please select at least one article');
        return;
    }

    // For conversation mode ensure guest name present; for bulletin ignore
    if (mode === 'conversation' && !guestName) {
        alert('Please enter a guest name');
        return;
    }

    try {
        const response = await fetch('/api/generate_podcast_script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                podcast_name: podcastName,
                episode_title: episodeTitle,
                model,
                mode,
                duration,
                host_name: hostName,
                guest_title: mode === 'conversation' ? guestTitle : null,
                guest_name: mode === 'conversation' ? guestName : null,
                articles: selectedArticles
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (editor) {
            editor.setValue(data.script);
        } else {
            console.error('Editor not initialized');
            alert('Editor not initialized. Please refresh the page and try again.');
        }
    } catch (error) {
        console.error('Error generating script:', error);
        alert('Error generating script. Please try again.');
    }
});

// Handle TTS podcast generation
document.getElementById('ttsForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!editor) {
        alert('Editor not initialized. Please refresh the page and try again.');
        return;
    }

    const script = editor.getValue();
    if (!script) {
        alert('Please generate or enter a script first');
        return;
    }

    const guestName = document.getElementById('guestName').value;
    // Mode check for guest name
    const mode = document.getElementById('ttsMode').value;
    if (mode === 'conversation' && !guestName) {
        alert('Please enter a guest name for conversation mode');
        return;
    }
    
    const selectedTopic = document.getElementById('topicSelect').value; // Get selected topic

    const formData = {
        podcast_name: document.getElementById('podcastName').value,
        episode_title: document.getElementById('episodeTitle').value,
        script: script,
        host_voice_id: document.getElementById('ttsHostVoice').value,
        guest_voice_id: mode === 'conversation' ? document.getElementById('ttsGuestVoice').value : null,
        guest_title: (() => { const val=document.getElementById('guestTitle').value; return val==='custom'?document.getElementById('guestTitleCustom').value:val; })(),
        guest_name: mode === 'conversation' ? guestName : null, // Only send if conversation
        model_id: "eleven_multilingual_v2",
        output_format: "mp3_44100_128",
        voice_settings: {
            stability: 0.5,
            similarity_boost: 0.75,
            style: 0.0,
            use_speaker_boost: true,
            speed: parseFloat(document.getElementById('voiceSpeed').value || '1')
        },
        model: document.getElementById('llmModel').value, // This was duplicated, ensure it refers to LLM model for script if needed
        duration: document.getElementById('ttsDuration').value, // Added duration for TTS podcast request
        mode: mode, // Added mode for TTS podcast request
        topic: selectedTopic || null, // Add the selected topic to the payload
        // article_uris: selectedArticles // article_uris are part of TTSPodcastRequest if script is not provided, not directly used if script is present
    };

    try {
        // Show progress section
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        progressSection.style.display = 'block';
        resultSection.style.display = 'none';

        // Generate TTS podcast
        const response = await fetch('/api/generate_tts_podcast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        // Start polling for status
        pollPodcastStatus(result.podcast_id);
    } catch (error) {
        console.error('Error generating TTS podcast:', error);
        document.getElementById('progressStatus').innerHTML = `
            <div class="alert alert-danger">
                Error generating podcast: ${error.message}
            </div>
        `;
    }
});

// Toggle guest voice visibility for TTS section
function toggleTTSGuestVoice() {
    const mode = document.getElementById('ttsMode').value;
    document.getElementById('ttsGuestVoiceSection').style.display = mode === 'conversation' ? 'block' : 'none';

    // Also toggle guest title & name inputs
    const guestTitleField = document.getElementById('guestTitle').parentElement;
    const guestNameField = document.getElementById('guestName').parentElement;
    guestTitleField.style.display = mode === 'conversation' ? 'block' : 'none';
    guestNameField.style.display = mode === 'conversation' ? 'block' : 'none';
}

// Settings defaults helpers
async function loadDefaults() {
    const mode = document.getElementById('ttsMode').value;
    try {
        const res = await fetch(`/api/podcast_settings/${mode}`);
        if (!res.ok) return;
        const data = await res.json();
        if (data.host_voice_id) document.getElementById('ttsHostVoice').value = data.host_voice_id;
        if (data.guest_voice_id) document.getElementById('ttsGuestVoice').value = data.guest_voice_id;
        if (data.host_name) document.getElementById('hostName').value = data.host_name;
        if (data.guest_name) document.getElementById('guestName').value = data.guest_name;
        if (data.model) document.getElementById('llmModel').value = data.model;
        if (data.podcast_name) document.getElementById('podcastName').value = data.podcast_name;
        if (data.episode_title) document.getElementById('episodeTitle').value = data.episode_title;
        if (data.duration) document.getElementById('ttsDuration').value = data.duration;
        if (data.voice_speed) document.getElementById('voiceSpeed').value = data.voice_speed;
    } catch (err) { console.error('Error loading defaults', err); }
}

document.getElementById('saveDefaultsBtn').addEventListener('click', async () => {
    const mode = document.getElementById('ttsMode').value;
    const payload = {
        settings: {
            host_voice_id: document.getElementById('ttsHostVoice').value,
            guest_voice_id: document.getElementById('ttsGuestVoice').value,
            host_name: document.getElementById('hostName').value,
            guest_name: document.getElementById('guestName').value,
            model: document.getElementById('llmModel').value,
            podcast_name: document.getElementById('podcastName').value,
            episode_title: document.getElementById('episodeTitle').value,
            duration: document.getElementById('ttsDuration').value,
            voice_speed: parseFloat(document.getElementById('voiceSpeed').value || '1')
        }
    };
    try {
        await fetch(`/api/podcast_settings/${mode}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        alert('Defaults saved');
    } catch (err) { console.error('Error saving defaults', err); alert('Error saving defaults'); }
});

// load on page‑ready after voices/models fetched
loadDefaults();

function toggleCustomTitle() {
    const sel = document.getElementById('guestTitle');
    const customInput = document.getElementById('guestTitleCustom');
    customInput.style.display = sel.value === 'custom' ? 'block' : 'none';
}

// ----------------- Dia TTS config tab -----------------
function loadDiaConfig() {
    fetch('/config/dia')
        .then(r => r.json())
        .then(data => {
            if (data.configured) {
                document.getElementById('diaApiKey').value = '********';
                document.getElementById('diaApiUrl').value = data.url || '';
                document.getElementById('diaConfigStatus').innerHTML = '<span class="text-success">Configured</span>';
            } else {
                document.getElementById('diaConfigStatus').innerHTML = '<span class="text-danger">Not configured</span>';
            }
        })
        .catch(err => console.error('Failed loading Dia config', err));
}

document.getElementById('diaConfigForm').addEventListener('submit', async e => {
    e.preventDefault();
    const payload = {
        api_key: document.getElementById('diaApiKey').value.trim(),
        url: document.getElementById('diaApiUrl').value.trim()
    };
    try {
        const res = await fetch('/config/dia', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Save failed');
        alert('Dia configuration saved');
        loadDiaConfig();
    } catch (err) {
        console.error(err); alert('Error saving Dia configuration');
    }
});

document.getElementById('diaDeleteBtn').addEventListener('click', async () => {
    if (!confirm('Remove Dia configuration?')) return;
    try {
        const res = await fetch('/config/dia', {method:'DELETE'});
        if (!res.ok) throw new Error('Delete failed');
        alert('Dia configuration removed');
        document.getElementById('diaApiKey').value = '';
        document.getElementById('diaApiUrl').value = '';
        loadDiaConfig();
    } catch (err) {
        console.error(err); alert('Error removing configuration');
    }
});

// Load on startup
loadDiaConfig();

// Add helper functions for bias and factual rating classifications
function getBiasClass(bias) {
    if (!bias) return '';
    
    bias = bias.toLowerCase();
    
    if (bias.includes('left') && !bias.includes('center')) {
        return 'bias-left';
    } else if (bias.includes('left-center')) {
        return 'bias-left-center';
    } else if (bias.includes('least biased')) {
        return 'bias-least-biased';
    } else if (bias.includes('center')) {
        return 'bias-center';
    } else if (bias.includes('right-center')) {
        return 'bias-right-center';
    } else if (bias.includes('right')) {
        return 'bias-right';
    } else if (bias.includes('pro-science')) {
        return 'bias-pro-science';
    } else if (bias.includes('conspiracy') || bias.includes('pseudo')) {
        return 'bias-conspiracy-pseudoscience';
    } else if (bias.includes('questionable')) {
        return 'bias-questionable';
    } else if (bias.includes('satire')) {
        return 'bias-satire';
    }
    
    return '';
}

function getFactualClass(factual) {
    if (!factual) return '';
    
    factual = factual.toLowerCase();
    
    if (factual.includes('very high')) {
        return 'factual-very-high';
    } else if (factual.includes('high') && !factual.includes('very')) {
        return 'factual-high';
    } else if (factual.includes('mostly')) {
        return 'factual-mostly-factual';
    } else if (factual.includes('mixed')) {
        return 'factual-mixed';
    } else if (factual.includes('low') && !factual.includes('very')) {
        return 'factual-low';
    } else if (factual.includes('very low')) {
        return 'factual-very-low';
    }
    
    return '';
}

// Check if at least one TTS provider (ElevenLabs or Dia) is configured
async function checkTtsKeysConfigured() {
    try {
        const [eleRes, diaRes] = await Promise.all([
            fetch('/config/elevenlabs'),
            fetch('/config/dia')
        ]);
        const eleOk = eleRes.ok && (await eleRes.json()).configured;
        const diaOk = diaRes.ok && (await diaRes.json()).configured;
        if (!eleOk && !diaOk) {
            document.getElementById('ttsKeyAlert').style.display = 'block';
        }
    } catch (err) {
        console.error('Error checking TTS keys', err);
    }
}

// Run check once DOM is fully loaded
document.addEventListener('DOMContentLoaded', checkTtsKeysConfigured);
</script>

<style>
.article-list-container {
    max-height: 600px;
    overflow-y: auto;
}

.article-item {
    transition: background-color 0.2s;
}

.article-item:hover {
    background-color: var(--colors-neutral-2);
}

.select2-container {
    width: 100% !important;
}

.progress {
    height: 20px;
}

#transcript {
    max-height: 300px;
    overflow-y: auto;
}

.list-group-item {
    transition: background-color 0.2s;
}

.list-group-item:hover {
    background-color: var(--colors-neutral-2);
}

.btn-group .btn {
    margin-left: 5px;
}

#noPodcasts {
    padding: 20px;
}
</style>
{% endblock %}
