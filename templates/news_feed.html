{% extends 'base.html' %}
{% block title %}Daily News Feed{% endblock %}

{% block content %}
<style>
/* Techmeme-inspired minimalist design */
.news-feed-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}

.news-header {
    border-bottom: 3px solid #000;
    margin-bottom: 30px;
    padding-bottom: 15px;
}

.news-title {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0;
    color: #000;
}

.news-date {
    font-size: 0.9rem;
    color: #666;
    margin-top: 5px;
}

.news-nav {
    margin: 20px 0;
    border-bottom: 1px solid #ddd;
}

.nav-tabs {
    border-bottom: none;
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #666;
    font-weight: 500;
    padding: 10px 20px;
    background: none;
}

.nav-tabs .nav-link.active {
    border-bottom-color: #000;
    color: #000;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #999;
    color: #333;
}

.story-item {
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 1px solid #eee;
}

.story-item:last-child {
    border-bottom: none;
}

.story-headline {
    font-size: 1.4rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 10px;
    color: #000;
}

.story-headline a {
    color: inherit;
    text-decoration: none;
}

.story-headline a:hover {
    color: #0066cc;
}

.story-summary {
    font-size: 1rem;
    color: #333;
    margin-bottom: 15px;
}

.story-meta {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 10px;
}

.source-info {
    display: inline-block;
    margin-right: 15px;
}

.bias-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 5px;
}

.bias-left { background: #e3f2fd; color: #1976d2; }
.bias-left-center { background: #e8f5e8; color: #388e3c; }
.bias-center { background: #f3e5f5; color: #7b1fa2; }
.bias-right-center { background: #fff3e0; color: #f57c00; }
.bias-right { background: #ffebee; color: #d32f2f; }
.bias-mixed { background: #f5f5f5; color: #616161; }

.factuality-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 5px;
}

.factuality-very-high { background: #e8f5e8; color: #2e7d32; }
.factuality-high { background: #e8f5e8; color: #388e3c; }
.factuality-mostly-factual { background: #f3e5f5; color: #7b1fa2; }
.factuality-mixed { background: #fff3e0; color: #f57c00; }
.factuality-low { background: #ffebee; color: #d32f2f; }

.related-articles {
    margin-top: 15px;
    padding-left: 20px;
    border-left: 3px solid #eee;
}

.related-articles h6 {
    font-size: 0.85rem;
    font-weight: 600;
    color: #666;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.related-item {
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.related-item a {
    color: #0066cc;
    text-decoration: none;
}

.related-item a:hover {
    text-decoration: underline;
}

.controls {
    background: var(--bs-light);
    padding: 1rem;
    border-radius: var(--bs-border-radius);
    margin-bottom: 2rem;
}

.controls-row {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.control-group-inline {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.control-group-inline label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--bs-dark);
    margin: 0;
    white-space: nowrap;
}

.selected-date-compact {
    font-size: 0.9rem;
    color: var(--bs-primary);
    margin-right: 0.5rem;
}

/* Bootstrap-based Calendar Styles */
#calendar-container {
    max-width: 400px;
    width: 100%;
    margin-top: 8px;
}

#calendar-view {
    max-width: 100%;
}

.calendar-month {
    margin-bottom: 1rem;
}

.calendar-month-header {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--bs-dark);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--bs-border-color);
    text-align: center;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 0.5rem;
    width: 100%;
    max-width: 350px;
}

.calendar-day-header {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--bs-secondary);
    padding: 0.25rem;
    background-color: var(--bs-light);
    border-radius: var(--bs-border-radius-sm);
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    border-radius: var(--bs-border-radius);
    cursor: default;
    position: relative;
    min-height: 32px;
    border: 1px solid transparent;
}

.calendar-day.has-articles {
    background-color: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
    cursor: pointer;
    font-weight: 600;
    border: 1px solid var(--bs-primary-border-subtle);
}

.calendar-day.has-articles:hover {
    background-color: var(--bs-primary);
    color: var(--bs-white);
    transform: scale(1.05);
    transition: all 0.15s ease-in-out;
}

.calendar-day.selected {
    background-color: var(--bs-primary) !important;
    color: var(--bs-white) !important;
    border-color: var(--bs-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

.calendar-day.other-month {
    color: var(--bs-secondary);
    opacity: 0.5;
}

.calendar-day.has-articles .badge {
    position: absolute;
    bottom: 1px;
    right: 1px;
    font-size: 0.6rem;
    padding: 0.1rem 0.25rem;
    line-height: 1;
}

.calendar-day.selected .badge {
    background-color: var(--bs-white) !important;
    color: var(--bs-primary) !important;
}

/* Old control-group styles removed - now using control-group-inline */

.form-select, .form-control {
    font-size: 0.9rem;
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.btn {
    font-size: 0.9rem;
    padding: 6px 12px;
    border-radius: 3px;
    font-weight: 500;
}

.btn-primary {
    background: #000;
    border-color: #000;
}

.btn-primary:hover {
    background: #333;
    border-color: #333;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.error-message {
    background: #ffebee;
    color: #c62828;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.executive-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 30px;
    border-left: 4px solid #000;
}

.key-themes {
    margin-bottom: 30px;
}

.key-themes h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: #000;
}

.theme-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.theme-tag {
    background: #e9ecef;
    color: #495057;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 500;
}

.perspective-breakdown {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
}

.perspective-breakdown h6 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: #000;
}

.perspective-item {
    margin-bottom: 8px;
    font-size: 0.85rem;
}

.perspective-label {
    font-weight: 600;
    text-transform: capitalize;
    margin-right: 8px;
}

@media (max-width: 768px) {
    .news-feed-container {
        padding: 15px;
    }
    
    .news-title {
        font-size: 1.8rem;
    }
    
    .story-headline {
        font-size: 1.2rem;
    }
    
    .controls-row {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .control-group-inline {
        justify-content: space-between;
        width: 100%;
    }
    
    .control-group-inline input,
    .control-group-inline select {
        width: auto !important;
        flex: 1;
        margin-left: 1rem;
    }
    }

    /* Add styles for metadata tags like topic_dashboard.html */
    .metadata-tag {
        display: inline-block;
        padding: 0.2em 0.6em;
        margin-right: 0.3em;
        margin-bottom: 0.3em;
        font-size: 0.75em;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        border: 1px solid transparent;
    }

    .tag-category {
        background-color: #e6f3ff;
        color: #0066cc;
        border-color: #99ccff;
    }

    .tag-driver {
        background-color: #fff0e6;
        color: #cc6600;
        border-color: #ffcc99;
    }

    .tag-tti {
        background-color: #f0f0ff;
        color: #4b0082;
        border-color: #c0c0ff;
    }

    .tag-sentiment {
        border-width: 1px;
        border-style: solid;
    }

    .sentiment-critical {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .sentiment-hyperbolic {
        background-color: #fffae6;
        color: #997a00;
        border-color: #ffe680;
    }

    .sentiment-mixed {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }

    .sentiment-positive { background-color: #d1e7dd; color: #0a5132; border: 1px solid #a3cfbb; }
    .sentiment-negative { background-color: #f8d7da; color: #842029; border: 1px solid #f1aeb5; }
    .sentiment-neutral { background-color: #e2e3e5; color: #41464b; border: 1px solid #c3c6ca; }
    .sentiment-unknown { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }

    /* Bias tags */
    .tag-bias-left {
        background-color: #e6f2ff;
        color: #0066cc;
        border-color: #99ccff;
    }

    .tag-bias-right {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .tag-bias-center {
        background-color: #f0f0ff;
        color: #4b0082;
        border-color: #c0c0ff;
    }

    .tag-bias-factual {
        background-color: #e6ffe6;
        color: #006600;
        border-color: #99ff99;
    }

    .tag-bias-unknown {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }

    /* Factual reporting tags */
    .tag-factual-high {
        background-color: #e6ffe6;
        color: #006600;
        border-color: #99ff99;
    }

    .tag-factual-mostly {
        background-color: #f0fff0;
        color: #228b22;
        border-color: #90ee90;
    }

    .tag-factual-mixed {
        background-color: #fffae6;
        color: #997a00;
        border-color: #ffe680;
    }

    .tag-factual-low {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .tag-factual-unknown {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }
</style>

<div class="news-feed-container">
    <!-- Header -->
    <div class="news-header">
        <h1 class="news-title">Daily News Feed</h1>
        <div class="news-date" id="current-date"></div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
                <i class="fas fa-cogs me-2"></i>Feed Configuration
            </h6>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleControlsBtn" onclick="toggleControlsPanel()">
                <i class="fas fa-chevron-up" id="controlsToggleIcon"></i>
            </button>
        </div>
        <div id="controlsContent">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Date Range:</label>
                            <select id="date-range-select" class="form-select form-select-sm" onchange="handleDateRangeChange()">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                                <option value="3m" selected>Last 90 Days</option>
                    <option value="1y">Last Year</option>
                    <option value="all">All Time</option>
                    <option value="custom">Custom Date</option>
                </select>
            </div>
                        <div class="col-6">
                            <label class="form-label small">Topic:</label>
                            <select id="topic-select" class="form-select form-select-sm">
                                <option value="">All Topics</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div id="date-range-display" class="small text-muted">
                            <i class="fas fa-clock"></i> <strong id="date-range-text">Last 90 Days</strong> 
                    (<span id="selected-date-count">loading...</span> articles)
                </div>
                <div id="custom-date-section" style="display: none;" class="mt-1">
                            <input type="date" id="custom-date-input" class="form-control form-control-sm" value="2025-09-15">
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-1" data-bs-toggle="collapse" data-bs-target="#calendar-collapse">
                        <i class="fas fa-calendar-alt"></i>
                </button>
                </div>
            </div>
            </div>
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Model:</label>
                            <select id="model-select" class="form-select form-select-sm">
                    <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                    <option value="gpt-4.1">GPT-4.1</option>
                    <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                    <option value="claude-4-sonnet-latest">Claude 4 Sonnet</option>
                    <option value="claude-3-5-sonnet-latest">Claude 3.5 Sonnet</option>
                    <option value="gemini-pro">Gemini Pro</option>
                </select>
            </div>
                        <div class="col-6">
                            <label class="form-label small">Profile:</label>
                            <div class="d-flex gap-1">
                                <select id="profile-select" class="form-select form-select-sm">
                                    <option value="">General Analysis</option>
                    </select>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadOrganizationalProfiles()" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                </div>
            </div>
                    <div class="mt-2">
                        
                    <div class="mt-2 d-flex gap-2">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="saveCurrentAsDefaults()" title="Save current settings as defaults">
                            <i class="fas fa-star"></i> Save Defaults
                </button>
                        <button id="restore-articles-btn" class="btn btn-outline-warning btn-sm" onclick="clearExcludedArticles()" style="display: none;" title="Restore hidden articles">
                    <i class="fas fa-undo"></i> Restore Hidden
                </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Collapsible Calendar -->
        <div class="collapse mt-3" id="calendar-collapse">
            <div class="card" style="max-width: 400px;">
                <div class="card-body">
                    <div id="calendar-loading" class="text-center text-muted p-3">
                        <i class="fas fa-spinner fa-spin"></i> Loading available dates...
                    </div>
                    <div id="calendar-view" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <input type="hidden" id="selected-date" value="2025-09-15" />
    </div>

    <!-- Navigation -->
    <div class="news-nav">
        <ul class="nav nav-tabs" id="news-tabs">
            <li class="nav-item">
                <a class="nav-link active" id="articles-tab" data-bs-toggle="tab" href="#articles-content">Articles</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="six-articles-tab" data-bs-toggle="tab" href="#six-articles-content">Six Articles</a>
            </li>
        </ul>
    </div>

    <!-- Content -->
    <div class="tab-content" id="news-content">
        <!-- Articles Tab -->
        <div class="tab-pane fade show active" id="articles-content">
            <div id="articles-loading" class="loading" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Loading articles...</div>
            </div>
            <div id="articles-error" class="error-message" style="display: none;"></div>
            
            <!-- Filter Section -->
            <div id="articles-filters" class="mb-3" style="display: none;">
                <div class="d-flex flex-wrap gap-2 align-items-center p-2 bg-light rounded">
                    <span class="text-muted small fw-bold">Filters:</span>
                    <div id="bias-filters" class="d-flex flex-wrap gap-1"></div>
                    <div id="factuality-filters" class="d-flex flex-wrap gap-1"></div>
                    <div id="category-filters" class="d-flex flex-wrap gap-1"></div>
                    <div class="d-flex align-items-center gap-2 ms-auto">
                        <label class="form-label small mb-0">Sort:</label>
                        <select id="sort-select" class="form-select form-select-sm" onchange="handleSortChange()">
                            <option value="date_asc">Date (Oldest First)</option>
                            <option value="date_desc">Date (Newest First)</option>
                            <option value="category_date">Category (by Date)</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center" style="min-width: 240px;">
                        <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Search titles, summaries, keywords..." onkeyup="handleSearchInput()">
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="improveQuality()" title="Filter to high-quality sources only">
                        <i class="fas fa-shield-alt"></i> Factual Only
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()" title="Clear all filters">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            
            <div id="articles-list"></div>
            
            <!-- Pagination Controls -->
            <div id="pagination-container" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                <div class="pagination-info">
                    <small class="text-muted">
                        Showing <span id="articles-start">1</span>-<span id="articles-end">25</span> of <span id="articles-total">0</span> articles
                    </small>
                </div>
                <div class="pagination-controls">
                    <button id="prev-page-btn" class="btn btn-outline-secondary btn-sm me-2" onclick="previousPage()" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span class="mx-2">
                        Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                    </span>
                    <button id="next-page-btn" class="btn btn-outline-secondary btn-sm ms-2" onclick="nextPage()" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Six Articles Tab -->
        <div class="tab-pane fade" id="six-articles-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">AI-Generated Six Articles</h5>
                <button id="generate-btn" class="btn btn-primary" onclick="generateNewsFeed()">
                    <i class="fas fa-magic me-2"></i>Generate Six Articles
                </button>
            </div>
            <div id="six-articles-loading" class="loading" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Analyzing top articles...</div>
            </div>
            <div id="six-articles-error" class="error-message" style="display: none;"></div>
            <div id="six-articles-report"></div>
        </div>
    </div>
</div>

<!-- Save Feed Modal -->
<div class="modal fade" id="saveFeedModal" tabindex="-1" aria-labelledby="saveFeedModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveFeedModalLabel">Save News Feed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Save this news feed for later viewing:</p>
                <div class="mb-3">
                    <label for="feedNameInput" class="form-label">Feed Name:</label>
                    <input type="text" class="form-control" id="feedNameInput" placeholder="e.g., AI News Sept 12, 2025">
                </div>
                <div class="mb-3">
                    <label for="feedDescriptionInput" class="form-label">Description (optional):</label>
                    <textarea class="form-control" id="feedDescriptionInput" rows="3" placeholder="Brief description of this feed..."></textarea>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeArticles" checked>
                    <label class="form-check-label" for="includeArticles">
                        Include article list
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeSixArticles" checked>
                    <label class="form-check-label" for="includeSixArticles">
                        Include six articles analysis
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFeedBtn">Save Feed</button>
            </div>
        </div>
    </div>
</div>

<!-- Saved Feeds Modal -->
<div class="modal fade" id="savedFeedsModal" tabindex="-1" aria-labelledby="savedFeedsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savedFeedsModalLabel">Saved News Feeds</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="savedFeedsList">
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-bookmark fa-2x mb-3"></i>
                        <p>No saved feeds yet.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-danger" id="clearAllFeeds">Clear All</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize with the selected date (September 15, 2025)
    const selectedDateObj = new Date(2025, 8, 15); // September 15, 2025
    document.getElementById('current-date').textContent = selectedDateObj.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    // Persist selected model between sessions
    try {
        const savedModel = localStorage.getItem('newsFeedDefaultModel');
        if (savedModel) {
            const modelSelect = document.getElementById('model-select');
            if (modelSelect && Array.from(modelSelect.options).some(o => o.value === savedModel)) {
                modelSelect.value = savedModel;
            }
        }
        const modelSelectEl = document.getElementById('model-select');
        if (modelSelectEl) {
            modelSelectEl.addEventListener('change', () => {
                localStorage.setItem('newsFeedDefaultModel', modelSelectEl.value);
            });
        }
    } catch (_) { /* best-effort */ }

    // Profile persistence is now handled in loadOrganizationalProfiles() after profiles are loaded

    // Default to last 90 days
    try {
        const dr = document.getElementById('date-range-select');
        if (dr) {
            dr.value = '3m';
            document.getElementById('date-range-text').textContent = 'Last 90 Days';
            handleDateRangeChange();
        }
    } catch (_) { /* best-effort */ }

    // Generate button is now in Six Articles tab - event listener added there

    // Tab change handlers
    document.getElementById('articles-tab').addEventListener('click', function() {
        // Always auto-load fresh articles when Articles tab is clicked
        autoLoadArticles();
    });

    document.getElementById('six-articles-tab').addEventListener('click', function() {
        if (!document.getElementById('six-articles-report').innerHTML.trim()) {
            loadSixArticles();
        }
    });

    // Don't auto-load articles to prevent freeze - user can click Generate Feed
    console.log('Initial article loading disabled to prevent freeze');
    
    // Show a helpful message in the articles area
    const articlesContainer = document.getElementById('articles-list');
    if (articlesContainer) {
        articlesContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Ready to Generate News Feed</h5>
                <p class="text-muted">Click "Generate Feed" to load articles for the selected date.</p>
            </div>
        `;
    }
    
    // Show a helpful message in the six articles area too
    const sixArticlesContainer = document.getElementById('six-articles-report');
    if (sixArticlesContainer) {
        sixArticlesContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-star fa-3x text-muted mb-3"></i>
                <h5>Six Articles Analysis</h5>
                <p class="text-muted">Generate a feed first, then click this tab to see the strategic analysis.</p>
            </div>
        `;
    }
    
    // Populate topics dropdown and wire change handlers
    try {
        const sel = document.getElementById('topic-select');
        if (sel) {
            fetch('/api/topics')
                .then(r => r.json())
                .then(topics => {
                    sel.innerHTML = '<option value="">All Topics</option>' + topics.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
                    const savedTopic = localStorage.getItem('newsFeedTopic');
                    if (savedTopic && Array.from(sel.options).some(o => o.value === savedTopic)) sel.value = savedTopic;
                })
                .catch(() => {});
            sel.addEventListener('change', () => {
                localStorage.setItem('newsFeedTopic', sel.value);
                updateArticleCountForDateRange();
                generateNewsFeed();
            });
        }
    } catch (_) { /* best-effort */ }

    // Load saved feeds when modal is opened
    document.getElementById('savedFeedsModal').addEventListener('show.bs.modal', loadSavedFeeds);
    
    // Clear all feeds functionality
    document.getElementById('clearAllFeeds').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all saved feeds?')) {
            localStorage.removeItem('savedNewsFeeds');
            loadSavedFeeds();
        }
    });
    
    // Save feed functionality
    document.getElementById('saveFeedBtn').addEventListener('click', saveFeedFromModal);
});

function loadSavedFeeds() {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const container = document.getElementById('savedFeedsList');
    
    if (savedFeeds.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-bookmark fa-2x mb-3"></i>
                <p>No saved feeds yet.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    savedFeeds.forEach(feed => {
        const createdDate = new Date(feed.created).toLocaleDateString();
        const createdTime = new Date(feed.created).toLocaleTimeString();
        
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${escapeHTML(feed.name)}</h6>
                            ${feed.description ? `<p class="card-text small mb-2">${escapeHTML(feed.description)}</p>` : ''}
                            <p class="card-text small text-muted mb-2">
                                <i class="fas fa-calendar me-1"></i>Feed Date: ${feed.date}
                                ${feed.topic ? `<span class="ms-2"><i class="fas fa-tag me-1"></i>Topic: ${escapeHTML(feed.topic)}</span>` : ''}
                            </p>
                            <p class="card-text small text-muted mb-0">
                                <i class="fas fa-clock me-1"></i>Saved: ${createdDate} ${createdTime}
                                <span class="ms-2">
                                    ${feed.includeArticles ? '<i class="fas fa-list me-1"></i>Articles' : ''}
                                    ${feed.includeSixArticles ? '<i class="fas fa-star me-1 ms-2"></i>Analysis' : ''}
                                </span>
                            </p>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-3">
                            <button class="btn btn-outline-primary" onclick="loadSavedFeed(${feed.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-outline-success" onclick="exportSavedFeed(${feed.id})">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteSavedFeed(${feed.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function deleteSavedFeed(feedId) {
    if (confirm('Are you sure you want to delete this saved feed?')) {
        const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
        const filteredFeeds = savedFeeds.filter(feed => feed.id !== feedId);
        localStorage.setItem('savedNewsFeeds', JSON.stringify(filteredFeeds));
        loadSavedFeeds();
    }
}

function saveFeed() {
    // Open the save modal
    const saveModal = new bootstrap.Modal(document.getElementById('saveFeedModal'));
    
    // Pre-fill the name with date range and topic
    const dateRange = document.getElementById('date-range-select').value;
    const topic = document.getElementById('topic-input').value.trim();
    
    let formattedDate;
    if (dateRange === 'custom') {
        const customDate = document.getElementById('custom-date-input').value;
        if (customDate) {
            const dateObj = new Date(customDate);
            formattedDate = dateObj.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        } else {
            formattedDate = 'Custom Date';
        }
    } else {
        // Use the display text for date ranges
        const displayText = document.getElementById('date-range-text').textContent;
        formattedDate = displayText;
    }
    
    const defaultName = topic ? `${topic} - ${formattedDate}` : `News Feed - ${formattedDate}`;
    document.getElementById('feedNameInput').value = defaultName;
    
    saveModal.show();
}

function saveFeedFromModal() {
    const feedName = document.getElementById('feedNameInput').value.trim();
    const feedDescription = document.getElementById('feedDescriptionInput').value.trim();
    const includeArticles = document.getElementById('includeArticles').checked;
    const includeSixArticles = document.getElementById('includeSixArticles').checked;
    
    if (!feedName) {
        alert('Please enter a feed name');
        return;
    }
    
    if (!includeArticles && !includeSixArticles) {
        alert('Please select at least one content type to save');
        return;
    }
    
    // Collect current feed data
    const dateRange = document.getElementById('date-range-select').value;
    const selectedDate = dateRange === 'custom' ? 
        document.getElementById('custom-date-input').value || document.getElementById('selected-date').value :
        dateRange;
    const topic = document.getElementById('topic-input').value.trim();
    const model = document.getElementById('model-select').value;
    
    // Get articles data if requested
    let articlesData = null;
    if (includeArticles) {
        const articleElements = document.querySelectorAll('#articles-list .list-group-item');
        articlesData = Array.from(articleElements).map(element => {
            const title = element.querySelector('h6 a')?.textContent || 'Untitled';
            const url = element.querySelector('h6 a')?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summary = element.querySelector('.small')?.textContent || '';
            
            return { title, url, source, summary };
        });
    }
    
    // Get six articles data if requested
    let sixArticlesData = null;
    if (includeSixArticles) {
        const sixArticlesContainer = document.getElementById('six-articles-report');
        if (sixArticlesContainer && sixArticlesContainer.innerHTML.trim()) {
            const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
            sixArticlesData = Array.from(articles).map(article => {
                const title = article.querySelector('h4')?.textContent || 'Article';
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown';
                const sections = Array.from(article.querySelectorAll('.section')).map(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    return { title: sectionTitle, content: sectionContent };
                });
                return { title, source, sections };
            });
        }
    }
    
    // Create feed object
    const feedData = {
        id: Date.now(),
        name: feedName,
        description: feedDescription,
        date: selectedDate,
        date_range: dateRange,
        topic: topic,
        model: model,
        includeArticles: includeArticles,
        includeSixArticles: includeSixArticles,
        articlesData: articlesData,
        sixArticlesData: sixArticlesData,
        created: new Date().toISOString()
    };
    
    // Save to localStorage
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    savedFeeds.unshift(feedData);
    localStorage.setItem('savedNewsFeeds', JSON.stringify(savedFeeds));
    
    // Close modal and show success
    const saveModal = bootstrap.Modal.getInstance(document.getElementById('saveFeedModal'));
    saveModal.hide();
    
    showNotification(`Feed "${feedName}" saved successfully!`, 'success');
}

function loadSavedFeed(feedId) {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const feed = savedFeeds.find(f => f.id === feedId);
    
    if (!feed) {
        showNotification('Feed not found', 'danger');
        return;
    }
    
    // Set the date range and other parameters
    if (feed.date_range) {
        document.getElementById('date-range-select').value = feed.date_range;
        handleDateRangeChange(); // Update display
    } else {
        // Legacy feed - treat as custom date
        document.getElementById('date-range-select').value = 'custom';
        document.getElementById('custom-date-input').value = feed.date;
        document.getElementById('selected-date').value = feed.date;
        handleDateRangeChange();
    }
    
    if (feed.topic) document.getElementById('topic-input').value = feed.topic;
    document.getElementById('model-select').value = feed.model;
    
    // Load the saved data
    if (feed.includeArticles && feed.articlesData) {
        // Render saved articles
        renderSavedArticles(feed.articlesData);
    }
    
    if (feed.includeSixArticles && feed.sixArticlesData) {
        // Render saved six articles
        renderSavedSixArticles(feed.sixArticlesData);
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('savedFeedsModal'));
    modal.hide();
    
    showNotification(`Loaded feed: ${feed.name}`, 'success');
}

function exportSavedFeed(feedId) {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const feed = savedFeeds.find(f => f.id === feedId);
    
    if (!feed) {
        showNotification('Feed not found', 'danger');
        return;
    }
    
    // Generate markdown for saved feed
    let markdown = '';
    const dateObj = new Date(feed.date);
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Header
    markdown += `# ${feed.name}\n\n`;
    markdown += `**Date:** ${formattedDate}\n`;
    if (feed.topic) markdown += `**Topic:** ${feed.topic}\n`;
    if (feed.description) markdown += `**Description:** ${feed.description}\n`;
    markdown += `**Model:** ${feed.model}\n`;
    markdown += `**Saved:** ${new Date(feed.created).toLocaleString()}\n\n`;
    
    // Add six articles if included
    if (feed.includeSixArticles && feed.sixArticlesData) {
        markdown += `## Six Most Important Articles Analysis\n\n`;
        feed.sixArticlesData.forEach((article, index) => {
            markdown += `### ${index + 1}. ${article.title}\n\n`;
            markdown += `**Source:** ${article.source}\n\n`;
            
            article.sections.forEach(section => {
                if (section.title && section.content) {
                    markdown += `**${section.title}**\n\n${section.content}\n\n`;
                }
            });
            
            markdown += `---\n\n`;
        });
    }
    
    // Add articles if included
    if (feed.includeArticles && feed.articlesData) {
        markdown += `## Article List\n\n`;
        feed.articlesData.forEach((article, index) => {
            markdown += `### ${index + 1}. [${article.title}](${article.url})\n\n`;
            markdown += `**Source:** ${article.source}\n\n`;
            if (article.summary && article.summary.trim() !== 'No summary available.') {
                const cleanSummary = article.summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            markdown += `---\n\n`;
        });
    }
    
    downloadMarkdown(markdown, `${feed.name.replace(/[^a-zA-Z0-9]/g, '_')}_${feed.date}.md`);
}

function renderSavedArticles(articlesData) {
    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '';
    
    const articlesList = document.createElement('div');
    articlesList.className = 'list-group list-group-flush mt-2';
    
    articlesData.forEach(article => {
        const articleItem = document.createElement('div');
        articleItem.className = 'list-group-item';
        
        articleItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1"><a href="${article.url}" target="_blank" rel="noopener">${article.title}</a></h6>
                <small>Saved</small>
            </div>
            <p class="mb-1"><small class="text-muted">${article.source}</small></p>
            <p class="mb-1 small">${article.summary}</p>
        `;
        
        articlesList.appendChild(articleItem);
    });
    
    listContainer.appendChild(articlesList);
}

function renderSavedSixArticles(sixArticlesData) {
    const container = document.getElementById('six-articles-report');
    if (!container) return;
    
    let html = `
        <div class="six-articles-analysis">
            <h3>Strategic Analysis: Six Most Important Articles (Saved)</h3>
            <p class="mb-4">Previously saved analysis of the most important articles.</p>
        </div>
    `;
    
    sixArticlesData.forEach((article, index) => {
        html += `
            <div class="article-analysis mb-5 p-4 border rounded">
                <div class="article-header mb-3">
                    <h4 class="text-primary">${index + 1}. ${article.title}</h4>
                    <p class="text-muted mb-1"><strong>Source:</strong> ${article.source}</p>
                </div>
                <div class="article-content">
        `;
        
        article.sections.forEach(section => {
            if (section.title && section.content) {
                html += `
                    <div class="section mb-3">
                        <h6 class="text-secondary">${section.title}</h6>
                        <p>${section.content}</p>
                    </div>
                `;
            }
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Article exclusion functionality
let excludedArticles = new Set();
let currentArticlesPage = 1;

function excludeArticle(articleUri, buttonElement) {
    if (confirm('Remove this article from the current view?')) {
        // Add to excluded set
        excludedArticles.add(articleUri);
        
        // Find and hide the article element
        const articleElement = buttonElement.closest('.list-group-item');
        if (articleElement) {
            articleElement.style.transition = 'opacity 0.3s ease-out';
            articleElement.style.opacity = '0';
            setTimeout(() => {
                articleElement.remove();
                updateArticleCount();
                updateRestoreButton();
            }, 300);
        }
        
        // Show success message
        showNotification('Article removed from view', 'success');
    }
}

function updateRestoreButton() {
    const restoreBtn = document.getElementById('restore-articles-btn');
    if (restoreBtn) {
        if (excludedArticles.size > 0) {
            restoreBtn.style.display = 'inline-block';
            restoreBtn.innerHTML = `<i class="fas fa-undo"></i> Restore Hidden (${excludedArticles.size})`;
        } else {
            restoreBtn.style.display = 'none';
        }
    }
}

function updateArticleCount() {
    const remainingArticles = document.querySelectorAll('#articles-list .list-group-item').length;
    const countEl = document.getElementById('selected-date-count');
    if (countEl && remainingArticles > 0) {
        const originalText = countEl.textContent;
        const originalCount = parseInt(originalText) || 0;
        if (remainingArticles < originalCount) {
            countEl.textContent = `${remainingArticles} (${originalCount - remainingArticles} hidden)`;
        }
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) notification.remove();
    }, 3000);
}

function clearExcludedArticles() {
    if (excludedArticles.size > 0 && confirm(`Restore ${excludedArticles.size} hidden articles?`)) {
        excludedArticles.clear();
        updateRestoreButton();
        loadArticles(currentArticlesPage); // Reload current page
        showNotification('All articles restored', 'success');
    }
}

// Markdown export functionality
async function exportToMarkdown() {
    try {
    const selectedDate = document.getElementById('selected-date').value;
    const selectedModel = document.getElementById('model-select').value;
    const topic = document.getElementById('topic-input').value.trim();
    const profileId = document.getElementById('profile-select').value;
        
        // Get current tab to determine what to export
        const activeTab = document.querySelector('#news-tabs .nav-link.active');
        const isArticlesTab = activeTab.id === 'articles-tab';
        
        let markdown = '';
        const dateObj = new Date(selectedDate);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Header
        markdown += `# Daily News Feed\n\n`;
        markdown += `**Date:** ${formattedDate}\n`;
        if (topic) markdown += `**Topic Filter:** ${topic}\n`;
        markdown += `**Generated:** ${new Date().toLocaleString()}\n`;
        markdown += `**Model:** ${selectedModel}\n\n`;
        
        // Export both six articles and article list
        await exportCombinedContent(markdown);
        
    } catch (error) {
        console.error('Error exporting to markdown:', error);
        showNotification('Error exporting to markdown', 'danger');
    }
}

async function exportArticlesList(baseMarkdown) {
    let markdown = baseMarkdown;
    markdown += `## Article List\n\n`;
    
    // Get visible articles from the current view
    const articleElements = document.querySelectorAll('#articles-list .list-group-item');
    
    if (articleElements.length === 0) {
        markdown += `*No articles available.*\n\n`;
    } else {
        articleElements.forEach((element, index) => {
            const title = element.querySelector('h6 a')?.textContent || 'Untitled';
            const url = element.querySelector('h6 a')?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summary = element.querySelector('.small')?.textContent || '';
            
            markdown += `### ${index + 1}. [${title}](${url})\n\n`;
            markdown += `**Source:** ${source}\n\n`;
            
            if (summary && summary.trim() !== 'No summary available.') {
                const cleanSummary = summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            
            // Add metadata tags if visible
            const metadataTags = element.querySelectorAll('.metadata-tag');
            if (metadataTags.length > 0) {
                markdown += `**Tags:** `;
                const tags = Array.from(metadataTags).map(tag => tag.textContent.trim()).join(', ');
                markdown += `${tags}\n\n`;
            }
            
            markdown += `---\n\n`;
        });
    }
    
    downloadMarkdown(markdown, `news-articles-${document.getElementById('selected-date').value}.md`);
}

async function exportCombinedContent(baseMarkdown) {
    let markdown = baseMarkdown;
    
    // First, add six articles analysis if available
    const sixArticlesContainer = document.getElementById('six-articles-report');
    if (sixArticlesContainer && sixArticlesContainer.innerHTML.trim()) {
        const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
        
        if (articles.length > 0) {
            markdown += `## Six Most Important Articles Analysis\n\n`;
            
            articles.forEach((article, index) => {
                const title = article.querySelector('h4')?.textContent || `Article ${index + 1}`;
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown source';
                
                markdown += `### ${index + 1}. ${title}\n\n`;
                markdown += `**Source:** ${source}\n\n`;
                
                const sections = article.querySelectorAll('.section');
                sections.forEach(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    
                    if (sectionTitle && sectionContent) {
                        markdown += `**${sectionTitle}**\n\n${sectionContent}\n\n`;
                    }
                });
                
                // Get perspectives if available
                const perspectives = article.querySelector('.row');
                if (perspectives) {
                    markdown += `**Political & Ideological Perspectives:**\n\n`;
                    const cols = perspectives.querySelectorAll('.col-md-4');
                    cols.forEach(col => {
                        const perspectiveTitle = col.querySelector('strong')?.textContent || '';
                        const perspectiveContent = col.querySelector('p')?.textContent || '';
                        
                        if (perspectiveTitle && perspectiveContent) {
                            markdown += `- **${perspectiveTitle}** ${perspectiveContent}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n`;
            });
        }
    }
    
    // Then add the article list
    markdown += `## Article List\n\n`;
    
    const articleElements = document.querySelectorAll('#articles-list .list-group-item');
    
    if (articleElements.length === 0) {
        markdown += `*No articles available.*\n\n`;
    } else {
        articleElements.forEach((element, index) => {
            const titleElement = element.querySelector('h6 a');
            const title = titleElement?.textContent || 'Untitled';
            const url = titleElement?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summaryElement = element.querySelector('.small');
            const summary = summaryElement?.getAttribute('title') || summaryElement?.textContent || 'No summary available.';
            
            markdown += `### ${index + 1}. [${title}](${url})\n\n`;
            markdown += `**Source:** ${source}\n\n`;
            
            if (summary && summary.trim() !== 'No summary available.') {
                const cleanSummary = summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            
            markdown += `---\n\n`;
        });
    }
    
    const filename = `news-feed-complete-${document.getElementById('selected-date').value}.md`;
    downloadMarkdown(markdown, filename);
}

async function exportSixArticles(baseMarkdown) {
    let markdown = baseMarkdown;
    markdown += `## Six Most Important Articles Analysis\n\n`;
    
    // Get six articles data from the current view
    const sixArticlesContainer = document.getElementById('six-articles-report');
    
    if (!sixArticlesContainer || !sixArticlesContainer.innerHTML.trim()) {
        markdown += `*No six articles analysis available. Please generate the report first.*\n\n`;
    } else {
        const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
        
        if (articles.length === 0) {
            markdown += `*No articles found in the analysis.*\n\n`;
        } else {
            articles.forEach((article, index) => {
                const title = article.querySelector('h4')?.textContent || `Article ${index + 1}`;
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown';
                
                markdown += `### ${title}\n\n`;
                markdown += `**Source:** ${source}\n\n`;
                
                // Get sections
                const sections = article.querySelectorAll('.section');
                sections.forEach(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    
                    if (sectionTitle && sectionContent) {
                        markdown += `**${sectionTitle}**\n\n${sectionContent}\n\n`;
                    }
                });
                
                // Get perspectives if available
                const perspectives = article.querySelector('.row');
                if (perspectives) {
                    markdown += `**Political & Ideological Perspectives:**\n\n`;
                    const cols = perspectives.querySelectorAll('.col-md-4');
                    cols.forEach(col => {
                        const perspectiveTitle = col.querySelector('strong')?.textContent || '';
                        const perspectiveContent = col.querySelector('p')?.textContent || '';
                        
                        if (perspectiveTitle && perspectiveContent) {
                            markdown += `- **${perspectiveTitle}** ${perspectiveContent}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n`;
            });
        }
    }
    
    downloadMarkdown(markdown, `six-articles-${document.getElementById('selected-date').value}.md`);
}

function downloadMarkdown(content, filename) {
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification(`Exported as ${filename}`, 'success');
}

async function generateNewsFeed() {
    console.log('Generate button clicked');
    const selectedDate = document.getElementById('selected-date').value;
    const selectedModel = document.getElementById('model-select').value;
    console.log('Selected date:', selectedDate, 'Model:', selectedModel);
    
    // Clear existing content
    document.getElementById('articles-list').innerHTML = '';
    document.getElementById('six-articles-report').innerHTML = '';

    // Reset count indicator while loading
    const selectedDateCountEl = document.getElementById('selected-date-count');
    if (selectedDateCountEl) selectedDateCountEl.textContent = 'loading...';
    
    // Load both tabs
    await Promise.all([loadArticles(), loadSixArticles()]);
}

async function loadArticles(page = 1) {
    currentArticlesPage = page;
    const loadingEl = document.getElementById('articles-loading');
    const errorEl = document.getElementById('articles-error');
    const contentEl = document.getElementById('articles-list');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        // Use the news feed articles API
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            model: document.getElementById('model-select').value,
            page: page.toString(),
            per_page: '20'
        });
        
        // Only add date parameter for custom date selection
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            params.append('date', customDate);
        }

        const topic = document.getElementById('topic-select').value.trim();
        if (topic) {
            params.append('topic', topic);
        }
        
        const profileId = document.getElementById('profile-select').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }
        
        // Add starred articles if any
        if (starredArticles.size > 0) {
            params.append('starred_articles', Array.from(starredArticles).join(','));
        }

        console.log('Loading articles with params:', params.toString());
        const response = await fetch(`/api/news-feed/articles?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`No articles found: ${errorData.detail || 'No articles available for the selected date and criteria'}`);
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        // Update the selected-date count from response
        const selectedDateCountElSuccess = document.getElementById('selected-date-count');
        if (selectedDateCountElSuccess) {
            const total = (data && data.articles && typeof data.articles.total_items === 'number')
                ? data.articles.total_items
                : (data && data.articles && Array.isArray(data.articles.items))
                    ? data.articles.items.length
                    : 0;
            selectedDateCountElSuccess.textContent = String(total);
        }
        console.log('Articles data received:', data);
        console.log('Data.articles exists:', !!data.articles);
        console.log('Data.articles.items exists:', !!(data.articles && data.articles.items));
        console.log('Items count:', data.articles && data.articles.items ? data.articles.items.length : 'N/A');
        console.log('Sample article fields:', data.articles && data.articles.items && data.articles.items.length > 0 ? Object.keys(data.articles.items[0]) : 'No items');
        
        if (data.articles && data.articles.items && data.articles.items.length > 0) {
            console.log('First article sample:', data.articles.items[0]);
            window.lastArticlesData = data.articles; // Store for filtering
            renderArticles(data.articles);  // News feed API returns data.articles
            renderArticlesPagination(data.articles);
        } else {
            console.log('No articles found in response - showing friendly message');
            // Show friendly message instead of error
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
            errorEl.style.display = 'block';
            return; // Exit early, don't throw error
        }
        showSaveButton();

    } catch (error) {
        console.error('Error loading overview:', error);
        if (error.message.includes('404')) {
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
        } else {
            errorEl.textContent = `Error loading overview: ${error.message}`;
            errorEl.className = 'error-message'; // Keep error styling
        }
        // Ensure the selected-date count reflects zero on error
        const selectedDateCountElError = document.getElementById('selected-date-count');
        if (selectedDateCountElError) selectedDateCountElError.textContent = '0';
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

async function loadSixArticles() {
    const loadingEl = document.getElementById('six-articles-loading');
    const errorEl = document.getElementById('six-articles-error');
    const contentEl = document.getElementById('six-articles-report');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            model: document.getElementById('model-select').value,
            per_page: '20'
        });
        
        // Only add date parameter for custom date selection
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            params.append('date', customDate);
        }

        const topic = document.getElementById('topic-select').value.trim();
        if (topic) {
            params.append('topic', topic);
        }
        
        const profileId = document.getElementById('profile-select').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }
        
        // Add starred articles if any
        if (starredArticles.size > 0) {
            params.append('starred_articles', Array.from(starredArticles).join(','));
        }

        const response = await fetch(`/api/news-feed/six-articles?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`No articles found: ${errorData.detail || 'No articles available for the selected date and criteria'}`);
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Six articles response data:', data);
        // Stamp generated date at top of report
        const generatedAt = new Date().toLocaleString();
        const header = document.createElement('div');
        header.className = 'small text-muted mb-2';
        header.innerHTML = `<i class="far fa-clock me-1"></i>Generated: ${generatedAt}`;
        const container = document.getElementById('six-articles-report');
        if (container) container.prepend(header);
        console.log('Six articles array:', data.six_articles);
        if (data.six_articles && data.six_articles.length > 0) {
            console.log('First article related_articles:', data.six_articles[0].related_articles);
        }
        renderSixArticles(data.six_articles);
        showSaveButton();

    } catch (error) {
        console.error('Error loading six articles:', error);
        if (error.message.includes('404')) {
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
        } else {
            errorEl.textContent = `Error loading six articles: ${error.message}`;
            errorEl.className = 'error-message'; // Keep error styling
        }
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

// Helper function to escape HTML content for safe display
function escapeHTML(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str).replace(/[&<>"']/g, function (match) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        }[match];
    });
}

// Helper function to get bias CSS class
function getBiasClass(bias) {
    if (!bias) return 'tag-bias-unknown';
    const biasLower = bias.toLowerCase();
    if (biasLower.includes('left')) return 'tag-bias-left';
    if (biasLower.includes('right')) return 'tag-bias-right';
    if (biasLower.includes('center') || biasLower.includes('mixed')) return 'tag-bias-center';
    if (biasLower.includes('least') || biasLower.includes('factual')) return 'tag-bias-factual';
    return 'tag-bias-unknown';
}

// Helper function to get factual reporting CSS class
function getFactualClass(factual) {
    if (!factual) return 'tag-factual-unknown';
    const factualLower = factual.toLowerCase();
    if (factualLower.includes('high') || factualLower === 'very high') return 'tag-factual-high';
    if (factualLower.includes('mostly') || factualLower === 'mostly factual') return 'tag-factual-mostly';
    if (factualLower.includes('mixed')) return 'tag-factual-mixed';
    if (factualLower.includes('low')) return 'tag-factual-low';
    return 'tag-factual-unknown';
}

// Removed old renderArticles function - using new one with star and filter functionality

function renderPagination(totalPages, currentPage) {
    const paginationContainer = document.getElementById('articles-pagination');
    paginationContainer.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous Button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
    paginationContainer.appendChild(prevLi);

    // Page Number Buttons
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        paginationContainer.appendChild(pageLi);
    }

    // Next Button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
    paginationContainer.appendChild(nextLi);

    // Add click handlers
    paginationContainer.querySelectorAll('.page-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page);
            if (page && page !== currentPage) {
                loadArticles(page);
            }
        });
    });
}

function renderOverview(overview) {
    const contentEl = document.getElementById('overview-stories');
    
    let html = '';
    
    overview.top_stories.forEach((story, index) => {
        html += `
            <div class="story-item">
                <h2 class="story-headline">
                    <a href="${story.primary_article.uri}" target="_blank">${story.headline}</a>
                </h2>
                
                <div class="story-summary">${story.summary}</div>
                
                <div class="story-meta">
                    <span class="source-info">
                        ${story.primary_article.source.name}
                        ${getBiasBadge(story.primary_article.source.bias)}
                        ${getFactualityBadge(story.primary_article.source.factuality)}
                    </span>
                    ${story.primary_article.publication_date ? 
                        `<span class="publish-date">${new Date(story.primary_article.publication_date).toLocaleDateString()}</span>` : 
                        ''
                    }
                </div>
                
                ${story.topic_description ? 
                    `<div class="story-context"><strong>Why it matters:</strong> ${story.topic_description}</div>` : 
                    ''
                }
                
                ${story.related_articles.length > 0 ? `
                    <div class="related-articles">
                        <h6>More Coverage</h6>
                        ${story.related_articles.map(related => `
                            <div class="related-item">
                                <strong>${related.source}</strong>${getBiasBadge(related.bias)}: 
                                ${related.url ? `<a href="${related.url}" target="_blank">${related.title}</a>` : related.title}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    contentEl.innerHTML = html;
}

function renderSixArticles(articles) {
    const contentEl = document.getElementById('six-articles-report');
    
    console.log('renderSixArticles called with:', articles);
    console.log('Articles length:', articles ? articles.length : 'null/undefined');
    if (articles && articles.length > 0) {
        console.log('First article structure:', articles[0]);
        console.log('First article has related_articles:', !!articles[0].related_articles);
        if (articles[0].related_articles) {
            console.log('Related articles count:', articles[0].related_articles.length);
        }
    }
    
    if (!articles || articles.length === 0) {
        contentEl.innerHTML = '<div class="alert alert-info">No articles available for analysis.</div>';
        return;
    }
    
    let html = `
        <div class="six-articles-analysis">
            <h3>Strategic Analysis: Six Most Important Articles</h3>
            <p class="mb-4">Selected based on strategic relevance, novelty, credibility, and representativeness for AI-focused organizations.</p>
        </div>
    `;
    
    // Render each article
    articles.forEach((article, index) => {
        const isStarred = article.uri && starredArticles.has(article.uri);
        html += `
            <div class="article-analysis mb-5 p-4 border rounded">
                <div class="article-header mb-3">
                    <h4 class="text-primary">${index + 1}. ${article.title} ${isStarred ? '<span class="badge bg-warning text-dark ms-2">Starred</span>' : ''}</h4>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                    <p class="text-muted mb-1"><strong>Source:</strong> ${article.source}</p>
                    ${article.date ? `<p class="text-muted mb-0"><strong>Date:</strong> ${article.date}</p>` : ''}
                        </div>
                        <div class="text-end">
                            ${article.bias ? `<span class="badge ${getBiasClass(article.bias)} mb-1">${article.bias}</span><br>` : ''}
                            ${article.factual_reporting ? `<span class="badge ${getFactualityClass(article.factual_reporting)}">${article.factual_reporting}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="article-content">
                    <div class="section mb-3">
                        <h6 class="text-secondary">Summary</h6>
                        <p>${article.summary}</p>
                    </div>
                    
                    <div class="section mb-3">
                        <h6 class="text-success">Why It Matters</h6>
                        <p>${article.why_interesting}</p>
                    </div>
                    
                    <div class="section mb-3">
                        <h6 class="text-warning">Devil's Advocate</h6>
                        <p>${article.devils_advocate}</p>
                    </div>
                    
                    <div class="section">
                        <h6 class="text-info">Political & Ideological Perspectives</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong class="text-danger">Left-leaning:</strong>
                                <p class="small">${article.perspectives.left}</p>
                            </div>
                            <div class="col-md-4">
                                <strong class="text-primary">Centrist:</strong>
                                <p class="small">${article.perspectives.center}</p>
                            </div>
                            <div class="col-md-4">
                                <strong class="text-warning">Right-leaning:</strong>
                                <p class="small">${article.perspectives.right}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Related Articles Section (compact) -->
                    ${article.related_articles && article.related_articles.length > 0 ? `
                    <div class="section mt-3">
                        <h6 class="text-primary">Related Articles</h6>
                        <ul class="list-unstyled mb-0">
                            ${article.related_articles.map(related => `
                                <li class="py-1">
                                    <div class="d-flex align-items-start justify-content-between gap-2">
                                        <div class="flex-grow-1">
                                            <a href="${related.url}" target="_blank" rel="noopener" class="text-decoration-none small fw-semibold">${related.title}</a>
                                            <div class="small text-muted">
                                                <strong>Source:</strong> ${related.source}
                                                ${related.similarity_score ? `<span class=\"ms-2 badge bg-secondary\">${(related.similarity_score * 100).toFixed(0)}% similar</span>` : ''}
                                            </div>
                                            ${related.summary ? `<div class=\"small text-secondary\">${related.summary.length > 110 ? related.summary.substring(0,110) + '' : related.summary}</div>` : ''}
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    contentEl.innerHTML = html;
}

function getBiasBadge(bias) {
    if (!bias) return '';
    
    const biasClasses = {
        'left': 'bias-left',
        'left-center': 'bias-left-center',
        'center': 'bias-center',
        'right-center': 'bias-right-center',
        'right': 'bias-right',
        'mixed': 'bias-mixed'
    };
    
    const className = biasClasses[bias] || 'bias-mixed';
    return `<span class="bias-badge ${className}">${bias}</span>`;
}

function getFactualityBadge(factuality) {
    if (!factuality) return '';
    
    const factualityClasses = {
        'very-high': 'factuality-very-high',
        'high': 'factuality-high',
        'mostly-factual': 'factuality-mostly-factual',
        'mixed': 'factuality-mixed',
        'low': 'factuality-low',
        'very-low': 'factuality-low'
    };
    
    const className = factualityClasses[factuality] || 'factuality-mixed';
    const displayText = factuality.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
    return `<span class="factuality-badge ${className}">${displayText}</span>`;
}

// Legacy share functionality - replaced with save feed functionality above

// Old share functionality removed - these elements no longer exist

function showSaveButton() {
    // Save and export buttons have been removed - this function is now a no-op
    // Keep for compatibility with existing calls
}

function renderArticlesPagination(data) {
    const paginationContainer = document.getElementById('articles-pagination');
    if (!paginationContainer || !data.total_pages || data.total_pages <= 1) {
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }

    const currentPage = data.page || 1;
    const totalPages = data.total_pages;
    
    let html = '<nav><ul class="pagination pagination-sm justify-content-center">';
    
    // Previous button
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${currentPage - 1}); return false;">Previous</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Previous</span></li>';
    }
    
    // Page numbers (show max 5 pages around current)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(1); return false;">1</a></li>';
        if (startPage > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${i}); return false;">${i}</a></li>`;
        }
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${currentPage + 1}); return false;">Next</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Next</span></li>';
    }
    
    html += '</ul></nav>';
    paginationContainer.innerHTML = html;
}

// Calendar functionality
let availableDates = {};
let selectedDate = '2025-09-15';
// Set calendar to show September 2025 (month of selected date)
let currentCalendarMonth = 8; // September (0-based)
let currentCalendarYear = 2025;

async function loadAvailableDates() {
    console.log('Starting loadAvailableDates...');
    try {
        console.log('Fetching available dates from API...');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch('/api/news-feed/available-dates', {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        console.log('Response received:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Data parsed:', data);
        
        if (data.success) {
            console.log('Processing dates...');
            availableDates = {};
            data.dates.forEach(dateInfo => {
                availableDates[dateInfo.date] = dateInfo.count;
            });
            console.log('Available dates processed:', Object.keys(availableDates).length, 'dates');
            
            console.log('Rendering calendar...');
            renderCalendar();
            console.log('Calendar rendered');

            // Hide loading, show calendar
            const loading = document.getElementById('calendar-loading');
            const view = document.getElementById('calendar-view');
            if (loading) loading.style.display = 'none';
            if (view) view.style.display = 'block';

            // Update selected-date count if known and initialize calendar to selected date month
            const countEl = document.getElementById('selected-date-count');
            const currentDate = document.getElementById('selected-date')?.value;
            if (countEl) countEl.textContent = String(availableDates[currentDate] ?? 0);
            
            // Set calendar to show the month of the selected date
            if (currentDate) {
                const [year, month] = currentDate.split('-').map(Number);
                currentCalendarYear = year;
                currentCalendarMonth = month - 1; // JS months are 0-based
            }
            console.log('loadAvailableDates completed successfully');
        } else {
            console.error('API returned success: false', data);
            throw new Error(data.message || 'Unknown error from API');
        }
    } catch (error) {
        console.error('Error loading available dates:', error);
        const loading = document.getElementById('calendar-loading');
        if (loading) {
            if (error.name === 'AbortError') {
                loading.innerHTML = `
                    <div class="text-danger">Calendar loading timed out.</div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableDates()">Retry</button>
                    <div class="mt-2 small text-muted">You can still use the date picker above to select dates.</div>
                `;
            } else {
                loading.innerHTML = `
                    <div class="text-danger">Failed to load calendar: ${error.message}</div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableDates()">Retry</button>
                    <div class="mt-2 small text-muted">You can still use the date picker above to select dates.</div>
                `;
            }
        }
    }
}

function renderCalendar() {
    console.log('renderCalendar started');
    const view = document.getElementById('calendar-view');
    const loading = document.getElementById('calendar-loading');
    if (!view) {
        console.error('calendar-view element not found');
        return;
    }

    if (loading) loading.style.display = 'none';
    console.log('Calendar loading hidden, building HTML...');

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Get first day of month and number of days
    const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
    const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeCalendarMonth(-1)"> Prev</button>
            <h6 class="mb-0">${monthNames[currentCalendarMonth]} ${currentCalendarYear}</h6>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeCalendarMonth(1)">Next </button>
        </div>`;

    // Calendar header
    html += '<div class="row g-1 mb-2">';
    for (const day of dayNames) {
        html += `<div class="col text-center"><small class="text-muted fw-bold">${day}</small></div>`;
    }
    html += '</div>';

    // Calendar days
    html += '<div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
    
    // Empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day-empty" style="height: 40px;"></div>';
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const count = availableDates[dateStr] ?? 0;
        const isSelected = dateStr === selectedDate;
        const hasArticles = count > 0;
        
        let buttonClass = 'btn btn-sm w-100 h-100 d-flex flex-column justify-content-center align-items-center';
        if (isSelected) {
            buttonClass += ' btn-primary';
        } else if (hasArticles) {
            buttonClass += ' btn-outline-primary';
        } else {
            buttonClass += ' btn-outline-light text-muted';
        }

        html += `
            <button type="button" class="${buttonClass}" data-date="${dateStr}" style="height: 40px; font-size: 0.8rem;" ${!hasArticles ? 'disabled' : ''}>
                <div>${day}</div>
                ${hasArticles ? `<small class="badge bg-secondary rounded-pill" style="font-size: 0.6rem;">${count}</small>` : ''}
            </button>`;
    }

    html += '</div>';
    console.log('Calendar HTML built, setting innerHTML...');
    view.innerHTML = html;
    view.style.display = 'block';
    console.log('Calendar HTML set, wiring click handlers...');

    // Wire click handlers
    view.querySelectorAll('[data-date]:not([disabled])').forEach((btn) => {
        btn.addEventListener('click', () => {
            const d = btn.getAttribute('data-date');
            setSelectedDate(d);
        });
    });
    console.log('renderCalendar completed');
}

function changeCalendarMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    }
    renderCalendar();
}

function setSelectedDate(dateStr) {
    // Update global and hidden input
    selectedDate = dateStr;
    const hidden = document.getElementById('selected-date');
    if (hidden) hidden.value = dateStr;

    // Update header display
    const [y, m, d] = dateStr.split('-').map(Number);
    const display = document.getElementById('selected-date-text');
    if (display) {
        const dateObj = new Date(y, m - 1, d);
        display.textContent = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Update count immediately if known, otherwise loading
    const countEl = document.getElementById('selected-date-count');
    if (countEl) countEl.textContent = (availableDates[dateStr] ?? 'loading...');

    // Close the calendar collapse if open
    try {
        const collapseEl = document.getElementById('calendar-collapse');
        if (collapseEl && collapseEl.classList.contains('show') && window.bootstrap && bootstrap.Collapse) {
            const instance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
            instance.hide();
        }
    } catch (_) { /* no-op if bootstrap not available */ }

    // Reload content for the newly selected date
    loadArticles(1);
    loadSixArticles();
}

// Organizational profile management
async function loadOrganizationalProfiles() {
    try {
        const response = await fetch('/api/organizational-profiles');
        const data = await response.json();
        
        if (data.success && data.profiles) {
            const profileSelect = document.getElementById('profile-select');
            
            // Clear existing options except the first
            profileSelect.innerHTML = '<option value="">General Analysis (No Profile)</option>';
            
            // Add profiles
            data.profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name}${profile.is_default ? ' (Default)' : ''}`;
                option.title = `${profile.industry || 'General'}  ${profile.organization_type || 'Organization'}`;
                profileSelect.appendChild(option);
            });
            
            // Restore saved profile selection after loading profiles
            const savedProfile = localStorage.getItem('newsFeedProfileId');
            if (savedProfile) {
                const opt = Array.from(profileSelect.options).find(o => o.value === savedProfile);
                if (opt) {
                    profileSelect.value = savedProfile;
                    console.log(`Restored saved profile: ${savedProfile}`);
                } else {
                    console.warn(`Saved profile ${savedProfile} not found in loaded profiles`);
                }
            }
            
            // Add change listener to save future selections (if not already added)
            if (!profileSelect.dataset.listenerAdded) {
                profileSelect.addEventListener('change', () => {
                    localStorage.setItem('newsFeedProfileId', profileSelect.value);
                    console.log(`Saved profile selection: ${profileSelect.value}`);
                    updateArticleCountForDateRange();
                });
                profileSelect.dataset.listenerAdded = 'true';
            }
            
            console.log(`Loaded ${data.profiles.length} organizational profiles`);
        }
    } catch (error) {
        console.error('Error loading organizational profiles:', error);
        showNotification('Failed to load organizational profiles', 'warning');
    }
}

// Date range handling
function handleDateRangeChange() {
    const dateRangeSelect = document.getElementById('date-range-select');
    const customDateSection = document.getElementById('custom-date-section');
    const dateRangeText = document.getElementById('date-range-text');
    const selectedDateInput = document.getElementById('selected-date');
    
    const selectedRange = dateRangeSelect.value;
    
    if (selectedRange === 'custom') {
        customDateSection.style.display = 'block';
        dateRangeText.textContent = 'Custom Date';
        // Use the custom date input value
        selectedDateInput.value = document.getElementById('custom-date-input').value;
    } else {
        customDateSection.style.display = 'none';
        
        // Calculate date range and update display
        const now = new Date();
        let startDate, endDate = now;
        let displayText = '';
        
        switch (selectedRange) {
            case '24h':
                startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                displayText = 'Last 24 Hours';
                selectedDateInput.value = now.toISOString().split('T')[0];
                break;
            case '7d':
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                displayText = 'Last 7 Days';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '30d':
                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                displayText = 'Last 30 Days';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '3m':
                startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                displayText = 'Last 3 Months';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '1y':
                startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                displayText = 'Last Year';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case 'all':
                displayText = 'All Time';
                selectedDateInput.value = 'all';
                break;
        }
        
        dateRangeText.textContent = displayText;
        
        // Update the info text
        const dateRangeInfo = document.getElementById('date-range-info');
        if (dateRangeInfo) {
            if (selectedRange === 'all') {
                dateRangeInfo.textContent = 'All available articles';
            } else {
                const startDateStr = startDate ? startDate.toLocaleDateString() : '';
                const endDateStr = endDate.toLocaleDateString();
                dateRangeInfo.textContent = `${startDateStr} to ${endDateStr}`;
            }
        }
    }
    
    // Auto-reload articles when date range changes
    autoLoadArticles();
}

// Update article count for date range changes
async function updateArticleCountForDateRange() {
    const countEl = document.getElementById('selected-date-count');
    if (!countEl) return;
    
    try {
        countEl.textContent = 'loading...';
        
        const dateRangeEl = document.getElementById('date-range-select');
        if (!dateRangeEl) {
            console.warn('date-range-select element not found');
            countEl.textContent = '0';
            return;
        }
        const dateRangeValue = dateRangeEl.value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            count_only: 'true'
        });
        
        // Add custom date if needed
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            if (customDate) {
                params.append('date', customDate);
            }
        }
        
        // Add topic filter if set
        const topicEl = document.getElementById('topic-select');
        if (topicEl && topicEl.value) {
            params.append('topic', topicEl.value.trim());
        }
        
        // Make a lightweight request to get just the count
        const response = await fetch(`/api/news-feed/articles?${params}&per_page=1&page=1`);
        
        if (response.ok) {
            const data = await response.json();
            const total = data.articles?.total_items || 0;
            countEl.textContent = total.toString();
        } else {
            countEl.textContent = '0';
        }
    } catch (error) {
        console.error('Error updating article count:', error);
        countEl.textContent = '?';
    }
}

// Star functionality for articles
let starredArticles = new Set();

// Filter functionality for articles
let activeFilters = {
    bias: new Set(),
    factuality: new Set(),
    category: new Set()
};

function renderArticles(articlesData) {
    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '';
    
    if (!articlesData.items || articlesData.items.length === 0) {
        listContainer.innerHTML = '<div class="alert alert-info">No articles available.</div>';
        document.getElementById('articles-filters').style.display = 'none';
        return;
    }
    
    // Build filter badges from available data
    buildFilterBadges(articlesData.items);
    
    // Apply current filters
    const filteredArticles = applyArticleFilters(articlesData.items);
    
    const articlesList = document.createElement('div');
    articlesList.className = 'list-group list-group-flush mt-2';
    
    filteredArticles.forEach(article => {
        const articleItem = document.createElement('div');
        articleItem.className = 'list-group-item position-relative';
        
        const isStarred = starredArticles.has(article.uri);
        
        articleItem.innerHTML = `
            <!-- Remove button (top-right) -->
            <button class="btn btn-sm position-absolute" 
                    style="top: 8px; right: 8px; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; border: none; background: rgba(220, 53, 69, 0.1); color: #dc3545; border-radius: 50%;"
                    onclick="excludeArticle('${article.uri}', this)"
                    onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                    onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'; this.style.color='#dc3545';"
                    title="Remove article"></button>
            
            <!-- Star button (top-left) -->
            <button class="btn btn-sm position-absolute star-btn ${isStarred ? 'starred' : ''}" 
                    style="top: 8px; left: 8px; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; border: none; background: ${isStarred ? '#ffc107' : 'rgba(255, 193, 7, 0.1)'}; color: ${isStarred ? 'white' : '#ffc107'}; border-radius: 50%;"
                    onclick="toggleStarArticle('${article.uri}', this)"
                    title="${isStarred ? 'Remove from Six Articles' : 'Add to Six Articles'}"></button>
            
            
            <!-- Expand arrow (left side) -->
            <button class="btn btn-sm position-absolute expand-arrow-btn" 
                    style="top: 50%; left: -2px; transform: translateY(-50%); width: 20px; height: 40px; padding: 0; font-size: 12px; border: none; background: #007bff; color: white; border-radius: 0 8px 8px 0; box-shadow: 2px 0 4px rgba(0,0,0,0.1);"
                    onclick="toggleArticleDetails('${article.uri}', this)"
                    title="Show detailed view">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Two Column Layout -->
            <div class="row" style="margin-left: 30px; margin-right: 30px;">
                <!-- Column 1: Content -->
                <div class="col-md-8">
                    <h6 class="mb-2">
                        <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                            ${escapeHTML(article.title)}
                        </a>
                        <span class="cached-indicator" id="cached-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none;">
                            <span class="badge bg-info text-white ms-2" style="font-size: 8px;">
                                <i class="fas fa-database me-1"></i>Cached
                            </span>
                        </span>
                    </h6>
                    <p class="mb-1 small text-muted">
                        <i class="fas fa-building me-1"></i>${escapeHTML(article.news_source)}
                        <span class="ms-2">
                            <i class="fas fa-calendar me-1"></i>${new Date(article.publication_date).toLocaleDateString()}
                        </span>
                    </p>
                    <p class="mb-0 small text-secondary" style="line-height: 1.4;">
                        ${escapeHTML(article.summary)}
                    </p>
                </div>
                
                <!-- Column 2: Metadata -->
                <div class="col-md-4">
                    <div class="d-flex flex-column gap-1 h-100 justify-content-center">
                        ${article.bias ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Political Bias:</span>
                            <span class="badge ${getBiasClass(article.bias)}">${article.bias}</span>
                        </div>` : ''}
                        
                        ${article.factual_reporting ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Factual:</span>
                            <span class="badge ${getFactualityClass(article.factual_reporting)}">${article.factual_reporting}</span>
                        </div>` : ''}
                        
                        ${article.mbfc_credibility_rating ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Credibility:</span>
                            <span class="badge bg-info text-white">${article.mbfc_credibility_rating}</span>
                        </div>` : ''}
                        
                        ${article.category ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Category:</span>
                            <span class="badge bg-light text-dark">${article.category}</span>
                        </div>` : ''}
                        
                    </div>
                </div>
            </div>
            
            <!-- Detailed View (Initially Hidden) -->
            <div class="article-details" id="details-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-left: 20px; margin-right: 10px; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                <div class="row">
                    <!-- Left Column: Enhanced Summary & Analysis -->
                    <div class="col-md-8">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-search-plus me-2"></i>Detailed Analysis
                        </h6>
                        
                        <div class="mb-3">
                            <h6 class="text-secondary">Full Summary</h6>
                            <p class="small">${escapeHTML(article.summary)}</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="text-secondary">Auspex Analysis</h6>
                            <div class="analysis-content bg-white p-3 rounded border" id="analysis-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                <div class="analysis-text bg-light p-2 rounded small text-muted">
                                    Analysis will be generated automatically when you expand this article.
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                    
                    <!-- Right Column: Complete Metadata -->
                    <div class="col-md-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>Complete Metadata
                        </h6>
                        
                        <div class="metadata-grid">
                            <!-- Enhanced metadata for detailed view -->
                            ${article.sentiment ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Sentiment</small>
                                <span class="badge ${getSentimentClass(article.sentiment)}">${article.sentiment}</span>
                                ${article.sentiment_explanation ? `<br><small class="text-muted">${article.sentiment_explanation}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.driver_type || article.driver_type_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Driver Type</small>
                                ${article.driver_type ? `<span class=\"badge bg-secondary\">${article.driver_type}</span>` : ''}
                                ${article.driver_type_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.driver_type_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.time_to_impact || article.time_to_impact_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Time to Impact</small>
                                ${article.time_to_impact ? `<span class=\"badge bg-warning text-dark\">${article.time_to_impact}</span>` : ''}
                                ${article.time_to_impact_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.time_to_impact_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.future_signal || article.future_signal_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Future Signal</small>
                                ${article.future_signal ? `<span class=\"badge bg-dark text-white\">${article.future_signal}</span>` : ''}
                                ${article.future_signal_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.future_signal_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${article.tags ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Tags</small>
                                <div class="d-flex flex-wrap gap-1">
                                    ${(() => {
                                        let tags = [];
                                        if (Array.isArray(article.tags)) {
                                            tags = article.tags;
                                        } else if (typeof article.tags === 'string') {
                                            tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                                        }
                                        return tags.map(tag => 
                                            `<span class="badge bg-light text-dark" style="font-size: 8px;">${escapeHTML(tag)}</span>`
                                        ).join('');
                                    })()}
                                </div>
                            </div>` : ''}
                            
            <!-- View & Analysis Options (Detailed View Only) -->
            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                <small class="text-muted d-block mb-1">View Options</small>
                <div class="d-flex flex-wrap gap-1 mb-2">
                    <button class="btn btn-outline-info btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="window.open('https://12ft.io/${article.uri}', '_blank')"
                            title="View via 12ft.io (bypass paywall)">
                        <i class="fas fa-unlock-alt me-1"></i>12ft
                    </button>
                    <button class="btn btn-outline-warning btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="window.open('https://archive.is/${article.uri}', '_blank')"
                            title="View archived version">
                        <i class="fas fa-archive me-1"></i>Archive
                    </button>
                    <button class="btn btn-outline-success btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="openAnnotationModal('${article.uri}')"
                            title="Add annotation">
                        <i class="fas fa-sticky-note me-1"></i>Note
                    </button>
                </div>
                <small class="text-muted d-block mb-1">Analysis Options</small>
                <div class="d-flex flex-wrap gap-1 mb-1">
                    <button class="btn btn-outline-primary btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchAuspexDeepDive('${article.uri}')"
                            title="Generate comprehensive deep-dive analysis">
                        <i class="fas fa-microscope me-1"></i>Deep Dive
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchConsensusAnalysis('${article.uri}')"
                            title="Compare article claims to consensus">
                        <i class="fas fa-balance-scale me-1"></i>Consensus
                    </button>
                    <button class="btn btn-outline-dark btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchTimelineAnalysis('${article.uri}')"
                            title="Analyze impact timeline">
                        <i class="fas fa-clock me-1"></i>Timeline
                    </button>
                </div>
                <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-outline-info btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchAuspexChat('${article.uri}')"
                            title="Chat with Auspex about this article">
                        <i class="fas fa-comments me-1"></i>Ask Auspex
                    </button>
                </div>
            </div>

                            <!-- Research Themes Section (Detailed View Only) -->
                            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                                <small class="text-muted d-block mb-1">Research Themes</small>
                                <div class="research-themes-sidebar" id="themes-sidebar-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="text-muted small">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Loading themes...
                                    </div>
                                </div>
                            </div>

                            <!-- Related Articles Section (Detailed View Only) -->
                            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                                <small class="text-muted d-block mb-1">Related Articles</small>
                                <div class="related-articles-sidebar" id="related-sidebar-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="text-muted small">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Loading...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        articlesList.appendChild(articleItem);
    });
    
    listContainer.appendChild(articlesList);
    updateStarredCount();
    
    // Check for cached analysis and show indicators
    checkCachedAnalysisIndicators(articlesData.items);
    
    // Update count display to show filtered vs total
    const countEl = document.getElementById('selected-date-count');
    if (countEl) {
        const totalCount = articlesData.items.length;
        const filteredCount = filteredArticles.length;
        if (filteredCount !== totalCount) {
            countEl.textContent = `${filteredCount} of ${totalCount}`;
        } else {
            countEl.textContent = totalCount.toString();
        }
    }
    
    // Update pagination based on filtered results
    updatePaginationForFilters(articlesData, filteredArticles);
}

function buildFilterBadges(articles) {
    // Collect unique values
    const biasValues = new Set();
    const factualityValues = new Set();
    const categoryValues = new Set();
    
    articles.forEach(article => {
        if (article.bias) biasValues.add(article.bias);
        if (article.factual_reporting) factualityValues.add(article.factual_reporting);
        if (article.category) categoryValues.add(article.category);
    });
    
    // Build bias filter badges
    const biasContainer = document.getElementById('bias-filters');
    biasContainer.innerHTML = '';
    biasValues.forEach(bias => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm ${getBiasClass(bias)} filter-badge ${activeFilters.bias.has(bias) ? 'active' : ''}`;
        badge.textContent = bias;
        badge.onclick = () => toggleFilter('bias', bias);
        biasContainer.appendChild(badge);
    });
    
    // Build factuality filter badges
    const factualityContainer = document.getElementById('factuality-filters');
    factualityContainer.innerHTML = '';
    factualityValues.forEach(factuality => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm ${getFactualityClass(factuality)} filter-badge ${activeFilters.factuality.has(factuality) ? 'active' : ''}`;
        badge.textContent = factuality;
        badge.onclick = () => toggleFilter('factuality', factuality);
        factualityContainer.appendChild(badge);
    });
    
    // Build category filter badges
    const categoryContainer = document.getElementById('category-filters');
    categoryContainer.innerHTML = '';
    categoryValues.forEach(category => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm bg-light text-dark filter-badge ${activeFilters.category.has(category) ? 'active' : ''}`;
        badge.textContent = category;
        badge.onclick = () => toggleFilter('category', category);
        categoryContainer.appendChild(badge);
    });
    
    // Show filter section if we have any filters
    if (biasValues.size > 0 || factualityValues.size > 0 || categoryValues.size > 0) {
        document.getElementById('articles-filters').style.display = 'block';
    }
}

function toggleFilter(filterType, value) {
    if (activeFilters[filterType].has(value)) {
        activeFilters[filterType].delete(value);
    } else {
        activeFilters[filterType].add(value);
    }
    
    // Re-render articles with new filters
    const articlesData = window.lastArticlesData; // Store this when loading articles
    if (articlesData) {
        renderArticles(articlesData);
    }
}

function applyArticleFilters(articles) {
    return articles.filter(article => {
        // Check bias filter
        if (activeFilters.bias.size > 0 && !activeFilters.bias.has(article.bias)) {
            return false;
        }
        
        // Check factuality filter
        if (activeFilters.factuality.size > 0 && !activeFilters.factuality.has(article.factual_reporting)) {
            return false;
        }
        
        // Check category filter
        if (activeFilters.category.size > 0 && !activeFilters.category.has(article.category)) {
            return false;
        }
        
        return true;
    });
}

function improveQuality() {
    // Clear existing filters first
    activeFilters.bias.clear();
    activeFilters.factuality.clear();
    activeFilters.category.clear();
    
    // Check what factuality values are actually available
    const articlesData = window.lastArticlesData;
    if (!articlesData || !articlesData.items) {
        showNotification('No articles data available for filtering', 'warning');
        return;
    }
    
    // Collect all factuality values to see what's available
    const availableFactuality = new Set();
    articlesData.items.forEach(article => {
        if (article.factual_reporting) {
            availableFactuality.add(article.factual_reporting);
        }
    });
    
    console.log('Available factuality values:', Array.from(availableFactuality));
    
    // Add high-quality factuality filters (more inclusive)
    const highQualityFactuality = Array.from(availableFactuality).filter(factuality => {
        const lower = factuality.toLowerCase();
        return lower.includes('high') || 
               lower.includes('mostly') || 
               lower.includes('factual') ||
               lower === 'very high' ||
               lower === 'high' ||
               lower === 'mostly factual';
    });
    
    if (highQualityFactuality.length === 0) {
        // If no high-quality matches found, be more lenient
        const acceptableFactuality = Array.from(availableFactuality).filter(factuality => {
            const lower = factuality.toLowerCase();
            return !lower.includes('low') && !lower.includes('very low');
        });
        
        acceptableFactuality.forEach(factuality => {
            activeFilters.factuality.add(factuality);
        });
        
        showNotification(`Showing ${acceptableFactuality.length > 0 ? 'acceptable' : 'all available'} quality sources`, 'info');
    } else {
        highQualityFactuality.forEach(factuality => {
            activeFilters.factuality.add(factuality);
        });
        
        showNotification(`Showing ${highQualityFactuality.length} high-quality source types`, 'success');
    }
    
    // Re-render articles with quality filters
    renderArticles(articlesData);
}

function updatePaginationForFilters(originalData, filteredArticles) {
    const paginationContainer = document.getElementById('articles-pagination');
    if (!paginationContainer) return;
    
    // If filtering is active and reduces results significantly, hide pagination
    const hasActiveFilters = activeFilters.bias.size > 0 || activeFilters.factuality.size > 0 || activeFilters.category.size > 0;
    
    if (hasActiveFilters) {
        // Hide pagination when filtering since we're showing filtered subset
        paginationContainer.innerHTML = '';
        
        // Show filter info instead
        if (filteredArticles.length !== originalData.items.length) {
            paginationContainer.innerHTML = `
                <div class="text-center text-muted small mt-2">
                    <i class="fas fa-filter me-1"></i>
                    Showing ${filteredArticles.length} filtered articles of ${originalData.items.length} total
                    ${originalData.total_pages > 1 ? ` (from ${originalData.total_pages} pages)` : ''}
                </div>
            `;
        }
    } else {
        // Show normal pagination when no filters active
        renderArticlesPagination(originalData);
    }
}

function clearAllFilters() {
    activeFilters.bias.clear();
    activeFilters.factuality.clear();
    activeFilters.category.clear();
    
    // Re-render articles without filters
    const articlesData = window.lastArticlesData;
    if (articlesData) {
        renderArticles(articlesData);
        showNotification('All filters cleared', 'info');
    }
}

// Article detailed view functionality
function toggleArticleDetails(articleUri, buttonElement) {
    const detailsId = `details-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const detailsDiv = document.getElementById(detailsId);
    const icon = buttonElement.querySelector('i');
    
    if (!detailsDiv) return;
    
    if (detailsDiv.style.display === 'none') {
        // Expand
        detailsDiv.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
        buttonElement.title = 'Hide detailed view';
        buttonElement.style.background = '#28a745'; // Green when expanded
        
        // Animate expansion
        detailsDiv.style.opacity = '0';
        detailsDiv.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            detailsDiv.style.transition = 'all 0.3s ease';
            detailsDiv.style.opacity = '1';
            detailsDiv.style.transform = 'translateY(0)';
        }, 10);

        // Auto-generate AI analysis and related articles on expand if a valid model is selected
        try {
            const model = document.getElementById('model-select')?.value;
            const isValid = model && typeof model === 'string' && model.trim().length > 0;
            const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const relatedId = `related-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const analysisDiv = document.getElementById(analysisId);
            const relatedDiv = document.getElementById(relatedId);

            if (!isValid) {
                showNotification('Select a valid AI model to generate analysis', 'warning');
            } else {
                console.log(`Analysis div check: exists=${!!analysisDiv}, loaded=${analysisDiv?.dataset.loaded}`);
                if (analysisDiv && !analysisDiv.dataset.loaded) {
                    console.log(`Generating analysis for ${articleUri}`);
                    generateArticleAnalysis(articleUri);
                } else {
                    console.log(`Skipping analysis generation - already loaded or div missing`);
                }
                // Load related articles for sidebar
                loadRelatedArticlesSidebar(articleUri);
                
                // Generate research themes for sidebar (check if already loaded)
                const themesDiv = document.getElementById(`themes-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`);
                console.log(`Themes div check: exists=${!!themesDiv}, loaded=${themesDiv?.dataset.loaded}`);
                if (themesDiv && !themesDiv.dataset.loaded) {
                    console.log(`Generating themes for ${articleUri}`);
                    generateResearchThemes(articleUri);
                } else {
                    console.log(`Skipping themes generation - already loaded or div missing`);
                }
            }
        } catch (_) { /* best-effort */ }
    } else {
        // Collapse
        detailsDiv.style.transition = 'all 0.3s ease';
        detailsDiv.style.opacity = '0';
        detailsDiv.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            detailsDiv.style.display = 'none';
        }, 300);
        
        icon.className = 'fas fa-chevron-right';
        buttonElement.title = 'Show detailed view';
        buttonElement.style.background = '#007bff'; // Blue when collapsed
    }
}

async function generateArticleAnalysis(articleUri) {
    const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const analysisDiv = document.getElementById(analysisId);
    
    if (!analysisDiv) return;
    
    // Check for cached analysis first (database + localStorage fallback)
    const selectedModel = document.getElementById('model-select')?.value;
    
    console.log(`=== CACHE CHECK START ===`);
    console.log(`Article URI: ${articleUri}`);
    console.log(`Selected Model: ${selectedModel}`);
    console.log(`Analysis div loaded: ${analysisDiv.dataset.loaded}`);
    
    // Try database cache first
    try {
        console.log(`Checking cache for: ${articleUri} with model: ${selectedModel}`);
        const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(articleUri)}&analysis_type=summary&model=${encodeURIComponent(selectedModel)}`);
        console.log(`Cache response status: ${cacheResponse.status}`);
        
        if (cacheResponse.ok) {
            const cacheData = await cacheResponse.json();
            console.log('Cache response data:', cacheData);
            
            if (cacheData.cached) {
                console.log('Using cached analysis from database');
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                analysisDiv.innerHTML = `
                    <div class="analysis-text bg-info-subtle p-3 rounded border">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-database me-2 text-info"></i>
                                <strong class="text-info">Strategic Analysis (DB Cache)</strong>
                                <span class="badge bg-info ms-2">${cacheData.model_used}</span>
                            </div>
                            <small class="text-muted">Generated: ${cacheDate}</small>
                        </div>
                        ${cacheData.content}
                    </div>
                `;
                analysisDiv.dataset.loaded = 'true';
                return;
            } else {
                console.log('No cached analysis found in database');
            }
        } else {
            console.warn(`Cache API returned ${cacheResponse.status}`);
        }
    } catch (e) {
        console.warn('Database cache failed, checking localStorage:', e);
    }
    
    // Fallback to localStorage cache
    try {
        const localCacheKey = `analysis_cache_${articleUri}_summary_${selectedModel}`;
        const localCache = localStorage.getItem(localCacheKey);
        if (localCache) {
            const cacheData = JSON.parse(localCache);
            const cacheAge = new Date() - new Date(cacheData.generated_at);
            const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
            
            if (cacheAge < maxAge) {
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                analysisDiv.innerHTML = `
                    <div class="analysis-text bg-warning-subtle p-3 rounded border">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-hdd me-2 text-warning"></i>
                                <strong class="text-warning">Strategic Analysis (Local Cache)</strong>
                                <span class="badge bg-warning ms-2">${cacheData.model_used}</span>
                            </div>
                            <small class="text-muted">Generated: ${cacheDate}</small>
                        </div>
                        ${cacheData.content}
                    </div>
                `;
                analysisDiv.dataset.loaded = 'true';
                return;
            } else {
                // Cache expired, remove it
                localStorage.removeItem(localCacheKey);
            }
        }
    } catch (e) {
        console.warn('localStorage cache check failed:', e);
    }
    
    try {
        analysisDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Generating analysis...
            </div>
        `;
        
        // Get the selected model
        const selectedModel = document.getElementById('model-select').value;
        console.log(`Generating analysis for ${articleUri} using model: ${selectedModel}`);
        
        // Get the article data from our current dataset
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Article not found in current dataset');
        }
        
        // Prefer raw-text endpoint, fall back to legacy metadata summary
        let response = await fetch('/api/vector-summary-raw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: [articleUri], model: selectedModel || 'gpt-4.1-mini' })
        });
        if (!response.ok) {
            console.warn('Raw summary failed, falling back to legacy summary');
            response = await fetch('/api/vector-summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: [articleUri], model: selectedModel || 'gpt-4.1-mini' })
            });
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error Response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
        }
        
        const responseText = await response.text();
        console.log('Raw API response:', responseText);
        
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (jsonError) {
            console.error('JSON Parse Error:', jsonError);
            console.log('Response that failed to parse:', responseText);
            throw new Error(`Invalid JSON response: ${jsonError.message}`);
        }
        
        let analysis = result.response || result.message || result.content || 'No analysis available';
        // Normalize to single-article framing
        analysis = analysis
            // Remove common cluster lead-ins
            .replace(/^\s*Cluster Summary:.*$/gmi, '')
            .replace(/^\s*Summary of .*?cluster.*$/gmi, 'Article Summary')
            .replace(/^\s*This cluster[^\n]*$/gmi, '')
            .replace(/^\s*Overall, the cluster[^\n]*$/gmi, '')
            // Re-label section headers
            .replace(/^\s*Key Themes\s*$/gmi, '## Key Themes')
            .replace(/^\s*Sentiment\s*$/gmi, '## Sentiment')
            // Drop multi-article sections entirely
            .replace(/(^\s*(Notable|Key) Articles[\s\S]*?)(?=^\s*##\s|^\s*#\s|\Z)/gmi, '')
            // Tone down remaining cluster words
            .replace(/\b[Cc]lusters\b/g, 'articles')
            .replace(/\b[Cc]luster\b/g, 'article')
            // Clean horizontal rules
            .replace(/^\s*-{3,}\s*$/gm, '')
            .trim();
        
        if (!analysis || analysis.trim() === '') {
            throw new Error('Empty analysis response');
        }
        
        // Format the response properly
        const formattedAnalysis = formatMarkdownAnalysis(analysis);
        const timestamp = new Date().toISOString();
        const displayDate = new Date().toLocaleString();
        
        // Cache the analysis in database with localStorage fallback
        try {
            const cacheResponse = await fetch('/api/save-analysis-cache', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    article_uri: articleUri,
                    analysis_type: 'summary',
                    content: formattedAnalysis,
                    model_name: selectedModel
                })
            });
            
            if (cacheResponse.ok) {
                console.log('Analysis cached to database successfully');
            } else {
                throw new Error(`Database cache failed: ${cacheResponse.status}`);
            }
        } catch (cacheError) {
            console.warn('Database cache failed, using localStorage fallback:', cacheError);
            
            // Fallback to localStorage
            const cacheData = {
                content: formattedAnalysis,
                model_used: selectedModel,
                generated_at: new Date().toISOString(),
                analysis_type: 'summary'
            };
            localStorage.setItem(`analysis_cache_${articleUri}_summary_${selectedModel}`, JSON.stringify(cacheData));
        }
        
        analysisDiv.innerHTML = `
            <div class="analysis-text bg-success-subtle p-3 rounded border">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                    <i class="fas fa-robot me-2 text-success"></i>
                    <strong class="text-success">Strategic Analysis</strong>
                    <span class="badge bg-success ms-2">${selectedModel}</span>
                    </div>
                    <small class="text-muted">Generated: ${displayDate}</small>
                </div>
                ${formattedAnalysis}
            </div>
        `;
        analysisDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error generating article analysis:', error);
        
        // Show clear error message about server configuration
        analysisDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Analysis Unavailable</h6>
                <p class="mb-2">Vector routes not mounted on server. Analysis endpoints returning 404.</p>
                <small class="text-muted">
                    <strong>Solution:</strong> Ensure your server instance mounts vector_routes via app/core/routers.py
                </small>
            </div>
        `;
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (article) {
            const enhancedAnalysis = generateEnhancedAnalysis(article);
            analysisDiv.innerHTML = `
                <div class="analysis-text bg-warning-subtle p-3 rounded border">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        <strong class="text-warning">Analysis Failed</strong>
                        <span class="badge bg-warning text-dark ms-2">Using Enhanced Metadata</span>
                    </div>
                    <div class="alert alert-warning alert-sm mb-3">
                        <small><strong>Error:</strong> ${error.message}</small>
                    </div>
                    ${enhancedAnalysis}
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="generateArticleAnalysis('${articleUri}')">
                            <i class="fas fa-sync me-1"></i>Retry Analysis
                        </button>
                    </div>
                </div>
            `;
        } else {
            analysisDiv.innerHTML = `
                <div class="text-danger small">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }
}

// Enhanced Analysis feature removed per requirements

async function loadRelatedArticles(articleUri) {
    const relatedId = `related-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const relatedDiv = document.getElementById(relatedId);
    
    if (!relatedDiv) return;
    
    try {
        relatedDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Finding related articles...
            </div>
        `;
        
        // Call vector similarity API
        const response = await fetch(`/api/vector-similar?uri=${encodeURIComponent(articleUri)}&top_k=5`);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const relatedArticles = result.results || [];
        
        if (relatedArticles.length === 0) {
            relatedDiv.innerHTML = `
                <div class="text-muted small">
                    <i class="fas fa-info-circle me-2"></i>
                    No related articles found
                </div>
            `;
            return;
        }
        
        let relatedHtml = '<ul class="list-unstyled mb-0">';
        relatedArticles.forEach((related) => {
            const metadata = related.metadata || {};
            const similarity = (related.score * 100).toFixed(0);
            const truncatedSummary = (metadata.summary || '').trim();
            const summaryShort = truncatedSummary ? escapeHTML(truncatedSummary.substring(0, 110)) + (truncatedSummary.length > 110 ? '' : '') : '';
            relatedHtml += `
                <li class="py-1 border-0">
                    <div class="d-flex align-items-start justify-content-between gap-2">
                        <div class="flex-grow-1">
                            <a href="${metadata.uri}" target="_blank" rel="noopener" class="text-decoration-none small fw-semibold">${escapeHTML(metadata.title || 'Untitled')}</a>
                            <div class="small text-muted">
                                <i class="fas fa-building me-1"></i>${escapeHTML(metadata.news_source || 'Unknown')}
                                ${metadata.category ? `<span class="ms-2 badge bg-light text-dark">${metadata.category}</span>` : ''}
                                ${metadata.bias ? `<span class="ms-1 badge ${getBiasClass(metadata.bias)}">${metadata.bias}</span>` : ''}
                                ${metadata.factual_reporting ? `<span class="ms-1 badge ${getFactualityClass(metadata.factual_reporting)}">${metadata.factual_reporting}</span>` : ''}
                            </div>
                            ${summaryShort ? `<div class="small text-secondary">${summaryShort}</div>` : ''}
                        </div>
                        <span class="badge bg-secondary align-self-start">${similarity}%</span>
                    </div>
                </li>`;
        });
        relatedHtml += '</ul>';
        
        relatedDiv.innerHTML = relatedHtml;
        relatedDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error loading related articles:', error);
        relatedDiv.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading related articles: ${error.message}
            </div>
        `;
    }
}

function formatMarkdownAnalysis(markdown) {
    // Convert markdown to HTML for better display
    let html = markdown;
    
    // Convert headers
    html = html.replace(/^### (.*$)/gm, '<h6 class="text-primary mt-3 mb-2">$1</h6>');
    html = html.replace(/^## (.*$)/gm, '<h5 class="text-primary mt-4 mb-3">$1</h5>');
    html = html.replace(/^# (.*$)/gm, '<h4 class="text-primary mt-4 mb-3">$1</h4>');
    
    // Convert bold text
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert bullet points
    html = html.replace(/^- (.*$)/gm, '<li class="mb-1">$1</li>');
    
    // Wrap consecutive list items in ul tags
    html = html.replace(/(<li.*?<\/li>\s*)+/g, '<ul class="mb-3">$&</ul>');
    
    // Convert paragraphs (double line breaks)
    html = html.replace(/\n\n/g, '</p><p class="mb-2">');
    html = '<p class="mb-2">' + html + '</p>';
    
    // Clean up empty paragraphs
    html = html.replace(/<p class="mb-2"><\/p>/g, '');
    html = html.replace(/<p class="mb-2">\s*<\/p>/g, '');
    
    // Convert horizontal rules
    html = html.replace(/^---$/gm, '<hr class="my-3">');
    
    // Clean up any remaining newlines
    html = html.replace(/\n/g, '<br>');
    
    return html;
}


// Enhanced markdown formatter for Auspex research results
function formatAuspexMarkdown(markdown) {
    if (!markdown || typeof markdown !== 'string') {
        return '<div class="text-muted">No content available</div>';
    }
    
    // Use marked.js for proper markdown rendering if available
    if (typeof marked !== 'undefined') {
        try {
            // Configure marked for better rendering
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            
            let html = marked.parse(markdown);
            
            // Add Bootstrap classes for better styling
            html = html.replace(/<table>/g, '<table class="table table-striped table-sm mt-3">');
            html = html.replace(/<h1>/g, '<h1 class="text-primary">');
            html = html.replace(/<h2>/g, '<h2 class="text-primary mt-4 mb-3">');
            html = html.replace(/<h3>/g, '<h3 class="text-primary mt-3 mb-2">');
            html = html.replace(/<h4>/g, '<h4 class="text-secondary mt-3 mb-2">');
            html = html.replace(/<h5>/g, '<h5 class="text-secondary mt-2 mb-2">');
            html = html.replace(/<h6>/g, '<h6 class="text-secondary mt-2 mb-1">');
            html = html.replace(/<ul>/g, '<ul class="mb-3">');
            html = html.replace(/<ol>/g, '<ol class="mb-3">');
            html = html.replace(/<li>/g, '<li class="mb-1">');
            html = html.replace(/<blockquote>/g, '<blockquote class="blockquote border-start border-primary ps-3 ms-3">');
            html = html.replace(/<code>/g, '<code class="bg-light text-dark px-1 rounded">');
            html = html.replace(/<pre>/g, '<pre class="bg-light p-3 rounded">');
            html = html.replace(/<hr>/g, '<hr class="my-4">');
            
            return html;
        } catch (error) {
            console.warn('Marked.js parsing failed, falling back to simple formatting:', error);
        }
    }
    
    // Fallback to simple formatting if marked.js isn't available
    return formatMarkdownAnalysis(markdown);
}

function generateEnhancedAnalysis(article) {
    let analysis = '';
    
    // Strategic insights section
    analysis += '<h6 class="text-primary mt-0 mb-2">Key Strategic Insights</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.category) {
        analysis += `<li class="mb-1">Categorized as <strong>${article.category}</strong>, indicating relevance to current sector developments</li>`;
    }
    
    if (article.time_to_impact && article.driver_type) {
        analysis += `<li class="mb-1">Expected <strong>${article.time_to_impact.toLowerCase()}</strong> impact, acting as a <strong>${article.driver_type.toLowerCase()}</strong> for related trends</li>`;
    }
    
    if (article.future_signal) {
        analysis += `<li class="mb-1">Signals <strong>${article.future_signal.toLowerCase()}</strong> future developments in the sector</li>`;
    }
    
    analysis += '</ul>';
    
    // Source credibility assessment
    analysis += '<h6 class="text-primary mb-2">Source Credibility</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.factual_reporting) {
        const factualityAssessment = article.factual_reporting.toLowerCase().includes('high') ? 'highly reliable' : 
                                   article.factual_reporting.toLowerCase().includes('mostly') ? 'generally reliable' :
                                   article.factual_reporting.toLowerCase().includes('mixed') ? 'moderately reliable' : 'reliability unclear';
        analysis += `<li class="mb-1">Factual reporting rated as <strong>${article.factual_reporting}</strong> - ${factualityAssessment}</li>`;
    }
    
    if (article.bias) {
        const biasImpact = article.bias.toLowerCase().includes('center') ? 'minimal bias impact on factual content' :
                          article.bias.toLowerCase().includes('left') ? 'may emphasize regulatory/social aspects' :
                          article.bias.toLowerCase().includes('right') ? 'may emphasize market/business aspects' : 'bias impact unclear';
        analysis += `<li class="mb-1">Political bias: <strong>${article.bias}</strong> - ${biasImpact}</li>`;
    }
    
    if (article.mbfc_credibility_rating) {
        analysis += `<li class="mb-1">Overall credibility: <strong>${article.mbfc_credibility_rating}</strong> rating</li>`;
    }
    
    analysis += '</ul>';
    
    // Strategic implications
    analysis += '<h6 class="text-primary mb-2">Strategic Implications</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.sentiment) {
        const sentimentImplication = article.sentiment.toLowerCase() === 'positive' ? 'suggests optimistic market outlook' :
                                   article.sentiment.toLowerCase() === 'negative' ? 'indicates potential challenges or concerns' :
                                   article.sentiment.toLowerCase() === 'critical' ? 'highlights significant issues requiring attention' :
                                   'presents balanced perspective';
        analysis += `<li class="mb-1">Sentiment is <strong>${article.sentiment.toLowerCase()}</strong> - ${sentimentImplication}</li>`;
    }
    
    // Add organizational context if available
    const profileSelect = document.getElementById('profile-select');
    if (profileSelect && profileSelect.value) {
        const selectedProfile = profileSelect.options[profileSelect.selectedIndex].text;
        analysis += `<li class="mb-1">For <strong>${selectedProfile}</strong>: Consider alignment with organizational risk tolerance and strategic priorities</li>`;
    }
    
    analysis += '</ul>';
    
    // Risk considerations
    analysis += '<h6 class="text-primary mb-2">Risk Considerations</h6>';
    analysis += '<ul class="mb-0">';
    
    if (article.bias && !article.bias.toLowerCase().includes('center')) {
        analysis += `<li class="mb-1">Source bias (${article.bias}) may influence framing - consider alternative perspectives</li>`;
    }
    
    if (article.time_to_impact && article.time_to_impact.toLowerCase().includes('long')) {
        analysis += `<li class="mb-1">Long-term impact timeline suggests gradual rather than immediate strategic implications</li>`;
    }
    
    if (!article.factual_reporting || article.factual_reporting.toLowerCase().includes('mixed')) {
        analysis += `<li class="mb-1">Factual reporting quality suggests verifying key claims with additional sources</li>`;
    }
    
    analysis += '<li class="mb-1">Consider this analysis alongside broader market trends and organizational context</li>';
    analysis += '</ul>';
    
    return analysis;
}

function generateSimpleAnalysisHTML(article) {
    // This version is for template rendering - returns HTML directly
    let analysis = '';
    
    // Sentiment analysis
    if (article.sentiment) {
        analysis += `<p class="mb-2 small"><strong>Sentiment:</strong> ${article.sentiment}`;
        if (article.sentiment_explanation) {
            analysis += ` - ${escapeHTML(article.sentiment_explanation)}`;
        }
        analysis += '</p>';
    }
    
    // Source quality
    if (article.bias && article.factual_reporting) {
        analysis += `<p class="mb-2 small"><strong>Source Quality:</strong> ${article.bias} bias, ${article.factual_reporting} factual reporting`;
        if (article.mbfc_credibility_rating) {
            analysis += `, ${article.mbfc_credibility_rating} credibility`;
        }
        analysis += '</p>';
    }
    
    // Impact timing
    if (article.time_to_impact) {
        analysis += `<p class="mb-2 small"><strong>Impact Timing:</strong> ${article.time_to_impact}`;
        if (article.driver_type) {
            analysis += ` (${article.driver_type})`;
        }
        analysis += '</p>';
    }
    
    // Future signals
    if (article.future_signal) {
        analysis += `<p class="mb-2 small"><strong>Future Signal:</strong> ${article.future_signal}</p>`;
    }
    
    return analysis || '<p class="mb-2 small text-muted">Limited metadata available.</p>';
}

function generateSimpleAnalysis(article) {
    let analysis = '';
    
    // Sentiment analysis
    if (article.sentiment) {
        analysis += `<p class="mb-2 small"><strong>Sentiment Analysis:</strong> This article has a ${article.sentiment.toLowerCase()} tone`;
        if (article.sentiment_explanation) {
            analysis += ` - ${article.sentiment_explanation}`;
        }
        analysis += '.</p>';
    }
    
    // Bias and factuality assessment
    if (article.bias && article.factual_reporting) {
        analysis += `<p class="mb-2 small"><strong>Source Quality:</strong> Published by a ${article.bias.toLowerCase()} source with ${article.factual_reporting.toLowerCase()} factual reporting standards`;
        if (article.mbfc_credibility_rating) {
            analysis += ` and ${article.mbfc_credibility_rating.toLowerCase()} credibility rating`;
        }
        analysis += '.</p>';
    }
    
    // Impact and timing analysis
    if (article.time_to_impact || article.driver_type) {
        analysis += `<p class="mb-2 small"><strong>Impact Assessment:</strong> `;
        if (article.time_to_impact) {
            analysis += `Expected to have ${article.time_to_impact.toLowerCase()} impact`;
        }
        if (article.driver_type) {
            analysis += `${article.time_to_impact ? ' and acts as a ' : 'Acts as a '}${article.driver_type.toLowerCase()} for related developments`;
        }
        analysis += '.</p>';
    }
    
    // Future signals
    if (article.future_signal) {
        analysis += `<p class="mb-2 small"><strong>Future Implications:</strong> This article signals ${article.future_signal.toLowerCase()} future developments in the ${article.category || 'relevant'} sector.</p>`;
    }
    
    // Category context
    if (article.category) {
        analysis += `<p class="mb-2 small"><strong>Thematic Context:</strong> Categorized under ${article.category}, indicating relevance to ongoing developments in this area.</p>`;
    }
    
    if (!analysis) {
        analysis = '<p class="mb-2 small text-muted">Limited metadata available for analysis.</p>';
    }
    
    return analysis;
}

// Generate research themes for sidebar
async function generateResearchThemes(articleUri) {
    const themesId = `themes-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const themesDiv = document.getElementById(themesId);
    
    if (!themesDiv || themesDiv.dataset.loaded) return;
    
    // Check for cached themes first
    const selectedModel = document.getElementById('model-select')?.value;
    try {
        const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(articleUri)}&analysis_type=themes&model=${encodeURIComponent(selectedModel)}`);
        if (cacheResponse.ok) {
            const cacheData = await cacheResponse.json();
            if (cacheData.cached && cacheData.metadata && cacheData.metadata.research_themes) {
                // Use cached structured themes
                const themes = cacheData.metadata.research_themes;
                let html = '<div class="d-flex flex-wrap gap-1">';
                themes.forEach((theme, index) => {
                    html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                            style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                            onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                            title="Launch Auspex research on: ${escapeHTML(theme)}">
                        <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                    </button>`;
                });
                html += '</div>';
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                html += `<small class="text-muted d-block mt-1" style="font-size: 8px;">Cached: ${cacheDate}</small>`;
                themesDiv.innerHTML = html;
                themesDiv.dataset.loaded = 'true';
                return;
            }
        }
    } catch (e) {
        console.warn('Failed to check themes cache, proceeding with generation:', e);
    }
    
    try {
        themesDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <small>Generating themes...</small>
            </div>
        `;
        
        const selectedModel = document.getElementById('model-select').value;
        
        const response = await fetch('/api/article-insights', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel || 'gpt-4o-mini',
                structured: true
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Research themes API response:', data);
        console.log('Response keys:', Object.keys(data));
        console.log('Has research_themes:', !!data.research_themes);
        console.log('Has response:', !!data.response);
        console.log('Structured flag sent:', true);
        
        console.log('Research themes array:', data.research_themes);
        console.log('Research themes length:', data.research_themes?.length);
        
        if (data.research_themes && data.research_themes.length > 0) {
            // Compact sidebar format - just theme buttons
            let html = '<div class="d-flex flex-wrap gap-1">';
            data.research_themes.forEach((theme, index) => {
                html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                        style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                        onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                        title="Launch Auspex research on: ${escapeHTML(theme)}">
                    <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                </button>`;
            });
            html += '</div>';
            html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
            themesDiv.innerHTML = html;
        } else if (data.response) {
            // Fallback to markdown - extract just themes
            const themesMatch = data.response.match(/## Research themes\n(.*?)(?=\n##|\n$)/s);
            if (themesMatch) {
                const themeLines = themesMatch[1].split('\n').filter(line => line.trim().startsWith('-'));
                let html = '<div class="d-flex flex-wrap gap-1">';
                themeLines.forEach(line => {
                    const theme = line.replace(/^-\s*/, '').trim();
                    if (theme) {
                        html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                                style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                                onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                                title="Launch Auspex research on: ${escapeHTML(theme)}">
                            <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                        </button>`;
                    }
                });
                html += '</div>';
                html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
                themesDiv.innerHTML = html;
            } else {
                themesDiv.innerHTML = '<small class="text-muted">No themes available</small>';
            }
        } else if (data.response) {
            // Try to extract themes from markdown response as fallback
            console.log('Attempting to parse themes from markdown response:', data.response);
            const themesMatch = data.response.match(/## Research themes\n(.*?)(?=\n##|\n$)/s);
            if (themesMatch) {
                const themeLines = themesMatch[1].split('\n').filter(line => line.trim().startsWith('-'));
                if (themeLines.length > 0) {
                    let html = '<div class="d-flex flex-wrap gap-1">';
                    themeLines.forEach(line => {
                        const theme = line.replace(/^-\s*/, '').trim();
                        if (theme) {
                            html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                                    style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                                    onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                                    title="Launch Auspex research on: ${escapeHTML(theme)}">
                                <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                            </button>`;
                        }
                    });
                    html += '</div>';
                    html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
                    themesDiv.innerHTML = html;
                } else {
                    themesDiv.innerHTML = '<small class="text-warning">No themes found in response</small>';
                }
            } else {
                themesDiv.innerHTML = '<small class="text-warning">Could not parse themes</small>';
            }
        } else {
            console.warn('No research themes or response in API data:', data);
            console.log('Full response object:', JSON.stringify(data, null, 2));
            
            // Show what we actually got for debugging
            if (data && typeof data === 'object') {
                const keys = Object.keys(data);
                themesDiv.innerHTML = `<small class="text-warning">Debug: Got keys: ${keys.join(', ')}</small>`;
            } else {
                themesDiv.innerHTML = '<small class="text-muted">API returned no data</small>';
            }
        }
        
        themesDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error generating research themes:', error);
        
        // Show clear error about server configuration
        themesDiv.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <small>Vector routes not mounted (404)</small>
            </div>
        `;
    }
}

// Generate deep dive analysis
async function generateDeepDive(articleUri) {
    try {
        const selectedModel = document.getElementById('model-select').value;
        if (!selectedModel) {
            showNotification('Select a valid AI model to generate deep-dive analysis', 'warning');
            return;
        }
        
        showNotification('Generating deep-dive analysis...', 'info');
        
        const response = await fetch('/api/article-deep-dive', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.response) {
            throw new Error('No deep-dive content received');
        }
        
        // Create a modal to show the deep dive
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-microscope me-2"></i>Deep-Dive Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="deep-dive-content">
                            ${formatMarkdownAnalysis(data.response)}
                        </div>
                        <div class="text-end mt-3">
                            <small class="text-muted">
                                Generated: ${data.generated_at ? new Date(data.generated_at).toLocaleString() : 'Just now'} | Model: ${selectedModel}
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
        
        showNotification('Deep-dive analysis generated successfully!', 'success');
        
    } catch (error) {
        console.error('Error generating deep dive:', error);
        showNotification(`Failed to generate deep-dive: ${error.message}`, 'error');
    }
}

// Check for cached analysis and show indicators
async function checkCachedAnalysisIndicators(articles) {
    const selectedModel = document.getElementById('model-select')?.value;
    if (!selectedModel || !articles || articles.length === 0) return;
    
    // Check cache for each article (database + localStorage fallback)
    for (const article of articles) {
        let hasCachedAnalysis = false;
        
        // Try database cache first
        try {
            const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(article.uri)}&analysis_type=summary&model=${encodeURIComponent(selectedModel)}`);
            if (cacheResponse.ok) {
                const cacheData = await cacheResponse.json();
                if (cacheData.cached) {
                    hasCachedAnalysis = true;
                }
            }
        } catch (e) {
            // Database failed, check localStorage
            try {
                const localCacheKey = `analysis_cache_${article.uri}_summary_${selectedModel}`;
                const localCache = localStorage.getItem(localCacheKey);
                if (localCache) {
                    const cacheData = JSON.parse(localCache);
                    const cacheAge = new Date() - new Date(cacheData.generated_at);
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
                    
                    if (cacheAge < maxAge) {
                        hasCachedAnalysis = true;
                    }
                }
            } catch (localError) {
                console.debug(`Local cache check failed for ${article.uri}:`, localError);
            }
        }
        
        // Show indicator if cached analysis found
        if (hasCachedAnalysis) {
            const indicator = document.getElementById(`cached-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (indicator) {
                indicator.style.display = 'inline';
            }
        }
    }
}

// Pagination and filtering variables
let allArticlesData = [];
let filteredArticlesData = [];
let currentPage = 1;
const articlesPerPage = 25;
let currentSort = 'date_asc';
let currentSearchTerm = '';

// Handle sort change
function handleSortChange() {
    currentSort = document.getElementById('sort-select').value;
    currentPage = 1; // Reset to first page
    applyFiltersAndDisplay();
}

// Handle search input with debouncing
let searchTimeout;
function handleSearchInput() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        currentSearchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        currentPage = 1; // Reset to first page
        applyFiltersAndDisplay();
    }, 300);
}

// Apply filters and display current page
function applyFiltersAndDisplay() {
    if (!allArticlesData || !Array.isArray(allArticlesData) || allArticlesData.length === 0) {
        console.warn('No valid articles data available for filtering');
        return;
    }
    
    // Filter articles based on search term
    filteredArticlesData = allArticlesData.filter(article => {
        if (!currentSearchTerm) return true;
        
        const searchableText = [
            article.title || '',
            article.summary || '',
            article.tags || '',
            article.category || ''
        ].join(' ').toLowerCase();
        
        return searchableText.includes(currentSearchTerm);
    });
    
    // Sort articles
    filteredArticlesData.sort((a, b) => {
        switch (currentSort) {
            case 'date_desc':
                return new Date(b.publication_date || 0) - new Date(a.publication_date || 0);
            case 'date_asc':
                return new Date(a.publication_date || 0) - new Date(b.publication_date || 0);
            case 'category_date':
                // Sort by category first, then by date within category
                if (a.category !== b.category) {
                    return (a.category || '').localeCompare(b.category || '');
                }
                return new Date(a.publication_date || 0) - new Date(b.publication_date || 0);
            default:
                return 0;
        }
    });
    
    // Update pagination info
    updatePaginationInfo();
    
    // Display current page
    displayCurrentPage();
}

// Update pagination information
function updatePaginationInfo() {
    const totalArticles = filteredArticlesData.length;
    const totalPages = Math.ceil(totalArticles / articlesPerPage);
    const start = (currentPage - 1) * articlesPerPage + 1;
    const end = Math.min(currentPage * articlesPerPage, totalArticles);
    
    document.getElementById('articles-start').textContent = totalArticles > 0 ? start : 0;
    document.getElementById('articles-end').textContent = end;
    document.getElementById('articles-total').textContent = totalArticles;
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages;
    
    // Update button states
    document.getElementById('prev-page-btn').disabled = currentPage <= 1;
    document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
    
    // Show/hide pagination container
    const paginationContainer = document.getElementById('pagination-container');
    if (paginationContainer) {
        paginationContainer.style.display = totalArticles > articlesPerPage ? 'flex' : 'none';
    }
}

// Display current page of articles
function displayCurrentPage() {
    const start = (currentPage - 1) * articlesPerPage;
    const end = start + articlesPerPage;
    const pageArticles = filteredArticlesData.slice(start, end);
    
    renderArticles({ items: pageArticles });
    
    // Check for cached analysis indicators
    checkCachedAnalysisIndicators(pageArticles);
}

// Pagination navigation
function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        displayCurrentPage();
        updatePaginationInfo();
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredArticlesData.length / articlesPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayCurrentPage();
        updatePaginationInfo();
    }
}

// Auto-load database articles on page load (no LLM generation)
async function autoLoadArticles() {
    try {
        console.log('Auto-loading database articles...');
        
        // Get current settings
        const dateRange = document.getElementById('date-range-select')?.value || '3m';
        const topic = document.getElementById('topic-select')?.value || '';
        
        // Convert date range to days for database query
        let days = 90; // Default
        if (dateRange.endsWith('d')) {
            days = parseInt(dateRange.replace('d', ''));
        } else if (dateRange.endsWith('h')) {
            days = Math.max(1, parseInt(dateRange.replace('h', '')) / 24);
        } else if (dateRange === '3m') {
            days = 90; // 3 months = 90 days
        } else if (dateRange === '1y') {
            days = 365; // 1 year = 365 days
        } else if (dateRange === 'all') {
            days = 9999; // Large number for "all time"
        }
        
        console.log(`Date range: ${dateRange} -> ${days} days back`);
        
        // Calculate actual start date for the API
        const now = new Date();
        const startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
        const dateParam = startDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        console.log(`Calculated date range: ${dateParam} to ${now.toISOString().split('T')[0]} (${days} days)`);
        
        // Build database query parameters to match news_feed_routes.py endpoint
        const params = new URLSearchParams({
            date_range: dateRange, // Use the original date_range parameter
            per_page: '100', // Match endpoint max limit
            page: '1',
            max_articles: '100'
        });
        
        if (topic) params.append('topic', topic);
        
        console.log(`API call: /api/news-feed/articles?${params.toString()}`);
        console.log(`Date range: ${dateRange} -> should get ${days} days of articles`);
        
        // Load articles directly from database (not LLM-generated)
        const response = await fetch(`/api/news-feed/articles?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Database articles loaded:', data);
        
        // Handle response structure
        let articles = [];
        if (Array.isArray(data)) {
            articles = data;
        } else if (data.articles) {
            // Check if data.articles is an array or has nested structure
            if (Array.isArray(data.articles)) {
                articles = data.articles;
            } else if (data.articles.items && Array.isArray(data.articles.items)) {
                articles = data.articles.items;
            } else if (data.articles.articles && Array.isArray(data.articles.articles)) {
                articles = data.articles.articles;
            } else {
                console.warn('data.articles is not an array:', data.articles);
                console.log('data.articles keys:', Object.keys(data.articles));
                articles = [];
            }
        } else if (data.items && Array.isArray(data.items)) {
            articles = data.items;
        } else if (data.results && Array.isArray(data.results)) {
            articles = data.results;
        } else {
            console.warn('Unexpected database response structure:', data);
            console.log('Available keys:', Object.keys(data));
            articles = [];
        }
        
        // Store all articles and initialize filtering
        allArticlesData = articles;
        currentPage = 1;
        
        // Also store in window.lastArticlesData for analysis functions
        window.lastArticlesData = { items: articles };
        
        console.log(`Loaded ${allArticlesData.length} database articles`);
        
        // Apply initial filters and display
        if (allArticlesData.length > 0) {
            applyFiltersAndDisplay();
        } else {
            // Show empty state
            const listContainer = document.getElementById('articles-list');
            if (listContainer) {
                listContainer.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Articles Found</h5>
                        <p class="text-muted">No articles found for the selected criteria.</p>
                        <small class="text-muted">Date range: ${dateRange}${topic ? `, Topic: ${topic}` : ''}</small>
                    </div>
                `;
            }
        }
        
        console.log(`Database articles auto-loaded: ${allArticlesData.length} total`);
        
    } catch (error) {
        console.error('Error auto-loading database articles:', error);
        
        // Show error in articles list
        const listContainer = document.getElementById('articles-list');
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Failed to Load Articles</h6>
                    <p class="mb-0">Error: ${error.message}</p>
                </div>
            `;
        }
    }
}

// Toggle controls panel visibility
function toggleControlsPanel() {
    const controlsContent = document.getElementById('controlsContent');
    const toggleIcon = document.getElementById('controlsToggleIcon');
    const isCollapsed = controlsContent.style.display === 'none';
    
    if (isCollapsed) {
        // Show controls
        controlsContent.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-up';
        localStorage.setItem('newsFeedControlsCollapsed', 'false');
    } else {
        // Hide controls
        controlsContent.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-down';
        localStorage.setItem('newsFeedControlsCollapsed', 'true');
    }
}

// Restore controls panel state
function restoreControlsState() {
    const isCollapsed = localStorage.getItem('newsFeedControlsCollapsed') === 'true';
    if (isCollapsed) {
        const controlsContent = document.getElementById('controlsContent');
        const toggleIcon = document.getElementById('controlsToggleIcon');
        
        if (controlsContent && toggleIcon) {
            controlsContent.style.display = 'none';
            toggleIcon.className = 'fas fa-chevron-down';
        }
    }
}

// Save all current settings as defaults
function saveCurrentAsDefaults() {
    try {
        const settings = {
            dateRange: document.getElementById('date-range-select')?.value,
            topic: document.getElementById('topic-select')?.value,
            model: document.getElementById('model-select')?.value,
            profile: document.getElementById('profile-select')?.value,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('newsFeedDefaults', JSON.stringify(settings));
        showNotification('Current settings saved as defaults!', 'success');
        console.log('Saved defaults:', settings);
    } catch (error) {
        console.error('Error saving defaults:', error);
        showNotification('Failed to save defaults', 'error');
    }
}

// Load saved defaults
function loadSavedDefaults() {
    try {
        const savedDefaults = localStorage.getItem('newsFeedDefaults');
        if (savedDefaults) {
            const settings = JSON.parse(savedDefaults);
            
            // Apply saved settings
            if (settings.dateRange) {
                const dateRangeEl = document.getElementById('date-range-select');
                if (dateRangeEl) dateRangeEl.value = settings.dateRange;
            }
            
            if (settings.topic) {
                const topicEl = document.getElementById('topic-select');
                if (topicEl) topicEl.value = settings.topic;
            }
            
            if (settings.model) {
                const modelEl = document.getElementById('model-select');
                if (modelEl) modelEl.value = settings.model;
            }
            
            console.log('Loaded saved defaults:', settings);
            return true;
        }
    } catch (error) {
        console.error('Error loading defaults:', error);
    }
    return false;
}

// Get the currently selected topic from the news feed
function getCurrentTopic() {
    const topicSelect = document.getElementById('topic-select');
    return topicSelect?.value || null;
}

// Launch Auspex research for a specific theme
async function launchAuspexResearch(theme, sourceArticleUri) {
    try {
        showNotification(`Launching Auspex research on: ${theme}`, 'info');
        
        // Get the article data to extract the actual topic and context
        const article = window.lastArticlesData?.items?.find(a => a.uri === sourceArticleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        // Use the article's topic, not the theme as topic
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning'; // Fallback to default topic
        
        console.log(`Research setup: Theme="${theme}", Topic="${actualTopic}", Article="${article.title}"`);
        
        // Create Auspex chat session with the actual topic
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Deep Research: ${theme}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Get the selected model from the news feed UI
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Build comprehensive research prompt with article context
        const researchPrompt = `Conduct a comprehensive analysis of "${theme}" using your tools to search recent articles, analyze trends, and provide strategic insights.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Summary: ${article.summary}
Why Interesting: ${article.why_interesting || 'Key insights for analysis'}

RESEARCH FOCUS: "${theme}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for recent articles related to "${theme}" in the topic "${actualTopic}"
2. Analyze current developments and key players in this space
3. Identify market trends and their implications
4. Assess future outlook and potential impacts
5. Provide strategic recommendations for decision-makers

The context article above sparked this research into "${theme}" - use it as a starting point but expand the analysis using your tools to find additional relevant articles and insights.

Provide a thorough analysis using the structured format from your system prompt.`;
        
        // Send initial research message
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: researchPrompt,
                model: selectedModel,
                limit: 50,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });
        
        if (!messageResponse.ok) {
            throw new Error(`Failed to send research message: ${messageResponse.status}`);
        }
        
        // Open Auspex chat modal and connect to the existing session
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));
        
        // Store the chat ID for the modal to use
        window.auspexActiveChatId = chatId;
        window.auspexActiveTheme = theme;
        
        // Set the topic and model in the modal properly
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');
        
        if (topicSelect) {
            topicSelect.value = actualTopic;
            // Trigger the change event to properly initialize the chat
            topicSelect.dispatchEvent(new Event('change'));
        }
        
        if (modelSelect) {
            modelSelect.value = selectedModel;
            // Trigger the change event to enable the chat input
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        // Enable the chat input and send button
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');
            
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Continue research on ${theme}...`;
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Clear existing messages and add our research status
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>Research Session Active</strong><br>
                        I'm conducting comprehensive research on "<strong>${theme}</strong>". 
                        The analysis has been started and results will appear here shortly...
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Analyzing articles and generating insights...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Open the modal
        auspexModal.show();
        
        // Start polling for the research results
        pollForAuspexResults(chatId, theme);
        
        showNotification(`Auspex research launched! Analyzing: ${theme}`, 'success');
        
        // Log for debugging
        console.log(`Launched Auspex research - Theme: ${theme}, Chat ID: ${chatId}, Source: ${sourceArticleUri}`);
        
    } catch (error) {
        console.error('Error launching Auspex research:', error);
        showNotification(`Failed to launch Auspex research: ${error.message}`, 'error');
    }
}

// Poll for Auspex research results
async function pollForAuspexResults(chatId, theme) {
    let pollCount = 0;
    const maxPolls = 60; // Poll for up to 1 minute
    const pollInterval = 2000; // Poll every 2 seconds
    
    const poll = async () => {
        try {
            // Get chat history to see if there are new messages
            const response = await fetch(`/api/auspex/chat/sessions/${chatId}/messages`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to get chat history: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            console.log(`Poll ${pollCount}: Response data:`, data);
            
            // Handle different response structures - the API returns {chat_id, messages, topic}
            const messages = data.messages || [];
            console.log(`Poll ${pollCount}: Got ${messages.length} messages for chat ${chatId}`);
            
            // Look for assistant messages (responses) - exclude system messages
            const assistantMessages = messages.filter(msg => msg.role === 'assistant' && msg.content && msg.content.trim().length > 0);
            console.log(`Poll ${pollCount}: Found ${assistantMessages.length} assistant messages`);
            
            // We need at least 2 messages: the initial system message and our research response
            if (assistantMessages.length > 0) {
                // Get the latest assistant message
                const latestResponse = assistantMessages[assistantMessages.length - 1];
                
                // Make sure it's not just an error message or empty response
                if (latestResponse.content && latestResponse.content.length > 50) {
                    displayAuspexResult(latestResponse.content, theme);
                    return; // Stop polling
                }
            }
            
            pollCount++;
            if (pollCount < maxPolls) {
                setTimeout(poll, pollInterval);
            } else {
                // Timeout - show error message
                displayAuspexTimeout(theme);
            }
            
        } catch (error) {
            console.error('Error polling for Auspex results:', error);
            displayAuspexError(error.message, theme);
        }
    };
    
    // Start polling after a brief delay
    setTimeout(poll, pollInterval);
}

// Display Auspex research result
function displayAuspexResult(content, theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        // Use marked.js for proper markdown rendering
        const formattedContent = formatAuspexMarkdown(content);
        
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Complete: ${theme}</strong><br>
                    <div class="mt-2 auspex-research-content">
                        ${formattedContent}
                    </div>
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    showNotification(`Research complete for: ${theme}`, 'success');
}

// Display timeout message
function displayAuspexTimeout(theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Timeout</strong><br>
                    The research for "${theme}" is taking longer than expected. You can continue chatting in this session - the results may still appear.
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// Display error message
function displayAuspexError(errorMessage, theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Error</strong><br>
                    There was an error with the research for "${theme}": ${errorMessage}
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// Load related articles for sidebar (headlines only)
async function loadRelatedArticlesSidebar(articleUri) {
    const sidebarId = `related-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const sidebarDiv = document.getElementById(sidebarId);
    
    if (!sidebarDiv || sidebarDiv.dataset.loaded) return;
    
    try {
        const response = await fetch(`/api/vector-similar?uri=${encodeURIComponent(articleUri)}&top_k=8`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const results = data.results || [];
        
        if (results.length > 0) {
            let html = '<div class="related-articles-compact">';
            results.forEach((related, index) => {
                if (index < 8) { // Show up to 8 in sidebar
                    html += `<div class="mb-1 d-flex align-items-center gap-1">
                        <a href="${related.id}" target="_blank" 
                           class="text-decoration-none small flex-grow-1"
                           style="font-size: 10px; line-height: 1.2; color: #0066cc;"
                           title="${escapeHTML(related.metadata?.title || 'Related article')}">
                            <i class="fas fa-external-link-alt me-1 text-muted"></i>
                            ${escapeHTML((related.metadata?.title || 'Related article').substring(0, 50))}${(related.metadata?.title || '').length > 50 ? '...' : ''}
                        </a>
                        <button class="btn btn-outline-primary btn-sm" 
                                style="font-size: 8px; padding: 0px 2px; line-height: 1;"
                                onclick="loadRelatedArticleAnalysis('${related.id}')"
                                title="Analyze this related article">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>`;
                }
            });
            html += '</div>';
            sidebarDiv.innerHTML = html;
        } else {
            sidebarDiv.innerHTML = '<small class="text-muted">No related articles</small>';
        }
        
        sidebarDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error loading related articles for sidebar:', error);
        sidebarDiv.innerHTML = '<small class="text-warning">Failed to load</small>';
    }
}

// Open annotation modal
function openAnnotationModal(articleUri) {
    // Create annotation modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'annotationModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sticky-note me-2"></i>Add Annotation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Article URL</label>
                        <input type="url" class="form-control" value="${articleUri}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Annotation</label>
                        <textarea class="form-control" id="annotationContent" rows="4" 
                                  placeholder="Add your analysis or comments..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="annotationPrivate">
                        <label class="form-check-label" for="annotationPrivate">
                            Private note (not included in analysis)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAnnotationFromModal('${articleUri}')">
                        <i class="fas fa-save me-1"></i>Save Annotation
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal after it's hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Save annotation from modal
async function saveAnnotationFromModal(articleUri) {
    const content = document.getElementById('annotationContent').value.trim();
    const isPrivate = document.getElementById('annotationPrivate').checked;
    
    if (!content) {
        showNotification('Please enter annotation content', 'warning');
        return;
    }
    
    try {
        const doubleEncodedUri = encodeURIComponent(encodeURIComponent(articleUri));
        
        const response = await fetch(`/api/articles/${doubleEncodedUri}/annotations`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content,
                is_private: isPrivate
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || 'Failed to save annotation');
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('annotationModal'));
        modal.hide();
        
        showNotification('Annotation saved successfully!', 'success');
        
    } catch (error) {
        console.error('Error saving annotation:', error);
        showNotification(`Failed to save annotation: ${error.message}`, 'error');
    }
}

// Load related article analysis in-app
async function loadRelatedArticleAnalysis(articleUri) {
    try {
        showNotification('Loading related article analysis...', 'info');
        
        // Find if this article is already in our current dataset
        const existingArticle = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        
        if (existingArticle) {
            // Article already loaded - just scroll to it and expand
            const articleElement = document.querySelector(`[onclick*="${articleUri}"]`);
            if (articleElement) {
                articleElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Trigger expansion
                const expandButton = articleElement.closest('.list-group-item').querySelector('.expand-arrow-btn');
                if (expandButton && expandButton.querySelector('i').className.includes('chevron-right')) {
                    expandButton.click();
                }
                showNotification('Scrolled to related article', 'success');
                return;
            }
        }
        
        // Article not in current view - load it in a modal
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Get article analysis
        const response = await fetch('/api/vector-summary-raw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to load article: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Create modal to show the related article
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-newspaper me-2"></i>Related Article Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="related-article-content">
                            ${formatMarkdownAnalysis(data.response || 'Analysis not available')}
                        </div>
                        <div class="text-end mt-3">
                            <small class="text-muted">
                                <a href="${articleUri}" target="_blank" class="text-decoration-none">
                                    <i class="fas fa-external-link-alt me-1"></i>View original article
                                </a>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
        
        showNotification('Related article loaded', 'success');
        
    } catch (error) {
        console.error('Error loading related article:', error);
        showNotification(`Failed to load related article: ${error.message}`, 'error');
    }
}

// Launch Auspex Deep Dive analysis
async function launchAuspexDeepDive(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching Auspex deep-dive analysis...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Deep Dive: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build deep dive prompt using the deepdiveprompt.md template
        const deepDivePrompt = `Conduct a comprehensive deep-dive analysis of the topic covered in this article using the Deep Dive Template framework.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Date: ${article.date}
Summary: ${article.summary}
Why Interesting: ${article.why_interesting || 'Key insights for analysis'}

DEEP DIVE INSTRUCTIONS:
Use your tools to search for articles related to the themes in this article and conduct a comprehensive analysis following the Deep Dive Template structure:

1. Topic Definition & Context Setting
2. Multi-Dimensional Analysis (4-5 relevant dimensions)
3. Strategic Summary Analysis  
4. Consensus vs Industry Narrative Comparison
5. Strategic Breakdown & Evidence
6. Synthesis & Strategic Insights
7. Final Assessment

Focus on providing evidence-based analysis grounded in multiple sources, not just the context article. Use your search tools to find related articles and build a comprehensive picture.

Target length: 900-1200 words with specific data points and strategic insights.`;
        
        await launchAuspexWithPrompt(chatId, deepDivePrompt, selectedModel, actualTopic, 'Deep Dive Analysis');
        
    } catch (error) {
        console.error('Error launching deep dive:', error);
        showNotification(`Failed to launch deep dive: ${error.message}`, 'error');
    }
}

// Launch Consensus vs Fringe Voices analysis
async function launchConsensusAnalysis(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching consensus vs fringe analysis...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Consensus Analysis: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Extract key claims from the article
        const consensusPrompt = `Analyze the consensus vs fringe voices regarding the claims made in this article.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Summary: ${article.summary}

CONSENSUS ANALYSIS INSTRUCTIONS:
1. Identify the key claims or predictions made in this article
2. Use your tools to search for related articles in the topic "${actualTopic}"
3. Analyze whether these claims represent:
   - Mainstream consensus (majority view)
   - Emerging consensus (growing agreement)
   - Fringe perspective (minority/outlier view)
   - Mixed views (no clear consensus)

4. Provide evidence-based analysis showing:
   - What the consensus actually says about these topics
   - How this article's perspective compares to the broader evidence
   - Timeline consensus (when impacts are expected)
   - Confidence levels in different scenarios
   - Notable outlier perspectives (both optimistic and pessimistic)

5. Structure your response with clear sections showing the comparison between this article's claims and the broader consensus patterns.

Use your search and analysis tools to gather comprehensive evidence from multiple sources.`;
        
        await launchAuspexWithPrompt(chatId, consensusPrompt, selectedModel, actualTopic, 'Consensus Analysis');
        
    } catch (error) {
        console.error('Error launching consensus analysis:', error);
        showNotification(`Failed to launch consensus analysis: ${error.message}`, 'error');
    }
}

// Launch Impact Timeline analysis
async function launchTimelineAnalysis(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching impact timeline analysis...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Timeline Analysis: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Extract themes and build timeline prompt
        const timelinePrompt = `Analyze the impact timeline and strategic planning horizons for the themes discussed in this article.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Category: ${article.category || 'Not specified'}
Future Signal: ${article.future_signal || 'Not specified'}
Time to Impact: ${article.time_to_impact || 'Not specified'}
Summary: ${article.summary}

TIMELINE ANALYSIS INSTRUCTIONS:
1. Identify the key themes and developments mentioned in this article
2. Use your tools to search for related articles in "${actualTopic}" to build a comprehensive timeline
3. Create strategic planning horizons showing:
   - Immediate impacts (2025)
   - Short-term developments (2025-2027)
   - Mid-term transformations (2027-2030)
   - Long-term implications (2030-2035+)

4. For each timeframe, provide:
   - Key milestones and decision points
   - Strategic implications for decision-makers
   - Risk and opportunity windows
   - Evidence from multiple sources

5. Structure your analysis to help strategic planning with specific timelines, actionable insights, and evidence-based projections.

Use your search and analysis tools to gather comprehensive timeline evidence from multiple sources.`;
        
        await launchAuspexWithPrompt(chatId, timelinePrompt, selectedModel, actualTopic, 'Timeline Analysis');
        
    } catch (error) {
        console.error('Error launching timeline analysis:', error);
        showNotification(`Failed to launch timeline analysis: ${error.message}`, 'error');
    }
}

// Common function to launch Auspex with a specific prompt
async function launchAuspexWithPrompt(chatId, prompt, model, topic, analysisType) {
    try {
        // Send the analysis prompt
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: prompt,
                model: model,
                limit: 50,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });
        
        if (!messageResponse.ok) {
            throw new Error(`Failed to send analysis message: ${messageResponse.status}`);
        }
        
        // Open Auspex modal and set up the session
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));
        
        // Set the topic and model in the modal properly
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');
        
        if (topicSelect) {
            topicSelect.value = topic;
            topicSelect.dispatchEvent(new Event('change'));
        }
        
        if (modelSelect) {
            modelSelect.value = model;
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        // Enable the chat input and send button
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');
            
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Continue ${analysisType.toLowerCase()}...`;
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Clear existing messages and add our analysis status
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>${analysisType} Active</strong><br>
                        I'm conducting comprehensive ${analysisType.toLowerCase()} analysis. 
                        The analysis has been started and results will appear here shortly...
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Analyzing articles and generating insights...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Open the modal
        auspexModal.show();
        
        // Start polling for the analysis results
        pollForAuspexResults(chatId, analysisType);
        
        showNotification(`${analysisType} launched successfully!`, 'success');
        
    } catch (error) {
        console.error(`Error launching ${analysisType}:`, error);
        showNotification(`Failed to launch ${analysisType}: ${error.message}`, 'error');
    }
}

function toggleStarArticle(articleUri, buttonElement) {
    if (starredArticles.has(articleUri)) {
        // Remove star
        starredArticles.delete(articleUri);
        buttonElement.classList.remove('starred');
        buttonElement.style.background = 'rgba(255, 193, 7, 0.1)';
        buttonElement.style.color = '#ffc107';
        buttonElement.title = 'Add to Six Articles';
        showNotification('Article removed from Six Articles selection', 'info');
    } else {
        // Add star
        if (starredArticles.size >= 6) {
            showNotification('Maximum 6 articles can be starred for Six Articles analysis', 'warning');
            return;
        }
        
        starredArticles.add(articleUri);
        buttonElement.classList.add('starred');
        buttonElement.style.background = '#ffc107';
        buttonElement.style.color = 'white';
        buttonElement.title = 'Remove from Six Articles';
        showNotification('Article added to Six Articles selection', 'success');
    }
    
    updateStarredCount();
}

function updateStarredCount() {
    // Update any UI elements that show starred count
    const starredCount = starredArticles.size;
    
    // Update six articles tab to show starred count
    const sixArticlesTab = document.getElementById('six-articles-tab');
    if (sixArticlesTab) {
        const originalText = sixArticlesTab.textContent.replace(/ \(\d+\)$/, '');
        sixArticlesTab.textContent = starredCount > 0 ? `${originalText} (${starredCount})` : originalText;
    }
    
    // Show warning if more than 6 are starred (shouldn't happen due to limit, but safety check)
    if (starredCount > 6) {
        showNotification('Too many articles starred! Please unstar some to keep 6 or fewer.', 'danger');
    }
}

// Helper functions for bias and factuality display
function getBiasClass(bias) {
    if (!bias) return 'bg-light text-dark';

    const biasClasses = {
        'left': 'bg-primary',
        'left-center': 'bg-info',
        'center': 'bg-secondary',
        'right-center': 'bg-warning text-dark',
        'right': 'bg-danger',
        'mixed': 'bg-dark'
    };

    return biasClasses[bias.toLowerCase()] || 'bg-light text-dark';
}

function getFactualityClass(factuality) {
    if (!factuality) return 'bg-light text-dark';

    const factualityClasses = {
        'very high': 'bg-success',
        'high': 'bg-success',
        'mostly factual': 'bg-info',
        'mixed': 'bg-warning text-dark',
        'low': 'bg-danger',
        'very low': 'bg-danger'
    };

    return factualityClasses[factuality.toLowerCase()] || 'bg-light text-dark';
}

// Add CSS for filter badges
const style = document.createElement('style');
style.textContent = `
    .filter-badge {
        transition: all 0.2s ease;
        opacity: 0.7;
        border: 1px solid transparent;
    }
    
    .filter-badge:hover {
        opacity: 1;
        transform: translateY(-1px);
    }
    
    .filter-badge.active {
        opacity: 1;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }
    
    .selected-date-compact {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        background: rgba(0,123,255,0.1);
        border-radius: 4px;
        border: 1px solid rgba(0,123,255,0.2);
    }
`;
document.head.appendChild(style);

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing news feed...');
    
    // Restore controls state first
    restoreControlsState();
    
    // Load saved defaults
    loadSavedDefaults();
    
    // Load calendar and other data
    loadAvailableDates();
    
    // Load organizational profiles (this will restore profile selection)
    loadOrganizationalProfiles();
    
    // Initialize article count for default date range
    updateArticleCountForDateRange();
    
    // Auto-load articles with 90-day default
    setTimeout(() => {
        autoLoadArticles();
    }, 1000); // Delay to ensure all settings are loaded
});

// Helper function for sentiment styling
function getSentimentClass(sentiment) {
    if (!sentiment) return 'bg-light text-dark';
    const sentimentLower = sentiment.toLowerCase();
    if (sentimentLower.includes('positive')) return 'bg-success text-white';
    if (sentimentLower.includes('negative') || sentimentLower.includes('critical')) return 'bg-danger text-white';
    if (sentimentLower.includes('neutral')) return 'bg-secondary text-white';
    return 'bg-light text-dark';
}

// Launch Ask Auspex chat with article context
async function launchAuspexChat(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Setting up Auspex chat for this article...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Article Discussion: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Get the current analysis if available
        const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const analysisDiv = document.getElementById(analysisId);
        const existingAnalysis = analysisDiv?.querySelector('.analysis-text')?.textContent || 'No analysis available yet';
        
        // Build context prompt with article and analysis
        const contextPrompt = `I'd like to discuss this article with you. Here's the full context:

ARTICLE DETAILS:
Title: ${article.title}
Source: ${article.source}
Date: ${article.date}
URL: ${article.uri}
Category: ${article.category || 'Not specified'}
Sentiment: ${article.sentiment || 'Not specified'}
Future Signal: ${article.future_signal || 'Not specified'}
Time to Impact: ${article.time_to_impact || 'Not specified'}
Driver Type: ${article.driver_type || 'Not specified'}
Tags: ${article.tags || 'None'}

ARTICLE SUMMARY:
${article.summary}

CURRENT ANALYSIS:
${existingAnalysis}

I'm ready to discuss this article with you. You can use your tools to search for related information, analyze trends, or dive deeper into any aspect of this article. What would you like to explore?`;
        
        // Send the context message
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: contextPrompt,
                model: selectedModel,
                limit: 50,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });
        
        if (!messageResponse.ok) {
            throw new Error(`Failed to send context message: ${messageResponse.status}`);
        }
        
        // Open Auspex modal and set it up for conversation
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));
        
        // Set the topic and model in the modal
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');
        
        if (topicSelect) {
            topicSelect.value = actualTopic;
            topicSelect.dispatchEvent(new Event('change'));
        }
        
        if (modelSelect) {
            modelSelect.value = selectedModel;
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        // Enable the chat input for continued conversation
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');
            
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Ask me anything about: ${article.title.substring(0, 50)}...`;
                chatInput.focus();
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Show initial message
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>Article Context Loaded</strong><br>
                        I've analyzed the article "<strong>${article.title}</strong>" and I'm ready to discuss it with you.
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Processing article context...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Open the modal
        auspexModal.show();
        
        // Poll for the context response, then enable chat
        pollForAuspexResults(chatId, 'Article Context');
        
        showNotification('Auspex chat ready for article discussion!', 'success');
        
    } catch (error) {
        console.error('Error launching Auspex chat:', error);
        showNotification(`Failed to launch Auspex chat: ${error.message}`, 'error');
    }
}

</script>

{% endblock %}
