{% extends 'base.html' %}
{% block title %}News Narrator{% endblock %}

{% block extra_js %}
<!-- Marked.js for markdown rendering in insights -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block content %}
<style>
/* Techmeme-inspired minimalist design */
.news-feed-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}

.news-header {
    border-bottom: 3px solid #000;
    margin-bottom: 30px;
    padding-bottom: 15px;
}

.news-title {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0;
    color: #000;
}

.news-date {
    font-size: 0.9rem;
    color: #666;
    margin-top: 5px;
}

.news-nav {
    margin: 20px 0;
    border-bottom: 1px solid #ddd;
}

.nav-tabs {
    border-bottom: none;
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #666;
    font-weight: 500;
    padding: 10px 20px;
    background: none;
}

.nav-tabs .nav-link.active {
    border-bottom-color: #000;
    color: #000;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #999;
    color: #333;
}

.story-item {
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 1px solid #eee;
}

.story-item:last-child {
    border-bottom: none;
}

.story-headline {
    font-size: 1.4rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 10px;
    color: #000;
}

.story-headline a {
    color: inherit;
    text-decoration: none;
}

.story-headline a:hover {
    color: #0066cc;
}

.story-summary {
    font-size: 1rem;
    color: #333;
    margin-bottom: 15px;
}

.story-meta {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 10px;
}

.source-info {
    display: inline-block;
    margin-right: 15px;
}

.bias-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 5px;
}

.bias-left { background: #e3f2fd; color: #1976d2; }
.bias-left-center { background: #e8f5e8; color: #388e3c; }
.bias-center { background: #f3e5f5; color: #7b1fa2; }
.bias-right-center { background: #fff3e0; color: #f57c00; }
.bias-right { background: #ffebee; color: #d32f2f; }
.bias-mixed { background: #f5f5f5; color: #616161; }

.factuality-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 5px;
}

.factuality-very-high { background: #e8f5e8; color: #2e7d32; }
.factuality-high { background: #e8f5e8; color: #388e3c; }
.factuality-mostly-factual { background: #f3e5f5; color: #7b1fa2; }
.factuality-mixed { background: #fff3e0; color: #f57c00; }
.factuality-low { background: #ffebee; color: #d32f2f; }

.related-articles {
    margin-top: 15px;
    padding-left: 20px;
    border-left: 3px solid #eee;
}

.related-articles h6 {
    font-size: 0.85rem;
    font-weight: 600;
    color: #666;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.related-item {
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.related-item a {
    color: #0066cc;
    text-decoration: none;
}

.related-item a:hover {
    text-decoration: underline;
}

.controls {
    background: var(--bs-light);
    padding: 1rem;
    border-radius: var(--bs-border-radius);
    margin-bottom: 2rem;
}

.controls-row {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.control-group-inline {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.control-group-inline label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--bs-dark);
    margin: 0;
    white-space: nowrap;
}

.selected-date-compact {
    font-size: 0.9rem;
    color: var(--bs-primary);
    margin-right: 0.5rem;
}

/* Bootstrap-based Calendar Styles */
#calendar-container {
    max-width: 400px;
    width: 100%;
    margin-top: 8px;
}

#calendar-view {
    max-width: 100%;
}

.calendar-month {
    margin-bottom: 1rem;
}

.calendar-month-header {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--bs-dark);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--bs-border-color);
    text-align: center;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 0.5rem;
    width: 100%;
    max-width: 350px;
}

.calendar-day-header {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--bs-secondary);
    padding: 0.25rem;
    background-color: var(--bs-light);
    border-radius: var(--bs-border-radius-sm);
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    border-radius: var(--bs-border-radius);
    cursor: default;
    position: relative;
    min-height: 32px;
    border: 1px solid transparent;
}

.calendar-day.has-articles {
    background-color: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
    cursor: pointer;
    font-weight: 600;
    border: 1px solid var(--bs-primary-border-subtle);
}

.calendar-day.has-articles:hover {
    background-color: var(--bs-primary);
    color: var(--bs-white);
    transform: scale(1.05);
    transition: all 0.15s ease-in-out;
}

.calendar-day.selected {
    background-color: var(--bs-primary) !important;
    color: var(--bs-white) !important;
    border-color: var(--bs-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

.calendar-day.other-month {
    color: var(--bs-secondary);
    opacity: 0.5;
}

.calendar-day.has-articles .badge {
    position: absolute;
    bottom: 1px;
    right: 1px;
    font-size: 0.6rem;
    padding: 0.1rem 0.25rem;
    line-height: 1;
}

.calendar-day.selected .badge {
    background-color: var(--bs-white) !important;
    color: var(--bs-primary) !important;
}

/* Old control-group styles removed - now using control-group-inline */

.form-select, .form-control {
    font-size: 0.9rem;
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.btn {
    font-size: 0.9rem;
    padding: 6px 12px;
    border-radius: 3px;
    font-weight: 500;
}

.btn-primary {
    background: #000;
    border-color: #000;
}

.btn-primary:hover {
    background: #333;
    border-color: #333;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.error-message {
    background: #ffebee;
    color: #c62828;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.executive-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 30px;
    border-left: 4px solid #000;
}

.key-themes {
    margin-bottom: 30px;
}

.key-themes h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: #000;
}

.theme-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.theme-tag {
    background: #e9ecef;
    color: #495057;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 500;
}

.perspective-breakdown {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
}

.perspective-breakdown h6 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: #000;
}

.perspective-item {
    margin-bottom: 8px;
    font-size: 0.85rem;
}

.perspective-label {
    font-weight: 600;
    text-transform: capitalize;
    margin-right: 8px;
}

@media (max-width: 768px) {
    .news-feed-container {
        padding: 15px;
    }
    
    .news-title {
        font-size: 1.8rem;
    }
    
    .story-headline {
        font-size: 1.2rem;
    }
    
    .controls-row {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .control-group-inline {
        justify-content: space-between;
        width: 100%;
    }
    
    .control-group-inline input,
    .control-group-inline select {
        width: auto !important;
        flex: 1;
        margin-left: 1rem;
    }
    }

    /* Add styles for metadata tags like topic_dashboard.html */
    .metadata-tag {
        display: inline-block;
        padding: 0.2em 0.6em;
        margin-right: 0.3em;
        margin-bottom: 0.3em;
        font-size: 0.75em;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        border: 1px solid transparent;
    }

    .tag-category {
        background-color: #e6f3ff;
        color: #0066cc;
        border-color: #99ccff;
    }

    .tag-driver {
        background-color: #fff0e6;
        color: #cc6600;
        border-color: #ffcc99;
    }

    .tag-tti {
        background-color: #f0f0ff;
        color: #4b0082;
        border-color: #c0c0ff;
    }

    .tag-sentiment {
        border-width: 1px;
        border-style: solid;
    }

    .sentiment-critical {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .sentiment-hyperbolic {
        background-color: #fffae6;
        color: #997a00;
        border-color: #ffe680;
    }

    .sentiment-mixed {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }

    .sentiment-positive { background-color: #d1e7dd; color: #0a5132; border: 1px solid #a3cfbb; }
    .sentiment-negative { background-color: #f8d7da; color: #842029; border: 1px solid #f1aeb5; }
    .sentiment-neutral { background-color: #e2e3e5; color: #41464b; border: 1px solid #c3c6ca; }
    .sentiment-unknown { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }

    /* Bias tags */
    .tag-bias-left {
        background-color: #e6f2ff;
        color: #0066cc;
        border-color: #99ccff;
    }

    .tag-bias-right {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .tag-bias-center {
        background-color: #f0f0ff;
        color: #4b0082;
        border-color: #c0c0ff;
    }

    .tag-bias-factual {
        background-color: #e6ffe6;
        color: #006600;
        border-color: #99ff99;
    }

    .tag-bias-unknown {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }

    /* Factual reporting tags */
    .tag-factual-high {
        background-color: #e6ffe6;
        color: #006600;
        border-color: #99ff99;
    }

    .tag-factual-mostly {
        background-color: #f0fff0;
        color: #228b22;
        border-color: #90ee90;
    }

    .tag-factual-mixed {
        background-color: #fffae6;
        color: #997a00;
        border-color: #ffe680;
    }

    .tag-factual-low {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .tag-factual-unknown {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }

    /* Insights Tab Styling */
    .insights-nav .nav-link {
        border: 1px solid #ddd;
        border-radius: 8px;
        margin: 0 2px;
        color: #666;
        font-weight: 500;
        padding: 8px 16px;
        transition: all 0.2s ease;
    }

    .insights-nav .nav-link.active {
        background-color: #000;
        border-color: #000;
        color: white;
    }

    .insights-nav .nav-link:hover:not(.active) {
        background-color: #f8f9fa;
        border-color: #999;
        color: #333;
    }

    /* Insight Card Styling - matching topic dashboard */
    .insight-item-card {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        flex: 1 1 320px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        background-color: #fff;
        min-width: 300px;
        max-width: 400px;
    }

    .insight-item-card h6 {
        font-size: 1rem;
        color: var(--bs-primary);
        margin-bottom: 0.75rem;
    }

    .insight-item-card p {
        font-size: 0.9rem;
        flex-grow: 1;
        max-height: 200px;
        overflow-y: auto;
        word-wrap: break-word;
        margin-bottom: 0.5rem;
    }

    .insight-content {
        width: 100%;
    }

    .insight-content ul, .insight-content ol {
        padding-left: 1.5rem;
    }

    .insight-content p {
        margin-bottom: 0.5rem;
    }

    /* Category Insights Grid */
    #category-insights-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.25rem;
        width: 100%;
        box-sizing: border-box;
    }

    #category-insights-container .insight-item-card {
        margin-bottom: 0;
    }

    /* Thematic Clustering Styles */
    .thematic-cluster {
        background: linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
        border-left: 4px solid #FF69B4;
    }

    .cluster-article-list {
        max-height: 200px;
        overflow-y: auto;
        border-top: 1px solid #e9ecef;
        margin-top: 12px;
        padding-top: 12px;
    }

    .cluster-article-item {
        padding: 8px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-size: 0.85rem;
    }

    .cluster-article-item:last-child {
        border-bottom: none;
    }

    .cluster-article-item a {
        color: #333;
        text-decoration: none;
        font-weight: 500;
    }

    .cluster-article-item a:hover {
        color: #FF69B4;
        text-decoration: underline;
    }

    .cluster-stats {
        display: flex;
        gap: 16px;
        margin-top: 12px;
        font-size: 0.8rem;
        color: #343a40;
    }

    .cluster-stat {
        display: flex;
        align-items: center;
        gap: 4px;
    }
</style>

<div class="news-feed-container">
    <!-- Header -->
    <div class="news-header">
        <h1 class="news-title">News Narrator</h1>
        <div class="news-date" id="current-date"></div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
                <i class="fas fa-cogs me-2"></i>Configuration
            </h6>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleControlsBtn" onclick="toggleControlsPanel()">
                <i class="fas fa-chevron-up" id="controlsToggleIcon"></i>
            </button>
        </div>
        <div id="controlsContent">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Date Range:</label>
                            <select id="date-range-select" class="form-select form-select-sm" onchange="handleDateRangeChange()">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                                <option value="3m" selected>Last 90 Days</option>
                    <option value="1y">Last Year</option>
                    <option value="all">All Time</option>
                    <option value="custom">Custom Date</option>
                </select>
            </div>
                        <div class="col-6">
                            <label class="form-label small">Topic:</label>
                            <select id="topic-select" class="form-select form-select-sm">
                                <option value="">All Topics</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div id="date-range-display" class="small text-muted">
                            <i class="fas fa-clock"></i> <strong id="date-range-text">Last 90 Days</strong> 
                    (<span id="selected-date-count">loading...</span> articles)
                </div>
                <div id="custom-date-section" style="display: none;" class="mt-1">
                            <input type="date" id="custom-date-input" class="form-control form-control-sm" value="2025-09-15">
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-1" data-bs-toggle="collapse" data-bs-target="#calendar-collapse">
                        <i class="fas fa-calendar-alt"></i>
                </button>
                </div>
            </div>
            </div>
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Model:</label>
                            <select id="model-select" class="form-select form-select-sm">
                    <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                    <option value="gpt-4.1">GPT-4.1</option>
                    <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                    <option value="claude-4-sonnet-latest">Claude 4 Sonnet</option>
                    <option value="claude-3-5-sonnet-latest">Claude 3.5 Sonnet</option>
                    <option value="gemini-pro">Gemini Pro</option>
                </select>
            </div>
                        <div class="col-6">
                            <label class="form-label small">Profile:</label>
                            <div class="d-flex gap-1">
                                <select id="profile-select" class="form-select form-select-sm">
                                    <option value="">General Analysis</option>
                    </select>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadOrganizationalProfiles()" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                </div>
            </div>
                    <div class="mt-2">
                        
                    <div class="mt-2 d-flex gap-2">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="saveCurrentAsDefaults()" title="Save current settings as defaults">
                            <i class="fas fa-star"></i> Save Defaults
                </button>
                        <button id="restore-articles-btn" class="btn btn-outline-warning btn-sm" onclick="clearExcludedArticles()" style="display: none;" title="Restore hidden articles">
                    <i class="fas fa-undo"></i> Restore Hidden
                </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Collapsible Calendar -->
        <div class="collapse mt-3" id="calendar-collapse">
            <div class="card" style="max-width: 400px;">
                <div class="card-body">
                    <div id="calendar-loading" class="text-center text-muted p-3">
                        <i class="fas fa-spinner fa-spin"></i> Loading available dates...
                    </div>
                    <div id="calendar-view" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <input type="hidden" id="selected-date" value="2025-09-15" />
    </div>

    <!-- Navigation -->
    <div class="news-nav">
        <ul class="nav nav-tabs" id="news-tabs">
            <li class="nav-item">
                <a class="nav-link active" id="insights-tab" data-bs-toggle="tab" href="#insights-content">Narrative Explorer</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="articles-tab" data-bs-toggle="tab" href="#articles-content">Article Investigator</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="six-articles-tab" data-bs-toggle="tab" href="#six-articles-content">Six Articles</a>
            </li>
        </ul>
    </div>

    <!-- Content -->
    <div class="tab-content" id="news-content">
        <!-- Articles Tab -->
        <div class="tab-pane fade" id="articles-content">
            <div id="articles-loading" class="loading" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Loading articles...</div>
            </div>
            <div id="articles-error" class="error-message" style="display: none;"></div>
            
            <!-- Filter Section -->
            <div id="articles-filters" class="mb-3" style="display: none;">
                <div class="d-flex flex-wrap gap-2 align-items-center p-2 bg-light rounded">
                    <span class="text-muted small fw-bold">Filters:</span>
                    <div class="d-flex align-items-center gap-1">
                        <span class="text-muted small">Bias:</span>
                        <div id="bias-filters" class="d-flex flex-wrap gap-1"></div>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <span class="text-muted small">Factuality:</span>
                        <div id="factuality-filters" class="d-flex flex-wrap gap-1"></div>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <span class="text-muted small">Category:</span>
                        <div id="category-filters" class="d-flex flex-wrap gap-1"></div>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <span class="text-muted small">Signals:</span>
                        <div id="signal-filters" class="d-flex flex-wrap gap-1"></div>
                    </div>
                    <div class="d-flex align-items-center gap-2 ms-auto">
                        <label class="form-label small mb-0">Sort:</label>
                        <select id="sort-select" class="form-select form-select-sm" onchange="handleSortChange()">
                            <option value="date_asc">Date (Oldest First)</option>
                            <option value="date_desc">Date (Newest First)</option>
                            <option value="category_date_asc">Category (Oldest First)</option>
                            <option value="category_date_desc">Category (Newest First)</option>
                            <option value="bias_date_asc">Political Bias (Oldest First)</option>
                            <option value="bias_date_desc">Political Bias (Newest First)</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center" style="min-width: 240px;">
                        <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Search titles, summaries, keywords..." onkeyup="handleSearchInput()">
                    </div>
                    <button id="factual-toggle-btn" class="btn btn-sm btn-outline-primary" onclick="toggleFactualFilter()" title="Toggle between factual and opinion articles">
                        <i class="fas fa-shield-alt"></i> Factual Only
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()" title="Clear all filters">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            
            <div id="articles-list"></div>
            
            <!-- Pagination Controls -->
            <div id="pagination-container" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                <div class="pagination-info">
                    <small class="text-muted">
                        Showing <span id="articles-start">1</span>-<span id="articles-end">25</span> of <span id="articles-total">0</span> articles
                    </small>
                </div>
                <div class="pagination-controls">
                    <button id="prev-page-btn" class="btn btn-outline-secondary btn-sm me-2" onclick="previousPage()" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span class="mx-2">
                        Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                    </span>
                    <button id="next-page-btn" class="btn btn-outline-secondary btn-sm ms-2" onclick="nextPage()" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Six Articles Tab -->
        <div class="tab-pane fade" id="six-articles-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">AI-Generated Six Articles</h5>
                <div class="d-flex gap-2">
                    <button id="generate-btn" class="btn btn-primary" onclick="loadSixArticles()">
                        <i class="fas fa-magic me-2"></i>Generate
                    </button>
                    <button id="regenerate-btn" class="btn btn-outline-secondary" onclick="loadSixArticles(true)">
                        <i class="fas fa-sync-alt me-2"></i>Regenerate
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="exportSixArticlesMarkdown()"><i class="fab fa-markdown me-2"></i>Download Markdown</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportSixArticlesHTML()"><i class="fas fa-code me-2"></i>Download HTML</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="generateSixArticlesPodcast()"><i class="fas fa-microphone me-2"></i>Generate Podcast</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="six-articles-loading" class="loading" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Analyzing top articles...</div>
            </div>
            <div id="six-articles-error" class="error-message" style="display: none;"></div>
            <div id="six-articles-report"></div>
        </div>

        <!-- Insights Tab -->
        <div class="tab-pane fade show active" id="insights-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Article & Category Insights
                </h5>
                <div class="btn-group">
                    <button id="smart-insights-btn" class="btn btn-primary" onclick="smartGenerateInsights()">
                        <i class="fas fa-brain me-2"></i><span id="insights-btn-text">Generate Insights</span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="smartGenerateInsights(true)"><i class="fas fa-sync me-2"></i>Force Regenerate</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Insights Navigation -->
            <ul class="nav nav-pills nav-fill mb-3" id="insights-nav">
                <li class="nav-item">
                    <a class="nav-link active" id="incident-tracking-nav" data-bs-toggle="pill" href="#incident-tracking-panel">
                        <i class="fas fa-crosshairs me-1"></i>Incident Tracking
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="article-insights-nav" data-bs-toggle="pill" href="#article-insights-panel">
                        <i class="fas fa-newspaper me-1"></i>AI Insights
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="category-insights-nav" data-bs-toggle="pill" href="#category-insights-panel">
                        <i class="fas fa-layer-group me-1"></i>Topic Analysis
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="realtime-signals-nav" data-bs-toggle="pill" href="#realtime-signals-panel">
                        <i class="fas fa-radar me-1"></i>Real-time Signals
                    </a>
                </li>
            </ul>

            <!-- Insights Content -->
            <div class="tab-content" id="insights-tab-content">
                <!-- Article Insights Panel -->
                <div class="tab-pane fade" id="article-insights-panel">
                    <div id="article-insights-loading" class="loading" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Analyzing article themes...</div>
                    </div>
                    <div id="article-insights-error" class="error-message" style="display: none;"></div>
                    <div class="d-flex flex-row flex-wrap justify-content-start align-items-stretch" id="article-insights-container">
                        <div class="text-center p-4 w-100">
                            <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                            <h5>Article Theme Analysis</h5>
                            <p class="text-muted">Generate insights to see AI-powered thematic analysis of current articles with research suggestions.</p>
                        </div>
                    </div>
                </div>

                <!-- Category Insights Panel -->
                <div class="tab-pane fade" id="category-insights-panel">
                    <div id="category-insights-loading" class="loading" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Analyzing categories...</div>
                    </div>
                    <div id="category-insights-error" class="error-message" style="display: none;"></div>
                    <div id="category-insights-container">
                        <div class="text-center p-4">
                            <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                            <h5>Category Distribution</h5>
                            <p class="text-muted">Generate insights to see how articles are distributed across categories.</p>
                        </div>
                    </div>
                </div>


                <!-- Incident Tracking Panel -->
                <div class="tab-pane fade show active" id="incident-tracking-panel">
                    <div id="incident-toolbar" class="d-flex align-items-center justify-content-between mb-2" style="gap: 8px;">
                        <div class="d-flex align-items-center gap-2">
                            <strong class="small text-muted">Incident Options</strong>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary active" id="incident-card-view-btn" onclick="toggleIncidentView('cards')" title="Card view">
                                    <i class="fas fa-th-large"></i>
                                </button>
                                <button class="btn btn-outline-primary" id="incident-table-view-btn" onclick="toggleIncidentView('table')" title="Table view">
                                    <i class="fas fa-table"></i>
                                </button>
                            </div>
                            <select id="incident-sort-select" class="form-select form-select-sm" onchange="handleIncidentSortChange()" style="width: auto;">
                                <option value="significance_desc">Significance (High → Low)</option>
                                <option value="significance_asc">Significance (Low → High)</option>
                                <option value="entity_asc">Entity (A → Z)</option>
                                <option value="entity_desc">Entity (Z → A)</option>
                                <option value="type_asc">Type (A → Z)</option>
                                <option value="type_desc">Type (Z → A)</option>
                                <option value="name_asc">Name (A → Z)</option>
                                <option value="name_desc">Name (Z → A)</option>
                                <option value="timeline_desc">Timeline (Recent → Old)</option>
                                <option value="timeline_asc">Timeline (Old → Recent)</option>
                            </select>
                        </div>
                        <div id="incident-toolbar-right" class="d-flex align-items-center gap-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="showIncidentConfigModal()" title="Configure incident tracking prompts and ontology">
                                <i class="fas fa-cogs me-1"></i>Configure
                            </button>
                        </div>
                    </div>
                    
                    <!-- Incident Filters -->
                    <div id="incident-filters" class="mb-3" style="display: none;">
                        <div class="d-flex flex-wrap gap-2 align-items-center p-2 bg-light rounded">
                            <span class="text-muted small fw-bold">Filter Incidents:</span>
                            <div class="d-flex align-items-center gap-1">
                                <span class="text-muted small">Type:</span>
                                <div id="incident-type-filters" class="d-flex flex-wrap gap-1"></div>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <span class="text-muted small">Significance:</span>
                                <div id="incident-significance-filters" class="d-flex flex-wrap gap-1"></div>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <span class="text-muted small">Status:</span>
                                <div id="incident-status-filters" class="d-flex flex-wrap gap-1"></div>
                            </div>
                            <div class="d-flex align-items-center gap-2 ms-auto">
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearIncidentFilters()" title="Clear all filters">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="incident-tracking-loading" class="loading" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Tracking incidents. This may take a few minutes.</div>
                    </div>
                    <div id="incident-tracking-error" class="error-message" style="display: none;"></div>
                    <div class="row g-2" id="incident-tracking-container">
                        <div class="text-center p-4 w-100">
                            <i class="fas fa-crosshairs fa-3x text-muted mb-3"></i>
                            <h5>Incident Tracking</h5>
                            <p class="text-muted">Generate insights to track specific incidents, entities, and events for threat hunting.</p>
                        </div>
                    </div>
                </div>

                <!-- Real-time Signals Panel -->
                <div class="tab-pane fade" id="realtime-signals-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-radar me-2"></i>Signal Instructions
                        </h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-success" onclick="runAllSignals()" title="Run all active signals">
                                <i class="fas fa-play me-1"></i>Run All
                            </button>
                            <button class="btn btn-primary" onclick="showAddSignalModal()">
                                <i class="fas fa-plus me-1"></i>Add Signal
                            </button>
                        </div>
                    </div>
                    
                    <!-- Signal Configuration -->
                    <div class="mb-3">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto">
                                <label class="form-label mb-0 small fw-bold">Topic:</label>
                            </div>
                            <div class="col">
                                <select id="signal-topic-select" class="form-select form-select-sm" onchange="handleSignalTopicChange()">
                                    <option value="">All Topics</option>
                                    <option value="AI and Machine Learning">AI and Machine Learning</option>
                                    <option value="Quantum Computing">Quantum Computing</option>
                                    <option value="Cybersecurity">Cybersecurity</option>
                                    <option value="Blockchain">Blockchain</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="form-label mb-0 small fw-bold">Days Back:</label>
                            </div>
                            <div class="col-auto">
                                <select id="signal-days-select" class="form-select form-select-sm" onchange="handleSignalConfigChange()">
                                    <option value="1">1 Day</option>
                                    <option value="3">3 Days</option>
                                    <option value="7" selected>7 Days</option>
                                    <option value="14">14 Days</option>
                                    <option value="30">30 Days</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-light text-dark" id="signal-article-count">0 articles</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-outline-info btn-sm" onclick="loadTopicsForSignals()" title="Refresh topics">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="signal-instructions-list" class="mb-3">
                        <div class="text-center p-3 text-muted">
                            <i class="fas fa-info-circle me-2"></i>No signal instructions yet. Add one to start monitoring.
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-bell me-2"></i>Signal Alerts
                        </h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="loadSignalAlerts()" title="Refresh alerts">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                            <button class="btn btn-outline-warning" onclick="acknowledgeAllAlerts()" title="Mark all as acknowledged">
                                <i class="fas fa-check me-1"></i>Ack All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Signal Alert Filters -->
                    <div id="signal-alert-filters" class="mb-3" style="display: none;">
                        <div class="d-flex flex-wrap gap-2 align-items-center p-2 bg-light rounded">
                            <span class="text-muted small fw-bold">Filter Alerts:</span>
                            <div class="d-flex align-items-center gap-1">
                                <span class="text-muted small">Instruction:</span>
                                <div id="instruction-filters" class="d-flex flex-wrap gap-1"></div>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <span class="text-muted small">Threat Level:</span>
                                <div id="threat-level-filters" class="d-flex flex-wrap gap-1"></div>
                            </div>
                            <div class="d-flex align-items-center gap-2 ms-auto">
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearAlertFilters()" title="Clear all filters">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="signal-alerts-list" class="mb-3">
                        <div class="text-center p-3 text-muted">
                            <i class="fas fa-info-circle me-2"></i>No alerts yet. Run signal instructions to generate alerts.
                        </div>
                    </div>
                    
                    <!-- Alerts Pagination -->
                    <div id="signal-alerts-pagination" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                        <div class="pagination-info">
                            <small class="text-muted">
                                Showing <span id="alerts-start">1</span>-<span id="alerts-end">10</span> of <span id="alerts-total">0</span> alerts
                            </small>
                        </div>
                        <div class="pagination-controls">
                            <button id="prev-alerts-btn" class="btn btn-outline-secondary btn-sm me-2" onclick="previousAlertsPage()" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span class="mx-2">
                                Page <span id="current-alerts-page">1</span> of <span id="total-alerts-pages">1</span>
                            </span>
                            <button id="next-alerts-btn" class="btn btn-outline-secondary btn-sm ms-2" onclick="nextAlertsPage()" disabled>
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div id="realtime-signals-loading" class="loading" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Analyzing signals...</div>
                    </div>
                    <div id="realtime-signals-error" class="error-message" style="display: none;"></div>
                    <div class="d-flex flex-row flex-wrap justify-content-start align-items-stretch" id="realtime-signals-container">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Signal Instruction Modal -->
<div class="modal fade" id="addSignalModal" tabindex="-1" aria-labelledby="addSignalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSignalModalLabel">Add Signal Instruction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="signalName" class="form-label">Signal Name</label>
                    <input type="text" class="form-control" id="signalName" placeholder="e.g., Elon Musk AI Mentions">
                    <div class="form-text">Give your signal a descriptive name</div>
                </div>
                <div class="mb-3">
                    <label for="signalDescription" class="form-label">Description</label>
                    <input type="text" class="form-control" id="signalDescription" placeholder="What this signal watches for">
                    <div class="form-text">Brief description of the monitoring purpose</div>
                </div>
                <div class="mb-3">
                    <label for="signalTopic" class="form-label">Topic</label>
                    <select class="form-select" id="signalTopic">
                        <option value="">All Topics (Global Signal)</option>
                        <option value="AI and Machine Learning">AI and Machine Learning</option>
                        <option value="Quantum Computing">Quantum Computing</option>
                        <option value="Cybersecurity">Cybersecurity</option>
                        <option value="Blockchain">Blockchain</option>
                    </select>
                    <div class="form-text">Choose which topic this signal applies to</div>
                </div>
                <div class="mb-3">
                    <label for="signalInstruction" class="form-label">LLM Instruction</label>
                    <textarea class="form-control" id="signalInstruction" rows="4" 
                        placeholder="Flag any articles that mention Elon Musk, especially regarding AI, Tesla, or SpaceX developments. Look for direct quotes, business decisions, or policy statements."></textarea>
                    <div class="form-text">Detailed instruction for the AI to follow when analyzing articles</div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="signalActive" checked>
                    <label class="form-check-label" for="signalActive">
                        Active (monitor this signal)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSignalInstruction()">Save Signal</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Feed Modal -->
<div class="modal fade" id="saveFeedModal" tabindex="-1" aria-labelledby="saveFeedModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveFeedModalLabel">Save News Feed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Save this news feed for later viewing:</p>
                <div class="mb-3">
                    <label for="feedNameInput" class="form-label">Feed Name:</label>
                    <input type="text" class="form-control" id="feedNameInput" placeholder="e.g., AI News Sept 12, 2025">
                </div>
                <div class="mb-3">
                    <label for="feedDescriptionInput" class="form-label">Description (optional):</label>
                    <textarea class="form-control" id="feedDescriptionInput" rows="3" placeholder="Brief description of this feed..."></textarea>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeArticles" checked>
                    <label class="form-check-label" for="includeArticles">
                        Include article list
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeSixArticles" checked>
                    <label class="form-check-label" for="includeSixArticles">
                        Include six articles analysis
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFeedBtn">Save Feed</button>
            </div>
        </div>
    </div>
</div>

<!-- Saved Feeds Modal -->
<div class="modal fade" id="savedFeedsModal" tabindex="-1" aria-labelledby="savedFeedsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savedFeedsModalLabel">Saved News Feeds</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="savedFeedsList">
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-bookmark fa-2x mb-3"></i>
                        <p>No saved feeds yet.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-danger" id="clearAllFeeds">Clear All</button>
            </div>
        </div>
    </div>
</div>

<!-- Incident Tracking Configuration Modal -->
<div class="modal fade" id="incidentConfigModal" tabindex="-1" aria-labelledby="incidentConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incidentConfigModalLabel">
                    <i class="fas fa-cogs me-2"></i>
                    Configure Incident Tracking
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Navigation tabs for different configuration sections -->
                <ul class="nav nav-tabs" id="incidentConfigTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="prompt-tab" data-bs-toggle="tab" data-bs-target="#prompt-panel" type="button" role="tab">
                            <i class="fas fa-comment-dots me-1"></i>System Prompt
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ontology-tab" data-bs-toggle="tab" data-bs-target="#ontology-panel" type="button" role="tab">
                            <i class="fas fa-sitemap me-1"></i>Ontology
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="guidance-tab" data-bs-toggle="tab" data-bs-target="#guidance-panel" type="button" role="tab">
                            <i class="fas fa-lightbulb me-1"></i>AI Guidance
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="incidentConfigTabContent">
                    <!-- System Prompt Panel -->
                    <div class="tab-pane fade show active" id="prompt-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold">System Prompt Template</h6>
                                <p class="text-muted small">
                                    Customize the system prompt used for incident tracking analysis. Use {topic} and {ontology_text} as placeholders.
                                </p>
                                <textarea id="incidentSystemPrompt" class="form-control" rows="15" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;"></textarea>
                                
                                <div class="mt-3">
                                    <h6 class="fw-bold">User Prompt Template</h6>
                                    <p class="text-muted small">
                                        Customize how articles are presented to the AI. Use {topic} and {articles_text} as placeholders.
                                    </p>
                                    <textarea id="incidentUserPrompt" class="form-control" rows="3" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;"></textarea>
                                </div>
                                
                                <div class="mt-3">
                                    <h6 class="fw-bold">Organizational Profile Integration</h6>
                                    <p class="text-muted small">
                                        Configure how organizational profiles are integrated into the analysis context.
                                    </p>
                                    <div class="mb-2">
                                        <label class="form-label">Profile Context Template:</label>
                                        <textarea id="profileContextTemplate" class="form-control" rows="4" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Template for how profile information is included in prompts..."></textarea>
                                        <small class="text-muted">Use {profile_name}, {industry}, {key_concerns}, {strategic_priorities}, etc. as placeholders</small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableProfileIntegration" checked>
                                        <label class="form-check-label" for="enableProfileIntegration">
                                            Enable organizational profile integration
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-info-circle me-1"></i>Available Placeholders</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <code>{topic}</code>
                                            <small class="d-block text-muted">Current analysis topic</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{ontology_text}</code>
                                            <small class="d-block text-muted">Generated ontology guidance</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{articles_text}</code>
                                            <small class="d-block text-muted">Formatted article content</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{profile_context}</code>
                                            <small class="d-block text-muted">Organizational profile context</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{analysis_instructions}</code>
                                            <small class="d-block text-muted">AI analysis instructions</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{quality_guidelines}</code>
                                            <small class="d-block text-muted">Quality control guidelines</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-history me-1"></i>Template Actions</h6>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="loadDefaultPromptTemplate()">
                                            <i class="fas fa-undo me-1"></i>Reset to Default
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="previewPrompt()">
                                            <i class="fas fa-eye me-1"></i>Preview with Sample Data
                                        </button>
                                        <button class="btn btn-outline-success btn-sm w-100" onclick="validatePromptTemplate()">
                                            <i class="fas fa-check me-1"></i>Validate Template
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ontology Panel -->
                    <div class="tab-pane fade" id="ontology-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold">Ontology Configuration</h6>
                                <p class="text-muted small">
                                    Define the types, subtypes, and classification rules for incident tracking.
                                </p>
                                
                                <!-- Base Ontology -->
                                <div class="mb-4">
                                    <h6>Base Ontology</h6>
                                    <textarea id="baseOntology" class="form-control" rows="12" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;"></textarea>
                                </div>
                                
                                <!-- Domain Overlays -->
                                <div class="mb-4">
                                    <h6>Domain-Specific Overlays</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Domain Key:</label>
                                        <input type="text" id="domainKey" class="form-control" placeholder="e.g., scientific_publisher, finance, healthcare">
                                        <small class="text-muted">Use 'vanilla' for no domain-specific overlay</small>
                                    </div>
                                    <textarea id="domainOverlay" class="form-control" rows="8" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Domain-specific rules and examples..."></textarea>
                                </div>
                                
                                <!-- Examples -->
                                <div class="mb-4">
                                    <h6>Classification Examples</h6>
                                    <textarea id="ontologyExamples" class="form-control" rows="6" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-layer-group me-1"></i>Ontology Structure</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>7-Type Classification:</strong>
                                            <ul class="list-unstyled ms-2 small">
                                                <li><code>incident</code> - Disruptive occurrences requiring response</li>
                                                <li><code>event</code> - Noteworthy developments and announcements</li>
                                                <li><code>entity</code> - Organizations, people, products tracked</li>
                                                <li><code>expertise</code> - Expert analysis and authoritative insights</li>
                                                <li><code>informed_insider</code> - Insider perspectives and leaks</li>
                                                <li><code>trend_signal</code> - Market trends and behavioral shifts</li>
                                                <li><code>strategic_shift</code> - Major strategic and policy changes</li>
                                            </ul>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Required Fields:</strong>
                                            <ul class="list-unstyled ms-2 small">
                                                <li>name, type, subtype</li>
                                                <li>description, timeline</li>
                                                <li>significance, plausibility</li>
                                                <li>investigation_leads</li>
                                                <li>source_quality, misinfo_flags</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-tools me-1"></i>Ontology Actions</h6>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="loadDefaultOntology()">
                                            <i class="fas fa-undo me-1"></i>Reset to Default
                                        </button>
                                        <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="addDomainOverlay()">
                                            <i class="fas fa-plus me-1"></i>Add Domain Overlay
                                        </button>
                                        <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="validateOntology()">
                                            <i class="fas fa-check me-1"></i>Validate Structure
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Guidance Panel -->
                    <div class="tab-pane fade" id="guidance-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold">Analysis Guidance</h6>
                                <p class="text-muted small">
                                    Provide specific instructions and examples to guide the AI's analysis behavior.
                                </p>
                                
                                <div class="mb-4">
                                    <h6>Analysis Instructions</h6>
                                    <textarea id="analysisInstructions" class="form-control" rows="8" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Specific instructions for how the AI should analyze articles and classify incidents..."></textarea>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Quality Control Guidelines</h6>
                                    <textarea id="qualityGuidelines" class="form-control" rows="6" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Guidelines for assessing credibility, handling extraordinary claims, source quality evaluation..."></textarea>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Output Format Requirements</h6>
                                    <textarea id="outputFormat" class="form-control" rows="4" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Specific JSON structure and formatting requirements..."></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-brain me-1"></i>Best Practices</h6>
                                    </div>
                                    <div class="card-body small">
                                        <div class="mb-3">
                                            <strong>Analysis Quality:</strong>
                                            <ul class="list-unstyled ms-2">
                                                <li>• Be specific about credibility assessment</li>
                                                <li>• Include source quality indicators</li>
                                                <li>• Flag extraordinary claims</li>
                                                <li>• Provide investigation leads</li>
                                                <li>• Be inclusive rather than restrictive</li>
                                            </ul>
                                        </div>
                                        <div class="mb-3">
                                            <strong>7-Type Classification:</strong>
                                            <ul class="list-unstyled ms-2">
                                                <li>• <strong>Incident</strong>: Immediate response needed</li>
                                                <li>• <strong>Event</strong>: Significant developments</li>
                                                <li>• <strong>Entity</strong>: Organizations/people tracked</li>
                                                <li>• <strong>Expertise</strong>: Expert insights/warnings</li>
                                                <li>• <strong>Informed Insider</strong>: Privileged information</li>
                                                <li>• <strong>Trend Signal</strong>: Market/behavioral patterns</li>
                                                <li>• <strong>Strategic Shift</strong>: Major strategic changes</li>
                                            </ul>
                                        </div>
                                        <div class="mb-3">
                                            <strong>Profile Context:</strong>
                                            <ul class="list-unstyled ms-2">
                                                <li>• Consider organizational priorities</li>
                                                <li>• Align with risk tolerance</li>
                                                <li>• Focus on relevant stakeholders</li>
                                                <li>• Account for industry context</li>
                                                <li>• Tailor investigation leads</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-flask me-1"></i>Testing</h6>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="testWithSampleArticles()">
                                            <i class="fas fa-play me-1"></i>Test with Sample Articles
                                        </button>
                                        <button class="btn btn-outline-info btn-sm w-100" onclick="showGuidanceExamples()">
                                            <i class="fas fa-book me-1"></i>View Examples
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-warning" onclick="resetAllToDefaults()">
                    <i class="fas fa-undo me-1"></i>Reset All to Defaults
                </button>
                <button type="button" class="btn btn-primary" onclick="saveIncidentConfiguration()">
                    <i class="fas fa-save me-1"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Global fetch wrapper to surface rate-limit (HTTP 429) errors to users
(function enhanceGlobalFetchForRateLimit(){
    if (window.__fetchRateLimitWrapped) return;
    window.__fetchRateLimitWrapped = true;
    const originalFetch = window.fetch.bind(window);
    window.fetch = async function(input, init) {
        try {
            const response = await originalFetch(input, init);
            if (response && response.status === 429) {
                let apiMsg = '';
                try {
                    const cloned = response.clone();
                    const body = await cloned.json().catch(() => null);
                    apiMsg = (body && (body.detail || body.message)) ? ` (${body.detail || body.message})` : '';
                } catch (_) { /* best-effort */ }
                const msg = `We are experiencing heavy load and hit a rate limit. Please wait a bit and try again${apiMsg}.`;
                try { if (typeof showNotification === 'function') showNotification(msg, 'warning'); } catch(_) {}
            }
            return response;
        } catch (error) {
            const text = String(error && (error.message || error))
            if (text.includes('RateLimit') || text.includes('429')) {
                try { if (typeof showNotification === 'function') showNotification('We are temporarily rate-limited. Please try again shortly.', 'warning'); } catch(_) {}
            }
            throw error;
        }
    };
})();
document.addEventListener('DOMContentLoaded', function() {
    // Initialize with the selected date (September 15, 2025)
    const selectedDateObj = new Date(2025, 8, 15); // September 15, 2025
    document.getElementById('current-date').textContent = selectedDateObj.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    // Persist selected model between sessions
    try {
        const savedModel = localStorage.getItem('newsFeedDefaultModel');
        if (savedModel) {
            const modelSelect = document.getElementById('model-select');
            if (modelSelect && Array.from(modelSelect.options).some(o => o.value === savedModel)) {
                modelSelect.value = savedModel;
            }
        }
        const modelSelectEl = document.getElementById('model-select');
        if (modelSelectEl) {
            modelSelectEl.addEventListener('change', () => {
                localStorage.setItem('newsFeedDefaultModel', modelSelectEl.value);
            });
        }
    } catch (_) { /* best-effort */ }

    // Profile persistence is now handled in loadOrganizationalProfiles() after profiles are loaded

    // Default to last 90 days
    try {
        const dr = document.getElementById('date-range-select');
        if (dr) {
            dr.value = '3m';
            document.getElementById('date-range-text').textContent = 'Last 90 Days';
            handleDateRangeChange();
        }
    } catch (_) { /* best-effort */ }

    // Generate button is now in Six Articles tab - event listener added there

    // Tab change handlers
    document.getElementById('articles-tab').addEventListener('click', function() {
        // Always auto-load fresh articles when Articles tab is clicked
        autoLoadArticles();
    });

    document.getElementById('six-articles-tab').addEventListener('click', function() {
        if (!document.getElementById('six-articles-report').innerHTML.trim()) {
            loadSixArticles();
        }
    });

    document.getElementById('insights-tab').addEventListener('click', async function() {
        // Check for cached data and auto-load if available
        await checkInsightsCache();
        
        const insightsContainer = document.getElementById('article-insights-container');
        if (insightsContainer && !insightsContainer.querySelector('.insight-item-card')) {
            // Auto-load cached insights if available, otherwise show welcome message
            if (insightsState.hasArticleCache || insightsState.hasCategoryCache || insightsState.hasIncidentCache) {
                await autoLoadCachedInsights();
            } else {
                showInsightsWelcomeMessage();
            }
        }
    });

    // Initialize insights sub-navigation
    document.querySelectorAll('#insights-nav .nav-link').forEach(navLink => {
        navLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active states for insights nav
            document.querySelectorAll('#insights-nav .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            this.classList.add('active');
            
            // Show corresponding panel
            const targetId = this.getAttribute('href').substring(1);
            document.querySelectorAll('#insights-tab-content .tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });
            
            const targetPanel = document.getElementById(targetId);
            if (targetPanel) {
                targetPanel.classList.add('show', 'active');
            }
        });
    });

    // Don't auto-load articles to prevent freeze - user can click Generate Feed
    console.log('Initial article loading disabled to prevent freeze');
    
    // Show a helpful message in the articles area
    const articlesContainer = document.getElementById('articles-list');
    if (articlesContainer) {
        articlesContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Ready to Generate News Feed</h5>
                <p class="text-muted">Click "Generate Feed" to load articles for the selected date.</p>
            </div>
        `;
    }
    
    // Show a helpful message in the six articles area too
    const sixArticlesContainer = document.getElementById('six-articles-report');
    if (sixArticlesContainer) {
        sixArticlesContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-star fa-3x text-muted mb-3"></i>
                <h5>Six Articles Analysis</h5>
                <p class="text-muted">Generate a feed first, then click this tab to see the strategic analysis.</p>
            </div>
        `;
    }
    
    // Populate topics dropdown and wire change handlers
    try {
        const sel = document.getElementById('topic-select');
        if (sel) {
            fetch('/api/topics')
                .then(r => r.json())
                .then(topics => {
                    sel.innerHTML = '<option value="">All Topics</option>' + topics.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
                    const savedTopic = localStorage.getItem('newsFeedTopic');
                    if (savedTopic && Array.from(sel.options).some(o => o.value === savedTopic)) sel.value = savedTopic;
                })
                .catch(() => {});
            sel.addEventListener('change', () => {
                localStorage.setItem('newsFeedTopic', sel.value);
                updateArticleCountForDateRange();
                generateNewsFeed();
                
                // Clear insights when topic changes
                clearInsightsContent();
            });
        }
    } catch (_) { /* best-effort */ }

    // Load saved feeds when modal is opened
    document.getElementById('savedFeedsModal').addEventListener('show.bs.modal', loadSavedFeeds);
    
    // Clear all feeds functionality
    document.getElementById('clearAllFeeds').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all saved feeds?')) {
            localStorage.removeItem('savedNewsFeeds');
            loadSavedFeeds();
        }
    });
    
    // Save feed functionality
    document.getElementById('saveFeedBtn').addEventListener('click', saveFeedFromModal);
});

function loadSavedFeeds() {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const container = document.getElementById('savedFeedsList');
    
    if (savedFeeds.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-bookmark fa-2x mb-3"></i>
                <p>No saved feeds yet.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    savedFeeds.forEach(feed => {
        const createdDate = new Date(feed.created).toLocaleDateString();
        const createdTime = new Date(feed.created).toLocaleTimeString();
        
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${escapeHTML(feed.name)}</h6>
                            ${feed.description ? `<p class="card-text small mb-2">${escapeHTML(feed.description)}</p>` : ''}
                            <p class="card-text small text-muted mb-2">
                                <i class="fas fa-calendar me-1"></i>Feed Date: ${feed.date}
                                ${feed.topic ? `<span class="ms-2"><i class="fas fa-tag me-1"></i>Topic: ${escapeHTML(feed.topic)}</span>` : ''}
                            </p>
                            <p class="card-text small text-muted mb-0">
                                <i class="fas fa-clock me-1"></i>Saved: ${createdDate} ${createdTime}
                                <span class="ms-2">
                                    ${feed.includeArticles ? '<i class="fas fa-list me-1"></i>Articles' : ''}
                                    ${feed.includeSixArticles ? '<i class="fas fa-star me-1 ms-2"></i>Analysis' : ''}
                                </span>
                            </p>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-3">
                            <button class="btn btn-outline-primary" onclick="loadSavedFeed(${feed.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-outline-success" onclick="exportSavedFeed(${feed.id})">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteSavedFeed(${feed.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function deleteSavedFeed(feedId) {
    if (confirm('Are you sure you want to delete this saved feed?')) {
        const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
        const filteredFeeds = savedFeeds.filter(feed => feed.id !== feedId);
        localStorage.setItem('savedNewsFeeds', JSON.stringify(filteredFeeds));
        loadSavedFeeds();
    }
}

function saveFeed() {
    // Open the save modal
    const saveModal = new bootstrap.Modal(document.getElementById('saveFeedModal'));
    
    // Pre-fill the name with date range and topic
    const dateRange = document.getElementById('date-range-select').value;
    const topic = document.getElementById('topic-input').value.trim();
    
    let formattedDate;
    if (dateRange === 'custom') {
        const customDate = document.getElementById('custom-date-input').value;
        if (customDate) {
            const dateObj = new Date(customDate);
            formattedDate = dateObj.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        } else {
            formattedDate = 'Custom Date';
        }
    } else {
        // Use the display text for date ranges
        const displayText = document.getElementById('date-range-text').textContent;
        formattedDate = displayText;
    }
    
    const defaultName = topic ? `${topic} - ${formattedDate}` : `News Feed - ${formattedDate}`;
    document.getElementById('feedNameInput').value = defaultName;
    
    saveModal.show();
}

function saveFeedFromModal() {
    const feedName = document.getElementById('feedNameInput').value.trim();
    const feedDescription = document.getElementById('feedDescriptionInput').value.trim();
    const includeArticles = document.getElementById('includeArticles').checked;
    const includeSixArticles = document.getElementById('includeSixArticles').checked;
    
    if (!feedName) {
        alert('Please enter a feed name');
        return;
    }
    
    if (!includeArticles && !includeSixArticles) {
        alert('Please select at least one content type to save');
        return;
    }
    
    // Collect current feed data
    const dateRange = document.getElementById('date-range-select').value;
    const selectedDate = dateRange === 'custom' ? 
        document.getElementById('custom-date-input').value || document.getElementById('selected-date').value :
        dateRange;
    const topic = document.getElementById('topic-input').value.trim();
    const model = document.getElementById('model-select').value;
    
    // Get articles data if requested
    let articlesData = null;
    if (includeArticles) {
        const articleElements = document.querySelectorAll('#articles-list .list-group-item');
        articlesData = Array.from(articleElements).map(element => {
            const title = element.querySelector('h6 a')?.textContent || 'Untitled';
            const url = element.querySelector('h6 a')?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summary = element.querySelector('.small')?.textContent || '';
            
            return { title, url, source, summary };
        });
    }
    
    // Get six articles data if requested
    let sixArticlesData = null;
    if (includeSixArticles) {
        const sixArticlesContainer = document.getElementById('six-articles-report');
        if (sixArticlesContainer && sixArticlesContainer.innerHTML.trim()) {
            const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
            sixArticlesData = Array.from(articles).map(article => {
                const title = article.querySelector('h4')?.textContent || 'Article';
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown';
                const sections = Array.from(article.querySelectorAll('.section')).map(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    return { title: sectionTitle, content: sectionContent };
                });
                return { title, source, sections };
            });
        }
    }
    
    // Create feed object
    const feedData = {
        id: Date.now(),
        name: feedName,
        description: feedDescription,
        date: selectedDate,
        date_range: dateRange,
        topic: topic,
        model: model,
        includeArticles: includeArticles,
        includeSixArticles: includeSixArticles,
        articlesData: articlesData,
        sixArticlesData: sixArticlesData,
        created: new Date().toISOString()
    };
    
    // Save to localStorage
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    savedFeeds.unshift(feedData);
    localStorage.setItem('savedNewsFeeds', JSON.stringify(savedFeeds));
    
    // Close modal and show success
    const saveModal = bootstrap.Modal.getInstance(document.getElementById('saveFeedModal'));
    saveModal.hide();
    
    showNotification(`Feed "${feedName}" saved successfully!`, 'success');
}

function loadSavedFeed(feedId) {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const feed = savedFeeds.find(f => f.id === feedId);
    
    if (!feed) {
        showNotification('Feed not found', 'danger');
        return;
    }
    
    // Set the date range and other parameters
    if (feed.date_range) {
        document.getElementById('date-range-select').value = feed.date_range;
        handleDateRangeChange(); // Update display
    } else {
        // Legacy feed - treat as custom date
        document.getElementById('date-range-select').value = 'custom';
        document.getElementById('custom-date-input').value = feed.date;
        document.getElementById('selected-date').value = feed.date;
        handleDateRangeChange();
    }
    
    if (feed.topic) document.getElementById('topic-input').value = feed.topic;
    document.getElementById('model-select').value = feed.model;
    
    // Load the saved data
    if (feed.includeArticles && feed.articlesData) {
        // Render saved articles
        renderSavedArticles(feed.articlesData);
    }
    
    if (feed.includeSixArticles && feed.sixArticlesData) {
        // Render saved six articles
        renderSavedSixArticles(feed.sixArticlesData);
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('savedFeedsModal'));
    modal.hide();
    
    showNotification(`Loaded feed: ${feed.name}`, 'success');
}

function exportSavedFeed(feedId) {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const feed = savedFeeds.find(f => f.id === feedId);
    
    if (!feed) {
        showNotification('Feed not found', 'danger');
        return;
    }
    
    // Generate markdown for saved feed
    let markdown = '';
    const dateObj = new Date(feed.date);
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Header
    markdown += `# ${feed.name}\n\n`;
    markdown += `**Date:** ${formattedDate}\n`;
    if (feed.topic) markdown += `**Topic:** ${feed.topic}\n`;
    if (feed.description) markdown += `**Description:** ${feed.description}\n`;
    markdown += `**Model:** ${feed.model}\n`;
    markdown += `**Saved:** ${new Date(feed.created).toLocaleString()}\n\n`;
    
    // Add six articles if included
    if (feed.includeSixArticles && feed.sixArticlesData) {
        markdown += `## Six Most Important Articles Analysis\n\n`;
        feed.sixArticlesData.forEach((article, index) => {
            markdown += `### ${index + 1}. ${article.title}\n\n`;
            markdown += `**Source:** ${article.source}\n\n`;
            
            article.sections.forEach(section => {
                if (section.title && section.content) {
                    markdown += `**${section.title}**\n\n${section.content}\n\n`;
                }
            });
            
            markdown += `---\n\n`;
        });
    }
    
    // Add articles if included
    if (feed.includeArticles && feed.articlesData) {
        markdown += `## Article List\n\n`;
        feed.articlesData.forEach((article, index) => {
            markdown += `### ${index + 1}. [${article.title}](${article.url})\n\n`;
            markdown += `**Source:** ${article.source}\n\n`;
            if (article.summary && article.summary.trim() !== 'No summary available.') {
                const cleanSummary = article.summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            markdown += `---\n\n`;
        });
    }
    
    downloadMarkdown(markdown, `${feed.name.replace(/[^a-zA-Z0-9]/g, '_')}_${feed.date}.md`);
}

function renderSavedArticles(articlesData) {
    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '';
    
    const articlesList = document.createElement('div');
    articlesList.className = 'list-group list-group-flush mt-2';
    
    articlesData.forEach(article => {
        const articleItem = document.createElement('div');
        articleItem.className = 'list-group-item';
        
        articleItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1"><a href="${article.url}" target="_blank" rel="noopener">${article.title}</a></h6>
                <small>Saved</small>
            </div>
            <p class="mb-1"><small class="text-muted">${article.source}</small></p>
            <p class="mb-1 small">${article.summary}</p>
        `;
        
        articlesList.appendChild(articleItem);
    });
    
    listContainer.appendChild(articlesList);
}

function renderSavedSixArticles(sixArticlesData) {
    const container = document.getElementById('six-articles-report');
    if (!container) return;
    
    let html = `
        <div class="six-articles-analysis">
            <h3>Strategic Analysis: Six Most Important Articles (Saved)</h3>
            <p class="mb-4">Previously saved analysis of the most important articles.</p>
        </div>
    `;
    
    sixArticlesData.forEach((article, index) => {
        html += `
            <div class="article-analysis mb-5 p-4 border rounded">
                <div class="article-header mb-3">
                    <h4 class="text-primary">${index + 1}. ${article.title}</h4>
                    <p class="text-muted mb-1"><strong>Source:</strong> ${article.source}</p>
                </div>
                <div class="article-content">
        `;
        
        article.sections.forEach(section => {
            if (section.title && section.content) {
                html += `
                    <div class="section mb-3">
                        <h6 class="text-secondary">${section.title}</h6>
                        <p>${section.content}</p>
                    </div>
                `;
            }
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Article exclusion functionality
let excludedArticles = new Set();
let currentArticlesPage = 1;

function excludeArticle(articleUri, buttonElement) {
    if (confirm('Remove this article from the current view?')) {
        // Add to excluded set
        excludedArticles.add(articleUri);
        
        // Find and hide the article element
        const articleElement = buttonElement.closest('.list-group-item');
        if (articleElement) {
            articleElement.style.transition = 'opacity 0.3s ease-out';
            articleElement.style.opacity = '0';
            setTimeout(() => {
                articleElement.remove();
                updateArticleCount();
                updateRestoreButton();
            }, 300);
        }
        
        // Show success message
        showNotification('Article removed from view', 'success');
    }
}

function updateRestoreButton() {
    const restoreBtn = document.getElementById('restore-articles-btn');
    if (restoreBtn) {
        if (excludedArticles.size > 0) {
            restoreBtn.style.display = 'inline-block';
            restoreBtn.innerHTML = `<i class="fas fa-undo"></i> Restore Hidden (${excludedArticles.size})`;
        } else {
            restoreBtn.style.display = 'none';
        }
    }
}

function updateArticleCount() {
    const remainingArticles = document.querySelectorAll('#articles-list .list-group-item').length;
    const countEl = document.getElementById('selected-date-count');
    if (countEl && remainingArticles > 0) {
        const originalText = countEl.textContent;
        const originalCount = parseInt(originalText) || 0;
        if (remainingArticles < originalCount) {
            countEl.textContent = `${remainingArticles} (${originalCount - remainingArticles} hidden)`;
        }
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) notification.remove();
    }, 3000);
}

function clearExcludedArticles() {
    if (excludedArticles.size > 0 && confirm(`Restore ${excludedArticles.size} hidden articles?`)) {
        excludedArticles.clear();
        updateRestoreButton();
        loadArticles(currentArticlesPage); // Reload current page
        showNotification('All articles restored', 'success');
    }
}

// Markdown export functionality
async function exportToMarkdown() {
    try {
    const selectedDate = document.getElementById('selected-date').value;
    const selectedModel = document.getElementById('model-select').value;
    const topic = document.getElementById('topic-input').value.trim();
    const profileId = document.getElementById('profile-select').value;
        
        // Get current tab to determine what to export
        const activeTab = document.querySelector('#news-tabs .nav-link.active');
        const isArticlesTab = activeTab.id === 'articles-tab';
        
        let markdown = '';
        const dateObj = new Date(selectedDate);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Header
        markdown += `# News Investigator\n\n`;
        markdown += `**Date:** ${formattedDate}\n`;
        if (topic) markdown += `**Topic Filter:** ${topic}\n`;
        markdown += `**Generated:** ${new Date().toLocaleString()}\n`;
        markdown += `**Model:** ${selectedModel}\n\n`;
        
        // Export both six articles and article list
        await exportCombinedContent(markdown);
        
    } catch (error) {
        console.error('Error exporting to markdown:', error);
        showNotification('Error exporting to markdown', 'danger');
    }
}

async function exportArticlesList(baseMarkdown) {
    let markdown = baseMarkdown;
    markdown += `## Article List\n\n`;
    
    // Get visible articles from the current view
    const articleElements = document.querySelectorAll('#articles-list .list-group-item');
    
    if (articleElements.length === 0) {
        markdown += `*No articles available.*\n\n`;
    } else {
        articleElements.forEach((element, index) => {
            const title = element.querySelector('h6 a')?.textContent || 'Untitled';
            const url = element.querySelector('h6 a')?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summary = element.querySelector('.small')?.textContent || '';
            
            markdown += `### ${index + 1}. [${title}](${url})\n\n`;
            markdown += `**Source:** ${source}\n\n`;
            
            if (summary && summary.trim() !== 'No summary available.') {
                const cleanSummary = summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            
            // Add metadata tags if visible
            const metadataTags = element.querySelectorAll('.metadata-tag');
            if (metadataTags.length > 0) {
                markdown += `**Tags:** `;
                const tags = Array.from(metadataTags).map(tag => tag.textContent.trim()).join(', ');
                markdown += `${tags}\n\n`;
            }
            
            markdown += `---\n\n`;
        });
    }
    
    downloadMarkdown(markdown, `news-articles-${document.getElementById('selected-date').value}.md`);
}

async function exportCombinedContent(baseMarkdown) {
    let markdown = baseMarkdown;
    
    // First, add six articles analysis if available
    const sixArticlesContainer = document.getElementById('six-articles-report');
    if (sixArticlesContainer && sixArticlesContainer.innerHTML.trim()) {
        const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
        
        if (articles.length > 0) {
            markdown += `## Six Most Important Articles Analysis\n\n`;
            
            articles.forEach((article, index) => {
                const title = article.querySelector('h4')?.textContent || `Article ${index + 1}`;
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown source';
                
                markdown += `### ${index + 1}. ${title}\n\n`;
                markdown += `**Source:** ${source}\n\n`;
                
                const sections = article.querySelectorAll('.section');
                sections.forEach(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    
                    if (sectionTitle && sectionContent) {
                        markdown += `**${sectionTitle}**\n\n${sectionContent}\n\n`;
                    }
                });
                
                // Get perspectives if available
                const perspectives = article.querySelector('.row');
                if (perspectives) {
                    markdown += `**Political & Ideological Perspectives:**\n\n`;
                    const cols = perspectives.querySelectorAll('.col-md-4');
                    cols.forEach(col => {
                        const perspectiveTitle = col.querySelector('strong')?.textContent || '';
                        const perspectiveContent = col.querySelector('p')?.textContent || '';
                        
                        if (perspectiveTitle && perspectiveContent) {
                            markdown += `- **${perspectiveTitle}** ${perspectiveContent}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n`;
            });
        }
    }
    
    // Then add the article list
    markdown += `## Article List\n\n`;
    
    const articleElements = document.querySelectorAll('#articles-list .list-group-item');
    
    if (articleElements.length === 0) {
        markdown += `*No articles available.*\n\n`;
    } else {
        articleElements.forEach((element, index) => {
            const titleElement = element.querySelector('h6 a');
            const title = titleElement?.textContent || 'Untitled';
            const url = titleElement?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summaryElement = element.querySelector('.small');
            const summary = summaryElement?.getAttribute('title') || summaryElement?.textContent || 'No summary available.';
            
            markdown += `### ${index + 1}. [${title}](${url})\n\n`;
            markdown += `**Source:** ${source}\n\n`;
            
            if (summary && summary.trim() !== 'No summary available.') {
                const cleanSummary = summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            
            markdown += `---\n\n`;
        });
    }
    
    const filename = `news-feed-complete-${document.getElementById('selected-date').value}.md`;
    downloadMarkdown(markdown, filename);
}

async function exportSixArticles(baseMarkdown) {
    let markdown = baseMarkdown;
    markdown += `## Six Most Important Articles Analysis\n\n`;
    
    // Get six articles data from the current view
    const sixArticlesContainer = document.getElementById('six-articles-report');
    
    if (!sixArticlesContainer || !sixArticlesContainer.innerHTML.trim()) {
        markdown += `*No six articles analysis available. Please generate the report first.*\n\n`;
    } else {
        const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
        
        if (articles.length === 0) {
            markdown += `*No articles found in the analysis.*\n\n`;
        } else {
            articles.forEach((article, index) => {
                const title = article.querySelector('h4')?.textContent || `Article ${index + 1}`;
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown';
                
                markdown += `### ${title}\n\n`;
                markdown += `**Source:** ${source}\n\n`;
                
                // Get sections
                const sections = article.querySelectorAll('.section');
                sections.forEach(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    
                    if (sectionTitle && sectionContent) {
                        markdown += `**${sectionTitle}**\n\n${sectionContent}\n\n`;
                    }
                });
                
                // Get perspectives if available
                const perspectives = article.querySelector('.row');
                if (perspectives) {
                    markdown += `**Political & Ideological Perspectives:**\n\n`;
                    const cols = perspectives.querySelectorAll('.col-md-4');
                    cols.forEach(col => {
                        const perspectiveTitle = col.querySelector('strong')?.textContent || '';
                        const perspectiveContent = col.querySelector('p')?.textContent || '';
                        
                        if (perspectiveTitle && perspectiveContent) {
                            markdown += `- **${perspectiveTitle}** ${perspectiveContent}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n`;
            });
        }
    }
    
    downloadMarkdown(markdown, `six-articles-${document.getElementById('selected-date').value}.md`);
}

function downloadMarkdown(content, filename) {
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification(`Exported as ${filename}`, 'success');
}

async function generateNewsFeed() {
    console.log('Generate button clicked');
    const selectedDate = document.getElementById('selected-date').value;
    const selectedModel = document.getElementById('model-select').value;
    console.log('Selected date:', selectedDate, 'Model:', selectedModel);
    
    // Clear existing content
    document.getElementById('articles-list').innerHTML = '';
    document.getElementById('six-articles-report').innerHTML = '';

    // Reset count indicator while loading
    const selectedDateCountEl = document.getElementById('selected-date-count');
    if (selectedDateCountEl) selectedDateCountEl.textContent = 'loading...';
    
    // Load both tabs
    await Promise.all([loadArticles(), loadSixArticles()]);
}

async function loadArticles(page = 1) {
    currentArticlesPage = page;
    const loadingEl = document.getElementById('articles-loading');
    const errorEl = document.getElementById('articles-error');
    const contentEl = document.getElementById('articles-list');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        // Use the news feed articles API
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            model: document.getElementById('model-select').value,
            page: page.toString(),
            per_page: '20'
        });
        
        // Only add date parameter for custom date selection
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            params.append('date', customDate);
        }

        const topic = document.getElementById('topic-select').value.trim();
        if (topic) {
            params.append('topic', topic);
        }
        
        const profileId = document.getElementById('profile-select').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }
        
        // Add starred articles if any
        if (starredArticles.size > 0) {
            params.append('starred_articles', Array.from(starredArticles).join(','));
        }

        console.log('Loading articles with params:', params.toString());
        const response = await fetch(`/api/news-feed/articles?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`No articles found: ${errorData.detail || 'No articles available for the selected date and criteria'}`);
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        // Update the selected-date count from response
        const selectedDateCountElSuccess = document.getElementById('selected-date-count');
        if (selectedDateCountElSuccess) {
            const total = (data && data.articles && typeof data.articles.total_items === 'number')
                ? data.articles.total_items
                : (data && data.articles && Array.isArray(data.articles.items))
                    ? data.articles.items.length
                    : 0;
            selectedDateCountElSuccess.textContent = String(total);
        }
        console.log('Articles data received:', data);
        console.log('Data.articles exists:', !!data.articles);
        console.log('Data.articles.items exists:', !!(data.articles && data.articles.items));
        console.log('Items count:', data.articles && data.articles.items ? data.articles.items.length : 'N/A');
        console.log('Sample article fields:', data.articles && data.articles.items && data.articles.items.length > 0 ? Object.keys(data.articles.items[0]) : 'No items');
        
        if (data.articles && data.articles.items && data.articles.items.length > 0) {
            console.log('First article sample:', data.articles.items[0]);
            window.lastArticlesData = data.articles; // Store for filtering
            renderArticles(data.articles);  // News feed API returns data.articles
            renderArticlesPagination(data.articles);
        } else {
            console.log('No articles found in response - showing friendly message');
            // Show friendly message instead of error
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
            errorEl.style.display = 'block';
            return; // Exit early, don't throw error
        }
        showSaveButton();

    } catch (error) {
        console.error('Error loading overview:', error);
        if (error.message.includes('404')) {
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
        } else {
            errorEl.textContent = `Error loading overview: ${error.message}`;
            errorEl.className = 'error-message'; // Keep error styling
        }
        // Ensure the selected-date count reflects zero on error
        const selectedDateCountElError = document.getElementById('selected-date-count');
        if (selectedDateCountElError) selectedDateCountElError.textContent = '0';
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

async function loadSixArticles(forceRegenerate = false) {
    const loadingEl = document.getElementById('six-articles-loading');
    const errorEl = document.getElementById('six-articles-error');
    const contentEl = document.getElementById('six-articles-report');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            model: document.getElementById('model-select').value,
            per_page: '20'
        });
        
        // Only add date parameter for custom date selection
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            params.append('date', customDate);
        }

        const topic = document.getElementById('topic-select').value.trim();
        if (topic) {
            params.append('topic', topic);
        }
        
        const profileId = document.getElementById('profile-select').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }
        
        // Add starred articles if any
        if (starredArticles.size > 0) {
            params.append('starred_articles', Array.from(starredArticles).join(','));
        }

        if (forceRegenerate) {
            params.append('force_regenerate', 'true');
        }
        const response = await fetch(`/api/news-feed/six-articles?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`No articles found: ${errorData.detail || 'No articles available for the selected date and criteria'}`);
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Six articles response data:', data);
        window.lastSixArticles = data.six_articles || [];
        // Stamp generated date at top of report
        const generatedAt = new Date().toLocaleString();
        const header = document.createElement('div');
        header.className = 'small text-muted mb-2';
        header.innerHTML = `<i class="far fa-clock me-1"></i>Generated: ${generatedAt}`;
        const container = document.getElementById('six-articles-report');
        if (container) container.prepend(header);
        console.log('Six articles array:', data.six_articles);
        if (data.six_articles && data.six_articles.length > 0) {
            console.log('First article related_articles:', data.six_articles[0].related_articles);
        }
        renderSixArticles(data.six_articles);
        showSaveButton();

    } catch (error) {
        console.error('Error loading six articles:', error);
        if (error.message.includes('404')) {
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
        } else {
            errorEl.textContent = `Error loading six articles: ${error.message}`;
            errorEl.className = 'error-message'; // Keep error styling
        }
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

// Helper function to escape HTML content for safe display
function escapeHTML(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str).replace(/[&<>"']/g, function (match) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        }[match];
    });
}

// Escape string for use in JavaScript string literals (for onclick attributes)
function escapeJS(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str).replace(/[\\'"\r\n]/g, function (match) {
        return {
            '\\': '\\\\',
            "'": "\\'",
            '"': '\\"',
            '\r': '\\r',
            '\n': '\\n'
        }[match];
    });
}

// Safe formatter for article source. Falls back to hostname from URI when missing
function formatSource(newsSource, uri) {
    if (newsSource && String(newsSource).trim()) return escapeHTML(newsSource);
    try {
        if (!uri) return 'Unknown';
        const url = new URL(uri);
        const host = url.hostname.replace(/^www\./i, '');
        return host || 'Unknown';
    } catch (_) {
        return 'Unknown';
    }
}

// Safe formatter for publication date
function formatPubDate(dateStr, includeTime) {
    if (!dateStr) return 'Unknown date';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return 'Unknown date';
    return includeTime ? d.toLocaleString() : d.toLocaleDateString();
}

// Helper function to get bias CSS class
function getBiasClass(bias) {
    if (!bias) return 'tag-bias-unknown';
    const biasLower = bias.toLowerCase();
    if (biasLower.includes('left')) return 'tag-bias-left';
    if (biasLower.includes('right')) return 'tag-bias-right';
    if (biasLower.includes('center') || biasLower.includes('mixed')) return 'tag-bias-center';
    if (biasLower.includes('least') || biasLower.includes('factual')) return 'tag-bias-factual';
    return 'tag-bias-unknown';
}

// Helper function to get factual reporting CSS class
function getFactualClass(factual) {
    if (!factual) return 'tag-factual-unknown';
    const factualLower = factual.toLowerCase();
    if (factualLower.includes('high') || factualLower === 'very high') return 'tag-factual-high';
    if (factualLower.includes('mostly') || factualLower === 'mostly factual') return 'tag-factual-mostly';
    if (factualLower.includes('mixed')) return 'tag-factual-mixed';
    if (factualLower.includes('low')) return 'tag-factual-low';
    return 'tag-factual-unknown';
}

// Helper function to get MBFC credibility CSS class
function getMBFCCredibilityClass(credibility) {
    if (!credibility) return 'bg-secondary';
    const credLower = credibility.toLowerCase();
    if (credLower.includes('high') || credLower === 'very high') return 'bg-success';
    if (credLower.includes('mostly') || credLower.includes('moderate')) return 'bg-info';
    if (credLower.includes('mixed')) return 'bg-warning text-dark';
    if (credLower.includes('low')) return 'bg-danger';
    return 'bg-secondary';
}

// Removed old renderArticles function - using new one with star and filter functionality

function renderPagination(totalPages, currentPage) {
    const paginationContainer = document.getElementById('articles-pagination');
    paginationContainer.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous Button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
    paginationContainer.appendChild(prevLi);

    // Page Number Buttons
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        paginationContainer.appendChild(pageLi);
    }

    // Next Button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
    paginationContainer.appendChild(nextLi);

    // Add click handlers
    paginationContainer.querySelectorAll('.page-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page);
            if (page && page !== currentPage) {
                loadArticles(page);
            }
        });
    });
}

function renderOverview(overview) {
    const contentEl = document.getElementById('overview-stories');
    
    let html = '';
    
    overview.top_stories.forEach((story, index) => {
        html += `
            <div class="story-item">
                <h2 class="story-headline">
                    <a href="${story.primary_article.uri}" target="_blank">${story.headline}</a>
                </h2>
                
                <div class="story-summary">${story.summary}</div>
                
                <div class="story-meta">
                    <span class="source-info">
                        ${story.primary_article.source.name}
                        ${getBiasBadge(story.primary_article.source.bias)}
                        ${getFactualityBadge(story.primary_article.source.factuality)}
                    </span>
                    ${story.primary_article.publication_date ? 
                        `<span class="publish-date">${new Date(story.primary_article.publication_date).toLocaleDateString()}</span>` : 
                        ''
                    }
                </div>
                
                ${story.topic_description ? 
                    `<div class="story-context"><strong>Why it matters:</strong> ${story.topic_description}</div>` : 
                    ''
                }
                
                ${story.related_articles.length > 0 ? `
                    <div class="related-articles">
                        <h6>More Coverage</h6>
                        ${story.related_articles.map(related => `
                            <div class="related-item">
                                <strong>${related.source}</strong>${getBiasBadge(related.bias)}: 
                                ${related.url ? `<a href="${related.url}" target="_blank">${related.title}</a>` : related.title}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    contentEl.innerHTML = html;
}

function renderSixArticles(articles) {
    window.lastSixArticles = Array.isArray(articles) ? articles : [];
    const contentEl = document.getElementById('six-articles-report');
    
    console.log('renderSixArticles called with:', articles);
    console.log('Articles length:', articles ? articles.length : 'null/undefined');
    if (articles && articles.length > 0) {
        console.log('First article format:', articles[0].executive_takeaway ? 'New CEO Daily format' : 'Legacy format');
        console.log('Available fields:', Object.keys(articles[0]));
    }
    
    if (!articles || articles.length === 0) {
        contentEl.innerHTML = '<div class="alert alert-info">No articles available for analysis.</div>';
        return;
    }
    
    let html = `
        <div class="six-articles-analysis">
            <h3>🎯 CEO Daily Top-6 AI Articles</h3>
            <p class="mb-4">Selected based on strategic relevance, novelty, credibility, and representativeness for executive decision-makers.</p>
            <div class="small text-muted mb-2">
                <i class="far fa-clock me-1"></i>Generated: ${new Date().toLocaleString()}
            </div>
        </div>
    `;
    
    // Render each article with new CEO format
    articles.forEach((article, index) => {
        const isStarred = article.uri && starredArticles.has(article.uri);
        
        // Get category color and icon
        const categoryColors = {
            'policy': 'text-danger',
            'market': 'text-success', 
            'tech': 'text-primary',
            'workforce': 'text-warning',
            'security': 'text-dark',
            'society': 'text-info'
        };
        const categoryColor = categoryColors[article.category] || 'text-secondary';
        
        // Get time horizon badge color
        const timeHorizonColors = {
            'Immediate': 'bg-danger',
            'Medium': 'bg-warning',
            'Long-term': 'bg-info'
        };
        const timeHorizonColor = timeHorizonColors[article.time_horizon] || 'bg-secondary';
        
        // Get risk/opportunity badge color
        const riskOpportunityColors = {
            'risk': 'bg-danger',
            'opportunity': 'bg-success',
            'mixed': 'bg-warning text-dark'
        };
        const riskOpportunityColor = riskOpportunityColors[article.risk_opportunity] || 'bg-secondary';
        
        // Get signal strength badge color
        const signalStrengthColors = {
            'weak': 'bg-light text-dark',
            'moderate': 'bg-warning text-dark',
            'strong': 'bg-success'
        };
        const signalStrengthColor = signalStrengthColors[article.signal_strength] || 'bg-secondary';
        
        html += `
            <div class="article-analysis mb-5 p-4 border rounded">
                <div class="article-header mb-3">
                    <h4 class="text-primary">${index + 1}. ${article.title} ${isStarred ? '<span class="badge bg-warning text-dark ms-2">Starred</span>' : ''}</h4>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                    <p class="text-muted mb-1"><strong>Source:</strong> ${article.source}</p>
                    ${article.date ? `<p class="text-muted mb-0"><strong>Date:</strong> ${article.date}</p>` : ''}
                            ${article.url ? `<p class="text-muted mb-0"><strong>URL:</strong> <a href="${article.url}" target="_blank" class="text-decoration-none">${article.url}</a></p>` : ''}
                        </div>
                        <div class="text-end">
                            ${article.category ? `<span class="badge bg-light text-dark mb-1 ${categoryColor}">${article.category.toUpperCase()}</span><br>` : ''}
                            ${article.scores ? `<small class="text-muted">Score: ${article.scores.relevance || 'N/A'}/5</small>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="article-content">
                    ${article.executive_takeaway ? `
                    <div class="section mb-3">
                        <h6 class="text-primary"><i class="fas fa-bullseye me-2"></i>Executive Takeaway</h6>
                        <div class="alert alert-primary py-2">
                            <strong>${article.executive_takeaway}</strong>
                    </div>
                    </div>` : ''}
                    
                    <div class="section mb-3">
                        <h6 class="text-secondary"><i class="fas fa-file-text me-2"></i>Summary</h6>
                        <p>${article.summary}</p>
                    </div>
                    
                    ${article.strategic_relevance ? `
                    <div class="section mb-3">
                        <h6 class="text-success"><i class="fas fa-chess me-2"></i>Strategic Relevance</h6>
                        <p>${article.strategic_relevance}</p>
                    </div>` : ''}
                    
                    <!-- Executive Indicators Row -->
                    ${(article.time_horizon || article.risk_opportunity || article.signal_strength) ? `
                    <div class="section mb-3">
                        <h6 class="text-info"><i class="fas fa-tachometer-alt me-2"></i>Executive Indicators</h6>
                        <div class="row">
                            ${article.time_horizon ? `
                            <div class="col-md-4 mb-2">
                                <small class="text-muted d-block">Time Horizon</small>
                                <span class="badge ${timeHorizonColor}">${article.time_horizon}</span>
                            </div>` : ''}
                            ${article.risk_opportunity ? `
                            <div class="col-md-4 mb-2">
                                <small class="text-muted d-block">Risk/Opportunity</small>
                                <span class="badge ${riskOpportunityColor}">${article.risk_opportunity}</span>
                            </div>` : ''}
                            ${article.signal_strength ? `
                            <div class="col-md-4 mb-2">
                                <small class="text-muted d-block">Signal Strength</small>
                                <span class="badge ${signalStrengthColor}">${article.signal_strength}</span>
                            </div>` : ''}
                    </div>
                    </div>` : ''}
                    
                    ${article.executive_action && Array.isArray(article.executive_action) && article.executive_action.length > 0 ? `
                    <div class="section mb-3">
                        <h6 class="text-warning"><i class="fas fa-tasks me-2"></i>Executive Actions</h6>
                        <ul class="mb-0">
                            ${article.executive_action.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                    
                    ${article.scores ? `
                    <div class="section mb-3">
                        <h6 class="text-dark"><i class="fas fa-chart-bar me-2"></i>Selection Scores</h6>
                        <div class="row">
                            <div class="col-6 col-md-3 mb-1">
                                <small class="text-muted">Relevance</small><br>
                                <span class="badge bg-primary">${article.scores.relevance || 'N/A'}/5</span>
                            </div>
                            <div class="col-6 col-md-3 mb-1">
                                <small class="text-muted">Novelty</small><br>
                                <span class="badge bg-info">${article.scores.novelty || 'N/A'}/5</span>
                            </div>
                            <div class="col-6 col-md-3 mb-1">
                                <small class="text-muted">Credibility</small><br>
                                <span class="badge bg-success">${article.scores.credibility || 'N/A'}/5</span>
                            </div>
                            <div class="col-6 col-md-3 mb-1">
                                <small class="text-muted">Representativeness</small><br>
                                <span class="badge bg-warning text-dark">${article.scores.representativeness || 'N/A'}/5</span>
                        </div>
                    </div>
                    </div>` : ''}
                    
                    <!-- Fallback: Show legacy fields if new format not available (excluding political perspectives) -->
                    ${(!article.executive_takeaway && !article.strategic_relevance && article.why_interesting) ? `
                    <div class="section mb-3">
                        <h6 class="text-success">Why It Matters</h6>
                        <p>${article.why_interesting}</p>
                    </div>` : ''}
                    
                    <!-- Format status notice -->
                    ${!article.executive_takeaway ? `
                    <div class="section mb-3" style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <h6 class="text-warning"><i class="fas fa-sync-alt me-2"></i>New CEO Daily Format Available</h6>
                        <div class="text-dark small">
                            <p class="mb-2">This analysis uses the legacy format. Regenerate to get the new <strong>CEO Daily Top-6</strong> format with:</p>
                            <ul class="mb-2 small">
                                <li><strong>Executive Takeaway</strong> - Critical insight in ~15 words</li>
                                <li><strong>Strategic Relevance</strong> - Why it matters for executives</li>
                                <li><strong>Time Horizon</strong> - Immediate/Medium/Long-term impact</li>
                                <li><strong>Risk/Opportunity</strong> - Assessment for decision-makers</li>
                                <li><strong>Executive Actions</strong> - Specific next steps to take</li>
                                <li><strong>Selection Scores</strong> - Relevance/novelty/credibility ratings</li>
                            </ul>
                            <button class="btn btn-sm btn-warning" onclick="loadSixArticles(true)">
                                <i class="fas fa-magic me-1"></i>Regenerate with CEO Daily Format
                            </button>
                        </div>
                    </div>` : ''}
                    
                    <!-- Research Actions -->
                    <div class="section">
                        <h6 class="text-primary"><i class="fas fa-search me-2"></i>Research & Analysis Options</h6>
                        
                        <!-- Primary Analysis Options -->
                        <div class="mb-2">
                            <small class="text-muted fw-bold">Deep Analysis:</small>
                            <div class="d-flex gap-1 flex-wrap mt-1">
                                <button class="btn btn-sm btn-outline-primary" onclick="launchSixArticleDeepDive('${escapeHTML(article.title)}', '${article.url || ''}')">
                                    <i class="fas fa-microscope me-1"></i>Deep Dive
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="launchSixArticleConsensus('${escapeHTML(article.title)}', '${article.url || ''}')">
                                    <i class="fas fa-balance-scale me-1"></i>Consensus Analysis
                                </button>
                                <button class="btn btn-sm btn-outline-dark" onclick="launchSixArticleTimeline('${escapeHTML(article.title)}', '${article.url || ''}')">
                                    <i class="fas fa-clock me-1"></i>Impact Timeline
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="launchSixArticleChat('${escapeHTML(article.title)}', '${article.url || ''}')">
                                    <i class="fas fa-comments me-1"></i>Ask Auspex
                                </button>
                            </div>
                        </div>
                        
                        <!-- Thematic Research Options -->
                        ${(article.category || article.strategic_relevance) ? `
                        <div class="mb-2">
                            <small class="text-muted fw-bold">Thematic Research:</small>
                            <div class="d-flex gap-1 flex-wrap mt-1">
                                ${article.category ? `
                                <button class="btn btn-sm btn-outline-success" onclick="launchAuspexResearchFromInsight('${escapeJS(article.category)} developments in AI', 'category_deep')">
                                    <i class="fas fa-layer-group me-1"></i>${article.category} Trends
                                </button>` : ''}
                                ${article.strategic_relevance ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="launchAuspexResearchFromInsight('strategic implications of ${escapeJS(article.title)}', 'strategic_analysis')">
                                    <i class="fas fa-chess me-1"></i>Strategic Impact
                                </button>` : ''}
                                ${article.time_horizon ? `
                                <button class="btn btn-sm btn-outline-info" onclick="launchAuspexResearchFromInsight('${article.time_horizon.toLowerCase()} impact scenarios for ${escapeJS(article.title)}', 'timeline_analysis')">
                                    <i class="fas fa-hourglass me-1"></i>${article.time_horizon} Impact
                                </button>` : ''}
                            </div>
                        </div>` : ''}
                        
                        <!-- Utility Options -->
                        <div>
                            <small class="text-muted fw-bold">View Options:</small>
                            <div class="d-flex gap-1 flex-wrap mt-1">
                                ${article.url ? `
                                <button class="btn btn-sm btn-outline-info" onclick="window.open('${article.url}', '_blank')" title="View original article">
                                    <i class="fas fa-external-link-alt me-1"></i>Read Original
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="window.open('https://12ft.io/${article.url}', '_blank')" title="Bypass paywall">
                                    <i class="fas fa-unlock-alt me-1"></i>12ft.io
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="window.open('https://archive.is/${article.url}', '_blank')" title="Archived version">
                                    <i class="fas fa-archive me-1"></i>Archive
                                </button>` : ''}
                                <button class="btn btn-sm btn-outline-success" onclick="openSixArticleAnnotation('${article.url || ''}', '${escapeHTML(article.title)}')">
                                    <i class="fas fa-sticky-note me-1"></i>Annotate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Related Articles Section (if available) -->
                    ${article.related_articles && article.related_articles.length > 0 ? `
                    <div class="section mt-3">
                        <h6 class="text-primary">Related Articles</h6>
                        <ul class="list-unstyled mb-0">
                            ${article.related_articles.map(related => `
                                <li class="py-1">
                                    <div class="d-flex align-items-start justify-content-between gap-2">
                                        <div class="flex-grow-1">
                                            <a href="${related.url}" target="_blank" rel="noopener" class="text-decoration-none small fw-semibold">${related.title}</a>
                                            <div class="small text-muted">
                                                <strong>Source:</strong> ${related.source}
                                                ${related.similarity_score ? `<span class=\"ms-2 badge bg-secondary\">${(related.similarity_score * 100).toFixed(0)}% similar</span>` : ''}
                                            </div>
                                            ${related.summary ? `<div class=\"small text-secondary\">${related.summary.length > 110 ? related.summary.substring(0,110) + '…' : related.summary}</div>` : ''}
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    contentEl.innerHTML = html;
}

function exportSixArticlesMarkdown() {
    const articles = window.lastSixArticles || [];
    if (!articles.length) {
        showNotification('No Six Articles to export. Generate first.', 'warning');
        return;
    }
    const lines = [];
    lines.push('# Six Most Interesting Articles');
    lines.push('');
    const generatedAt = new Date().toISOString();
    lines.push(`_Generated: ${generatedAt}_`);
    lines.push('');
    articles.forEach((a, idx) => {
        const title = a.title || 'Untitled';
        const url = a.url || a.uri || '';
        const header = url ? `${idx+1}. ${title} [link](${url})` : `${idx+1}. ${title}`;
        lines.push(`## ${header}`);
        if (a.executive_takeaway) {
            lines.push(`> ${a.executive_takeaway}`);
        }
        if (a.summary) {
            lines.push('');
            lines.push(a.summary);
        }
        const meta = [];
        if (a.source) meta.push(`Source: ${a.source}`);
        if (a.date) meta.push(`Date: ${a.date}`);
        if (a.time_horizon) meta.push(`Time horizon: ${a.time_horizon}`);
        if (a.risk_opportunity) meta.push(`Risk/Opportunity: ${a.risk_opportunity}`);
        if (a.signal_strength) meta.push(`Signal strength: ${a.signal_strength}`);
        if (meta.length) {
            lines.push('');
            lines.push(meta.map(m => `- ${m}`).join('\n'));
        }
        if (Array.isArray(a.executive_action) && a.executive_action.length) {
            lines.push('');
            lines.push('**Executive actions**');
            a.executive_action.forEach(act => lines.push(`- ${act}`));
        }
        if (Array.isArray(a.related_articles) && a.related_articles.length) {
            lines.push('');
            lines.push('**Related coverage**');
            a.related_articles.forEach(r => {
                const rt = r.title || 'Related';
                if (r.url) lines.push(`- ${r.source ? r.source+': ' : ''}[${rt}](${r.url})`);
                else lines.push(`- ${r.source ? r.source+': ' : ''}${rt}`);
            });
        }
        lines.push('');
    });
    const blob = new Blob([lines.join('\n')], { type: 'text/markdown;charset=utf-8' });
    const urlObj = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlObj;
    a.download = `six-articles-${new Date().toISOString().slice(0,10)}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(urlObj);
}

function exportSixArticlesHTML() {
    const articles = window.lastSixArticles || [];
    if (!articles.length) {
        showNotification('No Six Articles to export. Generate first.', 'warning');
        return;
    }
    const esc = (s) => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const items = articles.map((a, idx) => `
<article class="sa-item">
  <h2>${idx+1}. ${esc(a.title || 'Untitled')}</h2>
  ${a.url || a.uri ? `<p><a href="${esc(a.url || a.uri)}" target="_blank" rel="noopener">Read original</a></p>` : ''}
  ${a.executive_takeaway ? `<blockquote>${esc(a.executive_takeaway)}</blockquote>` : ''}
  ${a.summary ? `<p>${esc(a.summary)}</p>` : ''}
  <ul class="sa-meta">
    ${a.source ? `<li><strong>Source:</strong> ${esc(a.source)}</li>` : ''}
    ${a.date ? `<li><strong>Date:</strong> ${esc(a.date)}</li>` : ''}
    ${a.time_horizon ? `<li><strong>Time horizon:</strong> ${esc(a.time_horizon)}</li>` : ''}
    ${a.risk_opportunity ? `<li><strong>Risk/Opportunity:</strong> ${esc(a.risk_opportunity)}</li>` : ''}
    ${a.signal_strength ? `<li><strong>Signal strength:</strong> ${esc(a.signal_strength)}</li>` : ''}
  </ul>
  ${Array.isArray(a.executive_action) && a.executive_action.length ? `
  <div class="sa-actions">
    <h3>Executive actions</h3>
    <ul>
      ${a.executive_action.map(act => `<li>${esc(act)}</li>`).join('')}
    </ul>
  </div>` : ''}
  ${Array.isArray(a.related_articles) && a.related_articles.length ? `
  <div class="sa-related">
    <h4>Related coverage</h4>
    <ul>
      ${a.related_articles.map(r => `<li>${esc(r.source || '')}${r.source ? ': ' : ''}${r.url ? `<a href="${esc(r.url)}" target="_blank" rel="noopener">${esc(r.title || 'Related')}</a>` : esc(r.title || 'Related')}</li>`).join('')}
    </ul>
  </div>` : ''}
</article>`).join('\n');

    const html = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Six Most Interesting Articles</title>
  <style>
    body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.6;}
    h1{font-size: 1.8rem; margin: 0 0 20px;}
    .sa-item{border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;}
    blockquote{background:#f8f9fa; border-left:4px solid #ddd; margin:10px 0; padding:10px 15px;}
    .sa-meta{color:#555}
  </style>
  <meta name="robots" content="noindex,follow">
</head>
<body>
  <h1>Six Most Interesting Articles</h1>
  <p><em>Generated: ${new Date().toLocaleString()}</em></p>
  ${items}
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const urlObj = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlObj;
    a.download = `six-articles-${new Date().toISOString().slice(0,10)}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(urlObj);
}

async function generateSixArticlesPodcast() {
    const articles = window.lastSixArticles || [];
    if (!articles.length) {
        showNotification('No Six Articles available. Generate the report first.', 'warning');
        return;
    }
    
    // Show loading state
    showPodcastLoading();
    
    try {
        // Extract article URIs from the six articles data
        const articleUris = articles.map(article => {
            // Try different possible URI fields
            return article.uri || article.url || article.article_uri;
        }).filter(Boolean);
        
        if (!articleUris.length) {
            throw new Error('No valid article URIs found in Six Articles data');
        }
        
        const response = await fetch('/api/generate_tts_podcast', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                podcast_name: "Six Articles Briefing",
                episode_title: `Six Articles - ${new Date().toLocaleDateString()}`,
                mode: "bulletin",
                duration: "long", // 7+ minutes
                host_voice_id: "21m00Tcm4TlvDq8ikWAM", // Default voice (Rachel)
                article_uris: articleUris
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        pollPodcastStatus(result.podcast_id);
    } catch (error) {
        hidePodcastLoading();
        showNotification('Error generating podcast: ' + error.message, 'error');
    }
}

function showPodcastLoading() {
    // Find the export dropdown button and show loading state
    const exportBtn = document.querySelector('.btn-group .dropdown-toggle');
    if (exportBtn) {
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        exportBtn.disabled = true;
    }
    
    // Show notification
    showNotification('Generating podcast from Six Articles...', 'info');
}

function hidePodcastLoading() {
    // Restore the export dropdown button
    const exportBtn = document.querySelector('.btn-group .dropdown-toggle');
    if (exportBtn) {
        exportBtn.innerHTML = '<i class="fas fa-download me-2"></i>Export';
        exportBtn.disabled = false;
    }
}

function pollPodcastStatus(podcastId) {
    const checkStatus = async () => {
        try {
            const response = await fetch(`/api/podcast/status/${podcastId}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            switch (data.status) {
                case 'completed':
                    hidePodcastLoading();
                    showPodcastDownload(data.audio_url, data.title);
                    break;
                case 'failed':
                    hidePodcastLoading();
                    showNotification('Podcast generation failed', 'error');
                    break;
                case 'processing':
                default:
                    // Continue polling
                    setTimeout(checkStatus, 5000);
                    break;
            }
        } catch (error) {
            hidePodcastLoading();
            showNotification('Error checking podcast status: ' + error.message, 'error');
        }
    };
    
    // Start polling
    checkStatus();
}

function showPodcastDownload(audioUrl, title) {
    // Create download link
    const downloadLink = document.createElement('a');
    downloadLink.href = audioUrl;
    downloadLink.download = `${title || 'six-articles-podcast'}.mp3`;
    downloadLink.className = 'btn btn-success btn-sm';
    downloadLink.innerHTML = '<i class="fas fa-download me-2"></i>Download Podcast';
    
    // Find the Six Articles export area specifically
    const sixArticlesTab = document.getElementById('six-articles-content');
    const exportArea = sixArticlesTab ? sixArticlesTab.querySelector('.d-flex.gap-2') : null;
    if (exportArea) {
        // Remove any existing podcast download link
        const existingLink = exportArea.querySelector('.podcast-download-link');
        if (existingLink) {
            existingLink.remove();
        }
        
        // Add new download link
        downloadLink.classList.add('podcast-download-link');
        exportArea.appendChild(downloadLink);
    }
    
    showNotification('Podcast generated successfully!', 'success');
}

function getBiasBadge(bias) {
    if (!bias) return '';
    
    const biasClasses = {
        'left': 'bias-left',
        'left-center': 'bias-left-center',
        'center': 'bias-center',
        'right-center': 'bias-right-center',
        'right': 'bias-right',
        'mixed': 'bias-mixed'
    };
    
    const className = biasClasses[bias] || 'bias-mixed';
    return `<span class="bias-badge ${className}">${bias}</span>`;
}

function getFactualityBadge(factuality) {
    if (!factuality) return '';
    
    const factualityClasses = {
        'very-high': 'factuality-very-high',
        'high': 'factuality-high',
        'mostly-factual': 'factuality-mostly-factual',
        'mixed': 'factuality-mixed',
        'low': 'factuality-low',
        'very-low': 'factuality-low'
    };
    
    const className = factualityClasses[factuality] || 'factuality-mixed';
    const displayText = factuality.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
    return `<span class="factuality-badge ${className}">${displayText}</span>`;
}

// Legacy share functionality - replaced with save feed functionality above

// Old share functionality removed - these elements no longer exist

function showSaveButton() {
    // Save and export buttons have been removed - this function is now a no-op
    // Keep for compatibility with existing calls
}

function renderArticlesPagination(data) {
    const paginationContainer = document.getElementById('articles-pagination');
    if (!paginationContainer || !data.total_pages || data.total_pages <= 1) {
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }

    const currentPage = data.page || 1;
    const totalPages = data.total_pages;
    
    let html = '<nav><ul class="pagination pagination-sm justify-content-center">';
    
    // Previous button
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${currentPage - 1}); return false;">Previous</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Previous</span></li>';
    }
    
    // Page numbers (show max 5 pages around current)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(1); return false;">1</a></li>';
        if (startPage > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${i}); return false;">${i}</a></li>`;
        }
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${currentPage + 1}); return false;">Next</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Next</span></li>';
    }
    
    html += '</ul></nav>';
    paginationContainer.innerHTML = html;
}

// Calendar functionality
let availableDates = {};
let selectedDate = '2025-09-15';
// Set calendar to show September 2025 (month of selected date)
let currentCalendarMonth = 8; // September (0-based)
let currentCalendarYear = 2025;

async function loadAvailableDates() {
    console.log('Starting loadAvailableDates...');
    try {
        console.log('Fetching available dates from API...');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch('/api/news-feed/available-dates', {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        console.log('Response received:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Data parsed:', data);
        
        if (data.success) {
            console.log('Processing dates...');
            availableDates = {};
            data.dates.forEach(dateInfo => {
                availableDates[dateInfo.date] = dateInfo.count;
            });
            console.log('Available dates processed:', Object.keys(availableDates).length, 'dates');
            
            console.log('Rendering calendar...');
            renderCalendar();
            console.log('Calendar rendered');

            // Hide loading, show calendar
            const loading = document.getElementById('calendar-loading');
            const view = document.getElementById('calendar-view');
            if (loading) loading.style.display = 'none';
            if (view) view.style.display = 'block';

            // Update selected-date count if known and initialize calendar to selected date month
            const countEl = document.getElementById('selected-date-count');
            const currentDate = document.getElementById('selected-date')?.value;
            if (countEl) countEl.textContent = String(availableDates[currentDate] ?? 0);
            
            // Set calendar to show the month of the selected date
            if (currentDate) {
                const [year, month] = currentDate.split('-').map(Number);
                currentCalendarYear = year;
                currentCalendarMonth = month - 1; // JS months are 0-based
            }
            console.log('loadAvailableDates completed successfully');
        } else {
            console.error('API returned success: false', data);
            throw new Error(data.message || 'Unknown error from API');
        }
    } catch (error) {
        console.error('Error loading available dates:', error);
        const loading = document.getElementById('calendar-loading');
        if (loading) {
            if (error.name === 'AbortError') {
                loading.innerHTML = `
                    <div class="text-danger">Calendar loading timed out.</div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableDates()">Retry</button>
                    <div class="mt-2 small text-muted">You can still use the date picker above to select dates.</div>
                `;
            } else {
                loading.innerHTML = `
                    <div class="text-danger">Failed to load calendar: ${error.message}</div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableDates()">Retry</button>
                    <div class="mt-2 small text-muted">You can still use the date picker above to select dates.</div>
                `;
            }
        }
    }
}

function renderCalendar() {
    console.log('renderCalendar started');
    const view = document.getElementById('calendar-view');
    const loading = document.getElementById('calendar-loading');
    if (!view) {
        console.error('calendar-view element not found');
        return;
    }

    if (loading) loading.style.display = 'none';
    console.log('Calendar loading hidden, building HTML...');

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Get first day of month and number of days
    const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
    const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeCalendarMonth(-1)">‹ Prev</button>
            <h6 class="mb-0">${monthNames[currentCalendarMonth]} ${currentCalendarYear}</h6>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeCalendarMonth(1)">Next ›</button>
        </div>`;

    // Calendar header
    html += '<div class="row g-1 mb-2">';
    for (const day of dayNames) {
        html += `<div class="col text-center"><small class="text-muted fw-bold">${day}</small></div>`;
    }
    html += '</div>';

    // Calendar days
    html += '<div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
    
    // Empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day-empty" style="height: 40px;"></div>';
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const count = availableDates[dateStr] ?? 0;
        const isSelected = dateStr === selectedDate;
        const hasArticles = count > 0;
        
        let buttonClass = 'btn btn-sm w-100 h-100 d-flex flex-column justify-content-center align-items-center';
        if (isSelected) {
            buttonClass += ' btn-primary';
        } else if (hasArticles) {
            buttonClass += ' btn-outline-primary';
        } else {
            buttonClass += ' btn-outline-light text-muted';
        }

        html += `
            <button type="button" class="${buttonClass}" data-date="${dateStr}" style="height: 40px; font-size: 0.8rem;" ${!hasArticles ? 'disabled' : ''}>
                <div>${day}</div>
                ${hasArticles ? `<small class="badge bg-secondary rounded-pill" style="font-size: 0.6rem;">${count}</small>` : ''}
            </button>`;
    }

    html += '</div>';
    console.log('Calendar HTML built, setting innerHTML...');
    view.innerHTML = html;
    view.style.display = 'block';
    console.log('Calendar HTML set, wiring click handlers...');

    // Wire click handlers
    view.querySelectorAll('[data-date]:not([disabled])').forEach((btn) => {
        btn.addEventListener('click', () => {
            const d = btn.getAttribute('data-date');
            setSelectedDate(d);
        });
    });
    console.log('renderCalendar completed');
}

function changeCalendarMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    }
    renderCalendar();
}

function setSelectedDate(dateStr) {
    // Update global and hidden input
    selectedDate = dateStr;
    const hidden = document.getElementById('selected-date');
    if (hidden) hidden.value = dateStr;

    // Update header display
    const [y, m, d] = dateStr.split('-').map(Number);
    const display = document.getElementById('selected-date-text');
    if (display) {
        const dateObj = new Date(y, m - 1, d);
        display.textContent = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Update count immediately if known, otherwise loading
    const countEl = document.getElementById('selected-date-count');
    if (countEl) countEl.textContent = (availableDates[dateStr] ?? 'loading...');

    // Close the calendar collapse if open
    try {
        const collapseEl = document.getElementById('calendar-collapse');
        if (collapseEl && collapseEl.classList.contains('show') && window.bootstrap && bootstrap.Collapse) {
            const instance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
            instance.hide();
        }
    } catch (_) { /* no-op if bootstrap not available */ }

    // Reload content for the newly selected date
    loadArticles(1);
    loadSixArticles();
}

// Organizational profile management
async function loadOrganizationalProfiles() {
    try {
        const response = await fetch('/api/organizational-profiles');
        const data = await response.json();
        
        if (data.success && data.profiles) {
            const profileSelect = document.getElementById('profile-select');
            
            // Clear existing options except the first
            profileSelect.innerHTML = '<option value="">General Analysis (No Profile)</option>';
            
            // Add profiles
            data.profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name}${profile.is_default ? ' (Default)' : ''}`;
                option.title = `${profile.industry || 'General'} • ${profile.organization_type || 'Organization'}`;
                profileSelect.appendChild(option);
            });
            
            // Restore saved profile selection after loading profiles
            const savedProfile = localStorage.getItem('newsFeedProfileId');
            if (savedProfile) {
                const opt = Array.from(profileSelect.options).find(o => o.value === savedProfile);
                if (opt) {
                    profileSelect.value = savedProfile;
                    console.log(`Restored saved profile: ${savedProfile}`);
                } else {
                    console.warn(`Saved profile ${savedProfile} not found in loaded profiles`);
                }
            }
            
            // Add change listener to save future selections (if not already added)
            if (!profileSelect.dataset.listenerAdded) {
                profileSelect.addEventListener('change', () => {
                    localStorage.setItem('newsFeedProfileId', profileSelect.value);
                    console.log(`Saved profile selection: ${profileSelect.value}`);
                    updateArticleCountForDateRange();
                });
                profileSelect.dataset.listenerAdded = 'true';
            }
            
            console.log(`Loaded ${data.profiles.length} organizational profiles`);
        }
    } catch (error) {
        console.error('Error loading organizational profiles:', error);
        showNotification('Failed to load organizational profiles', 'warning');
    }
}

// Date range handling
function handleDateRangeChange() {
    const dateRangeSelect = document.getElementById('date-range-select');
    const customDateSection = document.getElementById('custom-date-section');
    const dateRangeText = document.getElementById('date-range-text');
    const selectedDateInput = document.getElementById('selected-date');
    
    const selectedRange = dateRangeSelect.value;
    
    if (selectedRange === 'custom') {
        customDateSection.style.display = 'block';
        dateRangeText.textContent = 'Custom Date';
        // Use the custom date input value
        selectedDateInput.value = document.getElementById('custom-date-input').value;
    } else {
        customDateSection.style.display = 'none';
        
        // Calculate date range and update display
        const now = new Date();
        let startDate, endDate = now;
        let displayText = '';
        
        switch (selectedRange) {
            case '24h':
                startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                displayText = 'Last 24 Hours';
                selectedDateInput.value = now.toISOString().split('T')[0];
                break;
            case '7d':
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                displayText = 'Last 7 Days';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '30d':
                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                displayText = 'Last 30 Days';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '3m':
                startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                displayText = 'Last 3 Months';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '1y':
                startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                displayText = 'Last Year';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case 'all':
                displayText = 'All Time';
                selectedDateInput.value = 'all';
                break;
        }
        
        dateRangeText.textContent = displayText;
        
        // Update the info text
        const dateRangeInfo = document.getElementById('date-range-info');
        if (dateRangeInfo) {
            if (selectedRange === 'all') {
                dateRangeInfo.textContent = 'All available articles';
            } else {
                const startDateStr = startDate ? startDate.toLocaleDateString() : '';
                const endDateStr = endDate.toLocaleDateString();
                dateRangeInfo.textContent = `${startDateStr} to ${endDateStr}`;
            }
        }
    }
    
    // Auto-reload articles when date range changes
    autoLoadArticles();
    
    // Clear insights when date range changes
    clearInsightsContent();
}

// Update article count for date range changes
async function updateArticleCountForDateRange() {
    const countEl = document.getElementById('selected-date-count');
    if (!countEl) return;
    
    try {
        countEl.textContent = 'loading...';
        
        const dateRangeEl = document.getElementById('date-range-select');
        if (!dateRangeEl) {
            console.warn('date-range-select element not found');
            countEl.textContent = '0';
            return;
        }
        const dateRangeValue = dateRangeEl.value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            count_only: 'true'
        });
        
        // Add custom date if needed
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            if (customDate) {
                params.append('date', customDate);
            }
        }
        
        // Add topic filter if set
        const topicEl = document.getElementById('topic-select');
        if (topicEl && topicEl.value) {
            params.append('topic', topicEl.value.trim());
        }
        
        // Make a lightweight request to get just the count
        const response = await fetch(`/api/news-feed/articles?${params}&per_page=1&page=1`);
        
        if (response.ok) {
            const data = await response.json();
            const total = data.articles?.total_items || 0;
            countEl.textContent = total.toString();
        } else {
            countEl.textContent = '0';
        }
    } catch (error) {
        console.error('Error updating article count:', error);
        countEl.textContent = '?';
    }
}

// Star functionality for articles
let starredArticles = new Set();

// Filter functionality for articles
let activeFilters = {
    bias: new Set(),
    factuality: new Set(),
    category: new Set(),
    signals: new Set()  // Add signal filtering
};

function renderArticles(articlesData) {
    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '';
    
    if (!articlesData.items || articlesData.items.length === 0) {
        listContainer.innerHTML = '<div class="alert alert-info">No articles available.</div>';
        document.getElementById('articles-filters').style.display = 'none';
        return;
    }
    
    // Build filter badges from available data
    buildFilterBadges(articlesData.items);
    
    // Apply current filters
    const filteredArticles = applyArticleFilters(articlesData.items);
    
    const articlesList = document.createElement('div');
    articlesList.className = 'list-group list-group-flush mt-2';
    
    filteredArticles.forEach(article => {
        const articleItem = document.createElement('div');
        articleItem.className = 'list-group-item position-relative';
        
        const isStarred = starredArticles.has(article.uri);
        
        articleItem.innerHTML = `
            <!-- Remove button (top-right) -->
            <button class="btn btn-sm position-absolute" 
                    style="top: 8px; right: 8px; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; border: none; background: rgba(220, 53, 69, 0.1); color: #dc3545; border-radius: 50%;"
                    onclick="excludeArticle('${article.uri}', this)"
                    onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                    onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'; this.style.color='#dc3545';"
                    title="Remove article">×</button>
            
            <!-- Star button (top-left) -->
            <button class="btn btn-sm position-absolute star-btn ${isStarred ? 'starred' : ''}" 
                    style="top: 8px; left: 8px; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; border: none; background: ${isStarred ? '#ffc107' : 'rgba(255, 193, 7, 0.1)'}; color: ${isStarred ? 'white' : '#ffc107'}; border-radius: 50%;"
                    onclick="toggleStarArticle('${article.uri}', this)"
                    title="${isStarred ? 'Remove from Six Articles' : 'Add to Six Articles'}">★</button>
            
            
            <!-- Expand arrow (left side) -->
            <button class="btn btn-sm position-absolute expand-arrow-btn" 
                    style="top: 50%; left: -2px; transform: translateY(-50%); width: 20px; height: 40px; padding: 0; font-size: 12px; border: none; background: #007bff; color: white; border-radius: 0 8px 8px 0; box-shadow: 2px 0 4px rgba(0,0,0,0.1);"
                    onclick="toggleArticleDetails('${article.uri}', this)"
                    title="Show detailed view">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Two Column Layout -->
            <div class="row" style="margin-left: 30px; margin-right: 30px;">
                <!-- Column 1: Content -->
                <div class="col-md-8">
                    <h6 class="mb-2">
                        <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                            ${escapeHTML(article.title)}
                        </a>
                        <span class="cached-indicator" id="cached-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none;">
                            <span class="badge bg-info text-white ms-2" style="font-size: 8px;">
                                <i class="fas fa-database me-1"></i>Cached
                            </span>
                        </span>
                        <span class="signal-flags" id="signal-flags-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}"></span>
                    </h6>
                    <p class="mb-1 small text-muted">
                        <i class="fas fa-building me-1"></i>${formatSource(article.news_source, article.uri)}
                        <span class="ms-2">
                            <i class="fas fa-calendar me-1"></i>${formatPubDate(article.publication_date, false)}
                        </span>
                    </p>
                    <p class="mb-0 small text-secondary" style="line-height: 1.4;">
                        ${escapeHTML(article.summary)}
                    </p>
                </div>
                
                <!-- Column 2: Metadata -->
                <div class="col-md-4">
                    <div class="d-flex flex-column gap-1 h-100 justify-content-center">
                        ${article.bias ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Political Bias:</span>
                            <span class="badge ${getBiasClass(article.bias)}">${article.bias}</span>
                        </div>` : ''}
                        
                        ${article.factual_reporting ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Factual:</span>
                            <span class="badge ${getFactualityClass(article.factual_reporting)}">${article.factual_reporting}</span>
                        </div>` : ''}
                        
                        ${article.mbfc_credibility_rating ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Credibility:</span>
                            <span class="badge bg-info text-white">${article.mbfc_credibility_rating}</span>
                        </div>` : ''}
                        
                        ${article.category ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Category:</span>
                            <span class="badge bg-light text-dark">${article.category}</span>
                        </div>` : ''}
                        
                    </div>
                </div>
            </div>
            
            <!-- Detailed View (Initially Hidden) -->
            <div class="article-details" id="details-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-left: 20px; margin-right: 10px; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                <div class="row">
                    <!-- Left Column: Enhanced Summary & Analysis -->
                    <div class="col-md-8">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-search-plus me-2"></i>Detailed Analysis
                        </h6>
                        
                        <div class="mb-3">
                            <h6 class="text-secondary">Full Summary</h6>
                            <p class="small">${escapeHTML(article.summary)}</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="text-secondary">Auspex Analysis</h6>
                            <div class="analysis-content bg-white p-3 rounded border" id="analysis-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                <div class="analysis-text bg-light p-2 rounded small text-muted">
                                    Analysis will be generated automatically when you expand this article.
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                    
                    <!-- Right Column: Complete Metadata -->
                    <div class="col-md-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>Complete Metadata
                        </h6>
                        
                        <div class="metadata-grid">
                            <!-- Enhanced metadata for detailed view -->
                            ${article.sentiment ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Sentiment</small>
                                <span class="badge ${getSentimentClass(article.sentiment)}">${article.sentiment}</span>
                                ${article.sentiment_explanation ? `<br><small class="text-muted">${article.sentiment_explanation}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.driver_type || article.driver_type_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Driver Type</small>
                                ${article.driver_type ? `<span class=\"badge bg-secondary\">${article.driver_type}</span>` : ''}
                                ${article.driver_type_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.driver_type_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.time_to_impact || article.time_to_impact_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Time to Impact</small>
                                ${article.time_to_impact ? `<span class=\"badge bg-warning text-dark\">${article.time_to_impact}</span>` : ''}
                                ${article.time_to_impact_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.time_to_impact_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.future_signal || article.future_signal_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Future Signal</small>
                                ${article.future_signal ? `<span class=\"badge bg-dark text-white\">${article.future_signal}</span>` : ''}
                                ${article.future_signal_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.future_signal_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${article.tags ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Tags</small>
                                <div class="d-flex flex-wrap gap-1">
                                    ${(() => {
                                        let tags = [];
                                        if (Array.isArray(article.tags)) {
                                            tags = article.tags;
                                        } else if (typeof article.tags === 'string') {
                                            tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                                        }
                                        return tags.map(tag => {
                                            // Highlight signal tags differently
                                            if (tag.startsWith('signal:')) {
                                                const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                                                return `<span class="badge bg-danger text-white" style="font-size: 8px;" title="Flagged by signal: ${escapeHTML(signalName)}"><i class="fas fa-flag me-1"></i>${escapeHTML(signalName)}</span>`;
                                            } else {
                                                return `<span class="badge bg-light text-dark" style="font-size: 8px;">${escapeHTML(tag)}</span>`;
                                            }
                                        }).join('');
                                    })()}
                                </div>
                            </div>` : ''}
                            
            <!-- View & Analysis Options (Detailed View Only) -->
            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                <small class="text-muted d-block mb-1">View Options</small>
                <div class="d-flex flex-wrap gap-1 mb-2">
                    <button class="btn btn-outline-info btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="window.open('https://12ft.io/${article.uri}', '_blank')"
                            title="View via 12ft.io (bypass paywall)">
                        <i class="fas fa-unlock-alt me-1"></i>12ft
                    </button>
                    <button class="btn btn-outline-warning btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="window.open('https://archive.is/${article.uri}', '_blank')"
                            title="View archived version">
                        <i class="fas fa-archive me-1"></i>Archive
                    </button>
                    <button class="btn btn-outline-success btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="openAnnotationModal('${article.uri}')"
                            title="Add annotation">
                        <i class="fas fa-sticky-note me-1"></i>Note
                    </button>
                </div>
                <small class="text-muted d-block mb-1">Analysis Options</small>
                <div class="d-flex flex-wrap gap-1 mb-1">
                    <button class="btn btn-outline-primary btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchAuspexDeepDive('${article.uri}')"
                            title="Generate comprehensive deep-dive analysis">
                        <i class="fas fa-microscope me-1"></i>Deep Dive
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchConsensusAnalysis('${article.uri}')"
                            title="Compare article claims to consensus">
                        <i class="fas fa-balance-scale me-1"></i>Consensus
                    </button>
                    <button class="btn btn-outline-dark btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchTimelineAnalysis('${article.uri}')"
                            title="Analyze impact timeline">
                        <i class="fas fa-clock me-1"></i>Timeline
                    </button>
                </div>
                <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-outline-info btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchAuspexChat('${article.uri}')"
                            title="Chat with Auspex about this article">
                        <i class="fas fa-comments me-1"></i>Ask Auspex
                    </button>
                </div>
            </div>

                            <!-- Research Themes Section (Detailed View Only) -->
                            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                                <small class="text-muted d-block mb-1">Research Themes</small>
                                <div class="research-themes-sidebar" id="themes-sidebar-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="text-muted small">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Loading themes...
                                    </div>
                                </div>
                            </div>

                            <!-- Related Articles Section (Detailed View Only) -->
                            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                                <small class="text-muted d-block mb-1">Related Articles</small>
                                <div class="related-articles-sidebar" id="related-sidebar-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="text-muted small">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Loading...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        articlesList.appendChild(articleItem);
    });
    
    listContainer.appendChild(articlesList);
    updateStarredCount();
    
    // Check for cached analysis and show indicators
    checkCachedAnalysisIndicators(articlesData.items);
    
    // Add signal flags to articles
    addSignalFlagsToArticles(articlesData.items);
    
    // Update count display to show filtered vs total
    const countEl = document.getElementById('selected-date-count');
    if (countEl) {
        const totalCount = articlesData.items.length;
        const filteredCount = filteredArticles.length;
        if (filteredCount !== totalCount) {
            countEl.textContent = `${filteredCount} of ${totalCount}`;
        } else {
            countEl.textContent = totalCount.toString();
        }
    }
    
    // Update pagination based on filtered results
    updatePaginationForFilters(articlesData, filteredArticles);
}

function buildFilterBadges(articles) {
    // Collect unique values
    const biasValues = new Set();
    const factualityValues = new Set();
    const categoryValues = new Set();
    const signalValues = new Set();
    
    articles.forEach(article => {
        if (article.bias) biasValues.add(article.bias);
        if (article.factual_reporting) factualityValues.add(article.factual_reporting);
        if (article.category) categoryValues.add(article.category);
        
        // Check for signal tags
        if (article.tags && Array.isArray(article.tags)) {
            article.tags.forEach(tag => {
                if (tag.startsWith('signal:')) {
                    // Extract signal name: "signal:SIGNAL_NAME" -> "NAME"
                    const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                    signalValues.add(signalName);
                }
            });
        } else if (article.tags && typeof article.tags === 'string') {
            const tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            tags.forEach(tag => {
                if (tag.startsWith('signal:')) {
                    // Extract signal name: "signal:SIGNAL_NAME" -> "NAME"
                    const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                    signalValues.add(signalName);
                }
            });
        }
        
    });
    
    // Build bias filter badges
    const biasContainer = document.getElementById('bias-filters');
    biasContainer.innerHTML = '';
    biasValues.forEach(bias => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm ${getBiasClass(bias)} filter-badge ${activeFilters.bias.has(bias) ? 'active' : ''}`;
        badge.textContent = bias;
        badge.onclick = () => toggleFilter('bias', bias);
        biasContainer.appendChild(badge);
    });
    
    // Build factuality filter badges
    const factualityContainer = document.getElementById('factuality-filters');
    factualityContainer.innerHTML = '';
    factualityValues.forEach(factuality => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm ${getFactualityClass(factuality)} filter-badge ${activeFilters.factuality.has(factuality) ? 'active' : ''}`;
        badge.textContent = factuality;
        badge.onclick = () => toggleFilter('factuality', factuality);
        factualityContainer.appendChild(badge);
    });
    
    // Build category filter badges
    const categoryContainer = document.getElementById('category-filters');
    categoryContainer.innerHTML = '';
    categoryValues.forEach(category => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm bg-light text-dark filter-badge ${activeFilters.category.has(category) ? 'active' : ''}`;
        badge.textContent = category;
        badge.onclick = () => toggleFilter('category', category);
        categoryContainer.appendChild(badge);
    });
    
    // Build signal filter badges
    const signalContainer = document.getElementById('signal-filters');
    if (signalContainer) {
        signalContainer.innerHTML = '';
        signalValues.forEach(signal => {
            const badge = document.createElement('button');
            badge.className = `btn btn-sm bg-danger text-white filter-badge ${activeFilters.signals.has(signal) ? 'active' : ''}`;
            badge.innerHTML = `<i class="fas fa-flag me-1"></i>${signal}`;
            badge.onclick = () => toggleFilter('signals', signal);
            signalContainer.appendChild(badge);
        });
    }
    
    // Show filter section if we have any filters
    if (biasValues.size > 0 || factualityValues.size > 0 || categoryValues.size > 0 || signalValues.size > 0) {
        document.getElementById('articles-filters').style.display = 'block';
    }
}

function toggleFilter(filterType, value) {
    if (activeFilters[filterType].has(value)) {
        activeFilters[filterType].delete(value);
    } else {
        activeFilters[filterType].add(value);
    }
    
    // Re-render articles with new filters
    const articlesData = window.lastArticlesData; // Store this when loading articles
    if (articlesData) {
        renderArticles(articlesData);
    }
}

function applyArticleFilters(articles) {
    return articles.filter(article => {
        // Check bias filter
        if (activeFilters.bias.size > 0 && !activeFilters.bias.has(article.bias)) {
            return false;
        }
        
        // Check factuality filter
        if (activeFilters.factuality.size > 0 && !activeFilters.factuality.has(article.factual_reporting)) {
            return false;
        }
        
        // Check category filter
        if (activeFilters.category.size > 0 && !activeFilters.category.has(article.category)) {
            return false;
        }
        
        // Check signal filter
        if (activeFilters.signals.size > 0) {
            let hasMatchingSignal = false;
            if (article.tags) {
                const tags = Array.isArray(article.tags) ? article.tags : 
                            (typeof article.tags === 'string' ? article.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : []);
                
                for (const tag of tags) {
                    if (tag.startsWith('signal:')) {
                        const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                        if (activeFilters.signals.has(signalName)) {
                            hasMatchingSignal = true;
                            break;
                        }
                    }
                }
            }
            if (!hasMatchingSignal) {
                return false;
            }
        }
        
        return true;
    });
}

let factualFilterMode = 'factual'; // 'factual' or 'opinion'

function toggleFactualFilter() {
    const btn = document.getElementById('factual-toggle-btn');
    
    // Check what factuality values are actually available
    const articlesData = window.lastArticlesData;
    if (!articlesData || !articlesData.items) {
        showNotification('No articles data available for filtering', 'warning');
        return;
    }
    
    // Clear existing filters first
    activeFilters.bias.clear();
    activeFilters.factuality.clear();
    activeFilters.category.clear();
    
    // Collect all factuality values to see what's available
    const availableFactuality = new Set();
    articlesData.items.forEach(article => {
        if (article.factual_reporting) {
            availableFactuality.add(article.factual_reporting);
        }
    });
    
    if (factualFilterMode === 'factual') {
        // Switch to opinion mode
        factualFilterMode = 'opinion';
        btn.innerHTML = '<i class="fas fa-comment"></i> Opinion Only';
        btn.title = 'Showing opinion articles only';
        
        // Add opinion/low factuality filters
        const opinionFactuality = Array.from(availableFactuality).filter(factuality => {
            const lower = factuality.toLowerCase();
            return lower.includes('mixed') || 
                   lower.includes('low') ||
                   lower === 'mixed';
        });
        
        opinionFactuality.forEach(factuality => {
            activeFilters.factuality.add(factuality);
        });
        
        showNotification(`Showing ${opinionFactuality.length} opinion/mixed factuality types`, 'info');
    } else {
        // Switch to factual mode
        factualFilterMode = 'factual';
        btn.innerHTML = '<i class="fas fa-shield-alt"></i> Factual Only';
        btn.title = 'Showing factual articles only';
        
        // Add high-quality factuality filters
        const highQualityFactuality = Array.from(availableFactuality).filter(factuality => {
            const lower = factuality.toLowerCase();
            return lower.includes('high') || 
                   lower.includes('mostly') || 
                   lower.includes('factual') ||
                   lower === 'very high' ||
                   lower === 'high' ||
                   lower === 'mostly factual';
        });
        
        if (highQualityFactuality.length === 0) {
            // If no high-quality matches found, be more lenient
            const acceptableFactuality = Array.from(availableFactuality).filter(factuality => {
                const lower = factuality.toLowerCase();
                return !lower.includes('low') && !lower.includes('very low');
            });
            
            acceptableFactuality.forEach(factuality => {
                activeFilters.factuality.add(factuality);
            });
            
            showNotification(`Showing ${acceptableFactuality.length > 0 ? 'acceptable' : 'all available'} quality sources`, 'info');
        } else {
            highQualityFactuality.forEach(factuality => {
                activeFilters.factuality.add(factuality);
            });
            
            showNotification(`Showing ${highQualityFactuality.length} high-quality source types`, 'success');
        }
    }
    
    // Re-render articles with quality filters
    renderArticles(articlesData);
}

function updatePaginationForFilters(originalData, filteredArticles) {
    const paginationContainer = document.getElementById('articles-pagination');
    if (!paginationContainer) return;
    
    // If filtering is active and reduces results significantly, hide pagination
    const hasActiveFilters = activeFilters.bias.size > 0 || activeFilters.factuality.size > 0 || activeFilters.category.size > 0;
    
    if (hasActiveFilters) {
        // Hide pagination when filtering since we're showing filtered subset
        paginationContainer.innerHTML = '';
        
        // Show filter info instead
        if (filteredArticles.length !== originalData.items.length) {
            paginationContainer.innerHTML = `
                <div class="text-center text-muted small mt-2">
                    <i class="fas fa-filter me-1"></i>
                    Showing ${filteredArticles.length} filtered articles of ${originalData.items.length} total
                    ${originalData.total_pages > 1 ? ` (from ${originalData.total_pages} pages)` : ''}
                </div>
            `;
        }
    } else {
        // Show normal pagination when no filters active
        renderArticlesPagination(originalData);
    }
}

function clearAllFilters() {
    activeFilters.bias.clear();
    activeFilters.factuality.clear();
    activeFilters.category.clear();
    
    // Re-render articles without filters
    const articlesData = window.lastArticlesData;
    if (articlesData) {
        renderArticles(articlesData);
        showNotification('All filters cleared', 'info');
    }
}

// Article detailed view functionality
function toggleArticleDetails(articleUri, buttonElement) {
    const detailsId = `details-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const detailsDiv = document.getElementById(detailsId);
    const icon = buttonElement.querySelector('i');
    
    if (!detailsDiv) return;
    
    if (detailsDiv.style.display === 'none') {
        // Expand
        detailsDiv.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
        buttonElement.title = 'Hide detailed view';
        buttonElement.style.background = '#28a745'; // Green when expanded
        
        // Animate expansion
        detailsDiv.style.opacity = '0';
        detailsDiv.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            detailsDiv.style.transition = 'all 0.3s ease';
            detailsDiv.style.opacity = '1';
            detailsDiv.style.transform = 'translateY(0)';
        }, 10);

        // Auto-generate AI analysis and related articles on expand if a valid model is selected
        try {
            const model = document.getElementById('model-select')?.value;
            const isValid = model && typeof model === 'string' && model.trim().length > 0;
            const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const relatedId = `related-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const analysisDiv = document.getElementById(analysisId);
            const relatedDiv = document.getElementById(relatedId);

            if (!isValid) {
                showNotification('Select a valid AI model to generate analysis', 'warning');
            } else {
                console.log(`Analysis div check: exists=${!!analysisDiv}, loaded=${analysisDiv?.dataset.loaded}`);
                if (analysisDiv && !analysisDiv.dataset.loaded) {
                    console.log(`Generating analysis for ${articleUri}`);
                    generateArticleAnalysis(articleUri);
                } else {
                    console.log(`Skipping analysis generation - already loaded or div missing`);
                }
                // Load related articles for sidebar
                loadRelatedArticlesSidebar(articleUri);
                
                // Generate research themes for sidebar (check if already loaded)
                const themesDiv = document.getElementById(`themes-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`);
                console.log(`Themes div check: exists=${!!themesDiv}, loaded=${themesDiv?.dataset.loaded}`);
                if (themesDiv && !themesDiv.dataset.loaded) {
                    console.log(`Generating themes for ${articleUri}`);
                    generateResearchThemes(articleUri);
                } else {
                    console.log(`Skipping themes generation - already loaded or div missing`);
                }
            }
        } catch (_) { /* best-effort */ }
    } else {
        // Collapse
        detailsDiv.style.transition = 'all 0.3s ease';
        detailsDiv.style.opacity = '0';
        detailsDiv.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            detailsDiv.style.display = 'none';
        }, 300);
        
        icon.className = 'fas fa-chevron-right';
        buttonElement.title = 'Show detailed view';
        buttonElement.style.background = '#007bff'; // Blue when collapsed
    }
}

async function generateArticleAnalysis(articleUri) {
    const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const analysisDiv = document.getElementById(analysisId);
    
    if (!analysisDiv) return;
    
    // Check for cached analysis first (database + localStorage fallback)
    const selectedModel = document.getElementById('model-select')?.value;
    
    console.log(`=== CACHE CHECK START ===`);
    console.log(`Article URI: ${articleUri}`);
    console.log(`Selected Model: ${selectedModel}`);
    console.log(`Analysis div loaded: ${analysisDiv.dataset.loaded}`);
    
    // Try database cache first
    try {
        console.log(`Checking cache for: ${articleUri} with model: ${selectedModel}`);
        const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(articleUri)}&analysis_type=summary&model=${encodeURIComponent(selectedModel)}`);
        console.log(`Cache response status: ${cacheResponse.status}`);
        
        if (cacheResponse.ok) {
            const cacheData = await cacheResponse.json();
            console.log('Cache response data:', cacheData);
            
            if (cacheData.cached) {
                console.log('Using cached analysis from database');
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                analysisDiv.innerHTML = `
                    <div class="analysis-text bg-info-subtle p-3 rounded border">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-database me-2 text-info"></i>
                                <strong class="text-info">Strategic Analysis (DB Cache)</strong>
                                <span class="badge bg-info ms-2">${cacheData.model_used}</span>
                            </div>
                            <small class="text-muted">Generated: ${cacheDate}</small>
                        </div>
                        ${cacheData.content}
                    </div>
                `;
                analysisDiv.dataset.loaded = 'true';
                return;
            } else {
                console.log('No cached analysis found in database');
            }
        } else {
            console.warn(`Cache API returned ${cacheResponse.status}`);
        }
    } catch (e) {
        console.warn('Database cache failed, checking localStorage:', e);
    }
    
    // Fallback to localStorage cache
    try {
        const localCacheKey = `analysis_cache_${articleUri}_summary_${selectedModel}`;
        const localCache = localStorage.getItem(localCacheKey);
        if (localCache) {
            const cacheData = JSON.parse(localCache);
            const cacheAge = new Date() - new Date(cacheData.generated_at);
            const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
            
            if (cacheAge < maxAge) {
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                analysisDiv.innerHTML = `
                    <div class="analysis-text bg-warning-subtle p-3 rounded border">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-hdd me-2 text-warning"></i>
                                <strong class="text-warning">Strategic Analysis (Local Cache)</strong>
                                <span class="badge bg-warning ms-2">${cacheData.model_used}</span>
                            </div>
                            <small class="text-muted">Generated: ${cacheDate}</small>
                        </div>
                        ${cacheData.content}
                    </div>
                `;
                analysisDiv.dataset.loaded = 'true';
                return;
            } else {
                // Cache expired, remove it
                localStorage.removeItem(localCacheKey);
            }
        }
    } catch (e) {
        console.warn('localStorage cache check failed:', e);
    }
    
    try {
        analysisDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Generating analysis...
            </div>
        `;
        
        // Get the selected model
        const selectedModel = document.getElementById('model-select').value;
        console.log(`Generating analysis for ${articleUri} using model: ${selectedModel}`);
        
        // Get the article data from our current dataset
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Article not found in current dataset');
        }
        
        // Prefer raw-text endpoint, fall back to legacy metadata summary
        let response = await fetch('/api/vector-summary-raw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: [articleUri], model: selectedModel || 'gpt-4.1-mini' })
        });
        if (!response.ok) {
            console.warn('Raw summary failed, falling back to legacy summary');
            response = await fetch('/api/vector-summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: [articleUri], model: selectedModel || 'gpt-4.1-mini' })
            });
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error Response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
        }
        
        const responseText = await response.text();
        console.log('Raw API response:', responseText);
        
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (jsonError) {
            console.error('JSON Parse Error:', jsonError);
            console.log('Response that failed to parse:', responseText);
            throw new Error(`Invalid JSON response: ${jsonError.message}`);
        }
        
        let analysis = result.response || result.message || result.content || 'No analysis available';
        // Normalize to single-article framing
        analysis = analysis
            // Remove common cluster lead-ins
            .replace(/^\s*Cluster Summary:.*$/gmi, '')
            .replace(/^\s*Summary of .*?cluster.*$/gmi, 'Article Summary')
            .replace(/^\s*This cluster[^\n]*$/gmi, '')
            .replace(/^\s*Overall, the cluster[^\n]*$/gmi, '')
            // Re-label section headers
            .replace(/^\s*Key Themes\s*$/gmi, '## Key Themes')
            .replace(/^\s*Sentiment\s*$/gmi, '## Sentiment')
            // Drop multi-article sections entirely
            .replace(/(^\s*(Notable|Key) Articles[\s\S]*?)(?=^\s*##\s|^\s*#\s|\Z)/gmi, '')
            // Tone down remaining cluster words
            .replace(/\b[Cc]lusters\b/g, 'articles')
            .replace(/\b[Cc]luster\b/g, 'article')
            // Clean horizontal rules
            .replace(/^\s*-{3,}\s*$/gm, '')
            .trim();
        
        if (!analysis || analysis.trim() === '') {
            throw new Error('Empty analysis response');
        }
        
        // Format the response properly
        const formattedAnalysis = formatMarkdownAnalysis(analysis);
        const timestamp = new Date().toISOString();
        const displayDate = new Date().toLocaleString();
        
        // Cache the analysis in database with localStorage fallback
        try {
            const cacheResponse = await fetch('/api/save-analysis-cache', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    article_uri: articleUri,
                    analysis_type: 'summary',
                    content: formattedAnalysis,
                    model_name: selectedModel
                })
            });
            
            if (cacheResponse.ok) {
                console.log('Analysis cached to database successfully');
            } else {
                throw new Error(`Database cache failed: ${cacheResponse.status}`);
            }
        } catch (cacheError) {
            console.warn('Database cache failed, using localStorage fallback:', cacheError);
            
            // Fallback to localStorage
            const cacheData = {
                content: formattedAnalysis,
                model_used: selectedModel,
                generated_at: new Date().toISOString(),
                analysis_type: 'summary'
            };
            localStorage.setItem(`analysis_cache_${articleUri}_summary_${selectedModel}`, JSON.stringify(cacheData));
        }
        
        analysisDiv.innerHTML = `
            <div class="analysis-text bg-success-subtle p-3 rounded border">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                    <i class="fas fa-robot me-2 text-success"></i>
                    <strong class="text-success">Strategic Analysis</strong>
                    <span class="badge bg-success ms-2">${selectedModel}</span>
                    </div>
                    <small class="text-muted">Generated: ${displayDate}</small>
                </div>
                ${formattedAnalysis}
            </div>
        `;
        analysisDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error generating article analysis:', error);
        
        // Show clear error message about server configuration
        analysisDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Analysis Unavailable</h6>
                <p class="mb-2">Vector routes not mounted on server. Analysis endpoints returning 404.</p>
                <small class="text-muted">
                    <strong>Solution:</strong> Ensure your server instance mounts vector_routes via app/core/routers.py
                </small>
            </div>
        `;
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (article) {
            const enhancedAnalysis = generateEnhancedAnalysis(article);
            analysisDiv.innerHTML = `
                <div class="analysis-text bg-warning-subtle p-3 rounded border">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        <strong class="text-warning">Analysis Failed</strong>
                        <span class="badge bg-warning text-dark ms-2">Using Enhanced Metadata</span>
                    </div>
                    <div class="alert alert-warning alert-sm mb-3">
                        <small><strong>Error:</strong> ${error.message}</small>
                    </div>
                    ${enhancedAnalysis}
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="generateArticleAnalysis('${articleUri}')">
                            <i class="fas fa-sync me-1"></i>Retry Analysis
                        </button>
                    </div>
                </div>
            `;
        } else {
            analysisDiv.innerHTML = `
                <div class="text-danger small">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }
}

// Enhanced Analysis feature removed per requirements

async function loadRelatedArticles(articleUri) {
    const relatedId = `related-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const relatedDiv = document.getElementById(relatedId);
    
    if (!relatedDiv) return;
    
    try {
        relatedDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Finding related articles...
            </div>
        `;
        
        // Call vector similarity API
        const response = await fetch(`/api/vector-similar?uri=${encodeURIComponent(articleUri)}&top_k=5`);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const relatedArticles = result.results || [];
        
        if (relatedArticles.length === 0) {
            relatedDiv.innerHTML = `
                <div class="text-muted small">
                    <i class="fas fa-info-circle me-2"></i>
                    No related articles found
                </div>
            `;
            return;
        }
        
        let relatedHtml = '<ul class="list-unstyled mb-0">';
        relatedArticles.forEach((related) => {
            const metadata = related.metadata || {};
            const similarity = (related.score * 100).toFixed(0);
            const truncatedSummary = (metadata.summary || '').trim();
            const summaryShort = truncatedSummary ? escapeHTML(truncatedSummary.substring(0, 110)) + (truncatedSummary.length > 110 ? '…' : '') : '';
            relatedHtml += `
                <li class="py-1 border-0">
                    <div class="d-flex align-items-start justify-content-between gap-2">
                        <div class="flex-grow-1">
                            <a href="${metadata.uri}" target="_blank" rel="noopener" class="text-decoration-none small fw-semibold">${escapeHTML(metadata.title || 'Untitled')}</a>
                            <div class="small text-muted">
                                <i class="fas fa-building me-1"></i>${escapeHTML(metadata.news_source || 'Unknown')}
                                ${metadata.category ? `<span class="ms-2 badge bg-light text-dark">${metadata.category}</span>` : ''}
                                ${metadata.bias ? `<span class="ms-1 badge ${getBiasClass(metadata.bias)}">${metadata.bias}</span>` : ''}
                                ${metadata.factual_reporting ? `<span class="ms-1 badge ${getFactualityClass(metadata.factual_reporting)}">${metadata.factual_reporting}</span>` : ''}
                            </div>
                            ${summaryShort ? `<div class="small text-secondary">${summaryShort}</div>` : ''}
                        </div>
                        <span class="badge bg-secondary align-self-start">${similarity}%</span>
                    </div>
                </li>`;
        });
        relatedHtml += '</ul>';
        
        relatedDiv.innerHTML = relatedHtml;
        relatedDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error loading related articles:', error);
        relatedDiv.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading related articles: ${error.message}
            </div>
        `;
    }
}

function formatMarkdownAnalysis(markdown) {
    // Convert markdown to HTML for better display
    let html = markdown;
    
    // Convert headers
    html = html.replace(/^### (.*$)/gm, '<h6 class="text-primary mt-3 mb-2">$1</h6>');
    html = html.replace(/^## (.*$)/gm, '<h5 class="text-primary mt-4 mb-3">$1</h5>');
    html = html.replace(/^# (.*$)/gm, '<h4 class="text-primary mt-4 mb-3">$1</h4>');
    
    // Convert bold text
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert bullet points
    html = html.replace(/^- (.*$)/gm, '<li class="mb-1">$1</li>');
    
    // Wrap consecutive list items in ul tags
    html = html.replace(/(<li.*?<\/li>\s*)+/g, '<ul class="mb-3">$&</ul>');
    
    // Convert paragraphs (double line breaks)
    html = html.replace(/\n\n/g, '</p><p class="mb-2">');
    html = '<p class="mb-2">' + html + '</p>';
    
    // Clean up empty paragraphs
    html = html.replace(/<p class="mb-2"><\/p>/g, '');
    html = html.replace(/<p class="mb-2">\s*<\/p>/g, '');
    
    // Convert horizontal rules
    html = html.replace(/^---$/gm, '<hr class="my-3">');
    
    // Clean up any remaining newlines
    html = html.replace(/\n/g, '<br>');
    
    return html;
}


// Enhanced markdown formatter for Auspex research results
function formatAuspexMarkdown(markdown) {
    if (!markdown || typeof markdown !== 'string') {
        return '<div class="text-muted">No content available</div>';
    }
    
    // Use marked.js for proper markdown rendering if available
    if (typeof marked !== 'undefined') {
        try {
            // Configure marked for better rendering
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            
            let html = marked.parse(markdown);
            
            // Add Bootstrap classes for better styling
            html = html.replace(/<table>/g, '<table class="table table-striped table-sm mt-3">');
            html = html.replace(/<h1>/g, '<h1 class="text-primary">');
            html = html.replace(/<h2>/g, '<h2 class="text-primary mt-4 mb-3">');
            html = html.replace(/<h3>/g, '<h3 class="text-primary mt-3 mb-2">');
            html = html.replace(/<h4>/g, '<h4 class="text-secondary mt-3 mb-2">');
            html = html.replace(/<h5>/g, '<h5 class="text-secondary mt-2 mb-2">');
            html = html.replace(/<h6>/g, '<h6 class="text-secondary mt-2 mb-1">');
            html = html.replace(/<ul>/g, '<ul class="mb-3">');
            html = html.replace(/<ol>/g, '<ol class="mb-3">');
            html = html.replace(/<li>/g, '<li class="mb-1">');
            html = html.replace(/<blockquote>/g, '<blockquote class="blockquote border-start border-primary ps-3 ms-3">');
            html = html.replace(/<code>/g, '<code class="bg-light text-dark px-1 rounded">');
            html = html.replace(/<pre>/g, '<pre class="bg-light p-3 rounded">');
            html = html.replace(/<hr>/g, '<hr class="my-4">');
            
            return html;
        } catch (error) {
            console.warn('Marked.js parsing failed, falling back to simple formatting:', error);
        }
    }
    
    // Fallback to simple formatting if marked.js isn't available
    return formatMarkdownAnalysis(markdown);
}

function generateEnhancedAnalysis(article) {
    let analysis = '';
    
    // Strategic insights section
    analysis += '<h6 class="text-primary mt-0 mb-2">Key Strategic Insights</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.category) {
        analysis += `<li class="mb-1">Categorized as <strong>${article.category}</strong>, indicating relevance to current sector developments</li>`;
    }
    
    if (article.time_to_impact && article.driver_type) {
        analysis += `<li class="mb-1">Expected <strong>${article.time_to_impact.toLowerCase()}</strong> impact, acting as a <strong>${article.driver_type.toLowerCase()}</strong> for related trends</li>`;
    }
    
    if (article.future_signal) {
        analysis += `<li class="mb-1">Signals <strong>${article.future_signal.toLowerCase()}</strong> future developments in the sector</li>`;
    }
    
    analysis += '</ul>';
    
    // Source credibility assessment
    analysis += '<h6 class="text-primary mb-2">Source Credibility</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.factual_reporting) {
        const factualityAssessment = article.factual_reporting.toLowerCase().includes('high') ? 'highly reliable' : 
                                   article.factual_reporting.toLowerCase().includes('mostly') ? 'generally reliable' :
                                   article.factual_reporting.toLowerCase().includes('mixed') ? 'moderately reliable' : 'reliability unclear';
        analysis += `<li class="mb-1">Factual reporting rated as <strong>${article.factual_reporting}</strong> - ${factualityAssessment}</li>`;
    }
    
    if (article.bias) {
        const biasImpact = article.bias.toLowerCase().includes('center') ? 'minimal bias impact on factual content' :
                          article.bias.toLowerCase().includes('left') ? 'may emphasize regulatory/social aspects' :
                          article.bias.toLowerCase().includes('right') ? 'may emphasize market/business aspects' : 'bias impact unclear';
        analysis += `<li class="mb-1">Political bias: <strong>${article.bias}</strong> - ${biasImpact}</li>`;
    }
    
    if (article.mbfc_credibility_rating) {
        analysis += `<li class="mb-1">Overall credibility: <strong>${article.mbfc_credibility_rating}</strong> rating</li>`;
    }
    
    analysis += '</ul>';
    
    // Strategic implications
    analysis += '<h6 class="text-primary mb-2">Strategic Implications</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.sentiment) {
        const sentimentImplication = article.sentiment.toLowerCase() === 'positive' ? 'suggests optimistic market outlook' :
                                   article.sentiment.toLowerCase() === 'negative' ? 'indicates potential challenges or concerns' :
                                   article.sentiment.toLowerCase() === 'critical' ? 'highlights significant issues requiring attention' :
                                   'presents balanced perspective';
        analysis += `<li class="mb-1">Sentiment is <strong>${article.sentiment.toLowerCase()}</strong> - ${sentimentImplication}</li>`;
    }
    
    // Add organizational context if available
    const profileSelect = document.getElementById('profile-select');
    if (profileSelect && profileSelect.value) {
        const selectedProfile = profileSelect.options[profileSelect.selectedIndex].text;
        analysis += `<li class="mb-1">For <strong>${selectedProfile}</strong>: Consider alignment with organizational risk tolerance and strategic priorities</li>`;
    }
    
    analysis += '</ul>';
    
    // Risk considerations
    analysis += '<h6 class="text-primary mb-2">Risk Considerations</h6>';
    analysis += '<ul class="mb-0">';
    
    if (article.bias && !article.bias.toLowerCase().includes('center')) {
        analysis += `<li class="mb-1">Source bias (${article.bias}) may influence framing - consider alternative perspectives</li>`;
    }
    
    if (article.time_to_impact && article.time_to_impact.toLowerCase().includes('long')) {
        analysis += `<li class="mb-1">Long-term impact timeline suggests gradual rather than immediate strategic implications</li>`;
    }
    
    if (!article.factual_reporting || article.factual_reporting.toLowerCase().includes('mixed')) {
        analysis += `<li class="mb-1">Factual reporting quality suggests verifying key claims with additional sources</li>`;
    }
    
    analysis += '<li class="mb-1">Consider this analysis alongside broader market trends and organizational context</li>';
    analysis += '</ul>';
    
    return analysis;
}

function generateSimpleAnalysisHTML(article) {
    // This version is for template rendering - returns HTML directly
    let analysis = '';
    
    // Sentiment analysis
    if (article.sentiment) {
        analysis += `<p class="mb-2 small"><strong>Sentiment:</strong> ${article.sentiment}`;
        if (article.sentiment_explanation) {
            analysis += ` - ${escapeHTML(article.sentiment_explanation)}`;
        }
        analysis += '</p>';
    }
    
    // Source quality
    if (article.bias && article.factual_reporting) {
        analysis += `<p class="mb-2 small"><strong>Source Quality:</strong> ${article.bias} bias, ${article.factual_reporting} factual reporting`;
        if (article.mbfc_credibility_rating) {
            analysis += `, ${article.mbfc_credibility_rating} credibility`;
        }
        analysis += '</p>';
    }
    
    // Impact timing
    if (article.time_to_impact) {
        analysis += `<p class="mb-2 small"><strong>Impact Timing:</strong> ${article.time_to_impact}`;
        if (article.driver_type) {
            analysis += ` (${article.driver_type})`;
        }
        analysis += '</p>';
    }
    
    // Future signals
    if (article.future_signal) {
        analysis += `<p class="mb-2 small"><strong>Future Signal:</strong> ${article.future_signal}</p>`;
    }
    
    return analysis || '<p class="mb-2 small text-muted">Limited metadata available.</p>';
}

function generateSimpleAnalysis(article) {
    let analysis = '';
    
    // Sentiment analysis
    if (article.sentiment) {
        analysis += `<p class="mb-2 small"><strong>Sentiment Analysis:</strong> This article has a ${article.sentiment.toLowerCase()} tone`;
        if (article.sentiment_explanation) {
            analysis += ` - ${article.sentiment_explanation}`;
        }
        analysis += '.</p>';
    }
    
    // Bias and factuality assessment
    if (article.bias && article.factual_reporting) {
        analysis += `<p class="mb-2 small"><strong>Source Quality:</strong> Published by a ${article.bias.toLowerCase()} source with ${article.factual_reporting.toLowerCase()} factual reporting standards`;
        if (article.mbfc_credibility_rating) {
            analysis += ` and ${article.mbfc_credibility_rating.toLowerCase()} credibility rating`;
        }
        analysis += '.</p>';
    }
    
    // Impact and timing analysis
    if (article.time_to_impact || article.driver_type) {
        analysis += `<p class="mb-2 small"><strong>Impact Assessment:</strong> `;
        if (article.time_to_impact) {
            analysis += `Expected to have ${article.time_to_impact.toLowerCase()} impact`;
        }
        if (article.driver_type) {
            analysis += `${article.time_to_impact ? ' and acts as a ' : 'Acts as a '}${article.driver_type.toLowerCase()} for related developments`;
        }
        analysis += '.</p>';
    }
    
    // Future signals
    if (article.future_signal) {
        analysis += `<p class="mb-2 small"><strong>Future Implications:</strong> This article signals ${article.future_signal.toLowerCase()} future developments in the ${article.category || 'relevant'} sector.</p>`;
    }
    
    // Category context
    if (article.category) {
        analysis += `<p class="mb-2 small"><strong>Thematic Context:</strong> Categorized under ${article.category}, indicating relevance to ongoing developments in this area.</p>`;
    }
    
    if (!analysis) {
        analysis = '<p class="mb-2 small text-muted">Limited metadata available for analysis.</p>';
    }
    
    return analysis;
}

// Generate research themes for sidebar
async function generateResearchThemes(articleUri) {
    const themesId = `themes-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const themesDiv = document.getElementById(themesId);
    
    if (!themesDiv || themesDiv.dataset.loaded) return;
    
    // Check for cached themes first
    const selectedModel = document.getElementById('model-select')?.value;
    try {
        const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(articleUri)}&analysis_type=themes&model=${encodeURIComponent(selectedModel)}`);
        if (cacheResponse.ok) {
            const cacheData = await cacheResponse.json();
            if (cacheData.cached && cacheData.metadata && cacheData.metadata.research_themes) {
                // Use cached structured themes
                const themes = cacheData.metadata.research_themes;
                let html = '<div class="d-flex flex-wrap gap-1">';
                themes.forEach((theme, index) => {
                    html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                            style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                            onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                            title="Launch Auspex research on: ${escapeHTML(theme)}">
                        <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                    </button>`;
                });
                html += '</div>';
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                html += `<small class="text-muted d-block mt-1" style="font-size: 8px;">Cached: ${cacheDate}</small>`;
                themesDiv.innerHTML = html;
                themesDiv.dataset.loaded = 'true';
                return;
            }
        }
    } catch (e) {
        console.warn('Failed to check themes cache, proceeding with generation:', e);
    }
    
    try {
        themesDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <small>Generating themes...</small>
            </div>
        `;
        
        const selectedModel = document.getElementById('model-select').value;
        
        const response = await fetch('/api/article-insights', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel || 'gpt-4o-mini',
                structured: true
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Research themes API response:', data);
        console.log('Response keys:', Object.keys(data));
        console.log('Has research_themes:', !!data.research_themes);
        console.log('Has response:', !!data.response);
        console.log('Structured flag sent:', true);
        
        console.log('Research themes array:', data.research_themes);
        console.log('Research themes length:', data.research_themes?.length);
        
        if (data.research_themes && data.research_themes.length > 0) {
            // Compact sidebar format - just theme buttons
            let html = '<div class="d-flex flex-wrap gap-1">';
            data.research_themes.forEach((theme, index) => {
                html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                        style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                        onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                        title="Launch Auspex research on: ${escapeHTML(theme)}">
                    <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                </button>`;
            });
            html += '</div>';
            html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
            themesDiv.innerHTML = html;
        } else if (data.response) {
            // Fallback to markdown - extract just themes
            const themesMatch = data.response.match(/## Research themes\n(.*?)(?=\n##|\n$)/s);
            if (themesMatch) {
                const themeLines = themesMatch[1].split('\n').filter(line => line.trim().startsWith('-'));
                let html = '<div class="d-flex flex-wrap gap-1">';
                themeLines.forEach(line => {
                    const theme = line.replace(/^-\s*/, '').trim();
                    if (theme) {
                        html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                                style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                                onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                                title="Launch Auspex research on: ${escapeHTML(theme)}">
                            <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                        </button>`;
                    }
                });
                html += '</div>';
                html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
                themesDiv.innerHTML = html;
            } else {
                themesDiv.innerHTML = '<small class="text-muted">No themes available</small>';
            }
        } else if (data.response) {
            // Try to extract themes from markdown response as fallback
            console.log('Attempting to parse themes from markdown response:', data.response);
            const themesMatch = data.response.match(/## Research themes\n(.*?)(?=\n##|\n$)/s);
            if (themesMatch) {
                const themeLines = themesMatch[1].split('\n').filter(line => line.trim().startsWith('-'));
                if (themeLines.length > 0) {
                    let html = '<div class="d-flex flex-wrap gap-1">';
                    themeLines.forEach(line => {
                        const theme = line.replace(/^-\s*/, '').trim();
                        if (theme) {
                            html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                                    style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                                    onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                                    title="Launch Auspex research on: ${escapeHTML(theme)}">
                                <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                            </button>`;
                        }
                    });
                    html += '</div>';
                    html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
                    themesDiv.innerHTML = html;
                } else {
                    themesDiv.innerHTML = '<small class="text-warning">No themes found in response</small>';
                }
            } else {
                themesDiv.innerHTML = '<small class="text-warning">Could not parse themes</small>';
            }
        } else {
            console.warn('No research themes or response in API data:', data);
            console.log('Full response object:', JSON.stringify(data, null, 2));
            
            // Show what we actually got for debugging
            if (data && typeof data === 'object') {
                const keys = Object.keys(data);
                themesDiv.innerHTML = `<small class="text-warning">Debug: Got keys: ${keys.join(', ')}</small>`;
            } else {
                themesDiv.innerHTML = '<small class="text-muted">API returned no data</small>';
            }
        }
        
        themesDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error generating research themes:', error);
        
        // Show clear error about server configuration
        themesDiv.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <small>Vector routes not mounted (404)</small>
            </div>
        `;
    }
}

// Generate deep dive analysis
async function generateDeepDive(articleUri) {
    try {
        const selectedModel = document.getElementById('model-select').value;
        if (!selectedModel) {
            showNotification('Select a valid AI model to generate deep-dive analysis', 'warning');
            return;
        }
        
        showNotification('Generating deep-dive analysis...', 'info');
        
        const response = await fetch('/api/article-deep-dive', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.response) {
            throw new Error('No deep-dive content received');
        }
        
        // Create a modal to show the deep dive
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-microscope me-2"></i>Deep-Dive Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="deep-dive-content">
                            ${formatMarkdownAnalysis(data.response)}
                        </div>
                        <div class="text-end mt-3">
                            <small class="text-muted">
                                Generated: ${data.generated_at ? new Date(data.generated_at).toLocaleString() : 'Just now'} | Model: ${selectedModel}
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
        
        showNotification('Deep-dive analysis generated successfully!', 'success');
        
    } catch (error) {
        console.error('Error generating deep dive:', error);
        showNotification(`Failed to generate deep-dive: ${error.message}`, 'error');
    }
}

// Check for cached analysis and show indicators
async function checkCachedAnalysisIndicators(articles) {
    const selectedModel = document.getElementById('model-select')?.value;
    if (!selectedModel || !articles || articles.length === 0) return;
    
    // Check cache for each article (database + localStorage fallback)
    for (const article of articles) {
        let hasCachedAnalysis = false;
        
        // Try database cache first
        try {
            const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(article.uri)}&analysis_type=summary&model=${encodeURIComponent(selectedModel)}`);
            if (cacheResponse.ok) {
                const cacheData = await cacheResponse.json();
                if (cacheData.cached) {
                    hasCachedAnalysis = true;
                }
            }
        } catch (e) {
            // Database failed, check localStorage
            try {
                const localCacheKey = `analysis_cache_${article.uri}_summary_${selectedModel}`;
                const localCache = localStorage.getItem(localCacheKey);
                if (localCache) {
                    const cacheData = JSON.parse(localCache);
                    const cacheAge = new Date() - new Date(cacheData.generated_at);
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
                    
                    if (cacheAge < maxAge) {
                        hasCachedAnalysis = true;
                    }
                }
            } catch (localError) {
                console.debug(`Local cache check failed for ${article.uri}:`, localError);
            }
        }
        
        // Show indicator if cached analysis found
        if (hasCachedAnalysis) {
            const indicator = document.getElementById(`cached-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (indicator) {
                indicator.style.display = 'inline';
            }
        }
    }
}

// Pagination and filtering variables
let allArticlesData = [];
let filteredArticlesData = [];
let currentPage = 1;
const articlesPerPage = 25;
let currentSort = 'date_asc';
let currentSearchTerm = '';

// Handle sort change
function handleSortChange() {
    currentSort = document.getElementById('sort-select').value;
    currentPage = 1; // Reset to first page
    applyFiltersAndDisplay();
}

// Handle search input with debouncing
let searchTimeout;
function handleSearchInput() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        currentSearchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        currentPage = 1; // Reset to first page
        applyFiltersAndDisplay();
    }, 300);
}

// Apply filters and display current page
function applyFiltersAndDisplay() {
    if (!allArticlesData || !Array.isArray(allArticlesData) || allArticlesData.length === 0) {
        console.warn('No valid articles data available for filtering');
        return;
    }
    
    // Filter articles based on search term
    filteredArticlesData = allArticlesData.filter(article => {
        if (!currentSearchTerm) return true;
        
        const searchableText = [
            article.title || '',
            article.summary || '',
            article.tags || '',
            article.category || ''
        ].join(' ').toLowerCase();
        
        return searchableText.includes(currentSearchTerm);
    });
    
    // Sort articles
    filteredArticlesData.sort((a, b) => {
        switch (currentSort) {
            case 'date_desc':
                return new Date(b.publication_date || 0) - new Date(a.publication_date || 0);
            case 'date_asc':
                return new Date(a.publication_date || 0) - new Date(b.publication_date || 0);
            case 'category_date_asc':
                // Sort by category first, then by date asc within category
                if (a.category !== b.category) {
                    return (a.category || '').localeCompare(b.category || '');
                }
                return new Date(a.publication_date || 0) - new Date(b.publication_date || 0);
            case 'category_date_desc':
                // Sort by category first, then by date desc within category
                if (a.category !== b.category) {
                    return (a.category || '').localeCompare(b.category || '');
                }
                return new Date(b.publication_date || 0) - new Date(a.publication_date || 0);
            case 'bias_date_asc':
                // Sort by political bias first, then by date asc within bias
                if (a.bias !== b.bias) {
                    return (a.bias || '').localeCompare(b.bias || '');
                }
                return new Date(a.publication_date || 0) - new Date(b.publication_date || 0);
            case 'bias_date_desc':
                // Sort by political bias first, then by date desc within bias
                if (a.bias !== b.bias) {
                    return (a.bias || '').localeCompare(b.bias || '');
                }
                return new Date(b.publication_date || 0) - new Date(a.publication_date || 0);
            default:
                return 0;
        }
    });
    
    // Update pagination info
    updatePaginationInfo();
    
    // Display current page
    displayCurrentPage();
}

// Update pagination information
function updatePaginationInfo() {
    const totalArticles = filteredArticlesData.length;
    const totalPages = Math.ceil(totalArticles / articlesPerPage);
    const start = (currentPage - 1) * articlesPerPage + 1;
    const end = Math.min(currentPage * articlesPerPage, totalArticles);
    
    document.getElementById('articles-start').textContent = totalArticles > 0 ? start : 0;
    document.getElementById('articles-end').textContent = end;
    document.getElementById('articles-total').textContent = totalArticles;
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages;
    
    // Update button states
    document.getElementById('prev-page-btn').disabled = currentPage <= 1;
    document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
    
    // Show/hide pagination container
    const paginationContainer = document.getElementById('pagination-container');
    if (paginationContainer) {
        paginationContainer.style.display = totalArticles > articlesPerPage ? 'flex' : 'none';
    }
}

// Display current page of articles
function displayCurrentPage() {
    const start = (currentPage - 1) * articlesPerPage;
    const end = start + articlesPerPage;
    const pageArticles = filteredArticlesData.slice(start, end);
    
    renderArticles({ items: pageArticles });
    
    // Check for cached analysis indicators
    checkCachedAnalysisIndicators(pageArticles);
}

// Pagination navigation
function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        displayCurrentPage();
        updatePaginationInfo();
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredArticlesData.length / articlesPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayCurrentPage();
        updatePaginationInfo();
    }
}

// Auto-load database articles on page load (no LLM generation)
async function autoLoadArticles() {
    try {
        console.log('Auto-loading database articles...');
        
        // Get current settings
        const dateRange = document.getElementById('date-range-select')?.value || '3m';
        const topic = document.getElementById('topic-select')?.value || '';
        
        // Convert date range to days for database query
        let days = 90; // Default
        if (dateRange.endsWith('d')) {
            days = parseInt(dateRange.replace('d', ''));
        } else if (dateRange.endsWith('h')) {
            days = Math.max(1, parseInt(dateRange.replace('h', '')) / 24);
        } else if (dateRange === '3m') {
            days = 90; // 3 months = 90 days
        } else if (dateRange === '1y') {
            days = 365; // 1 year = 365 days
        } else if (dateRange === 'all') {
            days = 9999; // Large number for "all time"
        }
        
        console.log(`Date range: ${dateRange} -> ${days} days back`);
        
        // Calculate actual start date for the API
        const now = new Date();
        const startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
        const dateParam = startDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        console.log(`Calculated date range: ${dateParam} to ${now.toISOString().split('T')[0]} (${days} days)`);
        
        // Build database query parameters to match news_feed_routes.py endpoint
        const params = new URLSearchParams({
            date_range: dateRange, // Use the original date_range parameter
            per_page: '100', // Match endpoint max limit
            page: '1',
            max_articles: '100'
        });
        
        if (topic) params.append('topic', topic);
        
        console.log(`API call: /api/news-feed/articles?${params.toString()}`);
        console.log(`Date range: ${dateRange} -> should get ${days} days of articles`);
        
        // Load articles directly from database (not LLM-generated)
        const response = await fetch(`/api/news-feed/articles?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Database articles loaded:', data);
        
        // Handle response structure
        let articles = [];
        if (Array.isArray(data)) {
            articles = data;
        } else if (data.articles) {
            // Check if data.articles is an array or has nested structure
            if (Array.isArray(data.articles)) {
                articles = data.articles;
            } else if (data.articles.items && Array.isArray(data.articles.items)) {
                articles = data.articles.items;
            } else if (data.articles.articles && Array.isArray(data.articles.articles)) {
                articles = data.articles.articles;
            } else {
                console.warn('data.articles is not an array:', data.articles);
                console.log('data.articles keys:', Object.keys(data.articles));
                articles = [];
            }
        } else if (data.items && Array.isArray(data.items)) {
            articles = data.items;
        } else if (data.results && Array.isArray(data.results)) {
            articles = data.results;
        } else {
            console.warn('Unexpected database response structure:', data);
            console.log('Available keys:', Object.keys(data));
            articles = [];
        }
        
        // Store all articles and initialize filtering
        allArticlesData = articles;
        currentPage = 1;
        
        // Also store in window.lastArticlesData for analysis functions
        window.lastArticlesData = { items: articles };
        
        console.log(`Loaded ${allArticlesData.length} database articles`);
        
        // Apply initial filters and display
        if (allArticlesData.length > 0) {
            applyFiltersAndDisplay();
        } else {
            // Show empty state
            const listContainer = document.getElementById('articles-list');
            if (listContainer) {
                listContainer.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Articles Found</h5>
                        <p class="text-muted">No articles found for the selected criteria.</p>
                        <small class="text-muted">Date range: ${dateRange}${topic ? `, Topic: ${topic}` : ''}</small>
                    </div>
                `;
            }
        }
        
        console.log(`Database articles auto-loaded: ${allArticlesData.length} total`);
        
    } catch (error) {
        console.error('Error auto-loading database articles:', error);
        
        // Show error in articles list
        const listContainer = document.getElementById('articles-list');
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Failed to Load Articles</h6>
                    <p class="mb-0">Error: ${error.message}</p>
                </div>
            `;
        }
    }
}

// Toggle controls panel visibility
function toggleControlsPanel() {
    const controlsContent = document.getElementById('controlsContent');
    const toggleIcon = document.getElementById('controlsToggleIcon');
    const isCollapsed = controlsContent.style.display === 'none';
    
    if (isCollapsed) {
        // Show controls
        controlsContent.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-up';
        localStorage.setItem('newsFeedControlsCollapsed', 'false');
    } else {
        // Hide controls
        controlsContent.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-down';
        localStorage.setItem('newsFeedControlsCollapsed', 'true');
    }
}

// Restore controls panel state
function restoreControlsState() {
    const isCollapsed = localStorage.getItem('newsFeedControlsCollapsed') === 'true';
    if (isCollapsed) {
        const controlsContent = document.getElementById('controlsContent');
        const toggleIcon = document.getElementById('controlsToggleIcon');
        
        if (controlsContent && toggleIcon) {
            controlsContent.style.display = 'none';
            toggleIcon.className = 'fas fa-chevron-down';
        }
    }
}

// Save all current settings as defaults
function saveCurrentAsDefaults() {
    try {
        const settings = {
            dateRange: document.getElementById('date-range-select')?.value,
            topic: document.getElementById('topic-select')?.value,
            model: document.getElementById('model-select')?.value,
            profile: document.getElementById('profile-select')?.value,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('newsFeedDefaults', JSON.stringify(settings));
        showNotification('Current settings saved as defaults!', 'success');
        console.log('Saved defaults:', settings);
    } catch (error) {
        console.error('Error saving defaults:', error);
        showNotification('Failed to save defaults', 'error');
    }
}

// Load saved defaults
function loadSavedDefaults() {
    try {
        const savedDefaults = localStorage.getItem('newsFeedDefaults');
        if (savedDefaults) {
            const settings = JSON.parse(savedDefaults);
            
            // Apply saved settings
            if (settings.dateRange) {
                const dateRangeEl = document.getElementById('date-range-select');
                if (dateRangeEl) dateRangeEl.value = settings.dateRange;
            }
            
            if (settings.topic) {
                const topicEl = document.getElementById('topic-select');
                if (topicEl) topicEl.value = settings.topic;
            }
            
            if (settings.model) {
                const modelEl = document.getElementById('model-select');
                if (modelEl) modelEl.value = settings.model;
            }
            
            console.log('Loaded saved defaults:', settings);
            return true;
        }
    } catch (error) {
        console.error('Error loading defaults:', error);
    }
    return false;
}

// Get the currently selected topic from the news feed
function getCurrentTopic() {
    const topicSelect = document.getElementById('topic-select');
    return topicSelect?.value || null;
}

// Launch Auspex research for a specific theme
async function launchAuspexResearch(theme, sourceArticleUri) {
    try {
        showNotification(`Launching Auspex research on: ${theme}`, 'info');
        
        // Get the article data to extract the actual topic and context
        const article = window.lastArticlesData?.items?.find(a => a.uri === sourceArticleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        // Use the article's topic, not the theme as topic
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning'; // Fallback to default topic
        
        console.log(`Research setup: Theme="${theme}", Topic="${actualTopic}", Article="${article.title}"`);
        
        // Create Auspex chat session with the actual topic
        // Create Auspex chat session with organizational profile
        const chatId = await createAuspexChatSession(actualTopic, `Deep Research: ${theme}`);
        
        // Get the selected model from the news feed UI
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Build comprehensive research prompt with article context
        const researchPrompt = `Conduct a comprehensive analysis of "${theme}" using your tools to search recent articles, analyze trends, and provide strategic insights.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Summary: ${article.summary}
Why Interesting: ${article.why_interesting || 'Key insights for analysis'}

RESEARCH FOCUS: "${theme}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for recent articles related to "${theme}" in the topic "${actualTopic}"
2. Analyze current developments and key players in this space
3. Identify market trends and their implications
4. Assess future outlook and potential impacts
5. Provide strategic recommendations for decision-makers

The context article above sparked this research into "${theme}" - use it as a starting point but expand the analysis using your tools to find additional relevant articles and insights.

Provide a thorough analysis using the structured format from your system prompt.`;
        
        // Send initial research message
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: researchPrompt,
                model: selectedModel,
                profile_id: getCurrentProfileId(),
                limit: 50,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });
        
        if (!messageResponse.ok) {
            throw new Error(`Failed to send research message: ${messageResponse.status}`);
        }
        
        // Open Auspex chat modal and connect to the existing session
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));
        
        // Store the chat ID for the modal to use
        window.auspexActiveChatId = chatId;
        window.auspexActiveTheme = theme;
        
        // Set the topic and model in the modal properly
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');
        
        if (topicSelect) {
            topicSelect.value = actualTopic;
            topicSelect.dispatchEvent(new Event('change'));
        }
        
        if (modelSelect) {
            modelSelect.value = selectedModel;
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        // Enable the chat input and send button
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');
            
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Continue research on ${theme}...`;
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Clear existing messages and add our research status
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>Research Session Active</strong><br>
                        I'm conducting comprehensive research on "<strong>${theme}</strong>". 
                        The analysis has been started and results will appear here shortly...
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Analyzing articles and generating insights...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Open the modal
        auspexModal.show();
        
        // Start polling for the research results
        pollForAuspexResults(chatId, theme);
        
        showNotification(`Auspex research launched! Analyzing: ${theme}`, 'success');
        
        // Log for debugging
        console.log(`Launched Auspex research - Theme: ${theme}, Chat ID: ${chatId}, Source: ${sourceArticleUri}`);
        
    } catch (error) {
        console.error('Error launching Auspex research:', error);
        showNotification(`Failed to launch Auspex research: ${error.message}`, 'error');
    }
}

// Poll for Auspex research results
async function pollForAuspexResults(chatId, theme) {
    let pollCount = 0;
    const maxPolls = 120; // Poll for up to 4 minutes (LLM might take longer)
    const pollInterval = 2000; // Poll every 2 seconds
    
    console.log(`Starting polling for research results - Chat ID: ${chatId}, Theme: ${theme}`);
    
    const poll = async () => {
        try {
            // Get chat history to see if there are new messages
            const response = await fetch(`/api/auspex/chat/sessions/${chatId}/messages`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to get chat history: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            console.log(`Poll ${pollCount}: Response data:`, data);
            
            // Handle different response structures - the API returns {chat_id, messages, topic}
            const messages = data.messages || [];
            console.log(`Poll ${pollCount}: Got ${messages.length} messages for chat ${chatId}`);
            
            // Log message details for debugging
            if (messages.length > 0) {
                messages.forEach((msg, idx) => {
                    console.log(`Poll ${pollCount}: Message ${idx}: role=${msg.role}, content_length=${msg.content?.length || 0}, is_complete=${msg.is_complete}`);
                });
            } else {
                console.log(`Poll ${pollCount}: No messages yet, LLM might still be processing...`);
            }
            
            // Look for assistant messages (responses) - exclude system messages
            const assistantMessages = messages.filter(msg => msg.role === 'assistant' && msg.content && msg.content.trim().length > 0);
            console.log(`Poll ${pollCount}: Found ${assistantMessages.length} assistant messages`);
            
            // We need at least 2 messages: the initial system message and our research response
            if (assistantMessages.length > 0) {
                // Get the latest assistant message
                const latestResponse = assistantMessages[assistantMessages.length - 1];
                
                // Make sure it's not just an error message or empty response
                if (latestResponse.content && latestResponse.content.length > 50) {
                    displayAuspexResult(latestResponse.content, theme);
                    return; // Stop polling
                }
            }
            
            pollCount++;
            if (pollCount < maxPolls) {
                setTimeout(poll, pollInterval);
            } else {
                // Timeout - show error message
                displayAuspexTimeout(theme);
            }
            
        } catch (error) {
            console.error('Error polling for Auspex results:', error);
            displayAuspexError(error.message, theme);
        }
    };
    
    // Start polling after a brief delay
    setTimeout(poll, pollInterval);
}

// Display Auspex research result
function displayAuspexResult(content, theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        // Use marked.js for proper markdown rendering
        const formattedContent = formatAuspexMarkdown(content);
        
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Complete: ${theme}</strong><br>
                    <div class="mt-2 auspex-research-content">
                        ${formattedContent}
                    </div>
                    <div id="auspex-followups" class="mt-3"></div>
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    showNotification(`Research complete for: ${theme}`, 'success');
    try { renderFollowUpActionsFromContent(content); } catch(_) {}
}
// Parse model output to extract Next Steps and Suggested Queries, render actionable badges
function renderFollowUpActionsFromContent(markdownText) {
    const container = document.getElementById('auspex-followups');
    if (!container || !markdownText) return;
    const text = String(markdownText);
    const nextSteps = [];
    const queries = [];
    const lines = text.split(/\r?\n/);
    let inNext = false, inQueries = false;
    for (const raw of lines) {
        const line = raw.trim();
        const lower = line.toLowerCase();
        // Section headers with or without markdown '#' and with variants
        if (/^#+\s*next steps/i.test(line) || lower.startsWith('next steps') || lower.startsWith('next steps:')) { inNext = true; inQueries = false; continue; }
        if (/^#+\s*suggested.*(query|search|filter)/i.test(line) || (lower.includes('suggested') && (lower.includes('query') || lower.includes('search') || lower.includes('filter')))) { inNext = false; inQueries = true; continue; }
        if (/^#+\s/.test(line)) { inNext = false; inQueries = false; }
        let bullet = line.replace(/^[-*•]\s+/, '').trim();
        if (!bullet) continue;
        // Strip ordered list prefix like "1. "
        bullet = bullet.replace(/^\d+\.|^\d+\)\s*/, '').trim();
        if (inNext && bullet.length > 3) {
            nextSteps.push(bullet.replace(/[\u201C\u201D]/g,'"'));
            continue;
        }
        if (inQueries) {
            // Accept non-bulleted lines too
            let candidate = bullet;
            // Prefer quoted phrase
            const m = candidate.match(/[\"\u201C]([^\"\u201D]+)[\"\u201D]/);
            if (m && m[1]) {
                queries.push(m[1].trim());
                continue;
            }
            // Otherwise, cut before dash or filter explanation
            const splitIdx = candidate.search(/[—–\-]\s|\swith\s|\sfocusing\s|\sfiltered\s|\scombining\s/i);
            if (splitIdx > 0) candidate = candidate.slice(0, splitIdx).trim();
            candidate = candidate.replace(/^"|"$/g,'');
            if (candidate.length > 3) queries.push(candidate);
        }
    }
    const makeBtn = (label, type) => {
        const cls = type === 'query' ? 'btn btn-sm btn-outline-info me-1 mb-1' : 'btn btn-sm btn-outline-primary me-1 mb-1';
        const enc = encodeURIComponent(label);
        return `<button class="${cls}" data-type="${type}" data-text="${enc}" onclick="handleFollowUpClick(this)" title="${escapeHTML(label)}"><i class=\"fas fa-bolt me-1\"></i>${escapeHTML(label)}</button>`;
    };
    let html = '';
    if (nextSteps.length) {
        html += '<div class="mb-2"><small class="text-muted fw-bold">Next Steps:</small><div class="mt-1">';
        html += nextSteps.slice(0, 12).map(step => makeBtn(step, 'action')).join('');
        html += '</div></div>';
    }
    if (queries.length) {
        html += '<div class="mb-2"><small class="text-muted fw-bold">Suggested Dataset Searches:</small><div class="mt-1">';
        html += queries.slice(0, 20).map(q => makeBtn(q, 'query')).join('');
        html += '</div></div>';
    }
    if (!html) return;
    container.innerHTML = html;
}

// Unified click handler to avoid brittle inline JS quoting
function handleFollowUpClick(buttonEl) {
    try {
        const type = buttonEl.getAttribute('data-type');
        const text = decodeURIComponent(buttonEl.getAttribute('data-text') || '');
        if (!text) return;
        if (type === 'query') return runDatasetQuery(text);
        return runFollowUpAction(text);
    } catch (e) {
        console.error('Failed to handle follow-up click', e);
        showNotification('Could not run follow-up action', 'error');
    }
}

// Execute a follow-up action by launching a targeted Auspex prompt in the same chat
async function runFollowUpAction(actionText) {
    try {
        const chatId = window.currentAuspexChatId; // set during polling/launch
        if (!chatId) { showNotification('Chat session not found', 'warning'); return; }
        const selectedModel = document.getElementById('floatingModelSelect')?.value || 'gpt-4o-mini';
        const prompt = `Follow-up action requested: ${actionText}\n\nPlease execute this action using dataset-first analysis. Cite URIs.`;
        await fetch('/api/auspex/chat/message', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: chatId, message: prompt, model: selectedModel, limit: 50, profile_id: getCurrentProfileId() }) });
        pollForAuspexResults(chatId, 'Follow-up');
        showNotification('Running follow-up action...', 'info');
    } catch (e) {
        console.error('Follow-up action failed', e);
        showNotification('Failed to run follow-up action', 'error');
    }
}

// Run a dataset query by reusing our dataset-first prompt pattern
async function runDatasetQuery(queryText) {
    try {
        const chatId = window.currentAuspexChatId; // set during polling/launch
        if (!chatId) { showNotification('Chat session not found', 'warning'); return; }
        const topic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        const currentArticles = window.lastArticlesData?.items || [];
        const { detailedLines } = buildDatasetContext(queryText, currentArticles, 12, 20);
        const prompt = `Dataset-first follow-up search: "${queryText}" in topic ${topic}.\n\nRelevant dataset items:\n${detailedLines || '(no strong matches; propose dataset search expansions)'}\n\nPlease analyze these items, cite URIs, and propose next dataset filters.`;
        await fetch('/api/auspex/chat/message', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: chatId, message: prompt, model: selectedModel, limit: 50, profile_id: getCurrentProfileId() }) });
        pollForAuspexResults(chatId, 'Dataset Search');
        showNotification('Running dataset search...', 'info');
    } catch (e) {
        console.error('Dataset query failed', e);
        showNotification('Failed to run dataset search', 'error');
    }
}

// Display timeout message
function displayAuspexTimeout(theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Timeout</strong><br>
                    The research for "${theme}" is taking longer than expected. You can continue chatting in this session - the results may still appear.
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// Display error message
function displayAuspexError(errorMessage, theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Error</strong><br>
                    There was an error with the research for "${theme}": ${errorMessage}
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// Load related articles for sidebar (headlines only)
async function loadRelatedArticlesSidebar(articleUri) {
    const sidebarId = `related-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const sidebarDiv = document.getElementById(sidebarId);
    
    if (!sidebarDiv || sidebarDiv.dataset.loaded) return;
    
    try {
        const response = await fetch(`/api/vector-similar?uri=${encodeURIComponent(articleUri)}&top_k=8`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const results = data.results || [];
        
        if (results.length > 0) {
            let html = '<div class="related-articles-compact">';
            results.forEach((related, index) => {
                if (index < 8) { // Show up to 8 in sidebar
                    html += `<div class="mb-1 d-flex align-items-center gap-1">
                        <a href="${related.id}" target="_blank" 
                           class="text-decoration-none small flex-grow-1"
                           style="font-size: 10px; line-height: 1.2; color: #0066cc;"
                           title="${escapeHTML(related.metadata?.title || 'Related article')}">
                            <i class="fas fa-external-link-alt me-1 text-muted"></i>
                            ${escapeHTML((related.metadata?.title || 'Related article').substring(0, 50))}${(related.metadata?.title || '').length > 50 ? '...' : ''}
                        </a>
                        <button class="btn btn-outline-primary btn-sm" 
                                style="font-size: 8px; padding: 0px 2px; line-height: 1;"
                                onclick="loadRelatedArticleAnalysis('${related.id}')"
                                title="Analyze this related article">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>`;
                }
            });
            html += '</div>';
            sidebarDiv.innerHTML = html;
        } else {
            sidebarDiv.innerHTML = '<small class="text-muted">No related articles</small>';
        }
        
        sidebarDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error loading related articles for sidebar:', error);
        sidebarDiv.innerHTML = '<small class="text-warning">Failed to load</small>';
    }
}

// Open annotation modal
function openAnnotationModal(articleUri) {
    // Create annotation modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'annotationModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sticky-note me-2"></i>Add Annotation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Article URL</label>
                        <input type="url" class="form-control" value="${articleUri}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Annotation</label>
                        <textarea class="form-control" id="annotationContent" rows="4" 
                                  placeholder="Add your analysis or comments..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="annotationPrivate">
                        <label class="form-check-label" for="annotationPrivate">
                            Private note (not included in analysis)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAnnotationFromModal('${articleUri}')">
                        <i class="fas fa-save me-1"></i>Save Annotation
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal after it's hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Save annotation from modal
async function saveAnnotationFromModal(articleUri) {
    const content = document.getElementById('annotationContent').value.trim();
    const isPrivate = document.getElementById('annotationPrivate').checked;
    
    if (!content) {
        showNotification('Please enter annotation content', 'warning');
        return;
    }
    
    try {
        const doubleEncodedUri = encodeURIComponent(encodeURIComponent(articleUri));
        
        const response = await fetch(`/api/articles/${doubleEncodedUri}/annotations`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content,
                is_private: isPrivate
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || 'Failed to save annotation');
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('annotationModal'));
        modal.hide();
        
        showNotification('Annotation saved successfully!', 'success');
        
    } catch (error) {
        console.error('Error saving annotation:', error);
        showNotification(`Failed to save annotation: ${error.message}`, 'error');
    }
}

// Load related article analysis in-app
async function loadRelatedArticleAnalysis(articleUri) {
    try {
        showNotification('Loading related article analysis...', 'info');
        
        // Find if this article is already in our current dataset
        const existingArticle = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        
        if (existingArticle) {
            // Article already loaded - just scroll to it and expand
            const articleElement = document.querySelector(`[onclick*="${articleUri}"]`);
            if (articleElement) {
                articleElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Trigger expansion
                const expandButton = articleElement.closest('.list-group-item').querySelector('.expand-arrow-btn');
                if (expandButton && expandButton.querySelector('i').className.includes('chevron-right')) {
                    expandButton.click();
                }
                showNotification('Scrolled to related article', 'success');
                return;
            }
        }
        
        // Article not in current view - load it in a modal
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Get article analysis
        const response = await fetch('/api/vector-summary-raw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to load article: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Create modal to show the related article
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-newspaper me-2"></i>Related Article Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="related-article-content">
                            ${formatMarkdownAnalysis(data.response || 'Analysis not available')}
                        </div>
                        <div class="text-end mt-3">
                            <small class="text-muted">
                                <a href="${articleUri}" target="_blank" class="text-decoration-none">
                                    <i class="fas fa-external-link-alt me-1"></i>View original article
                                </a>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
        
        showNotification('Related article loaded', 'success');
        
    } catch (error) {
        console.error('Error loading related article:', error);
        showNotification(`Failed to load related article: ${error.message}`, 'error');
    }
}

// Launch Auspex Deep Dive analysis
async function launchAuspexDeepDive(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching Auspex deep-dive analysis...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Deep Dive: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build deep dive prompt using the deepdiveprompt.md template
        const deepDivePrompt = `Conduct a comprehensive deep-dive analysis of the topic covered in this article using the Deep Dive Template framework.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Date: ${article.date}
Summary: ${article.summary}
Why Interesting: ${article.why_interesting || 'Key insights for analysis'}

DEEP DIVE INSTRUCTIONS:
Use your tools to search for articles related to the themes in this article and conduct a comprehensive analysis following the Deep Dive Template structure:

1. Topic Definition & Context Setting
2. Multi-Dimensional Analysis (4-5 relevant dimensions)
3. Strategic Summary Analysis  
4. Consensus vs Industry Narrative Comparison
5. Strategic Breakdown & Evidence
6. Synthesis & Strategic Insights
7. Final Assessment

Focus on providing evidence-based analysis grounded in multiple sources, not just the context article. Use your search tools to find related articles and build a comprehensive picture.

Target length: 900-1200 words with specific data points and strategic insights.`;
        
        await launchAuspexWithPrompt(chatId, deepDivePrompt, selectedModel, actualTopic, 'Deep Dive Analysis');
        
    } catch (error) {
        console.error('Error launching deep dive:', error);
        showNotification(`Failed to launch deep dive: ${error.message}`, 'error');
    }
}

// Launch Consensus vs Fringe Voices analysis
async function launchConsensusAnalysis(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching consensus vs fringe analysis...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Consensus Analysis: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Extract key claims from the article
        const consensusPrompt = `Analyze the consensus vs fringe voices regarding the claims made in this article.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Summary: ${article.summary}

CONSENSUS ANALYSIS INSTRUCTIONS:
1. Identify the key claims or predictions made in this article
2. Use your tools to search for related articles in the topic "${actualTopic}"
3. Analyze whether these claims represent:
   - Mainstream consensus (majority view)
   - Emerging consensus (growing agreement)
   - Fringe perspective (minority/outlier view)
   - Mixed views (no clear consensus)

4. Provide evidence-based analysis showing:
   - What the consensus actually says about these topics
   - How this article's perspective compares to the broader evidence
   - Timeline consensus (when impacts are expected)
   - Confidence levels in different scenarios
   - Notable outlier perspectives (both optimistic and pessimistic)

5. Structure your response with clear sections showing the comparison between this article's claims and the broader consensus patterns.

Use your search and analysis tools to gather comprehensive evidence from multiple sources.`;
        
        await launchAuspexWithPrompt(chatId, consensusPrompt, selectedModel, actualTopic, 'Consensus Analysis');
        
    } catch (error) {
        console.error('Error launching consensus analysis:', error);
        showNotification(`Failed to launch consensus analysis: ${error.message}`, 'error');
    }
}

// Launch Impact Timeline analysis
async function launchTimelineAnalysis(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching impact timeline analysis...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Timeline Analysis: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Extract themes and build timeline prompt
        const timelinePrompt = `Analyze the impact timeline and strategic planning horizons for the themes discussed in this article.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Category: ${article.category || 'Not specified'}
Future Signal: ${article.future_signal || 'Not specified'}
Time to Impact: ${article.time_to_impact || 'Not specified'}
Summary: ${article.summary}

TIMELINE ANALYSIS INSTRUCTIONS:
1. Identify the key themes and developments mentioned in this article
2. Use your tools to search for related articles in "${actualTopic}" to build a comprehensive timeline
3. Create strategic planning horizons showing:
   - Immediate impacts (2025)
   - Short-term developments (2025-2027)
   - Mid-term transformations (2027-2030)
   - Long-term implications (2030-2035+)

4. For each timeframe, provide:
   - Key milestones and decision points
   - Strategic implications for decision-makers
   - Risk and opportunity windows
   - Evidence from multiple sources

5. Structure your analysis to help strategic planning with specific timelines, actionable insights, and evidence-based projections.

Use your search and analysis tools to gather comprehensive timeline evidence from multiple sources.`;
        
        await launchAuspexWithPrompt(chatId, timelinePrompt, selectedModel, actualTopic, 'Timeline Analysis');
        
    } catch (error) {
        console.error('Error launching timeline analysis:', error);
        showNotification(`Failed to launch timeline analysis: ${error.message}`, 'error');
    }
}

// Helper function to get current profile ID
function getCurrentProfileId() {
    const profileSelect = document.getElementById('profile-select');
    return profileSelect && profileSelect.value ? parseInt(profileSelect.value) : null;
}

// Helper function to create Auspex chat session with profile
async function createAuspexChatSession(topic, title) {
    const profileId = getCurrentProfileId();
    
    const response = await fetch('/api/auspex/chat/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            topic: topic,
            title: title,
            profile_id: profileId
        })
    });
    
    if (!response.ok) {
        throw new Error(`Failed to create chat session: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (profileId) {
        console.log(`Created Auspex chat session ${data.chat_id} with organizational profile ${profileId}`);
    }
    
    return data.chat_id;
}

// Common function to launch Auspex with a specific prompt
async function launchAuspexWithPrompt(chatId, prompt, model, topic, analysisType) {
    try {
        // Open Auspex modal IMMEDIATELY with loading state
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));

        // Set the topic and model in the modal properly
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');

        if (topicSelect) {
            topicSelect.value = topic;
            topicSelect.dispatchEvent(new Event('change'));
        }

        if (modelSelect) {
            modelSelect.value = model;
            modelSelect.dispatchEvent(new Event('change'));
        }

        // Clear existing messages and add our analysis status
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>${analysisType} Starting</strong><br>
                        Preparing comprehensive ${analysisType.toLowerCase()} analysis...
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Initializing analysis...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Open the modal IMMEDIATELY
        auspexModal.show();

        // Get the selected organizational profile
        const profileSelect = document.getElementById('profile-select');
        const selectedProfileId = profileSelect && profileSelect.value ? parseInt(profileSelect.value) : null;

        // NOW send the analysis prompt with profile context (async, after modal is visible)
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: prompt,
                model: model,
                limit: 50,
                profile_id: selectedProfileId,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });

        if (!messageResponse.ok) {
            throw new Error(`Failed to send analysis message: ${messageResponse.status}`);
        }

        // Enable the chat input and send button after message is sent
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');

            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Continue ${analysisType.toLowerCase()}...`;
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Start polling for the analysis results
        pollForAuspexResults(chatId, analysisType);

        // Expose chat id for follow-up actions
        window.currentAuspexChatId = chatId;
        
        showNotification(`${analysisType} launched successfully!`, 'success');
        
    } catch (error) {
        console.error(`Error launching ${analysisType}:`, error);
        showNotification(`Failed to launch ${analysisType}: ${error.message}`, 'error');
    }
}

function toggleStarArticle(articleUri, buttonElement) {
    if (starredArticles.has(articleUri)) {
        // Remove star
        starredArticles.delete(articleUri);
        buttonElement.classList.remove('starred');
        buttonElement.style.background = 'rgba(255, 193, 7, 0.1)';
        buttonElement.style.color = '#ffc107';
        buttonElement.title = 'Add to Six Articles';
        showNotification('Article removed from Six Articles selection', 'info');
    } else {
        // Add star
        if (starredArticles.size >= 6) {
            showNotification('Maximum 6 articles can be starred for Six Articles analysis', 'warning');
            return;
        }
        
        starredArticles.add(articleUri);
        buttonElement.classList.add('starred');
        buttonElement.style.background = '#ffc107';
        buttonElement.style.color = 'white';
        buttonElement.title = 'Remove from Six Articles';
        showNotification('Article added to Six Articles selection', 'success');
    }
    
    updateStarredCount();
}

function updateStarredCount() {
    // Update any UI elements that show starred count
    const starredCount = starredArticles.size;
    
    // Update six articles tab to show starred count
    const sixArticlesTab = document.getElementById('six-articles-tab');
    if (sixArticlesTab) {
        const originalText = sixArticlesTab.textContent.replace(/ \(\d+\)$/, '');
        sixArticlesTab.textContent = starredCount > 0 ? `${originalText} (${starredCount})` : originalText;
    }
    
    // Show warning if more than 6 are starred (shouldn't happen due to limit, but safety check)
    if (starredCount > 6) {
        showNotification('Too many articles starred! Please unstar some to keep 6 or fewer.', 'danger');
    }
}

// Helper functions for bias and factuality display
function getBiasClass(bias) {
    if (!bias) return 'bg-light text-dark';

    const biasClasses = {
        'left': 'bg-primary',
        'left-center': 'bg-info',
        'center': 'bg-secondary',
        'right-center': 'bg-warning text-dark',
        'right': 'bg-danger',
        'mixed': 'bg-dark'
    };

    return biasClasses[bias.toLowerCase()] || 'bg-light text-dark';
}

function getFactualityClass(factuality) {
    if (!factuality) return 'bg-light text-dark';

    const factualityClasses = {
        'very high': 'bg-success',
        'high': 'bg-success',
        'mostly factual': 'bg-info',
        'mixed': 'bg-warning text-dark',
        'low': 'bg-danger',
        'very low': 'bg-danger'
    };

    return factualityClasses[factuality.toLowerCase()] || 'bg-light text-dark';
}

// Add CSS for filter badges
const style = document.createElement('style');
style.textContent = `
    .filter-badge {
        transition: all 0.2s ease;
        opacity: 0.7;
        border: 1px solid transparent;
    }
    
    .filter-badge:hover {
        opacity: 1;
        transform: translateY(-1px);
    }
    
    .filter-badge.active {
        opacity: 1;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }
    
    .selected-date-compact {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        background: rgba(0,123,255,0.1);
        border-radius: 4px;
        border: 1px solid rgba(0,123,255,0.2);
    }
`;
document.head.appendChild(style);

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing news feed...');
    
    // Restore controls state first
    restoreControlsState();
    
    // Load saved defaults
    loadSavedDefaults();
    
    // Load calendar and other data
    loadAvailableDates();
    
    // Load organizational profiles (this will restore profile selection)
    loadOrganizationalProfiles();
    
    // Initialize article count for default date range
    updateArticleCountForDateRange();
    
    // Auto-load articles with 90-day default
    setTimeout(() => {
        autoLoadArticles();
    }, 1000); // Delay to ensure all settings are loaded
});

// Helper function for sentiment styling
function getSentimentClass(sentiment) {
    if (!sentiment) return 'bg-light text-dark';
    const sentimentLower = sentiment.toLowerCase();
    if (sentimentLower.includes('positive')) return 'bg-success text-white';
    if (sentimentLower.includes('negative') || sentimentLower.includes('critical')) return 'bg-danger text-white';
    if (sentimentLower.includes('neutral')) return 'bg-secondary text-white';
    return 'bg-light text-dark';
}

// Launch Ask Auspex chat with article context
async function launchAuspexChat(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Setting up Auspex chat for this article...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Article Discussion: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Get the current analysis if available
        const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const analysisDiv = document.getElementById(analysisId);
        const existingAnalysis = analysisDiv?.querySelector('.analysis-text')?.textContent || 'No analysis available yet';
        
        // Build context prompt with article and analysis
        const contextPrompt = `I'd like to discuss this article with you. Here's the full context:

ARTICLE DETAILS:
Title: ${article.title}
Source: ${article.source}
Date: ${article.date}
URL: ${article.uri}
Category: ${article.category || 'Not specified'}
Sentiment: ${article.sentiment || 'Not specified'}
Future Signal: ${article.future_signal || 'Not specified'}
Time to Impact: ${article.time_to_impact || 'Not specified'}
Driver Type: ${article.driver_type || 'Not specified'}
Tags: ${article.tags || 'None'}

ARTICLE SUMMARY:
${article.summary}

CURRENT ANALYSIS:
${existingAnalysis}

I'm ready to discuss this article with you. You can use your tools to search for related information, analyze trends, or dive deeper into any aspect of this article. What would you like to explore?`;
        
        // Send the context message
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: contextPrompt,
                model: selectedModel,
                profile_id: getCurrentProfileId(),
                limit: 50,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });
        
        if (!messageResponse.ok) {
            throw new Error(`Failed to send context message: ${messageResponse.status}`);
        }
        
        // Open Auspex modal and set it up for conversation
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));
        
        // Set the topic and model in the modal
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');
        
        if (topicSelect) {
            topicSelect.value = actualTopic;
            topicSelect.dispatchEvent(new Event('change'));
        }
        
        if (modelSelect) {
            modelSelect.value = selectedModel;
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        // Enable the chat input for continued conversation
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');
            
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Ask me anything about: ${article.title.substring(0, 50)}...`;
                chatInput.focus();
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Show initial message
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>Article Context Loaded</strong><br>
                        I've analyzed the article "<strong>${article.title}</strong>" and I'm ready to discuss it with you.
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Processing article context...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Open the modal
        auspexModal.show();
        
        // Poll for the context response, then enable chat
        pollForAuspexResults(chatId, 'Article Context');
        
        showNotification('Auspex chat ready for article discussion!', 'success');
        
    } catch (error) {
        console.error('Error launching Auspex chat:', error);
        showNotification(`Failed to launch Auspex chat: ${error.message}`, 'error');
    }
}

// ===== INSIGHTS TAB FUNCTIONALITY =====

let insightsState = {
    hasArticleCache: false,
    hasCategoryCache: false,
    hasIncidentCache: false,
    isLoading: false
};

function updateInsightsButton() {
    const btn = document.getElementById('smart-insights-btn');
    const btnText = document.getElementById('insights-btn-text');
    const icon = btn.querySelector('i');
    
    if (insightsState.isLoading) {
        btn.disabled = true;
        icon.className = 'fas fa-spinner fa-spin me-2';
        btnText.textContent = 'Generating...';
    } else if (insightsState.hasArticleCache || insightsState.hasCategoryCache || insightsState.hasIncidentCache) {
        btn.disabled = false;
        icon.className = 'fas fa-database me-2';
        btnText.textContent = 'Using Cached Data';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-info');
    } else {
        btn.disabled = false;
        icon.className = 'fas fa-brain me-2';
        btnText.textContent = 'Generate Insights';
        btn.classList.remove('btn-info');
        btn.classList.add('btn-primary');
    }
}

async function checkInsightsCache() {
    const topic = getCurrentTopic();
    if (!topic) return;
    
    const currentArticles = window.lastArticlesData?.items || [];
    if (currentArticles.length === 0) return;
    
    const cacheUri = currentArticles[0].uri;
    
    try {
        // Check article insights cache
        const articleCacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=article_insights_${topic}&model=dashboard_api`);
        if (articleCacheResponse.ok) {
            const articleCache = await articleCacheResponse.json();
            insightsState.hasArticleCache = articleCache.cached;
        }
        
        // Check category insights cache
        const categoryCacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=category_insights_${topic}&model=dashboard_api`);
        if (categoryCacheResponse.ok) {
            const categoryCache = await categoryCacheResponse.json();
            insightsState.hasCategoryCache = categoryCache.cached;
        }
        
        // Check incident tracking cache
        const incidentCacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=incident_tracking_${topic}&model=incident_analysis`);
        if (incidentCacheResponse.ok) {
            const incidentCache = await incidentCacheResponse.json();
            insightsState.hasIncidentCache = incidentCache.cached;
        }
        
    } catch (error) {
        console.debug('Cache check failed:', error);
    }
    
    updateInsightsButton();
}

async function autoLoadCachedInsights() {
    const topic = getCurrentTopic();
    if (!topic) return;
    
    await checkInsightsCache();
    
    // If we have any cached data, auto-load it
    if (insightsState.hasArticleCache || insightsState.hasCategoryCache || insightsState.hasIncidentCache) {
        console.log('Auto-loading cached insights');
        await smartGenerateInsights(false, true); // false = don't force, true = auto-load
    }
}

async function smartGenerateInsights(forceRegenerate = false, isAutoLoad = false) {
    if (!isAutoLoad) {
        console.log('Smart insights button clicked', forceRegenerate ? '(force regenerate)' : '');
    }
    
    insightsState.isLoading = true;
    updateInsightsButton();
    
    try {
        await generateInsights(forceRegenerate);
        
        // Reset cache state after generation
        insightsState.hasArticleCache = !forceRegenerate;
        insightsState.hasCategoryCache = !forceRegenerate;
        insightsState.hasIncidentCache = !forceRegenerate;
        
    } finally {
        insightsState.isLoading = false;
        updateInsightsButton();
    }
}

function showInsightsWelcomeMessage() {
    // Show welcome messages in each panel if they're empty
    const articleContainer = document.getElementById('article-insights-container');
    const categoryContainer = document.getElementById('category-insights-container');
    const thematicContainer = document.getElementById('thematic-insights-container');
    
    if (articleContainer && !articleContainer.querySelector('.insight-item-card')) {
        articleContainer.innerHTML = `
            <div class="text-center p-4 w-100">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Article Theme Analysis</h5>
                <p class="text-muted">Generate insights to see AI-powered thematic analysis of current articles with research suggestions.</p>
            </div>
        `;
    }
    
    if (categoryContainer && !categoryContainer.querySelector('.insight-item-card')) {
        categoryContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                <h5>Category Distribution</h5>
                <p class="text-muted">Generate insights to see how articles are distributed across categories.</p>
            </div>
        `;
    }
    
    if (thematicContainer && !thematicContainer.querySelector('.insight-item-card')) {
        thematicContainer.innerHTML = `
            <div class="text-center p-4 w-100">
                <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                <h5>Thematic Clusters</h5>
                <p class="text-muted">Generate insights to see AI-powered thematic groupings of articles.</p>
            </div>
        `;
    }
}

async function loadArticleInsights(topic, startDate, endDate, daysLimit, forceRegenerate = false) {
    const loadingEl = document.getElementById('article-insights-loading');
    const errorEl = document.getElementById('article-insights-error');
    const containerEl = document.getElementById('article-insights-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        // Check database cache first using representative article URI
        const cacheKey = `article_insights_${topic}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit}`;
        let cacheUri = null;
        
        // Use the first article URI from current dataset as cache reference
        const currentArticles = window.lastArticlesData?.items || [];
        console.log('[ArticleInsights] forceRegenerate:', forceRegenerate, 'topic:', topic, 'startDate:', startDate, 'endDate:', endDate, 'daysLimit:', daysLimit);
        console.log('[ArticleInsights] lastArticlesData.items length:', currentArticles.length);
        if (currentArticles.length > 0) {
            cacheUri = currentArticles[0].uri; // Use first article as cache anchor
        }
        console.log('[ArticleInsights] cacheKey:', cacheKey, 'cacheUri:', cacheUri);
        
        if (cacheUri && !forceRegenerate) {
            try {
                const cacheCheckUrl = `/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=article_insights_${topic}&model=dashboard_api`;
                console.log('[ArticleInsights] Checking DB cache:', cacheCheckUrl);
                const cacheResponse = await fetch(cacheCheckUrl);
                console.log('[ArticleInsights] Cache response status:', cacheResponse.status);
                if (cacheResponse.ok) {
                    const cacheData = await cacheResponse.json();
                    console.log('[ArticleInsights] Cache metadata:', cacheData && cacheData.metadata);
                    if (cacheData.cached && cacheData.metadata) {
                        // Check if cache matches our parameters
                        const metadata = cacheData.metadata;
                        console.log('[ArticleInsights] Computed cacheKey:', cacheKey, 'Stored cache_key:', metadata.cache_key);
                        if (metadata.cache_key === cacheKey) {
                            console.log('[ArticleInsights] Using cached article insights from database');
                            const cachedInsights = JSON.parse(cacheData.content || '[]');
                            console.log('[ArticleInsights] Cached insights length:', Array.isArray(cachedInsights) ? cachedInsights.length : 'n/a');
                            
                            // Add cache indicator
                            const containerEl = document.getElementById('article-insights-container');
                            renderArticleInsights(cachedInsights);
                            
                            // Add cache timestamp
                            const cacheTimestamp = cacheData.generated_at ? new Date(cacheData.generated_at).toLocaleString() : 'unknown time';
                            const cacheIndicator = document.createElement('div');
                            cacheIndicator.className = 'alert alert-info py-2 mt-2';
                            cacheIndicator.innerHTML = `<small><i class="fas fa-database me-1"></i>Loaded from database cache (generated: ${cacheTimestamp})</small>`;
                            containerEl.appendChild(cacheIndicator);
                            
                            return;
                        } else {
                            console.log('[ArticleInsights] Cache key mismatch; bypassing cache');
                        }
                    } else {
                        console.log('[ArticleInsights] No cached content available');
                    }
                } else {
                    console.log('[ArticleInsights] Cache check not OK:', cacheResponse.status);
                }
            } catch (cacheError) {
                console.debug('[ArticleInsights] Database cache check failed, proceeding with API call:', cacheError);
            }
        } else if (forceRegenerate) {
            console.log('[ArticleInsights] Force regenerate is true; skipping DB cache');
        }
        
        const params = new URLSearchParams();
        if (startDate && endDate) {
            params.append('start_date', startDate);
            params.append('end_date', endDate);
        } else {
            params.append('days_limit', daysLimit.toString());
        }
        
        if (forceRegenerate) {
            params.append('force_regenerate', 'true');
        }
        
        // Add model parameter
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
        params.append('model', selectedModel);
        
        const insightsUrl = `/api/dashboard/article-insights/${encodeURIComponent(topic)}?${params}`;
        console.log('[ArticleInsights] Fetching insights:', insightsUrl);
        const response = await fetch(insightsUrl);
        
        if (!response.ok) {
            // Handle specific HTTP error codes with user-friendly messages
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `No articles found for topic '${topic}' in the specified date range. Try expanding the date range or selecting a different topic.`);
            } else if (response.status === 422) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Insufficient articles for meaningful insights. Try expanding the date range or selecting a different topic.`);
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
        
        const data = await response.json();
        console.log('[ArticleInsights] API insights length:', Array.isArray(data) ? data.length : 'n/a');
        if (!Array.isArray(data) || data.length === 0) {
            console.log('[ArticleInsights] Empty insights from API; will NOT cache empty result');
        }
        
        // Cache insights in database using representative article URI
        try {
            const cacheKey = `article_insights_${topic}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit}`;
            const currentArticles = window.lastArticlesData?.items || [];
            
            if (currentArticles.length > 0 && Array.isArray(data) && data.length > 0) {
                const cacheUri = currentArticles[0].uri; // Use first article as cache anchor
                const cacheContent = JSON.stringify(data, null, 2);
                const cacheMetadata = {
                    cache_key: cacheKey,
                    topic: topic,
                    start_date: startDate,
                    end_date: endDate,
                    days_limit: daysLimit,
                    insight_type: 'article_themes',
                    article_count: currentArticles.length
                };
                
                console.log('[ArticleInsights] Saving insights to cache for uri:', cacheUri, 'metadata:', cacheMetadata);
                const cacheResponse = await fetch('/api/save-analysis-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        article_uri: cacheUri,
                        analysis_type: `article_insights_${topic}`,
                        content: cacheContent,
                        model_name: 'dashboard_api',
                        metadata: cacheMetadata
                    })
                });
                
                if (cacheResponse.ok) {
                    console.log('[ArticleInsights] Cached article insights in database');
                } else {
                    console.warn('[ArticleInsights] Failed to cache article insights - server error:', cacheResponse.status);
                }
            } else if (!Array.isArray(data) || data.length === 0) {
                console.warn('[ArticleInsights] Skipping cache save because insights are empty');
            } else {
                console.warn('[ArticleInsights] No articles available for cache anchoring');
            }
        } catch (cacheError) {
            console.warn('[ArticleInsights] Failed to cache article insights:', cacheError);
        }
        
        renderArticleInsights(data);
        
    } catch (error) {
        console.error('Error loading article insights:', error);
        
        // Provide specific error messages based on the error content
        let errorMessage = error.message;
        let errorIcon = 'fas fa-exclamation-triangle';
        let errorClass = 'alert-warning';
        
        if (error.message.includes('No articles found') || error.message.includes('Insufficient articles')) {
            errorIcon = 'fas fa-info-circle';
            errorClass = 'alert-info';
        }
        
        errorEl.innerHTML = `<div class="alert ${errorClass}"><i class="${errorIcon} me-2"></i>${errorMessage}</div>`;
        errorEl.style.display = 'block';
        
        // Show appropriate fallback message
        if (error.message.includes('No articles found') || error.message.includes('Insufficient articles')) {
            containerEl.innerHTML = `
                <div class="text-center p-4 w-100">
                    <i class="fas fa-calendar-times fa-2x text-info mb-3"></i>
                    <h5>Insufficient Data for Insights</h5>
                    <p class="text-muted">Try expanding your date range to include more articles, or select a topic with more activity.</p>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            Tip: Article insights require at least 3 articles to generate meaningful themes.
                        </small>
                    </div>
                </div>
            `;
        } else {
            containerEl.innerHTML = `
                <div class="text-center p-4 w-100">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                    <h5>Article Insights Unavailable</h5>
                    <p class="text-muted">Unable to generate article insights. Please try again or contact support if the problem persists.</p>
                </div>
            `;
        }
    } finally {
        loadingEl.style.display = 'none';
    }
}

async function loadCategoryInsights(topic, startDate, endDate, daysLimit, forceRegenerate = false) {
    const loadingEl = document.getElementById('category-insights-loading');
    const errorEl = document.getElementById('category-insights-error');
    const containerEl = document.getElementById('category-insights-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        // Check database cache first using representative article URI
        const cacheKey = `category_insights_${topic}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit}`;
        let cacheUri = null;
        
        // Use the first article URI from current dataset as cache reference
        const currentArticles = window.lastArticlesData?.items || [];
        if (currentArticles.length > 0) {
            cacheUri = currentArticles[0].uri; // Use first article as cache anchor
        }
        
        if (cacheUri) {
            try {
                const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=category_insights_${topic}&model=dashboard_api`);
                if (cacheResponse.ok) {
                    const cacheData = await cacheResponse.json();
                    if (cacheData.cached && cacheData.metadata) {
                        // Check if cache matches our parameters
                        const metadata = cacheData.metadata;
                        if (metadata.cache_key === cacheKey) {
                            if (forceRegenerate) {
                                console.log('Bypassing cached category insights due to force regenerate');
                            } else {
                                console.log('Using cached category insights from database');
                                const cachedInsights = JSON.parse(cacheData.content);
                                
                                // Add cache indicator
                                const containerEl = document.getElementById('category-insights-container');
                                renderCategoryInsights(cachedInsights);
                                
                                // Add cache timestamp
                                const cacheTimestamp = new Date(cacheData.generated_at).toLocaleString();
                                const cacheIndicator = document.createElement('div');
                                cacheIndicator.className = 'alert alert-info py-2 mt-2';
                                cacheIndicator.innerHTML = `<small><i class="fas fa-database me-1"></i>Loaded from database cache (generated: ${cacheTimestamp})</small>`;
                                containerEl.appendChild(cacheIndicator);
                                
                                return;
                            }
                        }
                    }
                }
            } catch (cacheError) {
                console.debug('Database cache check failed, proceeding with API call:', cacheError);
            }
        }
        
        const params = new URLSearchParams();
        if (startDate && endDate) {
            params.append('start_date', startDate);
            params.append('end_date', endDate);
        } else {
            params.append('days_limit', daysLimit.toString());
        }
        
        if (forceRegenerate) {
            params.append('force_regenerate', 'true');
        }
        
        // Add model parameter
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
        params.append('model', selectedModel);
        
        const response = await fetch(`/api/dashboard/category-insights/${encodeURIComponent(topic)}?${params}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Cache category insights in database using representative article URI
        try {
            const cacheKey = `category_insights_${topic}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit}`;
            const currentArticles = window.lastArticlesData?.items || [];
            
            if (currentArticles.length > 0) {
                const cacheUri = currentArticles[0].uri; // Use first article as cache anchor
                const cacheContent = JSON.stringify(data, null, 2);
                const cacheMetadata = {
                    cache_key: cacheKey,
                    topic: topic,
                    start_date: startDate,
                    end_date: endDate,
                    days_limit: daysLimit,
                    insight_type: 'category_distribution',
                    article_count: currentArticles.length
                };
                
                const cacheResponse = await fetch('/api/save-analysis-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        article_uri: cacheUri,
                        analysis_type: `category_insights_${topic}`,
                        content: cacheContent,
                        model_name: 'dashboard_api',
                        metadata: cacheMetadata
                    })
                });
                
                if (cacheResponse.ok) {
                    console.log('Cached category insights in database');
                } else {
                    console.warn('Failed to cache category insights - server error:', cacheResponse.status);
                }
            } else {
                console.warn('No articles available for cache anchoring');
            }
        } catch (cacheError) {
            console.warn('Failed to cache category insights:', cacheError);
        }
        
        renderCategoryInsights(data);
        
    } catch (error) {
        console.error('Error loading category insights:', error);
        errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load category insights: ${error.message}</div>`;
        errorEl.style.display = 'block';
        
        // Show fallback message
        containerEl.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                <h5>Category Analysis Unavailable</h5>
                <p class="text-muted">Unable to generate category insights. Please try again or check if the topic has sufficient articles.</p>
            </div>
        `;
    } finally {
        loadingEl.style.display = 'none';
    }
}

async function loadThematicInsights(topic, startDate, endDate, daysLimit) {
    const loadingEl = document.getElementById('thematic-insights-loading');
    const errorEl = document.getElementById('thematic-insights-error');
    const containerEl = document.getElementById('thematic-insights-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        // Require a topic (dashboard article-insights is topic-scoped)
        const topicSelect = document.getElementById('topic-select');
        const selectedTopic = topicSelect ? (topicSelect.value || '').trim() : '';
        if (!selectedTopic) {
            errorEl.innerHTML = `<div class="alert alert-warning"><i class=\"fas fa-info-circle me-2\"></i>Select a topic to generate thematic clusters.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Build time params from the current date range
        const drSel = document.getElementById('date-range-select');
        const drVal = drSel ? drSel.value : '3m';
        const params = new URLSearchParams();
        let periodLabel = 'this period';
        switch (drVal) {
            case '24h':
                params.append('days_limit', '1'); periodLabel = 'the last 24 hours'; break;
            case '7d':
                params.append('days_limit', '7'); periodLabel = 'the last 7 days'; break;
            case '30d':
                params.append('days_limit', '30'); periodLabel = 'the last 30 days'; break;
            case '3m':
                params.append('days_limit', '90'); periodLabel = 'the last 3 months'; break;
            case '1y':
                params.append('days_limit', '365'); periodLabel = 'the last year'; break;
            case 'all':
                // Let the backend decide; do not pass days_limit
                periodLabel = 'all time'; break;
            case 'custom':
                // Use the selected date as both start and end
                const customDate = document.getElementById('custom-date-input')?.value || document.getElementById('selected-date')?.value;
                if (customDate) {
                    params.append('start_date', customDate);
                    params.append('end_date', customDate);
                    periodLabel = 'the selected date';
                } else {
                    params.append('days_limit', '1');
                    periodLabel = 'the last 24 hours';
                }
                break;
            default:
                params.append('days_limit', '90'); periodLabel = 'the last 3 months';
        }
        
        // Call topic dashboard article-insights (same logic as topic_dashboard.html)
        const response = await fetch(`/api/dashboard/article-insights/${encodeURIComponent(selectedTopic)}?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();

        // If no themes returned, show explicit reason (no fallback rendering)
        if (!data || (Array.isArray(data) && data.length === 0)) {
            errorEl.innerHTML = `<div class=\"alert alert-warning\"><i class=\"fas fa-info-circle me-2\"></i>No thematic clusters available. Reason: insufficient thematic signal for ${periodLabel}.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Transform dashboard themes -> cluster format used by renderThematicInsights
        const currentArticles = (window.lastArticlesData && window.lastArticlesData.items) ? window.lastArticlesData.items : [];
        const transformed = (Array.isArray(data) ? data : []).map((theme, idx) => {
            // Try to find article details from current dataset by URIs if provided
            let articles = [];
            const articleUris = theme.article_uris || theme.articleIds || theme.article_ids || [];
            if (Array.isArray(articleUris) && articleUris.length > 0 && currentArticles.length > 0) {
                articles = articleUris.map(uri => currentArticles.find(a => a.uri === uri)).filter(Boolean);
            }
            // Fallback: if API already includes article objects
            if ((!articles || articles.length === 0) && Array.isArray(theme.articles)) {
                articles = theme.articles;
            }
            // Compute simple source diversity
            const sourceDiversity = [...new Set((articles || []).map(a => a?.source_type || a?.news_source || 'unknown'))].length;
            
            return {
                theme_name: theme.theme_name || theme.name || `Theme ${idx + 1}`,
                theme_summary: theme.theme_summary || theme.summary || '',
                articles: articles || [],
                article_count: (articles || []).length,
                confidence: typeof theme.confidence === 'number' ? theme.confidence : undefined,
                source_diversity: sourceDiversity
            };
        });

        if (!transformed || transformed.length === 0) {
            errorEl.innerHTML = `<div class=\"alert alert-warning\"><i class=\"fas fa-info-circle me-2\"></i>No thematic clusters available. Reason: the topic has themes but no matching articles were loaded for ${periodLabel}. Try regenerating articles or adjusting the date range.</div>`;
            errorEl.style.display = 'block';
            return;
        }
        
        renderThematicInsights(transformed);
    } catch (error) {
        console.error('Error loading thematic insights:', error);
        errorEl.innerHTML = `<div class=\"alert alert-warning\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load thematic insights: ${error.message}</div>`;
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function renderArticleInsights(data) {
    const container = document.getElementById('article-insights-container');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No article insights available for this period.</div>';
        return;
    }
    
    console.log(`Rendering ${data.length} article insights:`, data);
    
    data.forEach((themeItem, index) => {
        const insightCard = document.createElement('div');
        insightCard.className = 'insight-item-card';
        
        // Build articles list with links
        let articlesHtml = '<ul class="list-unstyled mt-2 mb-0 small">';
        if (themeItem.articles && themeItem.articles.length > 0) {
            themeItem.articles.forEach(article => {
                const pubDate = article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'N/A';
                articlesHtml += `
                    <li class="mb-1">
                        <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                            ${article.title || 'Untitled Article'}
                        </a>
                        <small class="text-muted d-block">${formatSource(article.news_source, article.uri)} - ${pubDate}</small>
                        ${article.summary ? `<p class="mb-0 fst-italic text-muted" style="font-size: 0.8rem;">${article.summary.substring(0, 100)}...</p>` : ''}
                    </li>`;
            });
        } else {
            articlesHtml += '<li class="text-muted">No specific articles listed for this theme.</li>';
        }
        articlesHtml += '</ul>';

        insightCard.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">${themeItem.theme_name || 'Unnamed Theme'}</h6>
                <span class="badge bg-warning text-dark">Theme</span>
            </div>
            <p class="mb-1 small">${themeItem.theme_summary || 'No summary provided for this theme.'}</p>
            ${articlesHtml}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(themeItem.theme_name)}', 'article_theme')">
                    <i class="fas fa-search me-1"></i>Research with Auspex
                </button>
            </div>
        `;
        container.appendChild(insightCard);
    });
}

function renderCategoryInsights(data) {
    const container = document.getElementById('category-insights-container');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No category insights available for this period.</div>';
        return;
    }
    
    data.forEach(categoryItem => {
        const card = document.createElement('div');
        card.className = 'insight-item-card';
        
        // Prefer backend-provided sample articles; fallback to current feed filter
        let categoryArticles = [];
        if (Array.isArray(categoryItem.sample_articles) && categoryItem.sample_articles.length > 0) {
            categoryArticles = categoryItem.sample_articles;
        } else {
            const currentArticles = window.lastArticlesData?.items || [];
            categoryArticles = currentArticles.filter(article => 
                article.category && article.category.toLowerCase() === categoryItem.category.toLowerCase()
            ).slice(0, 5); // Show up to 5 articles
        }
        
        // Build articles list
        let articlesHtml = '';
        if (categoryArticles.length > 0) {
            articlesHtml = `
                <div class="mt-2 mb-2">
                    <small class="text-muted fw-bold">Sample Articles:</small>
                    <ul class="list-unstyled mt-1 mb-0 small">
                        ${categoryArticles.map(article => {
                            const pubDate = article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'N/A';
                            return `
                                <li class="mb-1">
                                    <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                                        ${article.title || 'Untitled Article'}
                                    </a>
                                    <small class="text-muted d-block">${formatSource(article.news_source, article.uri)} - ${pubDate}</small>
                                </li>`;
                        }).join('')}
                    </ul>
                </div>
            `;
        }

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">${categoryItem.category}</h6>
                <span class="badge bg-success text-dark">Category</span>
            </div>
            <p class="mb-1 small"><strong>Article Count:</strong> ${categoryItem.article_count}</p>
            <p class="mb-2 small fst-italic">${categoryItem.insight_text || 'Further analysis for this category will be available soon.'}</p>
            ${articlesHtml}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(categoryItem.category)}', 'category')">
                    <i class="fas fa-search me-1"></i>Research Category
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

function renderThematicInsights(data) {
    const container = document.getElementById('thematic-insights-container');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No thematic clusters available for this period.</div>';
        return;
    }
    
    data.forEach((cluster, index) => {
        const card = document.createElement('div');
        card.className = 'insight-item-card thematic-cluster';
        
        // Source diversity indicators
        const sourceTypes = cluster.source_types || [];
        const sourceBadges = sourceTypes.map(type => {
            const color = type === 'arxiv' ? 'primary' : 
                         type === 'bluesky' ? 'info' : 
                         type === 'thenewsapi' ? 'success' : 'secondary';
            return `<span class="badge bg-${color} me-1">${type.toUpperCase()}</span>`;
        }).join('');
        
        // Articles list (initially hidden)
        let articlesHtml = '';
        if (cluster.articles && cluster.articles.length > 0) {
            articlesHtml = `
                <div class="cluster-article-list" id="cluster-articles-${index}" style="display: none;">
                    ${cluster.articles.map(article => `
                        <div class="cluster-article-item">
                            <a href="${article.url || '#'}" target="_blank" rel="noopener">
                                <strong>${article.title || 'Untitled Article'}</strong>
                            </a>
                            <div class="text-muted small mt-1">
                                ${article.source_type ? `<span class="badge bg-secondary me-2">${article.source_type.toUpperCase()}</span>` : ''}
                                ${article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'No date'}
                                ${article.author ? ` • ${article.author}` : ''}
                            </div>
                            ${article.content ? `<p class="small text-muted mt-1 mb-0">${article.content.substring(0, 150)}...</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        const stats = `
            <div class="cluster-stats">
                <div class="cluster-stat">
                    <i class="fas fa-file-alt"></i>
                    <span>${cluster.article_count || cluster.articles?.length || 0} articles</span>
                </div>
                <div class="cluster-stat">
                    <i class="fas fa-percentage"></i>
                    <span>${Math.round((cluster.confidence || 0) * 100)}% confidence</span>
                </div>
                <div class="cluster-stat">
                    <i class="fas fa-layer-group"></i>
                    <span>${cluster.source_diversity || 1} sources</span>
                </div>
            </div>
        `;
        
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">${cluster.theme_name || `Theme ${index + 1}`}</h6>
                <div class="d-flex align-items-center gap-2">
                    ${sourceBadges}
                    <span class="badge bg-info">Thematic</span>
                </div>
            </div>
            <p class="mb-2 small">${cluster.theme_summary || cluster.description || 'No summary available for this theme.'}</p>
            ${stats}
            ${cluster.articles && cluster.articles.length > 0 ? `
            <div class="mt-2 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="toggleClusterArticles(${index})">
                    <i class="fas fa-eye"></i> <span id="toggle-text-${index}">Show Articles</span>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="launchAuspexResearchFromInsight('${escapeHTML(cluster.theme_name || `Theme ${index + 1}`)}', 'thematic_cluster')">
                    <i class="fas fa-search me-1"></i>Research Theme
                </button>
            </div>
            ${articlesHtml}` : ''}
        `;
        
        container.appendChild(card);
    });
}

function toggleClusterArticles(clusterIndex) {
    const articlesList = document.getElementById(`cluster-articles-${clusterIndex}`);
    const toggleText = document.getElementById(`toggle-text-${clusterIndex}`);
    
    if (!articlesList) return;
    
    if (articlesList.style.display === 'none') {
        articlesList.style.display = 'block';
        if (toggleText) toggleText.textContent = 'Hide Articles';
    } else {
        articlesList.style.display = 'none';
        if (toggleText) toggleText.textContent = 'Show Articles';
    }
}

function clearInsightsContent() {
    // Clear all insights content when topic or date range changes
    const articleContainer = document.getElementById('article-insights-container');
    const categoryContainer = document.getElementById('category-insights-container');
    const thematicContainer = document.getElementById('thematic-insights-container');
    
    if (articleContainer) {
        articleContainer.innerHTML = `
            <div class="text-center p-4 w-100">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Article Theme Analysis</h5>
                <p class="text-muted">Generate insights to see AI-powered thematic analysis of current articles with research suggestions.</p>
            </div>
        `;
    }
    
    if (categoryContainer) {
        categoryContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                <h5>Category Distribution</h5>
                <p class="text-muted">Generate insights to see how articles are distributed across categories.</p>
            </div>
        `;
    }
    
    if (thematicContainer) {
        thematicContainer.innerHTML = `
            <div class="text-center p-4 w-100">
                <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                <h5>Thematic Clusters</h5>
                <p class="text-muted">Generate insights to see AI-powered thematic groupings of articles.</p>
            </div>
        `;
    }
}

// Helper: build dataset-anchored context to avoid generic prompts
function buildDatasetContext(insightTopic, articles, detailedLimit = 15, extraLimit = 35) {
    if (!Array.isArray(articles) || articles.length === 0) return { detailedLines: '', uriLines: '', matches: [] };
    const topic = String(insightTopic || '').toLowerCase();
    const SYNONYMS = {
        'deal': ['deal', 'dealmaking', 'acquisition', 'acquire', 'merger', 'm&a', 'investment', 'funding', 'raise', 'round', 'series a', 'series b', 'financing', 'partnership', 'agreement', 'contract', 'buyout', 'ipo', 'alliance', 'joint venture'],
        'regulation': ['regulation', 'regulatory', 'policy', 'compliance', 'dsa', 'gdpr', 'antitrust', 'lawsuit', 'complaint', 'fine', 'ban', 'oversight'],
        'safety': ['safety', 'governance', 'risk', 'alignment', 'responsibility', 'ethics', 'ethical'],
        'incident': ['incident', 'breach', 'leak', 'lawsuit', 'complaint', 'investigation']
    };
    const terms = new Set(topic.split(/\W+/).filter(Boolean));
    Object.entries(SYNONYMS).forEach(([key, words]) => {
        if (topic.includes(key) || terms.has(key)) words.forEach(w => terms.add(w));
    });
    const scoreFor = (text, weight) => {
        if (!text) return 0;
        const lower = String(text).toLowerCase();
        let s = 0;
        terms.forEach(t => { if (t && lower.includes(t)) s += weight; });
        return s;
    };
    const scored = articles.map(a => {
        const s = (scoreFor(a.title, 3) + scoreFor(a.summary, 1) + scoreFor(a.category, 2) + scoreFor((a.tags||[]).join(' '), 2));
        return { article: a, score: s };
    }).sort((x, y) => y.score - x.score);
    const positive = scored.filter(x => x.score > 0).map(x => x.article);
    const topDetailed = positive.slice(0, detailedLimit);
    const remaining = positive.slice(detailedLimit, detailedLimit + extraLimit);
    const detailedLines = topDetailed.map((article, idx) => {
        const date = formatPubDate(article.publication_date, false);
        const source = formatSource(article.news_source, article.uri);
        const brief = (article.summary || '').slice(0, 140).replace(/\n+/g, ' ');
        return `${idx + 1}. ${article.title} (${source}, ${date})\n   URI: ${article.uri}\n   Brief: ${brief}${brief.length >= 140 ? '...' : ''}`;
    }).join('\n');
    const uriLines = remaining.map(a => `- ${a.title} — ${a.uri}`).join('\n');
    return { detailedLines, uriLines, matches: topDetailed.concat(remaining) };
}

// Launch Auspex research from insights (similar to article research themes)
async function launchAuspexResearchFromInsight(insightTopic, insightType) {
    try {
        showNotification(`Launching Auspex research on: ${insightTopic}`, 'info');
        
        // Get the current topic and articles context
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const currentArticles = window.lastArticlesData?.items || [];
        
        console.log(`Research setup: Insight="${insightTopic}", Type="${insightType}", Topic="${actualTopic}"`);
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `${insightType === 'category' ? 'Category' : insightType === 'thematic_cluster' ? 'Theme' : 'Article'} Research: ${insightTopic}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Get the selected model from the news feed UI
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Build comprehensive research prompt based on insight type
        let researchPrompt = '';
        
        if (insightType === 'ceo_article') {
            // CEO article deep dive research prompt
            researchPrompt = `Conduct executive-level deep dive analysis on: "${insightTopic}"

This article was selected as one of the top 6 most important AI articles for CEOs and senior decision-makers.

RESEARCH FOCUS: Executive deep dive on "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for related articles and background context on this topic
2. Analyze strategic implications for executive decision-making
3. Identify competitive landscape and market dynamics
4. Assess regulatory and policy implications
5. Evaluate risks and opportunities for organizations
6. Provide actionable recommendations for senior leadership
7. Identify key stakeholders and decision points
8. Analyze potential timeline and impact scenarios

Focus on executive-level strategic insights that would be valuable for C-suite decision-making and board discussions.`;
        } else if (insightType === 'category') {
            // Category research prompt
            const categoryArticles = currentArticles.filter(article => 
                article.category && article.category.toLowerCase() === insightTopic.toLowerCase()
            );
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, categoryArticles, 18, 42);
            
            researchPrompt = `Conduct comprehensive research on the "${insightTopic}" category in ${actualTopic}.

CONTEXT FROM NEWS FEED:
Top matching articles in our dataset (detailed):\n${detailedLines || '(no strong matches in current feed)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: "${insightTopic}" category analysis

Please use your tools to:
1. First analyze the dataset articles above (cite URIs). Build connections and timelines across them.
2. Identify key entities, organizations, and deal terms appearing repeatedly.
3. Summarize developments, trends, and market implications specific to this dataset.
4. Suggest exactly 2-3 high-priority follow-up questions that users could ask to expand coverage.
5. Only if necessary, suggest 1-2 external research angles as follow-up.

Write follow-up questions as natural language that users would ask, not as technical function calls.

Respond with sections: Dataset Findings, Key Entities, Timeline, Gaps, Suggested Follow-up Questions (limit to 2-3), Optional Research Angles (limit to 1-2).`;
        } else if (insightType === 'thematic_cluster') {
            // Thematic cluster research prompt
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, currentArticles, 18, 42);
            researchPrompt = `Conduct deep research on the theme "${insightTopic}" within ${actualTopic}.

CONTEXT FROM THEMATIC ANALYSIS:
This theme was identified through AI analysis of current articles in the news feed.

DATASET CONTEXT (top matches):\n${detailedLines || '(no strong matches found; derive related terms and search dataset)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: "${insightTopic}" thematic analysis

Please use your tools to:
1. Prioritize the dataset items above (cite URIs) and synthesize cross-article insights.
2. Identify trends, entities, and relationships evidenced by these articles.
3. Provide dataset-first analysis, then suggest exactly 2-3 follow-up questions users could ask.
4. Provide actionable insights for stakeholders.

Write follow-up questions as natural language that users would ask, not as technical function calls.`;
        } else if (insightType === 'incident') {
            // Incident tracking research prompt
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, currentArticles, 18, 42);
            researchPrompt = `Conduct detailed incident investigation on: "${insightTopic}"

CONTEXT FROM INCIDENT TRACKING:
This incident was identified through AI-powered threat hunting analysis of current articles.

DATASET CONTEXT (potentially related):\n${detailedLines || '(use dataset search to find related incident articles)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: Incident investigation - "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search within our dataset for all articles related to this incident (cite URIs)
2. Build a comprehensive timeline of events and developments
3. Identify key entities, organizations, and stakeholders involved
4. Analyze the scope, impact, and implications of this incident
5. Track related incidents or patterns that might be connected
6. Assess current status and ongoing developments
7. Identify potential risks, vulnerabilities, or threat indicators
8. Provide actionable intelligence and recommendations

Treat this as a comprehensive incident investigation using all available tools and sources.`;
        } else if (insightType === 'signal_investigation') {
            // Signal investigation research prompt  
            researchPrompt = `Conduct deep signal analysis on: "${insightTopic}"

CONTEXT FROM REAL-TIME SIGNALS:
This signal was flagged by custom threat hunting instructions as requiring investigation.

RESEARCH FOCUS: Signal investigation - "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for articles matching this signal pattern
2. Analyze the threat landscape and context around this signal
3. Identify related signals, patterns, or indicators
4. Assess the severity and potential impact of developments
5. Track historical patterns and precedents
6. Evaluate current threat level and trajectory
7. Identify key stakeholders and affected parties
8. Provide actionable threat intelligence and recommendations

Focus on providing comprehensive threat analysis and strategic intelligence.`;
        } else if (insightType === 'investigation_lead') {
            // Investigation lead research prompt
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, currentArticles, 18, 42);
            researchPrompt = `Conduct focused investigation on the lead: "${insightTopic}"

CONTEXT FROM INCIDENT TRACKING:
This investigation lead was identified through AI-powered incident analysis as a key area requiring deeper research.

DATASET CONTEXT (top matches):\n${detailedLines || '(no direct matches found; derive related terms and search the dataset)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: Investigation lead - "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search within our dataset for articles related to this lead (cite URIs)
2. Analyze connections to ongoing incidents or patterns
3. Identify key entities, organizations, or individuals involved
4. Assess the significance and potential implications
5. Track historical context and related developments
6. Evaluate current status and recent activities
7. Identify exactly 2-3 additional investigation angles or related leads
8. Provide actionable intelligence and next steps

Prioritize dataset-first analysis. Suggest exactly 2-3 follow-up questions users could ask to continue the investigation.

Write follow-up questions as natural language that users would ask, not as technical function calls.`;
        } else {
            // Article theme research prompt
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, currentArticles, 18, 42);
            researchPrompt = `Conduct comprehensive analysis of the theme "${insightTopic}" identified from recent ${actualTopic} articles.

CONTEXT FROM ARTICLE ANALYSIS:
This theme emerged from AI analysis of recent articles in the news feed.

DATASET CONTEXT (top matches):\n${detailedLines || '(derive related terms and search dataset)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Start with the dataset items above; synthesize cross-article findings and cite URIs.
2. Identify trends, entities, relationships, and implications grounded in the dataset.
3. Suggest exactly 2-3 follow-up questions users could ask to expand analysis.
4. Provide strategic recommendations for decision-makers.

Write follow-up questions as natural language that users would ask, not as technical function calls.`;
        }
        
        // Use the same launch pattern as working article analysis
        const displayNames = {
            'category': 'Category Analysis',
            'incident': 'Incident Investigation',
            'signal_investigation': 'Signal Analysis', 
            'article_theme': 'Theme Research',
            'thematic_cluster': 'Thematic Analysis',
            'category_deep': 'Category Deep Dive',
            'strategic_analysis': 'Strategic Analysis',
            'timeline_analysis': 'Timeline Analysis',
            'investigation_lead': 'Investigation Lead'
        };
        
        const analysisDisplayName = displayNames[insightType] || `${insightType} Research`;
        await launchAuspexWithPrompt(chatId, researchPrompt, selectedModel, actualTopic, analysisDisplayName);
        
        showNotification(`Auspex research launched: ${insightTopic}`, 'success');
        
    } catch (error) {
        console.error('Error launching Auspex research:', error);
        showNotification(`Failed to launch Auspex research: ${error.message}`, 'error');
    }
}

// ===== ENHANCED SIX ARTICLES RESEARCH FUNCTIONS =====

// Launch Deep Dive analysis for six articles
async function launchSixArticleDeepDive(articleTitle, articleUrl) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching deep-dive analysis...', 'info');
        
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `CEO Deep Dive: ${articleTitle}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        const deepDivePrompt = `Conduct a comprehensive executive-level deep-dive analysis of this CEO Daily Top-6 article using the Deep Dive Template framework.

CONTEXT ARTICLE (CEO Daily Selected):
Title: ${articleTitle}
URL: ${articleUrl}
Selected as: One of the 6 most strategically important AI articles for executives

EXECUTIVE DEEP DIVE INSTRUCTIONS:
Use your tools to search for articles related to the themes in this CEO Daily selection and conduct a comprehensive C-suite analysis following the Deep Dive Template structure:

1. Executive Summary & Context Setting
2. Strategic Dimensions Analysis (4-5 relevant dimensions for executives)
3. Market & Competitive Impact Analysis  
4. Regulatory & Risk Assessment
5. Strategic Implications & Evidence
6. Executive Decision Framework
7. Recommended Actions & Timeline

Focus on providing evidence-based analysis grounded in multiple sources that would be valuable for board discussions and executive decision-making. Use your search tools to find related articles and build a comprehensive strategic picture.

Target: Executive briefing quality, 900-1200 words with specific data points and actionable strategic insights.`;
        
        await launchAuspexWithPrompt(chatId, deepDivePrompt, selectedModel, actualTopic, 'CEO Deep Dive Analysis');
        
    } catch (error) {
        console.error('Error launching six article deep dive:', error);
        showNotification(`Failed to launch deep dive: ${error.message}`, 'error');
    }
}

// Launch Consensus analysis for six articles
async function launchSixArticleConsensus(articleTitle, articleUrl) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching consensus analysis...', 'info');
        
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Consensus Analysis: ${articleTitle}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        const consensusPrompt = `Analyze the consensus vs outlier perspectives regarding this CEO Daily Top-6 article.

CONTEXT ARTICLE (CEO Daily Selected):
Title: ${articleTitle}
URL: ${articleUrl}
Strategic Importance: Selected as one of 6 most important AI articles for executives

CONSENSUS ANALYSIS INSTRUCTIONS:
1. Identify the key claims or predictions made in this strategically important article
2. Use your tools to search for related articles in "${actualTopic}"
3. Analyze whether these claims represent:
   - Executive consensus (majority C-suite/analyst view)
   - Emerging consensus (growing agreement among experts)
   - Contrarian perspective (minority/outlier executive view)
   - Mixed expert views (no clear consensus)

4. Provide evidence-based executive analysis showing:
   - What the market consensus actually says about these topics
   - How this article's perspective compares to mainstream executive thinking
   - Timeline consensus among industry leaders (when impacts are expected)
   - Confidence levels in different strategic scenarios
   - Notable outlier perspectives from credible sources

5. Structure your response for executive consumption with clear sections showing the comparison between this article's strategic claims and broader market consensus.

Use your search and analysis tools to gather comprehensive evidence from authoritative sources.`;
        
        await launchAuspexWithPrompt(chatId, consensusPrompt, selectedModel, actualTopic, 'Executive Consensus Analysis');
        
    } catch (error) {
        console.error('Error launching six article consensus:', error);
        showNotification(`Failed to launch consensus analysis: ${error.message}`, 'error');
    }
}

// Launch Timeline analysis for six articles
async function launchSixArticleTimeline(articleTitle, articleUrl) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching timeline analysis...', 'info');
        
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Executive Timeline: ${articleTitle}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        const timelinePrompt = `Analyze the executive timeline and strategic planning horizons for this CEO Daily Top-6 article.

CONTEXT ARTICLE (CEO Daily Selected):
Title: ${articleTitle}
URL: ${articleUrl}
Strategic Priority: Selected as one of 6 most important AI articles for C-suite

EXECUTIVE TIMELINE ANALYSIS INSTRUCTIONS:
1. Identify the key strategic themes and business implications mentioned in this article
2. Use your tools to search for related articles in "${actualTopic}" to build a comprehensive executive timeline
3. Create strategic planning horizons for C-suite decision-making:
   - Immediate actions (Q4 2025)
   - Short-term strategic moves (2025-2027)
   - Mid-term transformations (2027-2030)
   - Long-term strategic positioning (2030-2035+)

4. For each timeframe, provide:
   - Key business milestones and executive decision points
   - Strategic implications for market positioning and competitive advantage
   - Risk and opportunity windows for executives
   - Investment and resource allocation considerations
   - Regulatory and compliance timeline factors
   - Evidence from authoritative industry sources

5. Structure your analysis for board-level strategic planning with specific timelines, actionable insights, and evidence-based executive recommendations.

Use your search and analysis tools to gather comprehensive timeline evidence from credible business and industry sources.`;
        
        await launchAuspexWithPrompt(chatId, timelinePrompt, selectedModel, actualTopic, 'Executive Timeline Analysis');
        
    } catch (error) {
        console.error('Error launching six article timeline:', error);
        showNotification(`Failed to launch timeline analysis: ${error.message}`, 'error');
    }
}

// Launch Chat with Auspex for six articles
async function launchSixArticleChat(articleTitle, articleUrl) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Setting up Auspex chat for CEO article...', 'info');
        
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `CEO Article Discussion: ${articleTitle}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        const contextPrompt = `I'd like to discuss this CEO Daily Top-6 article with you.

ARTICLE CONTEXT (CEO Daily Selected):
Title: ${articleTitle}
URL: ${articleUrl}
Strategic Importance: This was selected as one of the 6 most important AI articles for executives and senior decision-makers.

EXECUTIVE DISCUSSION SETUP:
This article was chosen based on high scores for strategic relevance, novelty, credibility, and representativeness. It's designed for C-suite consumption and strategic decision-making.

I'm ready to discuss this article with you from an executive perspective. You can use your tools to search for related information, analyze market implications, assess competitive dynamics, or dive deeper into any strategic aspect of this article.

What executive-level insights or strategic analysis would you like to explore about this article?`;
        
        await launchAuspexWithPrompt(chatId, contextPrompt, selectedModel, actualTopic, 'CEO Article Discussion');
        
    } catch (error) {
        console.error('Error launching six article chat:', error);
        showNotification(`Failed to launch Auspex chat: ${error.message}`, 'error');
    }
}

// Open annotation modal for six articles
function openSixArticleAnnotation(articleUrl, articleTitle) {
    if (!articleUrl) {
        showNotification('No URL available for annotation', 'warning');
        return;
    }
    
    // Reuse the existing annotation modal functionality
    openAnnotationModal(articleUrl, articleTitle, 'CEO Daily Top-6 Article', 'CEO Daily Selection');
}
// ===== SIGNAL MANAGEMENT FUNCTIONS =====

function showAddSignalModal() {
    const modal = new bootstrap.Modal(document.getElementById('addSignalModal'));
    
    // Clear form
    document.getElementById('signalName').value = '';
    document.getElementById('signalDescription').value = '';
    document.getElementById('signalInstruction').value = '';
    document.getElementById('signalActive').checked = true;
    
    // Pre-select current topic if one is selected
    const currentTopicSelect = document.getElementById('topic-select');
    const signalTopicSelect = document.getElementById('signalTopic');
    if (currentTopicSelect && signalTopicSelect) {
        signalTopicSelect.value = currentTopicSelect.value || '';
    }
    
    modal.show();
}

async function saveSignalInstruction() {
    const name = document.getElementById('signalName').value.trim();
    const description = document.getElementById('signalDescription').value.trim();
    const instruction = document.getElementById('signalInstruction').value.trim();
    const isActive = document.getElementById('signalActive').checked;
    const signalTopic = document.getElementById('signalTopic').value.trim() || null;
    
    if (!name || !instruction) {
        showNotification('Please provide both a name and instruction', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/signal-instructions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                description: description,
                instruction: instruction,
                topic: signalTopic,
                is_active: isActive
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addSignalModal'));
        modal.hide();
        
        // Refresh signal instructions list
        loadSignalInstructions();
        
        // Clear any cached real-time signals since instructions changed
        clearRealTimeSignalsCache();
        
        // Auto-trigger re-analysis if we're currently on the real-time signals tab
        const activeTab = document.querySelector('#insights-nav .nav-link.active');
        if (activeTab && activeTab.id === 'realtime-signals-nav') {
            setTimeout(() => {
                analyzeRealTimeSignals();
            }, 1000); // Small delay to let the UI update
        }
        
        showNotification(`Signal instruction '${name}' saved successfully!`, 'success');
        
    } catch (error) {
        console.error('Error saving signal instruction:', error);
        showNotification(`Failed to save signal instruction: ${error.message}`, 'error');
    }
}

async function loadSignalInstructions() {
    try {
        // Use the signal-specific topic selector instead of main topic
        const signalTopicSelect = document.getElementById('signal-topic-select');
        const signalTopic = signalTopicSelect ? signalTopicSelect.value : null;
        
        const params = new URLSearchParams();
        if (signalTopic) {
            params.append('topic', signalTopic);
        }
        
        const response = await fetch(`/api/signal-instructions?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        const container = document.getElementById('signal-instructions-list');
        
        if (!data.instructions || data.instructions.length === 0) {
            container.innerHTML = `
                <div class="text-center p-3 text-muted">
                    <i class="fas fa-info-circle me-2"></i>No signal instructions yet. Add one to start monitoring.
                </div>
            `;
            return;
        }
        
        // Get alert counts for each instruction
        const alertCounts = {};
        try {
            for (const instruction of data.instructions) {
                const alertParams = new URLSearchParams();
                alertParams.append('instruction_id', instruction.id.toString());
                alertParams.append('acknowledged', 'false');
                alertParams.append('limit', '1000'); // Get all to count
                
                const alertResponse = await fetch(`/api/signal-alerts?${alertParams}`);
                if (alertResponse.ok) {
                    const alertData = await alertResponse.json();
                    alertCounts[instruction.id] = alertData.total || 0;
                } else {
                    alertCounts[instruction.id] = 0;
                }
            }
        } catch (error) {
            console.warn('Error getting alert counts:', error);
        }
        
        let html = '';
        data.instructions.forEach(instruction => {
            const statusBadge = instruction.is_active ? 
                '<span class="badge bg-success">Active</span>' : 
                '<span class="badge bg-secondary">Inactive</span>';
            
            const topicBadge = instruction.topic ? 
                `<span class="badge bg-info">${instruction.topic}</span>` : 
                '<span class="badge bg-light text-dark">Global</span>';
            
            const flaggedCount = alertCounts[instruction.id] || 0;
            const flaggedBadge = flaggedCount > 0 ? 
                `<span class="badge bg-danger" title="${flaggedCount} articles flagged">${flaggedCount}</span>` : 
                '<span class="badge bg-light text-muted">0</span>';
            
            html += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${escapeHTML(instruction.name)} ${statusBadge} ${topicBadge} ${flaggedBadge}</h6>
                                <p class="mb-1 small text-muted">${escapeHTML(instruction.description)}</p>
                                <p class="mb-0 small"><strong>Instruction:</strong> ${escapeHTML(instruction.instruction.substring(0, 100))}${instruction.instruction.length > 100 ? '...' : ''}</p>
                            </div>
                            <div class="btn-group-vertical btn-group-sm ms-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="runSingleSignal(${instruction.id})" title="Run this signal">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteSignalInstruction(${instruction.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading signal instructions:', error);
        const container = document.getElementById('signal-instructions-list');
        container.innerHTML = `<div class="alert alert-danger">Failed to load signal instructions: ${error.message}</div>`;
    }
}

async function deleteSignalInstruction(instructionId) {
    if (!confirm('Are you sure you want to delete this signal instruction?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/signal-instructions/${instructionId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        loadSignalInstructions(); // Refresh list
        
        // Clear any cached real-time signals since instructions changed
        clearRealTimeSignalsCache();
        
        // Auto-trigger re-analysis if we're currently on the real-time signals tab
        const activeTab = document.querySelector('#insights-nav .nav-link.active');
        if (activeTab && activeTab.id === 'realtime-signals-nav') {
            setTimeout(() => {
                analyzeRealTimeSignals();
            }, 1000); // Small delay to let the UI update
        }
        
        showNotification('Signal instruction deleted successfully', 'success');
        
    } catch (error) {
        console.error('Error deleting signal instruction:', error);
        showNotification(`Failed to delete signal instruction: ${error.message}`, 'error');
    }
}

// ===== INCIDENT TRACKING FUNCTIONS =====

async function loadIncidentTracking(topic, startDate, endDate, daysLimit, forceRegenerate = false) {
    const loadingEl = document.getElementById('incident-tracking-loading');
    const errorEl = document.getElementById('incident-tracking-error');
    const containerEl = document.getElementById('incident-tracking-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        if (!topic) {
            errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>Select a topic to track incidents.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Get the selected model from feed configuration
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
        
        // Get the selected organizational profile
        const profileSelect = document.getElementById('profile-select');
        const selectedProfileId = profileSelect && profileSelect.value ? parseInt(profileSelect.value) : null;
        
        // Use passed parameters instead of reading from DOM
        let requestBody = {
            topic: topic,
            max_articles: 100,
            model: selectedModel,
            force_regenerate: forceRegenerate || false
        };
        
        // Add profile_id if selected
        if (selectedProfileId) {
            requestBody.profile_id = selectedProfileId;
            console.log(`Using organizational profile ID: ${selectedProfileId} for incident tracking`);
        }
        
        // Use passed date parameters
        if (startDate && endDate) {
            requestBody.start_date = startDate;
            requestBody.end_date = endDate;
        } else {
            requestBody.days_limit = daysLimit || 14;
        }
        
        const response = await fetch('/api/incident-tracking', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.incidents || data.incidents.length === 0) {
            const message = data.message || 'No incidents found';
            errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>${message}</div>`;
            errorEl.style.display = 'block';
            return;
        }
        
        renderIncidentTracking(data.incidents);
        
    } catch (error) {
        console.error('Error loading incident tracking:', error);
        errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load incident tracking: ${error.message}</div>`;
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function renderIncidentTracking(incidents) {
    const container = document.getElementById('incident-tracking-container');
    container.innerHTML = '';
    // Persist last set
    window._lastIncidents = Array.isArray(incidents) ? incidents.slice() : [];
    
    // Store all incidents for filtering
    allIncidents = Array.isArray(incidents) ? incidents.slice() : [];
    
    // Build filter badges
    buildIncidentFilterBadges(allIncidents);
    
    // Apply current filters
    const filteredIncidents = applyIncidentFilters(allIncidents);
    
    // Toggle to hide implausible/low-quality
    const toggleId = 'incident-hide-low-toggle';
    let hideLow = true;
    try { const saved = localStorage.getItem(toggleId); if (saved !== null) hideLow = saved === 'true'; } catch(_) {}

    const controlsHtml = `
        <div class="form-check form-switch d-flex align-items-center gap-2 m-0" id="incident-controls-switch">
            <input class="form-check-input" type="checkbox" id="${toggleId}" ${hideLow ? 'checked' : ''}>
            <label class="form-check-label small mb-0" for="${toggleId}">Hide implausible or low-quality source incidents</label>
        </div>
    `;
    // Insert controls into top toolbar (preserve existing buttons); fallback into container
    const toolbar = document.getElementById('incident-toolbar-right');
    if (toolbar) {
        // Check if quality controls already exist to avoid duplicates
        if (!toolbar.querySelector(`#${toggleId}`)) {
            // Preserve existing buttons (like Configure) and add quality controls
            toolbar.insertAdjacentHTML('beforeend', controlsHtml);
        }
    } else {
        container.insertAdjacentHTML('afterbegin', `<div class="insight-item-card p-2 mb-2">${controlsHtml}</div>`);
    }
    
    const riskFlags = new Set(['extraordinary_claim','no_independent_verification','low_factuality_source','low_credibility_source','fringe_bias']);
    
    // Apply filter badges first, then quality filter
    let incidentsToRender = filteredIncidents;
    
    // Compute global timeline range for ruler scaling
    let globalMin = null, globalMax = null;
    incidentsToRender.forEach(inc => {
        if (Array.isArray(inc?.timeline) && inc.timeline.length > 0) {
            const first = new Date(inc.timeline[0]).getTime();
            const last = new Date(inc.timeline[inc.timeline.length - 1]).getTime();
            if (!isNaN(first) && !isNaN(last)) {
                globalMin = (globalMin === null) ? first : Math.min(globalMin, first);
                globalMax = (globalMax === null) ? last : Math.max(globalMax, last);
            }
        }
    });
    if (globalMin !== null && globalMax !== null && globalMax < globalMin) {
        const t = globalMin; globalMin = globalMax; globalMax = t;
    }
    
    // Apply quality filter (hide low quality) on top of badge filters
    const filtered = hideLow
        ? incidentsToRender.filter(inc => {
            if (!inc) return false;
            const plaus = String(inc.plausibility || '').toLowerCase();
            const quality = String(inc.source_quality || '').toLowerCase();
            const flags = Array.isArray(inc.misinfo_flags) ? inc.misinfo_flags.map(f => String(f).toLowerCase()) : [];
            const hasLowFlags = flags.some(f => f === 'low_factuality_source' || f === 'low_credibility_source' || f === 'fringe_bias');
            return plaus !== 'implausible' && quality !== 'low' && !hasLowFlags;
        })
        : incidentsToRender;
    
    // Use the new filtered rendering function
    renderIncidentTrackingFiltered(filteredIncidents);
    return;
    
    // Old rendering code below (kept for reference but not executed)
    if (!filtered || filtered.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No incidents found for this period.</div>';
        return;
    }
    
    filtered.forEach((incident, index) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6 col-lg-4';
        const card = document.createElement('div');
        card.className = 'insight-item-card h-100';
        
        // Determine badge color based on type and significance
        const typeBadgeColor = incident.type === 'incident' ? 'danger' : 
                              incident.type === 'entity' ? 'primary' : 'success';
        const significanceBadgeColor = incident.significance === 'high' ? 'danger' : 
                                     incident.significance === 'medium' ? 'warning' : 'secondary';
        const plausibility = String(incident.plausibility || '').toLowerCase();
        const sourceQuality = String(incident.source_quality || '').toLowerCase();
        const plausibilityBadge = plausibility === 'likely' ? 'success' : plausibility === 'questionable' ? 'warning' : 'danger';
        const sourceQualityBadge = sourceQuality === 'high' ? 'success' : sourceQuality === 'mixed' ? 'warning' : 'danger';
        
        // Build timeline section (supports arrays -> start/end badges + mini ruler)
        let timelineSection = '';
        if (Array.isArray(incident.timeline)) {
            const dates = incident.timeline.filter(Boolean);
            if (dates.length > 0) {
                const start = dates[0];
                const end = dates[dates.length - 1];
                // Ruler positions
                let fillHtml = '';
                if (globalMin !== null && globalMax !== null && globalMax !== globalMin) {
                    const s = new Date(start).getTime();
                    const e = new Date(end).getTime();
                    const startPct = Math.max(0, Math.min(100, ((s - globalMin) / (globalMax - globalMin)) * 100));
                    const endPctRaw = Math.max(0, Math.min(100, ((e - globalMin) / (globalMax - globalMin)) * 100));
                    const endPct = Math.max(startPct + 2, endPctRaw); // ensure visible width
                    fillHtml = `
                        <div style="position:relative;height:6px;background:#eef1f5;border-radius:3px;margin-top:2px;">
                            <div style="position:absolute;left:${startPct}%;width:${endPct - startPct}%;height:100%;background:#b6d4fe;border-radius:3px;"></div>
                            <span style="position:absolute;left:${startPct}%;top:-4px;width:8px;height:8px;background:#0d6efd;border-radius:50%;transform:translateX(-50%);"></span>
                            ${end !== start ? `<span style=\"position:absolute;left:${endPct}%;top:-4px;width:8px;height:8px;background:#0d6efd;border-radius:50%;transform:translateX(-50%);\"></span>` : ''}
                        </div>`;
                }
                timelineSection = `
                    <div class="mb-1 small"><strong>Timeline:</strong>
                        <span class="badge bg-light text-dark border me-1" title="Start">${start}</span>
                        ${end !== start ? `<span class=\"badge bg-light text-dark border me-1\" title=\"End\">${end}</span>` : ''}
                        ${fillHtml}
                    </div>
                `;
            }
        } else {
            const timelineText = (typeof incident.timeline === 'string')
                ? incident.timeline
                : (incident.timeline && (incident.timeline.summary || incident.timeline.text))
                    ? (incident.timeline.summary || incident.timeline.text)
                    : '';
            if (timelineText) {
                timelineSection = `<p class="mb-1 small"><strong>Timeline:</strong> ${timelineText}</p>`;
            }
        }
        
        // Build articles list with MBFC quality indicators
        let articlesHtml = '';
        if (incident.article_uris && incident.article_uris.length > 0) {
            articlesHtml = `
                <div class="mt-2">
                    <small class="text-muted fw-bold">Related Articles (${incident.article_uris.length}):</small>
                    <ul class="list-unstyled mt-1 mb-0 small">
                        ${incident.article_uris.slice(0, 5).map(uri => {
                            const article = window.lastArticlesData?.items?.find(a => a.uri === uri);
                            const derivedTitle = (function(u){
                                try {
                                    const url = new URL(u);
                                    const parts = url.pathname.split('/').filter(Boolean);
                                    const last = parts[parts.length - 1] || '';
                                    const cleaned = decodeURIComponent(last.replace(/[-_]/g, ' ')).trim();
                                    if (cleaned && cleaned.length > 3) return cleaned;
                                } catch(_) {}
                                return 'Article';
                            })(uri);
                            const title = article?.title || derivedTitle;
                            
                            // Add MBFC quality indicators for each article
                            let qualityIndicators = '';
                            if (article) {
                                const qualityBadges = [];
                                if (article.factual_reporting) {
                                    const factualClass = getFactualityClass(article.factual_reporting);
                                    qualityBadges.push(`<span class="badge ${factualClass}" style="font-size: 8px;">${article.factual_reporting}</span>`);
                                }
                                if (article.mbfc_credibility_rating) {
                                    const mbfcClass = getMBFCCredibilityClass(article.mbfc_credibility_rating);
                                    qualityBadges.push(`<span class="badge ${mbfcClass}" style="font-size: 8px;">${article.mbfc_credibility_rating}</span>`);
                                }
                                if (qualityBadges.length > 0) {
                                    qualityIndicators = `<br>${qualityBadges.join(' ')}`;
                                }
                            }
                            
                            return `<li class="mb-1">
                                <a href="${uri}" target="_blank" rel="noopener" class="text-decoration-none">${escapeHTML(title)}</a>
                                ${qualityIndicators}
                            </li>`;
                        }).join('')}
                        ${incident.article_uris.length > 5 ? `<li class="text-muted">... and ${incident.article_uris.length - 5} more</li>` : ''}
                    </ul>
                </div>
            `;
        }
        
        // Build investigation leads as clickable Auspex research buttons
        let leadsHtml = '';
        if (incident.investigation_leads && incident.investigation_leads.length > 0) {
            leadsHtml = `
                <div class="mt-2">
                    <small class="text-muted fw-bold">Leads:</small>
                    <div class="d-flex gap-1 flex-wrap mt-1" style="max-width: 100%; overflow: hidden; word-break: break-word;">
                        ${incident.investigation_leads.map(lead => `
                            <button class="btn btn-outline-primary btn-sm"
                                    onclick="launchAuspexResearchFromInsight('${escapeHTML(lead)}', 'investigation_lead')"
                                    title="Launch Auspex research on: ${escapeHTML(lead)}"
                                    style="font-size: 10px; padding: 2px 6px; border-radius: 12px; max-width: 100%; text-overflow: ellipsis; overflow: hidden;">
                                <i class="fas fa-search me-1"></i>${escapeHTML(lead.length > 20 ? lead.substring(0, 20) + '...' : lead)}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Risk warnings and devil's advocate
        const flags = Array.isArray(incident.misinfo_flags) ? incident.misinfo_flags : [];
        const highRisk = flags.filter(f => riskFlags.has(String(f)));
        const prettyFlag = (f) => {
            switch (String(f)) {
                case 'extraordinary_claim': return 'Extraordinary claim';
                case 'no_independent_verification': return 'No independent verification';
                case 'low_factuality_source': return 'Check Source';
                case 'low_credibility_source': return 'Check Source (credibility)';
                case 'fringe_bias': return 'Fringe bias';
                default: return String(f).replace(/_/g, ' ');
            }
        };
        const warningHtml = highRisk.length > 0 ? `
            <div class="alert alert-danger py-1 px-2 small mt-2 mb-1">
                <strong>Potential misinformation risk:</strong> ${highRisk.map(prettyFlag).join(', ')}
            </div>
        ` : '';
        const devilsAdvocate = highRisk.includes('extraordinary_claim') ? "<span class=\"badge bg-danger\" title=\"Devil's advocate smell test\">Hyperbolic Claim</span>" : '';
        const credibilitySummary = incident.credibility_summary ? `<small class="text-muted d-block">${incident.credibility_summary}</small>` : '';

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 ${incident.significance === 'high' ? 'text-danger' : 'text-primary'}">${incident.name}</h6>
                <div class="d-flex flex-wrap gap-1 align-items-center text-end">
                    <span class="badge bg-${typeBadgeColor}" title="Type">${incident.type.toUpperCase()}</span>
                    <span class="badge bg-${significanceBadgeColor}" title="Significance">${incident.significance.toUpperCase()}</span>
                    ${plausibility ? `<span class="badge bg-${plausibilityBadge}" title="Plausibility">Plausibility: ${plausibility.toUpperCase()}</span>` : ''}
                    ${sourceQuality ? `<span class="badge bg-${sourceQualityBadge}" title="Source Quality">Source: ${sourceQuality.toUpperCase()}</span>` : ''}
                    ${devilsAdvocate}
                </div>
            </div>
            <p class="mb-1 small">${incident.description}</p>
            ${incident.organizational_relevance ? `
            <div class="alert alert-info py-2 mb-2">
                <small><strong><i class="fas fa-building me-1"></i>Why This Matters to Your Organization:</strong> ${incident.organizational_relevance}</small>
            </div>` : ''}
            ${timelineSection}
            ${credibilitySummary}
            ${warningHtml}
            ${articlesHtml}
            ${leadsHtml}
            <!-- Detailed Analysis Section (Initially Hidden) -->
            <div class="incident-analysis" id="incident-analysis-${escapeHTML(incident.name).replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-search-plus me-2"></i>Article Analysis
                </h6>
                <div class="analysis-content bg-white p-3 rounded border" id="incident-article-analysis-${escapeHTML(incident.name).replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="analysis-text bg-light p-2 rounded small text-muted">
                        Analysis will be generated when you click "Show Analysis" below.
                    </div>
                </div>
            </div>
            
            <div class="mt-2">
                <!-- Analysis Tools -->
                <div class="mb-2">
                    <small class="text-muted fw-bold d-block mb-1">Analysis</small>
                    <div class="d-flex flex-wrap gap-1">
                        ${incident.article_uris && incident.article_uris.length > 0 ? `
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleIncidentAnalysis('${escapeHTML(incident.name)}', '${incident.article_uris[0]}', this)" title="Show Analysis">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="launchIncidentDeepDive('${escapeHTML(incident.name)}', '${incident.article_uris[0]}')" title="Deep Dive">
                                <i class="fas fa-microscope"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="launchIncidentConsensus('${escapeHTML(incident.name)}', '${incident.article_uris[0]}')" title="Consensus Check">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="launchIncidentAdjacent('${escapeHTML(incident.name)}', '${incident.article_uris[0]}')" title="Adjacent Topics">
                                <i class="fas fa-project-diagram"></i>
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(incident.name)}', 'incident')" title="Investigate">
                                <i class="fas fa-search"></i>
                            </button>
                        `}
                    </div>
                </div>

                <!-- Admin Actions -->
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold d-block mb-1">Actions</small>
                        <div class="d-flex flex-wrap gap-1">
                            ${incident.article_uris && incident.article_uris.length > 0 ? `
                                <button class="btn btn-sm btn-outline-success" onclick="openAnnotationModal('${incident.article_uris[0]}')" title="Annotate">
                                    <i class="fas fa-sticky-note"></i>
                                </button>
                            ` : ''}
                            ${status !== 'seen' ? `
                                <button class="btn btn-sm btn-outline-info" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'seen')" title="Mark as seen">
                                    <i class="fas fa-eye"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'active')" title="Mark as unseen">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                            `}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteIncident('${escapeHTML(incident.name)}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        col.appendChild(card);
        container.appendChild(col);
    });

    // Wire up toggles (moved to after rendering)
    setTimeout(() => {
        // Quality toggle
        const toggleEl = document.getElementById(toggleId);
        if (toggleEl && !toggleEl.dataset.wired) {
            toggleEl.addEventListener('change', () => {
                try { localStorage.setItem(toggleId, toggleEl.checked ? 'true' : 'false'); } catch(_) {}
                // Re-render with current filters
                const filteredIncidents = applyIncidentFilters(allIncidents);
                renderIncidentTrackingFiltered(filteredIncidents);
            });
            toggleEl.dataset.wired = 'true';
        }

    }, 100);
}

// ===== ENHANCED TAB NAVIGATION =====

// Add to existing insights tab navigation handlers:
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    // Add handlers for new tabs
    document.getElementById('incident-tracking-nav')?.addEventListener('click', function() {
        // Don't auto-load - wait for Generate Insights button
        const container = document.getElementById('incident-tracking-container');
        if (container && !container.querySelector('.insight-item-card')) {
            // Show helpful message instead of auto-loading
            container.innerHTML = `
                <div class="text-center p-4 w-100">
                    <i class="fas fa-crosshairs fa-3x text-muted mb-3"></i>
                    <h5>Incident Tracking</h5>
                    <p class="text-muted">Click "Generate Insights" to track specific incidents, entities, and events for threat hunting.</p>
                </div>
            `;
        }
    });

    document.getElementById('realtime-signals-nav')?.addEventListener('click', function() {
        loadSignalInstructions();
    });
});

// ===== ENHANCED GENERATE INSIGHTS FUNCTION =====

async function generateInsights(forceRegenerate = false) {
    console.log('Generate insights button clicked', forceRegenerate ? '(force regenerate)' : '');
    
    const selectedTopic = document.getElementById('topic-select').value.trim();
    if (!selectedTopic) {
        showNotification('Please select a topic to generate insights', 'warning');
        return;
    }
    
    // Get current date range parameters
    const dateRangeValue = document.getElementById('date-range-select').value;
    let startDate = null;
    let endDate = null;
    let daysLimit = 30;
    
    if (dateRangeValue === 'custom') {
        const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
        if (customDate) {
            startDate = customDate;
            endDate = customDate;
        }
    } else if (dateRangeValue !== 'all') {
        // Calculate date range based on selection
        const now = new Date();
        endDate = now.toISOString().split('T')[0];
        
        switch (dateRangeValue) {
            case '24h': daysLimit = 1; break;
            case '7d': daysLimit = 7; break;
            case '30d': daysLimit = 30; break;
            case '3m': daysLimit = 90; break;
            case '1y': daysLimit = 365; break;
        }
        
        const startDateObj = new Date(now.getTime() - daysLimit * 24 * 60 * 60 * 1000);
        startDate = startDateObj.toISOString().split('T')[0];
    }
    
    console.log('Loading insights for topic:', selectedTopic, 'date range:', startDate, 'to', endDate, 'days:', daysLimit);
    
    // Load all insights including incident tracking
    await Promise.all([
        loadArticleInsights(selectedTopic, startDate, endDate, daysLimit, forceRegenerate),
        loadCategoryInsights(selectedTopic, startDate, endDate, daysLimit, forceRegenerate),
        loadIncidentTracking(selectedTopic, startDate, endDate, daysLimit, forceRegenerate)
    ]);
    
    showNotification('Insights generated successfully!', 'success');
}
// Add this function to your JavaScript section:

async function analyzeRealTimeSignals() {
    const loadingEl = document.getElementById('realtime-signals-loading');
    const errorEl = document.getElementById('realtime-signals-error');
    const containerEl = document.getElementById('realtime-signals-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        const topicSelect = document.getElementById('topic-select');
        const selectedTopic = topicSelect ? (topicSelect.value || '').trim() : '';
        if (!selectedTopic) {
            errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>Select a topic to analyze signals.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Get the selected model from feed configuration
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';

        // Build request for signal analysis
        const drSel = document.getElementById('date-range-select');
        const drVal = drSel ? drSel.value : '7d'; // Default to 7 days for signals
        
        let requestBody = {
            topic: selectedTopic,
            max_articles: 50,
            model: selectedModel,
            force_regenerate: true  // Always force regenerate for real-time signals
        };
        
        switch (drVal) {
            case '24h': requestBody.days_limit = 1; break;
            case '7d': requestBody.days_limit = 7; break;
            case '30d': requestBody.days_limit = 30; break;
            case 'custom':
                const customDate = document.getElementById('custom-date-input')?.value || document.getElementById('selected-date')?.value;
                if (customDate) {
                    requestBody.start_date = customDate;
                    requestBody.end_date = customDate;
                } else {
                    requestBody.days_limit = 7;
                }
                break;
            default:
                requestBody.days_limit = 7;
        }
        
        const response = await fetch('/api/real-time-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.signals || data.signals.length === 0) {
            const message = data.message || 'No signals detected';
            errorEl.innerHTML = `<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>${message}</div>`;
            errorEl.style.display = 'block';
            return;
        }
        
        renderRealTimeSignals(data);
        
    } catch (error) {
        console.error('Error analyzing real-time signals:', error);
        errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Failed to analyze signals: ${error.message}</div>`;
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function renderRealTimeSignals(data) {
    const container = document.getElementById('realtime-signals-container');
    container.innerHTML = '';
    
    if (!data.signals || data.signals.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No signals detected for this period.</div>';
        return;
    }
    
    // Add summary header
    const detectedCount = data.signals.filter(s => s.signal_detected).length;
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'alert alert-info mb-3';
    summaryDiv.innerHTML = `
        <h6><i class="fas fa-radar me-2"></i>Signal Analysis Results</h6>
        <p class="mb-1">Analyzed ${data.total_articles} articles with ${data.instructions_used} signal instructions</p>
        <p class="mb-0"><strong>${detectedCount} of ${data.signals.length} signals detected</strong></p>
    `;
    container.appendChild(summaryDiv);
    
    data.signals.forEach((signal, index) => {
        const card = document.createElement('div');
        card.className = 'insight-item-card';
        
        if (signal.signal_detected) {
            card.style.borderLeft = '4px solid #dc3545'; // Red border for detected signals
        }
        
        const threatBadgeColor = signal.threat_level === 'high' ? 'danger' : 
                               signal.threat_level === 'medium' ? 'warning' : 'success';
        
        // Build matching articles list
        let articlesHtml = '';
        if (signal.matching_articles && signal.matching_articles.length > 0) {
            articlesHtml = `
                <div class="mt-2">
                    <small class="text-muted fw-bold">Matching Articles (${signal.matching_articles.length}):</small>
                    <ul class="list-unstyled mt-1 mb-0 small">
                        ${signal.matching_articles.slice(0, 3).map(uri => {
                            const article = window.lastArticlesData?.items?.find(a => a.uri === uri);
                            if (article) {
                                return `<li class="mb-1"><a href="${uri}" target="_blank" rel="noopener">${article.title}</a></li>`;
                            }
                            return `<li class="mb-1"><a href="${uri}" target="_blank" rel="noopener">View Article</a></li>`;
                        }).join('')}
                        ${signal.matching_articles.length > 3 ? `<li class="text-muted">... and ${signal.matching_articles.length - 3} more</li>` : ''}
                    </ul>
                </div>
            `;
        }

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 ${signal.signal_detected ? 'text-danger' : 'text-muted'}">${signal.instruction_name}</h6>
                <div class="d-flex gap-1">
                    ${signal.signal_detected ? '<span class="badge bg-danger">DETECTED</span>' : '<span class="badge bg-secondary">Clear</span>'}
                    <span class="badge bg-${threatBadgeColor}">${signal.threat_level?.toUpperCase() || 'UNKNOWN'}</span>
                    <span class="badge bg-info">${Math.round((signal.confidence || 0) * 100)}%</span>
                </div>
            </div>
            <p class="mb-1 small">${signal.summary || 'No summary available'}</p>
            ${signal.recommended_action ? `<p class="mb-1 small"><strong>Recommended Action:</strong> ${signal.recommended_action}</p>` : ''}
            ${articlesHtml}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(signal.instruction_name)}', 'signal_investigation')">
                    <i class="fas fa-search me-1"></i>Deep Dive
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

// ===== CACHE MANAGEMENT FUNCTIONS =====

function clearRealTimeSignalsCache() {
    // This function clears any cached real-time signals when instructions change
    const container = document.getElementById('realtime-signals-container');
    if (container) {
        container.innerHTML = `
            <div class="text-center p-4 w-100">
                <i class="fas fa-radar fa-3x text-muted mb-3"></i>
                <h5>Real-time Signals</h5>
                <p class="text-muted">Signal instructions updated. Click "Analyze Signals" to run analysis with new instructions.</p>
            </div>
        `;
    }
}

// ===== REAL-TIME SIGNALS ANALYSIS FUNCTIONS =====

async function analyzeRealTimeSignals() {
    const loadingEl = document.getElementById('realtime-signals-loading');
    const errorEl = document.getElementById('realtime-signals-error');
    const containerEl = document.getElementById('realtime-signals-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        const topicSelect = document.getElementById('topic-select');
        const selectedTopic = topicSelect ? (topicSelect.value || '').trim() : '';
        if (!selectedTopic) {
            errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>Select a topic to analyze signals.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Get the selected model from feed configuration
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';

        // Build request for signal analysis
        const drSel = document.getElementById('date-range-select');
        const drVal = drSel ? drSel.value : '7d';
        
        let requestBody = {
            topic: selectedTopic,
            max_articles: 50,
            model: selectedModel
        };
        
        switch (drVal) {
            case '24h': requestBody.days_limit = 1; break;
            case '7d': requestBody.days_limit = 7; break;
            case '30d': requestBody.days_limit = 30; break;
            case 'custom':
                const customDate = document.getElementById('custom-date-input')?.value || document.getElementById('selected-date')?.value;
                if (customDate) {
                    requestBody.start_date = customDate;
                    requestBody.end_date = customDate;
                } else {
                    requestBody.days_limit = 7;
                }
                break;
            default:
                requestBody.days_limit = 7;
        }
        
        const response = await fetch('/api/real-time-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.signals || data.signals.length === 0) {
            const message = data.message || 'No signals detected';
            errorEl.innerHTML = `<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>${message}</div>`;
            errorEl.style.display = 'block';
            return;
        }
        
        renderRealTimeSignals(data);
        
    } catch (error) {
        console.error('Error analyzing real-time signals:', error);
        errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Failed to analyze signals: ${error.message}</div>`;
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function renderRealTimeSignals(data) {
    const container = document.getElementById('realtime-signals-container');
    container.innerHTML = '';
    
    if (!data.signals || data.signals.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No signals detected for this period.</div>';
        return;
    }
    
    // Add summary header
    const detectedCount = data.signals.filter(s => s.signal_detected).length;
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'alert alert-info mb-3';
    summaryDiv.innerHTML = `
        <h6><i class="fas fa-radar me-2"></i>Signal Analysis Results</h6>
        <p class="mb-1">Analyzed ${data.total_articles} articles with ${data.instructions_used} signal instructions</p>
        <p class="mb-0"><strong>${detectedCount} of ${data.signals.length} signals detected</strong></p>
    `;
    container.appendChild(summaryDiv);
    
    data.signals.forEach((signal, index) => {
        const card = document.createElement('div');
        card.className = 'insight-item-card';
        
        if (signal.signal_detected) {
            card.style.borderLeft = '4px solid #dc3545'; // Red border for detected signals
        }
        
        const threatBadgeColor = signal.threat_level === 'high' ? 'danger' : 
                               signal.threat_level === 'medium' ? 'warning' : 'success';
        
        // Build matching articles list
        let articlesHtml = '';
        if (signal.matching_articles && signal.matching_articles.length > 0) {
            articlesHtml = `
                <div class="mt-2">
                    <small class="text-muted fw-bold">Matching Articles (${signal.matching_articles.length}):</small>
                    <ul class="list-unstyled mt-1 mb-0 small">
                        ${signal.matching_articles.slice(0, 3).map(uri => {
                            const article = window.lastArticlesData?.items?.find(a => a.uri === uri);
                            if (article) {
                                return `<li class="mb-1"><a href="${uri}" target="_blank" rel="noopener">${article.title}</a></li>`;
                            }
                            return `<li class="mb-1"><a href="${uri}" target="_blank" rel="noopener">View Article</a></li>`;
                        }).join('')}
                        ${signal.matching_articles.length > 3 ? `<li class="text-muted">... and ${signal.matching_articles.length - 3} more</li>` : ''}
                    </ul>
                </div>
            `;
        }

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 ${signal.signal_detected ? 'text-danger' : 'text-muted'}">${signal.instruction_name}</h6>
                <div class="d-flex gap-1">
                    ${signal.signal_detected ? '<span class="badge bg-danger">DETECTED</span>' : '<span class="badge bg-secondary">Clear</span>'}
                    <span class="badge bg-${threatBadgeColor}">${signal.threat_level?.toUpperCase() || 'UNKNOWN'}</span>
                    <span class="badge bg-info">${Math.round((signal.confidence || 0) * 100)}%</span>
                </div>
            </div>
            <p class="mb-1 small">${signal.summary || 'No summary available'}</p>
            ${signal.recommended_action ? `<p class="mb-1 small"><strong>Recommended Action:</strong> ${signal.recommended_action}</p>` : ''}
            ${articlesHtml}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(signal.instruction_name)}', 'signal_investigation')">
                    <i class="fas fa-search me-1"></i>Deep Dive
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

// ===== SIGNAL FLAGS FOR ARTICLES =====

function addSignalFlagsToArticles(articles) {
    // Add signal flag badges to articles after they're rendered
    articles.forEach(article => {
        const flagsContainer = document.getElementById(`signal-flags-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (flagsContainer && article.tags) {
            let tags = [];
            if (Array.isArray(article.tags)) {
                tags = article.tags;
            } else if (typeof article.tags === 'string') {
                tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            }
            
            const signalTags = tags.filter(tag => tag.startsWith('signal:'));
            if (signalTags.length > 0) {
                const signalBadges = signalTags.map(tag => {
                    const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                    return `<span class="badge bg-danger text-white ms-1" style="font-size: 8px;" title="Flagged by signal: ${escapeHTML(signalName)}"><i class="fas fa-flag me-1"></i>${escapeHTML(signalName)}</span>`;
                }).join('');
                flagsContainer.innerHTML = signalBadges;
            }
        }
    });
}

// ===== SIGNAL TOPIC MANAGEMENT =====

function handleSignalTopicChange() {
    // Reload signal instructions when topic changes
    loadSignalInstructions();
    
    // Update article count for new topic
    updateSignalArticleCount();
    
    // Clear alerts since we're changing topic context
    const container = document.getElementById('signal-alerts-list');
    if (container) {
        container.innerHTML = `
            <div class="text-center p-3 text-muted">
                <i class="fas fa-info-circle me-2"></i>Topic changed. Run signal instructions to generate alerts for this topic.
            </div>
        `;
    }
}

function handleSignalConfigChange() {
    // Update article count when date range changes
    updateSignalArticleCount();
}

async function updateSignalArticleCount() {
    try {
        const signalTopicSelect = document.getElementById('signal-topic-select');
        const signalDaysSelect = document.getElementById('signal-days-select');
        const countBadge = document.getElementById('signal-article-count');
        
        const selectedTopic = signalTopicSelect ? signalTopicSelect.value : null;
        const daysBack = signalDaysSelect ? parseInt(signalDaysSelect.value) : 7;
        
        if (!countBadge) return;
        
        countBadge.textContent = 'loading...';
        
        // Calculate date range
        const endDate = new Date();
        const startDate = new Date(endDate.getTime() - daysBack * 24 * 60 * 60 * 1000);
        
        // Use the debug endpoint to get article count
        const params = new URLSearchParams();
        if (selectedTopic) {
            params.append('topic', selectedTopic);
        }
        
        const response = await fetch(`/api/debug-articles?${params}`);
        if (response.ok) {
            const data = await response.json();
            const totalArticles = data.date_range_info?.total_articles || 0;
            countBadge.textContent = `${totalArticles} articles`;
            countBadge.className = totalArticles > 0 ? 'badge bg-success text-white' : 'badge bg-warning text-dark';
        } else {
            countBadge.textContent = '? articles';
            countBadge.className = 'badge bg-secondary';
        }
        
    } catch (error) {
        console.error('Error updating signal article count:', error);
        const countBadge = document.getElementById('signal-article-count');
        if (countBadge) {
            countBadge.textContent = 'error';
            countBadge.className = 'badge bg-danger';
        }
    }
}

async function loadTopicsForSignals() {
    try {
        const response = await fetch('/api/topics');
        const topics = await response.json();
        
        const signalTopicSelect = document.getElementById('signal-topic-select');
        const signalModalSelect = document.getElementById('signalTopic');
        
        if (signalTopicSelect && topics) {
            const currentValue = signalTopicSelect.value;
            signalTopicSelect.innerHTML = '<option value="">All Topics</option>' + 
                topics.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            signalTopicSelect.value = currentValue; // Restore selection
        }
        
        if (signalModalSelect && topics) {
            const currentValue = signalModalSelect.value;
            signalModalSelect.innerHTML = '<option value="">All Topics (Global Signal)</option>' + 
                topics.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            signalModalSelect.value = currentValue; // Restore selection
        }
        
    } catch (error) {
        console.error('Error loading topics for signals:', error);
    }
}

// ===== INDEPENDENT SIGNAL RUNNER FUNCTIONS =====

async function runSingleSignal(instructionId) {
    // Use the signal topic selector for more targeted analysis
    const signalTopicSelect = document.getElementById('signal-topic-select');
    const selectedTopic = signalTopicSelect ? signalTopicSelect.value : null;
    const signalDaysSelect = document.getElementById('signal-days-select');
    const daysBack = signalDaysSelect ? parseInt(signalDaysSelect.value) : 7;
    const modelSelect = document.getElementById('model-select');
    const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
    
    try {
        showNotification(`Running signal instruction for last ${daysBack} days...`, 'info');
        
        const response = await fetch('/api/run-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                instruction_ids: [instructionId],
                topic: selectedTopic,
                days_back: daysBack,
                max_articles: 100,
                model: selectedModel,
                tag_flagged_articles: true
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`Signal run complete: ${result.total_matches} matches found`, 'success');
            loadSignalAlerts(); // Refresh alerts dashboard
        } else {
            showNotification(`Signal run failed: ${result.message}`, 'warning');
        }
        
    } catch (error) {
        console.error('Error running single signal:', error);
        showNotification(`Failed to run signal: ${error.message}`, 'error');
    }
}

async function runAllSignals() {
    // Use the signal topic selector for more targeted analysis
    const signalTopicSelect = document.getElementById('signal-topic-select');
    const selectedTopic = signalTopicSelect ? signalTopicSelect.value : null;
    const signalDaysSelect = document.getElementById('signal-days-select');
    const daysBack = signalDaysSelect ? parseInt(signalDaysSelect.value) : 7;
    const modelSelect = document.getElementById('model-select');
    const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
    
    try {
        // Get all active instructions first
        const params = new URLSearchParams();
        if (selectedTopic) {
            params.append('topic', selectedTopic);
        }
        params.append('active_only', 'true');
        
        const instructionsResponse = await fetch(`/api/signal-instructions?${params}`);
        if (!instructionsResponse.ok) {
            throw new Error('Failed to get signal instructions');
        }
        
        const instructionsData = await instructionsResponse.json();
        
        if (!instructionsData.instructions || instructionsData.instructions.length === 0) {
            showNotification(`No active signal instructions found for ${selectedTopic || 'all topics'}`, 'warning');
            return;
        }
        
        const instructionIds = instructionsData.instructions.map(inst => inst.id);
        
        showNotification(`Running ${instructionIds.length} signal instructions for last ${daysBack} days...`, 'info');
        
        const response = await fetch('/api/run-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                instruction_ids: instructionIds,
                topic: selectedTopic,
                days_back: daysBack,
                max_articles: 100,
                model: selectedModel,
                tag_flagged_articles: true
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`All signals run complete: ${result.total_matches} total matches found`, 'success');
            loadSignalAlerts(); // Refresh alerts dashboard
        } else {
            showNotification(`Signal run failed: ${result.message}`, 'warning');
        }
        
    } catch (error) {
        console.error('Error running all signals:', error);
        showNotification(`Failed to run signals: ${error.message}`, 'error');
    }
}

// Pagination variables for alerts
let currentAlertsPage = 1;
const alertsPerPage = 10;

// Alert filtering
let alertFilters = {
    instructions: new Set(),
    threatLevels: new Set()
};
let allAlerts = []; // Store all alerts for filtering

// Incident filtering
let incidentFilters = {
    types: new Set(),
    significance: new Set(),
    status: new Set()
};
let allIncidents = []; // Store all incidents for filtering

// Entity grouping function
function groupIncidentsByEntity(incidents) {
    if (!incidents || incidents.length === 0) return [];

    const entityGroups = new Map();

    incidents.forEach(incident => {
        const entityName = extractPrimaryEntity(incident);

        if (!entityGroups.has(entityName)) {
            entityGroups.set(entityName, {
                entityName: entityName,
                incidents: [],
                totalArticles: 0,
                maxSignificance: 'low',
                timelineRange: null
            });
        }

        const group = entityGroups.get(entityName);
        group.incidents.push(incident);

        // Update group metadata
        if (incident.article_uris) {
            group.totalArticles += incident.article_uris.length;
        }

        // Track highest significance
        if (incident.significance === 'high' ||
            (incident.significance === 'medium' && group.maxSignificance === 'low')) {
            group.maxSignificance = incident.significance;
        }

        // Track timeline range
        if (Array.isArray(incident.timeline) && incident.timeline.length > 0) {
            const startDate = new Date(incident.timeline[0]);
            const endDate = new Date(incident.timeline[incident.timeline.length - 1]);

            if (!group.timelineRange) {
                group.timelineRange = { start: startDate, end: endDate };
            } else {
                if (startDate < group.timelineRange.start) group.timelineRange.start = startDate;
                if (endDate > group.timelineRange.end) group.timelineRange.end = endDate;
            }
        }
    });

    // Convert to array and sort by significance and incident count
    return Array.from(entityGroups.values()).sort((a, b) => {
        // Sort by significance first
        const sigOrder = { 'high': 3, 'medium': 2, 'low': 1 };
        const sigDiff = sigOrder[b.maxSignificance] - sigOrder[a.maxSignificance];
        if (sigDiff !== 0) return sigDiff;

        // Then by number of incidents
        return b.incidents.length - a.incidents.length;
    });
}

function extractPrimaryEntity(incident) {
    if (!incident) return 'Unknown Entity';

    // Try to extract from related_entities first
    if (Array.isArray(incident.related_entities) && incident.related_entities.length > 0) {
        console.log('Entity from related_entities:', incident.related_entities[0]);
        return incident.related_entities[0];
    }

    // Extract from incident name using common patterns
    const name = incident.name || '';
    console.log('Extracting entity from name:', name);

    // Enhanced entity patterns to extract - more comprehensive
    const entityPatterns = [
        /(Tesla|OpenAI|Microsoft|Google|Amazon|Apple|Meta|Netflix|Uber|SpaceX|Elon\s+Musk|ChatGPT|X\.com)/i,  // Known entities - expanded
        /^([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:launches|announces|reports|develops|releases|faces|customers|caught|fires?|sues?|delivers?)/i,  // Company action patterns
        /([A-Z][A-Za-z]+)(?:'s|\s+(?:CEO|CFO|CTO|executives?|shareholders?|Megapacks?))/i,  // Possessive or related patterns
        /^([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+/,  // Any capitalized words at start
    ];

    for (const pattern of entityPatterns) {
        const match = name.match(pattern);
        if (match && match[1]) {
            const entity = match[1].trim();
            console.log('Extracted entity:', entity, 'from pattern:', pattern);
            return entity;
        }
    }

    // Fallback: use first significant word that looks like a company name
    const words = name.split(/\s+/).filter(word =>
        word.length > 2 &&
        word[0] === word[0].toUpperCase() &&
        !['The', 'And', 'For', 'With', 'From', 'Two', 'Three'].includes(word)
    );

    const entity = words[0] || 'Other';
    console.log('Fallback entity:', entity, 'from words:', words);
    return entity;
}

async function loadSignalAlerts(page = 1) {
    currentAlertsPage = page;
    
    try {
        const params = new URLSearchParams();
        // Don't filter by topic for now to see all alerts
        params.append('acknowledged', 'false'); // Show unacknowledged alerts by default
        params.append('limit', '50'); // Reasonable limit
        
        console.log('Loading signal alerts with params:', params.toString());
        
        const response = await fetch(`/api/signal-alerts?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Signal alerts response:', data);
        
        const container = document.getElementById('signal-alerts-list');
        
        console.log('Alerts data structure:', data);
        console.log('Alerts array:', data.alerts);
        console.log('Alerts length:', data.alerts ? data.alerts.length : 'undefined');
        
        if (!data.alerts || data.alerts.length === 0) {
            console.log('No alerts found - showing empty message');
            container.innerHTML = `
                <div class="text-center p-3 text-muted">
                    <i class="fas fa-info-circle me-2"></i>No unacknowledged alerts. Run signal instructions to generate alerts.
                    <br><small>Debug: API returned ${data.total || 0} alerts</small>
                </div>
            `;
            // Hide filter section when no alerts
            document.getElementById('signal-alert-filters').style.display = 'none';
            return;
        }
        
        // Store all alerts for filtering
        allAlerts = data.alerts;
        
        // Build filter badges
        buildAlertFilterBadges(data.alerts);
        
        // Apply current filters
        const filteredAlerts = applyAlertFilters(data.alerts);
        
        console.log('Rendering', filteredAlerts.length, 'filtered alerts out of', data.alerts.length, 'total');
        
        // Implement pagination on filtered alerts
        const totalAlerts = filteredAlerts.length;
        const totalPages = Math.ceil(totalAlerts / alertsPerPage);
        const start = (currentAlertsPage - 1) * alertsPerPage;
        const end = start + alertsPerPage;
        const pageAlerts = filteredAlerts.slice(start, end);
        
        // Update pagination info
        document.getElementById('alerts-start').textContent = totalAlerts > 0 ? start + 1 : 0;
        document.getElementById('alerts-end').textContent = Math.min(end, totalAlerts);
        document.getElementById('alerts-total').textContent = totalAlerts;
        document.getElementById('current-alerts-page').textContent = currentAlertsPage;
        document.getElementById('total-alerts-pages').textContent = totalPages;
        
        // Update button states
        document.getElementById('prev-alerts-btn').disabled = currentAlertsPage <= 1;
        document.getElementById('next-alerts-btn').disabled = currentAlertsPage >= totalPages;
        
        // Show/hide pagination
        const paginationContainer = document.getElementById('signal-alerts-pagination');
        if (paginationContainer) {
            paginationContainer.style.display = totalAlerts > alertsPerPage ? 'flex' : 'none';
        }
        
        let html = '';
        pageAlerts.forEach(alert => {
            const threatBadgeColor = alert.threat_level === 'high' ? 'danger' : 
                                   alert.threat_level === 'medium' ? 'warning' : 'success';
            
            const detectedTime = new Date(alert.detected_at).toLocaleString();
            
            html += `
                <div class="card mb-2 ${alert.threat_level === 'high' ? 'border-danger' : ''}">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <h6 class="mb-0 me-2">${escapeHTML(alert.instruction_name)}</h6>
                                    <span class="badge bg-${threatBadgeColor}">${alert.threat_level.toUpperCase()}</span>
                                    <span class="badge bg-info ms-1">${Math.round(alert.confidence * 100)}%</span>
                                </div>
                                <p class="mb-1 small">${escapeHTML(alert.summary)}</p>
                                <div class="small text-muted">
                                    <strong>Article:</strong> 
                                    <a href="${alert.article_uri}" target="_blank" rel="noopener">
                                        ${(() => { try { if (alert.article_title) return escapeHTML(alert.article_title); const u = new URL(alert.article_uri); const last = decodeURIComponent((u.pathname.split('/').filter(Boolean).pop()||'').replace(/[-_]/g,' ')).trim(); return escapeHTML(last || 'Article'); } catch(_) { return 'Article'; } })()}
                                    </a>
                                    <span class="ms-2">• ${formatSource(alert.article_source, alert.article_uri)}</span>
                                    <span class="ms-2">• ${detectedTime}</span>
                                </div>
                            </div>
                            <div class="btn-group-vertical btn-group-sm ms-2">
                                <button class="btn btn-outline-success btn-sm" onclick="acknowledgeAlert(${alert.id})" title="Acknowledge">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading signal alerts:', error);
        const container = document.getElementById('signal-alerts-list');
        container.innerHTML = `<div class="alert alert-danger">Failed to load signal alerts: ${error.message}</div>`;
    }
}

async function acknowledgeAlert(alertId) {
    try {
        const response = await fetch(`/api/acknowledge-alert/${alertId}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        loadSignalAlerts(); // Refresh alerts
        showNotification('Alert acknowledged', 'success');
        
    } catch (error) {
        console.error('Error acknowledging alert:', error);
        showNotification(`Failed to acknowledge alert: ${error.message}`, 'error');
    }
}

async function acknowledgeAllAlerts() {
    if (!confirm('Mark all alerts as acknowledged?')) {
        return;
    }
    
    try {
        // Get current alerts and acknowledge each one
        const topicSelect = document.getElementById('topic-select');
        const currentTopic = topicSelect ? topicSelect.value : null;
        
        const params = new URLSearchParams();
        if (currentTopic) {
            params.append('topic', currentTopic);
        }
        params.append('acknowledged', 'false');
        
        const alertsResponse = await fetch(`/api/signal-alerts?${params}`);
        if (!alertsResponse.ok) {
            throw new Error('Failed to get alerts');
        }
        
        const alertsData = await alertsResponse.json();
        
        if (alertsData.alerts && alertsData.alerts.length > 0) {
            // Acknowledge each alert
            const acknowledgePromises = alertsData.alerts.map(alert => 
                fetch(`/api/acknowledge-alert/${alert.id}`, { method: 'POST' })
            );
            
            await Promise.all(acknowledgePromises);
            
            loadSignalAlerts(); // Refresh alerts
            showNotification(`${alertsData.alerts.length} alerts acknowledged`, 'success');
        } else {
            showNotification('No alerts to acknowledge', 'info');
        }
        
    } catch (error) {
        console.error('Error acknowledging all alerts:', error);
        showNotification(`Failed to acknowledge alerts: ${error.message}`, 'error');
    }
}

function previousAlertsPage() {
    if (currentAlertsPage > 1) {
        loadSignalAlerts(currentAlertsPage - 1);
    }
}

function nextAlertsPage() {
    const totalPages = Math.ceil(document.getElementById('alerts-total').textContent / alertsPerPage);
    if (currentAlertsPage < totalPages) {
        loadSignalAlerts(currentAlertsPage + 1);
    }
}

// Alert filter functions
function buildAlertFilterBadges(alerts) {
    // Collect unique values
    const instructionNames = new Set();
    const threatLevels = new Set();
    
    alerts.forEach(alert => {
        if (alert.instruction_name) instructionNames.add(alert.instruction_name);
        if (alert.threat_level) threatLevels.add(alert.threat_level);
    });
    
    // Build instruction filter badges
    const instructionContainer = document.getElementById('instruction-filters');
    instructionContainer.innerHTML = '';
    instructionNames.forEach(instruction => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm btn-outline-primary filter-badge ${alertFilters.instructions.has(instruction) ? 'active' : ''}`;
        badge.textContent = instruction;
        badge.onclick = () => toggleAlertFilter('instructions', instruction);
        instructionContainer.appendChild(badge);
    });
    
    // Build threat level filter badges
    const threatContainer = document.getElementById('threat-level-filters');
    threatContainer.innerHTML = '';
    threatLevels.forEach(level => {
        const badge = document.createElement('button');
        const levelColor = level === 'high' ? 'btn-outline-danger' : 
                          level === 'medium' ? 'btn-outline-warning' : 'btn-outline-success';
        badge.className = `btn btn-sm ${levelColor} filter-badge ${alertFilters.threatLevels.has(level) ? 'active' : ''}`;
        badge.textContent = level.toUpperCase();
        badge.onclick = () => toggleAlertFilter('threatLevels', level);
        threatContainer.appendChild(badge);
    });
    
    // Show filter section if we have filters
    if (instructionNames.size > 0 || threatLevels.size > 0) {
        document.getElementById('signal-alert-filters').style.display = 'block';
    }
}

function toggleAlertFilter(filterType, value) {
    if (alertFilters[filterType].has(value)) {
        alertFilters[filterType].delete(value);
    } else {
        alertFilters[filterType].add(value);
    }
    
    // Re-render alerts with new filters
    if (allAlerts.length > 0) {
        const filteredAlerts = applyAlertFilters(allAlerts);
        renderFilteredAlerts(filteredAlerts);
        
        // Update badge styling
        buildAlertFilterBadges(allAlerts);
    }
}

function applyAlertFilters(alerts) {
    return alerts.filter(alert => {
        // Check instruction filter
        if (alertFilters.instructions.size > 0 && !alertFilters.instructions.has(alert.instruction_name)) {
            return false;
        }
        
        // Check threat level filter
        if (alertFilters.threatLevels.size > 0 && !alertFilters.threatLevels.has(alert.threat_level)) {
            return false;
        }
        
        return true;
    });
}

function renderFilteredAlerts(filteredAlerts) {
    // Reset pagination to page 1 when filtering
    currentAlertsPage = 1;
    
    const totalAlerts = filteredAlerts.length;
    const totalPages = Math.ceil(totalAlerts / alertsPerPage);
    const start = (currentAlertsPage - 1) * alertsPerPage;
    const end = start + alertsPerPage;
    const pageAlerts = filteredAlerts.slice(start, end);
    
    // Update pagination info
    document.getElementById('alerts-start').textContent = totalAlerts > 0 ? start + 1 : 0;
    document.getElementById('alerts-end').textContent = Math.min(end, totalAlerts);
    document.getElementById('alerts-total').textContent = totalAlerts;
    document.getElementById('current-alerts-page').textContent = currentAlertsPage;
    document.getElementById('total-alerts-pages').textContent = Math.max(1, totalPages);
    
    // Update pagination buttons
    document.getElementById('prev-alerts-btn').disabled = currentAlertsPage <= 1;
    document.getElementById('next-alerts-btn').disabled = currentAlertsPage >= totalPages;
    
    // Show/hide pagination
    const paginationEl = document.getElementById('signal-alerts-pagination');
    if (totalAlerts > alertsPerPage) {
        paginationEl.style.display = 'flex';
    } else {
        paginationEl.style.display = 'none';
    }
    
    // Render alerts
    const container = document.getElementById('signal-alerts-list');
    if (totalAlerts === 0) {
        container.innerHTML = `
            <div class="text-center p-3 text-muted">
                <i class="fas fa-filter me-2"></i>No alerts match the current filters.
                <br><small>Try clearing some filters to see more results.</small>
            </div>
        `;
        return;
    }
    
    let html = '';
    pageAlerts.forEach(alert => {
        const threatBadgeColor = alert.threat_level === 'high' ? 'danger' : 
                               alert.threat_level === 'medium' ? 'warning' : 'success';
        
        const detectedTime = new Date(alert.detected_at).toLocaleString();
        
        html += `
            <div class="card mb-2 ${alert.threat_level === 'high' ? 'border-danger' : ''}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <h6 class="mb-0 me-2">${escapeHTML(alert.instruction_name)}</h6>
                                <span class="badge bg-${threatBadgeColor}">${alert.threat_level.toUpperCase()}</span>
                                <span class="badge bg-info ms-1">${Math.round(alert.confidence * 100)}%</span>
                            </div>
                            <p class="mb-1 small">${escapeHTML(alert.summary)}</p>
                            <div class="small text-muted">
                                <strong>Article:</strong> 
                                <a href="${alert.article_uri}" target="_blank" rel="noopener">
                                    ${(() => { try { if (alert.article_title) return escapeHTML(alert.article_title); const u = new URL(alert.article_uri); const last = decodeURIComponent((u.pathname.split('/').filter(Boolean).pop()||'').replace(/[-_]/g,' ')).trim(); return escapeHTML(last || 'Article'); } catch(_) { return 'Article'; } })()}
                                </a>
                                <span class="ms-2">• ${formatSource(alert.article_source, alert.article_uri)}</span>
                                <span class="ms-2">• ${detectedTime}</span>
                            </div>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-2">
                            <button class="btn btn-outline-success btn-sm" onclick="acknowledgeAlert(${alert.id})" title="Acknowledge">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function clearAlertFilters() {
    alertFilters.instructions.clear();
    alertFilters.threatLevels.clear();
    
    if (allAlerts.length > 0) {
        buildAlertFilterBadges(allAlerts);
        renderFilteredAlerts(allAlerts);
    }
}

// Incident filter functions
function buildIncidentFilterBadges(incidents) {
    // Collect unique values
    const types = new Set();
    const significanceLevels = new Set();
    const statusLevels = new Set();
    
    incidents.forEach(incident => {
        if (incident.type) types.add(incident.type);
        if (incident.significance) significanceLevels.add(incident.significance);
        const status = incident.status || 'active';
        statusLevels.add(status);
    });
    
    // Build type filter badges
    const typeContainer = document.getElementById('incident-type-filters');
    typeContainer.innerHTML = '';
    types.forEach(type => {
        const badge = document.createElement('button');
        const typeColor = type === 'incident' ? 'btn-outline-danger' : 
                         type === 'entity' ? 'btn-outline-primary' : 'btn-outline-success';
        badge.className = `btn btn-sm ${typeColor} filter-badge ${incidentFilters.types.has(type) ? 'active' : ''}`;
        badge.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        badge.onclick = () => toggleIncidentFilter('types', type);
        typeContainer.appendChild(badge);
    });
    
    // Build significance filter badges in correct order: low, medium, high
    const significanceContainer = document.getElementById('incident-significance-filters');
    significanceContainer.innerHTML = '';
    const orderedSignificance = ['low', 'medium', 'high'].filter(sig => significanceLevels.has(sig));
    orderedSignificance.forEach(significance => {
        const badge = document.createElement('button');
        const sigColor = significance === 'high' ? 'btn-outline-danger' : 
                        significance === 'medium' ? 'btn-outline-warning' : 'btn-outline-info';
        badge.className = `btn btn-sm ${sigColor} filter-badge ${incidentFilters.significance.has(significance) ? 'active' : ''}`;
        badge.textContent = significance.charAt(0).toUpperCase() + significance.slice(1);
        badge.onclick = () => toggleIncidentFilter('significance', significance);
        significanceContainer.appendChild(badge);
    });
    
    // Build status filter badges
    const statusContainer = document.getElementById('incident-status-filters');
    statusContainer.innerHTML = '';
    const orderedStatus = ['active', 'seen'].filter(status => statusLevels.has(status));
    orderedStatus.forEach(status => {
        const badge = document.createElement('button');
        const statusColor = status === 'seen' ? 'btn-outline-secondary' : 'btn-outline-success';
        const statusIcon = status === 'seen' ? 'fas fa-eye' : 'fas fa-circle';
        badge.className = `btn btn-sm ${statusColor} filter-badge ${incidentFilters.status.has(status) ? 'active' : ''}`;
        badge.innerHTML = `<i class="${statusIcon} me-1"></i>${status.charAt(0).toUpperCase() + status.slice(1)}`;
        badge.onclick = () => toggleIncidentFilter('status', status);
        statusContainer.appendChild(badge);
    });
    
    // Show filter section if we have filters
    if (types.size > 0 || significanceLevels.size > 0 || statusLevels.size > 0) {
        document.getElementById('incident-filters').style.display = 'block';
    }
}

function toggleIncidentFilter(filterType, value) {
    if (incidentFilters[filterType].has(value)) {
        incidentFilters[filterType].delete(value);
    } else {
        incidentFilters[filterType].add(value);
    }
    
    // Re-render incidents with new filters
    if (allIncidents.length > 0) {
        const filteredIncidents = applyIncidentFilters(allIncidents);
        renderIncidentTrackingFiltered(filteredIncidents);
        
        // Update badge styling
        buildIncidentFilterBadges(allIncidents);
    }
}

function applyIncidentFilters(incidents) {
    console.log('Applying incident filters:', {
        types: Array.from(incidentFilters.types),
        significance: Array.from(incidentFilters.significance),
        totalIncidents: incidents.length
    });
    
    const filtered = incidents.filter(incident => {
        // Check type filter - ensure exact match
        if (incidentFilters.types.size > 0) {
            const incidentType = String(incident.type || '').toLowerCase().trim();
            const hasTypeMatch = Array.from(incidentFilters.types).some(filterType => 
                String(filterType).toLowerCase().trim() === incidentType
            );
            if (!hasTypeMatch) {
                console.log('Filtered out by type:', incident.name, 'type:', incident.type, 'expected:', Array.from(incidentFilters.types));
                return false;
            }
        }
        
        // Check significance filter - ensure exact match
        if (incidentFilters.significance.size > 0) {
            const incidentSignificance = String(incident.significance || '').toLowerCase().trim();
            const hasSignificanceMatch = Array.from(incidentFilters.significance).some(filterSig => 
                String(filterSig).toLowerCase().trim() === incidentSignificance
            );
            if (!hasSignificanceMatch) {
                console.log('Filtered out by significance:', incident.name, 'significance:', incident.significance, 'expected:', Array.from(incidentFilters.significance));
                return false;
            }
        }
        
        // Check status filter - ensure exact match
        if (incidentFilters.status.size > 0) {
            const incidentStatus = String(incident.status || 'active').toLowerCase().trim();
            const hasStatusMatch = Array.from(incidentFilters.status).some(filterStatus => 
                String(filterStatus).toLowerCase().trim() === incidentStatus
            );
            if (!hasStatusMatch) {
                console.log('Filtered out by status:', incident.name, 'status:', incident.status, 'expected:', Array.from(incidentFilters.status));
                return false;
            }
        }
        
        return true;
    });
    
    console.log('Filtered incidents:', filtered.length, 'out of', incidents.length);
    return filtered;
}

function renderIncidentTrackingFiltered(filteredIncidents) {
    const container = document.getElementById('incident-tracking-container');
    
    // Clear container but preserve controls
    const existingControls = container.querySelector('.insight-item-card');
    container.innerHTML = '';
    if (existingControls) {
        container.appendChild(existingControls);
    }
    
    // Get quality toggle state
    const toggleId = 'incident-hide-low-toggle';
    let hideLow = true;
    try { 
        const saved = localStorage.getItem(toggleId); 
        if (saved !== null) hideLow = saved === 'true'; 
    } catch(_) {}
    
    // Apply quality filter on top of badge filters
    const riskFlags = new Set(['extraordinary_claim','no_independent_verification','low_factuality_source','low_credibility_source','fringe_bias']);
    const qualityFiltered = hideLow
        ? filteredIncidents.filter(inc => {
            if (!inc) return false;
            const plaus = String(inc.plausibility || '').toLowerCase();
            const quality = String(inc.source_quality || '').toLowerCase();
            const flags = Array.isArray(inc.misinfo_flags) ? inc.misinfo_flags.map(f => String(f).toLowerCase()) : [];
            const hasLowFlags = flags.some(f => f === 'low_factuality_source' || f === 'low_credibility_source' || f === 'fringe_bias');
            return plaus !== 'implausible' && quality !== 'low' && !hasLowFlags;
        })
        : filteredIncidents;
    
    // Apply sorting
    const finalFiltered = sortIncidents([...qualityFiltered]);

    if (!finalFiltered || finalFiltered.length === 0) {
        const message = filteredIncidents.length === 0 ?
            'No incidents match the current filters.' :
            'No high-quality incidents match the current filters.';
        container.insertAdjacentHTML('beforeend', `<div class="text-muted p-2 small w-100 text-center">${message}</div>`);
        return;
    }

    // Render based on current view
    if (currentIncidentView === 'table') {
        renderIncidentTable(finalFiltered);
        return;
    }
    
    // Compute global timeline range for ruler scaling
    let globalMin = null, globalMax = null;
    finalFiltered.forEach(inc => {
        if (Array.isArray(inc?.timeline) && inc.timeline.length > 0) {
            const first = new Date(inc.timeline[0]).getTime();
            const last = new Date(inc.timeline[inc.timeline.length - 1]).getTime();
            if (!isNaN(first) && !isNaN(last)) {
                globalMin = (globalMin === null) ? first : Math.min(globalMin, first);
                globalMax = (globalMax === null) ? last : Math.max(globalMax, last);
            }
        }
    });
    if (globalMin !== null && globalMax !== null && globalMax < globalMin) {
        const t = globalMin; globalMin = globalMax; globalMax = t;
    }

    // Render individual incident cards (card view)
    finalFiltered.forEach((incident, index) => {
        const incidentCard = createIndividualIncidentCard(incident, globalMin, globalMax);
        container.appendChild(incidentCard);
    });
}

function createIndividualIncidentCard(incident, globalMin, globalMax) {
    const col = document.createElement('div');
    col.className = 'col-12 col-md-6 col-lg-4';
    const card = document.createElement('div');
    card.className = 'insight-item-card h-100';
        
        // Check for low quality and add visual indicator
        let isLowQuality = false;
        if (incident.article_uris && incident.article_uris.length > 0) {
            const firstUri = incident.article_uris[0];
            const article = window.lastArticlesData?.items?.find(a => a.uri === firstUri);
            if (article) {
                const factual = (article.factual_reporting || '').toLowerCase();
                const mbfc = (article.mbfc_credibility_rating || '').toLowerCase();
                const bias = (article.bias || '').toLowerCase();
                
                isLowQuality = factual.includes('low') || factual.includes('mixed') ||
                              mbfc.includes('low') || mbfc.includes('mixed') ||
                              bias.includes('extreme') || bias.includes('conspiracy') || bias.includes('fringe');
            }
        }
        
        // Also check AI-derived quality
        if (!isLowQuality) {
            const sourceQuality = String(incident.source_quality || '').toLowerCase();
            const plausibility = String(incident.plausibility || '').toLowerCase();
            isLowQuality = sourceQuality === 'low' || plausibility === 'implausible' ||
                          (Array.isArray(incident.misinfo_flags) && incident.misinfo_flags.some(f => 
                              f.includes('low_factuality') || f.includes('low_credibility') || f.includes('fringe_bias')));
        }
        
        // Add border styling for low quality incidents
        if (isLowQuality) {
            card.style.borderLeft = '4px solid #dc3545';
            card.style.backgroundColor = '#fff5f5';
        }
        
        // Determine badge color based on type and significance (updated for 7-type system)
        const typeBadgeColor = incident.type === 'incident' ? 'danger' : 
                              incident.type === 'entity' ? 'primary' : 
                              incident.type === 'expertise' ? 'warning' :
                              incident.type === 'informed_insider' ? 'dark' :
                              incident.type === 'trend_signal' ? 'info' :
                              incident.type === 'strategic_shift' ? 'secondary' : 'success';
        const significanceBadgeColor = incident.significance === 'high' ? 'danger' : 
                                     incident.significance === 'medium' ? 'warning' : 'info';
        
        // Build investigation leads HTML (clickable buttons)
        let leadsHtml = '';
        if (Array.isArray(incident.investigation_leads) && incident.investigation_leads.length > 0) {
            leadsHtml = `
                <div class="mt-2 mb-2">
                    <small class="text-muted fw-bold">Leads:</small>
                    <div class="d-flex gap-1 flex-wrap mt-1" style="max-width: 100%; overflow: hidden; word-break: break-word;">
                        ${incident.investigation_leads.map(lead => `
                            <button class="btn btn-outline-primary btn-sm"
                                    onclick="launchAuspexResearchFromInsight('${escapeHTML(lead)}', 'investigation_lead')"
                                    title="Launch Auspex research on: ${escapeHTML(lead)}"
                                    style="font-size: 10px; padding: 2px 6px; border-radius: 12px; max-width: 100%; text-overflow: ellipsis; overflow: hidden;">
                                <i class="fas fa-search me-1"></i>${escapeHTML(lead.length > 20 ? lead.substring(0, 20) + '...' : lead)}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Build timeline visualization
        let timelineHtml = '';
        if (Array.isArray(incident.timeline) && incident.timeline.length > 0) {
            const events = incident.timeline.map(t => new Date(t).getTime()).filter(t => !isNaN(t)).sort((a,b) => a - b);
            if (events.length > 0) {
                if (events.length === 1) {
                    // Single date - show as badge
                    timelineHtml = `
                        <div class="mt-2 mb-2">
                            <small class="text-muted fw-bold">Date:</small>
                            <span class="badge bg-primary ms-2">${new Date(events[0]).toLocaleDateString()}</span>
                        </div>
                    `;
                } else if (globalMin !== null && globalMax !== null) {
                    // Multiple dates - show timeline ruler
                    const range = Math.max(1, globalMax - globalMin);
                    const positions = events.map(t => Math.max(0, Math.min(100, ((t - globalMin) / range) * 100)));
                    timelineHtml = `
                        <div class="mt-2 mb-2">
                            <small class="text-muted fw-bold">Timeline:</small>
                            <div class="timeline-ruler" style="position: relative; height: 8px; background: #e9ecef; border-radius: 4px; margin-top: 4px;">
                                ${positions.map(pos => `<div style="position: absolute; left: ${pos}%; width: 3px; height: 8px; background: #007bff; border-radius: 1px;"></div>`).join('')}
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">${new Date(events[0]).toLocaleDateString()}</small>
                                <small class="text-muted">${new Date(events[events.length - 1]).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Determine status styling
        const status = incident.status || 'active';
        const statusBadgeColor = status === 'seen' ? 'secondary' : 'success';
        const cardOpacity = status === 'seen' ? 'opacity-75' : '';
        
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="d-flex align-items-center gap-2">
                    <h6 class="mb-0">${escapeHTML(incident.name || 'Unnamed Incident')}</h6>
                    ${status === 'seen' ? `<span class="badge bg-${statusBadgeColor}"><i class="fas fa-eye me-1"></i>Seen</span>` : ''}
                </div>
                <div class="d-flex gap-1">
                    <span class="badge bg-${typeBadgeColor}">${incident.type || 'Unknown'}</span>
                    <span class="badge bg-${significanceBadgeColor}">${incident.significance || 'Unknown'}</span>
                </div>
            </div>
            <p class="mb-2 small">${escapeHTML(incident.description || 'No description available.')}</p>
            ${incident.organizational_relevance ? `
            <div class="alert alert-info py-2 mb-2">
                <small><strong><i class="fas fa-building me-1"></i>Why This Matters:</strong> ${escapeHTML(incident.organizational_relevance)}</small>
            </div>` : ''}
            ${incident.credibility_summary ? `
            <div class="mt-2 mb-2 p-2 bg-light rounded">
                <small class="text-muted fw-bold">Credibility Assessment:</small>
                <p class="small text-secondary mb-0">${escapeHTML(incident.credibility_summary)}</p>
            </div>` : ''}
            ${timelineHtml}
            ${incident.article_uris && incident.article_uris.length > 0 ? `
            <div class="mt-2 mb-2">
                <small class="text-muted fw-bold">Source Articles (${incident.article_uris.length}):</small>
                <ul class="list-unstyled mt-1 mb-0 small">
                    ${incident.article_uris.slice(0, 3).map(uri => {
                        const article = window.lastArticlesData?.items?.find(a => a.uri === uri);
                        
                        // Extract title from URI if article not found in current dataset
                        let title = 'View Article';
                        let source = 'Unknown Source';
                        let hasMBFC = false;
                        
                        if (article) {
                            title = article.title || 'Untitled Article';
                            source = article.news_source || 'Unknown Source';
                            hasMBFC = !!(article.factual_reporting || article.mbfc_credibility_rating || article.bias);
                        } else {
                            // Try to extract meaningful title from URI
                            try {
                                const url = new URL(uri);
                                const pathParts = url.pathname.split('/').filter(Boolean);
                                const lastPart = pathParts[pathParts.length - 1] || '';
                                const cleaned = decodeURIComponent(lastPart.replace(/[-_]/g, ' ')).trim();
                                if (cleaned && cleaned.length > 5) {
                                    title = cleaned.substring(0, 50) + (cleaned.length > 50 ? '...' : '');
                                }
                                source = url.hostname.replace(/^www\./, '');
                            } catch (e) {
                                console.warn('Could not parse URI for title:', uri);
                            }
                        }
                        
                        // Add MBFC quality indicators or AI-derived flag
                        let qualityBadges = '';
                        if (article && hasMBFC) {
                            const badges = [];
                            if (article.factual_reporting) {
                                badges.push(`<span class="badge ${getFactualityClass(article.factual_reporting)}" style="font-size: 8px;" title="MBFC Factual Reporting">${article.factual_reporting}</span>`);
                            }
                            if (article.mbfc_credibility_rating) {
                                badges.push(`<span class="badge ${getMBFCCredibilityClass(article.mbfc_credibility_rating)}" style="font-size: 8px;" title="MBFC Credibility Rating">${article.mbfc_credibility_rating}</span>`);
                            }
                            if (article.bias) {
                                badges.push(`<span class="badge ${getBiasClass(article.bias)}" style="font-size: 8px;" title="MBFC Bias Rating">${article.bias}</span>`);
                            }
                            if (badges.length > 0) {
                                qualityBadges = `<br>${badges.join(' ')}`;
                            }
                        } else {
                            // Flag when MBFC is missing and AI is rating
                            qualityBadges = `<br><span class="badge bg-warning text-dark" style="font-size: 8px;" title="No MBFC data available - quality assessment by AI">📊 AI-Rated</span>`;
                        }
                        
                        return `<li class="mb-1">
                            <a href="${uri}" target="_blank" rel="noopener" class="text-decoration-none">${escapeHTML(title)}</a>
                            <small class="text-muted d-block">${escapeHTML(source)}</small>
                            ${qualityBadges}
                        </li>`;
                    }).join('')}
                    ${incident.article_uris.length > 3 ? `<li class="text-muted small">... and ${incident.article_uris.length - 3} more articles</li>` : ''}
                </ul>
            </div>` : ''}
            ${leadsHtml}
            <div class="mt-2">
                <!-- Analysis Tools -->
                <div class="mb-2">
                    <small class="text-muted fw-bold d-block mb-1">Analysis</small>
                    <div class="d-flex flex-wrap gap-1">
                        <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(incident.name)}', 'incident')" title="Investigate">
                            <i class="fas fa-search"></i>
                        </button>
                        ${incident.article_uris && incident.article_uris.length > 0 ? `
                            <button class="btn btn-sm btn-outline-secondary" onclick="launchConsensusAnalysis('${incident.article_uris[0]}')" title="Consensus">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>

                <!-- Admin Actions -->
                <div>
                    <small class="text-muted fw-bold d-block mb-1">Actions</small>
                    <div class="d-flex flex-wrap gap-1">
                        ${incident.article_uris && incident.article_uris.length > 0 ? `
                            <button class="btn btn-sm btn-outline-success" onclick="openAnnotationModal('${incident.article_uris[0]}')" title="Annotate">
                                <i class="fas fa-sticky-note"></i>
                            </button>
                        ` : ''}
                        ${status !== 'seen' ? `
                            <button class="btn btn-sm btn-outline-info" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'seen')" title="Mark as seen">
                                <i class="fas fa-eye"></i>
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-secondary" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'active')" title="Mark as unseen">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                        `}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteIncident('${escapeHTML(incident.name)}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
    // Apply opacity for seen incidents
    if (status === 'seen') {
        card.classList.add('opacity-75');
    }

    col.appendChild(card);
    return col;
}


function clearIncidentFilters() {
    incidentFilters.types.clear();
    incidentFilters.significance.clear();
    incidentFilters.status.clear();
    
    if (allIncidents.length > 0) {
        buildIncidentFilterBadges(allIncidents);
        renderIncidentTrackingFiltered(allIncidents);
    }
}

// Incident status management functions
async function updateIncidentStatus(incidentName, status) {
    try {
        const topicSelect = document.getElementById('topic-select');
        const currentTopic = topicSelect ? topicSelect.value : 'AI and Machine Learning';
        
        const response = await fetch(`/api/incident-status/${encodeURIComponent(incidentName)}?status=${status}&topic=${encodeURIComponent(currentTopic)}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Update the incident in allIncidents array
            const incident = allIncidents.find(inc => inc.name === incidentName);
            if (incident) {
                incident.status = status;
            }
            
            // Re-render with current filters
            const filteredIncidents = applyIncidentFilters(allIncidents);
            renderIncidentTrackingFiltered(filteredIncidents);
            
            const statusText = status === 'seen' ? 'seen' : 'active';
            showNotification(`Incident marked as ${statusText}`, 'success');
        } else {
            throw new Error(result.message || 'Failed to update status');
        }
        
    } catch (error) {
        console.error('Error updating incident status:', error);
        showNotification(`Failed to update incident status: ${error.message}`, 'error');
    }
}

async function deleteIncident(incidentName) {
    if (!confirm(`Are you sure you want to delete the incident "${incidentName}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const topicSelect = document.getElementById('topic-select');
        const currentTopic = topicSelect ? topicSelect.value : 'AI and Machine Learning';
        
        const response = await fetch(`/api/incident-status/${encodeURIComponent(incidentName)}?status=deleted&topic=${encodeURIComponent(currentTopic)}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Remove the incident from allIncidents array
            const incidentIndex = allIncidents.findIndex(inc => inc.name === incidentName);
            if (incidentIndex !== -1) {
                allIncidents.splice(incidentIndex, 1);
            }
            
            // Re-render with current filters
            const filteredIncidents = applyIncidentFilters(allIncidents);
            renderIncidentTrackingFiltered(filteredIncidents);
            
            // Update filter badges since we removed an incident
            buildIncidentFilterBadges(allIncidents);
            
            showNotification('Incident deleted successfully', 'success');
        } else {
            throw new Error(result.message || 'Failed to delete incident');
        }
        
    } catch (error) {
        console.error('Error deleting incident:', error);
        showNotification(`Failed to delete incident: ${error.message}`, 'error');
    }
}

// Incident analysis functions
async function toggleIncidentAnalysis(incidentName, articleUri, buttonElement) {
    const analysisId = `incident-analysis-${incidentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const analysisDiv = document.getElementById(analysisId);
    const icon = buttonElement.querySelector('i');
    
    if (!analysisDiv) return;
    
    if (analysisDiv.style.display === 'none') {
        // Expand
        analysisDiv.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
        buttonElement.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Hide Analysis';
        buttonElement.classList.remove('btn-outline-primary');
        buttonElement.classList.add('btn-success');
        
        // Generate analysis
        await generateIncidentArticleAnalysis(incidentName, articleUri);
        
    } else {
        // Collapse
        analysisDiv.style.display = 'none';
        icon.className = 'fas fa-chevron-right';
        buttonElement.innerHTML = '<i class="fas fa-chevron-right me-1"></i>Show Analysis';
        buttonElement.classList.remove('btn-success');
        buttonElement.classList.add('btn-outline-primary');
    }
}

async function generateIncidentArticleAnalysis(incidentName, articleUri) {
    const analysisContentId = `incident-article-analysis-${incidentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const analysisDiv = document.getElementById(analysisContentId);
    
    if (!analysisDiv) return;
    
    // Show loading state
    analysisDiv.innerHTML = `
        <div class="analysis-text bg-light p-2 rounded small text-muted">
            <i class="fas fa-spinner fa-spin me-2"></i>Generating analysis...
        </div>
    `;
    
    try {
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Use the same analysis endpoint as the Articles tab
        const response = await fetch('/api/vector-summary-raw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel
            })
        });
        
        if (!response.ok) {
            throw new Error(`Analysis failed: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.analysis) {
            // Convert markdown to HTML using marked.js
            const htmlContent = marked.parse(data.analysis);
            analysisDiv.innerHTML = `
                <div class="analysis-text small">
                    ${htmlContent}
                </div>
                <div class="mt-2 text-muted small">
                    <i class="fas fa-robot me-1"></i>Analysis by ${selectedModel}
                </div>
            `;
        } else {
            throw new Error('No analysis content received');
        }
        
    } catch (error) {
        console.error('Error generating incident analysis:', error);
        analysisDiv.innerHTML = `
            <div class="analysis-text bg-danger text-white p-2 rounded small">
                <i class="fas fa-exclamation-triangle me-2"></i>Failed to generate analysis: ${error.message}
            </div>
        `;
    }
}

// Incident-specific Auspex research functions with well-formed prompts
async function launchIncidentDeepDive(incidentName, articleUri) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Create chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Deep Dive: ${incidentName}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build focused deep dive prompt
        const researchPrompt = `Conduct a comprehensive deep dive analysis of the incident/entity: "${incidentName}"

CONTEXT:
This incident was identified through AI-powered threat hunting analysis. The primary article URI is: ${articleUri}

DEEP DIVE FOCUS: "${incidentName}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for comprehensive background information on "${incidentName}"
2. Analyze the primary themes, entities, and implications involved
3. Investigate historical context and related developments
4. Assess current status, recent activities, and future implications
5. Identify key stakeholders, organizations, and decision-makers
6. Evaluate strategic risks, opportunities, and potential outcomes
7. Provide actionable intelligence and strategic recommendations

Conduct a thorough investigation using your structured analysis format. Focus on providing comprehensive strategic intelligence about this specific incident/entity.`;
        
        await launchAuspexWithPrompt(chatId, researchPrompt, selectedModel, actualTopic, 'Incident Deep Dive');
        
    } catch (error) {
        console.error('Error launching incident deep dive:', error);
        showNotification(`Failed to launch deep dive: ${error.message}`, 'error');
    }
}

async function launchIncidentConsensus(incidentName, articleUri) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Create chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Consensus Check: ${incidentName}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build consensus analysis prompt
        const researchPrompt = `Analyze the claims and assertions related to: "${incidentName}" and compare them to broader consensus

CONTEXT:
This incident was identified through threat hunting analysis. The primary article URI is: ${articleUri}

CONSENSUS ANALYSIS FOCUS: "${incidentName}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for multiple sources reporting on "${incidentName}"
2. Identify the key claims, assertions, or releases being made
3. Compare these claims across different sources and perspectives
4. Assess the credibility and consistency of the information
5. Identify any contradictions, disputes, or verification issues
6. Evaluate the overall consensus or lack thereof on key points
7. Highlight any outlier claims that require additional verification

Focus on fact-checking and consensus-building analysis. Provide a balanced assessment of information reliability and source agreement.`;
        
        await launchAuspexWithPrompt(chatId, researchPrompt, selectedModel, actualTopic, 'Consensus Analysis');
        
    } catch (error) {
        console.error('Error launching incident consensus:', error);
        showNotification(`Failed to launch consensus analysis: ${error.message}`, 'error');
    }
}

async function launchIncidentAdjacent(incidentName, articleUri) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Create chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Adjacent Topics: ${incidentName}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build adjacent topics analysis prompt
        const researchPrompt = `Explore adjacent and related themes connected to: "${incidentName}"

CONTEXT:
This incident was identified through threat hunting analysis. The primary article URI is: ${articleUri}

ADJACENT TOPICS FOCUS: "${incidentName}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for related themes and adjacent topics connected to "${incidentName}"
2. Identify upstream causes, downstream effects, and parallel developments
3. Explore connected entities, technologies, or policy areas
4. Analyze broader ecosystem implications and interdependencies
5. Investigate similar incidents or patterns in related domains
6. Map the strategic landscape and competitive dynamics
7. Identify emerging themes that intersect with this incident

Focus on expanding the analysis beyond the immediate incident to understand the broader strategic context and related opportunities or threats.`;
        
        await launchAuspexWithPrompt(chatId, researchPrompt, selectedModel, actualTopic, 'Adjacent Topics Analysis');
        
    } catch (error) {
        console.error('Error launching adjacent topics analysis:', error);
        showNotification(`Failed to launch adjacent topics analysis: ${error.message}`, 'error');
    }
}

// Update the realtime-signals-nav click handler to load alerts
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    document.getElementById('realtime-signals-nav')?.addEventListener('click', function() {
        loadTopicsForSignals(); // Load available topics first
        updateSignalArticleCount(); // Update article count
        loadSignalInstructions();
        loadSignalAlerts(); // Also load alerts when tab is opened
    });
});

// ===== Incident Configuration Modal Functions =====

// Global configuration state
let incidentConfig = {
    systemPrompt: '',
    userPrompt: '',
    baseOntology: '',
    domainKey: '',
    domainOverlay: '',
    ontologyExamples: '',
    analysisInstructions: '',
    qualityGuidelines: '',
    outputFormat: '',
    profileContextTemplate: '',
    enableProfileIntegration: true
};

// Default templates
const DEFAULT_SYSTEM_PROMPT = `You are a threat intelligence analyst tracking incidents, entities, and events in {topic}.

IMPORTANT: Assess credibility and plausibility. Treat extraordinary, self-reported breakthroughs with skepticism.
Use factual_reporting, MBFC credibility, and bias indicators. Down-rank or flag items from low/mixed credibility or fringe bias sources.

{profile_context}

{analysis_instructions}

{quality_guidelines}

{ontology_text}

Required fields for each item:
- name
- type: incident | entity | event | expertise | informed_insider | trend_signal | strategic_shift
- subtype: from the allowed list for the chosen type
- description
- article_uris
- timeline
- significance: low | medium | high (reduce if credibility concerns exist)
- investigation_leads
- related_entities
- plausibility: likely | questionable | implausible
- source_quality: high | mixed | low
- misinfo_flags: [] e.g., "extraordinary_claim", "no_independent_verification", "low_factuality_source", "fringe_bias"
- credibility_summary: 1-2 sentence rationale

Devil's Advocate Smell Test:
- Add a "devils_advocate" field with brief caution if the claim appears hyperbolic or extraordinary relative to typical evidence.
- Use label "Hyperbolic Claim" when applicable.

Output a pure JSON array only.`;

const DEFAULT_USER_PROMPT = `Analyze these {topic} articles for threat hunting incidents, entities, and events:

{articles_text}`;

const DEFAULT_BASE_ONTOLOGY = `ONTOLOGY — Types and Subtypes
Valid types: incident | event | entity | expertise | informed_insider | trend_signal | strategic_shift

Definitions:
- incident: Discrete occurrence with material operational/strategic/risk impact that may warrant response, remediation, or escalation.
- event: Noteworthy occurrence (signals, milestones, announcements) that informs context or trends but is not itself a disruptive incident.
- entity: Organization, person, product, venue, dataset (things we track, not occurrences).
- expertise: Expert analysis, predictions, or authoritative insights from recognized industry leaders, analysts, or researchers.
- informed_insider: Insider perspectives, leaked information, or privileged insights from people with direct access to relevant information.
- trend_signal: Market trends, behavioral shifts, or emerging patterns that indicate future developments.
- strategic_shift: Major strategic changes, policy pivots, or directional changes by key organizations or governments.

Recommended subtypes:
- incident: regulatory_action, compliance_breach, data_security, legal_ip, mna, layoffs, funding_cut, rd_spend_change, governance_change, market_disruption
- event: product_launch, feature_update, partnership_mou, funding_round, hiring, award, conference_announcement, roadmap_teaser, benchmark_result, pilot_program
- entity: company, person, product, dataset, venue, regulator, research_institution, government_agency
- expertise: industry_analysis, market_prediction, technical_assessment, strategic_forecast, expert_warning, research_finding
- informed_insider: leaked_strategy, internal_memo, insider_trading, confidential_roadmap, private_meeting, executive_communication
- trend_signal: adoption_trend, market_shift, behavioral_change, technology_uptake, regulatory_momentum, competitive_dynamic
- strategic_shift: policy_pivot, strategic_realignment, market_repositioning, technology_focus_change, regulatory_approach_change

Assignment rules:
- Use 'incident' for events requiring immediate attention or response (layoffs, breaches, regulatory actions, major failures).
- Use 'event' for announcements and developments (product launches, funding, partnerships, pilot programs).
- Use 'entity' for organizations, people, or products being tracked.
- Use 'expertise' when article features expert analysis, predictions, or authoritative insights from recognized leaders.
- Use 'informed_insider' when article contains insider information, leaks, or privileged access insights.
- Use 'trend_signal' when article identifies emerging patterns, market trends, or behavioral shifts.
- Use 'strategic_shift' when article describes major strategic changes, policy pivots, or directional changes.
- Always include a 'subtype' from the lists above.
- Be inclusive rather than restrictive - classify newsworthy content appropriately.`;

const DEFAULT_ONTOLOGY_EXAMPLES = `Labeling examples (JSON objects):
{"name": "SoftBank Vision Fund layoffs amid AI strategy shift", "type": "incident", "subtype": "layoffs"}
{"name": "US risks losing AI leadership to China", "type": "incident", "subtype": "governance_change"}
{"name": "Citi launches agentic AI pilot program", "type": "event", "subtype": "pilot_program"}
{"name": "OpenAI CEO discusses quantum computing partnership", "type": "event", "subtype": "partnership_mou"}
{"name": "Eric Schmidt warns about AI competitiveness", "type": "expertise", "subtype": "expert_warning"}
{"name": "Inside Tony Blair Institute AI strategy discussions", "type": "informed_insider", "subtype": "private_meeting"}
{"name": "Growing enterprise adoption of agentic AI", "type": "trend_signal", "subtype": "adoption_trend"}
{"name": "SoftBank shifts focus from consumer to enterprise AI", "type": "strategic_shift", "subtype": "strategic_realignment"}
{"name": "SoftBank Vision Fund", "type": "entity", "subtype": "company"}
{"name": "Eric Schmidt", "type": "entity", "subtype": "person"}
{"name": "Tony Blair Institute", "type": "entity", "subtype": "research_institution"}`;

const DEFAULT_ANALYSIS_INSTRUCTIONS = `Focus on extracting actionable intelligence from news articles. Prioritize:

1. Material business impacts and strategic changes (layoffs, restructuring, major funding changes)
2. Regulatory actions and compliance issues (government policies, regulatory warnings)
3. Security incidents and data breaches (cybersecurity events, data leaks)
4. Significant funding, M&A, or operational changes (acquisitions, major investments, closures)
5. Technology launches and competitive developments (new products, platform launches, AI model releases)
6. Leadership changes and strategic pivots (CEO changes, strategic direction shifts)
7. Market warnings and competitive threats (expert warnings, competitive analysis)

Classification Guidelines:
- INCIDENT: Events requiring immediate attention or response (layoffs, breaches, regulatory actions, major failures)
- EVENT: Significant announcements and developments (product launches, funding rounds, partnerships, strategic initiatives)  
- ENTITY: Organizations, people, or products being tracked (companies mentioned, key executives, new technologies)

Be inclusive rather than restrictive - if an article discusses something newsworthy, classify it appropriately.`;

const DEFAULT_QUALITY_GUIDELINES = `Credibility Assessment:
- High credibility: Major news outlets, verified sources, multiple independent confirmations
- Mixed credibility: Single source reporting, unverified claims, industry blogs
- Low credibility: Social media rumors, fringe sources, extraordinary claims without evidence

Extraordinary Claims Protocol:
- Flag claims that seem too good to be true or represent major breakthroughs
- Require independent verification for significant technical achievements
- Down-rank significance for self-reported successes without third-party validation`;

const DEFAULT_OUTPUT_FORMAT = `Output must be a valid JSON array with each incident object containing all required fields.
Ensure proper JSON escaping of quotes and special characters.
Do not include any explanatory text outside the JSON array.`;

const DEFAULT_PROFILE_CONTEXT_TEMPLATE = `ORGANIZATIONAL CONTEXT:
Organization: {profile_name} ({organization_type} in {industry})
Region: {region}
Risk Tolerance: {risk_tolerance} | Innovation Appetite: {innovation_appetite}
Decision Making: {decision_making_style}

Key Concerns: {key_concerns}
Strategic Priorities: {strategic_priorities}
Key Stakeholders: {stakeholder_focus}
Competitive Landscape: {competitive_landscape}
Regulatory Environment: {regulatory_environment}

Custom Context: {custom_context}

ANALYSIS INSTRUCTIONS:
- Prioritize incidents and events that align with the organization's key concerns and strategic priorities
- Assess significance based on the organization's risk tolerance and decision-making style  
- Consider impact on key stakeholders and competitive positioning
- Account for relevant regulatory and compliance implications
- Tailor investigation leads to organizational context and priorities`;

// Show the incident configuration modal
function showIncidentConfigModal() {
    loadIncidentConfiguration();
    const modal = new bootstrap.Modal(document.getElementById('incidentConfigModal'));
    modal.show();
}

// Load configuration from localStorage or defaults
async function loadIncidentConfiguration() {
    try {
        // Try to load from API first (future enhancement)
        const response = await fetch('/api/incident-config');
        if (response.ok) {
            const config = await response.json();
            incidentConfig = { ...incidentConfig, ...config };
        }
    } catch (error) {
        console.log('No saved configuration found, using defaults');
    }

    // Load from localStorage as fallback
    const saved = localStorage.getItem('incidentTrackingConfig');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            incidentConfig = { ...incidentConfig, ...parsed };
        } catch (error) {
            console.error('Error parsing saved configuration:', error);
        }
    }

    // Get the currently selected organizational profile from news feed
    const currentProfile = await getCurrentOrganizationalProfile();
    
    // Populate form fields with current config or defaults
    document.getElementById('incidentSystemPrompt').value = incidentConfig.systemPrompt || DEFAULT_SYSTEM_PROMPT;
    document.getElementById('incidentUserPrompt').value = incidentConfig.userPrompt || DEFAULT_USER_PROMPT;
    document.getElementById('baseOntology').value = incidentConfig.baseOntology || DEFAULT_BASE_ONTOLOGY;
    document.getElementById('domainKey').value = incidentConfig.domainKey || '';
    document.getElementById('domainOverlay').value = incidentConfig.domainOverlay || '';
    document.getElementById('ontologyExamples').value = incidentConfig.ontologyExamples || DEFAULT_ONTOLOGY_EXAMPLES;
    document.getElementById('analysisInstructions').value = incidentConfig.analysisInstructions || DEFAULT_ANALYSIS_INSTRUCTIONS;
    document.getElementById('qualityGuidelines').value = incidentConfig.qualityGuidelines || DEFAULT_QUALITY_GUIDELINES;
    document.getElementById('outputFormat').value = incidentConfig.outputFormat || DEFAULT_OUTPUT_FORMAT;
    
    // Use profile-specific context template if we have a current profile
    let profileTemplate = incidentConfig.profileContextTemplate || DEFAULT_PROFILE_CONTEXT_TEMPLATE;
    if (currentProfile) {
        profileTemplate = generateProfileContextFromData(currentProfile);
    }
    document.getElementById('profileContextTemplate').value = profileTemplate;
    document.getElementById('enableProfileIntegration').checked = incidentConfig.enableProfileIntegration !== false;
    
    // Show profile info if one is selected
    showCurrentProfileInfo(currentProfile);
}

// Save configuration
async function saveIncidentConfiguration() {
    try {
        // Collect values from form
        incidentConfig = {
            systemPrompt: document.getElementById('incidentSystemPrompt').value,
            userPrompt: document.getElementById('incidentUserPrompt').value,
            baseOntology: document.getElementById('baseOntology').value,
            domainKey: document.getElementById('domainKey').value,
            domainOverlay: document.getElementById('domainOverlay').value,
            ontologyExamples: document.getElementById('ontologyExamples').value,
            analysisInstructions: document.getElementById('analysisInstructions').value,
            qualityGuidelines: document.getElementById('qualityGuidelines').value,
            outputFormat: document.getElementById('outputFormat').value,
            profileContextTemplate: document.getElementById('profileContextTemplate').value,
            enableProfileIntegration: document.getElementById('enableProfileIntegration').checked
        };

        // Save to localStorage
        localStorage.setItem('incidentTrackingConfig', JSON.stringify(incidentConfig));

        // Try to save to API (future enhancement)
        try {
            await fetch('/api/incident-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(incidentConfig)
            });
        } catch (error) {
            console.log('API save not available, using localStorage only');
        }

        showNotification('Incident configuration saved successfully', 'success');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('incidentConfigModal'));
        modal.hide();
        
    } catch (error) {
        console.error('Error saving configuration:', error);
        showNotification('Failed to save configuration: ' + error.message, 'error');
    }
}

// Reset all to defaults
function resetAllToDefaults() {
    if (confirm('Are you sure you want to reset all configuration to defaults? This will overwrite your current settings.')) {
        document.getElementById('incidentSystemPrompt').value = DEFAULT_SYSTEM_PROMPT;
        document.getElementById('incidentUserPrompt').value = DEFAULT_USER_PROMPT;
        document.getElementById('baseOntology').value = DEFAULT_BASE_ONTOLOGY;
        document.getElementById('domainKey').value = '';
        document.getElementById('domainOverlay').value = '';
        document.getElementById('ontologyExamples').value = DEFAULT_ONTOLOGY_EXAMPLES;
        document.getElementById('analysisInstructions').value = DEFAULT_ANALYSIS_INSTRUCTIONS;
        document.getElementById('qualityGuidelines').value = DEFAULT_QUALITY_GUIDELINES;
        document.getElementById('outputFormat').value = DEFAULT_OUTPUT_FORMAT;
        document.getElementById('profileContextTemplate').value = DEFAULT_PROFILE_CONTEXT_TEMPLATE;
        document.getElementById('enableProfileIntegration').checked = true;
        
        showNotification('Configuration reset to defaults', 'info');
    }
}

// Load default prompt template
function loadDefaultPromptTemplate() {
    if (confirm('Reset prompt templates to defaults?')) {
        document.getElementById('incidentSystemPrompt').value = DEFAULT_SYSTEM_PROMPT;
        document.getElementById('incidentUserPrompt').value = DEFAULT_USER_PROMPT;
        showNotification('Prompt templates reset to defaults', 'info');
    }
}

// Load default ontology
function loadDefaultOntology() {
    if (confirm('Reset ontology to defaults?')) {
        document.getElementById('baseOntology').value = DEFAULT_BASE_ONTOLOGY;
        document.getElementById('domainKey').value = '';
        document.getElementById('domainOverlay').value = '';
        document.getElementById('ontologyExamples').value = DEFAULT_ONTOLOGY_EXAMPLES;
        showNotification('Ontology reset to defaults', 'info');
    }
}

// Preview prompt with sample data
function previewPrompt() {
    const systemPrompt = document.getElementById('incidentSystemPrompt').value;
    const userPrompt = document.getElementById('incidentUserPrompt').value;
    const baseOntology = document.getElementById('baseOntology').value;
    
    // Sample data for preview
    const sampleTopic = 'AI and Machine Learning';
    const sampleOntology = baseOntology || DEFAULT_BASE_ONTOLOGY;
    const sampleArticles = `Article 1:
Title: OpenAI Announces GPT-5 with Revolutionary Capabilities
Source: TechCrunch
Date: 2024-01-15
Category: Technology | Sentiment: Positive
Summary: OpenAI unveiled GPT-5, claiming breakthrough performance in reasoning and multimodal tasks.`;

    // Get actual profile context (will use real profile data if available)
    const profileTemplate = document.getElementById('profileContextTemplate').value || DEFAULT_PROFILE_CONTEXT_TEMPLATE;
    
    // If the template contains actual profile data, use it as-is
    // Otherwise, use sample data for preview
    let sampleProfileContext = profileTemplate;
    if (profileTemplate === DEFAULT_PROFILE_CONTEXT_TEMPLATE) {
        sampleProfileContext = profileTemplate
            .replace(/{profile_name}/g, 'TechCorp Analytics (Sample)')
            .replace(/{organization_type}/g, 'Enterprise')
            .replace(/{industry}/g, 'Technology')
            .replace(/{region}/g, 'North America')
            .replace(/{risk_tolerance}/g, 'Medium')
            .replace(/{innovation_appetite}/g, 'Moderate')
            .replace(/{decision_making_style}/g, 'Data-driven')
            .replace(/{key_concerns}/g, 'AI safety, competitive intelligence, regulatory compliance')
            .replace(/{strategic_priorities}/g, 'Market leadership, innovation, risk management')
            .replace(/{stakeholder_focus}/g, 'Executives, product teams, compliance')
            .replace(/{competitive_landscape}/g, 'Google, Microsoft, OpenAI')
            .replace(/{regulatory_environment}/g, 'EU AI Act, US AI governance frameworks')
            .replace(/{custom_context}/g, 'Focus on enterprise AI applications and B2B market dynamics');
    }
    // If it's not the default template, it means we have real profile data, so use it as-is

    // Get AI guidance components
    const analysisInstructions = document.getElementById('analysisInstructions').value || DEFAULT_ANALYSIS_INSTRUCTIONS;
    const qualityGuidelines = document.getElementById('qualityGuidelines').value || DEFAULT_QUALITY_GUIDELINES;

    // Replace placeholders
    const previewSystem = systemPrompt
        .replace(/{topic}/g, sampleTopic)
        .replace(/{ontology_text}/g, sampleOntology)
        .replace(/{profile_context}/g, sampleProfileContext)
        .replace(/{analysis_instructions}/g, analysisInstructions)
        .replace(/{quality_guidelines}/g, qualityGuidelines);
    
    const previewUser = userPrompt
        .replace(/{topic}/g, sampleTopic)
        .replace(/{articles_text}/g, sampleArticles);

    // Show preview in new modal with both prompt and expected output
    const previewContent = `SYSTEM PROMPT:\n${previewSystem}\n\nUSER PROMPT:\n${previewUser}`;
    
    // Expected output based on sample data
    const expectedOutput = `EXPECTED OUTPUT (Sample):
[
  {
    "name": "OpenAI GPT-5 Revolutionary Capabilities Announcement",
    "type": "event",
    "subtype": "product_launch",
    "description": "OpenAI unveiled GPT-5 with claimed breakthrough performance in reasoning and multimodal tasks",
    "article_uris": ["https://techcrunch.com/sample-gpt5"],
    "timeline": ["2024-01-15"],
    "significance": "high",
    "investigation_leads": ["GPT-5 performance benchmarks", "competitive response analysis", "market impact assessment"],
    "related_entities": ["OpenAI", "GPT-5"],
    "plausibility": "likely",
    "source_quality": "high",
    "misinfo_flags": [],
    "credibility_summary": "TechCrunch is a reputable technology publication with high factual reporting standards."
  }
]`;
    
    // Create a simple preview modal
    const previewModal = document.createElement('div');
    previewModal.innerHTML = `
        <div class="modal fade" id="promptPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Prompt Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="previewTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#preview-prompt">Prompt</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#preview-output">Expected Output</a>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            <div class="tab-pane fade show active" id="preview-prompt">
                                <pre style="white-space: pre-wrap; font-size: 11px; max-height: 400px; overflow-y: auto;">${escapeHTML(previewContent)}</pre>
                            </div>
                            <div class="tab-pane fade" id="preview-output">
                                <pre style="white-space: pre-wrap; font-size: 11px; max-height: 400px; overflow-y: auto;">${escapeHTML(expectedOutput)}</pre>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(previewModal);
    const modal = new bootstrap.Modal(previewModal.querySelector('.modal'));
    modal.show();
    
    // Clean up when modal is closed
    previewModal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(previewModal);
    });
}

// Validate prompt template
async function validatePromptTemplate() {
    try {
        // Collect current configuration
        const config = {
            systemPrompt: document.getElementById('incidentSystemPrompt').value,
            userPrompt: document.getElementById('incidentUserPrompt').value,
            baseOntology: document.getElementById('baseOntology').value,
            domainKey: document.getElementById('domainKey').value,
            domainOverlay: document.getElementById('domainOverlay').value,
            ontologyExamples: document.getElementById('ontologyExamples').value,
            analysisInstructions: document.getElementById('analysisInstructions').value,
            qualityGuidelines: document.getElementById('qualityGuidelines').value,
            outputFormat: document.getElementById('outputFormat').value,
            profileContextTemplate: document.getElementById('profileContextTemplate').value,
            enableProfileIntegration: document.getElementById('enableProfileIntegration').checked
        };
        
        // Client-side validation
        const issues = [];
        
        // Check for required placeholders in system prompt
        const systemPrompt = config.systemPrompt;
        if (!systemPrompt.includes('{topic}')) {
            issues.push('System prompt missing {topic} placeholder');
        }
        if (!systemPrompt.includes('{ontology_text}')) {
            issues.push('System prompt missing {ontology_text} placeholder');
        }
        
        // Check for required placeholders in user prompt
        const userPrompt = config.userPrompt;
        if (!userPrompt.includes('{topic}')) {
            issues.push('User prompt missing {topic} placeholder');
        }
        if (!userPrompt.includes('{articles_text}')) {
            issues.push('User prompt missing {articles_text} placeholder');
        }
        
        // Validate ontology structure
        const ontology = config.baseOntology;
        if (!ontology.includes('incident') || !ontology.includes('event') || !ontology.includes('entity')) {
            issues.push('Base ontology missing required types (incident, event, entity)');
        }
        
        // Validate profile template if profile integration is enabled
        if (config.enableProfileIntegration && config.profileContextTemplate) {
            const template = config.profileContextTemplate;
            const currentProfile = await getCurrentOrganizationalProfile();
            
            if (currentProfile) {
                // For real profiles, template should already be populated (not contain placeholders)
                const hasPlaceholders = template.includes('{profile_name}') || 
                                      template.includes('{industry}') || 
                                      template.includes('{organization_type}');
                
                if (hasPlaceholders) {
                    // Template has placeholders but we have a real profile - try to populate it
                    try {
                        const testContext = generateProfileContextFromData(currentProfile);
                        if (!testContext || testContext === template) {
                            issues.push('Profile context template could not be populated with current profile data');
                        }
                    } catch (e) {
                        issues.push('Profile context template has formatting errors');
                    }
                } else {
                    // Template is already populated - check if it contains organization info
                    if (!template.includes(currentProfile.name)) {
                        issues.push('Profile context template does not appear to contain current organization information');
                    }
                }
            } else {
                // No profile selected - template should have placeholders for future use
                const hasPlaceholders = template.includes('{profile_name}') || 
                                      template.includes('{industry}') || 
                                      template.includes('{organization_type}');
                
                if (!hasPlaceholders) {
                    issues.push('No organizational profile selected. Template should contain placeholders like {profile_name}, {industry}, {organization_type} for future use.');
                }
            }
        }
        
        if (issues.length === 0) {
            showNotification('Configuration validation passed ✓', 'success');
        } else {
            showNotification(`Validation issues found:\\n• ${issues.join('\\n• ')}`, 'warning');
        }
        
    } catch (error) {
        console.error('Error validating configuration:', error);
        showNotification('Failed to validate configuration: ' + error.message, 'error');
    }
}

// Validate ontology structure
function validateOntology() {
    const baseOntology = document.getElementById('baseOntology').value;
    const examples = document.getElementById('ontologyExamples').value;
    
    const issues = [];
    
    // Check for required types
    if (!baseOntology.toLowerCase().includes('incident')) {
        issues.push('Base ontology missing "incident" type definition');
    }
    if (!baseOntology.toLowerCase().includes('event')) {
        issues.push('Base ontology missing "event" type definition');
    }
    if (!baseOntology.toLowerCase().includes('entity')) {
        issues.push('Base ontology missing "entity" type definition');
    }
    
    // Check examples format
    if (examples) {
        try {
            const lines = examples.split('\\n').filter(line => line.trim());
            for (const line of lines) {
                if (line.trim().startsWith('{')) {
                    JSON.parse(line.trim());
                }
            }
        } catch (error) {
            issues.push('Invalid JSON format in examples');
        }
    }
    
    if (issues.length === 0) {
        showNotification('Ontology validation passed', 'success');
    } else {
        showNotification('Validation issues found:\\n• ' + issues.join('\\n• '), 'warning');
    }
}

// Add domain overlay helper
function addDomainOverlay() {
    const domainKey = document.getElementById('domainKey').value.trim();
    if (!domainKey) {
        showNotification('Please enter a domain key first', 'warning');
        return;
    }
    
    const template = `
Domain overlay — ${domainKey}:
- Treat as incident: [specific incident criteria for this domain]
- Treat as event: [specific event criteria for this domain]
Examples:
  - '[Example incident]' → type=incident, subtype=[subtype], significance=[level].
  - '[Example event]' → type=event, subtype=[subtype], significance=[level].
`;
    
    document.getElementById('domainOverlay').value = template;
    showNotification('Domain overlay template added', 'info');
}

// Upgrade to extended 7-type ontology
function upgradeToExtendedOntology() {
    if (confirm('Upgrade to the new 7-type ontology with Expertise, Informed Insider, Trend Signal, and Strategic Shift types? This will replace your current ontology configuration.')) {
        // Update to the new extended ontology
        document.getElementById('baseOntology').value = DEFAULT_BASE_ONTOLOGY;
        document.getElementById('ontologyExamples').value = DEFAULT_ONTOLOGY_EXAMPLES;
        document.getElementById('analysisInstructions').value = DEFAULT_ANALYSIS_INSTRUCTIONS;
        
        showNotification('Upgraded to extended 7-type ontology! This should capture more nuanced intelligence from your articles.', 'success');
    }
}

// Test with sample articles
async function testWithSampleArticles() {
    try {
        showNotification('Running test analysis with sample articles...', 'info');
        
        // Get current configuration
        const config = {
            systemPrompt: document.getElementById('incidentSystemPrompt').value,
            userPrompt: document.getElementById('incidentUserPrompt').value,
            baseOntology: document.getElementById('baseOntology').value,
            profileContextTemplate: document.getElementById('profileContextTemplate').value,
            enableProfileIntegration: document.getElementById('enableProfileIntegration').checked
        };
        
        // Get 5 most recent articles from current news feed
        let sampleArticles = [];
        
        try {
            // First try to use articles already loaded in the news feed
            const currentArticles = window.lastArticlesData?.items || [];
            if (currentArticles.length >= 5) {
                sampleArticles = currentArticles.slice(0, 5).map(article => ({
                    title: article.title || 'Untitled Article',
                    news_source: article.news_source || 'Unknown Source', // Use news_source, not source
                    summary: article.summary || 'No summary available',
                    uri: article.uri || '',
                    category: article.category || 'Uncategorized',
                    sentiment: article.sentiment || 'Neutral',
                    bias: article.bias || 'Unknown',
                    factual_reporting: article.factual_reporting || 'Unknown',
                    publication_date: article.publication_date || new Date().toISOString().split('T')[0]
                }));
                console.log('Using 5 most recent articles from current news feed for testing');
            } else {
                // Fallback: fetch fresh articles from API
                console.log('Fetching fresh articles for testing...');
                const currentTopic = document.getElementById('topic-select')?.value || 'AI and Machine Learning';
                const response = await fetch(`/api/news-feed/articles?topic=${encodeURIComponent(currentTopic)}&per_page=5&page=1`);
                
                if (response.ok) {
                    const data = await response.json();
                    const articles = data.articles?.items || [];
                    
                    if (articles.length > 0) {
                        sampleArticles = articles.map(article => ({
                            title: article.title || 'Untitled Article',
                            news_source: article.news_source || 'Unknown Source', // Use news_source, not source
                            summary: article.summary || 'No summary available',
                            uri: article.uri || '',
                            category: article.category || 'Uncategorized',
                            sentiment: article.sentiment || 'Neutral',
                            bias: article.bias || 'Unknown',
                            factual_reporting: article.factual_reporting || 'Unknown',
                            publication_date: article.publication_date || new Date().toISOString().split('T')[0]
                        }));
                        console.log(`Fetched ${sampleArticles.length} fresh articles for testing`);
                    }
                }
            }
        } catch (error) {
            console.warn('Failed to get real articles, using fallback samples:', error);
        }
        
        // Fallback to mock data if we couldn't get real articles
        if (sampleArticles.length === 0) {
            console.log('Using fallback mock articles for testing');
            sampleArticles = [
                {
                    title: "OpenAI Announces GPT-5 with Revolutionary Capabilities",
                    news_source: "TechCrunch", // Use news_source, not source
                    summary: "OpenAI unveiled GPT-5, claiming breakthrough performance in reasoning and multimodal tasks.",
                    uri: "https://techcrunch.com/sample-gpt5",
                    category: "Technology",
                    sentiment: "Positive",
                    bias: "Least Biased",
                    factual_reporting: "High",
                    publication_date: "2024-01-15"
                },
                {
                    title: "EU Proposes Stricter AI Regulations Following Safety Concerns", 
                    news_source: "Reuters", // Use news_source, not source
                    summary: "European Union lawmakers are drafting additional AI safety regulations after reports of bias in large language models.",
                    uri: "https://reuters.com/sample-eu-regs",
                    category: "Policy",
                    sentiment: "Critical", 
                    bias: "Least Biased",
                    factual_reporting: "Very High",
                    publication_date: "2024-01-14"
                },
                {
                    title: "Tesla's AI Chip Division Reports Record Quarterly Revenue",
                    news_source: "Bloomberg", // Use news_source, not source
                    summary: "Tesla's semiconductor division exceeded expectations with $2.1B in Q4 revenue, driven by demand for AI training chips.",
                    uri: "https://bloomberg.com/sample-tesla",
                    category: "Business",
                    sentiment: "Positive",
                    bias: "Least Biased", 
                    factual_reporting: "High",
                    publication_date: "2024-01-13"
                }
            ];
        }
        
        // Show test results modal
        showTestResults(config, sampleArticles);
        
    } catch (error) {
        console.error('Error running test:', error);
        showNotification('Test failed: ' + error.message, 'error');
    }
}

// Show test results in modal
function showTestResults(config, sampleArticles) {
    // Create test modal to show results
    const testModal = document.createElement('div');
    testModal.innerHTML = `
        <div class="modal fade" id="testResultsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-flask me-2"></i>Test Analysis Results
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Sample Articles Used</h6>
                                <div class="bg-light p-3 rounded mb-3" style="max-height: 300px; overflow-y: auto;">
                                    ${sampleArticles.map((article, index) => `
                                        <div class="mb-2 pb-2 ${index < sampleArticles.length - 1 ? 'border-bottom' : ''}">
                                            <strong>${index + 1}. ${article.title}</strong><br>
                                            <small class="text-muted">${article.news_source}</small><br>
                                            <small>${article.summary}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">Configuration Status</h6>
                                <div class="mb-3">
                                    <div class="alert alert-info py-2">
                                        <strong>System Prompt:</strong> ${config.systemPrompt.length} characters<br>
                                        <strong>Profile Integration:</strong> ${config.enableProfileIntegration ? 'Enabled' : 'Disabled'}<br>
                                        <strong>Ontology:</strong> ${config.baseOntology.length} characters
                                    </div>
                                </div>
                                
                                <h6 class="text-warning">Expected Output</h6>
                                <div class="bg-light p-3 rounded">
                                    <small class="text-muted">
                                        Expected classifications:
                                        <ul class="mt-2 mb-0">
                                            <li><strong>Incident:</strong> EU regulatory action</li>
                                            <li><strong>Event:</strong> GPT-5 announcement</li>
                                            <li><strong>Entity:</strong> Tesla AI division</li>
                                        </ul>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary">Test Results</h6>
                                <div id="testAnalysisResults" class="bg-white border rounded p-3">
                                    <div class="text-center text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Running analysis simulation...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" onclick="runAnotherTest()">
                            <i class="fas fa-redo me-1"></i>Run Another Test
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(testModal);
    const modal = new bootstrap.Modal(testModal.querySelector('.modal'));
    modal.show();
    
    // Clean up when modal is closed
    testModal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(testModal);
    });
    
    // Run actual test analysis with the real articles
    setTimeout(() => runRealTestAnalysis(sampleArticles), 1500);
}

// Run actual test analysis with real articles
async function runRealTestAnalysis(articles) {
    const resultsDiv = document.getElementById('testAnalysisResults');
    if (!resultsDiv || !articles || articles.length === 0) {
        runSimulatedAnalysis(); // Fallback to simulation
        return;
    }
    
    try {
        resultsDiv.innerHTML = `
            <div class="text-center text-muted">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Running real incident analysis on ${articles.length} articles...
            </div>
        `;
        
        // Get current topic and model
        const currentTopic = document.getElementById('topic-select')?.value || 'AI and Machine Learning';
        const currentModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Get selected profile ID
        const profileSelect = document.getElementById('profile-select');
        const selectedProfileId = profileSelect && profileSelect.value ? parseInt(profileSelect.value) : null;
        
        // Build request for real incident tracking analysis
        const testRequest = {
            topic: currentTopic, // Use exact topic, not modified with "(Test)"
            days_limit: 7,
            max_articles: Math.max(10, Math.min(300, articles.length)), // Ensure within valid range
            model: currentModel,
            force_regenerate: true,
            test_articles: articles // Pass the actual articles for testing
        };
        
        // Add profile_id if selected
        if (selectedProfileId) {
            testRequest.profile_id = selectedProfileId;
            console.log(`Running test with organizational profile ID: ${selectedProfileId}`);
        }
        
        console.log('Test request payload:', testRequest);
        console.log('Articles being tested:', articles.map(a => ({ title: a.title, news_source: a.news_source, category: a.category })));
        
        // Add timeout to prevent infinite waiting (increased for LLM processing)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.error('Test request timed out after 60 seconds');
        }, 60000); // Increased to 60 seconds for LLM processing
        
        console.log('Calling /api/incident-tracking endpoint...');
        
        // Quick connectivity test first
        try {
            console.log('Testing API connectivity...');
            const pingResponse = await fetch('/api/incident-config/defaults', { 
                method: 'GET',
                signal: AbortSignal.timeout(5000) 
            });
            console.log('API connectivity test:', pingResponse.ok ? 'SUCCESS' : 'FAILED');
        } catch (pingError) {
            console.warn('API connectivity test failed:', pingError.message);
        }
        
        // Call the actual incident tracking API
        const response = await fetch('/api/incident-tracking', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testRequest),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        console.log('Response received:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorDetail = errorData.detail || response.statusText;
            console.error('API Error Details:', errorData);
            throw new Error(`API call failed: ${response.status} - ${errorDetail}`);
        }
        
        const result = await response.json();
        console.log('Real incident analysis results:', result);
        
        // Display real results
        if (result.incidents && result.incidents.length > 0) {
            let html = '<div class="alert alert-success py-2 mb-3">';
            html += `<strong>✅ Real Analysis Complete!</strong> Found ${result.incidents.length} incidents/entities/events from your actual articles`;
            html += '<br><small class="text-muted">This analysis used real articles from your database with your current configuration</small>';
            html += '</div>';
            
            html += '<div class="row g-2">';
            result.incidents.forEach((incident, index) => {
                const typeColor = incident.type === 'incident' ? 'danger' : 
                                 incident.type === 'entity' ? 'primary' : 'success';
                const sigColor = incident.significance === 'high' ? 'danger' : 
                               incident.significance === 'medium' ? 'warning' : 'info';
                
                html += `
                    <div class="col-md-6">
                        <div class="card border-${typeColor} h-100">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 small">${escapeHTML(incident.name || 'Unnamed')}</h6>
                                    <div>
                                        <span class="badge bg-${typeColor}">${incident.type}</span>
                                        <span class="badge bg-${sigColor}">${incident.significance}</span>
                                    </div>
                                </div>
                                <p class="card-text small text-muted mb-2">${escapeHTML(incident.description || 'No description')}</p>
                                
                                ${incident.plausibility ? `
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <strong>Plausibility:</strong> ${incident.plausibility} | 
                                            <strong>Source Quality:</strong> ${incident.source_quality || 'Unknown'}
                                        </small>
                                    </div>
                                ` : ''}
                                
                                ${incident.investigation_leads && incident.investigation_leads.length > 0 ? `
                                    <div class="mb-2">
                                        <small class="text-muted fw-bold">Leads:</small>
                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                            ${incident.investigation_leads.map(lead => `
                                                <span class="badge bg-light text-dark" style="font-size: 9px;">${escapeHTML(lead)}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${incident.article_uris && incident.article_uris.length > 0 ? `
                                    <div class="mb-1">
                                        <small class="text-muted">
                                            <strong>Related Articles:</strong> ${incident.article_uris.length}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Add analysis summary with real data
            html += '<div class="mt-3 alert alert-light">';
            html += '<h6 class="text-primary">Real Analysis Summary</h6>';
            html += `<div class="row text-center">`;
            
            const incidentCount = result.incidents.filter(i => i.type === 'incident').length;
            const entityCount = result.incidents.filter(i => i.type === 'entity').length;
            const eventCount = result.incidents.filter(i => i.type === 'event').length;
            const highSigCount = result.incidents.filter(i => i.significance === 'high').length;
            
            html += `
                <div class="col-3">
                    <div class="h5 text-danger mb-0">${incidentCount}</div>
                    <small class="text-muted">Incidents</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-primary mb-0">${entityCount}</div>
                    <small class="text-muted">Entities</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-success mb-0">${eventCount}</div>
                    <small class="text-muted">Events</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-warning mb-0">${highSigCount}</div>
                    <small class="text-muted">High Priority</small>
                </div>
            `;
            html += '</div></div>';
            
            resultsDiv.innerHTML = html;
            showNotification('Real incident analysis completed successfully!', 'success');
            
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h6>⚠️ No Incidents Found in Real Articles</h6>
                    <p class="mb-2">The analysis of your ${articles.length} real articles didn't identify any incidents. This could indicate:</p>
                    <ul class="mb-2">
                        <li>Your current articles don't contain incident-worthy events</li>
                        <li>The ontology or quality guidelines are too restrictive</li>
                        <li>The analysis instructions need adjustment for your content</li>
                    </ul>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Articles analyzed:</strong> ${articles.map(a => a.title.substring(0, 50) + '...').join(', ')}
                        </small>
                    </div>
                </div>
            `;
            showNotification('Real analysis completed but found no incidents', 'warning');
        }
        
    } catch (error) {
        console.error('Error running real test analysis:', error);
        
        let errorMessage = error.message;
        let errorAdvice = 'Check the browser console for detailed error information.';
        
        if (error.name === 'AbortError') {
            errorMessage = 'Request timed out after 60 seconds';
            errorAdvice = 'The LLM analysis is taking longer than expected. This can happen with complex articles or slower AI models. Try using a faster model like gpt-4o-mini or reduce the number of articles.';
        } else if (errorMessage.includes('Failed to fetch')) {
            errorMessage = 'Network connection failed';
            errorAdvice = 'Check if the server is running and accessible. Verify the API endpoint is working.';
        }
        
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>❌ Real Analysis Failed</h6>
                <p class="mb-2"><strong>Error:</strong> ${errorMessage}</p>
                <p class="mb-2"><small class="text-muted">${errorAdvice}</small></p>
                <p class="mb-2">Falling back to simulated analysis...</p>
            </div>
        `;
        
        // Fallback to simulation if real analysis fails
        setTimeout(() => runSimulatedAnalysis(), 1000);
        
        showNotification('Real analysis failed, using simulation: ' + errorMessage, 'warning');
    }
}

// Run simulated analysis for testing
function runSimulatedAnalysis() {
    const resultsDiv = document.getElementById('testAnalysisResults');
    if (!resultsDiv) return;
    
    // Simulate successful analysis results
    const mockResults = [
        {
            name: "EU AI Regulation Enforcement Action",
            type: "incident",
            description: "European Union implementing stricter AI safety regulations",
            significance: "high",
            investigation_leads: ["EU AI Act timeline", "Compliance costs", "Safety testing"]
        },
        {
            name: "OpenAI GPT-5 Launch",
            type: "event",
            description: "Major AI model release with breakthrough capabilities",
            significance: "high", 
            investigation_leads: ["Performance benchmarks", "Market impact", "Competitive response"]
        },
        {
            name: "Tesla AI Chip Division",
            type: "entity",
            description: "Tesla's semiconductor business unit in AI training chips",
            significance: "medium",
            investigation_leads: ["Chip technology", "Market trends", "Competition"]
        }
    ];
    
    let html = '<div class="alert alert-success py-2 mb-3">';
    html += `<strong>✅ Test Simulation Complete!</strong> Found ${mockResults.length} classifications`;
    html += '<br><small class="text-muted">This demonstrates how your configuration would classify the sample articles</small>';
    html += '</div>';
    
    html += '<div class="row g-2">';
    mockResults.forEach((result, index) => {
        const typeColor = result.type === 'incident' ? 'danger' : 
                         result.type === 'entity' ? 'primary' : 'success';
        const sigColor = result.significance === 'high' ? 'danger' : 'warning';
        
        html += `
            <div class="col-md-4">
                <div class="card border-${typeColor} h-100">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0 small">${result.name}</h6>
                            <div>
                                <span class="badge bg-${typeColor}">${result.type}</span>
                                <span class="badge bg-${sigColor}">${result.significance}</span>
                            </div>
                        </div>
                        <p class="card-text small text-muted mb-2">${result.description}</p>
                        <div class="mb-2">
                            <small class="text-muted fw-bold">Leads:</small>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                ${result.investigation_leads.map(lead => `
                                    <span class="badge bg-light text-dark" style="font-size: 9px;">${lead}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    // Add summary stats
    const incidentCount = mockResults.filter(r => r.type === 'incident').length;
    const entityCount = mockResults.filter(r => r.type === 'entity').length; 
    const eventCount = mockResults.filter(r => r.type === 'event').length;
    
    html += `
        <div class="mt-3 alert alert-light">
            <div class="row text-center">
                <div class="col-4">
                    <div class="h5 text-danger mb-0">${incidentCount}</div>
                    <small class="text-muted">Incidents</small>
                </div>
                <div class="col-4">
                    <div class="h5 text-primary mb-0">${entityCount}</div>
                    <small class="text-muted">Entities</small>
                </div>
                <div class="col-4">
                    <div class="h5 text-success mb-0">${eventCount}</div>
                    <small class="text-muted">Events</small>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
    showNotification('Test simulation completed successfully!', 'success');
}

// Run another test helper
function runAnotherTest() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('testResultsModal'));
    if (modal) modal.hide();
    setTimeout(() => testWithSampleArticles(), 500);
}

// Show guidance examples
function showGuidanceExamples() {
    const examples = `
ANALYSIS QUALITY EXAMPLES:

Good Analysis:
- "Patent lawsuit filed by TechCorp against StartupAI for alleged IP infringement of neural network architecture patents filed 2019-2021"
- Significance: high (potential injunction could halt product development)
- Investigation leads: ["TechCorp patent portfolio analysis", "StartupAI product roadmap impact"]

Poor Analysis:
- "Legal issue between companies"
- Significance: unknown
- Investigation leads: []

CLASSIFICATION EXAMPLES:

Incident (Material Impact):
- Data breach exposing customer information
- Regulatory action resulting in fines
- Major layoffs or restructuring
- Significant funding cuts

Event (Informational):
- Product feature announcement
- Conference presentation
- Partnership MOU signing
- Award recognition
`;

    // Show examples in modal
    const examplesModal = document.createElement('div');
    examplesModal.innerHTML = `
        <div class="modal fade" id="guidanceExamplesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Analysis Guidance Examples</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <pre style="white-space: pre-wrap; font-size: 12px;">${examples}</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(examplesModal);
    const modal = new bootstrap.Modal(examplesModal.querySelector('.modal'));
    modal.show();
    
    // Clean up when modal is closed
    examplesModal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(examplesModal);
    });
}

// Get the currently selected organizational profile
async function getCurrentOrganizationalProfile() {
    try {
        const profileSelect = document.getElementById('profile-select');
        if (!profileSelect || !profileSelect.value) {
            return null;
        }
        
        const profileId = profileSelect.value;
        const response = await fetch('/api/organizational-profiles');
        const data = await response.json();
        
        if (data.success && data.profiles) {
            const profile = data.profiles.find(p => p.id.toString() === profileId);
            if (profile) {
                console.log('Found current organizational profile:', profile.name);
                return profile;
            }
        }
        
        return null;
    } catch (error) {
        console.error('Error getting current organizational profile:', error);
        return null;
    }
}

// Generate profile context from profile data
function generateProfileContextFromData(profile) {
    if (!profile) return DEFAULT_PROFILE_CONTEXT_TEMPLATE;
    
    // Convert arrays to comma-separated strings
    const keyConcerns = Array.isArray(profile.key_concerns) ? profile.key_concerns.join(', ') : (profile.key_concerns || '');
    const strategicPriorities = Array.isArray(profile.strategic_priorities) ? profile.strategic_priorities.join(', ') : (profile.strategic_priorities || '');
    const stakeholderFocus = Array.isArray(profile.stakeholder_focus) ? profile.stakeholder_focus.join(', ') : (profile.stakeholder_focus || '');
    const competitiveLandscape = Array.isArray(profile.competitive_landscape) ? profile.competitive_landscape.join(', ') : (profile.competitive_landscape || '');
    const regulatoryEnvironment = Array.isArray(profile.regulatory_environment) ? profile.regulatory_environment.join(', ') : (profile.regulatory_environment || '');
    
    return `ORGANIZATIONAL CONTEXT:
Organization: ${profile.name} (${profile.organization_type || 'Organization'} in ${profile.industry || 'General'})
Region: ${profile.region || 'Not specified'}
Risk Tolerance: ${profile.risk_tolerance || 'Medium'} | Innovation Appetite: ${profile.innovation_appetite || 'Moderate'}
Decision Making: ${profile.decision_making_style || 'Collaborative'}

Key Concerns: ${keyConcerns || 'General business concerns'}
Strategic Priorities: ${strategicPriorities || 'Growth and sustainability'}
Key Stakeholders: ${stakeholderFocus || 'Customers and employees'}
Competitive Landscape: ${competitiveLandscape || 'Industry competitors'}
Regulatory Environment: ${regulatoryEnvironment || 'Standard regulations'}

Custom Context: ${profile.custom_context || 'No additional context specified'}

ANALYSIS INSTRUCTIONS:
- Prioritize incidents and events that align with ${profile.name}'s key concerns: ${keyConcerns}
- Assess significance based on ${profile.risk_tolerance || 'medium'} risk tolerance and ${profile.decision_making_style || 'collaborative'} decision-making style
- Consider impact on key stakeholders: ${stakeholderFocus}
- Account for competitive positioning relative to: ${competitiveLandscape}
- Evaluate regulatory implications considering: ${regulatoryEnvironment}
- Tailor investigation leads to ${profile.industry || 'industry'} context and organizational priorities`;
}

// Show current profile information in the modal
function showCurrentProfileInfo(profile) {
    // Add profile info section to the modal if profile exists
    const promptPanel = document.getElementById('prompt-panel');
    if (promptPanel && profile) {
        // Check if profile info already exists
        let profileInfo = promptPanel.querySelector('.current-profile-info');
        if (!profileInfo) {
            profileInfo = document.createElement('div');
            profileInfo.className = 'current-profile-info alert alert-success py-2 mb-3';
            promptPanel.insertBefore(profileInfo, promptPanel.firstChild);
        }
        
        profileInfo.innerHTML = `
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <strong><i class="fas fa-building me-2"></i>Using Profile: ${profile.name}</strong>
                    <small class="d-block text-muted">${profile.industry || 'General'} • ${profile.organization_type || 'Organization'} • ${profile.risk_tolerance || 'Medium'} Risk Tolerance</small>
                </div>
                <button class="btn btn-outline-success btn-sm" onclick="refreshProfileIntegration()" title="Refresh profile integration">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
            </div>
        `;
    } else if (promptPanel) {
        // Remove profile info if no profile selected
        const existingInfo = promptPanel.querySelector('.current-profile-info');
        if (existingInfo) {
            existingInfo.remove();
        }
    }
}

// Incident view and sorting functions
let currentIncidentView = 'cards';
let currentIncidentSort = 'significance_desc';

function toggleIncidentView(viewType) {
    currentIncidentView = viewType;
    
    // Update button states
    document.getElementById('incident-card-view-btn').classList.toggle('active', viewType === 'cards');
    document.getElementById('incident-table-view-btn').classList.toggle('active', viewType === 'table');
    
    // Re-render with current view
    if (allIncidents.length > 0) {
        const filteredIncidents = applyIncidentFilters(allIncidents);
        renderIncidentTrackingFiltered(filteredIncidents);
    }
}

function handleIncidentSortChange() {
    currentIncidentSort = document.getElementById('incident-sort-select').value;
    
    // Re-render with new sort order
    if (allIncidents.length > 0) {
        const filteredIncidents = applyIncidentFilters(allIncidents);
        renderIncidentTrackingFiltered(filteredIncidents);
    }
}

function sortIncidents(incidents) {
    return incidents.sort((a, b) => {
        switch (currentIncidentSort) {
            case 'significance_desc':
                const sigOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                return (sigOrder[b.significance] || 0) - (sigOrder[a.significance] || 0);
            case 'significance_asc':
                const sigOrderAsc = { 'high': 3, 'medium': 2, 'low': 1 };
                return (sigOrderAsc[a.significance] || 0) - (sigOrderAsc[b.significance] || 0);
            case 'type_asc':
                return (a.type || '').localeCompare(b.type || '');
            case 'type_desc':
                return (b.type || '').localeCompare(a.type || '');
            case 'name_asc':
                return (a.name || '').localeCompare(b.name || '');
            case 'name_desc':
                return (b.name || '').localeCompare(a.name || '');
            case 'entity_asc':
                const entityA = extractPrimaryEntity(a);
                const entityB = extractPrimaryEntity(b);
                return entityA.localeCompare(entityB);
            case 'entity_desc':
                const entityDescA = extractPrimaryEntity(a);
                const entityDescB = extractPrimaryEntity(b);
                return entityDescB.localeCompare(entityDescA);
            case 'timeline_desc':
                const aDate = Array.isArray(a.timeline) && a.timeline.length > 0 ? new Date(a.timeline[0]) : new Date(0);
                const bDate = Array.isArray(b.timeline) && b.timeline.length > 0 ? new Date(b.timeline[0]) : new Date(0);
                return bDate - aDate;
            case 'timeline_asc':
                const aDateAsc = Array.isArray(a.timeline) && a.timeline.length > 0 ? new Date(a.timeline[0]) : new Date(0);
                const bDateAsc = Array.isArray(b.timeline) && b.timeline.length > 0 ? new Date(b.timeline[0]) : new Date(0);
                return aDateAsc - bDateAsc;
            default:
                return 0;
        }
    });
}

function renderIncidentTable(incidents) {
    const container = document.getElementById('incident-tracking-container');

    if (!incidents || incidents.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No incidents match the current filters.</div>';
        return;
    }

    // Check if we should group by entity (when entity sorting is selected)
    const sortSelect = document.getElementById('incident-sort-select');
    const currentSort = sortSelect ? sortSelect.value : 'significance_desc';
    const groupByEntity = currentSort.startsWith('entity_');

    console.log('Table render - Sort:', currentSort, 'Group by entity:', groupByEntity, 'View:', currentIncidentView);

    if (groupByEntity) {
        renderTableGroupedByEntity(incidents, container);
    } else {
        renderTableUngrouped(incidents, container);
    }
}

function renderTableGroupedByEntity(incidents, container) {
    // Group incidents by entity
    console.log('Grouping incidents for table view:', incidents.length);
    const entityGroups = groupIncidentsByEntity(incidents);
    console.log('Created entity groups:', entityGroups.length, entityGroups);

    let html = `
        <div class="table-responsive" style="max-height: 80vh; overflow-y: auto;">
            <table class="table table-hover table-sm" style="min-width: 1400px;">
                <thead class="table-light sticky-top">
                    <tr>
                        <th style="width: 250px; min-width: 250px;">Entity/Incident</th>
                        <th style="width: 80px; min-width: 80px;">Type</th>
                        <th style="width: 90px; min-width: 90px;">Significance</th>
                        <th style="width: 120px; min-width: 120px;">Timeline</th>
                        <th style="width: 140px; min-width: 140px;">MBFC Quality</th>
                        <th style="width: 400px; min-width: 400px;">Description</th>
                        <th style="width: 120px; min-width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    entityGroups.forEach((group, groupIndex) => {
        // Entity group header row
        const significanceBadgeColor = group.maxSignificance === 'high' ? 'danger' :
                                     group.maxSignificance === 'medium' ? 'warning' : 'info';

        html += `
            <tr class="table-primary" style="background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);">
                <td colspan="8">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-building me-2"></i>
                            <strong>${escapeHTML(group.entityName)}</strong>
                            <span class="badge bg-${significanceBadgeColor} ms-2">${group.maxSignificance.toUpperCase()}</span>
                            <small class="text-muted ms-2">
                                ${group.incidents.length} incident${group.incidents.length !== 1 ? 's' : ''} •
                                ${group.totalArticles} article${group.totalArticles !== 1 ? 's' : ''}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTableGroupExpansion('entity-group-${groupIndex}')">
                            <i class="fas fa-chevron-down" id="entity-group-${groupIndex}-icon"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;

        // Entity incidents (collapsible)
        html += `<tbody id="entity-group-${groupIndex}" class="collapse show">`;

        group.incidents.forEach(incident => {
            html += renderTableRow(incident, true);
        });

        html += `</tbody>`;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // Initialize Bootstrap tooltips
    setTimeout(() => {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }, 100);
}

function renderTableUngrouped(incidents, container) {
    let html = `
        <div class="table-responsive" style="max-height: 80vh; overflow-y: auto;">
            <table class="table table-hover table-sm" style="min-width: 1400px;">
                <thead class="table-light sticky-top">
                    <tr>
                        <th style="width: 250px; min-width: 250px;">Name</th>
                        <th style="width: 80px; min-width: 80px;">Type</th>
                        <th style="width: 90px; min-width: 90px;">Significance</th>
                        <th style="width: 120px; min-width: 120px;">Timeline</th>
                        <th style="width: 140px; min-width: 140px;">MBFC Quality</th>
                        <th style="width: 400px; min-width: 400px;">Description</th>
                        <th style="width: 120px; min-width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    incidents.forEach((incident, index) => {
        html += renderTableRow(incident, false);
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // Initialize Bootstrap tooltips
    setTimeout(() => {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }, 100);
}

// Render individual table row
function renderTableRow(incident, isGrouped = false) {
    const typeBadgeColor = incident.type === 'incident' ? 'danger' :
                          incident.type === 'entity' ? 'primary' :
                          incident.type === 'expertise' ? 'warning' :
                          incident.type === 'informed_insider' ? 'dark' :
                          incident.type === 'trend_signal' ? 'info' :
                          incident.type === 'strategic_shift' ? 'secondary' : 'success';
    const significanceBadgeColor = incident.significance === 'high' ? 'danger' :
                                 incident.significance === 'medium' ? 'warning' : 'info';

    const plausibility = String(incident.plausibility || '').toLowerCase();
    const sourceQuality = String(incident.source_quality || '').toLowerCase();

    // Helper function to format dates to human-readable format
    function formatTimelineDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return dateStr;

        // Check if it looks like an ISO date (contains T and ends with Z or timezone)
        if (dateStr.includes('T') && (dateStr.endsWith('Z') || /[+-]\d{2}:\d{2}$/.test(dateStr))) {
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {
                console.warn('Error formatting date:', dateStr, e);
            }
        }

        return dateStr; // Return original if not a recognizable ISO date
    }

    // Timeline display - handle both arrays and strings with date formatting
    let timelineDisplay = '';
    if (Array.isArray(incident.timeline) && incident.timeline.length > 0) {
        const validDates = incident.timeline.filter(Boolean);
        if (validDates.length > 0) {
            const start = formatTimelineDate(validDates[0]);
            const end = formatTimelineDate(validDates[validDates.length - 1]);
            timelineDisplay = start === end ? start : `${start} → ${end}`;
        }
    } else if (typeof incident.timeline === 'string' && incident.timeline.trim()) {
        timelineDisplay = formatTimelineDate(incident.timeline.trim());
    } else if (incident.timeline && incident.timeline.summary) {
        timelineDisplay = formatTimelineDate(incident.timeline.summary);
    }

    // MBFC Quality indicators - consistent format for both real and AI-derived
    let qualityHtml = '';
    let hasRealMBFC = false;
    let isLowQuality = false;

    // Check if we have real MBFC data
    if (incident.article_uris && incident.article_uris.length > 0) {
        const firstUri = incident.article_uris[0];
        const article = window.lastArticlesData?.items?.find(a => a.uri === firstUri);
        if (article && (article.factual_reporting || article.mbfc_credibility_rating || article.bias)) {
            hasRealMBFC = true;

            // Check for low quality indicators
            const factual = (article.factual_reporting || '').toLowerCase();
            const mbfc = (article.mbfc_credibility_rating || '').toLowerCase();
            const bias = (article.bias || '').toLowerCase();

            isLowQuality = factual.includes('low') || factual.includes('mixed') ||
                          mbfc.includes('low') || mbfc.includes('mixed') ||
                          bias.includes('extreme') || bias.includes('conspiracy') || bias.includes('fringe');

            // Consistent badge format for real MBFC data with full labels
            const factualBadge = article.factual_reporting ?
                `<span class="badge ${getFactualityClass(article.factual_reporting)}" title="MBFC Factual Reporting">${article.factual_reporting}</span>` : '';
            const mbfcBadge = article.mbfc_credibility_rating ?
                `<span class="badge ${getMBFCCredibilityClass(article.mbfc_credibility_rating)}" title="MBFC Credibility Rating">${article.mbfc_credibility_rating}</span>` : '';
            const biasBadge = article.bias ?
                `<span class="badge ${getBiasClass(article.bias)}" title="MBFC Bias Rating">${article.bias}</span>` : '';

            qualityHtml = [factualBadge, mbfcBadge, biasBadge].filter(Boolean).join('<br>');
        } else {
            // Article found but no MBFC data - flag as AI-rated
            hasRealMBFC = false;
        }
    }

    // AI-derived quality if no real MBFC data - use same format as MBFC
    if (!hasRealMBFC) {
        // Check if AI-derived quality indicates low quality
        isLowQuality = sourceQuality === 'low' || plausibility === 'implausible' ||
                      (Array.isArray(incident.misinfo_flags) && incident.misinfo_flags.some(f =>
                          f.includes('low_factuality') || f.includes('low_credibility') || f.includes('fringe_bias')));

        // Convert AI-derived ratings to MBFC-equivalent format with proper capitalization
        const aiFactualRating = sourceQuality === 'high' ? 'High' :
                               sourceQuality === 'mixed' ? 'Mixed' : 'Low';
        const aiCredibilityRating = plausibility === 'likely' ? 'High' :
                                   plausibility === 'questionable' ? 'Mixed' : 'Low';
        let aiBiasRating = 'Least Biased'; // Default assumption unless flags indicate otherwise

        // Check for bias flags
        if (Array.isArray(incident.misinfo_flags) && incident.misinfo_flags.some(f => f.includes('fringe_bias'))) {
            aiBiasRating = 'Mixed Bias';
        }

        // Use same badge format as real MBFC but with AI indicator
        const factualBadge = `<span class="badge ${getFactualityClass(aiFactualRating)}" title="📊 AI-derived factual assessment (no MBFC data)">📊 ${aiFactualRating}</span>`;
        const credibilityBadge = `<span class="badge ${getMBFCCredibilityClass(aiCredibilityRating)}" title="📊 AI-derived credibility assessment (no MBFC data)">📊 ${aiCredibilityRating}</span>`;
        const biasBadge = `<span class="badge ${getBiasClass(aiBiasRating)}" title="📊 AI-derived bias assessment (no MBFC data)">📊 ${aiBiasRating}</span>`;

        qualityHtml = [factualBadge, credibilityBadge, biasBadge].join('<br>');
    }

    const status = incident.status || 'active';
    let rowClass = status === 'seen' ? 'opacity-75' : '';

    // Add highlighting for low quality incidents in table view
    if (isLowQuality) {
        rowClass += ' table-danger';
    }

    // Why significant explanation
    const whySignificant = incident.organizational_relevance ||
                          incident.credibility_summary ||
                          `${incident.significance || 'medium'} significance incident`;

    const namePrefix = isGrouped ? '&nbsp;&nbsp;↳ ' : '';

    return `
        <tr class="${rowClass}">
            <td>
                ${namePrefix}<strong>${escapeHTML(incident.name || 'Unnamed Incident')}</strong>
                ${status === 'seen' ? `<br><span class="badge bg-secondary"><i class="fas fa-eye me-1"></i>Seen</span>` : ''}
            </td>
            <td><span class="badge bg-${typeBadgeColor}">${incident.type || 'Unknown'}</span></td>
            <td><span class="badge bg-${significanceBadgeColor}">${incident.significance || 'Unknown'}</span></td>
            <td><small>${timelineDisplay || 'No timeline'}</small></td>
            <td>${qualityHtml || '<small class="text-muted">No quality data</small>'}</td>
            <td>
                <div data-bs-toggle="tooltip" data-bs-placement="top" title="${escapeHTML(whySignificant)}" style="cursor: help;">
                    <small>${escapeHTML((incident.description || 'No description available.').substring(0, 80))}${(incident.description || '').length > 80 ? '...' : ''}</small>
                    ${incident.article_uris && incident.article_uris.length > 0 ? `
                        <br><a href="${incident.article_uris[0]}" target="_blank" rel="noopener" class="small text-primary text-decoration-none">
                            <i class="fas fa-external-link-alt me-1"></i>View Article
                        </a>
                    ` : ''}
                </div>
            </td>
            <td>
                <div class="d-grid gap-1" style="grid-template-columns: 1fr 1fr; max-width: 120px;">
                    <button class="btn btn-outline-primary btn-sm" onclick="launchAuspexResearchFromInsight('${escapeHTML(incident.name)}', 'incident')" title="Investigate">
                        <i class="fas fa-search"></i>
                    </button>
                    ${incident.article_uris && incident.article_uris.length > 0 ? `
                        <button class="btn btn-outline-success btn-sm" onclick="openAnnotationModal('${incident.article_uris[0]}')" title="Annotate">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                    ` : `
                        <div></div>
                    `}
                    ${status !== 'seen' ? `
                        <button class="btn btn-outline-info btn-sm" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'seen')" title="Mark as seen">
                            <i class="fas fa-eye"></i>
                        </button>
                    ` : `
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'active')" title="Mark as unseen">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    `}
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteIncident('${escapeHTML(incident.name)}')" title="Delete incident">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// Table group expansion toggle
function toggleTableGroupExpansion(groupId) {
    const groupBody = document.getElementById(groupId);
    const icon = document.getElementById(groupId + '-icon');

    if (groupBody.classList.contains('show')) {
        groupBody.classList.remove('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    } else {
        groupBody.classList.add('show');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    }
}

// Refresh profile integration
async function refreshProfileIntegration() {
    try {
        showNotification('Refreshing organizational profile integration...', 'info');
        
        const currentProfile = await getCurrentOrganizationalProfile();
        if (currentProfile) {
            // Update the profile context template with current profile data
            const generatedContext = generateProfileContextFromData(currentProfile);
            document.getElementById('profileContextTemplate').value = generatedContext;
            
            // Update the profile info display
            showCurrentProfileInfo(currentProfile);
            
            showNotification(`Profile integration updated: ${currentProfile.name}`, 'success');
        } else {
            // Reset to default template if no profile selected
            document.getElementById('profileContextTemplate').value = DEFAULT_PROFILE_CONTEXT_TEMPLATE;
            showCurrentProfileInfo(null);
            
            showNotification('No profile selected - using default template', 'info');
        }
    } catch (error) {
        console.error('Error refreshing profile integration:', error);
        showNotification('Failed to refresh profile integration: ' + error.message, 'error');
    }
}

</script>

{% endblock %}