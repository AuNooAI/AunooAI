{% extends 'base.html' %}
{% block title %}Daily News Feed{% endblock %}

{% block content %}
<style>
/* Techmeme-inspired minimalist design */
.news-feed-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}

.news-header {
    border-bottom: 3px solid #000;
    margin-bottom: 30px;
    padding-bottom: 15px;
}

.news-title {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0;
    color: #000;
}

.news-date {
    font-size: 0.9rem;
    color: #666;
    margin-top: 5px;
}

.news-nav {
    margin: 20px 0;
    border-bottom: 1px solid #ddd;
}

.nav-tabs {
    border-bottom: none;
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #666;
    font-weight: 500;
    padding: 10px 20px;
    background: none;
}

.nav-tabs .nav-link.active {
    border-bottom-color: #000;
    color: #000;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #999;
    color: #333;
}

.story-item {
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 1px solid #eee;
}

.story-item:last-child {
    border-bottom: none;
}

.story-headline {
    font-size: 1.4rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 10px;
    color: #000;
}

.story-headline a {
    color: inherit;
    text-decoration: none;
}

.story-headline a:hover {
    color: #0066cc;
}

.story-summary {
    font-size: 1rem;
    color: #333;
    margin-bottom: 15px;
}

.story-meta {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 10px;
}

.source-info {
    display: inline-block;
    margin-right: 15px;
}

.bias-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 5px;
}

.bias-left { background: #e3f2fd; color: #1976d2; }
.bias-left-center { background: #e8f5e8; color: #388e3c; }
.bias-center { background: #f3e5f5; color: #7b1fa2; }
.bias-right-center { background: #fff3e0; color: #f57c00; }
.bias-right { background: #ffebee; color: #d32f2f; }
.bias-mixed { background: #f5f5f5; color: #616161; }

.factuality-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 5px;
}

.factuality-very-high { background: #e8f5e8; color: #2e7d32; }
.factuality-high { background: #e8f5e8; color: #388e3c; }
.factuality-mostly-factual { background: #f3e5f5; color: #7b1fa2; }
.factuality-mixed { background: #fff3e0; color: #f57c00; }
.factuality-low { background: #ffebee; color: #d32f2f; }

.related-articles {
    margin-top: 15px;
    padding-left: 20px;
    border-left: 3px solid #eee;
}

.related-articles h6 {
    font-size: 0.85rem;
    font-weight: 600;
    color: #666;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.related-item {
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.related-item a {
    color: #0066cc;
    text-decoration: none;
}

.related-item a:hover {
    text-decoration: underline;
}

.controls {
    background: var(--bs-light);
    padding: 1rem;
    border-radius: var(--bs-border-radius);
    margin-bottom: 2rem;
}

.controls-row {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.control-group-inline {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.control-group-inline label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--bs-dark);
    margin: 0;
    white-space: nowrap;
}

.selected-date-compact {
    font-size: 0.9rem;
    color: var(--bs-primary);
    margin-right: 0.5rem;
}

/* Bootstrap-based Calendar Styles */
#calendar-container {
    max-width: 400px;
    width: 100%;
    margin-top: 8px;
}

#calendar-view {
    max-width: 100%;
}

.calendar-month {
    margin-bottom: 1rem;
}

.calendar-month-header {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--bs-dark);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--bs-border-color);
    text-align: center;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 0.5rem;
    width: 100%;
    max-width: 350px;
}

.calendar-day-header {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--bs-secondary);
    padding: 0.25rem;
    background-color: var(--bs-light);
    border-radius: var(--bs-border-radius-sm);
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    border-radius: var(--bs-border-radius);
    cursor: default;
    position: relative;
    min-height: 32px;
    border: 1px solid transparent;
}

.calendar-day.has-articles {
    background-color: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
    cursor: pointer;
    font-weight: 600;
    border: 1px solid var(--bs-primary-border-subtle);
}

.calendar-day.has-articles:hover {
    background-color: var(--bs-primary);
    color: var(--bs-white);
    transform: scale(1.05);
    transition: all 0.15s ease-in-out;
}

.calendar-day.selected {
    background-color: var(--bs-primary) !important;
    color: var(--bs-white) !important;
    border-color: var(--bs-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

.calendar-day.other-month {
    color: var(--bs-secondary);
    opacity: 0.5;
}

.calendar-day.has-articles .badge {
    position: absolute;
    bottom: 1px;
    right: 1px;
    font-size: 0.6rem;
    padding: 0.1rem 0.25rem;
    line-height: 1;
}

.calendar-day.selected .badge {
    background-color: var(--bs-white) !important;
    color: var(--bs-primary) !important;
}

/* Old control-group styles removed - now using control-group-inline */

.form-select, .form-control {
    font-size: 0.9rem;
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.btn {
    font-size: 0.9rem;
    padding: 6px 12px;
    border-radius: 3px;
    font-weight: 500;
}

.btn-primary {
    background: #000;
    border-color: #000;
}

.btn-primary:hover {
    background: #333;
    border-color: #333;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.error-message {
    background: #ffebee;
    color: #c62828;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.executive-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 30px;
    border-left: 4px solid #000;
}

.key-themes {
    margin-bottom: 30px;
}

.key-themes h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: #000;
}

.theme-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.theme-tag {
    background: #e9ecef;
    color: #495057;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 500;
}

.perspective-breakdown {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
}

.perspective-breakdown h6 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: #000;
}

.perspective-item {
    margin-bottom: 8px;
    font-size: 0.85rem;
}

.perspective-label {
    font-weight: 600;
    text-transform: capitalize;
    margin-right: 8px;
}

@media (max-width: 768px) {
    .news-feed-container {
        padding: 15px;
    }
    
    .news-title {
        font-size: 1.8rem;
    }
    
    .story-headline {
        font-size: 1.2rem;
    }
    
    .controls-row {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .control-group-inline {
        justify-content: space-between;
        width: 100%;
    }
    
    .control-group-inline input,
    .control-group-inline select {
        width: auto !important;
        flex: 1;
        margin-left: 1rem;
    }
    }

    /* Add styles for metadata tags like topic_dashboard.html */
    .metadata-tag {
        display: inline-block;
        padding: 0.2em 0.6em;
        margin-right: 0.3em;
        margin-bottom: 0.3em;
        font-size: 0.75em;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        border: 1px solid transparent;
    }

    .tag-category {
        background-color: #e6f3ff;
        color: #0066cc;
        border-color: #99ccff;
    }

    .tag-driver {
        background-color: #fff0e6;
        color: #cc6600;
        border-color: #ffcc99;
    }

    .tag-tti {
        background-color: #f0f0ff;
        color: #4b0082;
        border-color: #c0c0ff;
    }

    .tag-sentiment {
        border-width: 1px;
        border-style: solid;
    }

    .sentiment-critical {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .sentiment-hyperbolic {
        background-color: #fffae6;
        color: #997a00;
        border-color: #ffe680;
    }

    .sentiment-mixed {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }

    .sentiment-positive { background-color: #d1e7dd; color: #0a5132; border: 1px solid #a3cfbb; }
    .sentiment-negative { background-color: #f8d7da; color: #842029; border: 1px solid #f1aeb5; }
    .sentiment-neutral { background-color: #e2e3e5; color: #41464b; border: 1px solid #c3c6ca; }
    .sentiment-unknown { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }

    /* Bias tags */
    .tag-bias-left {
        background-color: #e6f2ff;
        color: #0066cc;
        border-color: #99ccff;
    }

    .tag-bias-right {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .tag-bias-center {
        background-color: #f0f0ff;
        color: #4b0082;
        border-color: #c0c0ff;
    }

    .tag-bias-factual {
        background-color: #e6ffe6;
        color: #006600;
        border-color: #99ff99;
    }

    .tag-bias-unknown {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }

    /* Factual reporting tags */
    .tag-factual-high {
        background-color: #e6ffe6;
        color: #006600;
        border-color: #99ff99;
    }

    .tag-factual-mostly {
        background-color: #f0fff0;
        color: #228b22;
        border-color: #90ee90;
    }

    .tag-factual-mixed {
        background-color: #fffae6;
        color: #997a00;
        border-color: #ffe680;
    }

    .tag-factual-low {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .tag-factual-unknown {
        background-color: #f9f9f9;
        color: #666666;
        border-color: #dddddd;
    }
</style>

<div class="news-feed-container">
    <!-- Header -->
    <div class="news-header">
        <h1 class="news-title">Daily News Feed</h1>
        <div class="news-date" id="current-date"></div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="controls-row">
            <div class="control-group-inline">
                <label class="form-label">Date Range:</label>
                <select id="date-range-select" class="form-select form-select-sm" style="width: 140px;" onchange="handleDateRangeChange()">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="3m">Last 3 Months</option>
                    <option value="1y">Last Year</option>
                    <option value="all">All Time</option>
                    <option value="custom">Custom Date</option>
                </select>
            </div>
            <div class="control-group-inline">
                <div id="date-range-display" class="selected-date-compact">
                    <i class="fas fa-clock"></i> <strong id="date-range-text">Last 24 Hours</strong> 
                    (<span id="selected-date-count">loading...</span> articles)
                </div>
                <div id="custom-date-section" style="display: none;" class="mt-1">
                    <input type="date" id="custom-date-input" class="form-control form-control-sm" value="2025-09-15" style="width: 160px;">
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-1" data-bs-toggle="collapse" data-bs-target="#calendar-collapse">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                </div>
            </div>
            <div class="control-group-inline">
                <label for="topic-input" class="form-label">Topic:</label>
                <input type="text" id="topic-input" class="form-control form-control-sm" placeholder="Optional filter" style="width: 150px;" />
            </div>
            <div class="control-group-inline">
                <label for="model-select" class="form-label">Model:</label>
                <select id="model-select" class="form-select form-select-sm" style="width: 140px;">
                    <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                    <option value="gpt-4.1">GPT-4.1</option>
                    <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                    <option value="claude-4-sonnet-latest">Claude 4 Sonnet</option>
                    <option value="claude-3-5-sonnet-latest">Claude 3.5 Sonnet</option>
                    <option value="gemini-pro">Gemini Pro</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="profile-select" class="form-label">Organizational Profile:</label>
                <div class="d-flex gap-2">
                    <select id="profile-select" class="form-select form-select-sm" style="width: 200px;">
                        <option value="">General Analysis (No Profile)</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadOrganizationalProfiles()" title="Refresh Profiles">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                <div class="form-text">
                    <small class="text-muted">Select for contextualized analysis based on your organization's needs.</small>
                </div>
            </div>
            <div class="control-group-inline">
                <button id="generate-btn" class="btn btn-primary">Generate Feed</button>
                <button id="save-btn" class="btn btn-outline-primary" onclick="saveFeed()" style="display: none;" title="Save current feed">
                    <i class="fas fa-save"></i> Save Feed
                </button>
                <button id="saved-feeds-btn" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#savedFeedsModal">
                    <i class="fas fa-bookmark"></i> Saved Feeds
                </button>
                <button id="restore-articles-btn" class="btn btn-outline-warning" onclick="clearExcludedArticles()" style="display: none;" title="Restore hidden articles">
                    <i class="fas fa-undo"></i> Restore Hidden
                </button>
                <button id="export-markdown-btn" class="btn btn-outline-success" onclick="exportToMarkdown()" style="display: none;" title="Export as Markdown">
                    <i class="fas fa-download"></i> Export MD
                </button>
            </div>
        </div>
        
        <!-- Collapsible Calendar -->
        <div class="collapse mt-3" id="calendar-collapse">
            <div class="card" style="max-width: 400px;">
                <div class="card-body">
                    <div id="calendar-loading" class="text-center text-muted p-3">
                        <i class="fas fa-spinner fa-spin"></i> Loading available dates...
                    </div>
                    <div id="calendar-view" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <input type="hidden" id="selected-date" value="2025-09-15" />
    </div>

    <!-- Navigation -->
    <div class="news-nav">
        <ul class="nav nav-tabs" id="news-tabs">
            <li class="nav-item">
                <a class="nav-link active" id="articles-tab" data-bs-toggle="tab" href="#articles-content">Articles</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="six-articles-tab" data-bs-toggle="tab" href="#six-articles-content">Six Articles</a>
            </li>
        </ul>
    </div>

    <!-- Content -->
    <div class="tab-content" id="news-content">
        <!-- Articles Tab -->
        <div class="tab-pane fade show active" id="articles-content">
            <div id="articles-loading" class="loading" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Loading articles...</div>
            </div>
            <div id="articles-error" class="error-message" style="display: none;"></div>
            
            <!-- Filter Section -->
            <div id="articles-filters" class="mb-3" style="display: none;">
                <div class="d-flex flex-wrap gap-2 align-items-center p-2 bg-light rounded">
                    <span class="text-muted small fw-bold">Filter by:</span>
                    <div id="bias-filters" class="d-flex flex-wrap gap-1"></div>
                    <div id="factuality-filters" class="d-flex flex-wrap gap-1"></div>
                    <div id="category-filters" class="d-flex flex-wrap gap-1"></div>
                    <button class="btn btn-sm btn-outline-primary" onclick="improveQuality()" title="Filter to high-quality sources only">
                        <i class="fas fa-shield-alt"></i> Improve Quality
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()" title="Clear all filters">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            
            <div id="articles-list"></div>
            <nav aria-label="Article navigation">
                <ul class="pagination pagination-sm justify-content-center mt-3" id="articles-pagination">
                    <!-- Pagination controls will be added by JS -->
                </ul>
            </nav>
        </div>

        <!-- Six Articles Tab -->
        <div class="tab-pane fade" id="six-articles-content">
            <div id="six-articles-loading" class="loading" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Analyzing top articles...</div>
            </div>
            <div id="six-articles-error" class="error-message" style="display: none;"></div>
            <div id="six-articles-report"></div>
        </div>
    </div>
</div>

<!-- Save Feed Modal -->
<div class="modal fade" id="saveFeedModal" tabindex="-1" aria-labelledby="saveFeedModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveFeedModalLabel">Save News Feed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Save this news feed for later viewing:</p>
                <div class="mb-3">
                    <label for="feedNameInput" class="form-label">Feed Name:</label>
                    <input type="text" class="form-control" id="feedNameInput" placeholder="e.g., AI News Sept 12, 2025">
                </div>
                <div class="mb-3">
                    <label for="feedDescriptionInput" class="form-label">Description (optional):</label>
                    <textarea class="form-control" id="feedDescriptionInput" rows="3" placeholder="Brief description of this feed..."></textarea>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeArticles" checked>
                    <label class="form-check-label" for="includeArticles">
                        Include article list
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeSixArticles" checked>
                    <label class="form-check-label" for="includeSixArticles">
                        Include six articles analysis
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFeedBtn">Save Feed</button>
            </div>
        </div>
    </div>
</div>

<!-- Saved Feeds Modal -->
<div class="modal fade" id="savedFeedsModal" tabindex="-1" aria-labelledby="savedFeedsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savedFeedsModalLabel">Saved News Feeds</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="savedFeedsList">
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-bookmark fa-2x mb-3"></i>
                        <p>No saved feeds yet.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-danger" id="clearAllFeeds">Clear All</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize with the selected date (September 15, 2025)
    const selectedDateObj = new Date(2025, 8, 15); // September 15, 2025
    document.getElementById('current-date').textContent = selectedDateObj.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    // Generate button click handler
    document.getElementById('generate-btn').addEventListener('click', generateNewsFeed);

    // Tab change handlers
    document.getElementById('articles-tab').addEventListener('click', function() {
        if (!document.getElementById('articles-list').innerHTML.trim()) {
            loadArticles();
        }
    });

    document.getElementById('six-articles-tab').addEventListener('click', function() {
        if (!document.getElementById('six-articles-report').innerHTML.trim()) {
            loadSixArticles();
        }
    });

    // Don't auto-load articles to prevent freeze - user can click Generate Feed
    console.log('Initial article loading disabled to prevent freeze');
    
    // Show a helpful message in the articles area
    const articlesContainer = document.getElementById('articles-list');
    if (articlesContainer) {
        articlesContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Ready to Generate News Feed</h5>
                <p class="text-muted">Click "Generate Feed" to load articles for the selected date.</p>
            </div>
        `;
    }
    
    // Show a helpful message in the six articles area too
    const sixArticlesContainer = document.getElementById('six-articles-report');
    if (sixArticlesContainer) {
        sixArticlesContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-star fa-3x text-muted mb-3"></i>
                <h5>Six Articles Analysis</h5>
                <p class="text-muted">Generate a feed first, then click this tab to see the strategic analysis.</p>
            </div>
        `;
    }
    
    // Load saved feeds when modal is opened
    document.getElementById('savedFeedsModal').addEventListener('show.bs.modal', loadSavedFeeds);
    
    // Clear all feeds functionality
    document.getElementById('clearAllFeeds').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all saved feeds?')) {
            localStorage.removeItem('savedNewsFeeds');
            loadSavedFeeds();
        }
    });
    
    // Save feed functionality
    document.getElementById('saveFeedBtn').addEventListener('click', saveFeedFromModal);
});

function loadSavedFeeds() {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const container = document.getElementById('savedFeedsList');
    
    if (savedFeeds.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-bookmark fa-2x mb-3"></i>
                <p>No saved feeds yet.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    savedFeeds.forEach(feed => {
        const createdDate = new Date(feed.created).toLocaleDateString();
        const createdTime = new Date(feed.created).toLocaleTimeString();
        
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${escapeHTML(feed.name)}</h6>
                            ${feed.description ? `<p class="card-text small mb-2">${escapeHTML(feed.description)}</p>` : ''}
                            <p class="card-text small text-muted mb-2">
                                <i class="fas fa-calendar me-1"></i>Feed Date: ${feed.date}
                                ${feed.topic ? `<span class="ms-2"><i class="fas fa-tag me-1"></i>Topic: ${escapeHTML(feed.topic)}</span>` : ''}
                            </p>
                            <p class="card-text small text-muted mb-0">
                                <i class="fas fa-clock me-1"></i>Saved: ${createdDate} ${createdTime}
                                <span class="ms-2">
                                    ${feed.includeArticles ? '<i class="fas fa-list me-1"></i>Articles' : ''}
                                    ${feed.includeSixArticles ? '<i class="fas fa-star me-1 ms-2"></i>Analysis' : ''}
                                </span>
                            </p>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-3">
                            <button class="btn btn-outline-primary" onclick="loadSavedFeed(${feed.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-outline-success" onclick="exportSavedFeed(${feed.id})">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteSavedFeed(${feed.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function deleteSavedFeed(feedId) {
    if (confirm('Are you sure you want to delete this saved feed?')) {
        const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
        const filteredFeeds = savedFeeds.filter(feed => feed.id !== feedId);
        localStorage.setItem('savedNewsFeeds', JSON.stringify(filteredFeeds));
        loadSavedFeeds();
    }
}

function saveFeed() {
    // Open the save modal
    const saveModal = new bootstrap.Modal(document.getElementById('saveFeedModal'));
    
    // Pre-fill the name with date range and topic
    const dateRange = document.getElementById('date-range-select').value;
    const topic = document.getElementById('topic-input').value.trim();
    
    let formattedDate;
    if (dateRange === 'custom') {
        const customDate = document.getElementById('custom-date-input').value;
        if (customDate) {
            const dateObj = new Date(customDate);
            formattedDate = dateObj.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        } else {
            formattedDate = 'Custom Date';
        }
    } else {
        // Use the display text for date ranges
        const displayText = document.getElementById('date-range-text').textContent;
        formattedDate = displayText;
    }
    
    const defaultName = topic ? `${topic} - ${formattedDate}` : `News Feed - ${formattedDate}`;
    document.getElementById('feedNameInput').value = defaultName;
    
    saveModal.show();
}

function saveFeedFromModal() {
    const feedName = document.getElementById('feedNameInput').value.trim();
    const feedDescription = document.getElementById('feedDescriptionInput').value.trim();
    const includeArticles = document.getElementById('includeArticles').checked;
    const includeSixArticles = document.getElementById('includeSixArticles').checked;
    
    if (!feedName) {
        alert('Please enter a feed name');
        return;
    }
    
    if (!includeArticles && !includeSixArticles) {
        alert('Please select at least one content type to save');
        return;
    }
    
    // Collect current feed data
    const dateRange = document.getElementById('date-range-select').value;
    const selectedDate = dateRange === 'custom' ? 
        document.getElementById('custom-date-input').value || document.getElementById('selected-date').value :
        dateRange;
    const topic = document.getElementById('topic-input').value.trim();
    const model = document.getElementById('model-select').value;
    
    // Get articles data if requested
    let articlesData = null;
    if (includeArticles) {
        const articleElements = document.querySelectorAll('#articles-list .list-group-item');
        articlesData = Array.from(articleElements).map(element => {
            const title = element.querySelector('h6 a')?.textContent || 'Untitled';
            const url = element.querySelector('h6 a')?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summary = element.querySelector('.small')?.textContent || '';
            
            return { title, url, source, summary };
        });
    }
    
    // Get six articles data if requested
    let sixArticlesData = null;
    if (includeSixArticles) {
        const sixArticlesContainer = document.getElementById('six-articles-report');
        if (sixArticlesContainer && sixArticlesContainer.innerHTML.trim()) {
            const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
            sixArticlesData = Array.from(articles).map(article => {
                const title = article.querySelector('h4')?.textContent || 'Article';
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown';
                const sections = Array.from(article.querySelectorAll('.section')).map(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    return { title: sectionTitle, content: sectionContent };
                });
                return { title, source, sections };
            });
        }
    }
    
    // Create feed object
    const feedData = {
        id: Date.now(),
        name: feedName,
        description: feedDescription,
        date: selectedDate,
        date_range: dateRange,
        topic: topic,
        model: model,
        includeArticles: includeArticles,
        includeSixArticles: includeSixArticles,
        articlesData: articlesData,
        sixArticlesData: sixArticlesData,
        created: new Date().toISOString()
    };
    
    // Save to localStorage
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    savedFeeds.unshift(feedData);
    localStorage.setItem('savedNewsFeeds', JSON.stringify(savedFeeds));
    
    // Close modal and show success
    const saveModal = bootstrap.Modal.getInstance(document.getElementById('saveFeedModal'));
    saveModal.hide();
    
    showNotification(`Feed "${feedName}" saved successfully!`, 'success');
}

function loadSavedFeed(feedId) {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const feed = savedFeeds.find(f => f.id === feedId);
    
    if (!feed) {
        showNotification('Feed not found', 'danger');
        return;
    }
    
    // Set the date range and other parameters
    if (feed.date_range) {
        document.getElementById('date-range-select').value = feed.date_range;
        handleDateRangeChange(); // Update display
    } else {
        // Legacy feed - treat as custom date
        document.getElementById('date-range-select').value = 'custom';
        document.getElementById('custom-date-input').value = feed.date;
        document.getElementById('selected-date').value = feed.date;
        handleDateRangeChange();
    }
    
    if (feed.topic) document.getElementById('topic-input').value = feed.topic;
    document.getElementById('model-select').value = feed.model;
    
    // Load the saved data
    if (feed.includeArticles && feed.articlesData) {
        // Render saved articles
        renderSavedArticles(feed.articlesData);
    }
    
    if (feed.includeSixArticles && feed.sixArticlesData) {
        // Render saved six articles
        renderSavedSixArticles(feed.sixArticlesData);
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('savedFeedsModal'));
    modal.hide();
    
    showNotification(`Loaded feed: ${feed.name}`, 'success');
}

function exportSavedFeed(feedId) {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const feed = savedFeeds.find(f => f.id === feedId);
    
    if (!feed) {
        showNotification('Feed not found', 'danger');
        return;
    }
    
    // Generate markdown for saved feed
    let markdown = '';
    const dateObj = new Date(feed.date);
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Header
    markdown += `# ${feed.name}\n\n`;
    markdown += `**Date:** ${formattedDate}\n`;
    if (feed.topic) markdown += `**Topic:** ${feed.topic}\n`;
    if (feed.description) markdown += `**Description:** ${feed.description}\n`;
    markdown += `**Model:** ${feed.model}\n`;
    markdown += `**Saved:** ${new Date(feed.created).toLocaleString()}\n\n`;
    
    // Add six articles if included
    if (feed.includeSixArticles && feed.sixArticlesData) {
        markdown += `## Six Most Important Articles Analysis\n\n`;
        feed.sixArticlesData.forEach((article, index) => {
            markdown += `### ${index + 1}. ${article.title}\n\n`;
            markdown += `**Source:** ${article.source}\n\n`;
            
            article.sections.forEach(section => {
                if (section.title && section.content) {
                    markdown += `**${section.title}**\n\n${section.content}\n\n`;
                }
            });
            
            markdown += `---\n\n`;
        });
    }
    
    // Add articles if included
    if (feed.includeArticles && feed.articlesData) {
        markdown += `## Article List\n\n`;
        feed.articlesData.forEach((article, index) => {
            markdown += `### ${index + 1}. [${article.title}](${article.url})\n\n`;
            markdown += `**Source:** ${article.source}\n\n`;
            if (article.summary && article.summary.trim() !== 'No summary available.') {
                const cleanSummary = article.summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            markdown += `---\n\n`;
        });
    }
    
    downloadMarkdown(markdown, `${feed.name.replace(/[^a-zA-Z0-9]/g, '_')}_${feed.date}.md`);
}

function renderSavedArticles(articlesData) {
    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '';
    
    const articlesList = document.createElement('div');
    articlesList.className = 'list-group list-group-flush mt-2';
    
    articlesData.forEach(article => {
        const articleItem = document.createElement('div');
        articleItem.className = 'list-group-item';
        
        articleItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1"><a href="${article.url}" target="_blank" rel="noopener">${article.title}</a></h6>
                <small>Saved</small>
            </div>
            <p class="mb-1"><small class="text-muted">${article.source}</small></p>
            <p class="mb-1 small">${article.summary}</p>
        `;
        
        articlesList.appendChild(articleItem);
    });
    
    listContainer.appendChild(articlesList);
}

function renderSavedSixArticles(sixArticlesData) {
    const container = document.getElementById('six-articles-report');
    if (!container) return;
    
    let html = `
        <div class="six-articles-analysis">
            <h3>Strategic Analysis: Six Most Important Articles (Saved)</h3>
            <p class="mb-4">Previously saved analysis of the most important articles.</p>
        </div>
    `;
    
    sixArticlesData.forEach((article, index) => {
        html += `
            <div class="article-analysis mb-5 p-4 border rounded">
                <div class="article-header mb-3">
                    <h4 class="text-primary">${index + 1}. ${article.title}</h4>
                    <p class="text-muted mb-1"><strong>Source:</strong> ${article.source}</p>
                </div>
                <div class="article-content">
        `;
        
        article.sections.forEach(section => {
            if (section.title && section.content) {
                html += `
                    <div class="section mb-3">
                        <h6 class="text-secondary">${section.title}</h6>
                        <p>${section.content}</p>
                    </div>
                `;
            }
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Article exclusion functionality
let excludedArticles = new Set();
let currentArticlesPage = 1;

function excludeArticle(articleUri, buttonElement) {
    if (confirm('Remove this article from the current view?')) {
        // Add to excluded set
        excludedArticles.add(articleUri);
        
        // Find and hide the article element
        const articleElement = buttonElement.closest('.list-group-item');
        if (articleElement) {
            articleElement.style.transition = 'opacity 0.3s ease-out';
            articleElement.style.opacity = '0';
            setTimeout(() => {
                articleElement.remove();
                updateArticleCount();
                updateRestoreButton();
            }, 300);
        }
        
        // Show success message
        showNotification('Article removed from view', 'success');
    }
}

function updateRestoreButton() {
    const restoreBtn = document.getElementById('restore-articles-btn');
    if (restoreBtn) {
        if (excludedArticles.size > 0) {
            restoreBtn.style.display = 'inline-block';
            restoreBtn.innerHTML = `<i class="fas fa-undo"></i> Restore Hidden (${excludedArticles.size})`;
        } else {
            restoreBtn.style.display = 'none';
        }
    }
}

function updateArticleCount() {
    const remainingArticles = document.querySelectorAll('#articles-list .list-group-item').length;
    const countEl = document.getElementById('selected-date-count');
    if (countEl && remainingArticles > 0) {
        const originalText = countEl.textContent;
        const originalCount = parseInt(originalText) || 0;
        if (remainingArticles < originalCount) {
            countEl.textContent = `${remainingArticles} (${originalCount - remainingArticles} hidden)`;
        }
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) notification.remove();
    }, 3000);
}

function clearExcludedArticles() {
    if (excludedArticles.size > 0 && confirm(`Restore ${excludedArticles.size} hidden articles?`)) {
        excludedArticles.clear();
        updateRestoreButton();
        loadArticles(currentArticlesPage); // Reload current page
        showNotification('All articles restored', 'success');
    }
}

// Markdown export functionality
async function exportToMarkdown() {
    try {
    const selectedDate = document.getElementById('selected-date').value;
    const selectedModel = document.getElementById('model-select').value;
    const topic = document.getElementById('topic-input').value.trim();
    const profileId = document.getElementById('profile-select').value;
        
        // Get current tab to determine what to export
        const activeTab = document.querySelector('#news-tabs .nav-link.active');
        const isArticlesTab = activeTab.id === 'articles-tab';
        
        let markdown = '';
        const dateObj = new Date(selectedDate);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Header
        markdown += `# Daily News Feed\n\n`;
        markdown += `**Date:** ${formattedDate}\n`;
        if (topic) markdown += `**Topic Filter:** ${topic}\n`;
        markdown += `**Generated:** ${new Date().toLocaleString()}\n`;
        markdown += `**Model:** ${selectedModel}\n\n`;
        
        // Export both six articles and article list
        await exportCombinedContent(markdown);
        
    } catch (error) {
        console.error('Error exporting to markdown:', error);
        showNotification('Error exporting to markdown', 'danger');
    }
}

async function exportArticlesList(baseMarkdown) {
    let markdown = baseMarkdown;
    markdown += `## Article List\n\n`;
    
    // Get visible articles from the current view
    const articleElements = document.querySelectorAll('#articles-list .list-group-item');
    
    if (articleElements.length === 0) {
        markdown += `*No articles available.*\n\n`;
    } else {
        articleElements.forEach((element, index) => {
            const title = element.querySelector('h6 a')?.textContent || 'Untitled';
            const url = element.querySelector('h6 a')?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summary = element.querySelector('.small')?.textContent || '';
            
            markdown += `### ${index + 1}. [${title}](${url})\n\n`;
            markdown += `**Source:** ${source}\n\n`;
            
            if (summary && summary.trim() !== 'No summary available.') {
                const cleanSummary = summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            
            // Add metadata tags if visible
            const metadataTags = element.querySelectorAll('.metadata-tag');
            if (metadataTags.length > 0) {
                markdown += `**Tags:** `;
                const tags = Array.from(metadataTags).map(tag => tag.textContent.trim()).join(', ');
                markdown += `${tags}\n\n`;
            }
            
            markdown += `---\n\n`;
        });
    }
    
    downloadMarkdown(markdown, `news-articles-${document.getElementById('selected-date').value}.md`);
}

async function exportCombinedContent(baseMarkdown) {
    let markdown = baseMarkdown;
    
    // First, add six articles analysis if available
    const sixArticlesContainer = document.getElementById('six-articles-report');
    if (sixArticlesContainer && sixArticlesContainer.innerHTML.trim()) {
        const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
        
        if (articles.length > 0) {
            markdown += `## Six Most Important Articles Analysis\n\n`;
            
            articles.forEach((article, index) => {
                const title = article.querySelector('h4')?.textContent || `Article ${index + 1}`;
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown source';
                
                markdown += `### ${index + 1}. ${title}\n\n`;
                markdown += `**Source:** ${source}\n\n`;
                
                const sections = article.querySelectorAll('.section');
                sections.forEach(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    
                    if (sectionTitle && sectionContent) {
                        markdown += `**${sectionTitle}**\n\n${sectionContent}\n\n`;
                    }
                });
                
                // Get perspectives if available
                const perspectives = article.querySelector('.row');
                if (perspectives) {
                    markdown += `**Political & Ideological Perspectives:**\n\n`;
                    const cols = perspectives.querySelectorAll('.col-md-4');
                    cols.forEach(col => {
                        const perspectiveTitle = col.querySelector('strong')?.textContent || '';
                        const perspectiveContent = col.querySelector('p')?.textContent || '';
                        
                        if (perspectiveTitle && perspectiveContent) {
                            markdown += `- **${perspectiveTitle}** ${perspectiveContent}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n`;
            });
        }
    }
    
    // Then add the article list
    markdown += `## Article List\n\n`;
    
    const articleElements = document.querySelectorAll('#articles-list .list-group-item');
    
    if (articleElements.length === 0) {
        markdown += `*No articles available.*\n\n`;
    } else {
        articleElements.forEach((element, index) => {
            const titleElement = element.querySelector('h6 a');
            const title = titleElement?.textContent || 'Untitled';
            const url = titleElement?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summaryElement = element.querySelector('.small');
            const summary = summaryElement?.getAttribute('title') || summaryElement?.textContent || 'No summary available.';
            
            markdown += `### ${index + 1}. [${title}](${url})\n\n`;
            markdown += `**Source:** ${source}\n\n`;
            
            if (summary && summary.trim() !== 'No summary available.') {
                const cleanSummary = summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            
            markdown += `---\n\n`;
        });
    }
    
    const filename = `news-feed-complete-${document.getElementById('selected-date').value}.md`;
    downloadMarkdown(markdown, filename);
}

async function exportSixArticles(baseMarkdown) {
    let markdown = baseMarkdown;
    markdown += `## Six Most Important Articles Analysis\n\n`;
    
    // Get six articles data from the current view
    const sixArticlesContainer = document.getElementById('six-articles-report');
    
    if (!sixArticlesContainer || !sixArticlesContainer.innerHTML.trim()) {
        markdown += `*No six articles analysis available. Please generate the report first.*\n\n`;
    } else {
        const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
        
        if (articles.length === 0) {
            markdown += `*No articles found in the analysis.*\n\n`;
        } else {
            articles.forEach((article, index) => {
                const title = article.querySelector('h4')?.textContent || `Article ${index + 1}`;
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown';
                
                markdown += `### ${title}\n\n`;
                markdown += `**Source:** ${source}\n\n`;
                
                // Get sections
                const sections = article.querySelectorAll('.section');
                sections.forEach(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    
                    if (sectionTitle && sectionContent) {
                        markdown += `**${sectionTitle}**\n\n${sectionContent}\n\n`;
                    }
                });
                
                // Get perspectives if available
                const perspectives = article.querySelector('.row');
                if (perspectives) {
                    markdown += `**Political & Ideological Perspectives:**\n\n`;
                    const cols = perspectives.querySelectorAll('.col-md-4');
                    cols.forEach(col => {
                        const perspectiveTitle = col.querySelector('strong')?.textContent || '';
                        const perspectiveContent = col.querySelector('p')?.textContent || '';
                        
                        if (perspectiveTitle && perspectiveContent) {
                            markdown += `- **${perspectiveTitle}** ${perspectiveContent}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n`;
            });
        }
    }
    
    downloadMarkdown(markdown, `six-articles-${document.getElementById('selected-date').value}.md`);
}

function downloadMarkdown(content, filename) {
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification(`Exported as ${filename}`, 'success');
}

async function generateNewsFeed() {
    console.log('Generate button clicked');
    const selectedDate = document.getElementById('selected-date').value;
    const selectedModel = document.getElementById('model-select').value;
    console.log('Selected date:', selectedDate, 'Model:', selectedModel);
    
    // Clear existing content
    document.getElementById('articles-list').innerHTML = '';
    document.getElementById('six-articles-report').innerHTML = '';

    // Reset count indicator while loading
    const selectedDateCountEl = document.getElementById('selected-date-count');
    if (selectedDateCountEl) selectedDateCountEl.textContent = 'loading...';
    
    // Load both tabs
    await Promise.all([loadArticles(), loadSixArticles()]);
}

async function loadArticles(page = 1) {
    currentArticlesPage = page;
    const loadingEl = document.getElementById('articles-loading');
    const errorEl = document.getElementById('articles-error');
    const contentEl = document.getElementById('articles-list');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        // Use the news feed articles API
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            model: document.getElementById('model-select').value,
            page: page.toString(),
            per_page: '20'
        });
        
        // Only add date parameter for custom date selection
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            params.append('date', customDate);
        }
        
        const topic = document.getElementById('topic-input').value.trim();
        if (topic) {
            params.append('topic', topic);
        }
        
        const profileId = document.getElementById('profile-select').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }
        
        // Add starred articles if any
        if (starredArticles.size > 0) {
            params.append('starred_articles', Array.from(starredArticles).join(','));
        }

        console.log('Loading articles with params:', params.toString());
        const response = await fetch(`/api/news-feed/articles?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`No articles found: ${errorData.detail || 'No articles available for the selected date and criteria'}`);
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        // Update the selected-date count from response
        const selectedDateCountElSuccess = document.getElementById('selected-date-count');
        if (selectedDateCountElSuccess) {
            const total = (data && data.articles && typeof data.articles.total_items === 'number')
                ? data.articles.total_items
                : (data && data.articles && Array.isArray(data.articles.items))
                    ? data.articles.items.length
                    : 0;
            selectedDateCountElSuccess.textContent = String(total);
        }
        console.log('Articles data received:', data);
        console.log('Data.articles exists:', !!data.articles);
        console.log('Data.articles.items exists:', !!(data.articles && data.articles.items));
        console.log('Items count:', data.articles && data.articles.items ? data.articles.items.length : 'N/A');
        console.log('Sample article fields:', data.articles && data.articles.items && data.articles.items.length > 0 ? Object.keys(data.articles.items[0]) : 'No items');
        
        if (data.articles && data.articles.items && data.articles.items.length > 0) {
            console.log('First article sample:', data.articles.items[0]);
            window.lastArticlesData = data.articles; // Store for filtering
            renderArticles(data.articles);  // News feed API returns data.articles
            renderArticlesPagination(data.articles);
        } else {
            console.log('No articles found in response - showing friendly message');
            // Show friendly message instead of error
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
            errorEl.style.display = 'block';
            return; // Exit early, don't throw error
        }
        showSaveButton();

    } catch (error) {
        console.error('Error loading overview:', error);
        if (error.message.includes('404')) {
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
        } else {
            errorEl.textContent = `Error loading overview: ${error.message}`;
            errorEl.className = 'error-message'; // Keep error styling
        }
        // Ensure the selected-date count reflects zero on error
        const selectedDateCountElError = document.getElementById('selected-date-count');
        if (selectedDateCountElError) selectedDateCountElError.textContent = '0';
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

async function loadSixArticles() {
    const loadingEl = document.getElementById('six-articles-loading');
    const errorEl = document.getElementById('six-articles-error');
    const contentEl = document.getElementById('six-articles-report');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            model: document.getElementById('model-select').value,
            per_page: '20'
        });
        
        // Only add date parameter for custom date selection
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            params.append('date', customDate);
        }

        const topic = document.getElementById('topic-input').value.trim();
        if (topic) {
            params.append('topic', topic);
        }
        
        const profileId = document.getElementById('profile-select').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }
        
        // Add starred articles if any
        if (starredArticles.size > 0) {
            params.append('starred_articles', Array.from(starredArticles).join(','));
        }

        const response = await fetch(`/api/news-feed/six-articles?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`No articles found: ${errorData.detail || 'No articles available for the selected date and criteria'}`);
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Six articles response data:', data);
        console.log('Six articles array:', data.six_articles);
        if (data.six_articles && data.six_articles.length > 0) {
            console.log('First article related_articles:', data.six_articles[0].related_articles);
        }
        renderSixArticles(data.six_articles);
        showSaveButton();

    } catch (error) {
        console.error('Error loading six articles:', error);
        if (error.message.includes('404')) {
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
        } else {
            errorEl.textContent = `Error loading six articles: ${error.message}`;
            errorEl.className = 'error-message'; // Keep error styling
        }
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

// Helper function to escape HTML content for safe display
function escapeHTML(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str).replace(/[&<>"']/g, function (match) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        }[match];
    });
}

// Helper function to get bias CSS class
function getBiasClass(bias) {
    if (!bias) return 'tag-bias-unknown';
    const biasLower = bias.toLowerCase();
    if (biasLower.includes('left')) return 'tag-bias-left';
    if (biasLower.includes('right')) return 'tag-bias-right';
    if (biasLower.includes('center') || biasLower.includes('mixed')) return 'tag-bias-center';
    if (biasLower.includes('least') || biasLower.includes('factual')) return 'tag-bias-factual';
    return 'tag-bias-unknown';
}

// Helper function to get factual reporting CSS class
function getFactualClass(factual) {
    if (!factual) return 'tag-factual-unknown';
    const factualLower = factual.toLowerCase();
    if (factualLower.includes('high') || factualLower === 'very high') return 'tag-factual-high';
    if (factualLower.includes('mostly') || factualLower === 'mostly factual') return 'tag-factual-mostly';
    if (factualLower.includes('mixed')) return 'tag-factual-mixed';
    if (factualLower.includes('low')) return 'tag-factual-low';
    return 'tag-factual-unknown';
}

// Removed old renderArticles function - using new one with star and filter functionality

function renderPagination(totalPages, currentPage) {
    const paginationContainer = document.getElementById('articles-pagination');
    paginationContainer.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous Button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
    paginationContainer.appendChild(prevLi);

    // Page Number Buttons
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        paginationContainer.appendChild(pageLi);
    }

    // Next Button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
    paginationContainer.appendChild(nextLi);

    // Add click handlers
    paginationContainer.querySelectorAll('.page-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page);
            if (page && page !== currentPage) {
                loadArticles(page);
            }
        });
    });
}

function renderOverview(overview) {
    const contentEl = document.getElementById('overview-stories');
    
    let html = '';
    
    overview.top_stories.forEach((story, index) => {
        html += `
            <div class="story-item">
                <h2 class="story-headline">
                    <a href="${story.primary_article.uri}" target="_blank">${story.headline}</a>
                </h2>
                
                <div class="story-summary">${story.summary}</div>
                
                <div class="story-meta">
                    <span class="source-info">
                        ${story.primary_article.source.name}
                        ${getBiasBadge(story.primary_article.source.bias)}
                        ${getFactualityBadge(story.primary_article.source.factuality)}
                    </span>
                    ${story.primary_article.publication_date ? 
                        `<span class="publish-date">${new Date(story.primary_article.publication_date).toLocaleDateString()}</span>` : 
                        ''
                    }
                </div>
                
                ${story.topic_description ? 
                    `<div class="story-context"><strong>Why it matters:</strong> ${story.topic_description}</div>` : 
                    ''
                }
                
                ${story.related_articles.length > 0 ? `
                    <div class="related-articles">
                        <h6>More Coverage</h6>
                        ${story.related_articles.map(related => `
                            <div class="related-item">
                                <strong>${related.source}</strong>${getBiasBadge(related.bias)}: 
                                ${related.url ? `<a href="${related.url}" target="_blank">${related.title}</a>` : related.title}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    contentEl.innerHTML = html;
}

function renderSixArticles(articles) {
    const contentEl = document.getElementById('six-articles-report');
    
    console.log('renderSixArticles called with:', articles);
    console.log('Articles length:', articles ? articles.length : 'null/undefined');
    if (articles && articles.length > 0) {
        console.log('First article structure:', articles[0]);
        console.log('First article has related_articles:', !!articles[0].related_articles);
        if (articles[0].related_articles) {
            console.log('Related articles count:', articles[0].related_articles.length);
        }
    }
    
    if (!articles || articles.length === 0) {
        contentEl.innerHTML = '<div class="alert alert-info">No articles available for analysis.</div>';
        return;
    }
    
    let html = `
        <div class="six-articles-analysis">
            <h3>Strategic Analysis: Six Most Important Articles</h3>
            <p class="mb-4">Selected based on strategic relevance, novelty, credibility, and representativeness for AI-focused organizations.</p>
        </div>
    `;
    
    // Render each article
    articles.forEach((article, index) => {
        html += `
            <div class="article-analysis mb-5 p-4 border rounded">
                <div class="article-header mb-3">
                    <h4 class="text-primary">${index + 1}. ${article.title}</h4>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <p class="text-muted mb-1"><strong>Source:</strong> ${article.source}</p>
                            ${article.date ? `<p class="text-muted mb-0"><strong>Date:</strong> ${article.date}</p>` : ''}
                        </div>
                        <div class="text-end">
                            ${article.bias ? `<span class="badge ${getBiasClass(article.bias)} mb-1">${article.bias}</span><br>` : ''}
                            ${article.factual_reporting ? `<span class="badge ${getFactualityClass(article.factual_reporting)}">${article.factual_reporting}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="article-content">
                    <div class="section mb-3">
                        <h6 class="text-secondary">Summary</h6>
                        <p>${article.summary}</p>
                    </div>
                    
                    <div class="section mb-3">
                        <h6 class="text-success">Why It Matters</h6>
                        <p>${article.why_interesting}</p>
                    </div>
                    
                    <div class="section mb-3">
                        <h6 class="text-warning">Devil's Advocate</h6>
                        <p>${article.devils_advocate}</p>
                    </div>
                    
                    <div class="section">
                        <h6 class="text-info">Political & Ideological Perspectives</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong class="text-danger">Left-leaning:</strong>
                                <p class="small">${article.perspectives.left}</p>
                            </div>
                            <div class="col-md-4">
                                <strong class="text-primary">Centrist:</strong>
                                <p class="small">${article.perspectives.center}</p>
                            </div>
                            <div class="col-md-4">
                                <strong class="text-warning">Right-leaning:</strong>
                                <p class="small">${article.perspectives.right}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Related Articles Section -->
                    ${article.related_articles && article.related_articles.length > 0 ? `
                    <div class="section mt-4">
                        <h6 class="text-primary">Related Articles</h6>
                        <div class="row">
                            ${article.related_articles.map(related => `
                                <div class="col-md-6 mb-2">
                                    <div class="card card-body p-2 bg-light">
                                        <h6 class="card-title mb-1" style="font-size: 0.9rem;">
                                            <a href="${related.url}" target="_blank" rel="noopener" class="text-decoration-none">
                                                ${related.title}
                                            </a>
                                        </h6>
                                        <p class="card-text mb-1" style="font-size: 0.8rem;">
                                            <strong>Source:</strong> ${related.source}
                                            ${related.similarity_score ? `<span class="badge bg-secondary ms-1">${(related.similarity_score * 100).toFixed(0)}% similar</span>` : ''}
                                        </p>
                                        <p class="card-text small text-muted" style="font-size: 0.75rem;">
                                            ${related.summary.length > 100 ? related.summary.substring(0, 100) + '...' : related.summary}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    contentEl.innerHTML = html;
}

function getBiasBadge(bias) {
    if (!bias) return '';
    
    const biasClasses = {
        'left': 'bias-left',
        'left-center': 'bias-left-center',
        'center': 'bias-center',
        'right-center': 'bias-right-center',
        'right': 'bias-right',
        'mixed': 'bias-mixed'
    };
    
    const className = biasClasses[bias] || 'bias-mixed';
    return `<span class="bias-badge ${className}">${bias}</span>`;
}

function getFactualityBadge(factuality) {
    if (!factuality) return '';
    
    const factualityClasses = {
        'very-high': 'factuality-very-high',
        'high': 'factuality-high',
        'mostly-factual': 'factuality-mostly-factual',
        'mixed': 'factuality-mixed',
        'low': 'factuality-low',
        'very-low': 'factuality-low'
    };
    
    const className = factualityClasses[factuality] || 'factuality-mixed';
    const displayText = factuality.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
    return `<span class="factuality-badge ${className}">${displayText}</span>`;
}

// Legacy share functionality - replaced with save feed functionality above

// Old share functionality removed - these elements no longer exist

function showSaveButton() {
    document.getElementById('save-btn').style.display = 'inline-block';
    document.getElementById('export-markdown-btn').style.display = 'inline-block';
}

function renderArticlesPagination(data) {
    const paginationContainer = document.getElementById('articles-pagination');
    if (!paginationContainer || !data.total_pages || data.total_pages <= 1) {
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }

    const currentPage = data.page || 1;
    const totalPages = data.total_pages;
    
    let html = '<nav><ul class="pagination pagination-sm justify-content-center">';
    
    // Previous button
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${currentPage - 1}); return false;">Previous</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Previous</span></li>';
    }
    
    // Page numbers (show max 5 pages around current)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(1); return false;">1</a></li>';
        if (startPage > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${i}); return false;">${i}</a></li>`;
        }
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${currentPage + 1}); return false;">Next</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Next</span></li>';
    }
    
    html += '</ul></nav>';
    paginationContainer.innerHTML = html;
}

// Calendar functionality
let availableDates = {};
let selectedDate = '2025-09-15';
// Set calendar to show September 2025 (month of selected date)
let currentCalendarMonth = 8; // September (0-based)
let currentCalendarYear = 2025;

async function loadAvailableDates() {
    console.log('Starting loadAvailableDates...');
    try {
        console.log('Fetching available dates from API...');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch('/api/news-feed/available-dates', {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        console.log('Response received:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Data parsed:', data);
        
        if (data.success) {
            console.log('Processing dates...');
            availableDates = {};
            data.dates.forEach(dateInfo => {
                availableDates[dateInfo.date] = dateInfo.count;
            });
            console.log('Available dates processed:', Object.keys(availableDates).length, 'dates');
            
            console.log('Rendering calendar...');
            renderCalendar();
            console.log('Calendar rendered');

            // Hide loading, show calendar
            const loading = document.getElementById('calendar-loading');
            const view = document.getElementById('calendar-view');
            if (loading) loading.style.display = 'none';
            if (view) view.style.display = 'block';

            // Update selected-date count if known and initialize calendar to selected date month
            const countEl = document.getElementById('selected-date-count');
            const currentDate = document.getElementById('selected-date')?.value;
            if (countEl) countEl.textContent = String(availableDates[currentDate] ?? 0);
            
            // Set calendar to show the month of the selected date
            if (currentDate) {
                const [year, month] = currentDate.split('-').map(Number);
                currentCalendarYear = year;
                currentCalendarMonth = month - 1; // JS months are 0-based
            }
            console.log('loadAvailableDates completed successfully');
        } else {
            console.error('API returned success: false', data);
            throw new Error(data.message || 'Unknown error from API');
        }
    } catch (error) {
        console.error('Error loading available dates:', error);
        const loading = document.getElementById('calendar-loading');
        if (loading) {
            if (error.name === 'AbortError') {
                loading.innerHTML = `
                    <div class="text-danger">Calendar loading timed out.</div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableDates()">Retry</button>
                    <div class="mt-2 small text-muted">You can still use the date picker above to select dates.</div>
                `;
            } else {
                loading.innerHTML = `
                    <div class="text-danger">Failed to load calendar: ${error.message}</div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableDates()">Retry</button>
                    <div class="mt-2 small text-muted">You can still use the date picker above to select dates.</div>
                `;
            }
        }
    }
}

function renderCalendar() {
    console.log('renderCalendar started');
    const view = document.getElementById('calendar-view');
    const loading = document.getElementById('calendar-loading');
    if (!view) {
        console.error('calendar-view element not found');
        return;
    }

    if (loading) loading.style.display = 'none';
    console.log('Calendar loading hidden, building HTML...');

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Get first day of month and number of days
    const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
    const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeCalendarMonth(-1)"> Prev</button>
            <h6 class="mb-0">${monthNames[currentCalendarMonth]} ${currentCalendarYear}</h6>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeCalendarMonth(1)">Next </button>
        </div>`;

    // Calendar header
    html += '<div class="row g-1 mb-2">';
    for (const day of dayNames) {
        html += `<div class="col text-center"><small class="text-muted fw-bold">${day}</small></div>`;
    }
    html += '</div>';

    // Calendar days
    html += '<div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
    
    // Empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day-empty" style="height: 40px;"></div>';
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const count = availableDates[dateStr] ?? 0;
        const isSelected = dateStr === selectedDate;
        const hasArticles = count > 0;
        
        let buttonClass = 'btn btn-sm w-100 h-100 d-flex flex-column justify-content-center align-items-center';
        if (isSelected) {
            buttonClass += ' btn-primary';
        } else if (hasArticles) {
            buttonClass += ' btn-outline-primary';
        } else {
            buttonClass += ' btn-outline-light text-muted';
        }

        html += `
            <button type="button" class="${buttonClass}" data-date="${dateStr}" style="height: 40px; font-size: 0.8rem;" ${!hasArticles ? 'disabled' : ''}>
                <div>${day}</div>
                ${hasArticles ? `<small class="badge bg-secondary rounded-pill" style="font-size: 0.6rem;">${count}</small>` : ''}
            </button>`;
    }

    html += '</div>';
    console.log('Calendar HTML built, setting innerHTML...');
    view.innerHTML = html;
    view.style.display = 'block';
    console.log('Calendar HTML set, wiring click handlers...');

    // Wire click handlers
    view.querySelectorAll('[data-date]:not([disabled])').forEach((btn) => {
        btn.addEventListener('click', () => {
            const d = btn.getAttribute('data-date');
            setSelectedDate(d);
        });
    });
    console.log('renderCalendar completed');
}

function changeCalendarMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    }
    renderCalendar();
}

function setSelectedDate(dateStr) {
    // Update global and hidden input
    selectedDate = dateStr;
    const hidden = document.getElementById('selected-date');
    if (hidden) hidden.value = dateStr;

    // Update header display
    const [y, m, d] = dateStr.split('-').map(Number);
    const display = document.getElementById('selected-date-text');
    if (display) {
        const dateObj = new Date(y, m - 1, d);
        display.textContent = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Update count immediately if known, otherwise loading
    const countEl = document.getElementById('selected-date-count');
    if (countEl) countEl.textContent = (availableDates[dateStr] ?? 'loading...');

    // Close the calendar collapse if open
    try {
        const collapseEl = document.getElementById('calendar-collapse');
        if (collapseEl && collapseEl.classList.contains('show') && window.bootstrap && bootstrap.Collapse) {
            const instance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
            instance.hide();
        }
    } catch (_) { /* no-op if bootstrap not available */ }

    // Reload content for the newly selected date
    loadArticles(1);
    loadSixArticles();
}

// Organizational profile management
async function loadOrganizationalProfiles() {
    try {
        const response = await fetch('/api/organizational-profiles');
        const data = await response.json();
        
        if (data.success && data.profiles) {
            const profileSelect = document.getElementById('profile-select');
            
            // Clear existing options except the first
            profileSelect.innerHTML = '<option value="">General Analysis (No Profile)</option>';
            
            // Add profiles
            data.profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name}${profile.is_default ? ' (Default)' : ''}`;
                option.title = `${profile.industry || 'General'}  ${profile.organization_type || 'Organization'}`;
                profileSelect.appendChild(option);
            });
            
            console.log(`Loaded ${data.profiles.length} organizational profiles`);
        }
    } catch (error) {
        console.error('Error loading organizational profiles:', error);
        showNotification('Failed to load organizational profiles', 'warning');
    }
}

// Date range handling
function handleDateRangeChange() {
    const dateRangeSelect = document.getElementById('date-range-select');
    const customDateSection = document.getElementById('custom-date-section');
    const dateRangeText = document.getElementById('date-range-text');
    const selectedDateInput = document.getElementById('selected-date');
    
    const selectedRange = dateRangeSelect.value;
    
    if (selectedRange === 'custom') {
        customDateSection.style.display = 'block';
        dateRangeText.textContent = 'Custom Date';
        // Use the custom date input value
        selectedDateInput.value = document.getElementById('custom-date-input').value;
    } else {
        customDateSection.style.display = 'none';
        
        // Calculate date range and update display
        const now = new Date();
        let startDate, endDate = now;
        let displayText = '';
        
        switch (selectedRange) {
            case '24h':
                startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                displayText = 'Last 24 Hours';
                selectedDateInput.value = now.toISOString().split('T')[0];
                break;
            case '7d':
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                displayText = 'Last 7 Days';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '30d':
                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                displayText = 'Last 30 Days';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '3m':
                startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                displayText = 'Last 3 Months';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '1y':
                startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                displayText = 'Last Year';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case 'all':
                displayText = 'All Time';
                selectedDateInput.value = 'all';
                break;
        }
        
        dateRangeText.textContent = displayText;
        
        // Update the info text
        const dateRangeInfo = document.getElementById('date-range-info');
        if (dateRangeInfo) {
            if (selectedRange === 'all') {
                dateRangeInfo.textContent = 'All available articles';
            } else {
                const startDateStr = startDate ? startDate.toLocaleDateString() : '';
                const endDateStr = endDate.toLocaleDateString();
                dateRangeInfo.textContent = `${startDateStr} to ${endDateStr}`;
            }
        }
    }
    
    // Update article count for the new date range
    updateArticleCountForDateRange();
}

// Update article count for date range changes
async function updateArticleCountForDateRange() {
    const countEl = document.getElementById('selected-date-count');
    if (!countEl) return;
    
    try {
        countEl.textContent = 'loading...';
        
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            count_only: 'true'
        });
        
        // Add custom date if needed
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            if (customDate) {
                params.append('date', customDate);
            }
        }
        
        // Add topic filter if set
        const topic = document.getElementById('topic-input').value.trim();
        if (topic) {
            params.append('topic', topic);
        }
        
        // Make a lightweight request to get just the count
        const response = await fetch(`/api/news-feed/articles?${params}&per_page=1&page=1`);
        
        if (response.ok) {
            const data = await response.json();
            const total = data.articles?.total_items || 0;
            countEl.textContent = total.toString();
        } else {
            countEl.textContent = '0';
        }
    } catch (error) {
        console.error('Error updating article count:', error);
        countEl.textContent = '?';
    }
}

// Star functionality for articles
let starredArticles = new Set();

// Filter functionality for articles
let activeFilters = {
    bias: new Set(),
    factuality: new Set(),
    category: new Set()
};

function renderArticles(articlesData) {
    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '';
    
    if (!articlesData.items || articlesData.items.length === 0) {
        listContainer.innerHTML = '<div class="alert alert-info">No articles available.</div>';
        document.getElementById('articles-filters').style.display = 'none';
        return;
    }
    
    // Build filter badges from available data
    buildFilterBadges(articlesData.items);
    
    // Apply current filters
    const filteredArticles = applyArticleFilters(articlesData.items);
    
    const articlesList = document.createElement('div');
    articlesList.className = 'list-group list-group-flush mt-2';
    
    filteredArticles.forEach(article => {
        const articleItem = document.createElement('div');
        articleItem.className = 'list-group-item position-relative';
        
        const isStarred = starredArticles.has(article.uri);
        
        articleItem.innerHTML = `
            <!-- Remove button (top-right) -->
            <button class="btn btn-sm position-absolute" 
                    style="top: 8px; right: 8px; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; border: none; background: rgba(220, 53, 69, 0.1); color: #dc3545; border-radius: 50%;"
                    onclick="excludeArticle('${article.uri}', this)"
                    onmouseover="this.style.background='#dc3545'; this.style.color='white';"
                    onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'; this.style.color='#dc3545';"
                    title="Remove article"></button>
            
            <!-- Star button (top-left) -->
            <button class="btn btn-sm position-absolute star-btn ${isStarred ? 'starred' : ''}" 
                    style="top: 8px; left: 8px; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; border: none; background: ${isStarred ? '#ffc107' : 'rgba(255, 193, 7, 0.1)'}; color: ${isStarred ? 'white' : '#ffc107'}; border-radius: 50%;"
                    onclick="toggleStarArticle('${article.uri}', this)"
                    title="${isStarred ? 'Remove from Six Articles' : 'Add to Six Articles'}"></button>
            
            <!-- Two Column Layout -->
            <div class="row" style="margin-left: 30px; margin-right: 30px;">
                <!-- Column 1: Content -->
                <div class="col-md-8">
                    <h6 class="mb-2">
                        <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                            ${escapeHTML(article.title)}
                        </a>
                    </h6>
                    <p class="mb-1 small text-muted">
                        <i class="fas fa-building me-1"></i>${escapeHTML(article.news_source)}
                        <span class="ms-2">
                            <i class="fas fa-calendar me-1"></i>${new Date(article.publication_date).toLocaleDateString()}
                        </span>
                    </p>
                    <p class="mb-0 small text-secondary" style="line-height: 1.4;">
                        ${escapeHTML(article.summary)}
                    </p>
                </div>
                
                <!-- Column 2: Metadata -->
                <div class="col-md-4">
                    <div class="d-flex flex-column gap-1 h-100 justify-content-center">
                        ${article.bias ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Political Bias:</span>
                            <span class="badge ${getBiasClass(article.bias)}">${article.bias}</span>
                        </div>` : ''}
                        
                        ${article.factual_reporting ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Factual:</span>
                            <span class="badge ${getFactualityClass(article.factual_reporting)}">${article.factual_reporting}</span>
                        </div>` : ''}
                        
                        ${article.mbfc_credibility_rating ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Credibility:</span>
                            <span class="badge bg-info text-white">${article.mbfc_credibility_rating}</span>
                        </div>` : ''}
                        
                        ${article.category ? `
                        <div class="d-flex align-items-center">
                            <span class="text-muted small me-2" style="min-width: 80px;">Category:</span>
                            <span class="badge bg-light text-dark">${article.category}</span>
                        </div>` : ''}
                    </div>
                </div>
            </div>
        `;
        
        articlesList.appendChild(articleItem);
    });
    
    listContainer.appendChild(articlesList);
    updateStarredCount();
    
    // Update count display to show filtered vs total
    const countEl = document.getElementById('selected-date-count');
    if (countEl) {
        const totalCount = articlesData.items.length;
        const filteredCount = filteredArticles.length;
        if (filteredCount !== totalCount) {
            countEl.textContent = `${filteredCount} of ${totalCount}`;
        } else {
            countEl.textContent = totalCount.toString();
        }
    }
    
    // Update pagination based on filtered results
    updatePaginationForFilters(articlesData, filteredArticles);
}

function buildFilterBadges(articles) {
    // Collect unique values
    const biasValues = new Set();
    const factualityValues = new Set();
    const categoryValues = new Set();
    
    articles.forEach(article => {
        if (article.bias) biasValues.add(article.bias);
        if (article.factual_reporting) factualityValues.add(article.factual_reporting);
        if (article.category) categoryValues.add(article.category);
    });
    
    // Build bias filter badges
    const biasContainer = document.getElementById('bias-filters');
    biasContainer.innerHTML = '';
    biasValues.forEach(bias => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm ${getBiasClass(bias)} filter-badge ${activeFilters.bias.has(bias) ? 'active' : ''}`;
        badge.textContent = bias;
        badge.onclick = () => toggleFilter('bias', bias);
        biasContainer.appendChild(badge);
    });
    
    // Build factuality filter badges
    const factualityContainer = document.getElementById('factuality-filters');
    factualityContainer.innerHTML = '';
    factualityValues.forEach(factuality => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm ${getFactualityClass(factuality)} filter-badge ${activeFilters.factuality.has(factuality) ? 'active' : ''}`;
        badge.textContent = factuality;
        badge.onclick = () => toggleFilter('factuality', factuality);
        factualityContainer.appendChild(badge);
    });
    
    // Build category filter badges
    const categoryContainer = document.getElementById('category-filters');
    categoryContainer.innerHTML = '';
    categoryValues.forEach(category => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm bg-light text-dark filter-badge ${activeFilters.category.has(category) ? 'active' : ''}`;
        badge.textContent = category;
        badge.onclick = () => toggleFilter('category', category);
        categoryContainer.appendChild(badge);
    });
    
    // Show filter section if we have any filters
    if (biasValues.size > 0 || factualityValues.size > 0 || categoryValues.size > 0) {
        document.getElementById('articles-filters').style.display = 'block';
    }
}

function toggleFilter(filterType, value) {
    if (activeFilters[filterType].has(value)) {
        activeFilters[filterType].delete(value);
    } else {
        activeFilters[filterType].add(value);
    }
    
    // Re-render articles with new filters
    const articlesData = window.lastArticlesData; // Store this when loading articles
    if (articlesData) {
        renderArticles(articlesData);
    }
}

function applyArticleFilters(articles) {
    return articles.filter(article => {
        // Check bias filter
        if (activeFilters.bias.size > 0 && !activeFilters.bias.has(article.bias)) {
            return false;
        }
        
        // Check factuality filter
        if (activeFilters.factuality.size > 0 && !activeFilters.factuality.has(article.factual_reporting)) {
            return false;
        }
        
        // Check category filter
        if (activeFilters.category.size > 0 && !activeFilters.category.has(article.category)) {
            return false;
        }
        
        return true;
    });
}

function improveQuality() {
    // Clear existing filters first
    activeFilters.bias.clear();
    activeFilters.factuality.clear();
    activeFilters.category.clear();
    
    // Check what factuality values are actually available
    const articlesData = window.lastArticlesData;
    if (!articlesData || !articlesData.items) {
        showNotification('No articles data available for filtering', 'warning');
        return;
    }
    
    // Collect all factuality values to see what's available
    const availableFactuality = new Set();
    articlesData.items.forEach(article => {
        if (article.factual_reporting) {
            availableFactuality.add(article.factual_reporting);
        }
    });
    
    console.log('Available factuality values:', Array.from(availableFactuality));
    
    // Add high-quality factuality filters (more inclusive)
    const highQualityFactuality = Array.from(availableFactuality).filter(factuality => {
        const lower = factuality.toLowerCase();
        return lower.includes('high') || 
               lower.includes('mostly') || 
               lower.includes('factual') ||
               lower === 'very high' ||
               lower === 'high' ||
               lower === 'mostly factual';
    });
    
    if (highQualityFactuality.length === 0) {
        // If no high-quality matches found, be more lenient
        const acceptableFactuality = Array.from(availableFactuality).filter(factuality => {
            const lower = factuality.toLowerCase();
            return !lower.includes('low') && !lower.includes('very low');
        });
        
        acceptableFactuality.forEach(factuality => {
            activeFilters.factuality.add(factuality);
        });
        
        showNotification(`Showing ${acceptableFactuality.length > 0 ? 'acceptable' : 'all available'} quality sources`, 'info');
    } else {
        highQualityFactuality.forEach(factuality => {
            activeFilters.factuality.add(factuality);
        });
        
        showNotification(`Showing ${highQualityFactuality.length} high-quality source types`, 'success');
    }
    
    // Re-render articles with quality filters
    renderArticles(articlesData);
}

function updatePaginationForFilters(originalData, filteredArticles) {
    const paginationContainer = document.getElementById('articles-pagination');
    if (!paginationContainer) return;
    
    // If filtering is active and reduces results significantly, hide pagination
    const hasActiveFilters = activeFilters.bias.size > 0 || activeFilters.factuality.size > 0 || activeFilters.category.size > 0;
    
    if (hasActiveFilters) {
        // Hide pagination when filtering since we're showing filtered subset
        paginationContainer.innerHTML = '';
        
        // Show filter info instead
        if (filteredArticles.length !== originalData.items.length) {
            paginationContainer.innerHTML = `
                <div class="text-center text-muted small mt-2">
                    <i class="fas fa-filter me-1"></i>
                    Showing ${filteredArticles.length} filtered articles of ${originalData.items.length} total
                    ${originalData.total_pages > 1 ? ` (from ${originalData.total_pages} pages)` : ''}
                </div>
            `;
        }
    } else {
        // Show normal pagination when no filters active
        renderArticlesPagination(originalData);
    }
}

function clearAllFilters() {
    activeFilters.bias.clear();
    activeFilters.factuality.clear();
    activeFilters.category.clear();
    
    // Re-render articles without filters
    const articlesData = window.lastArticlesData;
    if (articlesData) {
        renderArticles(articlesData);
        showNotification('All filters cleared', 'info');
    }
}

function toggleStarArticle(articleUri, buttonElement) {
    if (starredArticles.has(articleUri)) {
        // Remove star
        starredArticles.delete(articleUri);
        buttonElement.classList.remove('starred');
        buttonElement.style.background = 'rgba(255, 193, 7, 0.1)';
        buttonElement.style.color = '#ffc107';
        buttonElement.title = 'Add to Six Articles';
        showNotification('Article removed from Six Articles selection', 'info');
    } else {
        // Add star
        if (starredArticles.size >= 6) {
            showNotification('Maximum 6 articles can be starred for Six Articles analysis', 'warning');
            return;
        }
        
        starredArticles.add(articleUri);
        buttonElement.classList.add('starred');
        buttonElement.style.background = '#ffc107';
        buttonElement.style.color = 'white';
        buttonElement.title = 'Remove from Six Articles';
        showNotification('Article added to Six Articles selection', 'success');
    }
    
    updateStarredCount();
}

function updateStarredCount() {
    // Update any UI elements that show starred count
    const starredCount = starredArticles.size;
    
    // Update six articles tab to show starred count
    const sixArticlesTab = document.getElementById('six-articles-tab');
    if (sixArticlesTab) {
        const originalText = sixArticlesTab.textContent.replace(/ \(\d+\)$/, '');
        sixArticlesTab.textContent = starredCount > 0 ? `${originalText} (${starredCount})` : originalText;
    }
    
    // Show warning if more than 6 are starred (shouldn't happen due to limit, but safety check)
    if (starredCount > 6) {
        showNotification('Too many articles starred! Please unstar some to keep 6 or fewer.', 'danger');
    }
}

// Helper functions for bias and factuality display
function getBiasClass(bias) {
    if (!bias) return 'bg-light text-dark';

    const biasClasses = {
        'left': 'bg-primary',
        'left-center': 'bg-info',
        'center': 'bg-secondary',
        'right-center': 'bg-warning text-dark',
        'right': 'bg-danger',
        'mixed': 'bg-dark'
    };

    return biasClasses[bias.toLowerCase()] || 'bg-light text-dark';
}

function getFactualityClass(factuality) {
    if (!factuality) return 'bg-light text-dark';

    const factualityClasses = {
        'very high': 'bg-success',
        'high': 'bg-success',
        'mostly factual': 'bg-info',
        'mixed': 'bg-warning text-dark',
        'low': 'bg-danger',
        'very low': 'bg-danger'
    };

    return factualityClasses[factuality.toLowerCase()] || 'bg-light text-dark';
}

// Add CSS for filter badges
const style = document.createElement('style');
style.textContent = `
    .filter-badge {
        transition: all 0.2s ease;
        opacity: 0.7;
        border: 1px solid transparent;
    }
    
    .filter-badge:hover {
        opacity: 1;
        transform: translateY(-1px);
    }
    
    .filter-badge.active {
        opacity: 1;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }
    
    .selected-date-compact {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        background: rgba(0,123,255,0.1);
        border-radius: 4px;
        border: 1px solid rgba(0,123,255,0.2);
    }
`;
document.head.appendChild(style);

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing calendar...');
    loadAvailableDates();
    
    // Load organizational profiles
    loadOrganizationalProfiles();
    
    // Initialize article count for default date range
    updateArticleCountForDateRange();
});
</script>

{% endblock %}
