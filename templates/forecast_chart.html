<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence-Based Forecast Charts - AuNoo AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .chart-image {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .form-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üìä Evidence-Based Forecast Charts</h1>
                <p class="text-center text-muted">Generate forecast charts showing consensus bands and outlier scenarios</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="form-section">
                    <h3>Chart Configuration</h3>
                    <form id="chartForm">
                        <div class="mb-3">
                            <label for="topic" class="form-label">Topic</label>
                            <select class="form-select" id="topic" required>
                                <option value="">Loading topics...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="timeframe" class="form-label">Timeframe</label>
                            <select class="form-select" id="timeframe">
                                <option value="1d">1 Day</option>
                                <option value="1w">1 Week</option>
                                <option value="1m">1 Month</option>
                                <option value="90d">90 Days</option>
                                <option value="180d">180 Days</option>
                                <option value="365d" selected>365 Days</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="customTimeframeDiv" style="display: none;">
                            <label for="customTimeframe" class="form-label">Custom Days</label>
                            <input type="number" class="form-control" id="customTimeframe" min="1" max="3650" placeholder="Enter number of days">
                        </div>
                        
                        <div class="mb-3">
                            <label for="categories" class="form-label">Categories <small>(Optional)</small></label>
                            <select class="form-select" id="categories" multiple>
                                <option value="">Loading categories...</option>
                            </select>
                            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple categories</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="clusters" class="form-label">Clusters <small>(Coming Soon)</small></label>
                            <select class="form-select" id="clusters" multiple disabled>
                                <option value="">Cluster functionality coming soon</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="titlePrefix" class="form-label">Chart Title Prefix</label>
                            <input type="text" class="form-control" id="titlePrefix" value="AI & Machine Learning">
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="interactive" checked>
                                <label class="form-check-label" for="interactive">
                                    Interactive Chart (hover tooltips)
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Generate Forecast Chart</button>
                    </form>
                </div>
                
                <div class="chart-info">
                    <h5>üîç How Consensus Types Are Determined</h5>
                    <ul class="small">
                        <li><strong>Data-Driven Analysis:</strong> Consensus types are based on actual sentiment analysis of articles, not category names</li>
                        <li><strong>Sentiment Thresholds:</strong> 
                            <ul>
                                <li>‚â•60% positive ‚Üí Positive Growth</li>
                                <li>‚â•25% critical ‚Üí Domain-specific concern type</li>
                                <li>35-60% positive ‚Üí Business Transformation or Positive Growth</li>
                                <li>Mixed patterns ‚Üí Mixed Consensus</li>
                            </ul>
                        </li>
                        <li><strong>Timeline:</strong> Based on "time to impact" distribution from articles</li>
                        <li><strong>Outliers:</strong> Extreme scenarios from hyperbolic/critical articles</li>
                    </ul>
                    
                    <h6 class="mt-3">üìä Consensus Types (Data-Driven)</h6>
                    <div class="small">
                        <div class="mb-2">
                            <strong>üü¢ Positive Growth:</strong> ‚â•60% positive sentiment in articles - strong optimism about technological advancement
                        </div>
                        <div class="mb-2">
                            <strong>üü® Business Transformation:</strong> 35-60% positive sentiment in business/work domains - moderate optimism about commercial adoption
                        </div>
                        <div class="mb-2">
                            <strong>üü° Mixed Consensus:</strong> Balanced sentiment patterns - no clear directional consensus in the data
                        </div>
                        <div class="mb-2">
                            <strong>üî¥ Regulatory Response:</strong> ‚â•25% critical sentiment in regulatory/legal domains - policy concerns dominating
                        </div>
                        <div class="mb-2">
                            <strong>üü† Societal Impact:</strong> ‚â•25% critical sentiment in ethics/society domains - social responsibility concerns
                        </div>
                        <div class="mb-2">
                            <strong>‚ö†Ô∏è Safety/Security:</strong> ‚â•25% critical sentiment in safety/risk domains - security concerns dominating
                        </div>
                        <div class="mb-2">
                            <strong>üîµ Geopolitical Strategy:</strong> ‚â•25% critical sentiment in geopolitical domains - international competition concerns
                        </div>
                        <div class="mb-2">
                            <strong>üü§ Defense Applications:</strong> ‚â•25% critical sentiment in military domains - defense/warfare concerns
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-info" onclick="loadConsensusTypes()">üìã View Detailed Explanations</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating forecast chart...</p>
                </div>
                
                <div id="errorContainer"></div>
                
                <div class="chart-container" id="chartContainer" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 id="chartTitle">Forecast Chart</h4>
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart()" id="downloadBtn">üì• Download</button>
                    </div>
                    <img id="chartImage" class="chart-image" alt="Forecast Chart" style="display: none;">
                    <div id="interactiveChart" style="width: 100%; height: auto;"></div>
                    <div class="mt-3">
                        <small class="text-muted" id="chartMetadata"></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load Plotly.js for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <script>
        let currentChartData = null;
        
        document.getElementById('chartForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const topic = document.getElementById('topic').value;
            let timeframe = document.getElementById('timeframe').value;
            const titlePrefix = document.getElementById('titlePrefix').value;
            const interactive = document.getElementById('interactive').checked;
            
            // Handle custom timeframe
            if (timeframe === 'custom') {
                const customDays = document.getElementById('customTimeframe').value;
                if (!customDays || customDays < 1) {
                    showError('Please enter a valid number of custom days.');
                    return;
                }
                timeframe = customDays + 'd';
            }
            
            // Get selected categories
            const categoriesSelect = document.getElementById('categories');
            const selectedCategories = Array.from(categoriesSelect.selectedOptions).map(option => option.value).filter(val => val);
            
            // Get selected clusters 
            const clustersSelect = document.getElementById('clusters');
            const selectedClusters = Array.from(clustersSelect.selectedOptions).map(option => option.value).filter(val => val);
            
            if (!topic) {
                showError('Please select a topic.');
                return;
            }
            
            await generateChart(topic, timeframe, titlePrefix, interactive, selectedCategories, selectedClusters);
        });
        
        // Handle custom timeframe visibility
        document.getElementById('timeframe').addEventListener('change', function() {
            const customDiv = document.getElementById('customTimeframeDiv');
            if (this.value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        });
        
        // Handle topic change to load categories
        document.getElementById('topic').addEventListener('change', async function() {
            const topic = this.value;
            if (topic) {
                await loadCategories(topic);
            }
        });
        
        async function generateChart(topic, timeframe, titlePrefix, interactive = false, categories = [], clusters = []) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const chartContainer = document.getElementById('chartContainer');
            const errorContainer = document.getElementById('errorContainer');
            
            loadingSpinner.style.display = 'block';
            chartContainer.style.display = 'none';
            errorContainer.innerHTML = '';
            
            try {
                // Build URL with parameters
                let url = `/api/forecast-charts/generate/${encodeURIComponent(topic)}?timeframe=${timeframe}&title_prefix=${encodeURIComponent(titlePrefix)}&interactive=${interactive}`;
                
                if (categories.length > 0) {
                    url += `&categories=${encodeURIComponent(categories.join(','))}`;
                }
                
                if (clusters.length > 0) {
                    url += `&clusters=${encodeURIComponent(clusters.join(','))}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to generate chart');
                }
                
                if (data.success) {
                    await displayChart(data);
                } else {
                    throw new Error(data.message || 'Chart generation failed');
                }
                
            } catch (error) {
                showError(`Error generating chart: ${error.message}`);
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
        
        async function displayChart(data) {
            const chartContainer = document.getElementById('chartContainer');
            const chartImage = document.getElementById('chartImage');
            const interactiveChart = document.getElementById('interactiveChart');
            const chartTitle = document.getElementById('chartTitle');
            const chartMetadata = document.getElementById('chartMetadata');
            const downloadBtn = document.getElementById('downloadBtn');
            
            currentChartData = data.chart_data;
            
            if (data.interactive) {
                // Display interactive Plotly chart
                chartImage.style.display = 'none';
                interactiveChart.style.display = 'block';
                
                // Clear any existing chart
                interactiveChart.innerHTML = '';
                
                // Check if Plotly is available
                if (typeof Plotly === 'undefined') {
                    showError('Plotly library not loaded. Please refresh the page and try again.');
                    return;
                }
                
                try {
                    // Parse the chart data directly (it's now JSON, not script)
                    const plotlyData = JSON.parse(data.chart_data);
                    
                    // Render the chart directly with Plotly
                    await Plotly.newPlot('interactiveChart', 
                        plotlyData.plotly_data, 
                        plotlyData.plotly_layout, 
                        plotlyData.config
                    );
                    
                    console.log('‚úÖ Interactive chart rendered successfully with tooltips');
                } catch (error) {
                    console.error('Error rendering interactive chart:', error);
                    console.log('Falling back to static chart...');
                    
                    // Fallback to static chart
                    try {
                        const fallbackUrl = `/api/forecast-charts/generate/${encodeURIComponent(data.topic)}?timeframe=${data.timeframe}&title_prefix=${encodeURIComponent(data.title_prefix || 'AI Test')}&interactive=false`;
                        const fallbackResponse = await fetch(fallbackUrl);
                        const fallbackData = await fallbackResponse.json();
                        
                        if (fallbackData.success) {
                            // Display static chart instead
                            interactiveChart.style.display = 'none';
                            chartImage.src = fallbackData.chart_data;
                            chartImage.style.display = 'block';
                            downloadBtn.style.display = 'block';
                            chartTitle.textContent = `Forecast Chart - ${data.topic} (Static Fallback)`;
                            chartMetadata.textContent = `Generated from ${data.timeframe} days of data | Topic: ${data.topic}`;
                        } else {
                            showError(`Interactive chart failed and static fallback also failed: ${fallbackData.message}`);
                        }
                    } catch (fallbackError) {
                        showError(`Interactive chart failed and could not load static fallback: ${fallbackError.message}`);
                    }
                    return;
                }
                
                downloadBtn.style.display = 'none'; // Hide download for interactive charts
                chartTitle.textContent = `Interactive Forecast Chart - ${data.topic}`;
                chartMetadata.innerHTML = `Generated from ${data.timeframe} days of data | Topic: ${data.topic}<br><small><i>üìù Hover over outlier markers and consensus bands for detailed information</i></small>`;
            } else {
                // Display static PNG chart
                chartImage.src = data.chart_data;
                chartImage.style.display = 'block';
                interactiveChart.style.display = 'none';
                downloadBtn.style.display = 'block';
                chartTitle.textContent = `Forecast Chart - ${data.topic}`;
                chartMetadata.textContent = `Generated from ${data.timeframe} days of data | Topic: ${data.topic}`;
            }
            
            chartContainer.style.display = 'block';
        }
        
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        function downloadChart() {
            if (!currentChartData) return;
            
            const link = document.createElement('a');
            link.href = currentChartData;
            link.download = `forecast-chart-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Check Plotly availability and update UI
        function checkPlotlyAvailability() {
            const interactiveCheckbox = document.getElementById('interactive');
            const label = interactiveCheckbox.nextElementSibling;
            
            if (typeof Plotly === 'undefined') {
                interactiveCheckbox.disabled = true;
                interactiveCheckbox.checked = false;
                label.textContent = 'Interactive Chart (Plotly loading...)';
                label.style.color = '#999';
                
                // Check again after a short delay
                setTimeout(() => {
                    if (typeof Plotly !== 'undefined') {
                        interactiveCheckbox.disabled = false;
                        label.textContent = 'Interactive Chart (hover tooltips)';
                        label.style.color = '';
                        console.log('‚úÖ Plotly loaded successfully');
                    } else {
                        label.textContent = 'Interactive Chart (Plotly not loaded - static only)';
                    }
                }, 2000);
            } else {
                interactiveCheckbox.disabled = false;
                label.textContent = 'Interactive Chart (hover tooltips)';
                label.style.color = '';
                console.log('‚úÖ Plotly loaded successfully');
            }
        }

        // Load categories for a topic
        async function loadCategories(topic) {
            try {
                const response = await fetch(`/api/forecast-charts/categories/${encodeURIComponent(topic)}`);
                const data = await response.json();
                
                const categoriesSelect = document.getElementById('categories');
                categoriesSelect.innerHTML = '<option value="">All Categories</option>';
                
                if (data.success && data.categories) {
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoriesSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // Load detailed consensus types
        async function loadConsensusTypes() {
            try {
                const response = await fetch('/api/forecast-charts/consensus-types');
                const data = await response.json();
                
                if (data.success && data.consensus_types) {
                    let modalContent = '<div class="modal fade" id="consensusTypesModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">';
                    modalContent += '<div class="modal-header"><h5 class="modal-title">üìä Detailed Consensus Type Explanations</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>';
                    modalContent += '<div class="modal-body">';
                    
                    Object.entries(data.consensus_types).forEach(([key, info]) => {
                        modalContent += `
                            <div class="mb-4 p-3 border rounded">
                                <h6 style="color: ${info.color}">${info.label}</h6>
                                <p class="mb-2"><strong>Description:</strong> ${info.description}</p>
                                <p class="mb-0 small text-muted"><strong>Rationale:</strong> ${info.rationale}</p>
                            </div>
                        `;
                    });
                    
                    modalContent += '</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>';
                    modalContent += '</div></div></div>';
                    
                    // Remove existing modal if any
                    const existingModal = document.getElementById('consensusTypesModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('consensusTypesModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading consensus types:', error);
                showError('Failed to load consensus type details');
            }
        }

        // Load available topics on page load
        window.addEventListener('load', async function() {
            // Check Plotly availability
            checkPlotlyAvailability();
            try {
                const response = await fetch('/api/topics');
                const data = await response.json();

                const topicSelect = document.getElementById('topic');

                if (data && data.length > 0) {
                    // Clear loading option
                    topicSelect.innerHTML = '<option value="">Select a topic...</option>';

                    data.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic.name;
                        option.textContent = topic.name;
                        topicSelect.appendChild(option);
                    });
                } else {
                    topicSelect.innerHTML = '<option value="">No topics with forecast data available</option>';
                    showError('No topics with forecast data found. Please ensure articles have been analyzed and categorized.');
                }
            } catch (error) {
                console.warn('Failed to load topics:', error);
                const topicSelect = document.getElementById('topic');
                topicSelect.innerHTML = '<option value="">Error loading topics</option>';
                showError('Failed to load available topics. Please check server connection.');
            }
        });
    </script>
</body>
</html> 