{% extends 'base.html' %}
{% block title %}Vector Analysis{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
    .layout {
        display: grid;
        grid-template-columns: 220px 1fr 260px;
        gap: 1rem;
        margin-top: 1.5rem;
        /* keep sidebars fixed, results scroll inside */
        height: calc(100vh - 120px);
        overflow: hidden;
    }
    .sidebar, .meta {
        background: var(--light-gray);
        padding: 1rem;
        border-radius: 8px;
        overflow-y: auto;
    }
    .main {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    #results {
        flex: 1;
        margin-top: 1rem;
        overflow-y: auto;
        height: 100%;
    }
    /* square icon buttons */
    .icon-btn {
        width: 32px;
        height: 32px;
        padding: 0;
        border-radius: 4px !important;
        background: var(--primary-color);
        color: #fff;
    }
    .icon-btn i { font-size: 14px; pointer-events: none; }
    /* metadata table */
    .meta table {width:100%; font-size:0.85rem;}
    .meta th{color:var(--primary-color); font-weight:500; white-space:nowrap;}
    .meta td{word-break:break-word;}
</style>

<div class="layout">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <h5>Filters</h5>
        <!-- Dynamic Facets from search response -->
        <div id="facetList" class="mb-3 small"></div>
        <small class="text-muted">Use <code>filter(field="value")</code> in the
            search bar to refine, e.g. <code>agi filter(category="AI Business")</code>
        </small>
        <hr>
        <div class="mb-3">
            <label class="form-label small">Max results</label>
            <input type="number" id="topK" class="form-control form-control-sm" value="100" min="1" max="500" style="width:100px;">
        </div>
        <button id="generateReportBtn" class="btn btn-secondary w-100 mb-2" disabled>Generate Report</button>
        <button id="generatePodcastBtn" class="btn btn-secondary w-100" disabled>Generate Podcast</button>
    </div>

    <!-- Center Main Content -->
    <div class="main">
        <div class="sticky-top bg-white pt-2" style="z-index:2;">
            <div class="input-group mb-2">
                <input type="text" id="searchInput" class="form-control" placeholder="Search news…">
                <div class="btn-group me-2">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" id="searchModeBtn">Fuzzy</button>
                    <ul class="dropdown-menu dropdown-menu-end small">
                        <li><a class="dropdown-item mode-select" data-mode="fuzzy" href="#">Fuzzy</a></li>
                        <li><a class="dropdown-item mode-select" data-mode="keyword" href="#">Keyword</a></li>
                    </ul>
                </div>
                <button id="searchBtn" class="btn btn-primary">Search</button>
            </div>
            <div id="activeFilters" class="mb-2"></div>
            <!-- Tabs -->
            <ul class="nav nav-tabs small mb-2" id="resultTabs" role="tablist">
              <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#eventsPane" type="button" role="tab">Events</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#patternsPane" type="button" role="tab">Patterns</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#vizPane" type="button" role="tab">Visualization</button></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="eventsPane" role="tabpanel">
                <canvas id="timelineChart" height="80"></canvas>
              </div>
              <div class="tab-pane fade" id="patternsPane" role="tabpanel">
                <div id="patternList" class="small p-2"></div>
              </div>
              <div class="tab-pane fade" id="vizPane" role="tabpanel">
                <div class="p-3 text-muted small" id="vizLoading">Loading…</div>
                <div class="d-flex align-items-center mb-1">
                  <select id="embedMethod" class="form-select form-select-sm me-2" style="width:120px;">
                    <option value="umap">UMAP</option>
                    <option value="tsne">t-SNE</option>
                    <option value="pca">PCA</option>
                  </select>
                  <div id="clusterLegend" class="small flex-wrap"></div>
                </div>
                <div id="scatter" style="width:100%;height:600px;display:none;"></div>
              </div>
            </div>
        </div>
        <div id="results"></div>
    </div>

    <!-- Right Metadata -->
    <div class="meta">
        <h5>Metadata</h5>
        <div id="metaContent" class="small"></div>
    </div>
</div>

<script>
async function runSearch() {
    const raw = document.getElementById('searchInput').value;
    if (!raw) return;

    const {cleaned, metadata} = parseQuery(raw);

    const topK = document.getElementById('topK').value;
    const mode = document.getElementById('searchModeBtn').dataset.mode || 'fuzzy';
    let data;
    if(mode==='keyword'){
        const params=new URLSearchParams({
            keyword: cleaned,
            per_page: topK,
            search_fields: 'title,summary,tags',
        });
        const res=await fetch(`/api/search_articles?${params.toString()}`);
        const raw=await res.json();
        const kwResults = raw.articles.map(a=>({id:a.uri,score:0,metadata:a}));
        // Build facets and simple timeline (by category & date)
        const facets = {};
        const timeline = {};
        kwResults.forEach(res=>{
            const m=res.metadata;
            ["topic","category","news_source","driver_type","sentiment"].forEach(f=>{
                if(m[f]){
                    facets[f]??={};
                    facets[f][m[f]] = (facets[f][m[f]]||0)+1;
                }
            });
            if(m.publication_date){
                const d=new Date(m.publication_date).toISOString().split('T')[0];
                const cat=m.category||'Uncategorized';
                timeline[cat]??={};
                timeline[cat][d]=(timeline[cat][d]||0)+1;
            }
        });
        data={results:kwResults,facets,timeline};
    }else{
        const params = new URLSearchParams({ q: cleaned, top_k: topK });
        Object.entries(metadata).forEach(([k,v])=>params.append(k, v));
        const res = await fetch(`/api/vector-search?${params.toString()}`);
        data = await res.json();
    }
    lastResults = data.results;
    selectedUris.clear();
    updateActionButtons();
    renderResults(data.results);
    renderFacets(data.facets || {});
    renderTimeline(data.timeline || {});
    updateActiveChips();
}

function renderResults(results) {
    const container = document.getElementById('results');
    container.innerHTML = '';
    results.forEach(r => {
        const card = document.createElement('div');
        card.className = 'card mb-2 position-relative ps-5';
        // Selection checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input position-absolute';
        checkbox.style.left = '12px';
        checkbox.style.top = '18px';
        checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
                selectedUris.add(r.id);
            } else {
                selectedUris.delete(r.id);
            }
            updateActionButtons();
        });

        const body = document.createElement('div');
        body.className = 'card-body';
        const title = r.metadata.title || 'Untitled';
        const link = r.metadata.uri ? `<a href="${r.metadata.uri}" target="_blank" rel="noopener">${title}</a>` : title;
        const summary = (r.metadata.summary || '').slice(0, 160);
        const cat = r.metadata.category ? `Category: ${r.metadata.category}` : '';
        const topic = r.metadata.topic ? `Topic: ${r.metadata.topic}` : '';
        const pub = r.metadata.publication_date ? new Date(r.metadata.publication_date).toISOString().split('T')[0] : '';

        body.innerHTML = `<h6 class="ms-4">${link}</h6>
            <p class='mb-1 ms-4'><small>${pub} · ${r.metadata.news_source || ''}</small></p>
            <p class='mb-1 text-muted small ms-4'>${summary}</p>
            <p class='mb-1 ms-4'><small>${cat}${cat && topic ? ' · ' : ''}${topic}</small></p>
            <p class='mb-1 ms-4'><small>Score: ${r.score.toFixed(3)}</small></p>
            <div class='d-flex gap-1 ms-4 mb-1'>
              <button class="btn icon-btn view-db" data-uri="${r.id}" title="View / edit"><i class="fas fa-eye"></i></button>
              <button class="btn icon-btn edit-note" data-uri="${r.id}" title="Annotate"><i class="fas fa-pen"></i></button>
              <a href="https://12ft.io/${r.metadata.uri}" target="_blank" class="btn icon-btn" title="Bypass paywall"><i class="fas fa-unlock"></i></a>
              <a href="https://archive.is/newest/${r.metadata.uri}" target="_blank" class="btn icon-btn" title="Archive snapshot"><i class="fas fa-box"></i></a>
            </div>`;
        card.appendChild(body);
        card.appendChild(checkbox);
        card.addEventListener('click', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'A' || e.target.closest('a')) return;
            renderMetadata(r.metadata);
        });
        container.appendChild(card);
    });
}

function renderFacets(facets) {
    const el = document.getElementById('facetList');
    el.innerHTML = '';
    Object.entries(facets).forEach(([field, values]) => {
        const group = document.createElement('div');
        group.className = 'mb-2';
        group.innerHTML = `<strong>${field}</strong>`;
        const list = document.createElement('ul');
        list.className = 'list-unstyled ms-2';

        const entries = Object.entries(values).sort((a, b) => b[1] - a[1]);
        entries.forEach(([val, count], idx) => {
            const li = document.createElement('li');
            if (idx >= 5) li.classList.add('d-none', 'extra');
            li.innerHTML = `<a href="#" data-field="${field}" data-value="${val}">${val}</a> <span class="text-muted">(${count})</span>`;
            list.appendChild(li);
        });

        if (entries.length > 5) {
            const toggle = document.createElement('a');
            toggle.href = '#';
            toggle.className = 'small';
            toggle.textContent = 'show more...';
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                list.querySelectorAll('.extra').forEach(li => li.classList.toggle('d-none'));
                toggle.textContent = toggle.textContent.startsWith('show') ? 'show less' : 'show more...';
            });
            group.appendChild(list);
            group.appendChild(toggle);
        } else {
            group.appendChild(list);
        }

        el.appendChild(group);
    });

    // Add click handler to facet links to auto-fill filters and rerun search
    el.querySelectorAll('a[data-field]').forEach((a) => {
        a.addEventListener('click', (evt) => {
            evt.preventDefault();
            const { field, value } = a.dataset;
            const input=document.getElementById('searchInput');
            const expr=`filter(${field}="${value}")`;
            if(input.value.includes(expr)){
                input.value=input.value.replace(expr,'').trim();
            }else{
                input.value=`${input.value} ${expr}`.trim();
            }
            runSearch();
        });
    });
}

// Simple bar chart with Chart.js (use CDN)
let timelineChart;
async function renderTimeline(timeline){
    if(!timeline || !Object.keys(timeline).length){return;}

    // Build date axis
    const dateSet=new Set();
    Object.values(timeline).forEach(catObj=>{
        Object.keys(catObj).forEach(d=>dateSet.add(d));
    });
    const labels=Array.from(dateSet).sort();

    const palette=[
        '#6c63ff','#ff6384','#36a2eb','#ff9f40','#4bc0c0','#9966ff','#c9cbcf',
    ];
    const datasets=Object.entries(timeline).map(([cat,obj],idx)=>({
        label:cat,
        data:labels.map(d=>obj[d]||0),
        backgroundColor:palette[idx%palette.length],
        stack:'stack1'
    }));

    if(!window.Chart){await loadChartJs();}
    const ctx=document.getElementById('timelineChart').getContext('2d');
    if(timelineChart){timelineChart.destroy();}
    timelineChart=new Chart(ctx,{
        type:'bar',
        data:{labels,datasets},
        options:{
            plugins:{legend:{display:true,position:'bottom'}},
            scales:{
                x:{stacked:true,ticks:{autoSkip:true,maxTicksLimit:10}},
                y:{stacked:true,beginAtZero:true},
            }
        }
    });
}

function loadChartJs(){
    return new Promise(res=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
        s.onload=res;
        document.head.appendChild(s);
    });
}

function renderMetadata(meta){
    const pre = document.getElementById('metaContent');
    const rows = Object.entries(meta).map(([k,v])=>{
        let val = v;
        if(k==='uri' || k==='url'){
            val = `<a href="${v}" target="_blank">link</a>`;
        }
        if(['topic','category','news_source','sentiment'].includes(k)){
            val = `<a href="#" class="meta-filter" data-field="${k}" data-val="${v}">${v}</a>`;
        }
        return `<tr><th class='text-end pe-2'>${k}</th><td>${val ?? ''}</td></tr>`;
    }).join('');
    pre.innerHTML = `<table class='table table-sm'>${rows}</table>`;

    // Related articles (same topic)
    const relDiv = document.createElement('div');
    relDiv.innerHTML = '<h6 class="mt-3">Related</h6>';
    const relList=document.createElement('ul');
    relList.className='list-unstyled small';
    // Fetch from backend similar endpoint
    fetch(`/api/vector-similar?uri=${encodeURIComponent(meta.uri)}&top_k=5`).then(r=>r.json()).then(d=>{
        d.results.forEach(r=>{
            const li=document.createElement('li');
            li.innerHTML=`<a href="#" class="related-link" data-id="${r.id}">${r.metadata.title}</a>`;
            relList.appendChild(li);
        });
    });
    relDiv.appendChild(relList);
    pre.appendChild(relDiv);

    // click related link to drill
    pre.querySelectorAll('.related-link').forEach(a=>{
        a.addEventListener('click',e=>{
            e.preventDefault();
            const id=a.dataset.id;
            const target= (lastResults||[]).find(r=>r.id===id);
            if(target) renderMetadata(target.metadata);
        });
    });

    // drill-down meta filters
    pre.querySelectorAll('.meta-filter').forEach(a=>{
        a.addEventListener('click',e=>{
            e.preventDefault();
            const { field, val } = a.dataset;
            const input=document.getElementById('searchInput');
            input.value=`${input.value} filter(${field}="${val}")`.trim();
            runSearch();
        });
    });
}

// -------------
// Filter parser
// -------------
function parseQuery(q){
    const metadata = {};
    const filterRegex = /filter\(([^)]+)\)/g;
    let cleaned=q;
    let m;
    while((m=filterRegex.exec(q))!==null){
        cleaned=cleaned.replace(m[0],'').trim();
        const inner=m[1];
        // Find every key="value" (quotes required to allow spaces)
        const pairRe=/(\w+)\s*=\s*"([^"]+)"/g;
        let p;
        while((p=pairRe.exec(inner))!==null){
            metadata[p[1]]=p[2];
        }
    }
    return {cleaned, metadata};
}

function updateActiveChips() {
    const container = document.getElementById('activeFilters');
    const { metadata } = parseQuery(document.getElementById('searchInput').value);
    container.innerHTML = '';

    Object.entries(metadata).forEach(([field, value]) => {
        const chip = document.createElement('span');
        chip.className = 'badge bg-primary me-1';
        chip.style.cursor = 'pointer';
        chip.textContent = `${field}: ${value} ×`;
        chip.addEventListener('click', () => {
            const raw = document.getElementById('searchInput').value;
            document.getElementById('searchInput').value = raw.replace(`filter(${field}="${value}")`,'').trim();
            runSearch();
        });
        container.appendChild(chip);
    });
    if (!Object.keys(metadata).length) {
        container.innerHTML = '<small class="text-muted">No filters applied</small>';
    }
}

// Selected uris and action buttons
const selectedUris = new Set();
function updateActionButtons() {
    document.getElementById('generateReportBtn').disabled = selectedUris.size === 0;
    document.getElementById('generatePodcastBtn').disabled = selectedUris.size === 0;
}

document.getElementById('generateReportBtn').addEventListener('click', async ()=>{
    if(!selectedUris.size) return;
    const res = await fetch('/api/generate_report',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ article_ids:[...selectedUris] })
    });
    if(res.ok){alert('Report generation started');}
});

document.getElementById('generatePodcastBtn').addEventListener('click', async ()=>{
    if(!selectedUris.size) return;
    const res = await fetch('/api/generate_tts_podcast',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ article_uris:[...selectedUris] })
    });
    if(res.ok){alert('Podcast generation started');}
});

document.getElementById('searchBtn').addEventListener('click', runSearch);

// Annotation modal appended at end of body when DOM ready
if(!document.getElementById('noteModal')){
    const modalHtml=`<div class="modal fade" id="noteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Annotate</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea id="noteText" class="form-control" rows="4"></textarea><div class="form-check mt-2"><input class="form-check-input" type="checkbox" id="notePrivate"><label class="form-check-label">Private</label></div></div><div class="modal-footer"><button class="btn btn-primary" id="noteSave">Save</button></div></div></div></div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

let currentAnnotateUri='';
document.body.addEventListener('click',e=>{
    const noteBtn=e.target.closest('.edit-note');
    if(noteBtn){
        currentAnnotateUri=noteBtn.dataset.uri;
        document.getElementById('noteText').value='';
        document.getElementById('notePrivate').checked=false;
        bootstrap.Modal.getOrCreateInstance(document.getElementById('noteModal')).show();
    }
});

document.getElementById('noteSave').addEventListener('click',async()=>{
    const txt=document.getElementById('noteText').value.trim();
    if(!txt) return;
    await fetch(`/api/articles/${encodeURIComponent(currentAnnotateUri)}/annotations`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({content:txt,is_private:document.getElementById('notePrivate').checked})
    });
    bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
    alert('Annotation saved');
});

// Article detail modal
if(!document.getElementById('articleModal')){
    document.body.insertAdjacentHTML('beforeend',`<div class="modal fade" id="articleModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Article Detail</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="articleDetail">Loading…</div></div></div></div></div>`);
}

document.body.addEventListener('click',async e=>{
    const btn=e.target.closest('.view-db');
    if(btn){
        const uri=btn.dataset.uri;
        const detailBox=document.getElementById('articleDetail');
        detailBox.textContent='Loading…';
        bootstrap.Modal.getOrCreateInstance('#articleModal').show();
        const res=await fetch(`/api/article?uri=${encodeURIComponent(uri)}`);
        if(res.ok){
            const data=await res.json();
            detailBox.innerHTML=`<pre class='small'>${JSON.stringify(data,null,2)}</pre>`;
        }else{
            detailBox.textContent='Failed to load article.';
        }
    }
});

// Search mode dropdown handlers
document.querySelectorAll('.mode-select').forEach(el=>{
    el.addEventListener('click',e=>{
        e.preventDefault();
        const mode=el.dataset.mode;
        document.getElementById('searchModeBtn').textContent=mode.charAt(0).toUpperCase()+mode.slice(1);
        document.getElementById('searchModeBtn').dataset.mode=mode;
    });
});

// ---------------------------
// Embedding visualisation (Plotly)
// ---------------------------
// Load and render once when the tab first becomes visible
let scatterLoaded=false;
document.querySelector('button[data-bs-target="#vizPane"]').addEventListener('shown.bs.tab',()=>{
    if(scatterLoaded) return;
    scatterLoaded=true;
    initScatter();
});

async function initScatter(){
    const loading=document.getElementById('vizLoading');
    const div=document.getElementById('scatter');

    // Bring in plotly if missing
    if(!window.Plotly){
        await new Promise(res=>{
            const s=document.createElement('script');
            s.src='https://cdn.plot.ly/plotly-2.27.0.min.js';
            s.onload=res;
            document.head.appendChild(s);
        });
    }

    // Initial fetch
    window.scatterPoints=[];
    await updateScatter();

    // click handler
    div.on('plotly_click',async ev=>{
        const idx=ev.points[0].pointIndex;
        const selId=window.scatterPoints[idx].id;
        const neighbours=await fetch(`/api/embedding_neighbours?id=${encodeURIComponent(selId)}&top_k=5`).then(r=>r.json());
        const ids=[selId,...neighbours.map(n=>n.id)];
        const style=window.scatterPoints.map(p=>ids.includes(p.id)?1:0.15);
        Plotly.restyle(div,{ 'marker.opacity':[style] });
    });

    loading.style.display='none';
    div.style.display='block';
}

// Refresh scatter with current filters
async function updateScatter(){
    const loading=document.getElementById('vizLoading');
    const div=document.getElementById('scatter');
    loading.textContent='Loading…';
    loading.style.display='block';

    // Build filter params
    const { metadata } = parseQuery(document.getElementById('searchInput').value);
    const params=new URLSearchParams();
    Object.entries(metadata).forEach(([k,v])=>params.append(k,v));
    params.append('method',document.getElementById('embedMethod').value);
    const res=await fetch(`/api/embedding_projection?${params.toString()}`);
    const data=await res.json();

    const pts = data.points || data;
    if(!pts.length){loading.textContent='No data';return;}

    window.scatterPoints=pts;
    window.clusterExplain=data.explain||{};
    window.clusterCentroids=data.centroids||{};

    const custom=pts.map(p=>(window.clusterExplain[p.cluster]||[]).join(', '));

    const trace={
        type:'scattergl',mode:'markers',
        x:pts.map(p=>p.x),
        y:pts.map(p=>p.y),
        marker:{size:7,color:pts.map(p=>p.cluster),colorscale:'Viridis',opacity:0.9},
        text:pts.map(p=>p.title||''),
        customdata:custom,
        hovertemplate:'%{text}<br><small>%{customdata}</small><extra>cluster=%{marker.color}</extra>'
    };
    Plotly.react(div,[trace],{margin:{t:0,l:0,r:0,b:0},hovermode:'closest',plugins:{legend:{display:true,position:'right'}}});

    // Build legend after fetching points
    const cls=[...new Set(pts.map(p=>p.cluster))].sort((a,b)=>a-b);
    rebuildLegend(cls);

    loading.style.display='none';
}

// Utility to build filter params object
function buildQueryParams(){
  const { cleaned, metadata } = parseQuery(document.getElementById('searchInput').value);
  const p=new URLSearchParams();
  if(cleaned){p.append('q', cleaned);}
  Object.entries(metadata).forEach(([k,v])=>p.append(k,v));
  return p;
}

function buildFilterParams(){
  const { metadata } = parseQuery(document.getElementById('searchInput').value);
  return metadata;
}

// ---------------------------
// Patterns and Statistics loaders
// ---------------------------
let patternsLoaded=false;

document.querySelector('button[data-bs-target="#patternsPane"]').addEventListener('shown.bs.tab',()=>{
  if(patternsLoaded) return;
  loadPatterns();
  patternsLoaded=true;
});

async function loadPatterns(){
  const res = await fetch(`/api/patterns?${buildQueryParams()}`);
  const data = await res.json();

  const list = document.getElementById('patternList');
  let html = '<h6>Top keywords</h6><div class="mb-2">';
  (data.ngrams||[]).slice(0,20).forEach(ng=>{
     html+=`<span class="badge bg-secondary me-1 mb-1">${ng.text} (${ng.count})</span>`;
  });
  html+='</div><h6 class="mt-3">Outliers</h6>';

  // Fetch top anomalies (embedding space outliers)
  const anoRes = await fetch(`/api/embedding_anomalies?${buildQueryParams()}`);
  const anomalies = await anoRes.json();
  html += anomalies.map(a=>`
       <div class="border-bottom py-1">
          <a href="#" class="outlier-link" data-id="${a.id}">${a.metadata.title || 'Untitled'}</a>
          <small class="text-muted">score ${a.score.toFixed(3)}</small>
       </div>`).join('');

  list.innerHTML = html;

  // click to open metadata
  list.querySelectorAll('.outlier-link').forEach(link=>{
      link.addEventListener('click',async e=>{
          e.preventDefault();
          const id=link.dataset.id;
          let target=(window.lastResults||[]).find(r=>r.id===id);
          if(!target){
               const res=await fetch(`/api/article?uri=${encodeURIComponent(id)}`);
               if(res.ok){
                   const meta=await res.json();
                   renderMetadata(meta);
                   return;
               }
          }
          if(target){renderMetadata(target.metadata);}            
      });
  });
}

// ---------------------------
// Visualization helpers – method dropdown & legend
// ---------------------------
document.getElementById('embedMethod').addEventListener('change',()=>{
  if(scatterLoaded){updateScatter();}
});

function rebuildLegend(clusters){
  const container=document.getElementById('clusterLegend');
  container.innerHTML='';
  clusters.forEach(idx=>{
    const span=document.createElement('span');
    span.className='badge me-1';
    span.style.background='#6c63ff';
    span.style.cursor='pointer';
    span.textContent=`Cluster ${idx}`;
    const kw=(window.clusterExplain||{})[idx];
    if(kw){span.title=kw.join(', ');}  // tooltip
    span.addEventListener('click',()=>{
      const style=window.scatterPoints.map(p=>p.cluster===idx?1:0.1);
      Plotly.restyle('scatter',{'marker.opacity':[style]});
    });
    container.appendChild(span);
  });
}

// simple fallback: cycle through a fixed palette
function palette(n){
  const base = ['#6c63ff','#36a2eb','#ff6384','#ff9f40',
                '#4bc0c0','#9966ff','#c9cbcf'];
  const colours = [];
  for (let i = 0; i < n; i++) colours.push(base[i % base.length]);
  return colours;
}
</script>
{% endblock %} 