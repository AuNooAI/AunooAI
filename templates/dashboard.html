{% extends "base.html" %}

{% block title %}N0RN AI - News Monitoring Dashboard{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #FF69B4;
        --primary-dark: #FF1493;
        --secondary-color: #32CD32;
        --secondary-dark: #228B22;
        --text-color: #333;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #343a40;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
    }

    .dashboard-card {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 24px;
        border: none;
        overflow: hidden;
    }

    .card-header {
        background-color: white;
        border-bottom: 1px solid var(--medium-gray);
        padding: 20px;
    }

    .card-title {
        color: var(--primary-color);
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    .content-section {
        padding: 20px;
        height: 100%;
    }

    .section-title {
        font-size: 1.1rem;
        color: var(--dark-gray);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .keyword-badge {
        background-color: var(--light-gray);
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 0.9rem;
        color: var(--text-color);
        display: inline-flex;
        align-items: center;
        margin-right: 10px;
    }

    .article-item {
        background-color: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        border: 1px solid var(--medium-gray);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .article-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-shadow);
    }

    .article-title {
        color: var(--primary-dark);
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .article-title a {
        color: inherit;
        text-decoration: none;
    }

    .article-title a:hover {
        color: var(--primary-color);
    }

    .article-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 12px;
        color: var(--dark-gray);
        font-size: 0.9rem;
    }

    .article-meta i {
        margin-right: 4px;
    }

    .article-summary {
        font-size: 0.95rem;
        line-height: 1.5;
        color: var(--text-color);
        margin: 8px 0;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
    }

    .controls {
        background-color: var(--light-gray);
        padding: 8px 16px;
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .form-control-sm {
        border-radius: 6px;
        border: 1px solid var(--medium-gray);
    }

    .btn-refresh {
        padding: 6px 12px;
        border-radius: 6px;
        background-color: var(--primary-color);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background-color 0.2s;
    }

    .btn-refresh:hover {
        background-color: var(--primary-dark);
    }

    .btn-edit {
        padding: 4px 12px;
        border-radius: 6px;
        background-color: var(--medium-gray);
        border: none;
        color: var(--dark-gray);
        font-size: 0.9rem;
        transition: background-color 0.2s;
    }

    .btn-edit:hover {
        background-color: var(--dark-gray);
        color: white;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        padding: 20px;
    }

    .articles-container {
        max-height: 800px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .articles-container::-webkit-scrollbar {
        width: 8px;
    }

    .articles-container::-webkit-scrollbar-track {
        background: var(--light-gray);
        border-radius: 4px;
    }

    .articles-container::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
    }

    .articles-container::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">News Monitoring Dashboard</h1>

    {% for topic in topics %}
    <div class="dashboard-card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="card-title">{{ topic.name }}</h2>
                <div class="controls">
                    <label class="mb-0">Show:</label>
                    <select class="form-control form-control-sm" 
                            id="articleCount-{{ topic.topic }}" 
                            style="width: 70px"
                            onchange="loadArticles('{{ topic.topic }}')">
                        {% for n in [3, 5, 10, 15, 20] %}
                        <option value="{{ n }}" {% if n == 5 %}selected{% endif %}>{{ n }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn-refresh" onclick="loadArticles('{{ topic.topic }}')">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <div class="row g-0">
            <!-- News Column -->
            <div class="col-md-6 border-end">
                <div class="content-section">
                    <div class="section-title">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <span class="me-2">News</span>
                                <div class="keyword-badge me-2">
                                    <span id="newsKeyword-{{ topic.topic }}">{{ topic.news_query }}</span>
                                    <button class="btn-edit ms-2" onclick="editKeyword('news', '{{ topic.topic }}')">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                </div>
                                <select class="form-control form-control-sm" 
                                        id="newsSort-{{ topic.topic }}" 
                                        style="width: 130px"
                                        onchange="loadArticles('{{ topic.topic }}')">
                                    <option value="publishedAt">Newest First</option>
                                    <option value="relevancy">Most Relevant</option>
                                    <option value="popularity">Most Popular</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="latestNews-{{ topic.topic }}" class="articles-container">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Papers Column -->
            <div class="col-md-6">
                <div class="content-section">
                    <div class="section-title">
                        <div class="d-flex align-items-center">
                            <span class="me-2">Papers</span>
                            <div class="keyword-badge">
                                <span id="paperKeyword-{{ topic.topic }}">{{ topic.paper_query }}</span>
                                <button class="btn-edit ms-2" onclick="editKeyword('paper', '{{ topic.topic }}')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="latestPapers-{{ topic.topic }}" class="articles-container">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
function loadArticles(topicId, type = 'both') {
    const countElement = document.getElementById(`articleCount-${topicId}`);
    const sortByElement = document.getElementById(`newsSort-${topicId}`);

    if (!countElement || !sortByElement) {
        console.error(`Elements not found for topicId: ${topicId}`);
        return;
    }

    const baseCount = parseInt(countElement.value);
    const sortBy = sortByElement.value;
    
    // Get hidden articles to calculate additional articles needed
    const hiddenArticles = JSON.parse(localStorage.getItem('hiddenArticles') || '{}');
    const topicHiddenArticles = hiddenArticles[topicId] || { news: [], papers: [] };
    
    // Request extra articles to account for hidden ones
    const extraNewsCount = Math.max(baseCount + (topicHiddenArticles.news?.length || 0), baseCount);
    const extraPapersCount = Math.max(baseCount + (topicHiddenArticles.papers?.length || 0), baseCount);

    // Show loading state only for affected column(s)
    const containersToUpdate = type === 'both' 
        ? ['latestNews', 'latestPapers'] 
        : [`latest${type.charAt(0).toUpperCase() + type.slice(1)}`];

    containersToUpdate.forEach(containerId => {
        document.getElementById(`${containerId}-${topicId}`).innerHTML = `
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
    });
    
    fetch(`/api/latest-news-and-papers?topicId=${encodeURIComponent(topicId)}&count=${Math.max(extraNewsCount, extraPapersCount)}&sortBy=${sortBy}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || !data.latest_news || !data.latest_papers) {
                throw new Error('Invalid data format received from server');
            }
            updateArticlesDisplay(topicId, data, type);
        })
        .catch(error => {
            console.error('Error loading articles:', error);
            containersToUpdate.forEach(containerId => {
                document.getElementById(`${containerId}-${topicId}`).innerHTML = `
                    <div class="alert alert-danger">
                        Error loading articles. Please try again.
                    </div>
                `;
            });
        });
}

function hideArticle(articleUrl, topicId, type) {
    console.log('Hiding article:', { articleUrl, topicId, type });
    
    // Get hidden articles from localStorage
    let hiddenArticles = JSON.parse(localStorage.getItem('hiddenArticles') || '{}');
    console.log('Current hidden articles before:', hiddenArticles);
    
    // Ensure proper structure
    if (!hiddenArticles[topicId] || Array.isArray(hiddenArticles[topicId])) {
        // Convert from old format or initialize new
        hiddenArticles[topicId] = {
            news: [],
            papers: []
        };
    }
    
    // Add article to appropriate list
    if (type === 'news' || type === 'papers') {
        if (!hiddenArticles[topicId][type].includes(articleUrl)) {
            hiddenArticles[topicId][type].push(articleUrl);
        }
        
        console.log('Updated hidden articles:', hiddenArticles);
        localStorage.setItem('hiddenArticles', JSON.stringify(hiddenArticles));
        
        // Reload only the affected column
        loadArticles(topicId, type);
    }
}

function updateArticlesDisplay(topicId, data, type = 'both') {
    const hiddenArticles = JSON.parse(localStorage.getItem('hiddenArticles') || '{}');
    const topicHiddenArticles = hiddenArticles[topicId] || { news: [], papers: [] };
    
    console.log('Filtering with hidden articles:', topicHiddenArticles);
    
    if (type === 'both' || type === 'news') {
        const newsArticles = data.latest_news || [];
        const filteredNews = newsArticles.filter(article => {
            const isHidden = topicHiddenArticles.news?.includes(article.url);
            console.log('News article:', article.url, 'Hidden:', isHidden);
            return !isHidden;
        });
        
        updateNewsContainer(topicId, filteredNews);
    }
    
    if (type === 'both' || type === 'papers') {
        const paperArticles = data.latest_papers || [];
        const filteredPapers = paperArticles.filter(article => {
            const isHidden = topicHiddenArticles.papers?.includes(article.url);
            console.log('Paper article:', article.url, 'Hidden:', isHidden);
            return !isHidden;
        });
        
        updatePapersContainer(topicId, filteredPapers);
    }
}

// Helper function to update news container
function updateNewsContainer(topicId, articles) {
    const container = document.getElementById(`latestNews-${topicId}`);
    container.innerHTML = articles.length ? articles.map(article => `
        <div class="article-item" data-article-url="${article.url}">
            <div class="row">
                ${article.image_url ? `
                    <div class="col-md-3">
                        <img src="${article.image_url}" class="img-fluid rounded" alt="Article image">
                    </div>
                    <div class="col-md-9">
                ` : '<div class="col-12">'}
                    <h3 class="article-title">
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer">
                            ${article.title}
                        </a>
                    </h3>
                    <div class="article-meta">
                        <span><i class="fas fa-newspaper"></i> ${article.source}</span>
                        <span><i class="fas fa-calendar"></i> ${article.date}</span>
                        ${article.author ? `<span><i class="fas fa-user"></i> ${article.author}</span>` : ''}
                    </div>
                    <p class="article-summary">${article.summary}</p>
                    <div class="mt-2">
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" 
                           class="btn btn-sm btn-outline-primary me-2">
                            <i class="fas fa-external-link-alt"></i> View
                        </a>
                        <a href="/research?url=${encodeURIComponent(article.url)}&topic=${encodeURIComponent(topicId)}" 
                           class="btn btn-sm btn-outline-success me-2">
                            <i class="fas fa-microscope"></i> Analyze
                        </a>
                        <button onclick="hideArticle('${article.url}', '${topicId}', 'news')"
                                class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-eye-slash"></i> Hide
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('') : '<div class="alert alert-info">No news articles found</div>';
}

// Helper function to update papers container
function updatePapersContainer(topicId, articles) {
    const container = document.getElementById(`latestPapers-${topicId}`);
    container.innerHTML = articles.length ? articles.map(article => `
        <div class="article-item" data-article-url="${article.url}">
            <h3 class="article-title">
                <a href="${article.url}" target="_blank" rel="noopener noreferrer">
                    ${article.title}
                </a>
            </h3>
            <div class="article-meta">
                <span><i class="fas fa-calendar"></i> ${article.date}</span>
                ${article.authors?.length ? `<span><i class="fas fa-users"></i> ${article.authors.join(', ')}</span>` : ''}
            </div>
            <p class="article-summary">${article.summary}</p>
            <div class="mt-2">
                <a href="${article.url}" target="_blank" rel="noopener noreferrer" 
                   class="btn btn-sm btn-outline-primary me-2">
                    <i class="fas fa-external-link-alt"></i> View
                </a>
                <a href="/research?url=${encodeURIComponent(article.url)}&topic=${encodeURIComponent(topicId)}" 
                   class="btn btn-sm btn-outline-success me-2">
                    <i class="fas fa-microscope"></i> Analyze
                </a>
                <button onclick="hideArticle('${article.url}', '${topicId}', 'papers')"
                        class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-eye-slash"></i> Hide
                </button>
            </div>
        </div>
    `).join('') : '<div class="alert alert-info">No papers found</div>';
}

document.addEventListener('DOMContentLoaded', () => {
    {% for topic in topics %}
    loadArticles('{{ topic.topic }}');
    {% endfor %}
});

function editKeyword(type, topicId) {
    const elementId = `${type}Keyword-${topicId}`;
    const currentKeyword = document.getElementById(elementId).textContent.trim();
    const newKeyword = prompt(`Enter new ${type} keyword:`, currentKeyword);
    
    if (newKeyword && newKeyword !== currentKeyword) {
        fetch('/api/update-keyword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic_id: topicId,
                keyword_type: type,
                new_keyword: newKeyword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(elementId).textContent = newKeyword;
                loadArticles(topicId);
            } else {
                alert('Failed to update keyword: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update keyword');
        });
    }
}
</script>
{% endblock %}

{% block extra_js %}
<script>
</script>
{% endblock %} 