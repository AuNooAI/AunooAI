{% extends "base.html" %}

{% block title %}AuNoo AI - News Monitoring Dashboard{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #FF69B4;
        --primary-dark: #FF1493;
        --secondary-color: #32CD32;
        --secondary-dark: #228B22;
        --text-color: #333;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #343a40;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
    }

    h1, h2, h5, h6 {
        color: var(--primary-color);
    }

    .dashboard-card {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 24px;
        border: none;
        overflow: hidden;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .card-header {
        background-color: white;
        border-bottom: 1px solid var(--medium-gray);
        padding: 20px;
    }

    .card-title {
        color: var(--primary-color);
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    .content-section {
        padding: 20px;
        height: 500px;
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .section-title {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
    }

    .section-title-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        width: 100%;
    }

    .section-controls {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        margin-left: auto;
    }

    .keyword-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background-color: var(--light-gray);
        border-radius: 4px;
        flex: 1;
        min-width: 0;
    }

    .keyword-badge span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        min-width: 0;
    }

    .article-item {
        background-color: white;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        border: 1px solid var(--medium-gray);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .article-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-shadow);
    }

    .article-title {
        color: var(--primary-dark);
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .article-title a {
        color: inherit;
        text-decoration: none;
    }

    .article-title a:hover {
        color: var(--primary-color);
    }

    .article-meta {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        margin-bottom: 12px;
        color: var(--dark-gray);
        font-size: 0.9rem;
    }

    .article-meta i {
        margin-right: 4px;
    }

    .article-summary {
        font-size: 0.95rem;
        line-height: 1.5;
        color: var(--text-color);
        margin: 8px 0;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        /* Fallback for browsers that don't support -webkit-line-clamp */
        max-height: 6em;  /* line-height * number of lines */
    }

    .controls {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
    }

    .form-control-sm {
        min-width: 80px;
        width: auto;
    }

    .btn-refresh,
    .btn-edit,
    .btn-delete {
        padding: 4px 8px;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .btn-refresh {
        padding: 6px 12px;
        border-radius: 6px;
        background-color: var(--primary-color);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background-color 0.2s;
    }

    .btn-refresh:hover {
        background-color: var(--primary-dark);
    }

    .btn-edit:hover {
        background-color: var(--dark-gray);
        color: white;
    }

    .btn-delete:hover {
        background-color: #bb2d3b;
        color: white;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        padding: 20px;
    }

    .articles-container {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
    }

    .articles-container::-webkit-scrollbar {
        width: 8px;
    }

    .articles-container::-webkit-scrollbar-track {
        background: var(--light-gray);
        border-radius: 4px;
    }

    .articles-container::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
    }

    .articles-container::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }

    /* Update the grid layout to use single column */
    .dashboard-container {
        max-width: 1200px;  /* More reasonable max-width for single column */
        margin: 0 auto;
        padding: 0 15px;
    }

    /* Update the columns layout */
    .news-papers-container {
        display: flex;
        gap: 20px;
    }

    .news-column, .papers-column {
        flex: 1;
        min-width: 0; /* Allows content to shrink below min-content width */
    }

    .border-divider {
        width: 1px;
        background-color: var(--medium-gray);
        margin: 0;
    }

    /* Improve section title layout */
    .section-title {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
    }

    /* Adjust button group layout */
    .mt-2 {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    /* Make sort selector more compact */
    .sort-select {
        width: 120px;
        min-width: 120px;
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container mt-4">
    <!-- Add status messages section -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-3">News Monitoring Dashboard</h2>
            <div class="d-flex flex-column gap-2">
                {% if last_error %}
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        {{ last_error }}
                    </div>
                {% endif %}
                <div class="d-flex align-items-center gap-3">
                    <div class="text-muted">
                        <i class="fas fa-chart-line"></i> API Requests Today: 
                        <span id="requestCount">0</span>/<span id="requestLimit">100</span>
                    </div>
                    {% if is_rate_limited %}
                        <span class="text-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Daily request limit reached. Some content may be unavailable.
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Existing dashboard content -->
    <div class="dashboard-content">
        {% for topic in topics %}
        <div id="topic-card-{{ topic.id }}">
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <h2 class="card-title mb-0">{{ topic.name }}</h2>
                        <div class="controls">
                            <div class="d-flex align-items-center gap-2">
                                <label class="mb-0">Show:</label>
                                <select class="form-control form-control-sm" 
                                        id="articleCount-{{ topic.topic }}"
                                        onchange="loadArticles('{{ topic.topic }}')">
                                    {% for n in [3, 5, 10, 15, 20] %}
                                    <option value="{{ n }}" {% if n == 5 %}selected{% endif %}>{{ n }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button class="btn-refresh" onclick="loadArticles('{{ topic.topic }}')">
                                <i class="fas fa-sync-alt"></i>
                                <span class="d-none d-sm-inline">Refresh</span>
                            </button>
                            <button class="btn-delete" onclick="deleteTopic('{{ topic.topic }}')">
                                <i class="fas fa-trash"></i>
                                <span class="d-none d-sm-inline">Delete</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Replace row g-0 with new structure -->
                <div class="news-papers-container">
                    <!-- News Column -->
                    <div class="news-column">
                        <div class="content-section">
                            <div class="section-title">
                                <div class="section-title-row">
                                    <span>News</span>
                                    <div class="keyword-badge">
                                        <span id="newsKeyword-{{ topic.topic }}">{{ topic.news_query }}</span>
                                        <button class="btn-edit" onclick="editKeyword('news', '{{ topic.topic }}')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                    <div class="section-controls">
                                        <select class="form-control form-control-sm sort-select" 
                                                id="newsSort-{{ topic.topic }}"
                                                onchange="loadArticles('{{ topic.topic }}')">
                                            <option value="publishedAt">Newest First</option>
                                            <option value="relevancy">Most Relevant</option>
                                            <option value="popularity">Most Popular</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="latestNews-{{ topic.topic }}" class="articles-container">
                                <div class="loading-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-divider"></div>
                    
                    <!-- Papers Column -->
                    <div class="papers-column">
                        <div class="content-section">
                            <div class="section-title">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">Papers</span>
                                    <div class="keyword-badge">
                                        <span id="paperKeyword-{{ topic.topic }}">{{ topic.paper_query }}</span>
                                        <button class="btn-edit ms-2" onclick="editKeyword('paper', '{{ topic.topic }}')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="latestPapers-{{ topic.topic }}" class="articles-container">
                                <div class="loading-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function loadArticles(topicId, type = 'both') {
    const countElement = document.getElementById(`articleCount-${topicId}`);
    const sortByElement = document.getElementById(`newsSort-${topicId}`);

    if (!countElement || !sortByElement) {
        console.error(`Elements not found for topicId: ${topicId}`);
        return;
    }

    const baseCount = parseInt(countElement.value);
    const sortBy = sortByElement.value;
    
    // Get hidden articles to calculate additional articles needed
    const hiddenArticles = JSON.parse(localStorage.getItem('hiddenArticles') || '{}');
    const topicHiddenArticles = hiddenArticles[topicId] || { news: [], papers: [] };
    
    // Request extra articles to account for hidden ones
    const extraNewsCount = Math.max(baseCount + (topicHiddenArticles.news?.length || 0), baseCount);
    const extraPapersCount = Math.max(baseCount + (topicHiddenArticles.papers?.length || 0), baseCount);

    // Show loading state only for affected column(s)
    const containersToUpdate = type === 'both' 
        ? ['latestNews', 'latestPapers'] 
        : [`latest${type.charAt(0).toUpperCase() + type.slice(1)}`];

    containersToUpdate.forEach(containerId => {
        document.getElementById(`${containerId}-${topicId}`).innerHTML = `
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
    });
    
    fetch(`/api/latest-news-and-papers?topicId=${encodeURIComponent(topicId)}&count=${Math.max(extraNewsCount, extraPapersCount)}&sortBy=${sortBy}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || !data.latest_news || !data.latest_papers) {
                throw new Error('Invalid data format received from server');
            }
            updateArticlesDisplay(topicId, data, type);
        })
        .catch(error => {
            console.error('Error loading articles:', error);
            containersToUpdate.forEach(containerId => {
                document.getElementById(`${containerId}-${topicId}`).innerHTML = `
                    <div class="alert alert-danger">
                        Error loading articles. Please try again.
                    </div>
                `;
            });
        });
}

function hideArticle(articleUrl, topicId, type) {
    console.log('Hiding article:', { articleUrl, topicId, type });
    
    // Get hidden articles from localStorage
    let hiddenArticles = JSON.parse(localStorage.getItem('hiddenArticles') || '{}');
    console.log('Current hidden articles before:', hiddenArticles);
    
    // Ensure proper structure
    if (!hiddenArticles[topicId] || Array.isArray(hiddenArticles[topicId])) {
        // Convert from old format or initialize new
        hiddenArticles[topicId] = {
            news: [],
            papers: []
        };
    }
    
    // Add article to appropriate list
    if (type === 'news' || type === 'papers') {
        if (!hiddenArticles[topicId][type].includes(articleUrl)) {
            hiddenArticles[topicId][type].push(articleUrl);
        }
        
        console.log('Updated hidden articles:', hiddenArticles);
        localStorage.setItem('hiddenArticles', JSON.stringify(hiddenArticles));
        
        // Reload only the affected column
        loadArticles(topicId, type);
    }
}

function updateArticlesDisplay(topicId, data, type = 'both') {
    const hiddenArticles = JSON.parse(localStorage.getItem('hiddenArticles') || '{}');
    const topicHiddenArticles = hiddenArticles[topicId] || { news: [], papers: [] };
    
    console.log('Filtering with hidden articles:', topicHiddenArticles);
    
    if (type === 'both' || type === 'news') {
        const newsArticles = data.latest_news || [];
        const filteredNews = newsArticles.filter(article => {
            const isHidden = topicHiddenArticles.news?.includes(article.url);
            console.log('News article:', article.url, 'Hidden:', isHidden);
            return !isHidden;
        });
        
        updateNewsContainer(topicId, filteredNews);
    }
    
    if (type === 'both' || type === 'papers') {
        const paperArticles = data.latest_papers || [];
        const filteredPapers = paperArticles.filter(article => {
            const isHidden = topicHiddenArticles.papers?.includes(article.url);
            console.log('Paper article:', article.url, 'Hidden:', isHidden);
            return !isHidden;
        });
        
        updatePapersContainer(topicId, filteredPapers);
    }
}

// Helper function to update news container
function updateNewsContainer(topicId, articles) {
    const container = document.getElementById(`latestNews-${topicId}`);
    container.innerHTML = articles.length ? articles.map(article => `
        <div class="article-item" data-article-url="${article.url}">
            <div class="row">
                ${article.image_url ? `
                    <div class="col-md-3">
                        <img src="${article.image_url}" class="img-fluid rounded" alt="Article image">
                    </div>
                    <div class="col-md-9">
                ` : '<div class="col-12">'}
                    <h3 class="article-title">
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer">
                            ${article.title}
                        </a>
                    </h3>
                    <div class="article-meta">
                        <span><i class="fas fa-newspaper"></i> ${article.source}</span>
                        <span><i class="fas fa-calendar"></i> ${article.date}</span>
                        ${article.author ? `<span><i class="fas fa-user"></i> ${article.author}</span>` : ''}
                    </div>
                    <p class="article-summary">${article.summary}</p>
                    <div class="mt-2">
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" 
                           class="btn btn-sm btn-outline-primary me-2">
                            <i class="fas fa-external-link-alt"></i> View
                        </a>
                        <a href="https://archive.is/${encodeURIComponent(article.url)}" 
                           target="_blank" rel="noopener noreferrer"
                           class="btn btn-sm btn-outline-secondary me-2">
                            <i class="fas fa-unlock"></i> Bypass Paywall
                        </a>
                        <a href="/research?url=${encodeURIComponent(article.url)}&topic=${encodeURIComponent(topicId)}" 
                           class="btn btn-sm btn-outline-success me-2">
                            <i class="fas fa-microscope"></i> Analyze
                        </a>
                        <button onclick="hideArticle('${article.url}', '${topicId}', 'news')"
                                class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-eye-slash"></i> Hide
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('') : '<div class="alert alert-info">No news articles found</div>';
}

// Helper function to update papers container
function updatePapersContainer(topicId, articles) {
    const container = document.getElementById(`latestPapers-${topicId}`);
    container.innerHTML = articles.length ? articles.map(article => `
        <div class="article-item" data-article-url="${article.url}">
            <h3 class="article-title">
                <a href="${article.url}" target="_blank" rel="noopener noreferrer">
                    ${article.title}
                </a>
            </h3>
            <div class="article-meta">
                <span><i class="fas fa-calendar"></i> ${article.date}</span>
                ${article.authors?.length ? `<span><i class="fas fa-users"></i> ${article.authors.join(', ')}</span>` : ''}
            </div>
            <p class="article-summary">${article.summary}</p>
            <div class="mt-2">
                <a href="${article.url}" target="_blank" rel="noopener noreferrer" 
                   class="btn btn-sm btn-outline-primary me-2">
                    <i class="fas fa-external-link-alt"></i> View
                </a>
                <a href="https://archive.is/${encodeURIComponent(article.url)}" 
                   target="_blank" rel="noopener noreferrer"
                   class="btn btn-sm btn-outline-secondary me-2">
                            <i class="fas fa-unlock"></i> Bypass Paywall
                        </a>
                <a href="/research?url=${encodeURIComponent(article.url)}&topic=${encodeURIComponent(topicId)}" 
                   class="btn btn-sm btn-outline-success me-2">
                    <i class="fas fa-microscope"></i> Analyze
                </a>
                <button onclick="hideArticle('${article.url}', '${topicId}', 'papers')"
                        class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-eye-slash"></i> Hide
                </button>
            </div>
        </div>
    `).join('') : '<div class="alert alert-info">No papers found</div>';
}

document.addEventListener('DOMContentLoaded', () => {
    {% for topic in topics %}
    loadArticles('{{ topic.topic }}');
    {% endfor %}
});

function editKeyword(type, topicId) {
    const elementId = `${type}Keyword-${topicId}`;
    const currentKeyword = document.getElementById(elementId).textContent.trim();
    const newKeyword = prompt(`Enter new ${type} keyword:`, currentKeyword);
    
    if (newKeyword && newKeyword !== currentKeyword) {
        fetch('/api/update-keyword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic_id: topicId,
                keyword_type: type,
                new_keyword: newKeyword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(elementId).textContent = newKeyword;
                loadArticles(topicId);
            } else {
                alert('Failed to update keyword: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update keyword');
        });
    }
}

async function deleteTopic(topicId) {
    if (!confirm(`Are you sure you want to delete the topic "${topicId}"?`)) {
        return;
    }

    const deleteArticles = confirm(`Do you want to delete all associated articles for topic "${topicId}" from the database?`);

    try {
        const response = await fetch(`/api/topic/${encodeURIComponent(topicId)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                delete_articles: deleteArticles
            })
        });

        if (!response.ok) {
            throw new Error(`Failed to delete topic: ${response.statusText}`);
        }

        // Remove the topic card from the DOM
        const topicCard = document.getElementById(`topic-card-${topicId}`);
        if (topicCard) {
            topicCard.remove();
        }

        // If no topics left, show a message
        const remainingTopics = document.querySelectorAll('.dashboard-card');
        if (remainingTopics.length === 0) {
            const container = document.querySelector('.dashboard-container');
            container.insertAdjacentHTML('beforeend', `
                <div class="alert alert-info mt-4">
                    No topics available. <a href="/create_topic">Create a new topic</a>
                </div>
            `);
        }
    } catch (error) {
        console.error('Error deleting topic:', error);
        alert('Failed to delete topic: ' + error.message);
    }
}

// Add function to update request count and status message
async function updateRequestStatus() {
    try {
        const response = await fetch('/api/keyword-monitor/settings');
        if (response.ok) {
            const settings = await response.json();
            const requestCount = document.getElementById('requestCount');
            const requestLimit = document.getElementById('requestLimit');
            
            if (settings.last_error && (
                settings.last_error.includes("Rate limit exceeded") || 
                settings.last_error.includes("limit reached")
            )) {
                requestCount.textContent = settings.daily_request_limit;
                requestCount.parentElement.classList.add('text-warning');
                
                // Show rate limit message if not already shown
                if (!document.querySelector('.alert-warning')) {
                    const statusDiv = document.querySelector('.d-flex.flex-column.gap-2');
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning d-flex align-items-center';
                    alert.innerHTML = `
                        <i class="fas fa-exclamation-circle me-2"></i>
                        API daily request limit reached. Some content may be unavailable.
                    `;
                    statusDiv.prepend(alert);
                }
            } else {
                requestCount.textContent = settings.requests_today;
                requestLimit.textContent = settings.daily_request_limit;
                requestCount.parentElement.classList.remove('text-warning');
            }
        }
    } catch (error) {
        console.error('Error updating request status:', error);
    }
}

// Update status every minute
setInterval(updateRequestStatus, 60000);

// Initial load
document.addEventListener('DOMContentLoaded', updateRequestStatus);
</script>
{% endblock %}

{% block extra_js %}
<script>
// Existing world clock functionality
function updateClocks() {
    const clockElements = document.querySelectorAll('.clock-time');
    clockElements.forEach(clock => {
        const timezone = clock.dataset.timezone;
        const time = new Date().toLocaleTimeString('en-US', {
            timeZone: timezone,
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        clock.textContent = time;
    });
}

// Keep existing topic overview functionality
function toggleTopicOverview() {
    const content = document.getElementById('topicOverviewContent');
    const icon = document.getElementById('topicOverviewIcon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    } else {
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    }
}

// Keep existing initialization
document.addEventListener('DOMContentLoaded', function() {
    updateClocks();
    setInterval(updateClocks, 1000);
});
</script>
{% endblock %} 