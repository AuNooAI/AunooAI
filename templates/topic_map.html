<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic Map - Knowledge Graph</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --primary-color: #FF69B4;  /* Hot Pink */
            --primary-dark: #FF1493;   /* Deep Pink */
            --secondary-color: #32CD32;  /* Lime Green */
            --secondary-dark: #228B22;   /* Forest Green */
            --text-color: #333;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            min-height: 100vh;
        }
        
        .topic-map-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            margin: 20px;
            overflow: hidden;
        }
        
        .map-header {
            background: white;
            color: var(--text-color);
            padding: 30px;
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
        }

        .map-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2rem;
            font-weight: 600;
        }

        .map-header p {
            color: var(--dark-gray);
            margin: 0;
            font-size: 1.1rem;
        }
        
        .controls-panel {
            background: var(--light-gray);
            padding: 20px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        #topic-map-svg {
            width: 100%;
            height: 700px;
            border: 1px solid var(--medium-gray);
            background: white;
            cursor: grab;
        }
        
        #topic-map-svg:active {
            cursor: grabbing;
        }
        
        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .node:hover {
            stroke: var(--primary-color);
            stroke-width: 3px;
        }
        
        .node-main {
            filter: drop-shadow(3px 3px 6px rgba(0,0,0,0.3));
        }
        
        .node-sub {
            opacity: 0.8;
        }
        
        .link {
            stroke: var(--medium-gray);
            stroke-opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .link:hover {
            stroke-opacity: 1;
            stroke-width: 3px;
            stroke: var(--primary-color);
        }
        
        .node-label {
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            fill: var(--text-color);
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
            font-weight: 500;
        }
        
        .main-topic-label {
            font-size: 14px;
            font-weight: bold;
            fill: var(--dark-gray);
        }
        
        .tooltip {
            position: absolute;
            background: rgba(52, 58, 64, 0.95);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .stats-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        .spinner {
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .legend {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .legend h6 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 12px;
        }

        /* Button styling to match app */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-outline-secondary {
            border-color: var(--medium-gray);
            color: var(--dark-gray);
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-outline-secondary:hover {
            background-color: var(--dark-gray);
            border-color: var(--dark-gray);
            color: white;
        }

        .form-control, .form-select {
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            padding: 8px 12px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
        }

        .form-label {
            color: var(--dark-gray);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-range {
            accent-color: var(--primary-color);
        }

        #limitValue {
            color: var(--primary-color);
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="topic-map-container">
            <div class="map-header">
                <h1><i class="fas fa-sitemap me-2"></i>Topic Knowledge Map</h1>
                <p>Interactive visualization of topic relationships from your articles</p>
            </div>
            
            <div class="controls-panel">
                <div class="filter-controls">
                    <div>
                        <label for="topicFilter" class="form-label">Filter by Topic:</label>
                        <select id="topicFilter" class="form-select form-select-sm" style="width: 200px;">
                            <option value="">All Topics</option>
                        </select>
                    </div>
                    <div>
                        <label for="categoryFilter" class="form-label">Filter by Category:</label>
                        <select id="categoryFilter" class="form-select form-select-sm" style="width: 200px;">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div>
                        <label for="limitFilter" class="form-label">Article Limit:</label>
                        <input type="range" id="limitFilter" min="50" max="1000" value="500" step="50" class="form-range" style="width: 150px;">
                        <span id="limitValue">500</span>
                    </div>
                    <button id="generateBtn" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-1"></i>Generate Map
                    </button>
                    <button id="resetZoomBtn" class="btn btn-outline-secondary">
                        <i class="fas fa-search-minus me-1"></i>Reset Zoom
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <!-- Topic Map Visualization -->
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-project-diagram me-2"></i>
                                Knowledge Graph - 3-Layer Hierarchy
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="topicMapContainer" style="width: 100%; height: 600px; position: relative;">
                                <!-- D3.js will create SVG here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="legend">
                        <h6><i class="fas fa-info-circle me-1"></i>3-Layer Knowledge Graph</h6>
                        <div class="legend-item">
                            <div class="legend-symbol" style="width: 24px; height: 16px; background: var(--primary-color); border-radius: 4px;"></div>
                            <span>Categories (Layer 1)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol" style="width: 16px; height: 16px; background: var(--secondary-color); border-radius: 50%;"></div>
                            <span>Topics (Layer 2)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol diamond" style="width: 12px; height: 12px; background: #E6E6FA; transform: rotate(45deg);"></div>
                            <span>Subtopics (Layer 3)</span>
                        </div>
                        <div class="mt-3">
                            <h6>How to Navigate:</h6>
                            <small>
                                • <strong>Categories</strong> group articles by main themes<br>
                                • <strong>Topics</strong> are semantic clusters within categories<br>
                                • <strong>Subtopics</strong> provide detailed breakdowns<br>
                                • Drag nodes to explore • Zoom to see details
                            </small>
                        </div>
                    </div>
                    
                    <!-- Statistics Panel -->
                    <div class="statistics-panel mt-4">
                        <h6><i class="fas fa-chart-bar me-1"></i>Statistics</h6>
                        <div id="stats-content">
                            <p class="text-muted">Generate a topic map to see statistics</p>
                        </div>
                    </div>
                    
                    <!-- Filter Options -->
                    <div class="filter-options mt-4">
                        <h6><i class="fas fa-filter me-1"></i>Filter Options</h6>
                        <div class="mb-3">
                            <label for="topicFilter" class="form-label">Topic:</label>
                            <select id="topicFilter" class="form-select form-select-sm">
                                <option value="">All Topics</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="categoryFilter" class="form-label">Category:</label>
                            <select id="categoryFilter" class="form-select form-select-sm">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="limitFilter" class="form-label">Article Limit:</label>
                            <select id="limitFilter" class="form-select form-select-sm">
                                <option value="50">50 articles</option>
                                <option value="100">100 articles</option>
                                <option value="200">200 articles</option>
                                <option value="500" selected>500 articles</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm w-100" onclick="generateTopicMap()">
                            <i class="fas fa-sync-alt me-1"></i>Update Map
                        </button>
                    </div>
                    
                    <!-- Status Panel -->
                    <div id="status" class="mt-4">
                        <!-- Status messages will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip" style="display: none;"></div>
    
    <script>
        // D3.js Topic Map Visualization with 3-Layer Hierarchy
        let svg, simulation, nodes, links, zoom;
        let currentData = null;
        
        function initVisualization() {
            const container = d3.select('#topicMapContainer');
            const containerRect = container.node().getBoundingClientRect();
            const width = containerRect.width;
            const height = Math.max(600, containerRect.height);
            
            // Clear existing SVG
            container.selectAll('*').remove();
            
            // Create zoom behavior
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    svg.select('.main-group').attr('transform', event.transform);
                });
            
            svg = container.append('svg')
                .attr('width', width)
                .attr('height', height)
                .call(zoom)
                .append('g')
                .attr('class', 'main-group');
            
            // Create layers for different node types
            svg.append('g').attr('class', 'edges');
            svg.append('g').attr('class', 'category-nodes');
            svg.append('g').attr('class', 'topic-nodes');
            svg.append('g').attr('class', 'subtopic-nodes');
            
            // Initialize simulation with 3-layer force layout
            simulation = d3.forceSimulation()
                .force('link', d3.forceLink().id(d => d.id).distance(d => {
                    // Different distances for different connection types
                    if (d.type === 'category_to_topic') return 120;
                    if (d.type === 'topic_to_subtopic') return 80;
                    if (d.type === 'cross_topic_relation') return 200;
                    return 100;
                }))
                .force('charge', d3.forceManyBody().strength(d => {
                    // Different charge for different layers
                    if (d.type === 'category') return -800;
                    if (d.type === 'topic') return -400;
                    if (d.type === 'subtopic') return -200;
                    return -300;
                }))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => (d.size || 20) + 5))
                .force('x', d3.forceX(d => {
                    // Position categories on the left, topics in center, subtopics on right
                    if (d.type === 'category') return width * 0.2;
                    if (d.type === 'topic') return width * 0.5;
                    if (d.type === 'subtopic') return width * 0.8;
                    return width / 2;
                }).strength(0.3))
                .force('y', d3.forceY(height / 2).strength(0.1));
        }
        
        function updateVisualization(data) {
            if (!data || !data.nodes || !data.edges) {
                console.error('Invalid data for visualization');
                return;
            }
            
            currentData = data;
            console.log(`Rendering ${data.nodes.length} nodes and ${data.edges.length} edges`);
            console.log('Layer breakdown:', {
                categories: data.nodes.filter(n => n.type === 'category').length,
                topics: data.nodes.filter(n => n.type === 'topic').length,
                subtopics: data.nodes.filter(n => n.type === 'subtopic').length
            });
            
            // Update simulation data
            simulation.nodes(data.nodes);
            simulation.force('link').links(data.edges);
            
            // Render edges
            const linkSelection = svg.select('.edges')
                .selectAll('line')
                .data(data.edges);
                
            linkSelection.exit().remove();
            
            const linkEnter = linkSelection.enter()
                .append('line')
                .attr('stroke-width', d => Math.max(1, (d.weight || 1) / 2))
                .attr('stroke', d => {
                    if (d.type === 'category_to_topic') return '#666';
                    if (d.type === 'topic_to_subtopic') return '#999';
                    if (d.type === 'cross_topic_relation') return '#ccc';
                    return '#888';
                })
                .attr('stroke-opacity', 0.6);
            
            const links = linkEnter.merge(linkSelection);
            
            // Render nodes by type with different styling for each layer
            renderNodeLayer('category', data.nodes.filter(n => n.type === 'category'));
            renderNodeLayer('topic', data.nodes.filter(n => n.type === 'topic'));
            renderNodeLayer('subtopic', data.nodes.filter(n => n.type === 'subtopic'));
            
            // Update simulation tick function
            simulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                svg.selectAll('.node-group')
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
            
            simulation.restart();
        }
        
        function renderNodeLayer(layerType, layerNodes) {
            const layerClass = `${layerType}-nodes`;
            const nodeSelection = svg.select(`.${layerClass}`)
                .selectAll('.node-group')
                .data(layerNodes, d => d.id);
            
            nodeSelection.exit().remove();
            
            const nodeEnter = nodeSelection.enter()
                .append('g')
                .attr('class', 'node-group')
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded));
            
            // Add different shapes for different layer types
            if (layerType === 'category') {
                // Categories: Large rectangles
                nodeEnter.append('rect')
                    .attr('width', d => d.size || 60)
                    .attr('height', d => (d.size || 60) * 0.6)
                    .attr('x', d => -(d.size || 60) / 2)
                    .attr('y', d => -(d.size || 60) * 0.3)
                    .attr('rx', 8)
                    .attr('fill', d => d.color || '#FF69B4')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 3);
            } else if (layerType === 'topic') {
                // Topics: Medium circles
                nodeEnter.append('circle')
                    .attr('r', d => (d.size || 40) / 2)
                    .attr('fill', d => d.color || '#32CD32')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 2);
            } else if (layerType === 'subtopic') {
                // Subtopics: Small diamonds
                nodeEnter.append('polygon')
                    .attr('points', d => {
                        const size = (d.size || 20) / 2;
                        return `0,${-size} ${size},0 0,${size} ${-size},0`;
                    })
                    .attr('fill', d => d.color || '#E6E6FA')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 1);
            }
            
            // Add labels with different styling for each layer
            nodeEnter.append('text')
                .attr('dy', layerType === 'category' ? '0.35em' : '0.35em')
                .attr('text-anchor', 'middle')
                .style('font-size', d => {
                    if (layerType === 'category') return '14px';
                    if (layerType === 'topic') return '11px';
                    return '9px';
                })
                .style('font-weight', layerType === 'category' ? 'bold' : 'normal')
                .style('fill', '#333')
                .style('pointer-events', 'none')
                .text(d => {
                    const maxLength = layerType === 'category' ? 12 : (layerType === 'topic' ? 10 : 8);
                    return d.label.length > maxLength ? 
                        d.label.substring(0, maxLength) + '...' : d.label;
                });
            
            // Add article count badges
            nodeEnter.append('circle')
                .attr('r', 8)
                .attr('cx', d => (d.size || 20) / 3)
                .attr('cy', d => -(d.size || 20) / 3)
                .attr('fill', '#ff4444')
                .attr('stroke', '#fff')
                .attr('stroke-width', 1);
            
            nodeEnter.append('text')
                .attr('x', d => (d.size || 20) / 3)
                .attr('y', d => -(d.size || 20) / 3)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'middle')
                .style('font-size', '8px')
                .style('font-weight', 'bold')
                .style('fill', '#fff')
                .style('pointer-events', 'none')
                .text(d => d.article_count || 0);
            
            // Add hover effects and tooltips
            const nodes = nodeEnter.merge(nodeSelection);
            
            nodes.on('mouseover', function(event, d) {
                d3.select(this).select('circle, rect, polygon')
                    .transition()
                    .duration(200)
                    .attr('stroke-width', 4);
                
                showTooltip(event, d);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).select('circle, rect, polygon')
                    .transition()
                    .duration(200)
                    .attr('stroke-width', layerType === 'category' ? 3 : (layerType === 'topic' ? 2 : 1));
                
                hideTooltip();
            })
            .on('click', function(event, d) {
                showNodeDetails(d);
            });
        }
        
        function showTooltip(event, d) {
            const tooltip = d3.select('body').selectAll('.tooltip')
                .data([d]);
            
            const tooltipEnter = tooltip.enter()
                .append('div')
                .attr('class', 'tooltip')
                .style('position', 'absolute')
                .style('background', 'rgba(0, 0, 0, 0.9)')
                .style('color', '#fff')
                .style('padding', '10px')
                .style('border-radius', '5px')
                .style('font-size', '12px')
                .style('pointer-events', 'none')
                .style('z-index', 1000)
                .style('opacity', 0);
            
            const tooltipUpdate = tooltipEnter.merge(tooltip);
            
            let content = `<strong>${d.label}</strong><br/>`;
            content += `Type: ${d.type}<br/>`;
            content += `Articles: ${d.article_count || 0}<br/>`;
            
            if (d.layer) content += `Layer: ${d.layer}<br/>`;
            if (d.parent_category) content += `Category: ${d.parent_category}<br/>`;
            if (d.topic_words) content += `Keywords: ${d.topic_words.slice(0, 3).join(', ')}<br/>`;
            
            tooltipUpdate
                .html(content)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .transition()
                .duration(200)
                .style('opacity', 1);
        }
        
        function hideTooltip() {
            d3.selectAll('.tooltip')
                .transition()
                .duration(200)
                .style('opacity', 0)
                .remove();
        }
        
        function showNodeDetails(node) {
            console.log('Node details:', node);
            // Could expand to show detailed modal or sidebar with articles
        }
        
        // Drag functions
        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // Load and populate filter options
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/topic-map/filter-options', {
                    credentials: 'include',  // Include session cookies
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                // Handle authentication redirects gracefully
                if (response.status === 307 || response.status === 302) {
                    console.warn('Filter options require authentication - continuing without filters');
                    return;
                }
                
                if (!response.ok) {
                    console.warn('Filter options not available:', response.status);
                    return; // Continue without filter options
                }
                
                const data = await response.json();
                
                // Populate topic filter
                const topicSelect = document.getElementById('topicFilter');
                if (topicSelect && data.topics && data.topics.length > 0) {
                    topicSelect.innerHTML = '<option value="">All Topics</option>';
                    data.topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic;
                        option.textContent = topic;
                        topicSelect.appendChild(option);
                    });
                }
                
                // Populate category filter
                const categorySelect = document.getElementById('categoryFilter');
                if (categorySelect && data.categories && data.categories.length > 0) {
                    categorySelect.innerHTML = '<option value="">All Categories</option>';
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                }
                
                console.log('Filter options loaded successfully:', data);
                
            } catch (error) {
                console.warn('Failed to load filter options (non-critical):', error.message);
                // Continue without filter options - not critical for functionality
                // The topic map will still work, just without pre-populated filter dropdowns
            }
        }
        
        // Generate topic map with current filters
        async function generateTopicMap() {
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="spinner"></div>
                <p class="mt-3">Generating hierarchical topic map...</p>
            `;
            loadingOverlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.9);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const container = document.getElementById('topicMapContainer');
            container.appendChild(loadingOverlay);
            
            try {
                // Get filter values
                const topicFilter = document.getElementById('topicFilter')?.value || '';
                const categoryFilter = document.getElementById('categoryFilter')?.value || '';
                const limit = document.getElementById('limitFilter')?.value || '500';
                
                // Build query parameters
                const params = new URLSearchParams();
                if (limit) params.append('limit', limit);
                if (topicFilter) params.append('topic', topicFilter);
                if (categoryFilter) params.append('category', categoryFilter);
                
                console.log('Generating topic map with params:', params.toString());
                
                const response = await fetch(`/api/topic-map/generate?${params}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to generate topic map: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Topic map data received:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!data.nodes || data.nodes.length === 0) {
                    throw new Error('No data available for visualization');
                }
                
                // Update visualization with new hierarchical data
                updateVisualization(data);
                updateStatistics(data.statistics || {});
                
                // Update status
                const statusDiv = document.getElementById('status');
                if (statusDiv) {
                    const layers = data.metadata || {};
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>✓ Hierarchical Topic Map Generated!</strong><br>
                            Categories: ${layers.total_categories || 0} | 
                            Topics: ${layers.total_topics || 0} | 
                            Subtopics: ${layers.total_subtopics || 0}<br>
                            Method: ${layers.method || 'BERTopic Hierarchical'}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error generating topic map:', error);
                
                // Show error message
                const container = document.getElementById('topicMapContainer');
                container.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <h6>Error generating topic map:</h6>
                        <p class="mb-0">${error.message}</p>
                        <small class="text-muted">Check the console for more details.</small>
                    </div>
                `;
                
                const statusDiv = document.getElementById('status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>✗ Topic Map Generation Failed</strong><br>
                            ${error.message}
                        </div>
                    `;
                }
            } finally {
                // Remove loading overlay
                const overlay = container.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
        }
        
        // Update statistics panel
        function updateStatistics(stats) {
            const statsContent = document.getElementById('stats-content');
            if (!stats || !statsContent) return;
            
            let html = `<div class="small">`;
            
            if (stats.total_articles) {
                html += `<div class="mb-2"><strong>Total Articles:</strong> ${stats.total_articles}</div>`;
            }
            
            if (stats.layers) {
                html += `<div class="mb-2">
                    <strong>Hierarchy:</strong><br>
                    • ${stats.layers.categories || 0} Categories<br>
                    • ${stats.layers.topics || 0} Topics<br>
                    • ${stats.layers.estimated_subtopics || 0} Subtopics
                </div>`;
            }
            
            if (stats.by_category && Object.keys(stats.by_category).length > 0) {
                html += `<div class="mb-2"><strong>Top Categories:</strong><br>`;
                const topCategories = Object.entries(stats.by_category)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                topCategories.forEach(([category, count]) => {
                    html += `• ${category}: ${count}<br>`;
                });
                html += `</div>`;
            }
            
            if (stats.by_sentiment && Object.keys(stats.by_sentiment).length > 0) {
                html += `<div class="mb-2"><strong>Sentiment:</strong><br>`;
                Object.entries(stats.by_sentiment).forEach(([sentiment, count]) => {
                    html += `• ${sentiment}: ${count}<br>`;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            statsContent.innerHTML = html;
        }
        
        // Reset zoom
        function resetZoom() {
            if (svg && zoom) {
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity
                );
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initVisualization();
            loadFilterOptions();
            
            // Slider value display
            const limitSlider = document.getElementById('limitFilter');
            const limitValue = document.getElementById('limitValue');
            
            limitSlider.addEventListener('input', function() {
                limitValue.textContent = this.value;
            });
            
            // Button event listeners
            document.getElementById('generateBtn').addEventListener('click', generateTopicMap);
            document.getElementById('resetZoomBtn').addEventListener('click', resetZoom);
            
            // Auto-generate on page load
            generateTopicMap();
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (svg) {
                const container = d3.select("#topic-map-svg");
                const width = container.node().getBoundingClientRect().width;
                const height = 700;
                
                svg.attr("width", width).attr("height", height);
                
                if (simulation) {
                    simulation.force("center", d3.forceCenter(width / 2, height / 2));
                    simulation.alpha(0.3).restart();
                }
            }
        });
    </script>
</body>
</html> 