{% extends "base.html" %}

{% block title %}AuNoo AI - Trend Dashboard{% endblock %}

{% block extra_css %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Media bias component code directly included -->
<script>
console.log('Keyword alerts page loaded');

// Helper functions for bias and factual class mapping
function getBiasClass(bias) {
    if (!bias) return '';
    
    bias = bias.toLowerCase();
    console.log('getBiasClass called with:', bias);
    
    if (bias.includes('left') && !bias.includes('center')) {
        return 'bias-left';
    } else if (bias.includes('left-center')) {
        return 'bias-left-center';
    } else if (bias.includes('least biased') || bias.includes('center')) {
        return 'bias-least-biased';
    } else if (bias.includes('right-center')) {
        return 'bias-right-center';
    } else if (bias.includes('right') && !bias.includes('center')) {
        return 'bias-right';
    } else if (bias.includes('pro-science')) {
        return 'bias-pro-science';
    } else if (bias.includes('conspiracy') || bias.includes('pseudo')) {
        return 'bias-conspiracy-pseudoscience';
    } else if (bias.includes('questionable')) {
        return 'bias-questionable';
    } else if (bias.includes('satire')) {
        return 'bias-satire';
    }
    
    return '';
}

function getFactualClass(factual) {
    if (!factual) return '';
    
    factual = factual.toLowerCase();
    
    if (factual.includes('very high')) {
        return 'factual-very-high';
    } else if (factual.includes('high') && !factual.includes('very')) {
        return 'factual-high';
    } else if (factual.includes('mostly')) {
        return 'factual-mostly-factual';
    } else if (factual.includes('mixed')) {
        return 'factual-mixed';
    } else if (factual.includes('low') && !factual.includes('very')) {
        return 'factual-low';
    } else if (factual.includes('very low')) {
        return 'factual-very-low';
    }
    
    return '';
}

// Function to create media bias display for an article
function createMediaBiasDisplay(article) {
    console.log('createMediaBiasDisplay called with article:', article);
    if (!article) {
        console.log('No article provided, returning empty string');
        return '';
    }
    
    // Check if article has bias data fields
    const hasBiasData = article.bias || article.factual_reporting;
    
    if (!hasBiasData) {
        console.log('No bias data found in article, returning empty string');
        return '';
    }
    
    let biasClass = getBiasClass(article.bias);
    let factualClass = getFactualClass(article.factual_reporting);
    console.log('Bias class:', biasClass, 'Factual class:', factualClass);
    
    let html = `<div class="source-metadata">
        <div class="d-flex align-items-center flex-wrap gap-2">`;
    
    if (article.bias) {
        html += `<span class="bias-badge ${biasClass}">
            <i class="fas fa-balance-scale-right me-1"></i> ${article.bias}
        </span>`;
    }
    
    if (article.factual_reporting) {
        html += `<span class="bias-badge ${factualClass}">
            <i class="fas fa-check-circle me-1"></i> ${article.factual_reporting}
        </span>`;
    }
    
    // Create tooltip text for media bias info
    let tooltipText = 'Media Bias Info for ' + (article.source || 'Unknown Source');
    const details = [];
    
    if (article.bias) details.push(`Bias: ${article.bias}`);
    if (article.factual_reporting) details.push(`Factual: ${article.factual_reporting}`);
    if (article.mbfc_credibility_rating) details.push(`Rating: ${article.mbfc_credibility_rating}`);
    if (article.bias_country) details.push(`Country: ${article.bias_country}`);
    if (article.press_freedom) details.push(`Press Freedom: ${article.press_freedom}`);
    if (article.media_type) details.push(`Media Type: ${article.media_type}`);
    if (article.popularity) details.push(`Popularity: ${article.popularity}`);
    
    if (details.length > 0) {
        tooltipText += ' | ' + details.join(' | ');
    }
    
    html += `<span class="source-tooltip" title="${tooltipText}">
        <i class="fas fa-info-circle"></i>
    </span>
    </div>
    </div>`;
    
    console.log('Generated media bias HTML:', html);
    return html;
}

// Expose functions globally so they can be used in other templates
window.getBiasClass = getBiasClass;
window.getFactualClass = getFactualClass;
window.createMediaBiasDisplay = createMediaBiasDisplay;
</script>
<style>
    /* Ensure media bias styling is available on this page */
    .bias-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        margin-right: 3px;
    }

    /* Bias color coding */
    .bias-left {
        background-color: #3373CC;
        color: white;
    }

    .bias-left-center {
        background-color: #6699EE;
        color: white;
    }

    .bias-least-biased, 
    .bias-center {
        background-color: #88CC88;
        color: black;
    }

    .bias-right-center {
        background-color: #FF9966;
        color: black;
    }

    .bias-right {
        background-color: #CC3333;
        color: white;
    }

    .bias-pro-science {
        background-color: #9966CC;
        color: white;
    }

    .bias-conspiracy-pseudoscience {
        background-color: #666666;
        color: white;
    }

    .bias-questionable {
        background-color: #222222;
        color: white;
    }

    .bias-satire {
        background-color: #CCBB33;
        color: black;
    }

    /* Factual reporting color coding */
    .factual-very-high {
        background-color: #006600;
        color: white;
    }

    .factual-high, 
    .factual-mostly-factual {
        background-color: #339933;
        color: white;
    }

    .factual-mixed {
        background-color: #CCCC00;
        color: black;
    }

    .factual-low, 
    .factual-very-low {
        background-color: #CC0000;
        color: white;
    }

    :root {
        --primary-color: #FF69B4;  /* Hot Pink */
        --primary-dark: #FF1493;   /* Deep Pink */
        --secondary-color: #32CD32;  /* Lime Green */
        --secondary-dark: #228B22;   /* Forest Green */
        --text-color: #333;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #343a40;
        --border-color: #dee2e6;
        --box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    h2, h5, h6 {
        color: var(--primary-color);
    }

/* Responsive layout improvements */
.container {
    max-width: 100%;
    padding-left: 15px;
    padding-right: 15px;
}

/* Header responsive improvements */
.header-controls {
    flex-wrap: wrap;
    gap: 0.5rem;
}

.header-controls .d-flex {
    flex-wrap: wrap;
    gap: 0.5rem;
}

/* Table responsive improvements */
.table-responsive {
    border: none;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    max-width: 100%;
}

.table {
    min-width: 980px; /* Increased minimum width to accommodate Update Now button */
    max-width: 100%;
    margin-bottom: 0;
    table-layout: fixed; /* Fixed layout for better control */
}

.table th,
.table td {
    vertical-align: middle;
    padding: 0.5rem;
    overflow: hidden;
}

.table th {
    white-space: nowrap;
    font-weight: 600;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 10; /* Higher z-index for sticky headers */
}

.table td {
    border-top: 1px solid #dee2e6;
    position: relative;
}

/* Ensure proper spacing between columns */
.table td:not(:last-child) {
    padding-right: 0.75rem;
}

/* Article content improvements */
.article-content {
    max-width: none;
    min-width: 300px;
}

.article-title {
    word-break: break-word;
    line-height: 1.3;
    max-width: 400px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-decoration: none;
    color: #0d6efd;
}

.article-title:hover {
    text-decoration: underline;
    color: #0a58ca;
}

.article-summary {
    word-break: break-word;
    line-height: 1.3;
    max-width: 400px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Source column improvements */
.source-info {
    min-width: 120px;
    max-width: 150px;
}

.source-name {
    word-break: break-word;
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Action buttons improvements - Fixed z-index issue */
.action-buttons {
    min-width: 120px;
    max-width: 150px;
    position: relative;
    z-index: 5; /* Lower than sticky headers but higher than content */
}

.action-buttons .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    white-space: nowrap;
    margin: 0;
    border: 1px solid;
    background-clip: padding-box;
}

/* Tags column improvements with tooltips */
.tags-column {
    max-width: 120px;
    overflow: hidden;
    position: relative;
}

.tags-column .badge {
    font-size: 0.65rem;
    margin: 1px;
    display: inline-block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px;
    cursor: help;
    position: relative;
}

/* Improved badge colors for better variety with white text */
.badge.bg-info:nth-child(1) { background-color: #0dcaf0 !important; color: white !important; }
.badge.bg-info:nth-child(2) { background-color: #6f42c1 !important; color: white !important; }
.badge.bg-info:nth-child(3) { background-color: #fd7e14 !important; color: white !important; }
.badge.bg-info:nth-child(4) { background-color: #20c997 !important; color: white !important; }
.badge.bg-info:nth-child(5) { background-color: #e83e8c !important; color: white !important; }
.badge.bg-info:nth-child(6) { background-color: #6610f2 !important; color: white !important; }

/* Ensure all badges have white text for better readability */
.badge {
    color: white !important;
}

/* Badge tooltip - Using JavaScript tooltips only */
.badge[title] {
    position: relative;
    cursor: help;
}

/* Checkbox styling */
.article-checkbox {
    width: 18px;
    height: 18px;
    margin-right: 8px;
    cursor: pointer;
}

.select-all-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Bulk action buttons */
.bulk-actions {
    position: sticky;
    top: 0;
    background: white;
    z-index: 15;
    padding: 10px 0;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 10px;
}

/* Enhanced sparkline container */
.sparkline-container {
    position: relative;
    margin-right: 10px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    width: 140px;
    height: 50px;
    padding: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.sparkline-container canvas {
    position: absolute;
    top: 8px;
    left: 8px;
    width: calc(100% - 16px) !important;
    height: calc(100% - 16px) !important;
}

.sparkline-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 49%, rgba(255,105,180,0.1) 50%, transparent 51%);
    border-radius: 6px;
    pointer-events: none;
}

/* Trend link styling */
.trend-link {
    color: inherit;
    text-decoration: none;
    display: block;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.trend-link:hover {
    background-color: rgba(255, 105, 180, 0.1);
    color: var(--primary-color);
    text-decoration: none;
}

.keyword-labels {
    display: none;
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 4px;
    border-radius: 4px;
    box-shadow: var(--box-shadow);
    white-space: nowrap;
    z-index: 1000;
    min-width: max-content;
}

.article-reference:hover .keyword-labels {
    display: block;
}

.keyword-labels .badge {
    font-size: 0.75rem;
    margin: 0 2px;
    padding: 3px 6px;
    display: inline-block;
}

.keyword-labels:after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid white;
}

/* Alert message styling */
#alertMessage {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
    max-width: 500px;
    box-shadow: var(--box-shadow);
}

.source-metadata {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    margin: 8px 0;
    border-top: 1px solid var(--light-gray);
    padding-top: 8px;
}

.source-tooltip {
    position: relative;
    display: inline-block;
    margin-left: 5px;
    cursor: help;
}

.source-tooltip i {
    color: var(--primary-color);
    opacity: 0.8;
    transition: opacity 0.2s;
}

.source-tooltip:hover i {
    opacity: 1;
}

/* Mobile responsive adjustments */
@media (max-width: 767px) {
    .container {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    /* Relevance filters responsive */
    .relevance-filters {
        padding: 0.75rem;
    }
    
    /* Stack filter row on mobile */
    .filter-row {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 1rem;
    }
    
    .status-section,
    .relevance-section,
    .controls-section {
        justify-content: center;
        text-align: center;
    }
    
    .relevance-section {
        margin: 0 !important;
    }
    
    /* Status filter mobile adjustments */
    .status-btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
    }
    
    /* Detoxify button mobile */
    .detoxify-section {
        margin-top: 0.5rem;
    }
    
    .detoxify-btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
    }
    
    /* Relevance slider mobile */
    .slider-wrapper-modern {
        margin: 0.5rem 0;
    }
    
    .relevance-value-modern {
        min-width: 50px;
        font-size: 0.8rem;
        padding: 0.2rem 0.4rem;
    }
    
    .track-label {
        font-size: 0.65rem;
    }
    
    /* Control buttons mobile */
    .btn-control {
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
    }
    
    .filter-summary .badge {
        font-size: 0.75rem;
        padding: 0.4rem 0.6rem;
    }
    
    /* Advanced filters mobile */
    .advanced-filters {
        padding: 0.75rem;
        margin-top: 0.75rem;
    }
    
    .slider-container {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .slider-wrapper label {
        font-size: 0.8rem;
    }
    
    .relevance-value {
        font-size: 0.7rem;
    }
    
    .slider-labels {
        font-size: 0.6rem;
    }
    
    /* Header adjustments */
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    .header-controls .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    /* Card header adjustments */
    .card-header .d-flex {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    /* Table adjustments */
    .table {
        min-width: 600px;
        font-size: 0.85rem;
    }
    
    .table th,
    .table td {
        padding: 0.25rem;
    }
    
    /* Hide less important columns on mobile */
    .table th:nth-child(4),
    .table td:nth-child(4) {
        display: none; /* Hide Detected column */
    }
    
    /* Article content mobile */
    .article-title {
        max-width: 250px;
        font-size: 0.9rem;
    }
    
    .article-summary {
        max-width: 250px;
        font-size: 0.8rem;
    }
    
    /* Action buttons mobile */
    .action-buttons {
        min-width: 90px;
        max-width: 110px;
    }
    
    .action-buttons .btn {
        padding: 0.2rem 0.3rem;
        font-size: 0.7rem;
    }
    
    /* Ensure no overlap on mobile */
    .table td {
        padding-right: 0.5rem !important;
    }
    
    /* Source info mobile */
    .source-info {
        min-width: 100px;
        max-width: 120px;
        font-size: 0.8rem;
    }
    
    /* Tags mobile */
    .tags-column {
        max-width: 80px;
    }
    
    .tags-column .badge {
        font-size: 0.6rem;
        padding: 0.1rem 0.3rem;
    }
    
    /* Tooltip adjustments - Disabled in favor of JavaScript tooltips */
    .source-tooltip .tooltip-content {
        display: none; /* Disabled to prevent conflicts with JS tooltips */
    }
    
    /* Pagination controls mobile */
    .pagination-controls {
        flex-direction: column !important;
        gap: 1rem;
        padding: 1rem !important;
    }
    
    .pagination-controls .pagination {
        font-size: 0.85rem;
    }
    
    .pagination-controls .page-link {
        padding: 0.25rem 0.5rem;
    }
    
    .page-size-selector {
        width: 100%;
        justify-content: center;
    }
    
    .pagination-info {
        text-align: center;
        width: 100%;
    }
}

/* Tablet responsive adjustments */
@media (max-width: 991px) and (min-width: 768px) {
    .table {
        min-width: 700px;
    }
    
    .article-title,
    .article-summary {
        max-width: 300px;
    }
    
    .action-buttons {
        min-width: 100px;
        max-width: 130px;
    }
}

/* Media bias badges inside tooltip */
.source-tooltip .bias-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin: 3px 0;
}

/* Pagination controls styling */
.pagination-controls {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-top: 1rem;
}

.pagination-controls .pagination {
    margin-bottom: 0;
}

.pagination-controls .page-link {
    color: var(--primary-color);
    border-color: #dee2e6;
}

.pagination-controls .page-link:hover {
    background-color: rgba(255, 105, 180, 0.1);
    border-color: var(--primary-color);
}

.pagination-controls .page-item.active .page-link {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.pagination-controls .page-item.disabled .page-link {
    color: #6c757d;
    background-color: transparent;
}

.page-size-selector {
    display: flex;
    align-items: center;
}

.page-size-selector .form-select {
    min-width: 70px;
}

/* Media Bias Display Styles */
.article-bias-container {
    position: relative;
    display: inline-block;
    margin-left: 8px;
}

.article-bias, .article-factual {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 4px;
}

/* Tooltip styling */
.bias-tooltip {
    visibility: hidden;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 0;
    width: 300px;
    background-color: #f9f9f9;
    color: #333;
    text-align: left;
    border-radius: 6px;
    padding: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    border: 1px solid #ddd;
}

.bias-details p {
    margin: 5px 0;
    font-size: 0.8rem;
}

.article-bias-container:hover .bias-tooltip {
    visibility: visible;
    opacity: 1;
}

/* Relevance column styling */
.relevance-column {
    max-width: 120px;
    overflow: hidden;
    position: relative;
    font-size: 0.75rem;
}

.relevance-scores {
    display: flex;
    flex-direction: column;
    gap: 2px;
    cursor: help;
}

.score-item {
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}

.score-item i {
    width: 12px;
    font-size: 0.7rem;
}

.score-item span {
    font-weight: 500;
    min-width: 30px;
}

/* Relevance slider styling */
.relevance-filters {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #e3e6ea;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Modern filter row layout */
.filter-row {
    min-height: 44px;
}

.filter-label {
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
    white-space: nowrap;
}

/* Status filter section */
.status-section {
    flex-shrink: 0;
}

.status-filter-group {
    display: flex;
    border-radius: 0.375rem;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

.status-btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 0 !important;
    border-right: none;
    transition: all 0.2s ease;
    position: relative;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
}

.status-btn:last-child {
    border-right: 1px solid #dee2e6;
}

.status-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    z-index: 2;
    background-color: #e9ecef;
    border-color: #adb5bd;
}

.status-filter-group input[type="radio"]:checked + .status-btn {
    transform: none;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    font-weight: 600;
    background-color: #ffffff;
    border-color: #0d6efd;
    color: #0d6efd;
}

.status-filter-group input[type="radio"]:checked + .btn-outline-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: #ffffff;
}

.status-filter-group input[type="radio"]:checked + .btn-outline-warning {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000000;
}

.status-filter-group input[type="radio"]:checked + .btn-outline-success {
    background-color: #198754;
    border-color: #198754;
    color: #ffffff;
}

/* Detoxify button styling */
.detoxify-section {
    flex-shrink: 0;
}

.detoxify-btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 0.375rem !important;
    transition: all 0.2s ease;
    background-color: #f8f9fa;
    border: 1px solid #dc3545;
    color: #dc3545;
}

.detoxify-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
    background-color: #f5c2c7;
    border-color: #bb2d3b;
    color: #bb2d3b;
}

input[type="checkbox"]:checked + .detoxify-btn {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #ffffff;
    font-weight: 600;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    transform: none;
}

input[type="checkbox"]:checked + .detoxify-btn:hover {
    background-color: #bb2d3b;
    border-color: #bb2d3b;
}

/* Analysis modal summary styling */
.summary-section {
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 0.75rem;
    background-color: #f8f9fa;
}

.summary-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    align-self: flex-start;
    flex-shrink: 0;
    min-width: 32px;
    text-align: center;
}

.ai-summary {
    font-weight: 500;
    color: #212529;
}

.original-summary {
    font-style: italic;
}

/* Relevance section */
.relevance-section {
    display: flex;
    align-items: center;
    min-width: 0;
}

.slider-container-modern {
    width: 100%;
}

.slider-wrapper-modern {
    position: relative;
    margin: 0 0.5rem;
}

.relevance-slider-modern {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, #dc3545 0%, #ffc107 33%, #28a745 66%, #007bff 100%);
    outline: none;
    opacity: 0.9;
    transition: opacity 0.3s;
    -webkit-appearance: none;
    appearance: none;
}

.relevance-slider-modern:hover {
    opacity: 1;
}

.relevance-slider-modern::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #ffffff;
    border: 3px solid #007bff;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
}

.relevance-slider-modern::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

.relevance-slider-modern::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #ffffff;
    border: 3px solid #007bff;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.slider-track-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 0.25rem;
    padding: 0 0.5rem;
}

.track-label {
    white-space: nowrap;
}

.relevance-value-modern {
    min-width: 60px;
    text-align: center;
    font-weight: 600;
    color: #007bff;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    background-color: rgba(0,123,255,0.1);
    border-radius: 0.25rem;
}

/* Controls section */
.controls-section {
    flex-shrink: 0;
}

.control-buttons {
    border-radius: 0.375rem;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

.btn-control {
    padding: 0.5rem 0.75rem;
    border-radius: 0 !important;
    border-right: none;
    transition: all 0.2s ease;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
}

.btn-control:last-child {
    border-right: 1px solid #dee2e6;
}

.btn-control:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    z-index: 2;
    background-color: #e9ecef;
    border-color: #adb5bd;
}

/* Filter summary styling */
.filter-summary .badge {
    font-size: 0.8rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
}

/* Legacy slider container - now handled by modern design */

.advanced-filters {
    background-color: #f7f8fc;
    border: 1px solid #d6d8db;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-top: 1rem;
    transition: all 0.3s ease;
}

.slider-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.slider-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.slider-wrapper label {
    text-align: center;
    margin-bottom: 0;
    font-weight: 500;
    font-size: 0.875rem;
}

.relevance-slider {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, #dc3545 0%, #ffc107 33%, #28a745 66%, #007bff 100%);
    outline: none;
    opacity: 0.8;
    transition: opacity 0.3s;
}

.relevance-slider:hover {
    opacity: 1;
}

.relevance-slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    border: 2px solid #007bff;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.relevance-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    border: 2px solid #007bff;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.slider-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.65rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.relevance-value {
    text-align: center;
    font-weight: 600;
    color: #007bff;
    font-size: 0.75rem;
    margin: 0.25rem 0;
}

/* Sortable table headers */
.sortable-header {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 1.5rem !important;
}

.sortable-header:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.sort-icon {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.5;
    transition: opacity 0.2s;
}

.sortable-header:hover .sort-icon {
    opacity: 1;
}

.sort-icon.active {
    opacity: 1;
    color: var(--primary-color);
}

.filtered-out {
    display: none !important;
}

/* Filter summary styling */
.filter-summary {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

.filter-summary .badge {
    font-size: 0.75rem;
}

/* Article Analysis Modal Styles */
.modal-xl {
    max-width: 90%;
}

.analysis-config {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

.selected-articles-preview {
    background-color: #fff;
    border-radius: 0.375rem;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

.selected-articles-preview h6 {
    color: var(--primary-color);
    margin-bottom: 0.75rem;
}

.processing-options {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

.processing-options h6 {
    color: var(--primary-color);
    margin-bottom: 0.75rem;
}

#selectedArticlesList {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

#selectedArticlesList .list-group-item {
    border-left: none;
    border-right: none;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#selectedArticlesList .list-group-item:first-child {
    border-top: none;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
}

#selectedArticlesList .list-group-item:last-child {
    border-bottom-left-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.article-item-content {
    flex-grow: 1;
    margin-right: 10px;
}

.article-item-actions {
    flex-shrink: 0;
}

.article-item-actions .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
    margin-left: 0.25rem;
}

#analysisProgressContainer {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

#analysisResults {
    background-color: #fff;
    border-radius: 0.375rem;
    padding: 1rem;
    border: 1px solid #dee2e6;
    max-height: 400px;
    overflow-y: auto;
}

.article-analysis-result {
    transition: all 0.3s ease;
    position: relative;
}

.article-analysis-result:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.result-item-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.article-analysis-result:hover .result-item-actions {
    opacity: 1;
}

.result-item-actions .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.7rem;
    margin-left: 0.25rem;
}

.review-status {
    position: absolute;
    top: 5px;
    left: 5px;
    z-index: 20;
    pointer-events: none;
}

.review-status .badge {
    font-size: 0.65rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.3);
}

/* Clickable review badge styles */
.clickable-badge {
    transition: all 0.2s ease;
    position: relative;
    cursor: pointer !important;
    user-select: none;
}

.clickable-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    filter: brightness(1.1);
}

.clickable-badge:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Ensure all child elements of clickable badges are also clickable */
.clickable-badge * {
    cursor: pointer !important;
    pointer-events: auto;
}

/* Specific styling for the clickable icon */
.clickable-icon {
    transition: all 0.2s ease;
    cursor: pointer !important;
}

.clickable-badge:hover .clickable-icon {
    opacity: 1 !important;
    transform: scale(1.1);
}

/* Add a subtle animation to show the badge is interactive */
.clickable-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.1) 50%, transparent 55%);
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: inherit;
}

.clickable-badge:hover::before {
    opacity: 1;
}

/* Review details modal specific styles */
#reviewDetailsModal .badge {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
}

#reviewDetailsModal .display-6 {
    font-weight: bold;
    font-family: 'Arial', monospace;
}

.review-results-section .card {
    transition: transform 0.2s ease;
}

.review-results-section .card:hover {
    transform: translateY(-2px);
}

/* Issues list styling */
#reviewIssuesList ul {
    padding-left: 1.5rem;
}

#reviewIssuesList li {
    margin-bottom: 0.5rem;
    color: #856404;
    font-weight: 500;
}

/* Content type badges */
#reviewContentType {
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Override button styling */
#reviewOverrideBtn {
    position: relative;
    overflow: hidden;
}

#reviewOverrideBtn:hover {
    background-color: var(--primary-dark);
    border-color: var(--primary-dark);
}

/* Square icon buttons styling */
.btn-square {
    width: 32px;
    height: 32px;
    padding: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 0.375rem !important;
}

.btn-square i {
    font-size: 0.875rem;
}

.btn-square:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<!-- Import the media bias macros -->
{% from "components/media_bias_display.html" import media_bias_badge, media_bias_icon %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div class="flex-grow-1">
            <h2 class="mb-3">Trends Dashboard</h2>
            <div class="header-controls d-flex flex-column gap-2">
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted">
                        <i class="fas fa-clock"></i> Last search: {{ last_check_time|default('Never', true) }}
                    </span>
                    {% if last_error %}
                        <span class="text-danger">
                            <i class="fas fa-exclamation-circle"></i> {{ last_error }}
                        </span>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted">
                        <i class="fas fa-sync"></i> Polling every {{ display_interval }}
                    </span>
                    <span class="text-muted">
                        <i class="fas fa-hourglass-half"></i> 
                        {% if not is_enabled %}
                            Polling disabled
                        {% elif next_check_time %}
                            Next check: {{ next_check_time }}
                        {% else %}
                            Checking soon...
                        {% endif %}
                    </span>
                    <span class="text-muted" id="resetTimer" style="font-size: 0.9rem;">
                        <i class="fas fa-refresh"></i> Loading reset time...
                    </span>
                    <span class="text-danger" id="rateLimitWarning" style="display: none; font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle"></i> Rate limit reached
                    </span>
                </div>
                <div class="d-flex align-items-center gap-3 mt-1">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="pollingToggle" 
                               {% if is_enabled %}checked{% endif %}
                               onchange="togglePolling(this.checked)">
                        <label class="form-check-label" for="pollingToggle">
                            Auto-polling {{ 'enabled' if is_enabled else 'disabled' }}
                        </label>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="checkKeywords()">
                        <i class="fas fa-sync"></i> Update Now
                    </button>
                    <a href="/keyword-monitor" class="btn btn-sm btn-primary">
                        <i class="fas fa-cog"></i> Manage
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced trend chart section -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">EMERGING TRENDS OVERVIEW</h5>
                <div>
                    <button class="btn btn-outline-danger btn-sm me-2" id="bulkDeleteBtn" style="display: none;">
                        <i class="fas fa-trash"></i> Delete Selected (<span id="deleteCount">0</span>)
                    </button>
                    <button class="btn btn-outline-primary btn-sm me-2" id="bulkAnalyzeBtn" style="display: none;">
                        <i class="fas fa-microscope"></i> Analyze Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportAlerts()">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Emerging Trend</th>
                            <!-- References column removed -->
                            <th class="d-none">References</th>
                            <th style="width: 200px;">Growth</th>
                            <th>Size</th>
                            <th style="width: 20%; min-width: 150px;">Tags & Enrichment</th>
                            <th style="width: 12%; min-width: 100px;">Detected</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in groups %}
                        <tr data-topic="{{ group.topic|default('') }}" data-total-count="{{ group.total_count|default(0) }}">
                            <td>
                                <span class="badge bg-primary">
                                    {{ group.growth_status|default('No Data') }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ group.name|default('Unknown Group') }}</strong>
                                        <p class="text-muted small mb-0">{{ group.topic|default('No Topic') }}</p>
                                    </div>
                                </div>
                            </td>
                            <!-- References column removed -->
                            <td class="d-none">
                                <div class="d-flex gap-1">
                                    {% if group.alerts %}
                                        {% for alert in group.alerts[:3] %}
                                        <span class="article-reference"
                                              data-url="{{ alert.article.url }}"
                                              data-title="{{ alert.article.title }}"
                                              data-summary="{{ alert.article.summary }}"
                                              data-topic="{{ group.topic }}"
                                              data-group-id="{{ group.id }}"
                                              onclick="toggleArticleSelection(this)"
                                              title="{{ alert.article.title }}">
                                            {{ loop.index }}
                                        </span>
                                        {% if alert.matched_keyword %}
                                            <span class="badge bg-info ms-1" title="{{ alert.matched_keyword }}">
                                                <i class="fas fa-tag me-1"></i>{{ alert.matched_keyword|truncate(8, True, '...') }}
                                            </span>
                                        {% endif %}
                                        {% if alert.matched_keywords %}
                                            {% for keyword in alert.matched_keywords %}
                                                {% if keyword and keyword != alert.matched_keyword %}
                                                <span class="badge bg-info ms-1" title="{{ keyword }}">
                                                    <i class="fas fa-tag me-1"></i>{{ keyword|truncate(8, True, '...') }}
                                                </span>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">No recent references</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="sparkline-container" style="width: 140px; height: 50px;">
                                        <canvas id="sparkline-{{ group.id }}" 
                                                width="140" 
                                                height="50" 
                                                style="width: 140px; height: 50px;"></canvas>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ group.unread_count }} alerts</span>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-1 align-items-center">
                                    {% for keyword in group.keywords[:3] %}
                                    <span class="badge bg-info" title="{{ keyword }}">
                                        <i class="fas fa-tag me-1"></i>{{ keyword|truncate(10, True, '...') }}
                                    </span>
                                    {% endfor %}
                                    {% if group.keywords|length > 3 %}
                                    <span class="badge bg-light text-dark border" title="{{ group.keywords[3:]|join(', ') }}">+{{ group.keywords|length - 3 }} more</span>
                                    {% endif %}
                                    <div class="ms-2">
                                        {% if group.total_count and group.total_count > group.unread_count %}
                                        <span class="badge bg-info" title="Total articles in group">
                                            <i class="fas fa-newspaper me-1"></i>{{ group.total_count }} Total
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="small">
                                    {% if group.alerts %}
                                        {% set latest_alert = group.alerts|first %}
                                        <div>{{ latest_alert.detected_at }}</div>
                                        <div class="text-muted">Latest detection</div>
                                    {% else %}
                                        <div class="text-muted">No alerts</div>
                                    {% endif %}
                                </div>
                            </td>

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if groups %}
        <div class="row">
            {% for group in groups %}
            <div class="col-12 mb-4">
                <div class="card" id="group-{{ group.id }}">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <div>
                                    <h5 class="mb-0">{{ group.name }}</h5>
                                    <div class="text-muted small">
                                        Topic: <span class="badge bg-secondary">{{ group.topic }}</span>
                                        {% if group.keywords %}
                                            <span class="ms-2">Monitoring: 
                                                {% for keyword in group.keywords %}
                                                <span class="badge bg-info" title="{{ keyword }}">
                                                    <i class="fas fa-tag me-1"></i>{{ keyword|truncate(12, True, '...') }}
                                                </span>
                                                {% endfor %}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input show-read-toggle" 
                                           type="checkbox" 
                                           id="showReadToggle_{{ group.id }}"
                                           data-topic="{{ group.topic }}"
                                           data-group-id="{{ group.id }}">
                                    <label class="form-check-label" for="showReadToggle_{{ group.id }}">
                                        Show read articles (<span class="total-count">{{ group.total_count|default(0) }}</span> total)
                                    </label>
                                </div>
                            </div>
                            <div class="d-flex gap-2 align-items-center" data-group-id="{{ group.id }}">
                                <button class="btn btn-outline-primary btn-sm bulk-analyze-btn" 
                                        data-topic="{{ group.topic }}"
                                        data-group-id="{{ group.id }}"
                                        onclick="analyzeBulkArticles('{{ group.topic }}', '{{ group.id }}')"
                                        style="display: none;">
                                    <i class="fas fa-microscope"></i> 
                                    Analyze Selected (<span class="selected-count">0</span>)
                                </button>
                                <button class="btn btn-outline-danger btn-sm bulk-delete-btn"
                                        data-topic="{{ group.topic }}"
                                        data-group-id="{{ group.id }}"
                                        onclick="bulkDeleteArticles('{{ group.topic }}', '{{ group.id }}')"
                                        style="display: none;">
                                    <i class="fas fa-trash"></i>
                                    Delete Selected (<span class="delete-count">0</span>)
                                </button>
                                <button class="btn btn-outline-success btn-sm btn-square" 
                                        onclick="updateGroupNow('{{ group.topic }}', '{{ group.id }}')"
                                        title="Check for new articles in this group">
                                    <i class="fas fa-sync"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm btn-square" 
                                        onclick="exportGroupAlerts('{{ group.topic }}', '{{ group.id }}')"
                                        title="Export alerts for this group">
                                    <i class="fas fa-download"></i>
                                </button>
                                <span class="badge bg-primary">{{ group.unread_count|default(0) }} alerts</span>
                                {% set enriched_count = group.alerts|selectattr('article.category')|list|length + group.alerts|selectattr('article.analysis_complete')|list|length %}
                                {% if enriched_count > 0 %}
                                <span class="badge bg-success ms-1" title="{{ enriched_count }} articles have been analyzed">
                                    <i class="fas fa-brain me-1"></i>{{ enriched_count }} enriched
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if group.alerts %}
                    <div class="relevance-filters">
                        <!-- Modern single-row filter layout -->
                        <div class="filter-row d-flex align-items-center justify-content-between mb-3">
                            <!-- Left: Status Filter -->
                            <div class="status-section d-flex align-items-center">
                                <span class="filter-label me-3">Show:</span>
                                <div class="status-filter-group" data-group-id="{{ group.id }}">
                                    <input type="radio" class="btn-check" name="statusFilter_{{ group.id }}" id="statusAll_{{ group.id }}" value="all" checked>
                                    <label class="btn btn-outline-primary status-btn" for="statusAll_{{ group.id }}" title="Show all articles">
                                        <i class="fas fa-list me-1"></i>All
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter_{{ group.id }}" id="statusNew_{{ group.id }}" value="new">
                                    <label class="btn btn-outline-warning status-btn" for="statusNew_{{ group.id }}" title="Show only new articles">
                                        <i class="fas fa-plus-circle me-1"></i>New
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter_{{ group.id }}" id="statusAdded_{{ group.id }}" value="added">
                                    <label class="btn btn-outline-success status-btn" for="statusAdded_{{ group.id }}" title="Show only analyzed articles">
                                        <i class="fas fa-check-circle me-1"></i>Added
                                    </label>
                                </div>
                                
                                <!-- Detoxify Toggle -->
                                <div class="detoxify-section ms-3">
                                    <input type="checkbox" class="btn-check" id="detoxifyToggle_{{ group.id }}" data-group-id="{{ group.id }}">
                                    <label class="btn btn-outline-danger detoxify-btn" for="detoxifyToggle_{{ group.id }}" 
                                           title="Filter out low credibility sources, conspiracy theories, pseudoscience, and poor factual reporting">
                                        <i class="fas fa-shield-virus me-1"></i>Detoxify
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Center: Relevance Slider -->
                            <div class="relevance-section flex-grow-1 mx-4">
                                <div class="slider-container-modern">
                                    <div class="d-flex align-items-center">
                                        <span class="filter-label me-2">Relevance:</span>
                                        <div class="slider-wrapper-modern flex-grow-1">
                                            <input type="range" class="relevance-slider-modern" 
                                                   id="mainRelevanceSlider_{{ group.id }}" 
                                                   min="0" max="1" step="0.01" value="0"
                                                   data-group-id="{{ group.id }}"
                                                   data-filter-type="main"
                                                   onchange="applyMainRelevanceFilter('{{ group.id }}')">
                                            <div class="slider-track-labels">
                                                <span class="track-label start">All</span>
                                                <span class="track-label end">High Only</span>
                                            </div>
                                        </div>
                                        <span class="relevance-value-modern ms-2" id="mainRelevanceValue_{{ group.id }}">All</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right: Controls and Summary -->
                            <div class="controls-section d-flex align-items-center">
                                <div class="filter-summary me-3" id="filterSummary_{{ group.id }}">
                                    <span class="badge bg-info">{{ group.alerts|length }} articles</span>
                                </div>
                                <div class="btn-group control-buttons">
                                    <button class="btn btn-outline-info btn-control" 
                                            onclick="toggleAdvancedFilters('{{ group.id }}')"
                                            id="advancedToggle_{{ group.id }}"
                                            title="Advanced filters">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-control" 
                                            onclick="resetFilters('{{ group.id }}')"
                                            title="Reset filters">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced individual sliders (initially hidden) -->
                        <div class="advanced-filters" id="advancedFilters_{{ group.id }}" style="display: none;">
                            <div class="alert alert-info small mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                Advanced mode: Set individual thresholds for each relevance metric
                            </div>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <label for="topicSlider_{{ group.id }}">Topic Relevance</label>
                                    <input type="range" class="relevance-slider" 
                                           id="topicSlider_{{ group.id }}" 
                                           min="0" max="1" step="0.01" value="0"
                                           data-group-id="{{ group.id }}"
                                           data-filter-type="topic"
                                           onchange="applyRelevanceFilter('{{ group.id }}')">
                                    <span class="relevance-value" id="topicValue_{{ group.id }}">All</span>
                                    <div class="slider-labels">
                                        <span>None</span>
                                        <span>High</span>
                                    </div>
                                </div>
                                <div class="slider-wrapper">
                                    <label for="keywordSlider_{{ group.id }}">Keyword Relevance</label>
                                    <input type="range" class="relevance-slider" 
                                           id="keywordSlider_{{ group.id }}" 
                                           min="0" max="1" step="0.01" value="0"
                                           data-group-id="{{ group.id }}"
                                           data-filter-type="keyword"
                                           onchange="applyRelevanceFilter('{{ group.id }}')">
                                    <span class="relevance-value" id="keywordValue_{{ group.id }}">All</span>
                                    <div class="slider-labels">
                                        <span>None</span>
                                        <span>High</span>
                                    </div>
                                </div>
                                <div class="slider-wrapper">
                                    <label for="confidenceSlider_{{ group.id }}">Confidence Score</label>
                                    <input type="range" class="relevance-slider" 
                                           id="confidenceSlider_{{ group.id }}" 
                                           min="0" max="1" step="0.01" value="0"
                                           data-group-id="{{ group.id }}"
                                           data-filter-type="confidence"
                                           onchange="applyRelevanceFilter('{{ group.id }}')">
                                    <span class="relevance-value" id="confidenceValue_{{ group.id }}">All</span>
                                    <div class="slider-labels">
                                        <span>Low</span>
                                        <span>High</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <!-- Bulk actions bar -->
                        <div class="bulk-actions" id="bulkActions_{{ group.id }}" style="display: none;">
                            <div class="d-flex align-items-center gap-3">
                                <label class="form-check-label">
                                    <input type="checkbox" class="select-all-checkbox me-2" 
                                           onchange="toggleSelectAll(this, '{{ group.id }}')">
                                    Select All
                                </label>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="analyzeSelectedArticles('{{ group.topic }}', '{{ group.id }}')">
                                    <i class="fas fa-microscope"></i> Analyze Selected
                                </button>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="analyzeRelevanceSelected('{{ group.topic }}', '{{ group.id }}')">
                                    <i class="fas fa-brain"></i> Analyze Relevance
                                </button>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="bulkMarkAsRead('{{ group.id }}')">
                                    <i class="fas fa-check"></i> Mark Selected as Read
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="bulkDeleteSelected('{{ group.id }}')">
                                    <i class="fas fa-trash"></i> Delete Selected
                                </button>
                                <span class="text-muted" id="selectedInfo_{{ group.id }}">0 selected</span>
                            </div>
                        </div>
                        
                        <table class="table table-hover align-middle mb-0" id="articlesTable_{{ group.id }}">
                            <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                <tr>
                                    <th style="width: 50px; min-width: 50px;">
                                        <input type="checkbox" class="select-all-checkbox" 
                                               onchange="toggleSelectAll(this, '{{ group.id }}')">
                                    </th>
                                    <th style="width: 80px; min-width: 60px;" class="sortable-header" data-sort="status" data-group-id="{{ group.id }}">
                                        Status <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 30%; min-width: 280px;" class="sortable-header" data-sort="title" data-group-id="{{ group.id }}">
                                        Article <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 15%; min-width: 120px;" class="sortable-header" data-sort="source" data-group-id="{{ group.id }}">
                                        Source <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 12%; min-width: 100px;" class="sortable-header" data-sort="detected" data-group-id="{{ group.id }}">
                                        Detected <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 13%; min-width: 100px;">Tags</th>
                                    <th style="width: 12%; min-width: 100px;" class="sortable-header" data-sort="relevance" data-group-id="{{ group.id }}">
                                        Relevance <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 25%; min-width: 200px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in group.alerts %}
                                <tr data-alert-id="{{ alert.id }}" data-group-id="{{ group.id }}"
                                    data-article-category="{{ alert.article.category|default('', true) }}"
                                    data-article-sentiment="{{ alert.article.sentiment|default('', true) }}"
                                    data-article-driver-type="{{ alert.article.driver_type|default('', true) }}"
                                    data-article-time-to-impact="{{ alert.article.time_to_impact|default('', true) }}">
                                    <td>
                                        <input type="checkbox" class="article-checkbox" 
                                               data-alert-id="{{ alert.id }}"
                                               data-group-id="{{ group.id }}"
                                               onchange="updateBulkActions('{{ group.id }}')">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% set has_enrichment = alert.article.category and alert.article.category|trim %}
                                            <!-- DEBUG: {{ alert.article.category }}|{{ alert.article.sentiment }}|{{ alert.article.driver_type }}|{{ alert.article.time_to_impact }}|{{ has_enrichment }} -->
                                            {% if has_enrichment %}
                                            <span class="badge bg-success" title="Article has been analyzed">
                                                <i class="fas fa-check-circle me-1"></i>Added
                                            </span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark" title="Article needs analysis">
                                                <i class="fas fa-exclamation-circle me-1"></i>New
                                            </span>
                                            {% endif %}
                                            {% if alert.article.bias or alert.article.factual_reporting %}
                                            <span class="badge bg-info ms-1" title="Has media bias data">
                                                <i class="fas fa-shield-alt me-1"></i>Bias
                                            </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="article-content d-flex flex-column">
                                            <div class="mb-1">
                                                                                            <div class="d-flex gap-2 align-items-start">
                                                <a href="{{ alert.article.url }}" target="_blank" class="article-title">{{ alert.article.title }}</a>
                                                </div>
                                                <p class="text-muted mb-0 small article-summary">{{ alert.article.summary }}</p>

                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="source-info small">
                                            <div class="source-name">{{ alert.article.source }}</div>
                                            <div class="text-muted">
                                                {{ alert.article.publication_date or 'Unknown' }}
                                            </div>
                                            {% if alert.article.bias or alert.article.factual_reporting %}
                                            <div class="d-flex flex-wrap gap-1 mt-1">
                                                {% if alert.article.bias %}
                                                <span class="bias-badge bias-{{ alert.article.bias|lower|replace(' ', '-') }}" title="Media Bias: {{ alert.article.bias }}">
                                                    {{ alert.article.bias }}
                                                </span>
                                                {% endif %}
                                                {% if alert.article.factual_reporting %}
                                                <span class="bias-badge factual-{{ alert.article.factual_reporting|lower|replace(' ', '-') }}" title="Factual Reporting: {{ alert.article.factual_reporting }}">
                                                    {{ alert.article.factual_reporting }}
                                                </span>
                                                {% endif %}
                                                {% if alert.article.bias_country %}
                                                <span class="badge bg-light text-dark border" title="Country: {{ alert.article.bias_country }}">
                                                    {{ alert.article.bias_country }}
                                                </span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td style="width: 15%; min-width: 120px;">
                                        <div class="small">
                                            <div>{{ alert.article.publication_date or 'Unknown' }}</div>
                                            <div class="text-muted">Published</div>
                                        </div>
                                        <div class="small mt-1">
                                            <div>{{ alert.detected_at or 'Unknown' }}</div>
                                            <div class="text-muted">Detected</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="tags-column">
                                            {% if alert.matched_keyword %}
                                                <span class="badge bg-info" title="{{ alert.matched_keyword }}">
                                                    <i class="fas fa-tag me-1"></i>{{ alert.matched_keyword|truncate(10, True, '...') }}
                                                </span>
                                            {% endif %}
                                            {% if alert.matched_keywords %}
                                                {% for keyword in alert.matched_keywords %}
                                                    {% if keyword and keyword != alert.matched_keyword %}
                                                    <span class="badge bg-info" title="{{ keyword }}">
                                                        <i class="fas fa-tag me-1"></i>{{ keyword|truncate(10, True, '...') }}
                                                    </span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="relevance-column" data-article-uri="{{ alert.article.url }}">
                                            {% if alert.article.topic_alignment_score is not none and alert.article.topic_alignment_score is defined %}
                                            <div class="relevance-scores" 
                                                 title="Topic: {{ '%.2f'|format(alert.article.topic_alignment_score) }} | Keywords: {{ '%.2f'|format(alert.article.keyword_relevance_score|default(0, true)) }} | Confidence: {{ '%.2f'|format(alert.article.confidence_score|default(0, true)) }}{% if alert.article.overall_match_explanation %} | {{ alert.article.overall_match_explanation }}{% endif %}">
                                                <div class="score-item">
                                                    <i class="fas fa-bullseye" style="color: #0dcaf0;"></i>
                                                    <span>{{ '%.2f'|format(alert.article.topic_alignment_score) }}</span>
                                                </div>
                                                <div class="score-item">
                                                    <i class="fas fa-key" style="color: #198754;"></i>
                                                    <span>{{ '%.2f'|format(alert.article.keyword_relevance_score|default(0, true)) }}</span>
                                                </div>
                                                {% if alert.article.confidence_score is not none and alert.article.confidence_score is defined %}
                                                <div class="score-item">
                                                    <i class="fas fa-chart-line" style="color: #fd7e14;"></i>
                                                    <span>{{ '%.2f'|format(alert.article.confidence_score) }}</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% else %}
                                            <span class="text-muted small">Not analyzed</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="action-buttons d-flex flex-column gap-1">
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-outline-success" 
                                                        onclick="markAsRead('{{ alert.id }}')"
                                                        data-topic="{{ group.topic }}"
                                                        data-group-id="{{ group.id }}"
                                                        title="Mark as read">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary analyze-single-article-btn" 
                                                        data-article-url="{{ alert.article.url }}"
                                                        data-article-title="{{ alert.article.title }}"
                                                        data-article-source="{{ alert.article.source }}"
                                                        data-article-topic="{{ group.topic }}"
                                                        data-article-summary="{{ alert.article.summary }}"
                                                        title="Analyze article">
                                                    <i class="fas fa-microscope"></i>
                                                </button>
                                            </div>
                                            <div class="d-flex gap-1">
                                                <a href="https://12ft.io/{{ alert.article.url }}" 
                                                   class="btn btn-sm btn-outline-secondary"
                                                   title="Bypass Paywall" 
                                                   target="_blank">
                                                    <i class="fas fa-unlock"></i>
                                                </a>
                                                <a href="https://archive.is/{{ alert.article.url }}" 
                                                   class="btn btn-sm btn-outline-secondary"
                                                   title="Archive" 
                                                   target="_blank">
                                                    <i class="fas fa-archive"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i> No new alerts for this group
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No unread alerts found.
        <a href="/keyword-monitor" class="alert-link">Set up keyword monitoring</a> to get notified about relevant articles.
    </div>
    {% endif %}
</div>

<!-- Add this at the top of the page for error messages -->
<div id="alertMessage" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
    <span id="alertText"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Model Selection Modal for Relevance Analysis -->
<div class="modal fade" id="modelSelectionModal" tabindex="-1" aria-labelledby="modelSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modelSelectionModalLabel">Start Background Relevance Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="modelSelect" class="form-label">Choose an AI model:</label>
                    <select class="form-select" id="modelSelect">
                        <option value="">Loading models...</option>
                    </select>
                    <div class="form-text">
                        The analysis will run in the background. You'll receive notifications when it starts and completes.
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Background Processing:</strong> The analysis will start immediately and run in the background. 
                    You can continue using the interface while it processes. Results will be automatically refreshed when complete.
                </div>
                <div id="analysisProgress" class="progress" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="analysisStatus" class="text-muted small" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startAnalysisBtn" onclick="startRelevanceAnalysis()">
                    <i class="fas fa-rocket"></i> Start Background Analysis
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LLM Review Details Modal -->
<div class="modal fade" id="reviewDetailsModal" tabindex="-1" aria-labelledby="reviewDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewDetailsModalLabel">
                    <i class="fas fa-shield-check me-2"></i>Quality Control Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Article Info -->
                <div class="article-info-section mb-4">
                    <h6 class="text-primary">
                        <i class="fas fa-newspaper me-2"></i>Article Information
                    </h6>
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 id="reviewArticleTitle" class="card-title mb-2">Article Title</h6>
                            <p id="reviewArticleSource" class="text-muted small mb-2">
                                <i class="fas fa-globe me-1"></i>Source
                            </p>
                            <p id="reviewArticleSummary" class="card-text">Article summary...</p>
                        </div>
                    </div>
                </div>

                <!-- Review Results -->
                <div class="review-results-section mb-4">
                    <h6 class="text-success">
                        <i class="fas fa-robot me-2"></i>Quality Control Results
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h4 id="reviewQualityScore" class="display-6 text-primary">0.85</h4>
                                    <p class="text-muted mb-0">Quality Score</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <span id="reviewRecommendationBadge" class="badge bg-success fs-6">APPROVE</span>
                                    <p class="text-muted mb-0 mt-2">Quality Control Recommendation</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Classification -->
                <div class="content-type-section mb-4">
                    <h6 class="text-info">
                        <i class="fas fa-tags me-2"></i>Content Classification
                    </h6>
                    <span id="reviewContentType" class="badge bg-info fs-6">article</span>
                    <span id="reviewModelUsed" class="badge bg-secondary ms-2 fs-6">gpt-4o-mini</span>
                </div>

                <!-- Issues Detected -->
                <div class="issues-section mb-4" id="reviewIssuesSection">
                    <h6 class="text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Issues Detected
                    </h6>
                    <div id="reviewIssuesList" class="alert alert-warning">
                        <ul class="mb-0" id="reviewIssuesItems">
                            <!-- Issues will be populated here -->
                        </ul>
                    </div>
                </div>

                <!-- Quality Control Explanation -->
                <div class="explanation-section">
                    <h6 class="text-dark">
                        <i class="fas fa-comment-alt me-2"></i>Quality Control Explanation
                    </h6>
                    <div class="alert alert-info">
                        <p id="reviewExplanation" class="mb-0">
                            The quality control system's detailed explanation will appear here...
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Close
                </button>
                <button type="button" class="btn btn-primary" id="reviewOverrideBtn" onclick="overrideReviewDecision()">
                    <i class="fas fa-edit me-1"></i>Override Decision
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Article Analysis Modal -->
<div class="modal fade" id="articleAnalysisModal" tabindex="-1" aria-labelledby="articleAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="articleAnalysisModalLabel">Analyze Selected Articles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Analysis Configuration -->
                <div class="analysis-config mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="analysisModelSelect" class="form-label">AI Model</label>
                                <select class="form-select" id="analysisModelSelect" required>
                                    <option value="">Loading models...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="analysisSummaryLength" class="form-label">Summary Length</label>
                                <select class="form-select" id="analysisSummaryLength">
                                    <option value="40">40 words</option>
                                    <option value="50" selected>50 words</option>
                                    <option value="75">75 words</option>
                                    <option value="100">100 words</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="analysisSummaryVoice" class="form-label">Summary Voice</label>
                                <select class="form-select" id="analysisSummaryVoice">
                                    <option value="business_analyst">Business Analyst</option>
                                    <option value="industry_analyst">Industry Analyst</option>
                                    <option value="tech_journalist">Tech Journalist</option>
                                    <option value="investment_advisor">Investment Advisor</option>
                                    <option value="principal_security_engineer">Principal Security Engineer</option>
                                    <option value="ciso">CISO</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="analysisTopicSelect" class="form-label">Topic</label>
                                <select class="form-select" id="analysisTopicSelect" required>
                                    <option value="">Select a topic</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Articles Preview -->
                <div class="selected-articles-preview mb-4">
                    <h6>Selected Articles (<span id="selectedArticlesCount">0</span>)</h6>
                    <div id="selectedArticlesList" class="list-group" style="max-height: 300px; overflow-y: auto;">
                        <!-- Selected articles will be listed here -->
                    </div>
                </div>

                <!-- Processing Options -->
                <div class="processing-options mb-4">
                    <h6><i class="fas fa-cogs me-2"></i>Processing Options</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="backgroundProcessing" checked>
                                <label class="form-check-label" for="backgroundProcessing">
                                    <i class="fas fa-rocket me-1"></i>Background Processing & Auto-Save
                                </label>
                                <div class="form-text">Process in background and automatically save results</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="qualityControl" checked>
                                <label class="form-check-label" for="qualityControl">
                                    <i class="fas fa-shield-check me-1"></i>Quality Control
                                </label>
                                <div class="form-text">AI-powered quality review and filtering</div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="saveApprovedOnly">
                                <label class="form-check-label" for="saveApprovedOnly">
                                    <i class="fas fa-filter me-1"></i>Save Approved Only
                                </label>
                                <div class="form-text">Only auto-save articles that pass quality control</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="closeOnComplete">
                                <label class="form-check-label" for="closeOnComplete">
                                    <i class="fas fa-times-circle me-1"></i>Close modal when done
                                </label>
                                <div class="form-text">Auto-close modal after processing</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress and Status -->
                <div id="analysisProgressContainer" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Processing Articles:</strong> <span id="analysisProgressText">Initializing...</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="analysisProgressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                                    <div id="analysisResults" class="mt-3" style="display: none;">
                    <h6>Analysis Results <span id="reviewStatusCount" class="badge bg-info ms-2" style="display: none;"></span></h6>
                    <div id="analysisResultsList"></div>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startArticleAnalysisBtn" onclick="startArticleAnalysis()">
                    <i class="fas fa-microscope"></i> Start Analysis
                </button>
                <button type="button" class="btn btn-success" id="saveAnalysisResultsBtn" style="display: none;" onclick="saveAnalysisResults()">
                    <i class="fas fa-save"></i> Save All Articles
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Debug initial page data
document.addEventListener('DOMContentLoaded', function() {
    console.log('Checking initial page data for enrichment fields...');
    
    // Check all articles in the initial page load
    const allArticleRows = document.querySelectorAll('tr[data-alert-id]');
    console.log(`Found ${allArticleRows.length} article rows on initial load`);
    
    allArticleRows.forEach((row, index) => {
        const title = row.querySelector('.article-title')?.textContent || 'Unknown';
        const statusBadge = row.querySelector('.badge')?.textContent || 'Unknown';
        
        // Check if this is a Jinja-rendered row that should show enrichment
        const hasEnrichmentBadge = row.querySelector('.badge.bg-success')?.textContent === 'Added';
        
        // Check data attributes that JavaScript would read
        const dataCategory = row.dataset.articleCategory;
        const dataSentiment = row.dataset.articleSentiment;
        const dataDriverType = row.dataset.articleDriverType;
        const dataTimeToImpact = row.dataset.articleTimeToImpact;
        
        // Look for DEBUG comment in HTML  
        const debugMatch = row.innerHTML.includes('<!-- DEBUG:') ? 
            row.innerHTML.substring(
                row.innerHTML.indexOf('<!-- DEBUG:') + 11, 
                row.innerHTML.indexOf('-->', row.innerHTML.indexOf('<!-- DEBUG:'))
            ).trim() : null;
        const serverSideDebug = debugMatch || 'No debug info';
        
        console.log('Initial row ' + index + ':', {
            title: title.substring(0, 50) + '...',
            statusBadge: statusBadge,
            hasEnrichmentBadge: hasEnrichmentBadge,
            alertId: row.dataset.alertId,
            dataAttributes: {
                category: '"' + dataCategory + '"',
                sentiment: '"' + dataSentiment + '"',
                driver_type: '"' + dataDriverType + '"',
                time_to_impact: '"' + dataTimeToImpact + '"'
            },
            serverSideDebug: serverSideDebug,
            jsEnrichmentCheck: isArticleEnriched({
                category: dataCategory,
                sentiment: dataSentiment,
                driver_type: dataDriverType,
                time_to_impact: dataTimeToImpact
            })
        });
    });
});

// Enhanced sparkline drawing with better visuals
function drawSparkline(canvas, data) {
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const padding = 4;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Find min and max values
    const maxValue = Math.max(...data.counts, 1);
    const minValue = Math.min(...data.counts, 0);
    const range = maxValue - minValue || 1;
    
    // Calculate scales
    const xScale = (width - 2 * padding) / Math.max(data.counts.length - 1, 1);
    const yScale = (height - 2 * padding) / range;
    
    // Draw background gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, 'rgba(255, 105, 180, 0.1)');
    gradient.addColorStop(1, 'rgba(255, 105, 180, 0.05)');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // Draw grid lines
    ctx.strokeStyle = 'rgba(255, 105, 180, 0.2)';
    ctx.lineWidth = 0.5;
    
    // Horizontal grid lines
    for (let i = 1; i <= 2; i++) {
        const y = padding + (i * (height - 2 * padding) / 3);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
    }
    
    if (data.counts.length > 1) {
        // Draw area under the line
    ctx.beginPath();
        ctx.moveTo(padding, height - padding - ((data.counts[0] - minValue) * yScale));
        
        for (let i = 1; i < data.counts.length; i++) {
            ctx.lineTo(
                i * xScale + padding,
                height - padding - ((data.counts[i] - minValue) * yScale)
            );
        }
        
        ctx.lineTo(width - padding, height - padding);
        ctx.lineTo(padding, height - padding);
        ctx.closePath();
        
        const areaGradient = ctx.createLinearGradient(0, 0, 0, height);
        areaGradient.addColorStop(0, 'rgba(255, 105, 180, 0.3)');
        areaGradient.addColorStop(1, 'rgba(255, 105, 180, 0.05)');
        ctx.fillStyle = areaGradient;
        ctx.fill();
        
        // Draw the main line
        ctx.strokeStyle = '#FF69B4';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        
    ctx.moveTo(
        padding,
            height - padding - ((data.counts[0] - minValue) * yScale)
    );
    
    for (let i = 1; i < data.counts.length; i++) {
        ctx.lineTo(
            i * xScale + padding,
                height - padding - ((data.counts[i] - minValue) * yScale)
        );
    }
    ctx.stroke();
    
        // Draw points with glow effect
        ctx.shadowColor = '#FF69B4';
        ctx.shadowBlur = 4;
        ctx.fillStyle = '#FF69B4';
        
    data.counts.forEach((value, i) => {
            const x = i * xScale + padding;
            const y = height - padding - ((value - minValue) * yScale);
            
        ctx.beginPath();
            ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
            
            // Add value labels for significant points
            if (value > 0 && (i === 0 || i === data.counts.length - 1 || value === maxValue)) {
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#333';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value.toString(), x, y - 8);
                ctx.fillStyle = '#FF69B4';
                ctx.shadowBlur = 4;
            }
        });
        
        ctx.shadowBlur = 0;
    } else {
        // Single data point
        ctx.fillStyle = '#FF69B4';
        ctx.beginPath();
        ctx.arc(width / 2, height / 2, 4, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.fillStyle = '#333';
        ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'center';
        ctx.fillText(data.counts[0].toString(), width / 2, height / 2 - 10);
    }
}

// Checkbox and bulk action functionality
function toggleSelectAll(checkbox, groupId) {
    // Only select checkboxes from rows that are not filtered out
    const checkboxes = document.querySelectorAll(`[data-group-id="${groupId}"] .article-checkbox`);
    checkboxes.forEach(cb => {
        const row = cb.closest('tr');
        // Only toggle if the row is not filtered out (visible)
        if (!row || !row.classList.contains('filtered-out')) {
            cb.checked = checkbox.checked;
        }
    });
    updateBulkActions(groupId);
}

function updateBulkActions(groupId) {
    const allCheckboxes = document.querySelectorAll(`[data-group-id="${groupId}"] .article-checkbox`);
    const allCheckedBoxes = document.querySelectorAll(`[data-group-id="${groupId}"] .article-checkbox:checked`);
    
    // Only count visible (non-filtered) checkboxes for select-all state
    const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => {
        const row = cb.closest('tr');
        return !row || !row.classList.contains('filtered-out');
    });
    
    const visibleCheckedBoxes = Array.from(allCheckedBoxes).filter(cb => {
        const row = cb.closest('tr');
        return !row || !row.classList.contains('filtered-out');
    });
    
    const bulkActions = document.getElementById(`bulkActions_${groupId}`);
    const selectedInfo = document.getElementById(`selectedInfo_${groupId}`);
    
    if (visibleCheckedBoxes.length > 0) {
        bulkActions.style.display = 'block';
        selectedInfo.textContent = `${visibleCheckedBoxes.length} selected`;
    } else {
        bulkActions.style.display = 'none';
    }
    
    // Update select all checkbox state based on visible checkboxes only
    const selectAllCheckboxes = document.querySelectorAll(`[data-group-id="${groupId}"] .select-all-checkbox`);
    selectAllCheckboxes.forEach(cb => {
        const visibleCount = visibleCheckboxes.length;
        const visibleCheckedCount = visibleCheckedBoxes.length;
        
        cb.indeterminate = visibleCheckedCount > 0 && visibleCheckedCount < visibleCount;
        cb.checked = visibleCheckedCount === visibleCount && visibleCount > 0;
    });
}

function bulkMarkAsRead(groupId) {
    const checkedBoxes = document.querySelectorAll(`[data-group-id="${groupId}"] .article-checkbox:checked`);
    const alertIds = Array.from(checkedBoxes).map(cb => cb.dataset.alertId);
    
    if (alertIds.length === 0) {
        showAlert('No articles selected', 'warning');
        return;
    }
    
    if (!confirm(`Mark ${alertIds.length} articles as read?`)) return;
    
    // Get the topic from the group container instead of the checkbox
    const groupContainer = document.querySelector(`[data-group-id="${groupId}"]`);
    let topic = groupContainer ? groupContainer.dataset.topic : null;
    
    if (!topic) {
        // Fallback: try to get topic from the card header
        const cardHeader = document.querySelector(`#group-${groupId}`);
        if (cardHeader) {
            const topicBadge = cardHeader.querySelector('.badge.bg-secondary');
            if (topicBadge) {
                topic = topicBadge.textContent.trim();
            }
        }
    }
    
    // Mark each alert as read
    Promise.all(alertIds.map(alertId => 
        fetch(`/api/keyword-monitor/alerts/${alertId}/read`, { 
            method: 'POST',
            credentials: 'same-origin'
        })
    )).then(() => {
        showAlert(`${alertIds.length} articles marked as read`, 'success');
        // Refresh the group
        const toggle = document.querySelector(`#showReadToggle_${groupId}`);
        if (topic && toggle) {
            refreshGroupArticles(topic, groupId, toggle.checked);
        } else {
            // If we can't get the topic, just reload the page
            setTimeout(() => window.location.reload(), 1000);
        }
    }).catch(error => {
        console.error('Error:', error);
        showAlert('Failed to mark articles as read', 'danger');
    });
}

function bulkDeleteSelected(groupId) {
    const checkedBoxes = document.querySelectorAll(`[data-group-id="${groupId}"] .article-checkbox:checked`);
    const alertIds = Array.from(checkedBoxes).map(cb => cb.dataset.alertId);
    
    if (alertIds.length === 0) {
        showAlert('No articles selected', 'warning');
        return;
    }
    
    if (!confirm(`Delete ${alertIds.length} selected articles? This action cannot be undone.`)) return;
    
    // Get the topic from the group container instead of the checkbox
    const groupContainer = document.querySelector(`[data-group-id="${groupId}"]`);
    let topic = groupContainer ? groupContainer.dataset.topic : null;
    
    if (!topic) {
        // Fallback: try to get topic from the card header
        const cardHeader = document.querySelector(`#group-${groupId}`);
        if (cardHeader) {
            const topicBadge = cardHeader.querySelector('.badge.bg-secondary');
            if (topicBadge) {
                topic = topicBadge.textContent.trim();
            }
        }
    }
    
    // Get article URLs for deletion
    const articleUrls = Array.from(checkedBoxes).map(cb => {
        const row = cb.closest('tr');
        const articleLink = row.querySelector('.article-title');
        return articleLink ? articleLink.href : null;
    }).filter(url => url);
    
    fetch('/api/bulk_delete_articles', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uris: articleUrls })
    }).then(response => response.json())
    .then(result => {
        showAlert(`${result.deleted_count} articles deleted`, 'success');
        // Refresh the group
        const toggle = document.querySelector(`#showReadToggle_${groupId}`);
        if (topic && toggle) {
            refreshGroupArticles(topic, groupId, toggle.checked);
        } else {
            // If we can't get the topic, just reload the page
            setTimeout(() => window.location.reload(), 1000);
        }
    }).catch(error => {
        console.error('Error:', error);
        showAlert('Failed to delete articles', 'danger');
    });
}

// At the top of the script section, change the storage structure
const selectedArticles = {
    byTopic: {},  // Store by topic for bulk operations
    byGroup: {}   // Store by group for UI updates
};

// Add pagination state tracking
const paginationState = {};

// Relevance analysis state
let currentRelevanceData = {
    topic: null,
    groupId: null,
    articleUris: [],
    keywords: []
};

// Available AI models cache
let availableModels = [];

function generateTopicId(topic) {
    return `bulkAnalyzeBtn_${topic.replace(/[^a-zA-Z0-9]/g, '_')}`;
}

let selectedArticlesByTopic = {};

// Load available AI models
async function loadAvailableModels() {
    console.log(' loadAvailableModels called');
    try {
        console.log(' Fetching models from /api/available_models');
        const response = await fetch('/api/available_models');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const models = await response.json();
        console.log(' Models received:', models);
        availableModels = models;
        
        const modelSelect = document.getElementById('modelSelect');
        console.log(' Model select element:', modelSelect);
        
        if (modelSelect) {
            if (models.length === 0) {
                console.warn(' No models found');
                modelSelect.innerHTML = '<option value="">No models configured</option>';
            } else {
                console.log(` Loading ${models.length} models into dropdown`);
                modelSelect.innerHTML = '<option value="">Select a model...</option>';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.provider})`;
                    
                    // Add data attributes for additional info
                    if (model.provider) {
                        option.dataset.provider = model.provider;
                    }
                    
                    modelSelect.appendChild(option);
                    console.log(` Added model: ${model.name} (${model.provider})`);
                });
                console.log(' Successfully loaded models into dropdown');
            }
        } else {
            console.error(' modelSelect element not found in DOM');
        }
    } catch (error) {
        console.error(' Error loading available models:', error);
        const modelSelect = document.getElementById('modelSelect');
        if (modelSelect) {
            modelSelect.innerHTML = '<option value="">Error loading models</option>';
        }
    }
}

// Analyze relevance for selected articles
async function analyzeRelevanceSelected(topic, groupId) {
    const checkedBoxes = document.querySelectorAll(`[data-group-id="${groupId}"] .article-checkbox:checked`);
    
    if (checkedBoxes.length === 0) {
        showAlert('No articles selected for relevance analysis', 'warning');
        return;
    }
    
    // Get article URIs from selected checkboxes
    const articleUris = Array.from(checkedBoxes).map(cb => {
        const row = cb.closest('tr');
        const articleLink = row.querySelector('.article-title');
        return articleLink ? articleLink.href : null;
    }).filter(uri => uri);
    
    if (articleUris.length === 0) {
        showAlert('No valid article URLs found for selected articles', 'warning');
        return;
    }
    
    // Store current analysis data
    currentRelevanceData = {
        topic: topic,
        groupId: groupId,
        articleUris: articleUris,
        keywords: [] // Will be populated from backend
    };
    
    // Load models if not already loaded
    if (availableModels.length === 0) {
        loadAvailableModels();
    }
    
    // Show the model selection modal
    const modal = new bootstrap.Modal(document.getElementById('modelSelectionModal'));
    modal.show();
    
    // Update modal title
    document.getElementById('modelSelectionModalLabel').textContent = 
        `Select AI Model for Relevance Analysis (${articleUris.length} articles)`;
}

// Start relevance analysis with selected model (background processing)
async function startRelevanceAnalysis() {
    const modelSelect = document.getElementById('modelSelect');
    
    const selectedModel = modelSelect.value;
    if (!selectedModel) {
        showAlert('Please select an AI model', 'warning');
        return;
    }
    
    // Immediately close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modelSelectionModal'));
    modal.hide();
    
    // Reset modal state for next use
    const progressBar = document.getElementById('analysisProgress');
    const statusDiv = document.getElementById('analysisStatus');
    const startBtn = document.getElementById('startAnalysisBtn');
    progressBar.style.display = 'none';
    statusDiv.style.display = 'none';
    startBtn.disabled = false;
    const progressBarElement = progressBar.querySelector('.progress-bar');
    progressBarElement.style.width = '0%';
    statusDiv.textContent = '';
    
    // Show start notification
    showAlert(`Starting relevance analysis for ${currentRelevanceData.articleUris.length} articles using ${selectedModel}...`, 'info');
    
    try {
        const response = await fetch('/api/keyword-monitor/analyze-relevance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                article_uris: currentRelevanceData.articleUris,
                model_name: selectedModel,
                topic: currentRelevanceData.topic,
                group_id: currentRelevanceData.groupId
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Analysis failed');
        }
        
        const result = await response.json();
        
        // Show completion notification
        showAlert(` Relevance analysis completed! Updated ${result.updated_count} articles using ${selectedModel}. Refreshing data...`, 'success');
        
        // Refresh the group to show updated relevance scores
        setTimeout(async () => {
            const toggle = document.querySelector(`#showReadToggle_${currentRelevanceData.groupId}`);
            if (toggle) {
                await refreshGroupArticles(currentRelevanceData.topic, currentRelevanceData.groupId, toggle.checked);
                showAlert(` Relevance scores updated for ${currentRelevanceData.topic} group`, 'success');
            } else {
                // If we can't refresh the group, just reload the page
                setTimeout(() => window.location.reload(), 1000);
            }
        }, 1500);
        
    } catch (error) {
        console.error('Error during relevance analysis:', error);
        showAlert(` Relevance analysis failed: ${error.message}`, 'danger');
    }
}

// Update relevance display after analysis
function updateRelevanceDisplay(articleUri, relevanceData) {
    const relevanceColumn = document.querySelector(`[data-article-uri="${articleUri}"] .relevance-column`);
    if (!relevanceColumn) return;
    
    // Check if the article has been analyzed
    if (relevanceData.topic_alignment_score === null || relevanceData.topic_alignment_score === undefined) {
        relevanceColumn.innerHTML = '<span class="text-muted small">Not analyzed</span>';
        return;
    }
    
    const topicScore = relevanceData.topic_alignment_score;
    const keywordScore = relevanceData.keyword_relevance_score || 0;
    const confidence = relevanceData.confidence_score || 0;
    const explanation = relevanceData.overall_match_explanation || '';
    
    const tooltipText = `Topic: ${topicScore.toFixed(2)} | Keywords: ${keywordScore.toFixed(2)} | Confidence: ${confidence.toFixed(2)}${explanation ? ' | ' + explanation : ''}`;
    
    relevanceColumn.innerHTML = `
        <div class="relevance-scores" title="${tooltipText}">
            <div class="score-item">
                <i class="fas fa-bullseye" style="color: #0dcaf0;"></i>
                <span>${topicScore.toFixed(2)}</span>
            </div>
            <div class="score-item">
                <i class="fas fa-key" style="color: #198754;"></i>
                <span>${keywordScore.toFixed(2)}</span>
            </div>
            <div class="score-item">
                <i class="fas fa-chart-line" style="color: #fd7e14;"></i>
                <span>${confidence.toFixed(2)}</span>
            </div>
        </div>
    `;
}

// NOTE: Consolidated with main DOMContentLoaded listener below

async function loadTrendChart() {
    try {
        const response = await fetch('/api/keyword-monitor/trends', {
            credentials: 'same-origin'
        });
        if (!response.ok) throw new Error('Failed to fetch trend data');
        
        const data = await response.json();
        
        Object.entries(data).forEach(([groupId, groupData]) => {
            const canvas = document.getElementById(`sparkline-${groupId}`);
            if (!canvas) return;
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            drawSparkline(canvas, groupData);
        });
    } catch (error) {
        console.error('Error loading trend charts:', error);
    }
}

async function markAsRead(alertId) {
    try {
        const response = await fetch(`/api/keyword-monitor/alerts/${alertId}/read`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        
        if (!response.ok) throw new Error('Failed to mark alert as read');
        
        const alertElement = document.querySelector(`[onclick*="${alertId}"]`);
        if (!alertElement) throw new Error('Alert element not found');
        
        const topic = alertElement.dataset.topic;
        const groupId = alertElement.dataset.groupId;
        
        if (!topic || !groupId) {
            console.error('Missing topic or groupId:', { topic, groupId });
            throw new Error('Missing required data attributes');
        }
        
        // Update the status badge count
        const groupCard = alertElement.closest('.card');
        const statusBadge = groupCard.querySelector('.badge.bg-primary');
        const currentCount = parseInt(statusBadge.textContent);
        if (!isNaN(currentCount)) {
            const newCount = Math.max(0, currentCount - 1);
            statusBadge.textContent = `${newCount} alerts`;
        }
        
        const toggle = document.querySelector(`#showReadToggle_${groupId}`);
        if (!toggle) throw new Error('Toggle element not found');
        
        // Refresh with current toggle state
        await refreshGroupArticles(topic, groupId, toggle.checked);
        
        showAlert('Alert marked as read', 'success');
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to mark alert as read', 'danger');
    }
}

function showAlert(message, type = 'danger') {
    let alert = document.getElementById('alertMessage');
    if (!alert) {
        // Create alert element if it doesn't exist
        alert = document.createElement('div');
        alert.id = 'alertMessage';
        alert.className = 'alert alert-dismissible fade';
        alert.setAttribute('role', 'alert');
        alert.style.position = 'fixed';
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '1050';
        alert.style.minWidth = '300px';
        alert.style.maxWidth = '500px';
        alert.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)';
        
        document.body.appendChild(alert);
    }

    // Update alert content
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        <span id="alertText">${message}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    alert.style.display = 'block';
    
    // Clear any existing timeout
    if (alert.timeoutId) {
        clearTimeout(alert.timeoutId);
    }
    
    // For rate limit warnings, show longer and update the status indicator
    const timeout = type === 'warning' && message.toLowerCase().includes('rate limit') ? 10000 : 5000;
    
    // Show rate limit warning indicator if this is a rate limit error
    if (type === 'warning' && message.toLowerCase().includes('rate limit')) {
        const rateLimitWarning = document.getElementById('rateLimitWarning');
        if (rateLimitWarning) {
            rateLimitWarning.style.display = 'inline';
        }
    }
    
    // Auto-dismiss after timeout
    alert.timeoutId = setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => {
            alert.style.display = 'none';
        }, 150); // Match the fade transition time
    }, timeout);
    
    // Add click handler for manual dismissal
    const closeButton = alert.querySelector('.btn-close');
    if (closeButton) {
        closeButton.onclick = () => {
            alert.classList.remove('show');
            setTimeout(() => {
                alert.style.display = 'none';
            }, 150);
        };
    }
}

async function checkKeywords() {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        
        console.log("Sending check-now request to API...");
        const response = await fetch('/api/keyword-monitor/check-now', {
            method: 'POST',
            credentials: 'same-origin'
        });
        
        console.log("API response received:", response.status);
        
        if (response.status === 429) {
            const errorData = await response.json().catch(() => ({}));
            const message = errorData.detail || 'API daily request limit reached. Please try again tomorrow.';
            showAlert(message, 'warning');
            return;
        }
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error("API error:", errorData);
            
            // Check if the error message contains rate limit information
            if (errorData.detail && errorData.detail.toLowerCase().includes('rate limit')) {
                showAlert('Rate limit exceeded. Please try again later or upgrade your API plan.', 'warning');
            } else {
            throw new Error(errorData.detail || 'Failed to check keywords');
            }
            return;
        }
        
        const result = await response.json();
        console.log("API check complete:", result);
        
        // Check if the result indicates rate limiting or no articles due to limits
        if (result.message && result.message.toLowerCase().includes('rate limit')) {
            showAlert('Rate limit reached during keyword check. Some keywords may not have been processed.', 'warning');
        } else if (result.error && result.error.toLowerCase().includes('rate limit')) {
            showAlert('Rate limit reached during keyword check. Some keywords may not have been processed.', 'warning');
        } else if (result.new_articles === 0 && result.warnings && result.warnings.some(w => w.toLowerCase().includes('rate limit'))) {
            showAlert('Rate limit reached. No new articles found due to API limitations.', 'warning');
        } else {
        // Show success message
            const articlesFound = result.new_articles || 0;
            showAlert(`Keyword check completed successfully. Found ${articlesFound} new articles. Refreshing page...`, 'success');
        }
        
        // Wait a moment to ensure database operations complete
        setTimeout(() => {
            console.log("Reloading page to show updated results");
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Error:', error);
        
        // Check if the error message contains rate limit information
        if (error.message && error.message.toLowerCase().includes('rate limit')) {
            showAlert('Rate limit exceeded. Please try again later or upgrade your API plan.', 'warning');
        } else {
        showAlert('Failed to check keywords: ' + error.message, 'danger');
        }
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

// Update the DOMContentLoaded event listener to be simpler
document.addEventListener('DOMContentLoaded', function() {
    console.log(' DOMContentLoaded event fired');
    
    // Load models and trend chart
    console.log(' Loading charts and models...');
    loadTrendChart();
    loadAvailableModels();
    setInterval(loadTrendChart, 5 * 60 * 1000);
    
    // Initialize toggles
    document.querySelectorAll('.show-read-toggle').forEach(toggle => {
        const topic = toggle.dataset.topic;
        const groupId = toggle.dataset.groupId;
        
        if (!topic || !groupId) {
            console.error('Toggle missing required data attributes');
            return;
        }
        
        const savedState = localStorage.getItem(`showReadArticles_${groupId}`);
        toggle.checked = savedState === 'true' || false;
        
        toggle.addEventListener('change', async function() {
            console.log(`Toggle changed for group ${groupId} (${topic}): ${this.checked}`);
            localStorage.setItem(`showReadArticles_${groupId}`, this.checked);
            await refreshGroupArticles(topic, groupId, this.checked);
        });
    });

    // Initialize reset timer
    updateResetTimer();
    setInterval(updateResetTimer, 60000);
    
    // Add media bias info to all articles
    console.log('Initializing media bias enhancement');
    
    // First call the enhanced media bias function for initial page load
    enhanceAllArticlesWithMediaBias();
    
    // Check for missing relevance data and refresh if needed
    checkAndRefreshRelevanceData();
    
    // Initialize table sorting
    initializeTableSorting();
    
    // Initialize relevance filters - prioritize main slider
    document.querySelectorAll('[id^="mainRelevanceSlider_"]').forEach(mainSlider => {
        const groupId = mainSlider.dataset.groupId;
        // Set initial display for main slider
        applyMainRelevanceFilter(groupId);
    });
    
    // Initialize any remaining advanced sliders that might be visible
    document.querySelectorAll('.relevance-slider:not([id^="mainRelevanceSlider_"])').forEach(slider => {
        const groupId = slider.dataset.groupId;
        const advancedFilters = document.getElementById(`advancedFilters_${groupId}`);
        // Only apply if advanced filters are visible
        if (advancedFilters && advancedFilters.style.display !== 'none') {
            applyRelevanceFilter(groupId);
        }
    });
    
    // Then set up a MutationObserver to detect when new articles are added
    const articleContainers = document.querySelectorAll('.card-body table tbody');
    if (articleContainers.length > 0) {
        console.log(`Setting up observers for ${articleContainers.length} article containers`);
        
        const observer = new MutationObserver(function(mutations) {
            console.log('Detected DOM changes, enhancing media bias');
            enhanceAllArticlesWithMediaBias();
            // Re-initialize sorting for new tables
            initializeTableSorting();
        });
        
        // Observe each article container for child additions/removals
        articleContainers.forEach(container => {
            observer.observe(container, { childList: true });
        });
    }
});

// Function to check for missing relevance data and refresh if needed
function checkAndRefreshRelevanceData() {
    console.log('Checking for missing relevance data on page load...');
    
    // Find all groups that have articles but missing relevance data
    const groupsNeedingRefresh = [];
    
    document.querySelectorAll('.show-read-toggle').forEach(toggle => {
        const groupId = toggle.dataset.groupId;
        const topic = toggle.dataset.topic;
        
        if (!groupId || !topic) return;
        
        // Check if this group has articles
        const groupCard = document.querySelector(`#group-${groupId}`);
        if (!groupCard) return;
        
        const articleRows = groupCard.querySelectorAll('tbody tr[data-alert-id]');
        if (articleRows.length === 0) return;
        
        // Check how many articles are missing relevance data
        let missingRelevanceCount = 0;
        articleRows.forEach(row => {
            const relevanceColumn = row.querySelector('.relevance-column');
            if (relevanceColumn) {
                const hasRelevanceScores = relevanceColumn.querySelector('.relevance-scores');
                const hasNotAnalyzedText = relevanceColumn.textContent.includes('Not analyzed');
                
                // If it shows "Not analyzed" but the article might actually be analyzed
                if (hasNotAnalyzedText || !hasRelevanceScores) {
                    missingRelevanceCount++;
                }
            }
        });
        
        // If more than half the articles are missing relevance data, refresh this group
        if (missingRelevanceCount > articleRows.length * 0.5) {
            console.log(`Group ${groupId} (${topic}) has ${missingRelevanceCount}/${articleRows.length} articles missing relevance data - scheduling refresh`);
            groupsNeedingRefresh.push({ topic, groupId, toggle });
        }
    });
    
    // Refresh groups that need it (with a small delay to avoid overwhelming the server)
    if (groupsNeedingRefresh.length > 0) {
        console.log(`Refreshing ${groupsNeedingRefresh.length} groups with missing relevance data`);
        
        groupsNeedingRefresh.forEach((group, index) => {
            setTimeout(async () => {
                console.log(`Refreshing relevance data for group ${group.groupId} (${group.topic})`);
                await refreshGroupArticles(group.topic, group.groupId, group.toggle.checked, true);
            }, index * 1000); // Stagger refreshes by 1 second each
        });
    }
}

// Helper function for normalizing domains (matches Python normalize_domain)
function normalizeDomain(url) {
    if (!url) return '';
    
    // Convert to lowercase
    let domain = url.toLowerCase();
    
    // Remove protocol if present
    if (domain.startsWith('http://')) {
        domain = domain.substring(7);
    } else if (domain.startsWith('https://')) {
        domain = domain.substring(8);
    }
    
    // Remove www. if present
    if (domain.startsWith('www.')) {
        domain = domain.substring(4);
    }
    
    // Remove paths, query parameters, etc.
    domain = domain.split('/')[0];
    
    // Remove trailing punctuation
    domain = domain.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '');
    
    return domain.trim();
}

// Helper function to check if two domains match (like Python domains_match)
function domainsMatch(sourceDomain, targetDomain) {
    if (!sourceDomain || !targetDomain) return false;
    
    // Normalize both domains
    sourceDomain = normalizeDomain(sourceDomain);
    targetDomain = normalizeDomain(targetDomain);
    
    // Check for exact match
    if (sourceDomain === targetDomain) return true;
    
    // Check if one is a subdomain of the other
    if (sourceDomain.endsWith('.' + targetDomain)) return true;
    if (targetDomain.endsWith('.' + sourceDomain)) return true;
    
    // Extract root domains (e.g., example.com from sub.example.com)
    const sourceParts = sourceDomain.split('.');
    const targetParts = targetDomain.split('.');
    
    if (sourceParts.length >= 2 && targetParts.length >= 2) {
        const sourceRoot = sourceParts.slice(-2).join('.');
        const targetRoot = targetParts.slice(-2).join('.');
        if (sourceRoot === targetRoot) return true;
    }
    
    return false;
}

// Function for adding media bias badges to dynamically loaded articles
function enhanceAllArticlesWithMediaBias() {
    console.log('Enhancing all articles with media bias data and enrichment status');
    
    // Target article detail tables (not the overview table)
    const articleTables = document.querySelectorAll('table[id^="articlesTable_"]');
    console.log(`Found ${articleTables.length} article tables to process`);
    
    articleTables.forEach((table, tableIndex) => {
        const rows = table.querySelectorAll('tbody tr[data-alert-id]');
        console.log(`Processing table ${tableIndex} with ${rows.length} article rows`);
        
        rows.forEach((row, rowIndex) => {
            // Look for source info - should be in 4th column
            const sourceCell = row.querySelector('td:nth-child(4) .source-info');
            if (!sourceCell) return;
            
            const sourceNameElement = sourceCell.querySelector('.source-name');
            if (!sourceNameElement) return;
            
            const sourceName = sourceNameElement.textContent.trim();
            if (!sourceName) return;
            
            // Check if already enhanced
            if (sourceCell.querySelector('.bias-badge') || sourceCell.classList.contains('media-bias-enhanced')) {
                return;
            }
            
            console.log(`Processing article ${rowIndex}: ${sourceName}`);
            
            // Enhanced known sources database
            const knownSources = {
                'vanity fair': { bias: 'Left', factual: 'Mixed', country: 'USA' },
                'cnn': { bias: 'Left', factual: 'Mostly Factual', country: 'USA' },
                'forbes': { bias: 'Least Biased', factual: 'Mostly Factual', country: 'USA' },
                'yahoo': { bias: 'Left-Center', factual: 'Mostly Factual', country: 'USA' },
                'yahoo finance': { bias: 'Left-Center', factual: 'Mostly Factual', country: 'USA' },
                'the verge': { bias: 'Left-Center', factual: 'Mostly Factual', country: 'USA' },
                'techcrunch': { bias: 'Least Biased', factual: 'High', country: 'USA' },
                'reuters': { bias: 'Least Biased', factual: 'Very High', country: 'UK' },
                'bbc': { bias: 'Left-Center', factual: 'High', country: 'UK' },
                'associated press': { bias: 'Least Biased', factual: 'Very High', country: 'USA' },
                'wall street journal': { bias: 'Right-Center', factual: 'High', country: 'USA' },
                'new york times': { bias: 'Left-Center', factual: 'High', country: 'USA' },
                'washington post': { bias: 'Left-Center', factual: 'High', country: 'USA' },
                'usa today': { bias: 'Left-Center', factual: 'Mostly Factual', country: 'USA' },
                'fox news': { bias: 'Right', factual: 'Mixed', country: 'USA' },
                'cnet': { bias: 'Least Biased', factual: 'Mostly Factual', country: 'USA' },
                'wired': { bias: 'Left-Center', factual: 'High', country: 'USA' },
                'ars technica': { bias: 'Left-Center', factual: 'High', country: 'USA' },
                'engadget': { bias: 'Left-Center', factual: 'Mostly Factual', country: 'USA' }
            };
            
            let matchedSource = null;
            const sourceNameLower = sourceName.toLowerCase();
            
            // Check for match with any known source
            for (const [source, data] of Object.entries(knownSources)) {
                if (sourceNameLower.includes(source.toLowerCase()) || 
                    domainsMatch(source, sourceName)) {
                    console.log(`Source ${sourceName} matches known source: ${source}`);
                    matchedSource = { source: source, ...data };
                    break;
                }
            }
            
            // Add media bias display if we have a match
            if (matchedSource) {
                console.log(`Adding media bias display for ${sourceName}`);
                
                const biasClass = getBiasClass(matchedSource.bias);
                const factualClass = getFactualClass(matchedSource.factual);
                
                const biasHtml = `
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        <span class="bias-badge ${biasClass}" title="Media Bias: ${matchedSource.bias}">
                            ${matchedSource.bias}
                        </span>
                        <span class="bias-badge ${factualClass}" title="Factual Reporting: ${matchedSource.factual}">
                            ${matchedSource.factual}
                        </span>
                        ${matchedSource.country ? `<span class="badge bg-light text-dark border" title="Country: ${matchedSource.country}">${matchedSource.country}</span>` : ''}
                    </div>
                `;
                
                sourceCell.insertAdjacentHTML('beforeend', biasHtml);
                sourceCell.classList.add('media-bias-enhanced');
            }
            
                         // Skip status badge updates for initial page load - let template handle it
             // Only update status badges for truly dynamically loaded content
             if (sourceCell.closest('table').dataset.dynamicallyLoaded === 'true') {
                 const statusCell = row.querySelector('td:nth-child(2)');
                 if (statusCell) {
                     const statusBadge = statusCell.querySelector('.badge');
                     if (statusBadge) {
                         // Check only category field to determine enrichment status
                         const hasCategory = !!(row.dataset.articleCategory && row.dataset.articleCategory.trim() !== '');
                         
                         if (hasCategory && !statusBadge.classList.contains('bg-success')) {
                             statusBadge.className = 'badge bg-success';
                             statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Added';
                             statusBadge.title = 'Article has been analyzed';
                         } else if (!hasCategory && !statusBadge.classList.contains('bg-warning')) {
                             statusBadge.className = 'badge bg-warning text-dark';
                             statusBadge.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>New';
                             statusBadge.title = 'Article needs analysis';
                         }
                     }
                 }
             }
        });
    });
    
    console.log('Media bias enhancement complete');
}

// Backward compatibility: keep the old function name but use the new implementation
function debugMediaBias() {
    console.log('Using enhanced media bias function');
    enhanceAllArticlesWithMediaBias();
}

// Add custom date formatting
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    // Handle future dates
    if (seconds < 0) {
        const futureSeconds = Math.abs(seconds);
        
        let interval = Math.floor(futureSeconds / 31536000);
        if (interval > 1) return `in ${interval} years`;
        
        interval = Math.floor(futureSeconds / 2592000);
        if (interval > 1) return `in ${interval} months`;
        
        interval = Math.floor(futureSeconds / 86400);
        if (interval > 1) return `in ${interval} days`;
        
        interval = Math.floor(futureSeconds / 3600);
        if (interval > 1) return `in ${interval} hours`;
        
        interval = Math.floor(futureSeconds / 60);
        if (interval > 1) return `in ${interval} minutes`;
        
        return `in ${Math.floor(futureSeconds)} seconds`;
    }
    
    // Handle past dates (original logic)
    let interval = Math.floor(seconds / 31536000);
    if (interval > 1) return `${interval} years ago`;
    
    interval = Math.floor(seconds / 2592000);
    if (interval > 1) return `${interval} months ago`;
    
    interval = Math.floor(seconds / 86400);
    if (interval > 1) return `${interval} days ago`;
    
    interval = Math.floor(seconds / 3600);
    if (interval > 1) return `${interval} hours ago`;
    
    interval = Math.floor(seconds / 60);
    if (interval > 1) return `${interval} minutes ago`;
    
    return `${Math.floor(seconds)} seconds ago`;
}

// Add Jinja filters
document.addEventListener('DOMContentLoaded', function() {
    const dates = document.querySelectorAll('[data-date]');
    dates.forEach(el => {
        const dateStr = el.dataset.date;
        if (el.classList.contains('timeago')) {
            el.textContent = timeAgo(dateStr);
        } else {
            el.textContent = formatDate(dateStr);
        }
    });
});

async function togglePolling(enabled) {
    try {
        const response = await fetch('/api/keyword-monitor/toggle-polling', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enabled }),
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error('Failed to toggle polling');
        }
        
        // Update the label text
        const label = document.querySelector('label[for="pollingToggle"]');
        if (label) {
            label.textContent = `Auto-polling ${enabled ? 'enabled' : 'disabled'}`;
        }
        
        // Update the next check time display
        const nextCheckSpan = document.querySelector('span.text-muted i.fa-hourglass-half')?.parentElement;
        if (nextCheckSpan) {
            if (enabled) {
                // Refresh the status to get accurate next check time
                fetchMonitorStatus();
            } else {
                nextCheckSpan.innerHTML = `<i class="fas fa-hourglass-half"></i> Polling disabled`;
            }
        }
        
        showAlert(`Auto-polling ${enabled ? 'enabled' : 'disabled'}`, 'success');
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to toggle polling');
        // Revert the toggle if there was an error
        const toggle = document.getElementById('pollingToggle');
        if (toggle) {
            toggle.checked = !enabled;
        }
    }
}

async function exportAlerts() {
    try {
        const response = await fetch('/api/keyword-monitor/export-alerts', {
            credentials: 'same-origin'
        });
        if (!response.ok) throw new Error('Failed to export alerts');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `keyword_alerts_${timestamp}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        showAlert('Alerts exported successfully!', 'success');
    } catch (error) {
        console.error('Error exporting alerts:', error);
        showAlert('Failed to export alerts. Please try again.', 'danger');
    }
}

function toggleArticleSelection(element) {
    const articleData = {
        url: element.dataset.url,
        title: element.dataset.title,
        summary: element.dataset.summary,
        topic: element.dataset.topic,
        groupId: element.dataset.groupId
    };
    
    // Initialize storage if needed
    if (!selectedArticles.byTopic[articleData.topic]) {
        selectedArticles.byTopic[articleData.topic] = [];
    }
    if (!selectedArticles.byGroup[articleData.groupId]) {
        selectedArticles.byGroup[articleData.groupId] = [];
    }
    
    element.classList.toggle('selected');
    
    if (element.classList.contains('selected')) {
        // Add to both topic and group arrays if not already present
        if (!selectedArticles.byTopic[articleData.topic].some(article => article.url === articleData.url)) {
            selectedArticles.byTopic[articleData.topic].push(articleData);
        }
        if (!selectedArticles.byGroup[articleData.groupId].some(article => article.url === articleData.url)) {
            selectedArticles.byGroup[articleData.groupId].push(articleData);
        }
    } else {
        // Remove from both arrays
        selectedArticles.byTopic[articleData.topic] = selectedArticles.byTopic[articleData.topic]
            .filter(article => article.url !== articleData.url);
        selectedArticles.byGroup[articleData.groupId] = selectedArticles.byGroup[articleData.groupId]
            .filter(article => article.url !== articleData.url);
    }
    
    updateBulkButtons(articleData.topic, articleData.groupId);
}

function updateBulkButtons(topic, groupId) {
    const groupArticles = selectedArticles.byGroup[groupId] || [];
    const buttonContainer = document.querySelector(`.d-flex[data-group-id="${groupId}"]`);
    if (!buttonContainer) return;
    
    // Update analyze button for this specific group
    const bulkAnalyzeBtn = buttonContainer.querySelector('.bulk-analyze-btn');
    if (bulkAnalyzeBtn) {
        if (groupArticles.length > 0) {
            bulkAnalyzeBtn.style.display = 'inline-block';
            const selectedCount = bulkAnalyzeBtn.querySelector('.selected-count');
            if (selectedCount) {
                selectedCount.textContent = groupArticles.length;
            }
        } else {
            bulkAnalyzeBtn.style.display = 'none';
        }
    }
    
    // Update delete button for this specific group
    const bulkDeleteBtn = buttonContainer.querySelector('.bulk-delete-btn');
    if (bulkDeleteBtn) {
        if (groupArticles.length > 0) {
            bulkDeleteBtn.style.display = 'inline-block';
            const deleteCount = bulkDeleteBtn.querySelector('.delete-count');
            if (deleteCount) {
                deleteCount.textContent = groupArticles.length;
            }
        } else {
            bulkDeleteBtn.style.display = 'none';
        }
    }
}

// Pagination helper functions
function generatePageNumbers(currentPage, totalPages, topic, groupId) {
    let html = '';
    const maxVisible = 5; // Maximum number of page buttons to show
    
    if (totalPages <= maxVisible) {
        // Show all pages if total is small
        for (let i = 1; i <= totalPages; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" 
                       onclick="changePage('${topic}', ${groupId}, ${i}); return false;">
                        ${i}
                    </a>
                </li>
            `;
        }
    } else {
        // Show ellipsis for many pages
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);
        
        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }
        
        if (startPage > 1) {
            html += `
                <li class="page-item">
                    <a class="page-link" href="#" 
                       onclick="changePage('${topic}', ${groupId}, 1); return false;">
                        1
                    </a>
                </li>
            `;
            if (startPage > 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" 
                       onclick="changePage('${topic}', ${groupId}, ${i}); return false;">
                        ${i}
                    </a>
                </li>
            `;
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            html += `
                <li class="page-item">
                    <a class="page-link" href="#" 
                       onclick="changePage('${topic}', ${groupId}, ${totalPages}); return false;">
                        ${totalPages}
                    </a>
                </li>
            `;
        }
    }
    
    return html;
}

async function changePage(topic, groupId, page) {
    const toggle = document.querySelector(`#showReadToggle_${groupId}`);
    const showRead = toggle ? toggle.checked : false;
    
    // Clear selections when changing pages
    selectedArticles.byGroup[groupId] = [];
    updateBulkActions(groupId);
    
    await refreshGroupArticles(topic, groupId, showRead, true, page);
}

async function changePageSize(topic, groupId, pageSize) {
    // Update page size in state
    if (!paginationState[groupId]) {
        paginationState[groupId] = {};
    }
    paginationState[groupId].pageSize = parseInt(pageSize);
    
    // Reset to page 1 when changing page size
    const toggle = document.querySelector(`#showReadToggle_${groupId}`);
    const showRead = toggle ? toggle.checked : false;
    
    // Clear selections when changing page size
    selectedArticles.byGroup[groupId] = [];
    updateBulkActions(groupId);
    
    await refreshGroupArticles(topic, groupId, showRead, true, 1);
}

function analyzeBulkArticles(topic, groupId) {
    const articles = selectedArticles.byGroup[groupId] || [];
    if (articles.length === 0) {
        showAlert('No articles selected for analysis', 'warning');
        return;
    }
    
    // Prepare articles for modal
    openArticleAnalysisModal(articles, topic, groupId);
}

// Function to analyze selected articles using checkboxes
function analyzeSelectedArticles(topic, groupId) {
    const checkedBoxes = document.querySelectorAll(`[data-group-id="${groupId}"] .article-checkbox:checked`);
    
    if (checkedBoxes.length === 0) {
        showAlert('No articles selected for analysis', 'warning');
        return;
    }
    
    // Extract article data with metadata preservation
    const articles = Array.from(checkedBoxes).map(checkbox => {
        const row = checkbox.closest('tr');
        const articleLink = row.querySelector('.article-title');
        const sourceCell = row.querySelector('.source-name');
        const titleText = articleLink ? articleLink.textContent.trim() : '';
        const sourceText = sourceCell ? sourceCell.textContent.trim() : '';
        const url = articleLink ? articleLink.href : null;
        
        if (!url) return null;
        
        // Extract publication date if available
        let publicationDate = '';
        const dateCell = row.querySelector('td:nth-child(5)'); // Detected column
        if (dateCell) {
            const dateText = dateCell.textContent.trim();
            if (dateText && dateText !== '-') {
                const cleanedDate = cleanPublicationDate(dateText);
                if (cleanedDate) {
                    publicationDate = cleanedDate;
                }
            }
        }
        
        return {
            url: url,
            title: titleText,
            source: sourceText,
            publication_date: publicationDate,
            summary: row.querySelector('.article-summary')?.textContent?.trim() || ''
        };
    }).filter(article => article);
    
    if (articles.length === 0) {
        showAlert('No valid articles found for analysis', 'warning');
        return;
    }
    
    // Open analysis modal
    openArticleAnalysisModal(articles, topic, groupId);
}

// Function to check if an article has been enriched (has category field populated)
function isArticleEnriched(article) {
    if (!article) return false;
    
    // Article is considered enriched if it has a populated category field
    const hasCategory = !!(article.category && article.category.trim() !== '');
    
    // Debug logging for specific articles
    if (article.uri && (article.uri.includes('tomshardware') || article.uri.includes('yahoo') || article.uri.includes('forbes') || article.title?.includes('AI Uncertainty'))) {
        console.log('isArticleEnriched check for:', article.title?.substring(0, 50) + '...', {
            uri: article.uri,
            category: `"${article.category}"`,
            hasCategory: hasCategory,
            isEnriched: hasCategory
        });
    }
    
    return hasCategory;
}

// Function to create enrichment status badge
function createEnrichmentBadge(article) {
    if (!article) return '';
    
    // Only check category field for enrichment status
    const hasCategory = !!(article.category && article.category.trim() !== '');
    
    if (hasCategory) {
        return `<span class="badge bg-success ms-1" title="Article has been analyzed">
            <i class="fas fa-check-circle me-1"></i>Added
        </span>`;
    }
    
    return `<span class="badge bg-warning text-dark ms-1" title="Article needs analysis">
        <i class="fas fa-exclamation-circle me-1"></i>New
    </span>`;
}



// Function to export alerts for a specific group
async function exportGroupAlerts(topic, groupId) {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        
        console.log(`Exporting alerts for group ${groupId}, topic: ${topic}`);
        
        const response = await fetch(`/api/keyword-monitor/export-group-alerts?topic=${encodeURIComponent(topic)}&group_id=${groupId}`, {
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error('Failed to export group alerts');
        }
        
        // Create download link
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `${topic.replace(/[^a-zA-Z0-9]/g, '_')}_alerts_${timestamp}.csv`;
        
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        showAlert(`Alerts exported successfully for ${topic}!`, 'success');
        
    } catch (error) {
        console.error('Error:', error);
        showAlert(`Failed to export alerts: ${error.message}`, 'danger');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

// Function to update a specific group now
async function updateGroupNow(topic, groupId) {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        
        console.log(`Updating group ${groupId} (${topic}) now...`);
        
        const response = await fetch('/api/keyword-monitor/check-now', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                topic: topic,
                group_id: parseInt(groupId)
            }),
            credentials: 'same-origin'
        });
        
        if (response.status === 429) {
            const errorData = await response.json().catch(() => ({}));
            const message = errorData.detail || 'API daily request limit reached. Please try again tomorrow.';
            showAlert(message, 'warning');
            return;
        }
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            
            // Check if the error message contains rate limit information
            if (errorData.detail && errorData.detail.toLowerCase().includes('rate limit')) {
                showAlert('Rate limit exceeded. Please try again later or upgrade your API plan.', 'warning');
            } else {
                throw new Error(errorData.detail || 'Failed to update group');
            }
            return;
        }
        
        const result = await response.json();
        console.log("Group update complete:", result);
        
        // Check if the result indicates rate limiting
        if (result.message && result.message.toLowerCase().includes('rate limit')) {
            showAlert(`Group "${topic}" check completed but rate limit reached. Some keywords may not have been processed.`, 'warning');
        } else {
            // Show success message
            showAlert(`Group "${topic}" updated successfully. Refreshing...`, 'success');
        }
        
        // Wait a moment then refresh the group
        setTimeout(async () => {
            const toggle = document.querySelector(`#showReadToggle_${groupId}`);
            if (toggle) {
                await refreshGroupArticles(topic, groupId, toggle.checked);
            }
        }, 1500);
        
    } catch (error) {
        console.error('Error:', error);
        
        // Check if the error message contains rate limit information
        if (error.message && error.message.toLowerCase().includes('rate limit')) {
            showAlert('Rate limit exceeded. Please try again later or upgrade your API plan.', 'warning');
        } else {
            showAlert(`Failed to update group: ${error.message}`, 'danger');
        }
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

async function bulkDeleteArticles(topic, groupId) {
    const articles = selectedArticles.byGroup[groupId] || [];
    
    if (articles.length === 0) {
        showAlert('No articles selected for deletion', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${articles.length} selected articles from this group?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/bulk_delete_articles', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                uris: articles.map(article => article.url)
            }),
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete articles');
        }
        
        const result = await response.json();
        showAlert(`Successfully deleted ${result.deleted_count} articles`, 'success');
        
        // Clear selections
        selectedArticles.byGroup[groupId] = [];
        selectedArticles.byTopic[topic] = [];
        
        // Update UI elements safely with null checks
        const headerBadge = document.querySelector(`a[href="#${groupId}"] .badge, [data-topic="${topic}"] .badge.bg-primary`);
        if (headerBadge) {
            headerBadge.textContent = '0 alerts';
        }
        
        const trendBadge = document.querySelector(`tr[data-topic="${topic}"] td:nth-child(5) .badge.bg-primary`);
        if (trendBadge) {
            trendBadge.textContent = '0 alerts';
        }
        
        // Safely get the toggle element
        const toggle = document.querySelector(`#showReadToggle_${groupId}`);
        if (toggle) {
            const totalSpan = toggle.closest('label')?.querySelector('.total-count');
            if (totalSpan) {
                totalSpan.textContent = '0';
            }
            
            // Refresh the group's content
            await refreshGroupArticles(topic, groupId, toggle.checked || false);
        }
        
        // Update the group content area
        const groupContainer = document.querySelector(`[data-group-id="${groupId}"]`);
        if (groupContainer) {
            const tableBody = groupContainer.closest('.card')?.querySelector('tbody');
            if (tableBody) {
                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle"></i> No new alerts for this group
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        }

    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to delete articles. Please try again.', 'danger');
    }
}

// Update refreshGroupArticles to skip media bias lookup on refresh and support pagination
async function refreshGroupArticles(topic, groupId, showRead = false, skipMediaBias = true, page = 1) {
    try {
        console.log(`Refreshing articles for group ${groupId} (${topic}), showRead: ${showRead}, page: ${page}`);
        
        // Get current page size from state or use default
        const pageSize = paginationState[groupId]?.pageSize || 50;
        
        const response = await fetch(`/api/keyword-monitor/alerts/${encodeURIComponent(topic)}?show_read=${showRead}&group_id=${groupId}&skip_media_bias=${skipMediaBias}&page=${page}&page_size=${pageSize}`, {
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        console.log('API Response status:', response.status);
        console.log('API Response headers:', response.headers.get('content-type'));
        
        if (!response.ok) {
            console.error('API Response not OK:', response.status, response.statusText);
            const text = await response.text();
            console.error('Response body:', text.substring(0, 500));
            throw new Error('Failed to fetch alerts');
        }
        
        const data = await response.json();
        
        // Store pagination info
        if (data.pagination) {
            paginationState[groupId] = {
                ...data.pagination,
                topic: topic,
                showRead: showRead
            };
        }
        
        console.log('API Response data:', data);
        console.log('Number of alerts:', data.alerts ? data.alerts.length : 0);
        console.log('Pagination info:', data.pagination);
        if (data.alerts && data.alerts.length > 0) {
            console.log('First alert:', data.alerts[0]);
            console.log('First alert article:', data.alerts[0].article);
            console.log('First alert enrichment fields:', {
                category: data.alerts[0].article.category,
                sentiment: data.alerts[0].article.sentiment,
                driver_type: data.alerts[0].article.driver_type,
                time_to_impact: data.alerts[0].article.time_to_impact,
                analysis_complete: data.alerts[0].article.analysis_complete
            });
            // Log all articles to see their enrichment status
            data.alerts.forEach((alert, index) => {
                console.log(`Alert ${index} enrichment:`, {
                    title: alert.article.title.substring(0, 50) + '...',
                    category: alert.article.category,
                    sentiment: alert.article.sentiment,
                    driver_type: alert.article.driver_type,
                    time_to_impact: alert.article.time_to_impact,
                    isEnriched: isArticleEnriched(alert.article)
                });
            });
        }
        
        // Try multiple ways to find the card
        let card = null;
        
        // Method 1: Find by group-id in the header
        const groupHeader = document.querySelector(`.d-flex[data-group-id="${groupId}"]`);
        if (groupHeader) {
            card = groupHeader.closest('.card');
        }
        
        // Method 2: Find by the group ID in the card itself
        if (!card) {
            card = document.querySelector(`#group-${groupId}`);
        }
        
        // Method 3: Find any card that contains the group ID
        if (!card) {
            const allCards = document.querySelectorAll('.card');
            for (const candidateCard of allCards) {
                const groupIdElement = candidateCard.querySelector(`[data-group-id="${groupId}"]`);
                if (groupIdElement) {
                    card = candidateCard;
                    break;
                }
            }
        }
        
        if (!card) {
            console.error(`Card not found for group ${groupId} (${topic})`);
            console.error('Available cards:', document.querySelectorAll('.card'));
            showAlert(`Unable to find group ${groupId} on page`, 'warning');
            return;
        }
        
        console.log(`Found card for group ${groupId}:`, card);
        updateGroupAlerts(card, data, groupId);
        
    } catch (error) {
        console.error('Error refreshing articles:', error);
        showAlert('Failed to refresh articles', 'danger');
    }
}

// Update the updateGroupAlerts function to add more debugging for media bias HTML generation
function updateGroupAlerts(card, data, groupId) {
    // Try multiple selectors to find the table body, including nested card structures
    let tableBody = card.querySelector('tbody');
    
    if (!tableBody) {
        // Try to find it in the table-responsive container
        const tableContainer = card.querySelector('.table-responsive');
        if (tableContainer) {
            tableBody = tableContainer.querySelector('tbody');
        }
    }
    
    if (!tableBody) {
        // Try to find any table body in the card (including nested cards)
        tableBody = card.querySelector('table tbody');
    }
    
    // Handle nested card structure - look for content area
    let contentArea = null;
    if (!tableBody) {
        // Check if this is a group with no alerts (showing the alert div)
        // Look in both the main card and any nested cards
        const alertDiv = card.querySelector('.alert.alert-info');
        
        if (alertDiv && data.alerts && data.alerts.length > 0) {
            // We have alerts to show but no table structure - need to create it
            console.log('Creating table structure for group with new alerts');
            
            // Find the appropriate container - could be nested
            contentArea = alertDiv.closest('.card-body');
            
            // If we're in a nested card structure, we might need to replace the entire nested card
            const nestedCard = alertDiv.closest('.card.mb-4');
            if (nestedCard && nestedCard !== card) {
                // We're in a nested card, replace its content with simple table structure
                nestedCard.innerHTML = `
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <div class="bulk-actions" id="bulkActions_${groupId}" style="display: none;">
                            <div class="d-flex align-items-center gap-3">
                                <label class="form-check-label">
                                    <input type="checkbox" class="select-all-checkbox me-2" 
                                           onchange="toggleSelectAll(this, '${groupId}')">
                                    Select All
                                </label>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="analyzeSelectedArticles('${data.topic}', '${groupId}')">
                                    <i class="fas fa-microscope"></i> Analyze Selected
                                </button>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="bulkMarkAsRead('${groupId}')">
                                    <i class="fas fa-check"></i> Mark Selected as Read
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="bulkDeleteSelected('${groupId}')">
                                    <i class="fas fa-trash"></i> Delete Selected
                                </button>
                                <span class="text-muted" id="selectedInfo_${groupId}">0 selected</span>
                            </div>
                        </div>
                        
                        <table class="table table-hover align-middle mb-0" id="articlesTable_${groupId}" data-dynamically-loaded="true">
                            <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                <tr>
                                    <th style="width: 50px; min-width: 50px;">
                                        <input type="checkbox" class="select-all-checkbox" 
                                               onchange="toggleSelectAll(this, '${groupId}')">
                                    </th>
                                    <th style="width: 80px; min-width: 60px;" class="sortable-header" data-sort="status" data-group-id="${groupId}">
                                        Status <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 30%; min-width: 280px;" class="sortable-header" data-sort="title" data-group-id="${groupId}">
                                        Article <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 15%; min-width: 120px;" class="sortable-header" data-sort="source" data-group-id="${groupId}">
                                        Source <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 12%; min-width: 100px;" class="sortable-header" data-sort="detected" data-group-id="${groupId}">
                                        Detected <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 13%; min-width: 100px;">Tags</th>
                                    <th style="width: 12%; min-width: 100px;" class="sortable-header" data-sort="relevance" data-group-id="${groupId}">
                                        Relevance <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 25%; min-width: 200px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Now find the tbody we just created
                tableBody = nestedCard.querySelector('tbody');
                contentArea = nestedCard;
            } else if (contentArea) {
                // Replace content in the card body with simple table structure
                contentArea.innerHTML = `
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <div class="bulk-actions" id="bulkActions_${groupId}" style="display: none;">
                            <div class="d-flex align-items-center gap-3">
                                <label class="form-check-label">
                                    <input type="checkbox" class="select-all-checkbox me-2" 
                                           onchange="toggleSelectAll(this, '${groupId}')">
                                    Select All
                                </label>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="analyzeSelectedArticles('${data.topic}', '${groupId}')">
                                    <i class="fas fa-microscope"></i> Analyze Selected
                                </button>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="bulkMarkAsRead('${groupId}')">
                                    <i class="fas fa-check"></i> Mark Selected as Read
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="bulkDeleteSelected('${groupId}')">
                                    <i class="fas fa-trash"></i> Delete Selected
                                </button>
                                <span class="text-muted" id="selectedInfo_${groupId}">0 selected</span>
                            </div>
                        </div>
                        
                        <table class="table table-hover align-middle mb-0" id="articlesTable_${groupId}" data-dynamically-loaded="true">
                            <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                <tr>
                                    <th style="width: 50px; min-width: 50px;">
                                        <input type="checkbox" class="select-all-checkbox" 
                                               onchange="toggleSelectAll(this, '${groupId}')">
                                    </th>
                                    <th style="width: 80px; min-width: 60px;" class="sortable-header" data-sort="status" data-group-id="${groupId}">
                                        Status <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 30%; min-width: 280px;" class="sortable-header" data-sort="title" data-group-id="${groupId}">
                                        Article <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 15%; min-width: 120px;" class="sortable-header" data-sort="source" data-group-id="${groupId}">
                                        Source <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 12%; min-width: 100px;" class="sortable-header" data-sort="detected" data-group-id="${groupId}">
                                        Detected <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 13%; min-width: 100px;">Tags</th>
                                    <th style="width: 12%; min-width: 100px;" class="sortable-header" data-sort="relevance" data-group-id="${groupId}">
                                        Relevance <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 25%; min-width: 200px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Now find the tbody we just created
                tableBody = contentArea.querySelector('tbody');
            }
        } else if (alertDiv && (!data.alerts || data.alerts.length === 0)) {
            // No alerts and we have the alert div - this is expected, just return without error
            console.log('No alerts for group, keeping the "no alerts" message');
            
            // Update count in the group panel
            const alertCountBadge = card.querySelector('.badge.bg-primary');
            if (alertCountBadge) {
                alertCountBadge.textContent = `0 alerts`;
            }
            
            // Update count in trend dashboard
            const trendRow = document.querySelector(`tr[data-topic="${data.topic}"]`);
            if (trendRow) {
                const trendCountBadge = trendRow.querySelector('td:nth-child(5) .badge.bg-primary');
                if (trendCountBadge) {
                    trendCountBadge.textContent = `0 alerts`;
                }
            }
            
            // Update the total count in toggle label
            const totalCount = card.querySelector('.total-count');
            if (totalCount) {
                totalCount.textContent = data.total_count || 0;
            }
            
            return; // Exit early - no need to process further
        }
        
        if (!tableBody) {
            console.error('Table body not found in card:', card);
            console.error('Available elements:', card.querySelectorAll('*'));
            console.error('Alert div found:', card.querySelector('.alert.alert-info'));
            console.error('Data alerts length:', data.alerts ? data.alerts.length : 'undefined');
            
            // Last resort: try to reload the page if we can't update the structure
            if (data.alerts && data.alerts.length > 0) {
                showAlert('Unable to update group display. Reloading page to show new articles...', 'info');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                // Don't show error for groups with no alerts
                console.log('No table structure needed - group has no alerts');
            }
        return;
        }
    }
    
    // Update count in the group panel
    const alertCountBadge = card.querySelector('.badge.bg-primary');
    if (alertCountBadge) {
        alertCountBadge.textContent = `${data.unread_count} alerts`;
    }
    
    // Update count in trend dashboard (but not the status badge)
    const trendRow = document.querySelector(`tr[data-topic="${data.topic}"]`);
    if (trendRow) {
        // Find the size column badge specifically (not the status badge)
        const trendCountBadge = trendRow.querySelector('td:nth-child(5) .badge.bg-primary');
        if (trendCountBadge) {
            trendCountBadge.textContent = `${data.unread_count} alerts`;
        }
    }
    
    // Generate alerts HTML
    let html = '';
    for (const alert of data.alerts) {

        
        // Process keywords for this alert
        let keywordBadges = '';
        
        // Debug logging for keywords
        if (alert.article.title && alert.article.title.includes("AI Uncertainty")) {
            console.log('DEBUG: Keywords for AI Uncertainty article:', {
                matched_keyword: alert.matched_keyword,
                matched_keywords: alert.matched_keywords
            });
        }
        
        if (alert.matched_keyword) {
            keywordBadges += `<span class="badge bg-info" title="${alert.matched_keyword}">
                <i class="fas fa-tag me-1"></i>${alert.matched_keyword.length > 10 ? alert.matched_keyword.substring(0, 10) + '...' : alert.matched_keyword}
            </span>`;
        }
        
        // Process additional keywords if available
        if (alert.matched_keywords && Array.isArray(alert.matched_keywords)) {
            alert.matched_keywords.forEach(keyword => {
                if (keyword && keyword !== alert.matched_keyword) {
                    keywordBadges += `<span class="badge bg-info ms-1" title="${keyword}">
                        <i class="fas fa-tag me-1"></i>${keyword.length > 10 ? keyword.substring(0, 10) + '...' : keyword}
                    </span>`;
                }
            });
        }
        
        // Create media bias badges if available
        let mediaBiasHtml = '';
        
        if (alert.article.bias || alert.article.factual_reporting) {
            // First try using the global function if it exists
            if (typeof window.createMediaBiasDisplay === 'function') {
                mediaBiasHtml = window.createMediaBiasDisplay(alert.article);
            }
        }
        
        html += `
            <tr class="${alert.is_read ? 'text-muted bg-light' : ''}"
                data-alert-id="${alert.id}" data-group-id="${groupId}"
                data-bias="${alert.article.bias || ''}"
                data-factual-reporting="${alert.article.factual_reporting || ''}"
                data-credibility-rating="${alert.article.mbfc_credibility_rating || ''}"
                data-bias-country="${alert.article.bias_country || ''}"
                data-press-freedom="${alert.article.press_freedom || ''}"
                data-media-type="${alert.article.media_type || ''}"
                data-popularity="${alert.article.popularity || ''}">
                <td>
                    <input type="checkbox" class="article-checkbox" 
                           data-alert-id="${alert.id}"
                           data-group-id="${groupId}"
                           onchange="updateBulkActions('${groupId}')">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        ${(() => {
                            // Debug logging for specific articles
                            if (alert.article.title && alert.article.title.includes("AI Uncertainty")) {
                                console.log('DEBUG: AI Uncertainty article in updateGroupAlerts:', {
                                    alertId: alert.id,
                                    article: alert.article,
                                    hasCategory: !!alert.article.category,
                                    hasSentiment: !!alert.article.sentiment,
                                    hasDriverType: !!alert.article.driver_type,
                                    hasTimeToImpact: !!alert.article.time_to_impact,
                                    isEnriched: isArticleEnriched(alert.article)
                                });
                            }
                            
                            if (alert.is_read) {
                                return '<span class="badge bg-secondary">Read</span>';
                            } else if (isArticleEnriched(alert.article)) {
                                console.log('updateGroupAlerts: Setting badge to Added for:', alert.article.title?.substring(0, 50) + '...', {
                                    category: alert.article.category,
                                    isEnriched: isArticleEnriched(alert.article)
                                });
                                return '<span class="badge bg-success">Added</span>';
                            } else {
                                console.log('updateGroupAlerts: Setting badge to New for:', alert.article.title?.substring(0, 50) + '...', {
                                    category: alert.article.category,
                                    isEnriched: isArticleEnriched(alert.article)
                                });
                                return '<span class="badge bg-primary">New</span>';
                            }
                        })()}
                    </div>
                </td>
                <td>
                    <div class="article-content d-flex flex-column">
                        <div class="mb-1">
                            <div class="d-flex gap-2 align-items-start">
                                <a href="${alert.article.url}" target="_blank" class="article-title">${alert.article.title}</a>
                            </div>
                            <p class="text-muted mb-0 small article-summary">${alert.article.summary}</p>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="source-info small">
                        <div class="source-name">${alert.article.source}</div>
                        <div class="text-muted">
                            ${new Date(alert.article.publication_date).toLocaleString()}
                        </div>
                        ${mediaBiasHtml}
                    </div>
                </td>
                <td style="width: 15%; min-width: 120px;">
                    <div class="small">
                        <div>${alert.article.publication_date || 'Unknown'}</div>
                        <div class="text-muted">Published</div>
                    </div>
                    <div class="small mt-1">
                        <div>${new Date(alert.detected_at).toLocaleString()}</div>
                        <div class="text-muted">Detected</div>
                    </div>
                </td>
                <td>
                    <div class="tags-column">
                        ${keywordBadges}
                    </div>
                </td>
                <td>
                    <div class="relevance-column" data-article-uri="${alert.article.url}">
                        ${(() => {
                            if (alert.article.topic_alignment_score !== null && alert.article.topic_alignment_score !== undefined) {
                                const topicScore = alert.article.topic_alignment_score.toFixed(2);
                                const keywordScore = (alert.article.keyword_relevance_score || 0).toFixed(2);
                                const confidenceScore = (alert.article.confidence_score || 0).toFixed(2);
                                const explanation = alert.article.overall_match_explanation || '';
                                
                                let title = `Topic: ${topicScore} | Keywords: ${keywordScore} | Confidence: ${confidenceScore}`;
                                if (explanation) {
                                    title += ` | ${explanation}`;
                                }
                                
                                let html = `<div class="relevance-scores" title="${title}">
                                    <div class="score-item">
                                        <i class="fas fa-bullseye" style="color: #0dcaf0;"></i>
                                        <span>${topicScore}</span>
                                    </div>
                                    <div class="score-item">
                                        <i class="fas fa-key" style="color: #198754;"></i>
                                        <span>${keywordScore}</span>
                                    </div>`;
                                
                                if (alert.article.confidence_score !== null && alert.article.confidence_score !== undefined) {
                                    html += `<div class="score-item">
                                        <i class="fas fa-chart-line" style="color: #fd7e14;"></i>
                                        <span>${confidenceScore}</span>
                                    </div>`;
                                }
                                
                                html += '</div>';
                                return html;
                            } else {
                                return '<span class="text-muted small">Not analyzed</span>';
                            }
                        })()}
                    </div>
                </td>
                <td>
                    <div class="action-buttons d-flex flex-column gap-1">
                        <div class="d-flex gap-1">
                            ${!alert.is_read ? 
                                `<button class="btn btn-sm btn-outline-success" 
                                         onclick="markAsRead('${alert.id}')"
                                         data-topic="${data.topic}"
                                         data-group-id="${groupId}"
                                         title="Mark as read">
                                    <i class="fas fa-check"></i>
                                </button>` : 
                                `<button class="btn btn-sm btn-outline-secondary" 
                                         onclick="markAsUnread('${alert.id}')"
                                         title="Mark as unread">
                                    <i class="fas fa-undo"></i>
                                </button>`}
                            <button class="btn btn-sm btn-outline-primary analyze-single-article-btn" 
                                    data-article-url="${alert.article.url}"
                                    data-article-title="${alert.article.title || ''}"
                                    data-article-source="${alert.article.source || ''}"
                                    data-article-topic="${data.topic}"
                                    data-article-summary="${alert.article.summary || ''}"
                                    title="Analyze article">
                                <i class="fas fa-microscope"></i>
                            </button>
                        </div>
                        <div class="d-flex gap-1">
                            <a href="https://12ft.io/${alert.article.url}" 
                               class="btn btn-sm btn-outline-secondary"
                               title="Bypass Paywall" 
                               target="_blank">
                                <i class="fas fa-unlock"></i>
                            </a>
                            <a href="https://archive.is/${alert.article.url}" 
                               class="btn btn-sm btn-outline-secondary"
                               title="Archive" 
                               target="_blank">
                                <i class="fas fa-archive"></i>
                            </a>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    }
    
    // If there are no alerts, show the "no alerts" message
    if (data.alerts.length === 0) {
        // Handle nested card structure
        const nestedCard = card.querySelector('.card.mb-4');
        if (nestedCard) {
            // Replace the nested card content
            nestedCard.innerHTML = `
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i> No new alerts for this group
                    </div>
                </div>
            `;
        } else {
            // Fallback to card body
            const cardBody = tableBody.closest('.card-body') || card.querySelector('.card-body');
            if (cardBody) {
                cardBody.innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i> No new alerts for this group
                    </div>
                `;
            }
        }
    } else {
        tableBody.innerHTML = html;
        
        // Mark this table as dynamically loaded so media bias enhancement knows to update status badges
        const table = tableBody.closest('table');
        if (table) {
            table.dataset.dynamicallyLoaded = 'true';
        }
        
        // Add pagination controls if we have pagination data
        if (data.pagination && data.pagination.total_pages > 1) {
            const tableContainer = tableBody.closest('.table-responsive') || tableBody.closest('div');
            
            // Remove existing pagination if any
            const existingPagination = tableContainer.querySelector('.pagination-controls');
            if (existingPagination) {
                existingPagination.remove();
            }
            
            // Create pagination controls
            const paginationHtml = `
                <div class="pagination-controls d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded">
                    <div class="pagination-info">
                        <span class="text-muted">
                            Page ${data.pagination.page} of ${data.pagination.total_pages}
                            (${data.total_count} total alerts)
                        </span>
                    </div>
                    <nav aria-label="Alert pagination">
                        <ul class="pagination mb-0">
                            <li class="page-item ${!data.pagination.has_prev ? 'disabled' : ''}">
                                <a class="page-link" href="#" 
                                   onclick="changePage('${data.topic}', ${groupId}, ${data.pagination.page - 1}); return false;"
                                   ${!data.pagination.has_prev ? 'tabindex="-1" aria-disabled="true"' : ''}>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>
                            ${generatePageNumbers(data.pagination.page, data.pagination.total_pages, data.topic, groupId)}
                            <li class="page-item ${!data.pagination.has_next ? 'disabled' : ''}">
                                <a class="page-link" href="#" 
                                   onclick="changePage('${data.topic}', ${groupId}, ${data.pagination.page + 1}); return false;"
                                   ${!data.pagination.has_next ? 'tabindex="-1" aria-disabled="true"' : ''}>
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    <div class="page-size-selector">
                        <label class="me-2 mb-0">Show:</label>
                        <select class="form-select form-select-sm" style="width: auto; display: inline-block;"
                                onchange="changePageSize('${data.topic}', ${groupId}, this.value)">
                            <option value="25" ${data.pagination.page_size === 25 ? 'selected' : ''}>25</option>
                            <option value="50" ${data.pagination.page_size === 50 ? 'selected' : ''}>50</option>
                            <option value="100" ${data.pagination.page_size === 100 ? 'selected' : ''}>100</option>
                            <option value="200" ${data.pagination.page_size === 200 ? 'selected' : ''}>200</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Insert pagination after the table
            tableContainer.insertAdjacentHTML('beforeend', paginationHtml);
        }
    }
    
    // Update the total count in toggle label
    const totalCount = card.querySelector('.total-count');
    if (totalCount) {
        totalCount.textContent = data.total_count;
    }
    
    // Update bulk action buttons only if we have alerts
    if (data.alerts.length > 0) {
    updateBulkButtons(data.topic, groupId);
    }
}

// Update markAsUnread to pass the correct showRead state
async function markAsUnread(alertId) {
    try {
        const response = await fetch(`/api/keyword-monitor/alerts/${alertId}/unread`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        
        if (!response.ok) throw new Error('Failed to mark alert as unread');
        
        const alertElement = document.querySelector(`[onclick*="${alertId}"]`);
        const groupElement = alertElement.closest('.card');
        const buttonContainer = groupElement.querySelector('.d-flex[data-group-id]');
        const topic = alertElement.dataset.topic;
        const groupId = buttonContainer.dataset.groupId;
        const toggle = document.querySelector(`#showReadToggle_${groupId}`);
        
        await refreshGroupArticles(topic, groupId, toggle.checked);
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to mark alert as unread', 'danger');
    }
}

$(document).ready(function() {
    // Fetch monitor status on page load
    fetchMonitorStatus();
    
    // Set interval to refresh status every 30 seconds
    setInterval(fetchMonitorStatus, 30000);
    
    // Initialize table sorting
    initializeTableSorting();
    
    // Enhance articles with media bias on initial load - but don't override template status badges
    // Only enhance media bias info, not status badges
    setTimeout(() => {
        console.log('Running media bias enhancement on initial page load...');
        enhanceAllArticlesWithMediaBias();
    }, 1000);
    
    // Set up event listeners for show/hide read toggles
    document.querySelectorAll('.show-read-toggle').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const topic = this.dataset.topic;
            const groupId = this.dataset.groupId;
            const showRead = this.checked;
            
            // Refresh group articles and enhance with media bias
            refreshGroupArticles(topic, groupId, showRead).then(() => {
                setTimeout(enhanceAllArticlesWithMediaBias, 500);
            });
        });
    });
    
    // Set up event listener for single article analysis buttons
    document.addEventListener('click', function(event) {
        if (event.target.closest('.analyze-single-article-btn')) {
            const button = event.target.closest('.analyze-single-article-btn');
            const article = {
                url: button.dataset.articleUrl,
                title: button.dataset.articleTitle,
                source: button.dataset.articleSource,
                summary: button.dataset.articleSummary
            };
            const topic = button.dataset.articleTopic;
            
            analyzeSingleArticle(article, topic);
        }
        
        // Handle update group buttons
        if (event.target.closest('.update-group-btn')) {
            const button = event.target.closest('.update-group-btn');
            const topic = button.dataset.topic;
            const groupId = button.dataset.groupId;
            updateGroupNow(topic, groupId);
        }
        
        // Handle export group buttons
        if (event.target.closest('.export-group-btn')) {
            const button = event.target.closest('.export-group-btn');
            const topic = button.dataset.topic;
            const groupId = button.dataset.groupId;
            exportGroupAlerts(topic, groupId);
        }
    });
    
    // Initialize other components here...
});

// Function to analyze a single article
function analyzeSingleArticle(article, topic) {
    const articles = [article];
    openArticleAnalysisModal(articles, topic, null);
}

function fetchMonitorStatus() {
    fetch('/api/keyword-monitor/status', {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            // Update next check time in the header
            updateStatusDisplay(data);
        })
        .catch(error => {
            console.error("Error fetching monitor status:", error);
        });
}

function updateStatusDisplay(data) {
    const bgTask = data.background_task;
    const settings = data.settings;
    
    // Update last check time
    if (bgTask.last_check_time) {
        const lastCheckElem = document.querySelector('.fas.fa-clock').parentElement;
        if (lastCheckElem) {
            // Format consistently with next check time
            const lastCheck = new Date(bgTask.last_check_time);
            const now = new Date();
            const diffMs = now - lastCheck;
            
            if (diffMs < 60000) { // Less than a minute
                lastCheckElem.innerHTML = `<i class="fas fa-clock"></i> Last check: Less than a minute ago`;
            } else if (diffMs < 3600000) { // Less than an hour
                const minutes = Math.floor(diffMs / 60000);
                lastCheckElem.innerHTML = `<i class="fas fa-clock"></i> Last check: ${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else {
                const hours = Math.floor(diffMs / 3600000);
                lastCheckElem.innerHTML = `<i class="fas fa-clock"></i> Last check: ${hours} hour${hours > 1 ? 's' : ''} ago`;
            }
        }
    }
    
    // Update next check time (keep the minutes format since it's more precise for upcoming events)
    if (bgTask.next_check_time) {
        const nextCheckElem = document.querySelector('.fas.fa-hourglass-half').parentElement;
        if (nextCheckElem) {
            const now = new Date();
            const nextCheck = new Date(bgTask.next_check_time);
            
            if (settings.is_enabled) {
                if (nextCheck <= now) {
                    nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Checking soon...`;
                } else {
                    const timeDiff = nextCheck - now;
                    if (timeDiff <= 60000) { // Less than a minute
                        nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Next check: In less than a minute`;
                    } else if (timeDiff < 3600000) { // Less than an hour
                        const minutes = Math.floor(timeDiff / 60000);
                        nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Next check: In ${minutes} minute${minutes > 1 ? 's' : ''}`;
                    } else {
                        const hours = Math.floor(timeDiff / 3600000);
                        nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Next check: In ${hours} hour${hours > 1 ? 's' : ''}`;
                    }
                }
            } else {
                nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Polling disabled`;
            }
        }
    }
    
    // Update error message if there is one
    if (bgTask.last_error) {
        const lastErrorElem = document.querySelector('.fas.fa-exclamation-circle')?.parentElement;
        if (lastErrorElem) {
            lastErrorElem.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${bgTask.last_error}`;
            lastErrorElem.style.display = 'inline-flex';
        }
    } else {
        const lastErrorElem = document.querySelector('.fas.fa-exclamation-circle')?.parentElement;
        if (lastErrorElem) {
            lastErrorElem.style.display = 'none';
        }
    }
    
    // Update polling toggle status
    const pollingToggle = document.getElementById('pollingToggle');
    if (pollingToggle) {
        pollingToggle.checked = settings.is_enabled;
        const label = document.querySelector('label[for="pollingToggle"]');
        if (label) {
            label.textContent = `Auto-polling ${settings.is_enabled ? 'enabled' : 'disabled'}`;
        }
    }
    
    // Update API usage
    if (data.api_usage) {
        const resetTimer = document.getElementById('resetTimer');
        const rateLimitWarning = document.getElementById('rateLimitWarning');
        
        if (resetTimer) {
            const percentage = (data.api_usage.requests_today / data.api_usage.limit) * 100;
            resetTimer.innerHTML = `<i class="fas fa-refresh"></i> API usage: ${data.api_usage.requests_today}/${data.api_usage.limit}`;
            
            if (percentage >= 100) {
                resetTimer.classList.add('text-danger');
                resetTimer.classList.remove('text-warning', 'text-muted');
                
                // Show rate limit warning
                if (rateLimitWarning) {
                    rateLimitWarning.style.display = 'inline';
                }
            } else if (percentage >= 80) {
                resetTimer.classList.add('text-warning');
                resetTimer.classList.remove('text-danger', 'text-muted');
                
                // Hide rate limit warning
                if (rateLimitWarning) {
                    rateLimitWarning.style.display = 'none';
                }
            } else {
                resetTimer.classList.add('text-muted');
                resetTimer.classList.remove('text-danger', 'text-warning');
                
                // Hide rate limit warning
                if (rateLimitWarning) {
                    rateLimitWarning.style.display = 'none';
                }
            }
        }
    }
}

// Update the reset timer function to properly display when API usage will reset
function updateResetTimer() {
    // Get current time in UTC/GMT
    const now = new Date();
    
    // Create tomorrow's date at midnight UTC (when API counter resets)
    const tomorrow = new Date(now);
    tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);
    tomorrow.setUTCHours(0, 0, 0, 0);
    
    const timeUntilReset = tomorrow - now;
    const hours = Math.floor(timeUntilReset / (1000 * 60 * 60));
    const minutes = Math.floor((timeUntilReset % (1000 * 60 * 60)) / (1000 * 60));
    
    const resetTimer = document.getElementById('resetTimer');
    if (resetTimer) {
        // Get current API usage if available
        const usageText = resetTimer.dataset.usage || '';
        resetTimer.innerHTML = `<i class="fas fa-refresh"></i> ${usageText} (Resets in ${hours}h ${minutes}m)`;
        
        // Update color based on API usage status
        if (resetTimer.dataset.status === 'danger') {
            resetTimer.classList.add('text-danger');
        } else if (resetTimer.dataset.status === 'warning') {
            resetTimer.classList.add('text-warning');
        } else {
            resetTimer.classList.remove('text-danger', 'text-warning');
        }
    }
}

// Fetch current API usage periodically
function fetchApiUsage() {
    fetch('/api/keyword-monitor/status', {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            if (data.api_usage) {
                const resetTimer = document.getElementById('resetTimer');
                if (resetTimer) {
                    const usage = data.api_usage.requests_today;
                    const limit = data.api_usage.limit;
                    const percentage = (usage / limit) * 100;
                    
                    // Store the usage text for the reset timer
                    resetTimer.dataset.usage = `API usage: ${usage}/${limit}`;
                    
                    // Update status for coloring
                    if (percentage >= 100) {
                        resetTimer.dataset.status = 'danger';
                    } else if (percentage >= 80) {
                        resetTimer.dataset.status = 'warning';
                    } else {
                        resetTimer.dataset.status = 'normal';
                    }
                    
                    // Update the timer display
                    updateResetTimer();
                }
            }
        })
        .catch(error => console.error('Error fetching API usage:', error));
}

// Function to manually reset the API counter
async function resetApiCounter() {
    if (!confirm("Are you sure you want to manually reset the API counter? This should only be needed if the automatic daily reset isn't working.")) {
            return;
        }
        
    try {
        const response = await fetch('/api/keyword-monitor/reset-api-counter', {
            method: 'POST',
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error('Failed to reset API counter');
        }
        
        const result = await response.json();
        showAlert(`API counter reset successfully: ${result.message}`, 'success');
        
        // Refresh the API usage display
        fetchApiUsage();
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to reset API counter: ' + error.message, 'danger');
    }
}

// Handle smooth scrolling to keyword groups when manage links are clicked
document.addEventListener('DOMContentLoaded', function() {
    // Check if there's a hash in the URL for group navigation
    if (window.location.hash && window.location.hash.startsWith('#group-')) {
        const groupId = window.location.hash.substring(7); // Remove '#group-'
        const groupElement = document.getElementById(`group-${groupId}`);
        if (groupElement) {
            setTimeout(() => {
                groupElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Add a highlight effect
                groupElement.style.boxShadow = '0 0 20px rgba(255, 105, 180, 0.5)';
                setTimeout(() => {
                    groupElement.style.boxShadow = '';
                }, 3000);
            }, 500);
        }
    }
    
    // Enhanced tooltip system for better multi-screen support
    initializeTooltips();
});

// Initialize enhanced tooltip system
function initializeTooltips() {
    // Disabled - using native browser tooltips for reliability
    return;
    
    // ... existing tooltip code (keep but disabled) ...
}

// Comment out the tooltip initialization in DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    // Enhanced tooltip system for better multi-screen support
    // initializeTooltips();  // Commented out - using native tooltips
});

// Add custom date formatting
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

// Clean publication date by extracting only the date portion
function cleanPublicationDate(dateStr) {
    if (!dateStr) return "";
    
    // If it's already a clean date format, return as is
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr.trim())) {
        return dateStr.trim();
    }
    
    // Extract ISO date format (YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS)
    const isoMatch = dateStr.match(/(\d{4}-\d{2}-\d{2})(?:T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+-]\d{2}:\d{2})?)?/);
    if (isoMatch) {
        return isoMatch[1];
    }
    
    // Extract DD/MM/YYYY format
    const dateMatch = dateStr.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
    if (dateMatch) {
        // Convert DD/MM/YYYY to YYYY-MM-DD
        const dateParts = dateMatch[1].split('/');
        if (dateParts.length === 3) {
            const [day, month, year] = dateParts;
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
    }
    
    // Extract MM-DD-YYYY or MM/DD/YYYY format
    const usDateMatch = dateStr.match(/(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})/);
    if (usDateMatch) {
        const dateParts = usDateMatch[1].split(/[-\/]/);
        if (dateParts.length === 3) {
            const [month, day, year] = dateParts;
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
    }
    
    // If we can't parse it cleanly, return empty string
    return "";
}

// Relevance filtering functions
function getRelevanceLabel(value) {
    if (value <= 0.01) return 'All';
    if (value <= 0.25) return 'No relevance';
    if (value <= 0.5) return 'Adjacent';
    if (value <= 0.75) return 'Somewhat related';
    return 'Strongly related';
}

function getMainRelevanceLabel(value) {
    if (value <= 0.01) return 'All';
    if (value <= 0.3) return 'Low relevance';
    if (value <= 0.6) return 'Medium relevance';
    return 'High relevance';
}

function getRelevanceColor(value) {
    if (value <= 0.25) return '#dc3545'; // Red
    if (value <= 0.5) return '#ffc107';  // Yellow
    if (value <= 0.75) return '#28a745'; // Green
    return '#007bff'; // Blue
}

// Toggle advanced filters visibility
function toggleAdvancedFilters(groupId) {
    const advancedFilters = document.getElementById(`advancedFilters_${groupId}`);
    const toggleButton = document.getElementById(`advancedToggle_${groupId}`);
    
    if (advancedFilters.style.display === 'none') {
        advancedFilters.style.display = 'block';
        toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i> Simple';
        toggleButton.title = 'Hide advanced filters';
        
        // Disable main slider when advanced mode is active
        const mainSlider = document.getElementById(`mainRelevanceSlider_${groupId}`);
        if (mainSlider) {
            mainSlider.disabled = true;
            mainSlider.style.opacity = '0.5';
        }
    } else {
        advancedFilters.style.display = 'none';
        toggleButton.innerHTML = '<i class="fas fa-cog"></i> Advanced';
        toggleButton.title = 'Show advanced filters';
        
        // Re-enable main slider
        const mainSlider = document.getElementById(`mainRelevanceSlider_${groupId}`);
        if (mainSlider) {
            mainSlider.disabled = false;
            mainSlider.style.opacity = '1';
        }
        
        // Reset advanced sliders and apply main filter
        resetAdvancedSliders(groupId);
        applyMainRelevanceFilter(groupId);
    }
}

// Apply main relevance filter (simplified combined filter)
function applyMainRelevanceFilter(groupId) {
    const mainSlider = document.getElementById(`mainRelevanceSlider_${groupId}`);
    const mainValue = document.getElementById(`mainRelevanceValue_${groupId}`);
    
    if (!mainSlider || !mainValue) return;
    
    const threshold = parseFloat(mainSlider.value);
    
    // Update value display
    mainValue.textContent = getMainRelevanceLabel(threshold);
    mainValue.style.color = getRelevanceColor(threshold);
    
    // Use unified filter function
    applyAllFilters(groupId);
}

// Reset advanced sliders only
function resetAdvancedSliders(groupId) {
    const topicSlider = document.getElementById(`topicSlider_${groupId}`);
    const keywordSlider = document.getElementById(`keywordSlider_${groupId}`);
    const confidenceSlider = document.getElementById(`confidenceSlider_${groupId}`);
    
    if (topicSlider) topicSlider.value = 0;
    if (keywordSlider) keywordSlider.value = 0;
    if (confidenceSlider) confidenceSlider.value = 0;
}

function applyRelevanceFilter(groupId) {
    const topicSlider = document.getElementById(`topicSlider_${groupId}`);
    const keywordSlider = document.getElementById(`keywordSlider_${groupId}`);
    const confidenceSlider = document.getElementById(`confidenceSlider_${groupId}`);
    const topicValue = document.getElementById(`topicValue_${groupId}`);
    const keywordValue = document.getElementById(`keywordValue_${groupId}`);
    const confidenceValue = document.getElementById(`confidenceValue_${groupId}`);
    
    const topicThreshold = parseFloat(topicSlider.value);
    const keywordThreshold = parseFloat(keywordSlider.value);
    const confidenceThreshold = parseFloat(confidenceSlider.value);
    
    // Update value displays
    topicValue.textContent = getRelevanceLabel(topicThreshold);
    topicValue.style.color = getRelevanceColor(topicThreshold);
    keywordValue.textContent = getRelevanceLabel(keywordThreshold);
    keywordValue.style.color = getRelevanceColor(keywordThreshold);
    confidenceValue.textContent = getRelevanceLabel(confidenceThreshold);
    confidenceValue.style.color = getRelevanceColor(confidenceThreshold);
    
    // Use unified filter function
    applyAllFilters(groupId);
}

function resetFilters(groupId) {
    const mainSlider = document.getElementById(`mainRelevanceSlider_${groupId}`);
    const topicSlider = document.getElementById(`topicSlider_${groupId}`);
    const keywordSlider = document.getElementById(`keywordSlider_${groupId}`);
    const confidenceSlider = document.getElementById(`confidenceSlider_${groupId}`);
    
    // Reset main slider
    if (mainSlider) mainSlider.value = 0;
    
    // Reset advanced sliders
    if (topicSlider) topicSlider.value = 0;
    if (keywordSlider) keywordSlider.value = 0;
    if (confidenceSlider) confidenceSlider.value = 0;
    
    // Reset status filter
    const statusAllRadio = document.getElementById(`statusAll_${groupId}`);
    if (statusAllRadio) statusAllRadio.checked = true;
    
    // Reset detoxify filter
    const detoxifyToggle = document.getElementById(`detoxifyToggle_${groupId}`);
    if (detoxifyToggle) detoxifyToggle.checked = false;
    
    // Apply filters
    applyAllFilters(groupId);
}

// Apply status filter
function applyStatusFilter(groupId) {
    applyAllFilters(groupId);
}

// Combined function to apply all filters (relevance + status + detoxify)
function applyAllFilters(groupId) {
    // Get status filter value
    const statusFilter = document.querySelector(`input[name="statusFilter_${groupId}"]:checked`)?.value || 'all';
    
    // Get detoxify filter value
    const detoxifyEnabled = document.getElementById(`detoxifyToggle_${groupId}`)?.checked || false;
    
    // Get relevance filter values
    const advancedFilters = document.getElementById(`advancedFilters_${groupId}`);
    const isAdvancedMode = advancedFilters && advancedFilters.style.display !== 'none';
    
    let relevanceThreshold = 0;
    let topicThreshold = 0;
    let keywordThreshold = 0;
    let confidenceThreshold = 0;
    
    if (isAdvancedMode) {
        topicThreshold = parseFloat(document.getElementById(`topicSlider_${groupId}`)?.value || 0);
        keywordThreshold = parseFloat(document.getElementById(`keywordSlider_${groupId}`)?.value || 0);
        confidenceThreshold = parseFloat(document.getElementById(`confidenceSlider_${groupId}`)?.value || 0);
    } else {
        relevanceThreshold = parseFloat(document.getElementById(`mainRelevanceSlider_${groupId}`)?.value || 0);
    }
    
    // Get all rows in this group's table
    const table = document.getElementById(`articlesTable_${groupId}`);
    if (!table) return;
    
    const rows = table.querySelectorAll('tbody tr[data-alert-id]');
    let visibleCount = 0;
    let totalCount = rows.length;
    
    rows.forEach(row => {
        let showRow = true;
        
        // Apply status filter
        if (statusFilter !== 'all') {
            const statusBadge = row.querySelector('.badge');
            const statusText = statusBadge ? statusBadge.textContent.trim().toLowerCase() : '';
            
            // Debug logging for status filtering
            if (statusFilter === 'new' && !statusText.includes('new')) {
                console.log('Filtering out article - status:', statusText, 'looking for: new');
                showRow = false;
            } else if (statusFilter === 'added' && !statusText.includes('added')) {
                console.log('Filtering out article - status:', statusText, 'looking for: added');
                showRow = false;
            }
        }
        
        // Apply detoxify filter (only if status filter passes)
        if (showRow && detoxifyEnabled) {
            const shouldDetoxify = isLowQualitySource(row);
            if (shouldDetoxify) {
                showRow = false;
            }
        }
        
        // Apply relevance filter (only if status filter passes)
        if (showRow && (relevanceThreshold > 0.01 || topicThreshold > 0.01 || keywordThreshold > 0.01 || confidenceThreshold > 0.01)) {
            const relevanceColumn = row.querySelector('.relevance-column');
            
            if (relevanceColumn) {
                const scoreItems = relevanceColumn.querySelectorAll('.score-item span');
                
                if (scoreItems.length >= 2) {
                    const topicScore = parseFloat(scoreItems[0].textContent) || 0;
                    const keywordScore = parseFloat(scoreItems[1].textContent) || 0;
                    const confidenceScore = scoreItems.length >= 3 ? parseFloat(scoreItems[2].textContent) || 0 : 0;
                    
                    if (isAdvancedMode) {
                        // Advanced mode: apply individual thresholds
                        if (topicThreshold > 0.01 && topicScore < topicThreshold) showRow = false;
                        if (keywordThreshold > 0.01 && keywordScore < keywordThreshold) showRow = false;
                        if (confidenceThreshold > 0.01 && confidenceScore < confidenceThreshold) showRow = false;
                    } else {
                        // Main mode: apply combined relevance
                        const combinedScore = (topicScore * 0.6) + (keywordScore * 0.4);
                        if (combinedScore < relevanceThreshold) showRow = false;
                    }
                } else if (relevanceThreshold > 0.01 || topicThreshold > 0.01 || keywordThreshold > 0.01 || confidenceThreshold > 0.01) {
                    showRow = false;
                }
            } else if (relevanceThreshold > 0.01 || topicThreshold > 0.01 || keywordThreshold > 0.01 || confidenceThreshold > 0.01) {
                showRow = false;
            }
        }
        
        if (showRow) {
            row.classList.remove('filtered-out');
            visibleCount++;
        } else {
            row.classList.add('filtered-out');
        }
    });
    
    // Update filter summary
    updateFilterSummary(groupId, visibleCount, totalCount, statusFilter, detoxifyEnabled, isAdvancedMode, relevanceThreshold, topicThreshold, keywordThreshold, confidenceThreshold);
    
    // Update bulk actions visibility
    updateBulkActions(groupId);
}

// Update filter summary with status, detoxify, and relevance info
function updateFilterSummary(groupId, visibleCount, totalCount, statusFilter, detoxifyEnabled, isAdvancedMode, relevanceThreshold, topicThreshold, keywordThreshold, confidenceThreshold) {
    const filterSummary = document.getElementById(`filterSummary_${groupId}`);
    if (!filterSummary) return;
    
    const activeFilters = [];
    
    // Add status filter info
    if (statusFilter === 'new') {
        activeFilters.push('New only');
    } else if (statusFilter === 'added') {
        activeFilters.push('Analyzed only');
    }
    
    // Add detoxify filter info
    if (detoxifyEnabled) {
        activeFilters.push('Detoxified');
    }
    
    // Add relevance filter info
    if (isAdvancedMode) {
        if (topicThreshold > 0.01) activeFilters.push('Topic');
        if (keywordThreshold > 0.01) activeFilters.push('Keyword');
        if (confidenceThreshold > 0.01) activeFilters.push('Confidence');
    } else if (relevanceThreshold > 0.01) {
        activeFilters.push(getMainRelevanceLabel(relevanceThreshold));
    }
    
    if (visibleCount === totalCount) {
        filterSummary.innerHTML = `<span class="badge bg-info small">${totalCount} articles</span>`;
    } else {
        let badgeHtml = `<span class="badge bg-warning small">${visibleCount} of ${totalCount} articles</span>`;
        badgeHtml += `<span class="badge bg-secondary ms-1 small">${totalCount - visibleCount} filtered out</span>`;
        
        if (activeFilters.length > 0) {
            badgeHtml += `<span class="badge bg-info ms-1 small">${activeFilters.join(', ')}</span>`;
        }
        
        filterSummary.innerHTML = badgeHtml;
    }
}

// Function to check if a source should be filtered out by detoxify
function isLowQualitySource(row) {
    // Check data attributes for bias and factual reporting info
    const bias = row.dataset.bias?.toLowerCase() || '';
    const factualReporting = row.dataset.factualReporting?.toLowerCase() || '';
    const credibilityRating = row.dataset.credibilityRating?.toLowerCase() || '';
    
    // Also check for bias badges in the source cell
    const sourceCell = row.querySelector('.source-info');
    const biasBadges = sourceCell ? sourceCell.querySelectorAll('.bias-badge') : [];
    
    let foundLowQuality = false;
    
    // Check bias for conspiracy theories and pseudoscience
    if (bias.includes('conspiracy') || bias.includes('pseudoscience') || 
        bias.includes('quackery') || bias.includes('junk news')) {
        foundLowQuality = true;
    }
    
    // Check factual reporting for low quality
    if (factualReporting.includes('low') || factualReporting.includes('very low') || 
        factualReporting.includes('mixed')) {
        foundLowQuality = true;
    }
    
    // Check credibility rating
    if (credibilityRating.includes('low')) {
        foundLowQuality = true;
    }
    
    // Check bias badges for low quality indicators
    biasBadges.forEach(badge => {
        const badgeText = badge.textContent.toLowerCase();
        const badgeClasses = badge.className;
        
        if (badgeClasses.includes('bias-conspiracy') || 
            badgeClasses.includes('bias-pseudoscience') ||
            badgeClasses.includes('bias-questionable') ||
            badgeClasses.includes('factual-low') ||
            badgeClasses.includes('factual-very-low') ||
            badgeClasses.includes('factual-mixed') ||
            badgeText.includes('conspiracy') ||
            badgeText.includes('pseudoscience') ||
            badgeText.includes('low') ||
            badgeText.includes('mixed')) {
            foundLowQuality = true;
        }
    });
    
    return foundLowQuality;
}

// Table sorting functions
let sortStates = {}; // Track sort state for each column

function initializeTableSorting() {
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', function() {
            const sortColumn = this.dataset.sort;
            const groupId = this.dataset.groupId;
            const table = document.getElementById(`articlesTable_${groupId}`);
            
            if (!table) return;
            
            // Toggle sort direction
            const currentState = sortStates[`${groupId}_${sortColumn}`] || 'none';
            let newState;
            
            if (currentState === 'none' || currentState === 'desc') {
                newState = 'asc';
            } else {
                newState = 'desc';
            }
            
            sortStates[`${groupId}_${sortColumn}`] = newState;
            
            // Update sort icons
            const allHeaders = table.querySelectorAll('.sortable-header');
            allHeaders.forEach(h => {
                const icon = h.querySelector('.sort-icon');
                if (h === this) {
                    icon.classList.remove('fas', 'fa-sort', 'fa-sort-up', 'fa-sort-down');
                    icon.classList.add('fas', newState === 'asc' ? 'fa-sort-up' : 'fa-sort-down', 'active');
                } else {
                    icon.classList.remove('fas', 'fa-sort-up', 'fa-sort-down', 'active');
                    icon.classList.add('fas', 'fa-sort');
                }
            });
            
            // Sort the table
            sortTable(table, sortColumn, newState);
        });
    });
}

function sortTable(table, column, direction) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr[data-alert-id]'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'status':
                aVal = a.querySelector('.badge').textContent.trim();
                bVal = b.querySelector('.badge').textContent.trim();
                // Custom order for status: New > Added > Read
                const statusOrder = { 'New': 3, 'Added': 2, 'Read': 1 };
                aVal = statusOrder[aVal] || 0;
                bVal = statusOrder[bVal] || 0;
                break;
                
            case 'title':
                aVal = a.querySelector('.article-title').textContent.trim().toLowerCase();
                bVal = b.querySelector('.article-title').textContent.trim().toLowerCase();
                break;
                
            case 'source':
                aVal = a.querySelector('.source-name').textContent.trim().toLowerCase();
                bVal = b.querySelector('.source-name').textContent.trim().toLowerCase();
                break;
                
            case 'detected':
                // Use the "Detected" timestamp (second date in the cell)
                const aDetectedDivs = a.querySelectorAll('td:nth-child(5) .small div:first-child');
                const bDetectedDivs = b.querySelectorAll('td:nth-child(5) .small div:first-child');
                aVal = aDetectedDivs.length > 1 ? new Date(aDetectedDivs[1].textContent.trim()) : new Date(0);
                bVal = bDetectedDivs.length > 1 ? new Date(bDetectedDivs[1].textContent.trim()) : new Date(0);
                break;
                
            case 'relevance':
                // Sort by topic alignment score (first score)
                const aRelevance = a.querySelector('.relevance-scores .score-item span');
                const bRelevance = b.querySelector('.relevance-scores .score-item span');
                aVal = aRelevance ? parseFloat(aRelevance.textContent) || 0 : -1;
                bVal = bRelevance ? parseFloat(bRelevance.textContent) || 0 : -1;
                break;
                
            default:
                return 0;
        }
        
        // Handle different data types
        if (typeof aVal === 'string' && typeof bVal === 'string') {
            return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
            if (direction === 'asc') {
                return aVal - bVal;
            } else {
                return bVal - aVal;
            }
        }
    });
    
    // Clear and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

// Initialize sorting when page loads
document.addEventListener('DOMContentLoaded', function() {
    // ... existing initialization code ...
    
    // Initialize table sorting
    initializeTableSorting();
    
    // Initialize relevance filters with main slider - just update display, don't apply filters
    document.querySelectorAll('[id^="mainRelevanceSlider_"]').forEach(mainSlider => {
        const groupId = mainSlider.dataset.groupId;
        // Just update the display value, don't apply filters on page load
        const mainValue = document.getElementById(`mainRelevanceValue_${groupId}`);
        if (mainValue) {
            mainValue.textContent = getMainRelevanceLabel(0);
            mainValue.style.color = getRelevanceColor(0);
        }
        
        // Initialize filter summary without applying filters
        const filterSummary = document.getElementById(`filterSummary_${groupId}`);
        if (filterSummary) {
            const table = document.getElementById(`articlesTable_${groupId}`);
            if (table) {
                // Ensure all articles are visible on page load (remove any filtered-out classes)
                const allRows = table.querySelectorAll('tbody tr[data-alert-id]');
                allRows.forEach(row => row.classList.remove('filtered-out'));
                
                const totalRows = allRows.length;
                filterSummary.innerHTML = `<span class="badge bg-info">${totalRows} articles</span>`;
                console.log(`Initialized group ${groupId} with ${totalRows} articles - all visible`);
            }
        }
    });
    
    // Initialize status filter event listeners
    document.querySelectorAll('.status-filter-group input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const groupId = this.closest('.status-filter-group').dataset.groupId;
                applyStatusFilter(groupId);
            }
        });
    });
    
    // Initialize detoxify filter event listeners
    document.querySelectorAll('input[id^="detoxifyToggle_"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const groupId = this.dataset.groupId;
            applyAllFilters(groupId);
        });
    });
});

// Global variable to store articles being analyzed
let currentAnalysisArticles = [];
let currentAnalysisResults = [];

// Function to open the article analysis modal
function openArticleAnalysisModal(articles, topic, groupId) {
    currentAnalysisArticles = articles;
    
    // Load topics and models for the modal
    loadModalTopics(topic);
    loadModalModels();
    
    // Populate selected articles list
    populateSelectedArticlesList(articles);
    
    // Set the topic
    setTimeout(() => {
        document.getElementById('analysisTopicSelect').value = topic;
    }, 500);
    
    // Reset modal state
    resetModalState();
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('articleAnalysisModal'));
    modal.show();
}

// Function to populate the selected articles list in the modal
function populateSelectedArticlesList(articles) {
    const listContainer = document.getElementById('selectedArticlesList');
    const countElement = document.getElementById('selectedArticlesCount');
    
    countElement.textContent = articles.length;
    listContainer.innerHTML = '';
    
    articles.forEach((article, index) => {
        const listItem = document.createElement('div');
        listItem.className = 'list-group-item';
        listItem.dataset.articleIndex = index;
        listItem.innerHTML = `
            <div class="article-item-content">
                <h6 class="mb-1">${article.title || 'Untitled'}</h6>
                <p class="mb-1 small text-muted">${article.source || 'Unknown Source'}</p>
                <small class="text-muted">${article.url}</small>
            </div>
            <div class="article-item-actions">
                <span class="badge bg-primary me-2">#${index + 1}</span>
                <button class="btn btn-outline-danger btn-sm" onclick="removeSelectedArticle(${index})" title="Remove article">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        listContainer.appendChild(listItem);
    });
}

// Function to load topics for the modal
async function loadModalTopics(selectedTopic = '') {
    try {
        const response = await fetch('/api/topics');
        const topics = await response.json();
        const topicSelect = document.getElementById('analysisTopicSelect');
        
        topicSelect.innerHTML = '<option value="">Select a topic</option>';
        topics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic.name;
            option.textContent = topic.name;
            if (topic.name === selectedTopic) {
                option.selected = true;
            }
            topicSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading topics for modal:', error);
    }
}

// Function to load models for the modal
async function loadModalModels() {
    console.log(' loadModalModels called');
    try {
        console.log(' Fetching models for modal from /api/available_models');
        const response = await fetch('/api/available_models');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const models = await response.json();
        console.log(' Modal models received:', models);
        const modelSelect = document.getElementById('analysisModelSelect');
        console.log(' Analysis model select element:', modelSelect);
        
        if (modelSelect) {
            if (models.length === 0) {
                console.warn(' No models found for modal');
                modelSelect.innerHTML = '<option value="">No models configured</option>';
            } else {
                console.log(` Loading ${models.length} models into analysis modal dropdown`);
                modelSelect.innerHTML = '<option value="">Select a model...</option>';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.provider})`;
                    
                    // Add data attributes for additional info
                    if (model.provider) {
                        option.dataset.provider = model.provider;
                    }
                    
                    modelSelect.appendChild(option);
                    console.log(` Added modal model: ${model.name} (${model.provider})`);
                });
                console.log(' Successfully loaded models into analysis modal dropdown');
            }
        } else {
            console.error(' analysisModelSelect element not found in DOM');
        }
    } catch (error) {
        console.error(' Error loading models for modal:', error);
        const modelSelect = document.getElementById('analysisModelSelect');
        if (modelSelect) {
            modelSelect.innerHTML = '<option value="">Error loading models</option>';
        }
    }
}

// Function to reset modal state
function resetModalState() {
    currentAnalysisResults = [];
    
    // Hide progress and results
    document.getElementById('analysisProgressContainer').style.display = 'none';
    document.getElementById('analysisResults').style.display = 'none';
    document.getElementById('saveAnalysisResultsBtn').style.display = 'none';
    
    // Reset progress bar
    const progressBar = document.getElementById('analysisProgressBar');
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
    
    // Reset processing options to defaults
    document.getElementById('backgroundProcessing').checked = true;
    document.getElementById('qualityControl').checked = true;
    document.getElementById('saveApprovedOnly').checked = false;
    document.getElementById('closeOnComplete').checked = false;
    
    // Enable start button
    const startBtn = document.getElementById('startArticleAnalysisBtn');
    startBtn.disabled = currentAnalysisArticles.length === 0;
    startBtn.style.display = 'inline-block';
}

// Function to start article analysis
async function startArticleAnalysis() {
    const startBtn = document.getElementById('startArticleAnalysisBtn');
    const progressContainer = document.getElementById('analysisProgressContainer');
    const progressText = document.getElementById('analysisProgressText');
    const progressBar = document.getElementById('analysisProgressBar');
    
    // Validate inputs
    const topic = document.getElementById('analysisTopicSelect').value;
    const model = document.getElementById('analysisModelSelect').value;
    
    if (!topic || !model) {
        showAlert('Please select both a topic and AI model', 'warning');
        return;
    }
    
    // Get processing options
    const backgroundProcessing = document.getElementById('backgroundProcessing').checked;
    const qualityControl = document.getElementById('qualityControl').checked;
    const saveApprovedOnly = document.getElementById('saveApprovedOnly').checked;
    const closeOnComplete = document.getElementById('closeOnComplete').checked;
    
    try {
        // Disable start button and show progress
        startBtn.disabled = true;
        startBtn.style.display = 'none';
        progressContainer.style.display = 'block';
        
        // Update progress text based on processing options
        let statusText = 'Starting analysis...';
        if (backgroundProcessing) statusText += ' (Background & Auto-Save)';
        if (qualityControl) statusText += ' (Quality Control)';
        if (saveApprovedOnly) statusText += ' (Approved Only)';
        
        progressText.textContent = statusText;
        
        // Prepare request data
        const requestData = {
            urls: currentAnalysisArticles.map(article => article.url),
            summaryType: "curious_ai_long",
            modelName: model,
            summaryLength: document.getElementById('analysisSummaryLength').value,
            summaryVoice: document.getElementById('analysisSummaryVoice').value,
            topic: topic,
            preservedMetadata: currentAnalysisArticles,
            options: {
                backgroundProcessing: backgroundProcessing,
                qualityControl: qualityControl,
                saveApprovedOnly: saveApprovedOnly,
                closeOnComplete: closeOnComplete
            }
        };
        
        // If background processing is enabled, allow user to continue using the interface
        if (backgroundProcessing) {
            showAlert(`Analysis started in background for ${currentAnalysisArticles.length} articles. You can continue using the interface.`, 'info');
        }
        
        // Start streaming analysis
        await performStreamingAnalysis(requestData);
        
    } catch (error) {
        console.error('Error during analysis:', error);
        showAlert(`Analysis failed: ${error.message}`, 'danger');
        resetModalState();
    }
}

// Function to perform streaming analysis
async function performStreamingAnalysis(requestData) {
    const progressText = document.getElementById('analysisProgressText');
    const progressBar = document.getElementById('analysisProgressBar');
    const resultsContainer = document.getElementById('analysisResults');
    const resultsList = document.getElementById('analysisResultsList');
    
    let processedCount = 0;
    const totalCount = requestData.urls.length;
    
    const response = await fetch('/api/bulk-research-stream', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Accept: 'application/x-ndjson'
        },
        body: JSON.stringify(requestData)
    });

    if (!response.ok || !response.body) {
        throw new Error(`Server error: ${response.status}`);
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    // Show results container
    resultsContainer.style.display = 'block';
    resultsList.innerHTML = '';

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop(); // keep incomplete line
        
        for (const line of lines) {
            if (!line.trim()) continue;
            
            try {
                const result = JSON.parse(line);
                
                // Apply preserved metadata (but preserve AI-generated summary)
                const preserved = requestData.preservedMetadata.find(meta => meta.url === result.uri);
                if (preserved) {
                    result.title = preserved.title || result.title;
                    result.news_source = preserved.source || result.news_source;
                    result.publication_date = preserved.publication_date || result.publication_date;
                    // Store original summary separately, keep AI-generated summary as primary
                    result.original_summary = preserved.summary;
                    // Only use preserved summary as fallback if AI didn't generate one
                    if (!result.summary || result.summary.trim() === '') {
                        result.summary = preserved.summary;
                    }
                }
                
                currentAnalysisResults.push(result);
                processedCount++;
                
                // Update progress
                const percentage = (processedCount / totalCount) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
                progressText.textContent = `Processed ${processedCount} of ${totalCount} articles...`;
                
                // Add result to list
                addAnalysisResultToList(result, processedCount);
                
            } catch (e) {
                console.error('Failed to parse NDJSON line', line, e);
            }
        }
    }

    // Parse any remaining buffer
    if (buffer.trim()) {
        try {
            const result = JSON.parse(buffer);
            const preserved = requestData.preservedMetadata.find(meta => meta.url === result.uri);
            if (preserved) {
                result.title = preserved.title || result.title;
                result.news_source = preserved.source || result.news_source;
                result.publication_date = preserved.publication_date || result.publication_date;
                // Store original summary separately, keep AI-generated summary as primary
                result.original_summary = preserved.summary;
                // Only use preserved summary as fallback if AI didn't generate one
                if (!result.summary || result.summary.trim() === '') {
                    result.summary = preserved.summary;
                }
            }
            currentAnalysisResults.push(result);
            addAnalysisResultToList(result, currentAnalysisResults.length);
        } catch (e) {
            console.error('Failed to parse last NDJSON fragment', buffer, e);
        }
    }
    
    // Analysis complete
    progressText.textContent = `Analysis complete! Processed ${currentAnalysisResults.length} articles.`;
    
    // Stop progress bar animation
    const analysisProgressBar = document.getElementById('analysisProgressBar');
    analysisProgressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
    analysisProgressBar.style.width = '100%';
    analysisProgressBar.setAttribute('aria-valuenow', '100');
    
    document.getElementById('saveAnalysisResultsBtn').style.display = 'inline-block';
    
    // Auto-save if background processing is enabled
    const backgroundProcessing = document.getElementById('backgroundProcessing').checked;
    if (backgroundProcessing && currentAnalysisResults.length > 0) {
        showAlert('Auto-saving analysis results...', 'info');
        setTimeout(() => {
            saveAnalysisResults();
        }, 2000);
    }
}

// Function to add analysis result to the list
function addAnalysisResultToList(result, index) {
    const resultsList = document.getElementById('analysisResultsList');
    
    const resultItem = document.createElement('div');
    resultItem.className = 'article-analysis-result border rounded p-3 mb-2 bg-light';
    resultItem.dataset.resultIndex = index - 1; // Adjust for 0-based indexing
    resultItem.dataset.resultUri = result.uri;
    
    resultItem.innerHTML = `
        <div class="review-status">
            <span class="badge bg-info review-badge" id="reviewBadge_${index}">
                <i class="fas fa-hourglass-half"></i> Queued
            </span>
        </div>
        <div class="result-item-actions">
            <button class="btn btn-outline-primary btn-sm" onclick="editAnalysisResult(${index - 1})" title="Edit result">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="removeAnalysisResult(${index - 1})" title="Remove result">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1 pe-5 pt-2">
                <h6 class="mb-1">${result.title || 'Untitled'}</h6>
                <div class="summary-section mb-2">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-success me-2 summary-badge" title="AI-generated summary">AI</span>
                        <p class="mb-0 small ai-summary">${result.summary || 'No AI summary available'}</p>
                    </div>
                    ${result.original_summary && result.original_summary !== result.summary ? 
                        `<div class="d-flex align-items-start mt-1">
                            <span class="badge bg-secondary me-2 summary-badge" title="Original newsfeed summary">Orig</span>
                            <p class="mb-0 small text-muted original-summary">${result.original_summary}</p>
                        </div>` : ''}
                </div>
                <div class="d-flex flex-wrap gap-1 mt-2">
                    ${result.category ? `<span class="badge bg-info">${result.category}</span>` : ''}
                    ${result.sentiment ? `<span class="badge bg-secondary">${result.sentiment}</span>` : ''}
                    ${result.future_signal ? `<span class="badge bg-warning text-dark">${result.future_signal}</span>` : ''}
                    ${result.time_to_impact ? `<span class="badge bg-success">${result.time_to_impact}</span>` : ''}
                    ${result.driver_type ? `<span class="badge bg-dark">${result.driver_type}</span>` : ''}
                </div>
                <small class="text-muted">${result.news_source || 'Unknown Source'}</small>
            </div>
            <span class="badge bg-primary mt-4">#${index}</span>
        </div>
    `;
    
    resultsList.appendChild(resultItem);
    
    // Trigger quality control if enabled
    const qualityControlEnabled = document.getElementById('qualityControl').checked;
    if (qualityControlEnabled) {
        // Small delay to show queued status, then start review
        setTimeout(() => {
            updateReviewStatus(index, 'reviewing', 'Quality Check...');
            setTimeout(() => performQualityControl(result, index), 300);
        }, 800);
    } else {
        // Mark as ready if no review needed
        setTimeout(() => updateReviewStatus(index, 'ready', 'Ready'), 500);
    }
    
    // Scroll to bottom to show latest result
    resultsList.scrollTop = resultsList.scrollHeight;
}

// Function to remove selected article
function removeSelectedArticle(index) {
    if (confirm('Remove this article from the analysis queue?')) {
        currentAnalysisArticles.splice(index, 1);
        populateSelectedArticlesList(currentAnalysisArticles);
        
        // Update count and check if we need to disable start button
        if (currentAnalysisArticles.length === 0) {
            document.getElementById('startArticleAnalysisBtn').disabled = true;
        }
    }
}



// Function to edit analysis result
function editAnalysisResult(index) {
    const result = currentAnalysisResults[index];
    if (!result) return;
    
    // Create a simple edit dialog
    const editModal = document.createElement('div');
    editModal.className = 'modal fade';
    editModal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Analysis Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="editResultTitle" value="${result.title || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">AI-Generated Summary</label>
                        <textarea class="form-control" id="editResultSummary" rows="3">${result.summary || ''}</textarea>
                        <div class="form-text">This is the AI-generated summary that will be saved to the database.</div>
                        ${result.original_summary && result.original_summary !== result.summary ? 
                            `<div class="mt-2">
                                <small class="text-muted"><strong>Original:</strong> ${result.original_summary}</small>
                            </div>` : ''}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" id="editResultCategory" value="${result.category || ''}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sentiment</label>
                                <select class="form-control" id="editResultSentiment">
                                    <option value="Positive" ${result.sentiment === 'Positive' ? 'selected' : ''}>Positive</option>
                                    <option value="Negative" ${result.sentiment === 'Negative' ? 'selected' : ''}>Negative</option>
                                    <option value="Neutral" ${result.sentiment === 'Neutral' ? 'selected' : ''}>Neutral</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedResult(${index})">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(editModal);
    const modal = new bootstrap.Modal(editModal);
    modal.show();
    
    // Remove modal from DOM when hidden
    editModal.addEventListener('hidden.bs.modal', () => {
        editModal.remove();
    });
}

// Function to save edited result
function saveEditedResult(index) {
    const result = currentAnalysisResults[index];
    result.title = document.getElementById('editResultTitle').value;
    result.summary = document.getElementById('editResultSummary').value;
    result.category = document.getElementById('editResultCategory').value;
    result.sentiment = document.getElementById('editResultSentiment').value;
    
    // Update the display
    updateAnalysisResultDisplay(index);
    
    // Close the edit modal
    const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
    if (modal) modal.hide();
    
    showAlert('Analysis result updated successfully!', 'success');
}

// Function to remove analysis result
function removeAnalysisResult(index) {
    if (confirm('Remove this analysis result?')) {
        const resultElement = document.querySelector(`[data-result-index="${index}"]`);
        if (resultElement) {
            resultElement.remove();
        }
        
        currentAnalysisResults.splice(index, 1);
        
        // Re-index remaining results
        currentAnalysisResults.forEach((result, newIndex) => {
            const element = document.querySelector(`[data-result-uri="${result.uri}"]`);
            if (element) {
                element.dataset.resultIndex = newIndex;
                const badge = element.querySelector('.badge.bg-primary');
                if (badge) badge.textContent = `#${newIndex + 1}`;
            }
        });
        
        showAlert('Analysis result removed', 'info');
    }
}

// Function to update analysis result display
function updateAnalysisResultDisplay(index) {
    const result = currentAnalysisResults[index];
    const resultElement = document.querySelector(`[data-result-index="${index}"]`);
    
    if (resultElement && result) {
        const titleElement = resultElement.querySelector('h6');
        const summaryElement = resultElement.querySelector('p.small');
        const badgesContainer = resultElement.querySelector('.d-flex.flex-wrap');
        
        if (titleElement) titleElement.textContent = result.title;
        if (summaryElement) summaryElement.textContent = result.summary;
        if (badgesContainer) {
            badgesContainer.innerHTML = `
                ${result.category ? `<span class="badge bg-info">${result.category}</span>` : ''}
                ${result.sentiment ? `<span class="badge bg-secondary">${result.sentiment}</span>` : ''}
                ${result.future_signal ? `<span class="badge bg-warning text-dark">${result.future_signal}</span>` : ''}
                ${result.time_to_impact ? `<span class="badge bg-success">${result.time_to_impact}</span>` : ''}
                ${result.driver_type ? `<span class="badge bg-dark">${result.driver_type}</span>` : ''}
            `;
        }
    }
}

// Function to perform quality control using actual AI models to detect unwanted content
async function performQualityControl(result, index) {
    // Status is already set to 'reviewing' before this function is called
    // This function now calls a real LLM to detect cookie notices, paywalls, and other unwanted content
    
    try {
        console.log('Starting AI-based quality control for article:', result.title?.substring(0, 50) + '...');
        
        // Get the selected model for analysis (from the analysis modal)
        const modelSelect = document.getElementById('analysisModelSelect');
        let selectedModel = modelSelect ? modelSelect.value : '';
        
        // Fallback to a default model if none selected
        if (!selectedModel) {
            selectedModel = 'gpt-4o-mini'; // Use a fast, cost-effective model for review
        }
        
        // Prepare the review request
        const reviewRequest = {
            article_title: result.title || 'No title',
            article_summary: result.summary || 'No summary available',
            article_source: result.news_source || 'Unknown source',
            model_name: selectedModel,
            article_url: result.uri
        };
        
        console.log('Sending quality control request to AI API...');
        
        // Call the LLM review API
        const response = await fetch('/api/keyword-monitor/review-content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(reviewRequest)
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `HTTP ${response.status}: Review API error`);
        }
        
        const reviewResult = await response.json();
        console.log('Quality control response received:', reviewResult);
        
        if (reviewResult.success && reviewResult.review) {
            const review = reviewResult.review;
            
            // Store review data in the result
            result.review_score = review.quality_score;
            result.review_notes = review.explanation;
            result.issues_detected = review.issues_detected;
            result.content_type = review.content_type;
            result.review_recommendation = review.recommendation;
            result.model_used = reviewResult.model_used;
            
            console.log(`Quality Control completed - Score: ${review.quality_score.toFixed(2)}, Recommendation: ${review.recommendation}`);
            
            // Update status based on LLM recommendation and quality score
            const scorePercent = Math.round(review.quality_score * 100);
            
            if (review.recommendation === 'approve' && review.quality_score >= 0.8) {
                updateReviewStatus(index, 'approved', `Approved (${scorePercent}%)`, 
                    `${review.explanation}${review.issues_detected.length > 0 ? ' | Issues: ' + review.issues_detected.join(', ') : ''}`);
            } else if (review.recommendation === 'reject' || review.quality_score < 0.3) {
                updateReviewStatus(index, 'rejected', `Rejected (${scorePercent}%)`, 
                    `${review.explanation}${review.issues_detected.length > 0 ? ' | Issues: ' + review.issues_detected.join(', ') : ''}`);
        } else {
                // review or mixed quality
                updateReviewStatus(index, 'warning', `Flagged (${scorePercent}%)`, 
                    `${review.explanation}${review.issues_detected.length > 0 ? ' | Issues: ' + review.issues_detected.join(', ') : ''}`);
            }
            
        } else {
            // Handle API error but still got a response
            console.error('Quality control API returned error:', reviewResult.error);
            
            if (reviewResult.review) {
                // Use the fallback review data
                result.review_score = reviewResult.review.quality_score;
                result.review_notes = reviewResult.review.explanation;
                updateReviewStatus(index, 'warning', 'Review Issues', reviewResult.review.explanation);
            } else {
                throw new Error(reviewResult.error || 'Unknown API error');
            }
        }
        
    } catch (error) {
        console.error('Quality Control error:', error);
        
        // Store error information
        result.review_score = 0.5; // Neutral score on error
        result.review_notes = `Review failed: ${error.message}`;
        
        updateReviewStatus(index, 'error', 'Review Failed', error.message);
        
        // Fallback to ready status after a delay
        setTimeout(() => {
            updateReviewStatus(index, 'ready', 'Review Unavailable');
            result.review_score = 0.6; // Default to acceptable quality for safety
        }, 2000);
    }
}

// Function to update review status
function updateReviewStatus(index, status, text, reviewNotes = '') {
    const badge = document.getElementById(`reviewBadge_${index}`);
    if (!badge) return;
    
    // Remove existing classes
    badge.className = 'badge review-badge';
    
    // Store the result index for click handling
    badge.setAttribute('data-result-index', index);
    
    // Create tooltip text with review explanation
    let tooltipText = text;
    if (reviewNotes && reviewNotes.trim()) {
        tooltipText += ` - ${reviewNotes}`;
    }
    
    // Add tooltip
    badge.setAttribute('title', tooltipText);
    badge.setAttribute('data-bs-toggle', 'tooltip');
    badge.setAttribute('data-bs-placement', 'top');
    
    // Add appropriate class and icon based on status
    switch (status) {
        case 'approved':
            badge.className += ' bg-success clickable-badge';
            badge.innerHTML = `<i class="fas fa-check"></i> ${text}`;
            break;
        case 'warning':
            badge.className += ' bg-warning text-dark clickable-badge';
            badge.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${text}`;
            break;
        case 'rejected':
            badge.className += ' bg-danger clickable-badge';
            badge.innerHTML = `<i class="fas fa-times"></i> ${text}`;
            break;
        case 'error':
            badge.className += ' bg-danger clickable-badge';
            badge.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${text}`;
            break;
        case 'reviewing':
            badge.className += ' bg-info';
            badge.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
            break;
        case 'ready':
            badge.className += ' bg-primary clickable-badge';
            badge.innerHTML = `<i class="fas fa-check-circle"></i> ${text}`;
            break;
        default:
            badge.className += ' bg-secondary';
            badge.innerHTML = `<i class="fas fa-clock"></i> ${text}`;
    }
    
    // Add click handler for completed reviews (not for reviewing status)
    if (status !== 'reviewing') {
        badge.style.cursor = 'pointer';
        badge.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            showReviewDetails(index);
        };
        
        // Add a small visual indicator that it's clickable
        if (badge.classList.contains('clickable-badge')) {
            badge.innerHTML += ' <i class="fas fa-info-circle ms-1 clickable-icon" style="font-size: 0.7em; opacity: 0.8; cursor: pointer; pointer-events: auto;"></i>';
        }
    } else {
        badge.style.cursor = 'default';
        badge.onclick = null;
    }
    
    // Initialize Bootstrap tooltip
    if (window.bootstrap && bootstrap.Tooltip) {
        // Remove existing tooltip instance if any
        const existingTooltip = bootstrap.Tooltip.getInstance(badge);
        if (existingTooltip) {
            existingTooltip.dispose();
        }
        // Create new tooltip
        new bootstrap.Tooltip(badge);
    }
    
    // Update review status count
    updateReviewStatusCount();
}

// Function to update review status count display
function updateReviewStatusCount() {
    const statusCount = document.getElementById('reviewStatusCount');
    if (!statusCount) return;
    
    const allBadges = document.querySelectorAll('.review-badge');
    let reviewing = 0;
    let approved = 0;
    let warning = 0;
    let rejected = 0;
    
    allBadges.forEach(badge => {
        if (badge.classList.contains('bg-info') && badge.innerHTML.includes('spinner')) {
            reviewing++;
        } else if (badge.classList.contains('bg-success')) {
            approved++;
        } else if (badge.classList.contains('bg-warning')) {
            warning++;
        } else if (badge.classList.contains('bg-danger')) {
            rejected++;
        }
    });
    
    if (reviewing > 0) {
        statusCount.innerHTML = `${reviewing} reviewing...`;
        statusCount.className = 'badge bg-info ms-2';
        statusCount.style.display = 'inline';
    } else if (allBadges.length > 0) {
        statusCount.innerHTML = `${approved} approved, ${warning} need review, ${rejected} rejected`;
        statusCount.className = 'badge bg-secondary ms-2';
        statusCount.style.display = 'inline';
    } else {
        statusCount.style.display = 'none';
    }
}

// Function to show review details modal
function showReviewDetails(resultIndex) {
    console.log('Showing review details for result index:', resultIndex);
    
    // Get the analysis result
    const result = currentAnalysisResults[resultIndex];
    if (!result) {
        console.error('No analysis result found for index:', resultIndex);
        showAlert('Review details not available', 'warning');
        return;
    }
    
    console.log('Analysis result found:', result);
    
    // Populate article information
    document.getElementById('reviewArticleTitle').textContent = result.title || 'No title available';
    document.getElementById('reviewArticleSource').innerHTML = `<i class="fas fa-globe me-1"></i>${result.news_source || 'Unknown source'}`;
    document.getElementById('reviewArticleSummary').textContent = result.summary || 'No summary available';
    
    // Populate review results
    const qualityScore = result.review_score || 0;
    document.getElementById('reviewQualityScore').textContent = qualityScore.toFixed(2);
    
    // Set quality score color based on value
    const scoreElement = document.getElementById('reviewQualityScore');
    if (qualityScore >= 0.8) {
        scoreElement.className = 'display-6 text-success';
    } else if (qualityScore >= 0.6) {
        scoreElement.className = 'display-6 text-warning';
    } else {
        scoreElement.className = 'display-6 text-danger';
    }
    
    // Populate recommendation badge
    const recommendation = result.review_recommendation || 'unknown';
    const recommendationBadge = document.getElementById('reviewRecommendationBadge');
    
    switch (recommendation) {
        case 'approve':
            recommendationBadge.className = 'badge bg-success fs-6';
            recommendationBadge.innerHTML = '<i class="fas fa-check me-1"></i>APPROVE';
            break;
        case 'review':
            recommendationBadge.className = 'badge bg-warning text-dark fs-6';
            recommendationBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>REVIEW';
            break;
        case 'reject':
            recommendationBadge.className = 'badge bg-danger fs-6';
            recommendationBadge.innerHTML = '<i class="fas fa-times me-1"></i>REJECT';
            break;
        default:
            recommendationBadge.className = 'badge bg-secondary fs-6';
            recommendationBadge.innerHTML = '<i class="fas fa-question me-1"></i>UNKNOWN';
    }
    
    // Populate content type and model
    document.getElementById('reviewContentType').textContent = result.content_type || 'unknown';
    document.getElementById('reviewModelUsed').textContent = result.model_used || 'Unknown model';
    
    // Populate issues detected
    const issuesSection = document.getElementById('reviewIssuesSection');
    const issuesList = document.getElementById('reviewIssuesItems');
    const issues = result.issues_detected || [];
    
    if (issues.length > 0) {
        issuesSection.style.display = 'block';
        issuesList.innerHTML = '';
        issues.forEach(issue => {
            const li = document.createElement('li');
            li.textContent = issue;
            issuesList.appendChild(li);
        });
    } else {
        issuesSection.style.display = 'none';
    }
    
    // Populate explanation
    document.getElementById('reviewExplanation').textContent = result.review_notes || 'No explanation available';
    
    // Store result index for potential override action
    document.getElementById('reviewOverrideBtn').setAttribute('data-result-index', resultIndex);
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('reviewDetailsModal'));
    modal.show();
}

// Function to override review decision (placeholder for future implementation)
function overrideReviewDecision() {
    const resultIndex = document.getElementById('reviewOverrideBtn').getAttribute('data-result-index');
    const result = currentAnalysisResults[resultIndex];
    
    if (!result) {
        showAlert('Cannot override - result not found', 'warning');
        return;
    }
    
    // Simple implementation: toggle between approve and review
    const currentRecommendation = result.review_recommendation || 'review';
    let newRecommendation, newScore, newText;
    
    if (currentRecommendation === 'reject') {
        newRecommendation = 'review';
        newScore = 0.6;
        newText = 'Manual Override (Review)';
    } else if (currentRecommendation === 'review') {
        newRecommendation = 'approve';
        newScore = 0.85;
        newText = 'Manual Override (Approved)';
    } else {
        newRecommendation = 'review';
        newScore = 0.6;
        newText = 'Manual Override (Review)';
    }
    
    // Update the result
    result.review_recommendation = newRecommendation;
    result.review_score = newScore;
    result.review_notes = `${result.review_notes || ''}\n\n[Manual Override: Changed to ${newRecommendation}]`;
    
    // Update the badge
    const badgeIndex = parseInt(resultIndex) + 1; // Badge IDs are 1-based
    updateReviewStatus(badgeIndex, newRecommendation === 'approve' ? 'approved' : 'warning', newText, `Manually overridden to ${newRecommendation}`);
    
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('reviewDetailsModal'));
    if (modal) modal.hide();
    
    showAlert(`Review decision overridden to: ${newRecommendation}`, 'info');
}

// Function to save analysis results
async function saveAnalysisResults() {
    const saveBtn = document.getElementById('saveAnalysisResultsBtn');
    const topic = document.getElementById('analysisTopicSelect').value;
    const backgroundProcessing = document.getElementById('backgroundProcessing').checked;
    const closeOnComplete = document.getElementById('closeOnComplete').checked;
    
    if (currentAnalysisResults.length === 0) {
        showAlert('No analysis results to save', 'warning');
        return;
    }
    
    try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Filter articles based on quality control settings
        const qualityControlEnabled = document.getElementById('qualityControl').checked;
        const saveApprovedOnly = document.getElementById('saveApprovedOnly').checked;
        let articlesToSave = currentAnalysisResults;
        
        if (qualityControlEnabled && saveApprovedOnly) {
            articlesToSave = currentAnalysisResults.filter(result => {
                // Only save articles that were explicitly approved
                if (result.review_recommendation) {
                    return result.review_recommendation === 'approve';
                }
                // Fallback to high quality score for approval
                return result.review_score && result.review_score >= 0.8;
            });
            
            if (articlesToSave.length < currentAnalysisResults.length) {
                const excludedCount = currentAnalysisResults.length - articlesToSave.length;
                const excludedReasons = currentAnalysisResults
                    .filter(result => !articlesToSave.includes(result))
                    .map(result => {
                        if (result.review_recommendation === 'reject') return 'Rejected';
                        if (result.review_recommendation === 'review') return 'Flagged';
                        return 'Not approved';
                    })
                    .reduce((acc, reason) => {
                        acc[reason] = (acc[reason] || 0) + 1;
                        return acc;
                    }, {});
                
                const reasonText = Object.entries(excludedReasons)
                    .map(([reason, count]) => `${count} ${reason}`)
                    .join(', ');
                
                showAlert(`${excludedCount} articles excluded from auto-save (${reasonText})`, 'info');
            }
        } else if (qualityControlEnabled) {
            // Quality control enabled but not restricted to approved only - exclude rejected
            articlesToSave = currentAnalysisResults.filter(result => {
                if (result.review_recommendation) {
                    return result.review_recommendation !== 'reject';
                }
                // Fallback to score-based filtering
                return !result.review_score || result.review_score >= 0.6;
            });
            
            if (articlesToSave.length < currentAnalysisResults.length) {
                const rejectedCount = currentAnalysisResults.length - articlesToSave.length;
                showAlert(`${rejectedCount} rejected articles excluded from saving`, 'info');
            }
        }
        
        // Prepare articles for saving
        const articles = articlesToSave.map(result => ({
            ...result,
            topic: topic,
            tags: Array.isArray(result.tags) ? result.tags : (result.tags ? result.tags.split(',').map(tag => tag.trim()) : []),
            submission_date: new Date().toISOString(),
            analyzed: true,
            review_score: result.review_score || null,
            review_notes: result.review_notes || null
        }));
        
        const response = await fetch('/api/save-bulk-articles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ articles }),
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success && result.success.length > 0) {
            showAlert(`${result.success.length} articles saved successfully!`, 'success');
            
            // Handle modal closing based on user preference
            if (closeOnComplete) {
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('articleAnalysisModal'));
                    if (modal) modal.hide();
                    setTimeout(() => window.location.reload(), 1000);
                }, 1500);
            } else {
                // Just refresh the page data without closing modal
                setTimeout(() => window.location.reload(), 2000);
            }
        }
        
        if (result.errors && result.errors.length > 0) {
            const errorMessage = result.errors.map(error => `${error.uri}: ${error.error}`).join('\n');
            showAlert(`Some articles could not be saved:\n${errorMessage}`, 'warning');
        }
        
    } catch (error) {
        console.error('Error saving articles:', error);
        showAlert(`Error saving articles: ${error.message}`, 'danger');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save All Articles';
    }
}

</script>
{% endblock %} 