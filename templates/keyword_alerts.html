{% extends "base.html" %}

{% block title %}AuNoo AI - Trend Dashboard{% endblock %}

{% block extra_css %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Media bias component code directly included -->
<script>
// Helper functions for bias and factual class mapping
function getBiasClass(bias) {
    if (!bias) return '';
    
    bias = bias.toLowerCase();
    console.log('getBiasClass called with:', bias);
    
    if (bias.includes('left') && !bias.includes('center')) {
        return 'bias-left';
    } else if (bias.includes('left-center')) {
        return 'bias-left-center';
    } else if (bias.includes('least biased') || bias.includes('center')) {
        return 'bias-least-biased';
    } else if (bias.includes('right-center')) {
        return 'bias-right-center';
    } else if (bias.includes('right') && !bias.includes('center')) {
        return 'bias-right';
    } else if (bias.includes('pro-science')) {
        return 'bias-pro-science';
    } else if (bias.includes('conspiracy') || bias.includes('pseudo')) {
        return 'bias-conspiracy-pseudoscience';
    } else if (bias.includes('questionable')) {
        return 'bias-questionable';
    } else if (bias.includes('satire')) {
        return 'bias-satire';
    }
    
    return '';
}

function getFactualClass(factual) {
    if (!factual) return '';
    
    factual = factual.toLowerCase();
    
    if (factual.includes('very high')) {
        return 'factual-very-high';
    } else if (factual.includes('high') && !factual.includes('very')) {
        return 'factual-high';
    } else if (factual.includes('mostly')) {
        return 'factual-mostly-factual';
    } else if (factual.includes('mixed')) {
        return 'factual-mixed';
    } else if (factual.includes('low') && !factual.includes('very')) {
        return 'factual-low';
    } else if (factual.includes('very low')) {
        return 'factual-very-low';
    }
    
    return '';
}

// Function to create media bias display for an article
function createMediaBiasDisplay(article) {
    console.log('createMediaBiasDisplay called with article:', article);
    if (!article) {
        console.log('No article provided, returning empty string');
        return '';
    }
    
    // Check if article has bias data fields
    const hasBiasData = article.bias || article.factual_reporting;
    
    if (!hasBiasData) {
        console.log('No bias data found in article, returning empty string');
        return '';
    }
    
    let biasClass = getBiasClass(article.bias);
    let factualClass = getFactualClass(article.factual_reporting);
    console.log('Bias class:', biasClass, 'Factual class:', factualClass);
    
    let html = `<div class="source-metadata">
        <div class="d-flex align-items-center flex-wrap gap-2">`;
    
    if (article.bias) {
        html += `<span class="bias-badge ${biasClass}">
            <i class="fas fa-balance-scale-right me-1"></i> ${article.bias}
        </span>`;
    }
    
    if (article.factual_reporting) {
        html += `<span class="bias-badge ${factualClass}">
            <i class="fas fa-check-circle me-1"></i> ${article.factual_reporting}
        </span>`;
    }
    
    html += `<span class="source-tooltip">
        <i class="fas fa-info-circle"></i>
        <div class="tooltip-content">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Media Bias Info</div>
            <table class="mb-0" style="font-size: 0.85rem; width: 100%;">`;
    
    // Always show source name if available
    if (article.source) {
        html += `<tr><td><strong>Source:</strong></td><td>${article.source}</td></tr>`;
    }
    
    if (article.bias) {
        html += `<tr><td><strong>Bias:</strong></td><td>${article.bias}</td></tr>`;
    }
    
    if (article.factual_reporting) {
        html += `<tr><td><strong>Factual:</strong></td><td>${article.factual_reporting}</td></tr>`;
    }
    
    if (article.mbfc_credibility_rating) {
        html += `<tr><td><strong>Rating:</strong></td><td>${article.mbfc_credibility_rating}</td></tr>`;
    }
    
    if (article.bias_country) {
        html += `<tr><td><strong>Country:</strong></td><td>${article.bias_country}</td></tr>`;
    }
    
    if (article.press_freedom) {
        html += `<tr><td><strong>Press&nbsp;Freedom:</strong></td><td>${article.press_freedom}</td></tr>`;
    }
    
    if (article.media_type) {
        html += `<tr><td><strong>Media&nbsp;Type:</strong></td><td>${article.media_type}</td></tr>`;
    }
    
    if (article.popularity) {
        html += `<tr><td><strong>Popularity:</strong></td><td>${article.popularity}</td></tr>`;
    }
    
    html += `</table>
        </div>
    </span>
    </div>
    </div>`;
    
    console.log('Generated media bias HTML:', html);
    return html;
}

// Expose functions globally so they can be used in other templates
window.getBiasClass = getBiasClass;
window.getFactualClass = getFactualClass;
window.createMediaBiasDisplay = createMediaBiasDisplay;
</script>
<style>
    /* Ensure media bias styling is available on this page */
    .bias-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        margin-right: 3px;
    }

    /* Bias color coding */
    .bias-left {
        background-color: #3373CC;
        color: white;
    }

    .bias-left-center {
        background-color: #6699EE;
        color: white;
    }

    .bias-least-biased, 
    .bias-center {
        background-color: #88CC88;
        color: black;
    }

    .bias-right-center {
        background-color: #FF9966;
        color: black;
    }

    .bias-right {
        background-color: #CC3333;
        color: white;
    }

    .bias-pro-science {
        background-color: #9966CC;
        color: white;
    }

    .bias-conspiracy-pseudoscience {
        background-color: #666666;
        color: white;
    }

    .bias-questionable {
        background-color: #222222;
        color: white;
    }

    .bias-satire {
        background-color: #CCBB33;
        color: black;
    }

    /* Factual reporting color coding */
    .factual-very-high {
        background-color: #006600;
        color: white;
    }

    .factual-high, 
    .factual-mostly-factual {
        background-color: #339933;
        color: white;
    }

    .factual-mixed {
        background-color: #CCCC00;
        color: black;
    }

    .factual-low, 
    .factual-very-low {
        background-color: #CC0000;
        color: white;
    }

    :root {
        --primary-color: #FF69B4;  /* Hot Pink */
        --primary-dark: #FF1493;   /* Deep Pink */
        --secondary-color: #32CD32;  /* Lime Green */
        --secondary-dark: #228B22;   /* Forest Green */
        --text-color: #333;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #343a40;
        --border-color: #dee2e6;
        --box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    h2, h5, h6 {
        color: var(--primary-color);
    }

/* Specific styles for keyword alerts page */
.article-reference {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 24px !important;
    height: 24px !important;
    border-radius: 50% !important;
    background-color: var(--light-gray) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-color) !important;
    text-decoration: none !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
}

.article-reference:hover {
    background-color: var(--primary-color) !important;
    color: white !important;
    border-color: var(--primary-color) !important;
}

.article-reference.selected {
    background-color: var(--primary-color) !important;
    color: white !important;
    border-color: var(--primary-color) !important;
}

.sparkline-container {
    position: relative;
    margin-right: 10px;
    background-color: #fff;
    border: 1px solid var(--border-color);
    width: 120px;
    height: 40px;
    padding: 5px;
}

.sparkline-container canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100% !important;
    height: 100% !important;
}

.keyword-labels {
    display: none;
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 4px;
    border-radius: 4px;
    box-shadow: var(--box-shadow);
    white-space: nowrap;
    z-index: 1000;
    min-width: max-content;
}

.article-reference:hover .keyword-labels {
    display: block;
}

.keyword-labels .badge {
    font-size: 0.75rem;
    margin: 0 2px;
    padding: 3px 6px;
    display: inline-block;
}

.keyword-labels:after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid white;
}

/* Alert message styling */
#alertMessage {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
    max-width: 500px;
    box-shadow: var(--box-shadow);
}

.source-metadata {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    margin: 8px 0;
    border-top: 1px solid var(--light-gray);
    padding-top: 8px;
}

.source-tooltip {
    position: relative;
    display: inline-block;
    margin-left: 5px;
    cursor: help;
}

.source-tooltip i {
    color: var(--primary-color);
    opacity: 0.8;
    transition: opacity 0.2s;
}

.source-tooltip:hover i {
    opacity: 1;
}

.source-tooltip .tooltip-content {
    visibility: hidden;
    position: absolute;
    z-index: 100;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    background-color: white;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    width: max-content;
    min-width: 260px;
    max-width: 320px;
    border: 1px solid var(--medium-gray);
    opacity: 0;
    transition: opacity 0.3s, transform 0.2s;
    pointer-events: none;
}

.source-tooltip:hover .tooltip-content {
    visibility: visible;
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.source-tooltip .tooltip-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: white transparent transparent transparent;
}

/* Mobile tooltip adjustments */
@media (max-width: 767px) {
    .source-tooltip .tooltip-content {
        position: fixed;
        top: 50%;
        left: 50%;
        bottom: auto;
        transform: translate(-50%, -50%);
        min-width: 280px;
        max-width: 90vw;
        z-index: 1050;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    
    .source-tooltip:hover .tooltip-content {
        transform: translate(-50%, -50%);
    }
    
    .source-tooltip .tooltip-content::after {
        display: none;
    }
}

/* Media bias badges inside tooltip */
.source-tooltip .bias-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin: 3px 0;
}

/* Media Bias Display Styles */
.article-bias-container {
    position: relative;
    display: inline-block;
    margin-left: 8px;
}

.article-bias, .article-factual {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 4px;
}

/* Tooltip styling */
.bias-tooltip {
    visibility: hidden;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 0;
    width: 300px;
    background-color: #f9f9f9;
    color: #333;
    text-align: left;
    border-radius: 6px;
    padding: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    border: 1px solid #ddd;
}

.bias-details p {
    margin: 5px 0;
    font-size: 0.8rem;
}

.article-bias-container:hover .bias-tooltip {
    visibility: visible;
    opacity: 1;
}
</style>
{% endblock %}

{% block content %}
<!-- Import the media bias macros -->
{% from "components/media_bias_display.html" import media_bias_badge, media_bias_icon %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-3">Trends Dashboard</h2>
            <div class="d-flex flex-column gap-2">
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted">
                        <i class="fas fa-clock"></i> Last search: {{ last_check_time|default('Never', true) }}
                    </span>
                    {% if last_error %}
                        <span class="text-danger">
                            <i class="fas fa-exclamation-circle"></i> {{ last_error }}
                        </span>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted">
                        <i class="fas fa-sync"></i> Polling every {{ display_interval }}
                    </span>
                    <span class="text-muted">
                        <i class="fas fa-hourglass-half"></i> 
                        {% if not is_enabled %}
                            Polling disabled
                        {% elif next_check_time %}
                            {% set next_check = next_check_time|datetime %}
                            {% set current_time = now|datetime %}
                            {% if next_check <= current_time %}
                                Checking soon...
                            {% else %}
                                Next check: Coming up soon
                            {% endif %}
                        {% else %}
                            Checking soon...
                        {% endif %}
                    </span>
                    <span class="text-muted" id="resetTimer" style="font-size: 0.9rem;">
                        <i class="fas fa-refresh"></i> Loading reset time...
                    </span>
                </div>
                <div class="d-flex align-items-center gap-3 mt-1">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="pollingToggle" 
                               {% if is_enabled %}checked{% endif %}
                               onchange="togglePolling(this.checked)">
                        <label class="form-check-label" for="pollingToggle">
                            Auto-polling {{ 'enabled' if is_enabled else 'disabled' }}
                        </label>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="checkKeywords()">
                        <i class="fas fa-sync"></i> Check Now
                    </button>
                </div>
            </div>
        </div>
        <div>
            <a href="/keyword-monitor" class="btn btn-primary">
                <i class="fas fa-cog"></i> Manage Keywords
            </a>
        </div>
    </div>

    <!-- Replace the existing trend chart section with this -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">EMERGING TRENDS OVERVIEW</h5>
                <div>
                    <button class="btn btn-outline-danger btn-sm me-2" id="bulkDeleteBtn" style="display: none;">
                        <i class="fas fa-trash"></i> Delete Selected (<span id="deleteCount">0</span>)
                    </button>
                    <button class="btn btn-outline-primary btn-sm me-2" id="bulkAnalyzeBtn" style="display: none;">
                        <i class="fas fa-microscope"></i> Analyze Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportAlerts()">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Emerging Trend</th>
                            <th>References</th>
                            <th style="width: 200px;">Growth</th>
                            <th>Size</th>
                            <th>Tags</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in groups %}
                        <tr data-topic="{{ group.topic }}" data-total-count="{{ group.total_count }}">
                            <td>
                                <span class="badge bg-{{ status_colors[group.growth_status] }}">
                                    {{ group.growth_status }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ group.name }}</strong>
                                        <p class="text-muted small mb-0">{{ group.topic }}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    {% if group.alerts %}
                                        {% for alert in group.alerts[:3] %}
                                        <span class="article-reference"
                                              data-url="{{ alert.article.url }}"
                                              data-title="{{ alert.article.title }}"
                                              data-summary="{{ alert.article.summary }}"
                                              data-topic="{{ group.topic }}"
                                              data-group-id="{{ group.id }}"
                                              onclick="toggleArticleSelection(this)"
                                              title="{{ alert.article.title }}">
                                            {{ loop.index }}
                                        </span>
                                        {% if alert.matched_keyword %}
                                            <span class="badge bg-info ms-1">
                                                <i class="fas fa-tag me-1"></i>{{ alert.matched_keyword }}
                                            </span>
                                        {% endif %}
                                        {% if alert.matched_keywords %}
                                            {% for keyword in alert.matched_keywords %}
                                                {% if keyword and keyword != alert.matched_keyword %}
                                                <span class="badge bg-info ms-1">
                                                    <i class="fas fa-tag me-1"></i>{{ keyword }}
                                                </span>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">No recent references</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="sparkline-container" style="width: 120px; height: 40px;">
                                        <canvas id="sparkline-{{ group.id }}" 
                                                width="120" 
                                                height="40" 
                                                style="width: 120px; height: 40px;"></canvas>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ group.unread_count }} alerts</span>
                            </td>
                            <td>
                                {% for keyword in group.keywords[:3] %}
                                <span class="badge bg-info">
                                    <i class="fas fa-tag me-1"></i>{{ keyword }}
                                </span>
                                {% endfor %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" title="Hide trend">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if groups %}
        <div class="row">
            {% for group in groups %}
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <div>
                                    <h5 class="mb-0">{{ group.name }}</h5>
                                    <div class="text-muted small">
                                        Topic: <span class="badge bg-secondary">{{ group.topic }}</span>
                                        {% if group.keywords %}
                                            <span class="ms-2">Monitoring: 
                                                {% for keyword in group.keywords %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-tag me-1"></i>{{ keyword }}
                                                </span>
                                                {% endfor %}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input show-read-toggle" 
                                           type="checkbox" 
                                           id="showReadToggle_{{ group.id }}"
                                           data-topic="{{ group.topic }}"
                                           data-group-id="{{ group.id }}">
                                    <label class="form-check-label" for="showReadToggle_{{ group.id }}">
                                        Show read articles (<span class="total-count">{{ group.total_count }}</span> total)
                                    </label>
                                </div>
                            </div>
                            <div class="d-flex gap-2 align-items-center" data-group-id="{{ group.id }}">
                                <button class="btn btn-outline-primary btn-sm bulk-analyze-btn" 
                                        data-topic="{{ group.topic }}"
                                        data-group-id="{{ group.id }}"
                                        onclick="analyzeBulkArticles('{{ group.topic }}', '{{ group.id }}')"
                                        style="display: none;">
                                    <i class="fas fa-microscope"></i> 
                                    Analyze Selected (<span class="selected-count">0</span>)
                                </button>
                                <button class="btn btn-outline-danger btn-sm bulk-delete-btn"
                                        data-topic="{{ group.topic }}"
                                        data-group-id="{{ group.id }}"
                                        onclick="bulkDeleteArticles('{{ group.topic }}', '{{ group.id }}')"
                                        style="display: none;">
                                    <i class="fas fa-trash"></i>
                                    Delete Selected (<span class="delete-count">0</span>)
                                </button>
                                <span class="badge bg-primary">{{ group.unread_count }} alerts</span>
                            </div>
                        </div>
                    </div>
                    
                    {% if group.alerts %}
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                                <tr>
                                    <th style="width: 80px">Status</th>
                                    <th>Article</th>
                                    <th style="width: 150px">Source</th>
                                    <th style="width: 150px">Detected</th>
                                    <th style="width: 150px">Tags</th>
                                    <th style="width: 250px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in group.alerts %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-primary">New</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column" style="max-width: 600px;">
                                            <div class="mb-1">
                                                <div class="d-flex gap-2 align-items-center">
                                                    <span class="article-reference"
                                                          data-url="{{ alert.article.url }}"
                                                          data-title="{{ alert.article.title }}"
                                                          data-summary="{{ alert.article.summary }}"
                                                          data-topic="{{ group.topic }}"
                                                          data-group-id="{{ group.id }}"
                                                          onclick="toggleArticleSelection(this)"
                                                          title="{{ alert.article.title }}">
                                                        {{ loop.index }}
                                                    </span>
                                                    <a href="{{ alert.article.url }}" target="_blank">{{ alert.article.title }}</a>
                                                </div>
                                                <p class="text-muted mb-0 small">{{ alert.article.summary }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small">
                                            <div class="fw-bold">{{ alert.article.source }}</div>
                                            <div class="text-muted">
                                                {{ alert.article.publication_date|datetime }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small">
                                            <div>{{ alert.detected_at|timeago }}</div>
                                            <div class="text-muted">
                                                {{ alert.detected_at|datetime }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            {% if alert.matched_keyword %}
                                                <span class="badge bg-info ms-1">
                                                    <i class="fas fa-tag me-1"></i>{{ alert.matched_keyword }}
                                                </span>
                                            {% endif %}
                                            {% if alert.matched_keywords %}
                                                {% for keyword in alert.matched_keywords %}
                                                    {% if keyword and keyword != alert.matched_keyword %}
                                                    <span class="badge bg-info ms-1">
                                                        <i class="fas fa-tag me-1"></i>{{ keyword }}
                                                    </span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column gap-2">
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-success" 
                                                        onclick="markAsRead('{{ alert.id }}')"
                                                        data-topic="{{ group.topic }}"
                                                        data-group-id="{{ group.id }}"
                                                        title="Mark as read">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <a href="/submit-article?url={{ alert.article.url|urlencode }}&topic={{ group.topic|urlencode }}" 
                                                   class="btn btn-sm btn-outline-primary"
                                                   title="Analyze article">
                                                    <i class="fas fa-microscope"></i>
                                                </a>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <a href="https://12ft.io/{{ alert.article.url }}" 
                                                   class="btn btn-sm btn-outline-secondary"
                                                   title="Bypass Paywall with 12ft.io" 
                                                   target="_blank">
                                                    <i class="fas fa-unlock"></i>
                                                </a>
                                                <a href="https://archive.is/{{ alert.article.url }}" 
                                                   class="btn btn-sm btn-outline-secondary"
                                                   title="View archived version" 
                                                   target="_blank">
                                                    <i class="fas fa-archive"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i> No new alerts for this group
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No unread alerts found.
        <a href="/keyword-monitor" class="alert-link">Set up keyword monitoring</a> to get notified about relevant articles.
    </div>
    {% endif %}
</div>

<!-- Add this at the top of the page for error messages -->
<div id="alertMessage" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
    <span id="alertText"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<script>
// At the top of the script section, change the storage structure
const selectedArticles = {
    byTopic: {},  // Store by topic for bulk operations
    byGroup: {}   // Store by group for UI updates
};

function generateTopicId(topic) {
    return `bulkAnalyzeBtn_${topic.replace(/[^a-zA-Z0-9]/g, '_')}`;
}

let selectedArticlesByTopic = {};

function drawSparkline(canvas, data) {
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const padding = 2;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Find min and max values
    const maxValue = Math.max(...data.counts, 1);  // At least 1 to avoid division by zero
    
    // Calculate scales
    const xScale = (width - 2 * padding) / (data.counts.length - 1);
    const yScale = (height - 2 * padding) / maxValue;
    
    // Draw grid lines
    ctx.strokeStyle = '#f0f0f0';
    ctx.lineWidth = 0.5;
    
    // Horizontal grid lines (3 lines)
    for (let i = 1; i <= 3; i++) {
        const y = height - (i * (height - 2 * padding) / 3);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
    }
    
    // Draw the sparkline
    ctx.strokeStyle = '#0d6efd';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    
    // Move to first point
    ctx.moveTo(
        padding,
        height - padding - (data.counts[0] * yScale)
    );
    
    // Draw lines to subsequent points
    for (let i = 1; i < data.counts.length; i++) {
        ctx.lineTo(
            i * xScale + padding,
            height - padding - (data.counts[i] * yScale)
        );
    }
    ctx.stroke();
    
    // Draw points
    ctx.fillStyle = '#0d6efd';
    data.counts.forEach((value, i) => {
        ctx.beginPath();
        ctx.arc(
            i * xScale + padding,
            height - padding - (value * yScale),
            2,
            0,
            2 * Math.PI
        );
        ctx.fill();
    });
    
    // Add value labels
    ctx.fillStyle = '#666';
    ctx.font = '8px Arial';
    ctx.textAlign = 'center';
    data.counts.forEach((value, i) => {
        if (value > 0) {  // Only show non-zero values
            ctx.fillText(
                value.toString(),
                i * xScale + padding,
                height - padding - (value * yScale) - 5
            );
        }
    });
}

async function loadTrendChart() {
    try {
        const response = await fetch('/api/keyword-monitor/trends');
        if (!response.ok) throw new Error('Failed to fetch trend data');
        
        const data = await response.json();
        
        Object.entries(data).forEach(([groupId, groupData]) => {
            const canvas = document.getElementById(`sparkline-${groupId}`);
            if (!canvas) return;
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            drawSparkline(canvas, groupData);
        });
    } catch (error) {
        console.error('Error loading trend charts:', error);
    }
}

// Load charts when page loads and refresh every 5 minutes
document.addEventListener('DOMContentLoaded', () => {
    loadTrendChart();
    setInterval(loadTrendChart, 5 * 60 * 1000);
});

async function markAsRead(alertId) {
    try {
        const response = await fetch(`/api/keyword-monitor/alerts/${alertId}/read`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to mark alert as read');
        
        const alertElement = document.querySelector(`[onclick*="${alertId}"]`);
        if (!alertElement) throw new Error('Alert element not found');
        
        const topic = alertElement.dataset.topic;
        const groupId = alertElement.dataset.groupId;
        
        if (!topic || !groupId) {
            console.error('Missing topic or groupId:', { topic, groupId });
            throw new Error('Missing required data attributes');
        }
        
        // Update the status badge count
        const groupCard = alertElement.closest('.card');
        const statusBadge = groupCard.querySelector('.badge.bg-primary');
        const currentCount = parseInt(statusBadge.textContent);
        if (!isNaN(currentCount)) {
            const newCount = Math.max(0, currentCount - 1);
            statusBadge.textContent = `${newCount} alerts`;
        }
        
        const toggle = document.querySelector(`#showReadToggle_${groupId}`);
        if (!toggle) throw new Error('Toggle element not found');
        
        // Refresh with current toggle state
        await refreshGroupArticles(topic, groupId, toggle.checked);
        
        showAlert('Alert marked as read', 'success');
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to mark alert as read', 'danger');
    }
}

function showAlert(message, type = 'danger') {
    let alert = document.getElementById('alertMessage');
    if (!alert) {
        // Create alert element if it doesn't exist
        alert = document.createElement('div');
        alert.id = 'alertMessage';
        alert.className = 'alert alert-dismissible fade';
        alert.setAttribute('role', 'alert');
        alert.style.position = 'fixed';
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '1050';
        alert.style.minWidth = '300px';
        alert.style.maxWidth = '500px';
        alert.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)';
        
        document.body.appendChild(alert);
    }

    // Update alert content
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        <span id="alertText">${message}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    alert.style.display = 'block';
    
    // Clear any existing timeout
    if (alert.timeoutId) {
        clearTimeout(alert.timeoutId);
    }
    
    // Auto-dismiss after 5 seconds
    alert.timeoutId = setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => {
            alert.style.display = 'none';
        }, 150); // Match the fade transition time
    }, 5000);
    
    // Add click handler for manual dismissal
    const closeButton = alert.querySelector('.btn-close');
    if (closeButton) {
        closeButton.onclick = () => {
            alert.classList.remove('show');
            setTimeout(() => {
                alert.style.display = 'none';
            }, 150);
        };
    }
}

async function checkKeywords() {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        
        console.log("Sending check-now request to API...");
        const response = await fetch('/api/keyword-monitor/check-now', {
            method: 'POST'
        });
        
        console.log("API response received:", response.status);
        
        if (response.status === 429) {
            showAlert('API daily request limit reached. Please try again tomorrow.', 'warning');
            return;
        }
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error("API error:", errorData);
            throw new Error(errorData.detail || 'Failed to check keywords');
        }
        
        const result = await response.json();
        console.log("API check complete:", result);
        
        // Show success message
        showAlert('Keyword check completed successfully. Refreshing page...', 'success');
        
        // Wait a moment to ensure database operations complete
        setTimeout(() => {
            console.log("Reloading page to show updated results");
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to check keywords: ' + error.message, 'danger');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

// Update the DOMContentLoaded event listener to be simpler
document.addEventListener('DOMContentLoaded', function() {
    // Initialize toggles
    document.querySelectorAll('.show-read-toggle').forEach(toggle => {
        const topic = toggle.dataset.topic;
        const groupId = toggle.dataset.groupId;
        
        if (!topic || !groupId) {
            console.error('Toggle missing required data attributes');
            return;
        }
        
        const savedState = localStorage.getItem(`showReadArticles_${groupId}`);
        toggle.checked = savedState === 'true' || false;
        
        toggle.addEventListener('change', async function() {
            console.log(`Toggle changed for group ${groupId} (${topic}): ${this.checked}`);
            localStorage.setItem(`showReadArticles_${groupId}`, this.checked);
            await refreshGroupArticles(topic, groupId, this.checked);
        });
    });

    // Initialize reset timer
    updateResetTimer();
    setInterval(updateResetTimer, 60000);
    
    // Add media bias info to all articles
    console.log('Initializing media bias enhancement');
    
    // First call the enhanced media bias function for initial page load
    enhanceAllArticlesWithMediaBias();
    
    // Then set up a MutationObserver to detect when new articles are added
    const articleContainers = document.querySelectorAll('.card-body table tbody');
    if (articleContainers.length > 0) {
        console.log(`Setting up observers for ${articleContainers.length} article containers`);
        
        const observer = new MutationObserver(function(mutations) {
            console.log('Detected DOM changes, enhancing media bias');
            enhanceAllArticlesWithMediaBias();
        });
        
        // Observe each article container for child additions/removals
        articleContainers.forEach(container => {
            observer.observe(container, { childList: true });
        });
    }
});

// Helper function for normalizing domains (matches Python normalize_domain)
function normalizeDomain(url) {
    if (!url) return '';
    
    // Convert to lowercase
    let domain = url.toLowerCase();
    
    // Remove protocol if present
    if (domain.startsWith('http://')) {
        domain = domain.substring(7);
    } else if (domain.startsWith('https://')) {
        domain = domain.substring(8);
    }
    
    // Remove www. if present
    if (domain.startsWith('www.')) {
        domain = domain.substring(4);
    }
    
    // Remove paths, query parameters, etc.
    domain = domain.split('/')[0];
    
    // Remove trailing punctuation
    domain = domain.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '');
    
    return domain.trim();
}

// Helper function to check if two domains match (like Python domains_match)
function domainsMatch(sourceDomain, targetDomain) {
    if (!sourceDomain || !targetDomain) return false;
    
    // Normalize both domains
    sourceDomain = normalizeDomain(sourceDomain);
    targetDomain = normalizeDomain(targetDomain);
    
    // Check for exact match
    if (sourceDomain === targetDomain) return true;
    
    // Check if one is a subdomain of the other
    if (sourceDomain.endsWith('.' + targetDomain)) return true;
    if (targetDomain.endsWith('.' + sourceDomain)) return true;
    
    // Extract root domains (e.g., example.com from sub.example.com)
    const sourceParts = sourceDomain.split('.');
    const targetParts = targetDomain.split('.');
    
    if (sourceParts.length >= 2 && targetParts.length >= 2) {
        const sourceRoot = sourceParts.slice(-2).join('.');
        const targetRoot = targetParts.slice(-2).join('.');
        if (sourceRoot === targetRoot) return true;
    }
    
    return false;
}

// Function for adding media bias badges to all articles
function enhanceAllArticlesWithMediaBias() {
    console.log('Enhancing all articles with media bias data');
    
    // Look for all table rows that might contain articles
    const allRows = document.querySelectorAll('tr');
    console.log(`Found ${allRows.length} table rows to check for media bias`);
    
    // Process each row
    allRows.forEach((row, index) => {
        // Look for source information
        const sourceCell = row.querySelector('td div.small .fw-bold');
        if (!sourceCell) return;
        
        const sourceName = sourceCell.textContent.trim();
        console.log(`Row ${index}: Found source: ${sourceName}`);
        
        // Check common sources that should have media bias data
        const knownSources = {
            'vanity fair': { bias: 'Left', factual: 'Mixed', country: 'USA' },
            'cnn': { bias: 'Left', factual: 'Mostly Factual', country: 'USA' },
            'forbes': { bias: 'Least Biased', factual: 'Mostly Factual', country: 'USA' },
            'yahoo': { bias: 'Left-Center', factual: 'Mostly Factual', country: 'USA' },
            'theverge': { bias: 'Left-Center', factual: 'Mostly Factual', country: 'USA' },
            'the verge': { bias: 'Left-Center', factual: 'Mostly Factual', country: 'USA' }
        };
        
        let matchedSource = null;
        const normalizedSource = normalizeDomain(sourceName);
        
        // Check for match with any known source
        for (const [source, data] of Object.entries(knownSources)) {
            if (domainsMatch(source, normalizedSource) || 
                sourceName.toLowerCase().includes(source.toLowerCase()) ||
                normalizedSource.includes(normalizeDomain(source))) {
                console.log(`Source ${sourceName} matches known source: ${source}`);
                matchedSource = { source: source, ...data };
                break;
            }
        }
        
        // If we have a match and media bias isn't already displayed, add it
        if (matchedSource) {
            const sourceContainer = sourceCell.closest('div.small');
            if (!sourceContainer) return;
            
            // Check if media bias is already displayed
            if (sourceContainer.querySelector('.source-metadata')) {
                console.log('Media bias already displayed for this source');
                return;
            }
            
            console.log(`Adding media bias display for ${sourceName} (matched: ${matchedSource.source})`);
            
            // Get bias and factual classes
            const biasClass = getBiasClass(matchedSource.bias);
            const factualClass = getFactualClass(matchedSource.factual);
            
            // Create article object for createMediaBiasDisplay
            const articleData = {
                source: sourceName,
                bias: matchedSource.bias,
                factual_reporting: matchedSource.factual,
                bias_country: matchedSource.country
            };
            
            // Generate HTML using our reusable function
            const biasHtml = createMediaBiasDisplay(articleData);
            
            // Add the HTML after the publication date
            const publicationDateDiv = sourceContainer.querySelector('.text-muted');
            if (publicationDateDiv) {
                console.log('Adding media bias HTML after publication date');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = biasHtml;
                publicationDateDiv.insertAdjacentElement('afterend', tempDiv.firstElementChild);
            } else {
                console.log('No publication date div found, adding at the end of container');
                sourceContainer.insertAdjacentHTML('beforeend', biasHtml);
            }
        }
    });
}

// Backward compatibility: keep the old function name but use the new implementation
function debugMediaBias() {
    console.log('Using enhanced media bias function');
    enhanceAllArticlesWithMediaBias();
}

// Add custom date formatting
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    // Handle future dates
    if (seconds < 0) {
        const futureSeconds = Math.abs(seconds);
        
        let interval = Math.floor(futureSeconds / 31536000);
        if (interval > 1) return `in ${interval} years`;
        
        interval = Math.floor(futureSeconds / 2592000);
        if (interval > 1) return `in ${interval} months`;
        
        interval = Math.floor(futureSeconds / 86400);
        if (interval > 1) return `in ${interval} days`;
        
        interval = Math.floor(futureSeconds / 3600);
        if (interval > 1) return `in ${interval} hours`;
        
        interval = Math.floor(futureSeconds / 60);
        if (interval > 1) return `in ${interval} minutes`;
        
        return `in ${Math.floor(futureSeconds)} seconds`;
    }
    
    // Handle past dates (original logic)
    let interval = Math.floor(seconds / 31536000);
    if (interval > 1) return `${interval} years ago`;
    
    interval = Math.floor(seconds / 2592000);
    if (interval > 1) return `${interval} months ago`;
    
    interval = Math.floor(seconds / 86400);
    if (interval > 1) return `${interval} days ago`;
    
    interval = Math.floor(seconds / 3600);
    if (interval > 1) return `${interval} hours ago`;
    
    interval = Math.floor(seconds / 60);
    if (interval > 1) return `${interval} minutes ago`;
    
    return `${Math.floor(seconds)} seconds ago`;
}

// Add Jinja filters
document.addEventListener('DOMContentLoaded', function() {
    const dates = document.querySelectorAll('[data-date]');
    dates.forEach(el => {
        const dateStr = el.dataset.date;
        if (el.classList.contains('timeago')) {
            el.textContent = timeAgo(dateStr);
        } else {
            el.textContent = formatDate(dateStr);
        }
    });
});

async function togglePolling(enabled) {
    try {
        const response = await fetch('/api/keyword-monitor/toggle-polling', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enabled })
        });
        
        if (!response.ok) {
            throw new Error('Failed to toggle polling');
        }
        
        // Update the label text
        const label = document.querySelector('label[for="pollingToggle"]');
        if (label) {
            label.textContent = `Auto-polling ${enabled ? 'enabled' : 'disabled'}`;
        }
        
        // Update the next check time display
        const nextCheckSpan = document.querySelector('span.text-muted i.fa-hourglass-half')?.parentElement;
        if (nextCheckSpan) {
            if (enabled) {
                // Refresh the status to get accurate next check time
                fetchMonitorStatus();
            } else {
                nextCheckSpan.innerHTML = `<i class="fas fa-hourglass-half"></i> Polling disabled`;
            }
        }
        
        showAlert(`Auto-polling ${enabled ? 'enabled' : 'disabled'}`, 'success');
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to toggle polling');
        // Revert the toggle if there was an error
        const toggle = document.getElementById('pollingToggle');
        if (toggle) {
            toggle.checked = !enabled;
        }
    }
}

// Old updateResetTimer and DOMContentLoaded event listener removed to avoid duplication

async function exportAlerts() {
    try {
        const response = await fetch('/api/keyword-monitor/export-alerts');
        if (!response.ok) throw new Error('Failed to export alerts');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `keyword_alerts_${timestamp}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        showAlert('Alerts exported successfully!', 'success');
    } catch (error) {
        console.error('Error exporting alerts:', error);
        showAlert('Failed to export alerts. Please try again.', 'danger');
    }
}

function toggleArticleSelection(element) {
    const articleData = {
        url: element.dataset.url,
        title: element.dataset.title,
        summary: element.dataset.summary,
        topic: element.dataset.topic,
        groupId: element.dataset.groupId
    };
    
    // Initialize storage if needed
    if (!selectedArticles.byTopic[articleData.topic]) {
        selectedArticles.byTopic[articleData.topic] = [];
    }
    if (!selectedArticles.byGroup[articleData.groupId]) {
        selectedArticles.byGroup[articleData.groupId] = [];
    }
    
    element.classList.toggle('selected');
    
    if (element.classList.contains('selected')) {
        // Add to both topic and group arrays if not already present
        if (!selectedArticles.byTopic[articleData.topic].some(article => article.url === articleData.url)) {
            selectedArticles.byTopic[articleData.topic].push(articleData);
        }
        if (!selectedArticles.byGroup[articleData.groupId].some(article => article.url === articleData.url)) {
            selectedArticles.byGroup[articleData.groupId].push(articleData);
        }
    } else {
        // Remove from both arrays
        selectedArticles.byTopic[articleData.topic] = selectedArticles.byTopic[articleData.topic]
            .filter(article => article.url !== articleData.url);
        selectedArticles.byGroup[articleData.groupId] = selectedArticles.byGroup[articleData.groupId]
            .filter(article => article.url !== articleData.url);
    }
    
    updateBulkButtons(articleData.topic, articleData.groupId);
}

function updateBulkButtons(topic, groupId) {
    const groupArticles = selectedArticles.byGroup[groupId] || [];
    const buttonContainer = document.querySelector(`.d-flex[data-group-id="${groupId}"]`);
    if (!buttonContainer) return;
    
    // Update analyze button for this specific group
    const bulkAnalyzeBtn = buttonContainer.querySelector('.bulk-analyze-btn');
    if (bulkAnalyzeBtn) {
        if (groupArticles.length > 0) {
            bulkAnalyzeBtn.style.display = 'inline-block';
            const selectedCount = bulkAnalyzeBtn.querySelector('.selected-count');
            if (selectedCount) {
                selectedCount.textContent = groupArticles.length;
            }
        } else {
            bulkAnalyzeBtn.style.display = 'none';
        }
    }
    
    // Update delete button for this specific group
    const bulkDeleteBtn = buttonContainer.querySelector('.bulk-delete-btn');
    if (bulkDeleteBtn) {
        if (groupArticles.length > 0) {
            bulkDeleteBtn.style.display = 'inline-block';
            const deleteCount = bulkDeleteBtn.querySelector('.delete-count');
            if (deleteCount) {
                deleteCount.textContent = groupArticles.length;
            }
        } else {
            bulkDeleteBtn.style.display = 'none';
        }
    }
}

function analyzeBulkArticles(topic, groupId) {
    const articles = selectedArticles.byGroup[groupId] || [];
    if (articles.length === 0) {
        showAlert('No articles selected for analysis', 'warning');
        return;
    }
    
    const urls = articles.map(article => article.url).join('\n');
    const params = new URLSearchParams({
        url: urls,
        topic: topic
    });
    
    window.location.href = `/submit-article?${params.toString()}`;
}

async function bulkDeleteArticles(topic, groupId) {
    const articles = selectedArticles.byGroup[groupId] || [];
    
    if (articles.length === 0) {
        showAlert('No articles selected for deletion', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${articles.length} selected articles from this group?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/bulk_delete_articles', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                uris: articles.map(article => article.url)
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete articles');
        }
        
        const result = await response.json();
        showAlert(`Successfully deleted ${result.deleted_count} articles`, 'success');
        
        // Clear selections
        selectedArticles.byGroup[groupId] = [];
        selectedArticles.byTopic[topic] = [];
        
        // Update UI elements safely with null checks
        const headerBadge = document.querySelector(`a[href="#${groupId}"] .badge, [data-topic="${topic}"] .badge.bg-primary`);
        if (headerBadge) {
            headerBadge.textContent = '0 alerts';
        }
        
        const trendBadge = document.querySelector(`tr[data-topic="${topic}"] td:nth-child(5) .badge.bg-primary`);
        if (trendBadge) {
            trendBadge.textContent = '0 alerts';
        }
        
        // Safely get the toggle element
        const toggle = document.querySelector(`#showReadToggle_${groupId}`);
        if (toggle) {
            const totalSpan = toggle.closest('label')?.querySelector('.total-count');
            if (totalSpan) {
                totalSpan.textContent = '0';
            }
            
            // Refresh the group's content
            await refreshGroupArticles(topic, groupId, toggle.checked || false);
        }
        
        // Update the group content area
        const groupContainer = document.querySelector(`[data-group-id="${groupId}"]`);
        if (groupContainer) {
            const tableBody = groupContainer.closest('.card')?.querySelector('tbody');
            if (tableBody) {
                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle"></i> No new alerts for this group
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        }

    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to delete articles. Please try again.', 'danger');
    }
}

// Update refreshGroupArticles to skip media bias lookup on refresh
async function refreshGroupArticles(topic, groupId, showRead = false, skipMediaBias = true) {
    try {
        console.log(`Refreshing articles for group ${groupId} (${topic}), showRead: ${showRead}`);
        
        const response = await fetch(`/api/keyword-monitor/alerts/${encodeURIComponent(topic)}?show_read=${showRead}&group_id=${groupId}&skip_media_bias=${skipMediaBias}`);
        
        if (!response.ok) {
            throw new Error('Failed to fetch alerts');
        }
        
        const data = await response.json();
        
        // Debug: Log the detailed data structure
        console.log('API Response:', data);
        if (data.alerts && data.alerts.length > 0) {
            console.log('First alert:', data.alerts[0]);
            console.log('Media bias data from API:', 
                        'bias:', data.alerts[0].article.bias, 
                        'factual:', data.alerts[0].article.factual_reporting);
            
            // Check for articles with sources we know should have bias data
            const sourcesToCheck = ['vanity fair', 'vanityfair', 'cnn', 'fox', 'nyt', 'new york times'];
            const matchedArticles = data.alerts.filter(alert => 
                sourcesToCheck.some(s => 
                    alert.article.source && alert.article.source.toLowerCase().includes(s)
                )
            );
            
            if (matchedArticles.length > 0) {
                console.log('*** Found articles with known sources that should have bias data: ***');
                matchedArticles.forEach(alert => {
                    console.log(`Source: ${alert.article.source}`);
                    console.log(`Has bias data: ${!!(alert.article.bias || alert.article.factual_reporting)}`);
                    console.log(`Bias: ${alert.article.bias || 'MISSING'}`);
                    console.log(`Factual: ${alert.article.factual_reporting || 'MISSING'}`);
                    console.log('---');
                });
            }
        }
        
        // Update the card selector to find by group-id
        const card = document.querySelector(`.card .d-flex[data-group-id="${groupId}"]`).closest('.card');
        if (!card) {
            console.error(`Card not found for group ${groupId} (${topic})`);
            return;
        }
        
        updateGroupAlerts(card, data, groupId);
        
    } catch (error) {
        console.error('Error refreshing articles:', error);
        showAlert('Failed to refresh articles', 'danger');
    }
}

// Update the updateGroupAlerts function to add more debugging for media bias HTML generation
function updateGroupAlerts(card, data, groupId) {
    const tableBody = card.querySelector('tbody');
    if (!tableBody) {
        console.error('Table body not found');
        return;
    }
    
    // Update count in the group panel
    const alertCountBadge = card.querySelector('.badge.bg-primary');
    if (alertCountBadge) {
        alertCountBadge.textContent = `${data.unread_count} alerts`;
    }
    
    // Update count in trend dashboard (but not the status badge)
    const trendRow = document.querySelector(`tr[data-topic="${data.topic}"]`);
    if (trendRow) {
        // Find the size column badge specifically (not the status badge)
        const trendCountBadge = trendRow.querySelector('td:nth-child(5) .badge.bg-primary');
        if (trendCountBadge) {
            trendCountBadge.textContent = `${data.unread_count} alerts`;
        }
    }
    
    // Generate alerts HTML
    let html = '';
    for (const alert of data.alerts) {
        console.log(`Processing alert: ${alert.id}, Source: ${alert.article.source}`);
        console.log('Media bias data in alert:', 
                  'bias:', alert.article.bias, 
                  'factual_reporting:', alert.article.factual_reporting);
        
        // Check if this is a known source for debugging
        const knownSources = ['vanity fair', 'vanityfair', 'cnn', 'fox', 'nyt', 'new york times'];
        const isKnownSource = knownSources.some(s => 
            alert.article.source && alert.article.source.toLowerCase().includes(s)
        );
        
        if (isKnownSource) {
            console.log(`Known source "${alert.article.source}" found! Has bias data: ${!!(alert.article.bias || alert.article.factual_reporting)}`);
        }
                    
        // Check if this alert is for Vanity Fair
        const isVanityFair = alert.article.source && 
            (alert.article.source.toLowerCase().includes('vanity') || 
             alert.article.source.toLowerCase().includes('vanityfair'));
             
        if (isVanityFair) {
            console.log('Processing Vanity Fair alert:', alert);
            
            // Force add bias data if it's missing
            if (!alert.article.bias) {
                console.log('Adding hard-coded bias data for Vanity Fair');
                alert.article.bias = 'Left';
                alert.article.factual_reporting = 'Mixed';
                alert.article.bias_country = 'USA';
                alert.article.press_freedom = 'Mostly Free';
                alert.article.media_type = 'Magazine';
                alert.article.popularity = 'High Traffic';
                alert.article.mbfc_credibility_rating = 'High Credibility';
            }
        }
        
        // Process keywords for this alert
        let keywordBadges = '';
        if (alert.matched_keyword) {
            keywordBadges += `<span class="badge bg-info">
                <i class="fas fa-tag me-1"></i>${alert.matched_keyword}
            </span>`;
        }
        
        // Process additional keywords if available
        if (alert.matched_keywords && Array.isArray(alert.matched_keywords)) {
            alert.matched_keywords.forEach(keyword => {
                if (keyword && keyword !== alert.matched_keyword) {
                    keywordBadges += `<span class="badge bg-info ms-1">
                        <i class="fas fa-tag me-1"></i>${keyword}
                    </span>`;
                }
            });
        }
        
        // Create media bias badges if available
        let mediaBiasHtml = '';
        
        // Log all properties of the article for debugging
        console.log('Article object properties:', Object.keys(alert.article));
        console.log('Article bias value type:', typeof alert.article.bias);
        
        if (alert.article.bias || alert.article.factual_reporting) {
            console.log('Creating media bias HTML for source:', alert.article.source);
            console.log('Bias value:', alert.article.bias);
            console.log('Factual reporting value:', alert.article.factual_reporting);
            
            // First try using the global function if it exists
            if (typeof window.createMediaBiasDisplay === 'function') {
                console.log('Using global createMediaBiasDisplay function');
                mediaBiasHtml = window.createMediaBiasDisplay(alert.article);
                console.log('Generated HTML from global function:', mediaBiasHtml);
            } else {
                // Fallback implementation if the function isn't available
                console.log('Using fallback media bias implementation');
                
                // Helper functions for the fallback
                function getBiasClass(bias) {
                    if (!bias) return '';
                    
                    bias = (bias || '').toLowerCase();
                    console.log('Getting bias class for:', bias);
                    
                    if (bias.includes('left') && !bias.includes('center')) {
                        return 'bias-left';
                    } else if (bias.includes('left-center')) {
                        return 'bias-left-center';
                    } else if (bias.includes('least biased')) {
                        return 'bias-least-biased';
                    } else if (bias.includes('center')) {
                        return 'bias-center';
                    } else if (bias.includes('right-center')) {
                        return 'bias-right-center';
                    } else if (bias.includes('right')) {
                        return 'bias-right';
                    } else if (bias.includes('pro-science')) {
                        return 'bias-pro-science';
                    } else if (bias.includes('conspiracy') || bias.includes('pseudo')) {
                        return 'bias-conspiracy-pseudoscience';
                    } else if (bias.includes('questionable')) {
                        return 'bias-questionable';
                    } else if (bias.includes('satire')) {
                        return 'bias-satire';
                    }
                    
                    return '';
                }
                
                function getFactualClass(factual) {
                    if (!factual) return '';
                    
                    factual = (factual || '').toLowerCase();
                    console.log('Getting factual class for:', factual);
                    
                    if (factual.includes('very high')) {
                        return 'factual-very-high';
                    } else if (factual.includes('high') && !factual.includes('very')) {
                        return 'factual-high';
                    } else if (factual.includes('mostly')) {
                        return 'factual-mostly-factual';
                    } else if (factual.includes('mixed')) {
                        return 'factual-mixed';
                    } else if (factual.includes('low') && !factual.includes('very')) {
                        return 'factual-low';
                    } else if (factual.includes('very low')) {
                        return 'factual-very-low';
                    }
                    
                    return '';
                }
                
                const biasClass = getBiasClass(alert.article.bias);
                const factualClass = getFactualClass(alert.article.factual_reporting);
                
                console.log('Fallback implementation results - Bias class:', biasClass, 'Factual class:', factualClass);
                
                mediaBiasHtml = `<div class="source-metadata">
                    <div class="d-flex align-items-center flex-wrap gap-2">`;
                
                if (alert.article.bias) {
                    mediaBiasHtml += `<span class="bias-badge ${biasClass}">
                        <i class="fas fa-balance-scale-right me-1"></i> ${alert.article.bias}
                    </span>`;
                }
                
                if (alert.article.factual_reporting) {
                    mediaBiasHtml += `<span class="bias-badge ${factualClass}">
                        <i class="fas fa-check-circle me-1"></i> ${alert.article.factual_reporting}
                    </span>`;
                }
                
                mediaBiasHtml += `
                    <span class="source-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <div class="tooltip-content">
                            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Media Bias Info</div>
                            <table class="mb-0" style="font-size: 0.85rem;">
                                <tr><td><strong>Source:</strong></td><td>${alert.article.source}</td></tr>
                                ${alert.article.bias ? `<tr><td><strong>Bias:</strong></td><td>${alert.article.bias}</td></tr>` : ''}
                                ${alert.article.factual_reporting ? `<tr><td><strong>Factual:</strong></td><td>${alert.article.factual_reporting}</td></tr>` : ''}
                                ${alert.article.mbfc_credibility_rating ? `<tr><td><strong>Rating:</strong></td><td>${alert.article.mbfc_credibility_rating}</td></tr>` : ''}
                                ${alert.article.bias_country ? `<tr><td><strong>Country:</strong></td><td>${alert.article.bias_country}</td></tr>` : ''}
                                ${alert.article.press_freedom ? `<tr><td><strong>Press Freedom:</strong></td><td>${alert.article.press_freedom}</td></tr>` : ''}
                                ${alert.article.media_type ? `<tr><td><strong>Media Type:</strong></td><td>${alert.article.media_type}</td></tr>` : ''}
                                ${alert.article.popularity ? `<tr><td><strong>Popularity:</strong></td><td>${alert.article.popularity}</td></tr>` : ''}
                            </table>
                        </div>
                    </span>
                </div>
                </div>`;
                
                console.log('Generated media bias HTML from fallback:', mediaBiasHtml);
            }
        } else if (isVanityFair) {
            // If it's Vanity Fair but still no media bias HTML, create a hardcoded one
            console.log('Creating hardcoded media bias HTML for Vanity Fair');
            mediaBiasHtml = `<div class="source-metadata">
                <div class="d-flex align-items-center flex-wrap gap-2">
                    <span class="bias-badge bias-left">
                        <i class="fas fa-balance-scale-right me-1"></i> Left
                    </span>
                    <span class="bias-badge factual-mixed">
                        <i class="fas fa-check-circle me-1"></i> Mixed
                    </span>
                    <span class="source-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <div class="tooltip-content">
                            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Media Bias Info</div>
                            <table class="mb-0" style="font-size: 0.85rem;">
                                <tr><td><strong>Source:</strong></td><td>${alert.article.source}</td></tr>
                                <tr><td><strong>Bias:</strong></td><td>Left</td></tr>
                                <tr><td><strong>Factual:</strong></td><td>Mixed</td></tr>
                                <tr><td><strong>Country:</strong></td><td>USA</td></tr>
                                <tr><td><strong>Media Type:</strong></td><td>Magazine</td></tr>
                            </table>
                        </div>
                    </span>
                </div>
            </div>`;
            console.log('Generated hardcoded HTML for Vanity Fair:', mediaBiasHtml);
        } else {
            console.log('No bias data available for this article:', alert.article.source);
        }
        
        // Let's render all properties of the article object for debugging
        console.log('Final mediaBiasHtml length:', mediaBiasHtml ? mediaBiasHtml.length : 0);
        
        html += `
            <tr class="${alert.is_read ? 'text-muted bg-light' : ''}"
                data-bias="${alert.article.bias || ''}"
                data-factual-reporting="${alert.article.factual_reporting || ''}"
                data-credibility-rating="${alert.article.mbfc_credibility_rating || ''}"
                data-bias-country="${alert.article.bias_country || ''}"
                data-press-freedom="${alert.article.press_freedom || ''}"
                data-media-type="${alert.article.media_type || ''}"
                data-popularity="${alert.article.popularity || ''}">
                <td>
                    <div class="d-flex align-items-center">
                        ${alert.is_read ? 
                            '<span class="badge bg-secondary">Read</span>' : 
                            '<span class="badge bg-primary">New</span>'}
                    </div>
                </td>
                <td>
                    <div class="d-flex flex-column" style="max-width: 600px;">
                        <div class="mb-1">
                            <div class="d-flex gap-2 align-items-center">
                                <span class="article-reference"
                                      data-url="${alert.article.url}"
                                      data-title="${alert.article.title}"
                                      data-summary="${alert.article.summary}"
                                      data-topic="${data.topic}"
                                      data-group-id="${groupId}"
                                      onclick="toggleArticleSelection(this)"
                                      title="${alert.article.title}">
                                    ${alert.id}
                                </span>
                                <a href="${alert.article.url}" target="_blank">${alert.article.title}</a>
                            </div>
                            <p class="text-muted mb-0 small">${alert.article.summary}</p>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="small">
                        <div class="fw-bold">${alert.article.source}</div>
                        <div class="text-muted">
                            ${new Date(alert.article.publication_date).toLocaleString()}
                        </div>
                        ${mediaBiasHtml}
                    </div>
                </td>
                <td>
                    <div class="small">
                        <div>${timeAgo(alert.detected_at)}</div>
                        <div class="text-muted">
                            ${new Date(alert.detected_at).toLocaleString()}
                        </div>
                    </div>
                </td>
                <td>
                    <div>
                        ${keywordBadges}
                    </div>
                </td>
                <td>
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex gap-2">
                            ${!alert.is_read ? 
                                `<button class="btn btn-sm btn-outline-success" 
                                         onclick="markAsRead('${alert.id}')"
                                         data-topic="${data.topic}"
                                         data-group-id="${groupId}"
                                         title="Mark as read">
                                    <i class="fas fa-check"></i>
                                </button>` : 
                                `<button class="btn btn-sm btn-outline-secondary" 
                                         onclick="markAsUnread('${alert.id}')"
                                         title="Mark as unread">
                                    <i class="fas fa-undo"></i>
                                </button>`}
                            <a href="/submit-article?url=${encodeURIComponent(alert.article.url)}&topic=${encodeURIComponent(data.topic)}" 
                               class="btn btn-sm btn-outline-primary"
                               title="Analyze article">
                                <i class="fas fa-microscope"></i>
                            </a>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="https://12ft.io/${alert.article.url}" 
                               class="btn btn-sm btn-outline-secondary"
                               title="Bypass Paywall with 12ft.io" 
                               target="_blank">
                                <i class="fas fa-unlock"></i>
                            </a>
                            <a href="https://archive.is/${alert.article.url}" 
                               class="btn btn-sm btn-outline-secondary"
                               title="View archived version" 
                               target="_blank">
                                <i class="fas fa-archive"></i>
                            </a>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    }
    
    tableBody.innerHTML = html;
    
    // Update the total count in toggle label
    const totalCount = card.querySelector('.total-count');
    if (totalCount) {
        totalCount.textContent = data.total_count;
    }
    
    // Update bulk action buttons
    updateBulkButtons(data.topic, groupId);
}

// Update markAsUnread to pass the correct showRead state
async function markAsUnread(alertId) {
    try {
        const response = await fetch(`/api/keyword-monitor/alerts/${alertId}/unread`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to mark alert as unread');
        
        const alertElement = document.querySelector(`[onclick*="${alertId}"]`);
        const groupElement = alertElement.closest('.card');
        const buttonContainer = groupElement.querySelector('.d-flex[data-group-id]');
        const topic = alertElement.dataset.topic;
        const groupId = buttonContainer.dataset.groupId;
        const toggle = document.querySelector(`#showReadToggle_${groupId}`);
        
        await refreshGroupArticles(topic, groupId, toggle.checked);
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to mark alert as unread', 'danger');
    }
}

async function fixDuplicateAlerts() {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
        
        const response = await fetch('/api/keyword-monitor/fix-duplicate-alerts', {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to fix duplicate alerts');
        }
        
        const result = await response.json();
        showAlert(`${result.message}`, 'success');
        
        // Reload the page to show the updated alerts
        setTimeout(() => {
            window.location.reload();
        }, 2000);
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to fix duplicate alerts. Please try again.', 'danger');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

$(document).ready(function() {
    // Fetch monitor status on page load
    fetchMonitorStatus();
    
    // Set interval to refresh status every 30 seconds
    setInterval(fetchMonitorStatus, 30000);
    
    // Initialize other components here...
});

function fetchMonitorStatus() {
    fetch('/api/keyword-monitor/status')
        .then(response => response.json())
        .then(data => {
            // Update next check time in the header
            updateStatusDisplay(data);
        })
        .catch(error => {
            console.error("Error fetching monitor status:", error);
        });
}

function updateStatusDisplay(data) {
    const bgTask = data.background_task;
    const settings = data.settings;
    
    // Update last check time
    if (bgTask.last_check_time) {
        const lastCheckElem = document.querySelector('.fas.fa-clock').parentElement;
        if (lastCheckElem) {
            // Format consistently with next check time
            const lastCheck = new Date(bgTask.last_check_time);
            const now = new Date();
            const diffMs = now - lastCheck;
            
            if (diffMs < 60000) { // Less than a minute
                lastCheckElem.innerHTML = `<i class="fas fa-clock"></i> Last check: Less than a minute ago`;
            } else if (diffMs < 3600000) { // Less than an hour
                const minutes = Math.floor(diffMs / 60000);
                lastCheckElem.innerHTML = `<i class="fas fa-clock"></i> Last check: ${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else {
                const hours = Math.floor(diffMs / 3600000);
                lastCheckElem.innerHTML = `<i class="fas fa-clock"></i> Last check: ${hours} hour${hours > 1 ? 's' : ''} ago`;
            }
        }
    }
    
    // Update next check time (keep the minutes format since it's more precise for upcoming events)
    if (bgTask.next_check_time) {
        const nextCheckElem = document.querySelector('.fas.fa-hourglass-half').parentElement;
        if (nextCheckElem) {
            const now = new Date();
            const nextCheck = new Date(bgTask.next_check_time);
            
            if (settings.is_enabled) {
                if (nextCheck <= now) {
                    nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Checking soon...`;
                } else {
                    const timeDiff = nextCheck - now;
                    if (timeDiff <= 60000) { // Less than a minute
                        nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Next check: In less than a minute`;
                    } else if (timeDiff < 3600000) { // Less than an hour
                        const minutes = Math.floor(timeDiff / 60000);
                        nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Next check: In ${minutes} minute${minutes > 1 ? 's' : ''}`;
                    } else {
                        const hours = Math.floor(timeDiff / 3600000);
                        nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Next check: In ${hours} hour${hours > 1 ? 's' : ''}`;
                    }
                }
            } else {
                nextCheckElem.innerHTML = `<i class="fas fa-hourglass-half"></i> Polling disabled`;
            }
        }
    }
    
    // Update error message if there is one
    if (bgTask.last_error) {
        const lastErrorElem = document.querySelector('.fas.fa-exclamation-circle')?.parentElement;
        if (lastErrorElem) {
            lastErrorElem.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${bgTask.last_error}`;
            lastErrorElem.style.display = 'inline-flex';
        }
    } else {
        const lastErrorElem = document.querySelector('.fas.fa-exclamation-circle')?.parentElement;
        if (lastErrorElem) {
            lastErrorElem.style.display = 'none';
        }
    }
    
    // Update polling toggle status
    const pollingToggle = document.getElementById('pollingToggle');
    if (pollingToggle) {
        pollingToggle.checked = settings.is_enabled;
        const label = document.querySelector('label[for="pollingToggle"]');
        if (label) {
            label.textContent = `Auto-polling ${settings.is_enabled ? 'enabled' : 'disabled'}`;
        }
    }
    
    // Update API usage
    if (data.api_usage) {
        const resetTimer = document.getElementById('resetTimer');
        if (resetTimer) {
            const percentage = (data.api_usage.requests_today / data.api_usage.limit) * 100;
            resetTimer.innerHTML = `<i class="fas fa-refresh"></i> API usage: ${data.api_usage.requests_today}/${data.api_usage.limit}`;
            
            if (percentage >= 100) {
                resetTimer.classList.add('text-danger');
                resetTimer.classList.remove('text-warning', 'text-muted');
            } else if (percentage >= 80) {
                resetTimer.classList.add('text-warning');
                resetTimer.classList.remove('text-danger', 'text-muted');
            } else {
                resetTimer.classList.add('text-muted');
                resetTimer.classList.remove('text-danger', 'text-warning');
            }
        }
    }
}

// Update the reset timer function to properly display when API usage will reset
function updateResetTimer() {
    // Get current time in UTC/GMT
    const now = new Date();
    
    // Create tomorrow's date at midnight UTC (when API counter resets)
    const tomorrow = new Date(now);
    tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);
    tomorrow.setUTCHours(0, 0, 0, 0);
    
    const timeUntilReset = tomorrow - now;
    const hours = Math.floor(timeUntilReset / (1000 * 60 * 60));
    const minutes = Math.floor((timeUntilReset % (1000 * 60 * 60)) / (1000 * 60));
    
    const resetTimer = document.getElementById('resetTimer');
    if (resetTimer) {
        // Get current API usage if available
        const usageText = resetTimer.dataset.usage || '';
        resetTimer.innerHTML = `<i class="fas fa-refresh"></i> ${usageText} (Resets in ${hours}h ${minutes}m)`;
        
        // Update color based on API usage status
        if (resetTimer.dataset.status === 'danger') {
            resetTimer.classList.add('text-danger');
        } else if (resetTimer.dataset.status === 'warning') {
            resetTimer.classList.add('text-warning');
        } else {
            resetTimer.classList.remove('text-danger', 'text-warning');
        }
    }
}

// Fetch current API usage periodically
function fetchApiUsage() {
    fetch('/api/keyword-monitor/status')
        .then(response => response.json())
        .then(data => {
            if (data.api_usage) {
                const resetTimer = document.getElementById('resetTimer');
                if (resetTimer) {
                    const usage = data.api_usage.requests_today;
                    const limit = data.api_usage.limit;
                    const percentage = (usage / limit) * 100;
                    
                    // Store the usage text for the reset timer
                    resetTimer.dataset.usage = `API usage: ${usage}/${limit}`;
                    
                    // Update status for coloring
                    if (percentage >= 100) {
                        resetTimer.dataset.status = 'danger';
                    } else if (percentage >= 80) {
                        resetTimer.dataset.status = 'warning';
                    } else {
                        resetTimer.dataset.status = 'normal';
                    }
                    
                    // Update the timer display
                    updateResetTimer();
                }
            }
        })
        .catch(error => console.error('Error fetching API usage:', error));
}

// Update the DOMContentLoaded event listener to include API usage checks
document.addEventListener('DOMContentLoaded', function() {
    // Initialize toggles
    document.querySelectorAll('.show-read-toggle').forEach(toggle => {
        const topic = toggle.dataset.topic;
        const groupId = toggle.dataset.groupId;
        
        if (!topic || !groupId) {
            console.error('Toggle missing required data attributes');
            return;
        }
        
        const savedState = localStorage.getItem(`showReadArticles_${groupId}`);
        toggle.checked = savedState === 'true' || false;
        
        toggle.addEventListener('change', async function() {
            console.log(`Toggle changed for group ${groupId} (${topic}): ${this.checked}`);
            localStorage.setItem(`showReadArticles_${groupId}`, this.checked);
            await refreshGroupArticles(topic, groupId, this.checked);
        });
    });

    // Fetch API usage immediately
    fetchApiUsage();
    
    // Initialize reset timer and set periodic updates
    updateResetTimer();
    setInterval(updateResetTimer, 60000);  // Update the countdown every minute
    setInterval(fetchApiUsage, 300000);    // Fetch fresh API usage every 5 minutes
    
    // Add media bias info to all articles
    console.log('Initializing media bias enhancement');
    
    // First call the enhanced media bias function for initial page load
    enhanceAllArticlesWithMediaBias();
    
    // Rest of existing init code...
});

// Extract domain from URL to match with media bias sources
function extractDomain(url) {
    try {
        // For URLs with protocol
        if (url.includes('://')) {
            const urlObj = new URL(url);
            return urlObj.hostname;
        }
        
        // For domain strings without protocol
        if (url.includes('.')) {
            // If there's no protocol but it looks like a domain
            return url.trim().split('/')[0];
        }
        
        return url.trim();
    } catch (e) {
        console.warn('Error extracting domain:', e);
        return url;
    }
}

// Check if two domains match, including subdomain support
function domainsMatch(sourceDomain, targetDomain) {
    if (!sourceDomain || !targetDomain) return false;
    
    sourceDomain = sourceDomain.toLowerCase();
    targetDomain = targetDomain.toLowerCase();
    
    // Exact match
    if (sourceDomain === targetDomain) return true;
    
    // Check if sourceDomain is a subdomain of targetDomain
    if (sourceDomain.endsWith('.' + targetDomain)) return true;
    
    // Check if targetDomain is a subdomain of sourceDomain
    if (targetDomain.endsWith('.' + sourceDomain)) return true;
    
    // Extract root domain (e.g., "example.com" from "sub.example.com")
    const sourceRoot = sourceDomain.split('.').slice(-2).join('.');
    const targetRoot = targetDomain.split('.').slice(-2).join('.');
    
    // Match on root domains
    return sourceRoot === targetRoot;
}

// Get media bias data for a given article
function getMediaBiasFromArticle(article) {
    // Check if article has media bias fields
    if (!article || !article.bias) {
        return { found: false };
    }
    
    return { 
        found: true, 
        data: {
            source: article.source,
            bias: article.bias,
            factual_reporting: article.factual_reporting,
            mbfc_credibility_rating: article.mbfc_credibility_rating,
            country: article.bias_country,
            press_freedom: article.press_freedom,
            media_type: article.media_type,
            popularity: article.popularity
        }
    };
}

// Populate media bias metadata using data already in the article objects
function populateMediaBiasMetadata() {
    console.log('Populating media bias tooltips from article data...');
    // Get all source containers
    const sourceContainers = document.querySelectorAll('td div.small');
    
    for (const container of sourceContainers) {
        // Check if this is a source container with source name
        const sourceElement = container.querySelector('.fw-bold');
        if (!sourceElement || container.querySelector('.source-tooltip')) {
            // Skip if no source element or already has tooltip
            continue;
        }
        
        // Find the article-reference that contains the article data
        const articleRow = container.closest('tr');
        if (!articleRow) continue;
        
        const articleRef = articleRow.querySelector('.article-reference');
        if (!articleRef) continue;
        
        // Get article URL from the reference
        const articleUrl = articleRef.dataset.url;
        
        // Get the article data from the container element
        const article = {
            source: sourceElement.textContent.trim(),
            bias: articleRow.dataset.bias,
            factual_reporting: articleRow.dataset.factualReporting,
            mbfc_credibility_rating: articleRow.dataset.credibilityRating,
            bias_country: articleRow.dataset.biasCountry,
            press_freedom: articleRow.dataset.pressFreedom,
            media_type: articleRow.dataset.mediaType,
            popularity: articleRow.dataset.popularity
        };
        
        // Skip if no bias data
        if (!article.bias && !article.factual_reporting) {
            continue;
        }
        
        // Create tooltip HTML using our helper functions
        if (!container.querySelector('.source-tooltip')) {
            const biasClass = getBiasClass(article.bias);
            const factualClass = getFactualClass(article.factual_reporting);
            
            // Create the bias badge element
            const biasContainer = document.createElement('div');
            biasContainer.className = 'mt-1 media-bias-container d-inline-flex align-items-center';
            
            // Add bias badge if available
            if (article.bias) {
                const biasBadge = document.createElement('span');
                biasBadge.className = `bias-badge ${biasClass}`;
                biasBadge.textContent = article.bias;
                biasContainer.appendChild(biasBadge);
            }
            
            // Add factual reporting badge if available
            if (article.factual_reporting) {
                const factualBadge = document.createElement('span');
                factualBadge.className = `bias-badge ${factualClass}`;
                factualBadge.textContent = article.factual_reporting;
                biasContainer.appendChild(factualBadge);
            }
            
            // Add tooltip
            const tooltip = document.createElement('span');
            tooltip.className = 'source-tooltip';
            tooltip.innerHTML = '<i class="fas fa-info-circle"></i>';
            
            // Create tooltip content
            const tooltipContent = document.createElement('div');
            tooltipContent.className = 'tooltip-content';
            
            let tooltipHtml = '<div style="text-align: center; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Media Bias Info</div>';
            tooltipHtml += '<table class="mb-0" style="font-size: 0.85rem;">';
            
            // Add source info
            tooltipHtml += `<tr><td><strong>Source:</strong></td><td>${article.source}</td></tr>`;
            
            // Add bias badge if available
            if (article.bias) {
                tooltipHtml += `<tr><td><strong>Bias:</strong></td><td>${article.bias}</td></tr>`;
            }
            
            // Add factual reporting badge if available
            if (article.factual_reporting) {
                tooltipHtml += `<tr><td><strong>Factual:</strong></td><td>${article.factual_reporting}</td></tr>`;
            }
            
            // Add credibility rating if available
            if (article.mbfc_credibility_rating) {
                tooltipHtml += `<tr><td><strong>Rating:</strong></td><td>${article.mbfc_credibility_rating}</td></tr>`;
            }
            
            // Add country if available
            if (article.bias_country) {
                tooltipHtml += `<tr><td><strong>Country:</strong></td><td>${article.bias_country}</td></tr>`;
            }
            
            // Add press freedom if available
            if (article.press_freedom) {
                tooltipHtml += `<tr><td><strong>Press Freedom:</strong></td><td>${article.press_freedom}</td></tr>`;
            }
            
            // Add media type if available
            if (article.media_type) {
                tooltipHtml += `<tr><td><strong>Media Type:</strong></td><td>${article.media_type}</td></tr>`;
            }
            
            // Add popularity if available
            if (article.popularity) {
                tooltipHtml += `<tr><td><strong>Popularity:</strong></td><td>${article.popularity}</td></tr>`;
            }
            
            tooltipHtml += '</table>';
            
            tooltipContent.innerHTML = tooltipHtml;
            tooltip.appendChild(tooltipContent);
            biasContainer.appendChild(tooltip);
            
            // Add the bias container after the source element
            sourceElement.after(biasContainer);
        }
    }
}

// These functions are now provided by media_bias_display.html
// Removing them since we now use the global functions from media_bias_display.html component

// Make sure the media bias display functions are available
document.addEventListener('DOMContentLoaded', function() {
    // Check if media bias display functions exist, define them if not
    if (typeof window.getBiasClass !== 'function') {
        console.log('Defining media bias functions...');
        
        window.getBiasClass = function(bias) {
            if (!bias) return '';
            
            bias = bias.toLowerCase();
            
            if (bias.includes('left') && !bias.includes('center')) {
                return 'bias-left';
            } else if (bias.includes('left-center')) {
                return 'bias-left-center';
            } else if (bias.includes('least biased') || bias.includes('center')) {
                return 'bias-least-biased';
            } else if (bias.includes('right-center')) {
                return 'bias-right-center';
            } else if (bias.includes('right') && !bias.includes('center')) {
                return 'bias-right';
            } else if (bias.includes('pro-science')) {
                return 'bias-pro-science';
            } else if (bias.includes('conspiracy') || bias.includes('pseudo')) {
                return 'bias-conspiracy-pseudoscience';
            } else if (bias.includes('questionable')) {
                return 'bias-questionable';
            } else if (bias.includes('satire')) {
                return 'bias-satire';
            }
            
            return '';
        };
        
        window.getFactualClass = function(factual) {
            if (!factual) return '';
            
            factual = factual.toLowerCase();
            
            if (factual.includes('very high')) {
                return 'factual-very-high';
            } else if (factual.includes('high') && !factual.includes('very')) {
                return 'factual-high';
            } else if (factual.includes('mostly')) {
                return 'factual-mostly-factual';
            } else if (factual.includes('mixed')) {
                return 'factual-mixed';
            } else if (factual.includes('low') && !factual.includes('very')) {
                return 'factual-low';
            } else if (factual.includes('very low')) {
                return 'factual-very-low';
            }
            
            return '';
        };
        
        window.createMediaBiasDisplay = function(article) {
            if (!article || (!article.bias && !article.factual_reporting)) {
                return '';
            }
            
            let biasClass = window.getBiasClass(article.bias);
            let factualClass = window.getFactualClass(article.factual_reporting);
            
            let html = `<div class="source-metadata">
                <div class="d-flex align-items-center flex-wrap gap-2">`;
            
            if (article.bias) {
                html += `<span class="bias-badge ${biasClass}">
                    <i class="fas fa-balance-scale-right me-1"></i> ${article.bias}
                </span>`;
            }
            
            if (article.factual_reporting) {
                html += `<span class="bias-badge ${factualClass}">
                    <i class="fas fa-check-circle me-1"></i> ${article.factual_reporting}
                </span>`;
            }
            
            html += `<span class="source-tooltip">
                <i class="fas fa-info-circle"></i>
                <div class="tooltip-content">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Media Bias Info</div>
                    <table class="mb-0" style="font-size: 0.85rem;">`;
            
            if (article.bias) {
                html += `<tr><td><strong>Bias:</strong></td><td>${article.bias}</td></tr>`;
            }
            
            if (article.factual_reporting) {
                html += `<tr><td><strong>Factual:</strong></td><td>${article.factual_reporting}</td></tr>`;
            }
            
            if (article.mbfc_credibility_rating) {
                html += `<tr><td><strong>Rating:</strong></td><td>${article.mbfc_credibility_rating}</td></tr>`;
            }
            
            if (article.bias_country) {
                html += `<tr><td><strong>Country:</strong></td><td>${article.bias_country}</td></tr>`;
            }
            
            if (article.press_freedom) {
                html += `<tr><td><strong>Press&nbsp;Freedom:</strong></td><td>${article.press_freedom}</td></tr>`;
            }
            
            if (article.media_type) {
                html += `<tr><td><strong>Media&nbsp;Type:</strong></td><td>${article.media_type}</td></tr>`;
            }
            
            if (article.popularity) {
                html += `<tr><td><strong>Popularity:</strong></td><td>${article.popularity}</td></tr>`;
            }
            
            html += `</table>
                </div>
            </span>
            </div>
            </div>`;
            
            return html;
        };
    } else {
        console.log('Media bias functions already defined.');
    }
});

// ... Add the resetApiCounter function to the script section ...
async function resetApiCounter() {
    if (!confirm("Are you sure you want to manually reset the API counter? This should only be needed if the automatic daily reset isn't working.")) {
        return;
    }
    
    try {
        const response = await fetch('/api/keyword-monitor/reset-api-counter', {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to reset API counter');
        }
        
        const result = await response.json();
        showAlert(`API counter reset successfully: ${result.message}`, 'success');
        
        // Refresh the API usage display
        fetchApiUsage();
    } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to reset API counter: ' + error.message, 'danger');
    }
}
</script>
{% endblock %} 