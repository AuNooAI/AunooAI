{% extends "base.html" %}

{% block title %}Newsletter Compiler{% endblock %}

{% block styles %}
<!-- 
IMPORTANT: To add this page to your main navigation menu:

1. Edit your base template or navigation file (e.g., base.html, navbar.html, or sidebar.html)
2. Find the Analysis section in your navigation menu
3. Add the following link inside that section:

For a Bootstrap navbar:
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('newsletter_compiler') }}">Newsletter Compiler</a>
</li>

For a sidebar menu:
<li>
    <a href="{{ url_for('newsletter_compiler') }}">Newsletter Compiler</a>
</li>

Make sure the URL matches your actual route for this page.
If you're not using Flask's url_for, use the direct URL: "/newsletter-compiler" 
-->

<!-- SimpleMDE Markdown Editor CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css">
<!-- Font Awesome for editor toolbar icons - using preload to prioritize loading -->
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" as="style">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!-- Highlight.js for code syntax highlighting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
<style>
    /* Custom container styling */
    .newsletter-container {
        padding: 20px;
        max-width: 100%;
    }

    #editorPane { 
        height: 500px;
        position: relative;
        border: none;
        padding: 0;
    }
    
    #previewPane {
        height: 500px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        padding: 10px;
        overflow-y: auto;
    }
    
    /* SimpleMDE Specific Overrides and Styling */
    .editor-toolbar {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-bottom: none;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        opacity: 1 !important;
        padding: 4px;
    }

    .editor-toolbar a {
        color: #495057 !important;
        border: 1px solid transparent !important;
        margin: 2px !important;
        width: 30px !important;
        height: 30px !important;
        text-align: center;
        line-height: 30px !important;
    }

    .editor-toolbar a:before {
        line-height: 30px !important;
    }

    .editor-toolbar a.active,
    .editor-toolbar a:hover {
        background: #e9ecef !important;
        border-color: #ced4da !important;
        color: #000 !important;
    }
    
    .CodeMirror-fullscreen, .editor-preview-full {
        z-index: 1050 !important;
    }

    /* Ensure CodeMirror (editor area) fits within #editorPane and card */
    .CodeMirror {
        height: 100% !important;
        border: 1px solid #dee2e6 !important;
        border-top: none !important;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        font-size: 16px;
        line-height: 1.5;
        padding: 10px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    /* Fix cursor visibility issues */
    .CodeMirror-cursor {
        border-left: 1px solid black !important;
        border-right: none !important;
        width: 0 !important;
        opacity: 1 !important;
    }
    
    /* Improve focus and selection styling */
    .CodeMirror-focused .CodeMirror-selected {
        background: rgba(0, 0, 255, 0.1) !important;
    }
    
    /* Make sure cursor is visible in editor */
    .CodeMirror pre.CodeMirror-line, 
    .CodeMirror pre.CodeMirror-line-like {
        z-index: 1;
    }

    .CodeMirror-scroll {
        min-height: 450px;
    }
    
    .editor-preview-side {
        z-index: 100;
        border-left: 1px solid #dee2e6 !important; 
    }
    
    #htmlPreview {
        height: 100%;
        overflow-y: auto;
        padding: 15px;
    }
    
    .control-panel {
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .content-type-item {
        margin: 10px 0;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        margin: 20px;
    }

    .editor-section {
        margin-bottom: 20px;
    }
    
    .editor-card { 
        background-color: white;
        border-radius: 0.25rem;
        margin-bottom: 20px;
        overflow: hidden; 
    }
    
    .editor-card-header {
        padding: 0.75rem 1.25rem;
        margin-bottom: 0;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: calc(0.25rem - 1px);
        border-top-right-radius: calc(0.25rem - 1px);
    }

    .editor-card-header h5 {
        margin-bottom: 0;
        font-size: 1rem;
        font-weight: 500;
    }
    
    /* Style for code blocks in preview */
    #htmlPreview pre {
        background-color: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
    }
    
    #htmlPreview code {
        font-family: 'Courier New', Courier, monospace;
    }
    
    @media (max-width: 768px) {
        #editorPane, #previewPane {
            height: 400px;
        }
        .CodeMirror-scroll {
            min-height: 350px; 
        }
    }

    /* Ensure Font Awesome icons display correctly in the toolbar */
    .editor-toolbar a:before {
        font-family: FontAwesome, sans-serif !important;
        display: inline-block;
        font-size: 16px;
        width: 100%;
        text-align: center;
    }
    
    /* Fix specific icon issues by providing direct icon code points */
    .editor-toolbar a.fa-header:before { content: "\f1dc"; }
    .editor-toolbar a.fa-bold:before { content: "\f032"; }
    .editor-toolbar a.fa-italic:before { content: "\f033"; }
    .editor-toolbar a.fa-strikethrough:before { content: "\f0cc"; }
    .editor-toolbar a.fa-link:before { content: "\f0c1"; }
    .editor-toolbar a.fa-quote-left:before { content: "\f10d"; }
    .editor-toolbar a.fa-list-ul:before { content: "\f0ca"; }
    .editor-toolbar a.fa-list-ol:before { content: "\f0cb"; }
    .editor-toolbar a.fa-table:before { content: "\f0ce"; }
    .editor-toolbar a.fa-picture-o:before { content: "\f03e"; }
    .editor-toolbar a.fa-code:before { content: "\f121"; }
    .editor-toolbar a.fa-question-circle:before { content: "\f059"; }
    .editor-toolbar a.fa-eye:before { content: "\f06e"; }
    .editor-toolbar a.fa-columns:before { content: "\f0db"; }
    .editor-toolbar a.fa-arrows-alt:before { content: "\f0b2"; }
    .editor-toolbar a.fa-minus:before { content: "\f068"; }

    /* Improved content type selection layout */
    .content-types-container {
        display: block;
        margin-bottom: 15px;
    }
    
    .content-type-item {
        padding: 8px 12px;
        margin-bottom: 8px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    .content-type-checkbox-wrapper {
        display: flex;
        align-items: center;
    }
    
    .content-type-item label {
        font-weight: 500;
        margin-left: 8px;
        margin-bottom: 0;
        cursor: pointer;
    }
    
    .content-type-item small {
        display: block;
        margin-left: 25px;
        margin-top: 5px;
        color: #6c757d;
    }
    
    /* Control chart sizes in the preview - more aggressive size limitations */
    .preview-container img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 15px auto;
    }
    
    /* Specifically target chart images to ensure they're not too large */
    .preview-container img[src*="chart"], 
    .preview-container img[alt*="Chart"],
    .preview-container img[alt*="chart"],
    .preview-container img[src*="sentiment"],
    .preview-container img[src*="radar"],
    .preview-container img[src*="graph"] {
        max-width: 550px;
        max-height: 400px;
        width: auto !important;
        height: auto !important;
        object-fit: contain;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        background-color: white;
    }
    
    /* Ensure the loading spinner is centered and visible */
    #loadingSpinner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
    }

    /* Navigation styles */
    .breadcrumb-container {
        background-color: #f5f5f5;
        padding: 8px 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .breadcrumb {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-wrap: wrap;
    }
    
    .breadcrumb-item {
        display: inline-block;
        margin-right: 5px;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        content: "/";
        padding: 0 5px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid newsletter-container" id="newsletterCompilerApp">
    <!-- Add breadcrumb navigation -->
    <div class="breadcrumb-container">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/analysis">Analysis</a></li>
            <li class="breadcrumb-item active">Newsletter Compiler</li>
        </ol>
    </div>

    <h1>Newsletter Compiler</h1>
    
    <!-- Row 1: Newsletter Configuration -->
    <div class="row mb-4">
        <div class="col-md-12">
            <!-- Newsletter Configuration Form -->
            <div class="card">
                <div class="card-header">
                    <h5>Newsletter Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="newsletterForm">
                        <div class="form-group">
                            <label for="frequency">Frequency:</label>
                            <select class="form-control" id="frequency" name="frequency" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="topics">Topics:</label>
                            <select class="form-control" id="topics" name="topics" multiple required>
                                <!-- Will be populated via API -->
                                <option value="" disabled>Loading topics...</option>
                            </select>
                            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple topics</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Content Types:</label>
                            <div class="mb-2">
                                <button type="button" id="selectAllContentTypes" class="btn btn-sm btn-primary">Select All</button>
                            </div>
                            <table class="table table-borderless" id="contentTypesTable">
                                <tbody>
                                    <tr><td colspan="2" class="text-muted">Loading content types...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-group">
                            <label>Date Range (Optional):</label>
                            <div class="row mb-2">
                                <div class="col-auto">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="dayRangeBtn">Day</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="weekRangeBtn">Week</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="monthRangeBtn">Month</button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="startDate">Start Date:</label>
                                    <input type="date" class="form-control" id="startDate" name="startDate">
                                </div>
                                <div class="col-md-6">
                                    <label for="endDate">End Date:</label>
                                    <input type="date" class="form-control" id="endDate" name="endDate">
                                </div>
                            </div>
                            <small class="form-text text-muted">If not specified, dates will be calculated based on frequency</small>
                        </div>
                        
                        <button type="button" id="compileButton" class="btn btn-primary">Fetch & Compile Content</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 2: Actions -->
    <div class="row mb-4">
        <div class="col-md-12">
            <!-- Action Buttons -->
            <div class="card">
                <div class="card-header">
                    <h5>Actions</h5>
                </div>
                <div class="card-body">
                    <button type="button" id="updatePreviewButton" class="btn btn-secondary mb-2">Update Preview</button>
                    <button type="button" id="downloadMarkdownButton" class="btn btn-success mb-2">Download Markdown</button>
                    <button type="button" id="downloadPdfButton" class="btn btn-info mb-2" disabled>Download PDF (Coming Soon)</button>
                    <button type="button" id="sendEmailButton" class="btn btn-warning mb-2" disabled>Send via Email (Coming Soon)</button>
                    <button type="button" id="sendSlackButton" class="btn btn-dark mb-2" disabled>Send to Slack (Coming Soon)</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading-spinner" id="loadingSpinner" style="display: none; text-align: center; margin: 20px;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p>Compiling newsletter content...</p>
    </div>
    
    <!-- Row 3: Editor and Preview -->
    <div class="row">
        <div class="col-md-6 editor-section">
            <!-- Simple editor container with explicit styling -->
            <div class="card" style="margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div class="card-header" style="background-color: #f8f9fa; padding: 10px 15px;">
                    <h5 class="mb-0">Markdown Editor</h5>
                </div>
                <div class="card-body" style="padding: 0;">
                    <!-- Keep our working textarea -->
                    <textarea id="basic-editor" style="width: 100%; height: 600px; padding: 15px; border: 1px solid #dee2e6;"></textarea>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 editor-section">
            <!-- HTML Preview -->
            <div class="card" style="margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div class="card-header" style="background-color: #f8f9fa; padding: 10px 15px;">
                    <h5 class="mb-0">HTML Preview</h5>
                </div>
                <div class="card-body" style="padding: 15px; height: 600px; overflow-y: auto;">
                    <div id="preview-content" class="preview-container">
                        <p>Preview content will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Keep the working SimpleMDE implementation -->
<script src="https://unpkg.com/simplemde@1.11.2/dist/simplemde.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/simplemde@1.11.2/dist/simplemde.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Add back the marked library for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/lib/marked.umd.min.js"></script>

<script>
// Global variables
let simplemde; // Our SimpleMDE editor instance
const loadingSpinner = document.getElementById('loadingSpinner');
let originalMarkdownContent = ""; // Store the full content with base64

// Initialize SimpleMDE editor
window.onload = function() {
    console.log("Window loaded, initializing SimpleMDE editor");
    
    // Check if the textarea exists
    const textArea = document.getElementById('basic-editor');
    if (!textArea) {
        console.error("Textarea not found");
        return;
    }
    
    // Check if SimpleMDE exists
    if (typeof SimpleMDE === 'undefined') {
        console.error("SimpleMDE library not loaded");
        textArea.value = "SimpleMDE library could not be loaded. Please check your internet connection.";
        return;
    }
    
    try {
        // Initialize SimpleMDE
        simplemde = new SimpleMDE({ 
            element: textArea,
            spellChecker: false,
            autofocus: true,
            placeholder: "Type markdown content here...",
            initialValue: "# Newsletter Content\n\nYour newsletter content will appear here after compilation.",
            toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", 
                     "link", "image", "table", "|", "preview", "side-by-side", "fullscreen"]
        });
        
        console.log("SimpleMDE initialized successfully");
        
        // Save original value method
        const originalGetValue = simplemde.value.bind(simplemde);
        const originalSetValue = simplemde.value;
        
        // Override the value() method to handle base64 images
        simplemde.value = function(val) {
            if (val === undefined) {
                // Getting the value - return original content with base64
                return originalMarkdownContent || originalGetValue();
            } else {
                // Setting the value - store original and set condensed version
                originalMarkdownContent = val;
                
                // Replace base64 content with placeholders in the editor
                const condensedVal = replaceBase64WithPlaceholders(val);
                originalSetValue.call(simplemde, condensedVal);
                
                return simplemde;
            }
        };
        
        // Set up change handler for preview updates
        simplemde.codemirror.on("change", function() {
            // Get editor content (which may have placeholders)
            const editorContent = simplemde.codemirror.getValue();
            
            // If user edited something, update the original content too
            if (editorContent !== replaceBase64WithPlaceholders(originalMarkdownContent)) {
                // Find and restore any image placeholders that might have been edited
                originalMarkdownContent = restorePlaceholdersIfNeeded(editorContent, originalMarkdownContent);
            }
            
            updatePreview();
        });
        
        // Initial preview update
        updatePreview();
        
    } catch (error) {
        console.error("Error initializing SimpleMDE:", error);
        textArea.value = "Error initializing editor: " + error.message;
    }
};

// Function to replace base64 content with placeholders
function replaceBase64WithPlaceholders(markdown) {
    if (!markdown) return markdown;
    
    // Pattern to match Markdown image syntax with base64 data
    const imagePattern = /!\[([^\]]*)\]\(data:image\/[^;]+;base64,([A-Za-z0-9+/=]{30})[A-Za-z0-9+/=]+\)/g;
    
    // Replace with placeholder but keep alt text and image type
    return markdown.replace(imagePattern, (match, altText, base64Start) => {
        return `![${altText}][IMAGE: ${base64Start}...]`;
    });
}

// Function to restore placeholders when needed
function restorePlaceholdersIfNeeded(editorContent, originalContent) {
    if (!editorContent || !originalContent) return originalContent;
    
    // Look for placeholder pattern
    const placeholderPattern = /!\[([^\]]*)\]\[IMAGE: ([A-Za-z0-9+/=]{30})...\]/g;
    
    return editorContent.replace(placeholderPattern, (match, altText, base64Start) => {
        // Try to find the corresponding original image in the stored content
        const originalImagePattern = new RegExp(`!\\[${altText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]\\(data:image\\/[^;]+;base64,${base64Start}[A-Za-z0-9+/=]+\\)`, 'g');
        const originalMatches = originalContent.match(originalImagePattern);
        
        if (originalMatches && originalMatches.length > 0) {
            return originalMatches[0]; // Return the original image markdown with full base64
        }
        
        // If not found, just return the placeholder
        return match;
    });
}

// Function to get markdown content
function getMarkdownContent() {
    if (simplemde) {
        // Return original content with full base64 images
        return originalMarkdownContent || simplemde.value();
    }
    return "";
}

// Function to set markdown content
function setMarkdownContent(markdown) {
    if (simplemde) {
        simplemde.value(markdown);
        updatePreview();
    }
}

// Update the preview from markdown content
function updatePreview() {
    // Use original content with full base64 data for preview
    const markdownContent = getMarkdownContent();
    const previewElement = document.getElementById('preview-content');
    
    if (!markdownContent || !markdownContent.trim()) {
        previewElement.innerHTML = '<p>Preview will appear here...</p>';
        return;
    }
    
    try {
        // Use marked for markdown rendering
        if (typeof marked !== 'undefined') {
            const html = marked.parse(markdownContent);
            previewElement.innerHTML = html;
            
            // Apply image processing to ensure color charts display properly
            const images = previewElement.querySelectorAll('img');
            images.forEach(img => {
                // Fix data URLs - ensure no space after base64,
                if (img.src && img.src.startsWith('data:image') && img.src.includes('base64, ')) {
                    img.src = img.src.replace('base64, ', 'base64,');
                }
                
                // Skip cache busting for data URLs
                if (img.src && !img.src.startsWith('data:') && !img.src.includes('cache=')) {
                    img.src = img.src + (img.src.includes('?') ? '&' : '?') + 'cache=' + new Date().getTime();
                }
                
                // Add specific classes for charts
                if (img.src && (img.src.includes('chart') || img.src.includes('sentiment') || 
                    img.src.includes('radar') || img.alt && (img.alt.includes('Chart') || 
                    img.alt.includes('chart')))) {
                    img.classList.add('newsletter-chart');
                    // Explicitly set dimensions to override any inline styles
                    img.style.maxWidth = '550px';
                    img.style.maxHeight = '400px';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                }
                
                // Add error handler to log any issues with images
                img.onerror = function() {
                    console.error('Error loading image:', this.src);
                    // Replace with error message directly in the image
                    this.style.display = 'inline-block';
                    this.style.padding = '5px';
                    this.style.border = '1px solid #f55';
                    this.style.backgroundColor = '#fee';
                    this.style.color = '#333';
                    this.style.fontStyle = 'italic';
                    this.style.fontSize = '14px';
                    this.style.height = 'auto';
                    this.style.width = 'auto';
                    this.style.minHeight = '50px';
                    this.style.textAlign = 'center';
                    this.style.lineHeight = '50px';
                    this.alt = 'Image failed to load';
                    
                    // Set a data attribute to mark this as an error
                    this.setAttribute('data-load-error', 'true');
                    
                    // Replace the src with a transparent pixel so it stops trying to load
                    // but only if it's not a data URL to avoid recursive errors
                    if (!this.src.startsWith('data:')) {
                        this.src = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';
                    }
                };
            });
        } else {
            // Fallback to basic rendering
            let html = markdownContent
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/\*\*(.*)\*\*/gm, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gm, '<em>$1</em>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/gm, '<a href="$2">$1</a>')
                .replace(/\n/gm, '<br>');
            
            previewElement.innerHTML = html;
        }
    } catch (error) {
        console.error("Error updating preview:", error);
        previewElement.innerHTML = "<p>Error rendering preview: " + error.message + "</p>";
    }
}

// Download markdown content - use full content with base64
function downloadMarkdown() {
    const markdownContent = getMarkdownContent();
    
    if (!markdownContent.trim()) {
        alert('No content to download');
        return;
    }
    
    // Create filename with date
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    const frequency = document.getElementById('frequency').value;
    const topicsSelect = document.getElementById('topics');
    const topics = Array.from(topicsSelect.selectedOptions).map(option => option.value).join('-');
    
    const filename = `${frequency}_${topics || 'newsletter'}_${dateStr}.md`;
    
    // Create download link
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(markdownContent));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    
    // Add to body, click, and remove
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

// Load topics from API
async function loadTopics() {
    try {
        console.log('Starting to fetch topics...');
        const topicsSelect = document.getElementById('topics');
        topicsSelect.innerHTML = '<option value="" disabled>Loading topics...</option>';
        
        // Try multiple endpoints in sequence until one works
        const endpoints = [
            '/api/topics',
            '/api/newsletter/topics',
            '/api/debug/topics'
        ];
        
        let response = null;
        let endpoint = null;
        
        // Try each endpoint in sequence
        for (const ep of endpoints) {
            try {
                console.log(`Trying to fetch from ${ep}...`);
                const tempResponse = await fetch(ep);
                
                if (tempResponse.ok) {
                    response = tempResponse;
                    endpoint = ep;
                    console.log(`Successfully connected to ${ep}`);
                    break;
                } else {
                    console.warn(`Endpoint ${ep} returned status: ${tempResponse.status}`);
                }
            } catch (fetchError) {
                console.warn(`Failed to fetch from ${ep}:`, fetchError);
            }
        }
        
        if (!response) {
            throw new Error(`Failed to fetch topics from any endpoint`);
        }
        
        const data = await response.json();
        
        // Clear select element
        topicsSelect.innerHTML = '';
        
        if (!Array.isArray(data)) {
            console.error('Topics data is not an array:', data);
            topicsSelect.innerHTML = '<option value="" disabled>Error: Invalid data format</option>';
            return;
        }
        
        if (data.length === 0) {
            console.warn('No topics returned from API');
            topicsSelect.innerHTML = '<option value="" disabled>No topics available</option>';
            return;
        }
        
        // Handle different data formats
        data.forEach((topic) => {
            let topicValue, topicText;
            
            if (typeof topic === 'string') {
                topicValue = topic;
                topicText = topic;
            } else if (topic && typeof topic === 'object') {
                topicValue = topic.name || topic.id || "Unknown Topic";
                topicText = topic.displayName || topic.name || topic.id || "Unknown Topic";
            } else {
                return; // Skip invalid format
            }
            
            const option = document.createElement('option');
            option.value = topicValue;
            option.textContent = topicText;
            topicsSelect.appendChild(option);
        });
        
        console.log('Topics loaded successfully');
        
    } catch (error) {
        console.error('Error loading topics:', error);
        const topicsSelect = document.getElementById('topics');
        topicsSelect.innerHTML = '<option value="" disabled>Failed to load topics</option>';
    }
}

// Load content types from API
async function loadContentTypes() {
    try {
        console.log('Fetching content types...');
        const contentTypesTable = document.getElementById('contentTypesTable');
        if (!contentTypesTable) {
            console.error('Content types table element not found');
            return;
        }
        
        // Get the tbody element
        const tbody = contentTypesTable.querySelector('tbody');
        tbody.innerHTML = '<tr><td colspan="2" class="text-muted">Loading content types...</td></tr>';
        
        const response = await fetch('/api/newsletter/content_types');
        
        if (!response.ok) {
            throw new Error(`API returned status: ${response.status}`);
        }
        
        const contentTypes = await response.json();
        
        // Clear container
        tbody.innerHTML = '';
        
        if (!Array.isArray(contentTypes)) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-danger">Error: Invalid data format</td></tr>';
            return;
        }
        
        if (contentTypes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-muted">No content types available</td></tr>';
            return;
        }
        
        // Add checkboxes for each content type with table layout
        contentTypes.forEach(type => {
            const row = document.createElement('tr');
            
            // Create checkbox cell
            const checkboxCell = document.createElement('td');
            checkboxCell.width = '30'; // Fixed width for checkbox cell
            checkboxCell.style.verticalAlign = 'top';
            checkboxCell.style.paddingRight = '0';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `content-type-${type.id}`;
            checkbox.name = 'contentTypes';
            checkbox.value = type.id;
            checkbox.checked = true;
            checkboxCell.appendChild(checkbox);
            
            // Create label cell
            const labelCell = document.createElement('td');
            
            const label = document.createElement('label');
            label.htmlFor = `content-type-${type.id}`;
            label.textContent = type.name || 'Unnamed Type';
            label.style.fontWeight = '500';
            label.style.marginBottom = '0';
            label.style.display = 'block';
            labelCell.appendChild(label);
            
            if (type.description) {
                const description = document.createElement('small');
                description.className = 'text-muted';
                description.textContent = type.description;
                description.style.display = 'block';
                labelCell.appendChild(description);
            }
            
            // Add cells to row
            row.appendChild(checkboxCell);
            row.appendChild(labelCell);
            
            // Add row to table
            tbody.appendChild(row);
        });
        
        // Set initial text for Select All button to "Deselect All" since all are checked by default
        const selectAllBtn = document.getElementById('selectAllContentTypes');
        if (selectAllBtn) {
            selectAllBtn.textContent = 'Deselect All';
        }
        
        console.log('Content types loaded successfully');
        
    } catch (error) {
        console.error('Error loading content types:', error);
        const contentTypesTable = document.getElementById('contentTypesTable');
        if (contentTypesTable) {
            const tbody = contentTypesTable.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-danger">Failed to load content types</td></tr>';
            }
        }
    }
}

// Compile newsletter content
async function compileNewsletter() {
    // Get form values
    const frequency = document.getElementById('frequency').value;
    const topicsSelect = document.getElementById('topics');
    const topics = Array.from(topicsSelect.selectedOptions).map(option => option.value);
    const contentTypes = Array.from(document.querySelectorAll('input[name="contentTypes"]:checked')).map(checkbox => checkbox.value);
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    // Validate form
    if (topics.length === 0) {
        alert('Please select at least one topic');
        return;
    }
    
    if (contentTypes.length === 0) {
        alert('Please select at least one content type');
        return;
    }
    
    // Prepare request payload
    const payload = {
        frequency,
        topics,
        content_types: contentTypes
    };
    
    // Add optional dates if provided
    if (startDate) payload.start_date = startDate;
    if (endDate) payload.end_date = endDate;
    
    // Show loading spinner
    loadingSpinner.style.display = 'block';
    
    try {
        console.log('Sending request to /api/newsletter/compile with payload:', JSON.stringify(payload));
        const response = await fetch('/api/newsletter/compile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error response:', errorText);
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Received response:', data);
        
        // Update markdown editor with compiled content
        setMarkdownContent(data.compiled_markdown || '');
        
    } catch (error) {
        console.error('Error compiling newsletter:', error);
        setMarkdownContent(`# Error Compiling Newsletter\n\n${error.message}\n\nPlease try again or check the browser console for more details.`);
    } finally {
        // Hide loading spinner
        loadingSpinner.style.display = 'none';
    }
}

// Initialize everything when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up event listeners');
    
    // Load data from APIs
    loadTopics();
    loadContentTypes();
    
    // Set up event listeners for buttons
    
    // Compile button
    const compileButton = document.getElementById('compileButton');
    if (compileButton) {
        compileButton.addEventListener('click', compileNewsletter);
    }
    
    // Update preview button
    const updatePreviewButton = document.getElementById('updatePreviewButton');
    if (updatePreviewButton) {
        updatePreviewButton.addEventListener('click', updatePreview);
    }
    
    // Download markdown button
    const downloadMarkdownButton = document.getElementById('downloadMarkdownButton');
    if (downloadMarkdownButton) {
        downloadMarkdownButton.addEventListener('click', downloadMarkdown);
    }
    
    // Select all content types button - set initial text and handling
    const selectAllContentTypes = document.getElementById('selectAllContentTypes');
    if (selectAllContentTypes) {
        // Initial text will be set after content types are loaded
        
        selectAllContentTypes.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('input[name="contentTypes"]');
            
            // Check if all are already checked
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            // Toggle the checked state based on current state
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            // Update button text
            this.textContent = allChecked ? 'Select All' : 'Deselect All';
        });
    }
    
    // Date range buttons
    function setDateRange(days) {
        const today = new Date();
        const endDate = today.toISOString().split('T')[0];
        const start = new Date(today);
        start.setDate(today.getDate() - days);
        const startDate = start.toISOString().split('T')[0];
        
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        if (startDateInput) startDateInput.value = startDate;
        if (endDateInput) endDateInput.value = endDate;
    }
    
    const dayRangeBtn = document.getElementById('dayRangeBtn');
    if (dayRangeBtn) {
        dayRangeBtn.addEventListener('click', function() { setDateRange(1); });
    }
    
    const weekRangeBtn = document.getElementById('weekRangeBtn');
    if (weekRangeBtn) {
        weekRangeBtn.addEventListener('click', function() { setDateRange(7); });
    }
    
    const monthRangeBtn = document.getElementById('monthRangeBtn');
    if (monthRangeBtn) {
        monthRangeBtn.addEventListener('click', function() { setDateRange(30); });
    }
});
</script>
{% endblock %} 