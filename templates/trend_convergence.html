{% extends "base.html" %}

{% block title %}Trend Convergence Analysis - AuNoo AI{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced theme with glass morphism effects */
    :root {
        --primary-color: #FF69B4;
        --primary-dark: #FF1493;
        --primary-gradient: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%);
        --text-color: #333;
        --container-width: 1200px;
        --spacing-md: 1rem;
        --bg-light: #f8f9fa;
        --bg-white: #ffffff;
        --border-color: #dee2e6;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: var(--bg-light);
        color: var(--text-color);
        min-height: 100vh;
    }
    html { overflow-y: scroll; }
    body.modal-open { overflow: hidden !important; overscroll-behavior: contain; }


    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
        z-index: 1;
    }
    
    .header {
        text-align: center;
        margin-bottom: 40px;
        animation: fadeInDown 1s ease-out;
    }

    .header::before {
        display: none; /* remove rotating conic gradient */
    }
    
    .header h1 {
        font-size: 2.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: bold;
        margin-bottom: 8px;
        position: relative;
        z-index: 1;
    }
    
    .header .subtitle {
        font-size: 1.2rem;
        color: #666;
        font-weight: 600;
        margin-bottom: 6px;
        position: relative;
        z-index: 1;
    }
    
    .header p {
        font-size: 1rem;
        color: #888;
        max-width: 700px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Enhanced form styling with glass effects */
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid var(--border-color);
        padding: 0.5rem 0.75rem;
        transition: all 0.2s ease;
        background: var(--bg-white);
        color: var(--text-color);
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
        background: var(--bg-white);
        color: var(--text-color);
    }

    .form-control option, .form-select option {
        background: var(--bg-white);
        color: var(--text-color);
    }

    .btn {
        border-radius: 12px;
        padding: 0.75rem 1.25rem;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        position: relative;
        overflow: hidden;

        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        /* Default button styling to ensure visibility */
        border: 1px solid rgba(108, 117, 125, 0.3);
        background: rgba(108, 117, 125, 0.1);
        color: var(--text-color);
        text-decoration: none;
    }

    .btn:hover:not(.btn-primary):not(.btn-secondary):not(.btn-success):not(.btn-outline-primary):not(.btn-outline-secondary):not(.btn-outline-danger):not(.btn-outline-info) {
        background: rgba(108, 117, 125, 0.2);
        color: var(--text-color);
        transform: translateY(-2px) scale(1.02);
        text-decoration: none;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: var(--primary-gradient);
        border: 1px solid rgba(255, 105, 180, 0.3);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #FF1493 0%, #C71585 100%);
        border-color: rgba(255, 105, 180, 0.5);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 15px 35px rgba(255, 105, 180, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: 1px solid rgba(40, 167, 69, 0.3);
        color: white;
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        border: 1px solid rgba(108, 117, 125, 0.3);
        color: white;

    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
        border-color: rgba(108, 117, 125, 0.5);
        transform: translateY(-2px) scale(1.02);
        color: white;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 15px 35px rgba(40, 167, 69, 0.3);
    }

    .btn-outline-primary {
        background: rgba(255, 105, 180, 0.1);
        border: 1px solid rgba(255, 105, 180, 0.5);
        color: #FF1493;

    }

    .btn-outline-primary:hover {
        background: var(--primary-gradient);
        border-color: rgba(255, 105, 180, 1);
        color: white;
        transform: translateY(-2px) scale(1.02);
    }

    .btn-outline-secondary {
        background: rgba(108, 117, 125, 0.1);
        border: 1px solid rgba(108, 117, 125, 0.5);
        color: #6c757d;

    }

    .btn-outline-danger {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.5);
        color: #dc3545;

    }

    .btn-outline-info {
        background: rgba(23, 162, 184, 0.1);
        border: 1px solid rgba(23, 162, 184, 0.5);
        color: #17a2b8;

    }

    .btn-outline-secondary:hover {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        border-color: rgba(108, 117, 125, 1);
        color: white;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 10px 25px rgba(108, 117, 125, 0.3);
    }

    .btn-outline-danger:hover {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border-color: rgba(220, 53, 69, 1);
        color: white;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 10px 25px rgba(220, 53, 69, 0.3);
    }

    .btn-outline-info:hover {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        border-color: rgba(23, 162, 184, 1);
        color: white;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 10px 25px rgba(23, 162, 184, 0.3);
    }

    /* Fix button close visibility */
    .btn-close {
        background: rgba(0, 0, 0, 0.1) url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='m.293.293 1.414-1.414L8 6.586 14.293.293l1.414 1.414L9.414 8l6.293 6.293-1.414 1.414L8 9.414l-6.293 6.293-1.414-1.414L6.586 8 .293 1.707z'/%3e%3c/svg%3e") center/1em auto no-repeat;
        border: 1px solid rgba(0, 0, 0, 0.2);
        opacity: 0.8;
        border-radius: 6px;

    }

    .btn-close:hover {
        background: rgba(0, 0, 0, 0.2) url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='m.293.293 1.414-1.414L8 6.586 14.293.293l1.414 1.414L9.414 8l6.293 6.293-1.414 1.414L8 9.414l-6.293 6.293-1.414-1.414L6.586 8 .293 1.707z'/%3e%3c/svg%3e") center/1em auto no-repeat;
        opacity: 1;
        transform: scale(1.1);
    }

    /* Ensure all buttons have consistent focus states */
    .btn:focus, .btn-close:focus {
        box-shadow: 0 0 0 0.25rem rgba(255, 105, 180, 0.25);
        outline: 0;
    }

    .loading-spinner {
        text-align: center;
        padding: 40px;
        background: var(--bg-white);

        border-radius: 20px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-soft);
        color: white;
    }
    
    .spinner-border {
        color: #FF69B4;
        width: 3rem;
        height: 3rem;
        border-width: 0.25em;
    }

    .modal-content {
        background: var(--bg-white);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        border-radius: 12px;
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-light);
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        background: var(--bg-light);
    }

    .modal-title {
        color: var(--primary-color);
        font-weight: 600;
    }

    .btn-close {
        color: var(--text-color);
    }

    .btn-close:hover {
        color: var(--primary-color);
    }

    /* Fix modal backdrop issues */
    .modal-backdrop {
        background-color: transparent !important; /* Remove grey dimming */
        pointer-events: none !important; /* Allow clicks to pass through to modal content */
    }

    .modal-backdrop.show {
        opacity: 0 !important; /* Ensure no dimming is visible */
        pointer-events: none !important; /* Ensure backdrop never blocks clicks */
    }

    /* Ensure modal is properly positioned but allow navbar dropdowns to work */
    .modal {
        z-index: 1055;
    }

    .modal-backdrop {
        z-index: 1050;
    }

    /* Ensure modal dialog and content are interactive */
    .modal-dialog {
        position: relative;
        z-index: 1060;
        pointer-events: auto;
    }

    .modal-content {
        position: relative;
        z-index: 1065;
        pointer-events: auto;
    }

    /* Ensure all form elements in modal are interactive */
    .modal .form-control,
    .modal .form-select,
    .modal .btn,
    .modal input,
    .modal select,
    .modal button {
        pointer-events: auto !important;
        position: relative;
        z-index: 1070;
    }
    
    /* Ensure tooltips are above everything including modals */
    .explainability-tooltip {
        z-index: 9999999 !important; /* higher than modals */
    }

    /* Fix Bootstrap column layout blocking in modal */
    .modal .row,
    .modal .col-md-6,
    .modal .col,
    .modal .mb-3 {
        position: relative;
        z-index: 1066;
        pointer-events: auto;
    }

    /* Ensure modal body content is properly layered */
    .modal .modal-body {
        position: relative;
        z-index: 1067;
        pointer-events: auto;
    }

    /* Form labels styling */
    .form-label {
        color: var(--text-color);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    /* Form check elements (checkboxes, switches) */
    .form-check {
        display: block;
        min-height: 1.5rem;
        padding-left: 1.5em;
        margin-bottom: 0.125rem;
    }

    .form-check-input {
        width: 1em;
        height: 1em;
        margin-top: 0.25em;
        margin-left: -1.5em;
        vertical-align: top;
        background-color: var(--bg-white);
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        border: 1px solid var(--border-color);
        -webkit-appearance: none;
        appearance: none;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .form-check-input[type="checkbox"] {
        border-radius: 0.25em;
    }

    .form-check-input:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(255, 105, 180, 0.25);
    }

    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .form-check-input:checked[type="checkbox"] {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e");
    }

    .form-check-label {
        color: var(--text-color);
        cursor: pointer;
    }

    /* Form switch styling */
    .form-switch {
        padding-left: 2.5em;
    }

    .form-switch .form-check-input {
        position: relative;
        width: 2.25em;
        height: 1.25em;
        margin-left: -2.5em;
        background-color: #cfd4da; /* visible track (higher contrast) */
        background-image: none; /* use custom knob */
        background-position: left center;
        border-radius: 2em;
        border: 1px solid #9aa0a6; /* stronger outline for visibility */
        transition: background-position 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
    }

    .form-switch .form-check-input:focus {
        outline: none;
    }

    .form-switch .form-check-input:checked {
        background-position: right center;
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    /* Visible knob */
    .form-switch .form-check-input::after {
        content: '';
        position: absolute;
        top: 0.125em;
        left: 0.15em;
        width: 0.95em;
        height: 0.95em;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        border: 1px solid #9aa0a6; /* knob outline */
        transition: left 0.15s ease-in-out;
    }
    .form-switch .form-check-input:checked::after {
        left: 1.15em;
        border-color: #fff;
    }

    /* High-contrast modal switch fix (white-on-white issue) */
    .modal .form-switch .form-check-input {
        background-color: #adb5bd !important;
        border: 1px solid #6c757d !important;
        background-image: none !important;
    }
    .modal .form-switch .form-check-input::after {
        background: #ffffff !important;
        border: 1px solid #495057 !important;
    }
    .modal .form-switch .form-check-input:checked {
        background-color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
    }
    .modal .form-check-label { color: var(--text-color) !important; }



    .modal-header {
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-light);

    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        background: var(--bg-light);

    }

    .modal-title {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        text-shadow: 0 2px 10px rgba(255, 105, 180, 0.3);
    }

    /* Enhanced Trend Convergence Visualization */
    .convergence-container {
        background: var(--bg-white);

        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-soft);
        padding: 25px;
        margin: 25px 0;
        overflow: visible; /* allow tooltips to overflow */
        position: relative;
        will-change: auto; /* avoid constant reflow on scroll */
        /* contain removed to avoid tooltip clipping across stacking contexts */
    }

    .convergence-container::before {
        content: '';
        position: absolute;
        top: -1px;
        left: -1px;
        right: -1px;
        bottom: -1px;
        background: var(--primary-gradient);
        border-radius: 16px;
        z-index: -1;
        opacity: 0.03;
    }

    .convergence-container:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-hover);
        transition: all 0.3s ease;
    }



    /* Enhanced Strategic Recommendations Section */
    .strategic-recommendations-section {
        margin-top: 30px;
        margin-bottom: 30px;
        position: relative;
        overflow: visible;
    }

    .section-subtitle {
        color: #666;
        margin-bottom: 20px;
        text-align: center;
        font-size: 1rem;
        font-weight: 500;
    }

    .strategic-timeline {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        padding-top: 8px;
        overflow: visible; /* let tooltips escape cards */
        align-items: flex-start; /* prevent cards from stretching to tallest */
        flex-wrap: nowrap; /* keep 3 columns */
    }
    
    .strategic-timeline > .timeline-card {
        flex: 1; /* equal width */
        max-width: calc(33.333% - 8px); /* prevent overflow */
    }

    .timeline-card {
        border-radius: 12px;
        padding: 12px 12px; /* tighter padding */
        color: white;
        position: relative;
        overflow: visible; /* allow tooltips to overflow */
        transition: all 0.3s ease;
        z-index: auto; /* don't create stacking context that traps tooltips */
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 
            0 4px 16px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        min-height: 0; /* allow natural height */
        height: auto; /* size to content */
        align-self: start; /* avoid stretching to tallest */
    }

    .timeline-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.05));
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        z-index: -1;
    }

    .timeline-card.near-term {
        background: linear-gradient(135deg, rgba(255, 105, 180, 0.9) 0%, rgba(255, 20, 147, 0.9) 100%);
    }

    .timeline-card.mid-term {
        background: linear-gradient(135deg, rgba(255, 105, 180, 0.8) 0%, rgba(138, 43, 226, 0.8) 100%);
    }

    .timeline-card.long-term {
        background: linear-gradient(135deg, rgba(138, 43, 226, 0.9) 0%, rgba(75, 0, 130, 0.9) 100%);
    }

    .timeline-card:hover {
        transform: translateY(-1px); /* minimal lift */
        box-shadow: 
            0 15px 35px rgba(255, 105, 180, 0.3),
            0 0 0 1px rgba(255, 255, 255, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .timeline-card:hover::before {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
    }

    .timeline-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px; /* less space below header */
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 4px;
    }

    .timeline-header i {
        font-size: 1.1rem;
    }

    .timeline-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .timeline-content ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 2px; /* tighter spacing between items */
    }

    .timeline-content li {
        padding: 0;
        border-bottom: none; /* remove separators to save vertical space */
        display: flex;
        align-items: flex-start;
        gap: 6px;
        font-size: 0.9rem;
        line-height: 1.15; /* denser lines */
    }

    .timeline-content li:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .timeline-content li::before {
        content: '‚Ä¢';
        color: rgba(255, 255, 255, 0.8);
        font-weight: 700;
        margin-top: 2px;
        flex-shrink: 0;
        font-size: 0.7rem;
        line-height: 1;
    }

    /* Enhanced Executive Framework Section */
    .executive-framework-section {
        margin-top: 30px;
        margin-bottom: 30px;
    }

    .framework-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 10px;
        max-width: 1000px;
        margin: 0 auto;
        overflow: visible;
    }

    .framework-item {
        background: rgba(255, 255, 255, 0.95);

        border-radius: 12px;
        padding: 8px 10px; /* tighter padding */
        border: 1px solid rgba(255, 105, 180, 0.2);
        border-left: 4px solid rgba(255, 105, 180, 0.8);
        transition: all 0.3s ease;
        position: relative;
        overflow: visible;
        z-index: auto; /* don't create stacking context that traps tooltips */
        box-shadow: 
            0 3px 12px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        height: fit-content;
    }

    .framework-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent);
        border-radius: 15px;
        z-index: -1;
    }

    .framework-item:hover {
        transform: translateY(-3px);
        box-shadow: 
            0 15px 35px rgba(255, 105, 180, 0.3),
            0 0 0 1px rgba(255, 105, 180, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border-left-color: rgba(255, 105, 180, 1);
    }

    .framework-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #2d3436;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .framework-description {
        color: #636e72;
        font-size: 0.88rem;
        line-height: 1.3;
        font-weight: 500;
        margin: 0; /* remove extra spacing */
    }

    /* Enhanced Next Steps Section */
    .next-steps-section {
        margin-top: 30px;
        margin-bottom: 30px;
    }

    .next-steps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
        gap: 10px;
        max-width: 900px;
        margin: 0 auto;
        overflow: visible;
    }

    .next-step-item {
        background: rgba(255, 255, 255, 0.95);

        border-radius: 10px;
        padding: 6px 8px; /* tighter padding */
        border: 1px solid rgba(255, 105, 180, 0.15);
        border-left: 4px solid rgba(255, 105, 180, 0.6);
        transition: all 0.3s ease;
        position: relative;
        overflow: visible;
        z-index: auto; /* don't create stacking context that traps tooltips */
        box-shadow: 
            0 3px 12px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        height: fit-content;
    }

    .next-step-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent);
        border-radius: 12px;
        z-index: -1;
    }

    .next-step-item:hover {
        background: rgba(255, 105, 180, 0.12);
        transform: translateX(5px) translateY(-2px);
        box-shadow: 
            0 12px 30px rgba(255, 105, 180, 0.25),
            0 0 0 1px rgba(255, 105, 180, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border-left-color: rgba(255, 105, 180, 0.9);
    }

    .next-step-number {
        display: inline-block;
        background: var(--primary-gradient);
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        text-align: center;
        line-height: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        margin-right: 10px;
        box-shadow: 
            0 3px 10px rgba(255, 105, 180, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        position: relative;

        flex-shrink: 0;
    }

    .next-step-number::before {
        content: '';
        position: absolute;
        top: -1px;
        left: -1px;
        right: -1px;
        bottom: -1px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
        border-radius: 50%;
        z-index: -1;
    }

    .next-step-text {
        color: #495057;
        font-size: 0.9rem;
        line-height: 1.25;
        display: inline;
        font-weight: 500;
    }

    /* Explainability Tooltips */
    .explainable-item {
        position: relative;
        cursor: help;
        transition: all 0.2s ease;
    }
    
    .explainable-item:hover {
        transform: translateY(-1px);
    }

    .explainability-tooltip {
        position: fixed; /* use fixed to escape all containers */
        background: rgba(0, 0, 0, 0.95);
        color: white;
        padding: 15px 20px;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
        white-space: normal;
        max-width: 380px;
        min-width: 220px;
        z-index: 9999999; /* highest z-index */
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        pointer-events: none;
        box-shadow: 
            0 15px 45px rgba(0, 0, 0, 0.6),
            0 0 0 1px rgba(255, 255, 255, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    /* Use a single global tooltip to avoid stacking/overflow within cards */
    /* Keep original tooltips hidden only if global tooltip is present */
    body:has(#globalExplainabilityTooltip) .explainable-item .explainability-tooltip { display: none !important; }
    #globalExplainabilityTooltip.explainability-tooltip { z-index: 2147483647 !important; }

    /* Prevent tooltips from being clipped by any ancestor */
    .strategic-timeline, .framework-grid, .next-steps-grid { 
        overflow: visible; 
        z-index: auto; /* don't create stacking context */
    }
    .framework-item, .next-step-item { 
        overflow: visible; 
    }
    
    /* Ensure main container doesn't create stacking context */
    .container {
        z-index: auto;
    }
    
    /* Ensure cards don't create transform-based stacking contexts on hover */
    .timeline-card:hover,
    .framework-item:hover,
    .next-step-item:hover {
        z-index: auto;
    }

    .explainability-tooltip::before {
        content: '';
        position: absolute;
        top: -1px;
        left: -1px;
        right: -1px;
        bottom: -1px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
        border-radius: 12px;
        z-index: -1;
    }

    .explainability-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
    }

    .explainability-tooltip.tooltip-below::after {
        top: -12px;
        border-top-color: transparent;
        border-bottom-color: rgba(0, 0, 0, 0.9);
    }

    .explainable-item:hover .explainability-tooltip {
        opacity: 1;
        visibility: visible;
    }

    /* Enhanced Explainability icon */
    .explainability-icon {
        display: inline-block;
        margin-left: 10px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        cursor: help;
        padding: 2px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);

    }

    .timeline-content .explainability-icon {
        color: rgba(255, 255, 255, 0.7);
        background: rgba(255, 255, 255, 0.15);
    }

    .framework-item .explainability-icon {
        color: rgba(45, 52, 54, 0.7);
        background: rgba(45, 52, 54, 0.1);
    }

    .next-step-item .explainability-icon {
        color: rgba(73, 80, 87, 0.7);
        background: rgba(73, 80, 87, 0.1);
    }

    .explainable-item:hover .explainability-icon {
        color: #007bff;
        background: rgba(0, 123, 255, 0.15);
        transform: scale(1.2) rotate(5deg);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }



    /* Enhanced Controls */
    .controls-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        background: var(--bg-white);

        border-radius: 20px;
        border: 1px solid var(--border-color);
        padding: 20px 30px;
        box-shadow: var(--shadow-soft);
        position: relative;
    }

    .controls-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
    }

    .btn-square {
        width: 45px;
        height: 45px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        box-shadow: 
            0 4px 15px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);

        position: relative;
        overflow: hidden;
    }

    .btn-square::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }

    .btn-square:hover::before {
        left: 100%;
    }

    .btn-square:hover {
        box-shadow: 
            0 8px 25px rgba(0, 0, 0, 0.2),
            0 0 0 1px rgba(255, 255, 255, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        transform: translateY(-3px) scale(1.05);
    }

    .btn-divider {
        width: 2px;
        height: 30px;
        background: linear-gradient(180deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        margin: 0 8px;
        align-self: center;
        border-radius: 1px;
    }

    /* Enhanced Alert styling */
    .alert {
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);

        position: relative;
        overflow: hidden;
        box-shadow: 
            0 8px 32px rgba(31, 38, 135, 0.37),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .alert::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
        border-radius: 15px;
        z-index: -1;
    }

    .alert-info {
        background: linear-gradient(135deg, rgba(227, 242, 253, 0.9), rgba(243, 229, 245, 0.9));
        color: var(--primary-dark);
        border-left: 4px solid var(--primary-color);
    }

    .alert-success {
        background: linear-gradient(135deg, rgba(232, 245, 232, 0.9), rgba(241, 248, 233, 0.9));
        color: #2e7d32;
        border-left: 4px solid #4caf50;
    }

    .alert-danger {
        background: linear-gradient(135deg, rgba(255, 235, 238, 0.9), rgba(252, 228, 236, 0.9));
        color: #c62828;
        border-left: 4px solid #f44336;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(2deg); }
    }

    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    /* Remove floating animations - not useful */

    /* Add subtle shimmer effect to glass elements */
    .header::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            45deg,
            transparent 30%,
            rgba(255, 255, 255, 0.1) 50%,
            transparent 70%
        );
        background-size: 200% 200%;
        animation: shimmer 8s linear infinite;
        pointer-events: none;
        z-index: 1;
    }
    body.modal-open .header::after { animation: none !important; display: none !important; }
    
    @media (max-width: 768px) {
        body::before {
            background: 
                radial-gradient(circle at 30% 40%, rgba(255, 105, 180, 0.08) 0%, transparent 60%),
                radial-gradient(circle at 70% 60%, rgba(255, 105, 180, 0.05) 0%, transparent 60%);
        }

        .header {
            padding: 25px 18px;
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 2rem;
        }

        .header .subtitle {
            font-size: 1.1rem;
        }

        .header p {
            font-size: 0.95rem;
        }

        .controls-container {
            padding: 15px 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-square {
            width: 40px;
            height: 40px;
        }

        .strategic-timeline {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .timeline-card {
            padding: 16px 14px;
        }

        .framework-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .next-steps-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .explainability-tooltip {
            max-width: 300px;
            font-size: 0.85rem;
            padding: 12px 16px;
            left: 10px;
            right: 10px;
            transform: none;
            margin-bottom: 10px;
        }

        .explainability-tooltip::after {
            left: 30px;
            transform: none;
        }
        
        .explainable-item {
            cursor: pointer;
        }

        .convergence-container {
            padding: 20px 16px;
            margin: 16px 0;
        }

        .modal-content {
            margin: 10px;
            border-radius: 15px;
        }

        .form-control, .form-select {
            padding: 0.6rem 0.8rem;
        }

        .btn {
            padding: 0.6rem 1rem;
        }
    }

    @media (max-width: 480px) {
        .header h1 {
            font-size: 1.8rem;
        }

        .timeline-card, .framework-item, .next-step-item {
            padding: 14px 12px;
        }

        .controls-container {
            padding: 12px 15px;
        }

        .btn-square {
            width: 36px;
            height: 36px;
        }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        :root {
            --text-color: #e9ecef;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.25);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Trend Convergence Analysis</h1>
        <div class="subtitle" id="topicSubtitle">Configure Analysis Below</div>
        <p>AI-powered strategic analysis providing executive recommendations and decision frameworks</p>
    </div>
    
    <!-- Controls -->
    <div class="controls-container">
        <button type="button" class="btn btn-sm btn-square btn-primary" data-bs-toggle="modal" data-bs-target="#configModal" title="Configure Analysis">
            <i class="fas fa-cog"></i>
        </button>
        <button type="button" class="btn btn-sm btn-square btn-success" id="loadAnalysisBtn" onclick="loadTrendConvergenceAnalysis()" disabled title="Generate Analysis">
            <i class="fas fa-play"></i>
        </button>
        <button type="button" class="btn btn-sm btn-square btn-outline-secondary" onclick="clearSavedConfiguration()" title="Clear Cache">
            <i class="fas fa-trash"></i>
        </button>
        <div class="btn-divider"></div>
        <button type="button" class="btn btn-sm btn-square btn-outline-danger" onclick="downloadAsPDF()" title="Download PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button type="button" class="btn btn-sm btn-square btn-outline-info" onclick="downloadAsImage()" title="Download PNG">
            <i class="fas fa-image"></i>
        </button>
    </div>
    
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Generating trend convergence analysis...</p>
    </div>
    
    <div id="errorContainer"></div>
    
    <!-- Add consistency indicator -->
    <div class="consistency-indicator" id="consistencyIndicator" style="display: none;">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Consistency Info:</strong>
            <span id="consistencyMessage"></span>
        </div>
    </div>
    
    <div id="trendConvergenceContainer" style="display: none;">
        <div class="convergence-container">
            <!-- Strategic Recommendations Section -->
            <div class="strategic-recommendations-section" id="strategicRecommendationsSection" style="display: none;">
                <h2 class="mb-4">Strategic Recommendations</h2>
                <p class="section-subtitle">Evidence-based action plan for executive leadership</p>
                
                <div class="strategic-timeline">
                    <div class="timeline-card near-term" id="nearTermCard">
                        <div class="timeline-header">
                            <i class="fas fa-rocket"></i>
                            <h3>NEAR-TERM (2025-2027)</h3>
                        </div>
                        <div class="timeline-content" id="nearTermContent">
                            <!-- Near-term recommendations will be populated -->
                        </div>
                    </div>
                    
                    <div class="timeline-card mid-term" id="midTermCard">
                        <div class="timeline-header">
                            <i class="fas fa-chart-line"></i>
                            <h3>MID-TERM (2027-2032)</h3>
                        </div>
                        <div class="timeline-content" id="midTermContent">
                            <!-- Mid-term recommendations will be populated -->
                        </div>
                    </div>
                    
                    <div class="timeline-card long-term" id="longTermCard">
                        <div class="timeline-header">
                            <i class="fas fa-globe"></i>
                            <h3>LONG-TERM (2032+)</h3>
                        </div>
                        <div class="timeline-content" id="longTermContent">
                            <!-- Long-term recommendations will be populated -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Executive Decision Framework Section -->
            <div class="executive-framework-section" id="executiveFrameworkSection" style="display: none;">
                <h2 class="mb-4">Executive Decision Framework</h2>
                <div class="framework-grid" id="frameworkGrid">
                    <!-- Framework items will be populated -->
                </div>
            </div>
            
            <!-- Next Steps Section -->
            <div class="next-steps-section" id="nextStepsSection" style="display: none;">
                <h2 class="mb-4">Next Steps</h2>
                <div class="next-steps-grid" id="nextStepsGrid">
                    <!-- Next steps will be populated -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configModalLabel">üîç Configure Trend Convergence Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="topic" class="form-label">Topic</label>
                            <select class="form-select" id="topic" required onchange="updateLoadButton()">
                                <option value="">Select a topic...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="timeframe" class="form-label">Analysis Timeframe</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="timeframe" onchange="toggleCustomTimeframe()">
                                    <option value="30d">Last 30 Days</option>
                                    <option value="90d">Last 90 Days</option>
                                    <option value="180d">Last 180 Days</option>
                                    <option value="365d" selected>Last 365 Days</option>
                                    <option value="all">All Time</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="customDays" placeholder="Days" 
                                       style="display: none; width: 80px;" min="1" max="3650">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="model" class="form-label">AI Model</label>
                            <select class="form-select" id="model" onchange="updateLoadButton()">
                                <option value="">Select model...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="analysisDepth" class="form-label">Analysis Depth</label>
                            <select class="form-select" id="analysisDepth">
                                <option value="standard" selected>Standard Analysis</option>
                                <option value="detailed">Detailed Analysis</option>
                                <option value="comprehensive">Comprehensive Analysis</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="organizationalProfile" class="form-label">Organizational Profile</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="organizationalProfile" onchange="handleProfileChange()">
                                    <option value="">Select a profile...</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="showProfileManager()" title="Manage Profiles">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                            <div class="profile-info mt-2" id="profileInfo" style="display: none;">
                                <small class="text-primary">
                                    <i class="fas fa-building me-1"></i>
                                    <span id="profileDetails">No profile selected</span>
                                </small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sampleSizeMode" class="form-label">Article Sample Size</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="sampleSizeMode" onchange="handleSampleSizeModeChange()">
                                    <option value="auto" selected>Auto-size</option>
                                    <option value="balanced">Balanced</option>
                                    <option value="comprehensive">Comprehensive</option>
                                    <option value="focused">Focused</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="customLimit" placeholder="Count" 
                                       style="display: none; width: 100px;" min="10" max="500" value="50">
                            </div>
                            <div class="context-info mt-2" id="contextInfo" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="contextStats">Context: 0 articles, ~0 tokens</span>
                                </small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="consistencyMode" class="form-label">Analysis Consistency</label>
                            <select class="form-select" id="consistencyMode">
                                <option value="deterministic">üéØ Deterministic - Maximum consistency, identical results</option>
                                <option value="low_variance">üé≤ Low Variance - High consistency with minor variations</option>
                                <option value="balanced" selected>‚öñÔ∏è Balanced - Good mix of consistency and insights</option>
                                <option value="creative">üåü Creative - Maximum variation and fresh perspectives</option>
                            </select>
                            <div class="form-text">
                                <small class="text-muted">
                                    Choose based on your needs: <strong>Deterministic</strong> for reports, 
                                    <strong>Creative</strong> for brainstorming, <strong>Balanced</strong> for general use.
                                </small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch" onclick="event.stopPropagation()">
                                <input class="form-check-input" type="checkbox" id="enableCaching" checked onclick="event.stopPropagation()">
                                <label class="form-check-label" for="enableCaching">
                                    Enable Result Caching
                                </label>
                            </div>
                            <div class="form-text">
                                <small class="text-muted">
                                    Cache results to improve response time and ensure consistency for identical parameters.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfigurationAndClose()">
                    <i class="fas fa-save me-2"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Profile Management Modal -->
<div class="modal fade" id="profileManagerModal" tabindex="-1" aria-labelledby="profileManagerModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileManagerModalLabel">üè¢ Organizational Profile Manager</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Profile List -->
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Profiles</h6>
                            <button type="button" class="btn btn-primary btn-sm" onclick="createNewProfile()">
                                <i class="fas fa-plus me-1"></i>New
                            </button>
                        </div>
                        <div class="list-group" id="profileList">
                            <!-- Profiles will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Profile Editor -->
                    <div class="col-md-8">
                        <div id="profileEditor" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0" id="editorTitle">New Profile</h6>
                                <div>
                                    <button type="button" class="btn btn-success btn-sm" onclick="saveProfile()">
                                        <i class="fas fa-save me-1"></i>Save
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelEdit()">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </button>
                                </div>
                            </div>
                            
                            <form id="profileForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileName" class="form-label">Name *</label>
                                            <input type="text" class="form-control" id="profileName" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileIndustry" class="form-label">Industry</label>
                                            <input type="text" class="form-control" id="profileIndustry" 
                                                   placeholder="e.g., Academic Publishing, Technology, Healthcare">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileOrganizationType" class="form-label">Organization Type</label>
                                            <select class="form-select" id="profileOrganizationType">
                                                <option value="">Select type...</option>
                                                <option value="publisher">Publisher</option>
                                                <option value="enterprise">Enterprise</option>
                                                <option value="startup">Startup</option>
                                                <option value="government">Government</option>
                                                <option value="ngo">Non-Profit/NGO</option>
                                                <option value="academic">Academic Institution</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileRiskTolerance" class="form-label">Risk Tolerance</label>
                                            <select class="form-select" id="profileRiskTolerance">
                                                <option value="low">Conservative (Low Risk)</option>
                                                <option value="medium" selected>Balanced (Medium Risk)</option>
                                                <option value="high">Aggressive (High Risk)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileInnovationAppetite" class="form-label">Innovation Appetite</label>
                                            <select class="form-select" id="profileInnovationAppetite">
                                                <option value="conservative">Conservative</option>
                                                <option value="moderate" selected>Moderate</option>
                                                <option value="aggressive">Aggressive</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileRegion" class="form-label">Region</label>
                                            <select class="form-select" id="profileRegion">
                                                <option value="">Select region...</option>
                                                <option value="global">Global</option>
                                                <option value="north_america">North America</option>
                                                <option value="europe">Europe</option>
                                                <option value="asia_pacific">Asia Pacific</option>
                                                <option value="latin_america">Latin America</option>
                                                <option value="middle_east_africa">Middle East & Africa</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileDecisionMakingStyle" class="form-label">Decision Making Style</label>
                                            <select class="form-select" id="profileDecisionMakingStyle">
                                                <option value="collaborative" selected>Collaborative</option>
                                                <option value="data-driven">Data-Driven</option>
                                                <option value="hierarchical">Hierarchical</option>
                                                <option value="agile">Agile</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileDescription" class="form-label">Description</label>
                                            <textarea class="form-control" id="profileDescription" rows="3" 
                                                    placeholder="Brief description of the organization"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileKeyConcerns" class="form-label">Key Concerns</label>
                                            <textarea class="form-control" id="profileKeyConcerns" rows="3" 
                                                    placeholder="Enter concerns separated by commas (e.g., R&D funding, copyright protection, peer review)"></textarea>
                                            <div class="form-text">Separate multiple concerns with commas</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileStrategicPriorities" class="form-label">Strategic Priorities</label>
                                            <textarea class="form-control" id="profileStrategicPriorities" rows="3" 
                                                    placeholder="Enter priorities separated by commas (e.g., digital transformation, market expansion)"></textarea>
                                            <div class="form-text">Separate multiple priorities with commas</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="profileStakeholderFocus" class="form-label">Key Stakeholders</label>
                                            <textarea class="form-control" id="profileStakeholderFocus" rows="2" 
                                                    placeholder="Enter stakeholders separated by commas (e.g., researchers, authors, subscribers)"></textarea>
                                            <div class="form-text">Separate multiple stakeholders with commas</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileCompetitiveLandscape" class="form-label">Competitive Landscape</label>
                                            <textarea class="form-control" id="profileCompetitiveLandscape" rows="2" 
                                                    placeholder="Key competitors and market dynamics (comma-separated)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileRegulatoryEnvironment" class="form-label">Regulatory Environment</label>
                                            <textarea class="form-control" id="profileRegulatoryEnvironment" rows="2" 
                                                    placeholder="Key regulations and compliance requirements (comma-separated)"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="profileCustomContext" class="form-label">Additional Context</label>
                                    <textarea class="form-control" id="profileCustomContext" rows="3" 
                                            placeholder="Any additional context or specific considerations for this organization"></textarea>
                                </div>
                            </form>
                        </div>
                        
                        <div id="profileEditorPlaceholder" class="text-center text-muted py-5">
                            <i class="fas fa-building fa-3x mb-3 opacity-50"></i>
                            <p>Select a profile to edit or create a new one</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Helper function for robust tooltip positioning
function positionTooltip(tooltip, icon) {
    // Force tooltip to be visible first to measure it
    tooltip.style.visibility = 'visible';
    tooltip.style.opacity = '0';
    tooltip.style.display = 'block';
    
    const rect = icon.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;
    
    // Calculate horizontal position (centered on icon)
    let leftPos = rect.left + rect.width / 2;
    
    // Calculate vertical position (above icon by default)
    let topPos = rect.top - tooltipRect.height - 15;
    
    // If tooltip would go above viewport, show it below instead
    if (topPos < 10) {
        topPos = rect.bottom + 15;
        tooltip.classList.add('tooltip-below');
    } else {
        tooltip.classList.remove('tooltip-below');
    }
    
    // Ensure tooltip doesn't go off screen horizontally
    const tooltipWidth = tooltipRect.width;
    if (leftPos - tooltipWidth/2 < 10) {
        leftPos = 10 + tooltipWidth/2;
    } else if (leftPos + tooltipWidth/2 > viewportWidth - 10) {
        leftPos = viewportWidth - 10 - tooltipWidth/2;
    }
    
    tooltip.style.left = leftPos + 'px';
    tooltip.style.top = topPos + 'px';
    tooltip.style.transform = 'translateX(-50%)';
    tooltip.style.zIndex = '999999';
    
    // Now make it fully visible
    requestAnimationFrame(() => {
        tooltip.style.opacity = '1';
        tooltip.style.visibility = 'visible';
    });
}

// Global tooltip element management for top-level stacking
function getGlobalTooltipElement() {
    let tooltip = document.getElementById('globalExplainabilityTooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'globalExplainabilityTooltip';
        tooltip.className = 'explainability-tooltip';
        document.body.appendChild(tooltip);
    }
    return tooltip;
}

function showGlobalTooltip(icon, htmlContent) {
    const tooltip = getGlobalTooltipElement();
    tooltip.innerHTML = htmlContent;
    tooltip.style.display = 'block';
    console.debug('Explainability tooltip: show', {icon});
    positionTooltip(tooltip, icon);
}

function hideGlobalTooltip() {
    const tooltip = document.getElementById('globalExplainabilityTooltip');
    if (tooltip) {
        tooltip.style.opacity = '0';
        tooltip.style.visibility = 'hidden';
        tooltip.style.display = 'none';
        console.debug('Explainability tooltip: hide');
    }
}

// Configuration and state management
let currentAnalysisData = null;

async function loadTrendConvergenceAnalysis() {
    const topicElement = document.getElementById('topic');
    const timeframeElement = document.getElementById('timeframe');
    const modelElement = document.getElementById('model');
    const analysisDepthElement = document.getElementById('analysisDepth');
    
    const loadingSpinner = document.getElementById('loadingSpinner');
    const trendConvergenceContainer = document.getElementById('trendConvergenceContainer');
    
    if (!topicElement || !timeframeElement || !modelElement) {
        showError('Required form elements not found. Please refresh the page.');
        return;
    }
    
    const topic = topicElement.value;
    const timeframe = timeframeElement.value;
    const model = modelElement.value;
    const analysisDepth = analysisDepthElement ? analysisDepthElement.value : 'standard';
    
    if (!topic) {
        showError('Please select a topic');
        return;
    }
    
    if (!model) {
        showError('Please select a model');
        return;
    }
    
    // Get current configuration for caching
    const currentConfig = getCurrentConfiguration();
    
    // Check for cached results first
    const cachedResults = loadCachedResults(currentConfig);
    if (cachedResults && cachedResults.data) {
        console.log('Using cached results for configuration:', currentConfig);
        await displayTrendConvergence(cachedResults.data);
        showSuccess('Loaded cached results (faster response)');
        return;
    }
    
    // Get custom timeframe if selected
    let actualTimeframe = timeframe;
    if (timeframe === 'custom') {
        const customDaysElement = document.getElementById('customDays');
        const customDays = customDaysElement ? parseInt(customDaysElement.value) : null;
        if (!customDays || customDays < 1) {
            showError('Please enter a valid number of days');
            return;
        }
        actualTimeframe = customDays;
    } else {
        // Convert timeframe format
        actualTimeframe = parseInt(timeframe.replace('d', '')) || 365;
    }
    
    // Show loading
    if (loadingSpinner) loadingSpinner.style.display = 'block';
    if (trendConvergenceContainer) trendConvergenceContainer.style.display = 'none';
    
    try {
        // Get sample size parameters
        const sampleSizeMode = document.getElementById('sampleSizeMode').value;
        const customLimit = document.getElementById('customLimit').value;
        const consistencyMode = document.getElementById('consistencyMode').value;
        const enableCaching = document.getElementById('enableCaching').checked;
        
        // Show consistency indicator
        showConsistencyInfo(consistencyMode, enableCaching);
        
        // Build request parameters
        const params = new URLSearchParams({
            timeframe_days: actualTimeframe,
            model: model,
            analysis_depth: analysisDepth,
            sample_size_mode: sampleSizeMode,
            consistency_mode: consistencyMode,
            enable_caching: enableCaching,
            cache_duration_hours: 24
        });
        
        // Add custom limit if specified
        if (sampleSizeMode === 'custom' && customLimit) {
            params.append('custom_limit', customLimit);
        }
        
        // Add organizational profile if specified
        const profileId = document.getElementById('organizationalProfile').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }
        
        const response = await fetch(`/api/trend-convergence/${encodeURIComponent(topic)}?${params}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Cache the results with full configuration
        saveAnalysisResults(data, currentConfig);
        
        await displayTrendConvergence(data);
        
    } catch (error) {
        showError(`Error loading trend convergence analysis: ${error.message}`);
    } finally {
        loadingSpinner.style.display = 'none';
    }
}

async function displayTrendConvergence(data) {
    currentAnalysisData = data;
    
    // Update subtitle with topic
    const topicSubtitle = document.getElementById('topicSubtitle');
    const topic = document.getElementById('topic').value;
    if (topicSubtitle && topic) {
        topicSubtitle.textContent = `Trend Convergence for ${topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
    }
    
    // Populate strategic recommendations
    populateStrategicRecommendations(data.strategic_recommendations || {});
    
    // Populate executive framework
    populateExecutiveFramework(data.executive_decision_framework || {});
    
    // Populate next steps
    populateNextSteps(data.next_steps || []);
    
    // Show the container
    document.getElementById('trendConvergenceContainer').style.display = 'block';
}

// Strategic Recommendations Functions
function populateStrategicRecommendations(recommendations) {
    const section = document.getElementById('strategicRecommendationsSection');
    
    if (!recommendations || Object.keys(recommendations).length === 0) {
        section.style.display = 'none';
        return;
    }
    
    // Populate near-term
    if (recommendations.near_term) {
        populateTimelineCard('nearTermContent', recommendations.near_term);
    }
    
    // Populate mid-term
    if (recommendations.mid_term) {
        populateTimelineCard('midTermContent', recommendations.mid_term);
    }
    
    // Populate long-term
    if (recommendations.long_term) {
        populateTimelineCard('longTermContent', recommendations.long_term);
    }
    
    section.style.display = 'block';
}

function populateTimelineCard(containerId, timeframeData) {
    const container = document.getElementById(containerId);
    if (!container || !timeframeData.trends) return;
    
    const ul = document.createElement('ul');
    timeframeData.trends.forEach((trend, index) => {
        const li = document.createElement('li');
        li.className = 'explainable-item';
        
        const trendText = trend.name || trend.description || trend;
        const explanation = generateTrendExplanation(trend, timeframeData.timeframe, index);
        
        li.innerHTML = `
            ${trendText}
            <i class="fas fa-info-circle explainability-icon"></i>
            <div class="explainability-tooltip">${explanation}</div>
        `;
        
        // Add hover event listeners for proper positioning
        const tooltip = li.querySelector('.explainability-tooltip');
        const icon = li.querySelector('.explainability-icon');
        
        icon.addEventListener('mouseenter', (e) => {
            // Render the tooltip at document.body level to avoid stacking issues
            showGlobalTooltip(icon, tooltip.innerHTML);
        });
        
        icon.addEventListener('mouseleave', (e) => {
            hideGlobalTooltip();
        });
        
        ul.appendChild(li);
    });
    
    container.innerHTML = '';
    container.appendChild(ul);
}

function populateExecutiveFramework(framework) {
    const section = document.getElementById('executiveFrameworkSection');
    const grid = document.getElementById('frameworkGrid');
    
    if (!framework || !framework.principles || framework.principles.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    grid.innerHTML = '';
    
    framework.principles.forEach((principle, index) => {
        const item = document.createElement('div');
        item.className = 'framework-item explainable-item';
        
        const principleTitle = principle.title || principle.name || 'Strategic Principle';
        const principleDescription = principle.description || principle.content || principle;
        const explanation = generateFrameworkExplanation(principle, index);
        
        item.innerHTML = `
            <div class="framework-title">
                <i class="fas fa-lightbulb"></i>
                ${principleTitle}
                <i class="fas fa-info-circle explainability-icon"></i>
            </div>
            <div class="framework-description">
                ${principleDescription}
            </div>
            <div class="explainability-tooltip">${explanation}</div>
        `;
        
        // Add hover event listeners for proper positioning
        const tooltip = item.querySelector('.explainability-tooltip');
        const icon = item.querySelector('.explainability-icon');
        
        icon.addEventListener('mouseenter', (e) => {
            showGlobalTooltip(icon, tooltip.innerHTML);
        });
        
        icon.addEventListener('mouseleave', (e) => {
            hideGlobalTooltip();
        });
        
        grid.appendChild(item);
    });
    
    section.style.display = 'block';
}

function populateNextSteps(nextSteps) {
    const section = document.getElementById('nextStepsSection');
    const grid = document.getElementById('nextStepsGrid');
    
    if (!nextSteps || nextSteps.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    grid.innerHTML = '';
    
    nextSteps.forEach((step, index) => {
        const item = document.createElement('div');
        item.className = 'next-step-item explainable-item';
        
        const stepText = typeof step === 'string' ? step : (step.description || step.action || step.name || 'Action item');
        const explanation = generateNextStepExplanation(step, index);
        
        item.innerHTML = `
            <span class="next-step-number">${index + 1}</span>
            <span class="next-step-text">${stepText}</span>
            <i class="fas fa-info-circle explainability-icon"></i>
            <div class="explainability-tooltip">${explanation}</div>
        `;
        
        // Add hover event listeners for proper positioning
        const tooltip = item.querySelector('.explainability-tooltip');
        const icon = item.querySelector('.explainability-icon');
        
        icon.addEventListener('mouseenter', (e) => {
            showGlobalTooltip(icon, tooltip.innerHTML);
        });
        
        icon.addEventListener('mouseleave', (e) => {
            hideGlobalTooltip();
        });
        
        grid.appendChild(item);
    });
    
    section.style.display = 'block';
}

// Enhanced Explainability Generation Functions with Profile Context
function generateTrendExplanation(trend, timeframe, index) {
    const organizationalProfile = currentAnalysisData?.organizational_profile;
    
    const explanations = {
        'near_term': [
            'Based on current market data and immediate technological developments',
            'Derived from recent regulatory changes and industry adoption patterns',
            'Identified through analysis of current investment flows and business initiatives',
            'Supported by emerging consumer behavior patterns and market signals'
        ],
        'mid_term': [
            'Projected from technological maturation cycles and infrastructure development',
            'Based on regulatory roadmaps and policy implementation timelines',
            'Derived from industry consolidation patterns and competitive dynamics',
            'Supported by demographic shifts and evolving market structures'
        ],
        'long_term': [
            'Extrapolated from fundamental technological and societal shifts',
            'Based on generational changes and long-term demographic trends',
            'Derived from potential breakthrough technologies and paradigm shifts',
            'Supported by historical patterns of innovation adoption and market evolution'
        ]
    };
    
    const timeframeKey = timeframe?.includes('2025-2027') ? 'near_term' : 
                        timeframe?.includes('2027-2032') ? 'mid_term' : 'long_term';
    
    const baseExplanations = explanations[timeframeKey] || explanations['near_term'];
    let explanation = baseExplanations[index % baseExplanations.length];
    
    // Enhance with organizational profile context
    if (organizationalProfile) {
        const profileContext = generateProfileSpecificContext(organizationalProfile, 'trend', timeframeKey);
        explanation += `. ${profileContext}`;
    }
    
    // Add trend-specific context if available
    const trendData = typeof trend === 'object' ? trend : {};
    const confidence = trendData.confidence || 'Medium';
    const sources = trendData.sources ? ` Sources: ${trendData.sources}` : '';
    
    return `${explanation}. Confidence: ${confidence}.${sources}`;
}

function generateProfileSpecificContext(profile, contextType, timeframe) {
    const industry = profile.industry?.toLowerCase() || '';
    const orgType = profile.organization_type?.toLowerCase() || '';
    const keyConcerns = profile.key_concerns || [];
    const riskTolerance = profile.risk_tolerance || 'medium';
    
    let context = '';
    
    // Industry-specific context
    if (industry.includes('publishing') || orgType.includes('publisher')) {
        if (contextType === 'trend') {
            context = `For ${profile.name}, this trend particularly impacts content creation, distribution, and intellectual property management`;
        } else if (contextType === 'framework') {
            context = `In the publishing industry, this principle helps balance editorial excellence with digital transformation needs`;
        } else if (contextType === 'action') {
            context = `This action supports sustainable publishing models while addressing industry-specific challenges`;
        }
    } else if (industry.includes('technology') || industry.includes('tech')) {
        if (contextType === 'trend') {
            context = `This trend affects ${profile.name}'s technology stack, product development, and competitive positioning`;
        } else if (contextType === 'framework') {
            context = `For technology organizations, this principle guides innovation strategy and technical decision-making`;
        } else if (contextType === 'action') {
            context = `This action aligns with technology industry best practices for sustainable growth`;
        }
    } else {
        // Generic organizational context
        if (contextType === 'trend') {
            context = `This trend impacts ${profile.name}'s strategic positioning and operational capabilities`;
        } else if (contextType === 'framework') {
            context = `This principle supports ${profile.name}'s organizational goals and stakeholder expectations`;
        } else if (contextType === 'action') {
            context = `This action aligns with ${profile.name}'s strategic priorities and risk tolerance`;
        }
    }
    
    // Add key concerns context
    if (keyConcerns.length > 0) {
        const primaryConcern = keyConcerns[0];
        context += `, with specific attention to ${primaryConcern.toLowerCase()}`;
    }
    
    // Add risk tolerance context
    if (riskTolerance === 'low') {
        context += `. Recommended approach: Conservative implementation with careful risk assessment`;
    } else if (riskTolerance === 'high') {
        context += `. Recommended approach: Aggressive adoption with calculated risk-taking`;
    } else {
        context += `. Recommended approach: Balanced implementation with measured risk management`;
    }
    
    return context;
}

function generateFrameworkExplanation(principle, index) {
    const organizationalProfile = currentAnalysisData?.organizational_profile;
    
    const explanations = [
        'This principle is derived from analysis of successful strategic implementations across similar market conditions',
        'Based on best practices identified from executive decision-making patterns in comparable scenarios',
        'Developed from organizational behavior research and leadership effectiveness studies',
        'Grounded in risk management frameworks and strategic planning methodologies',
        'Informed by stakeholder analysis and organizational change management principles'
    ];
    
    let baseExplanation = explanations[index % explanations.length];
    
    // Enhance with organizational profile context
    if (organizationalProfile) {
        const profileContext = generateProfileSpecificContext(organizationalProfile, 'framework', 'general');
        baseExplanation += `. ${profileContext}`;
    }
    
    // Add principle-specific context if available
    const principleData = typeof principle === 'object' ? principle : {};
    const applicability = principleData.applicability || 'High';
    const riskLevel = principleData.risk_level || 'Medium';
    
    return `${baseExplanation} Applicability: ${applicability}. Risk Level: ${riskLevel}.`;
}

function generateNextStepExplanation(step, index) {
    const organizationalProfile = currentAnalysisData?.organizational_profile;
    
    const explanations = [
        'Prioritized based on impact-to-effort ratio and strategic alignment with organizational goals',
        'Sequenced according to dependency analysis and resource availability constraints',
        'Ranked by urgency and potential to unlock subsequent strategic initiatives',
        'Ordered by stakeholder readiness and organizational change management capacity',
        'Prioritized based on risk mitigation potential and competitive advantage timing'
    ];
    
    let baseExplanation = explanations[index % explanations.length];
    
    // Enhance with organizational profile context
    if (organizationalProfile) {
        const profileContext = generateProfileSpecificContext(organizationalProfile, 'action', 'general');
        baseExplanation += `. ${profileContext}`;
    }
    
    // Add step-specific context if available
    const stepData = typeof step === 'object' ? step : {};
    const priority = stepData.priority || 'Medium';
    const timeline = stepData.timeline || '3-6 months';
    
    return `${baseExplanation} Priority: ${priority}. Estimated Timeline: ${timeline}.`;
}



// Profile Management Functions
let currentProfiles = [];
let currentEditingProfile = null;

async function loadOrganizationalProfiles() {
    try {
        const response = await fetch('/api/organizational-profiles');
        const data = await response.json();
        
        if (data.success && data.profiles) {
            currentProfiles = data.profiles;
            updateProfileSelect();
            updateProfileList();
            return true;
        } else {
            console.error('Failed to load profiles:', data);
            return false;
        }
    } catch (error) {
        console.error('Error loading profiles:', error);
        return false;
    }
}

function updateProfileSelect() {
    const profileSelect = document.getElementById('organizationalProfile');
    if (!profileSelect) return;
    
    profileSelect.innerHTML = '<option value="">Select a profile...</option>';
    
    currentProfiles.forEach(profile => {
        const option = document.createElement('option');
        option.value = profile.id;
        option.textContent = `${profile.name}${profile.is_default ? ' (Default)' : ''}`;
        profileSelect.appendChild(option);
    });
}

function updateProfileList() {
    const profileList = document.getElementById('profileList');
    if (!profileList) return;
    
    profileList.innerHTML = '';
    
    currentProfiles.forEach(profile => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-start';
        item.innerHTML = `
            <div class="flex-grow-1" onclick="editProfile(${profile.id})" style="cursor: pointer;">
                <h6 class="mb-1">${profile.name}</h6>
                <p class="mb-1 text-muted small">${profile.industry || 'No industry specified'} ‚Ä¢ ${profile.region || 'No region specified'}</p>
                <small class="text-muted">${profile.organization_type || 'No type specified'}</small>
                ${profile.is_default ? '<span class="badge bg-primary">Default</span>' : ''}
            </div>
            <div class="btn-group-vertical btn-group-sm">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="editProfile(${profile.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                ${!profile.is_default ? `<button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteProfile(${profile.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>` : ''}
            </div>
        `;
        profileList.appendChild(item);
    });
}

function handleProfileChange() {
    const profileId = document.getElementById('organizationalProfile').value;
    const profileInfo = document.getElementById('profileInfo');
    const profileDetails = document.getElementById('profileDetails');
    
    if (profileId) {
        const profile = currentProfiles.find(p => p.id == profileId);
        if (profile) {
            profileDetails.textContent = `${profile.name} - ${profile.industry || 'General'} ‚Ä¢ ${profile.region || 'No region'} (${profile.organization_type || 'Unknown type'})`;
            profileInfo.style.display = 'block';
        }
    } else {
        profileInfo.style.display = 'none';
    }
}

function showProfileManager() {
    loadOrganizationalProfiles().then(() => {
        const modal = new bootstrap.Modal(document.getElementById('profileManagerModal'));
        modal.show();
    });
}

function createNewProfile() {
    currentEditingProfile = null;
    clearProfileForm();
    document.getElementById('editorTitle').textContent = 'New Profile';
    showProfileEditor();
}

function editProfile(profileId) {
    const profile = currentProfiles.find(p => p.id === profileId);
    if (!profile) return;
    
    currentEditingProfile = profile;
    populateProfileForm(profile);
    document.getElementById('editorTitle').textContent = `Edit Profile: ${profile.name}`;
    showProfileEditor();
}

function showProfileEditor() {
    document.getElementById('profileEditorPlaceholder').style.display = 'none';
    document.getElementById('profileEditor').style.display = 'block';
}

function cancelEdit() {
    document.getElementById('profileEditor').style.display = 'none';
    document.getElementById('profileEditorPlaceholder').style.display = 'block';
    clearProfileForm();
    currentEditingProfile = null;
}

function clearProfileForm() {
    document.getElementById('profileName').value = '';
    document.getElementById('profileDescription').value = '';
    document.getElementById('profileIndustry').value = '';
    document.getElementById('profileOrganizationType').value = '';
    document.getElementById('profileRegion').value = '';
    document.getElementById('profileKeyConcerns').value = '';
    document.getElementById('profileStrategicPriorities').value = '';
    document.getElementById('profileRiskTolerance').value = 'medium';
    document.getElementById('profileInnovationAppetite').value = 'moderate';
    document.getElementById('profileDecisionMakingStyle').value = 'collaborative';
    document.getElementById('profileStakeholderFocus').value = '';
    document.getElementById('profileCompetitiveLandscape').value = '';
    document.getElementById('profileRegulatoryEnvironment').value = '';
    document.getElementById('profileCustomContext').value = '';
}

function populateProfileForm(profile) {
    document.getElementById('profileName').value = profile.name || '';
    document.getElementById('profileDescription').value = profile.description || '';
    document.getElementById('profileIndustry').value = profile.industry || '';
    document.getElementById('profileOrganizationType').value = profile.organization_type || '';
    document.getElementById('profileRegion').value = profile.region || '';
    document.getElementById('profileKeyConcerns').value = (profile.key_concerns || []).join(', ');
    document.getElementById('profileStrategicPriorities').value = (profile.strategic_priorities || []).join(', ');
    document.getElementById('profileRiskTolerance').value = profile.risk_tolerance || 'medium';
    document.getElementById('profileInnovationAppetite').value = profile.innovation_appetite || 'moderate';
    document.getElementById('profileDecisionMakingStyle').value = profile.decision_making_style || 'collaborative';
    document.getElementById('profileStakeholderFocus').value = (profile.stakeholder_focus || []).join(', ');
    document.getElementById('profileCompetitiveLandscape').value = (profile.competitive_landscape || []).join(', ');
    document.getElementById('profileRegulatoryEnvironment').value = (profile.regulatory_environment || []).join(', ');
    document.getElementById('profileCustomContext').value = profile.custom_context || '';
}

async function saveProfile() {
    const form = document.getElementById('profileForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const profileData = {
        name: document.getElementById('profileName').value,
        description: document.getElementById('profileDescription').value,
        industry: document.getElementById('profileIndustry').value,
        organization_type: document.getElementById('profileOrganizationType').value,
        region: document.getElementById('profileRegion').value,
        key_concerns: document.getElementById('profileKeyConcerns').value.split(',').map(s => s.trim()).filter(s => s),
        strategic_priorities: document.getElementById('profileStrategicPriorities').value.split(',').map(s => s.trim()).filter(s => s),
        risk_tolerance: document.getElementById('profileRiskTolerance').value,
        innovation_appetite: document.getElementById('profileInnovationAppetite').value,
        decision_making_style: document.getElementById('profileDecisionMakingStyle').value,
        stakeholder_focus: document.getElementById('profileStakeholderFocus').value.split(',').map(s => s.trim()).filter(s => s),
        competitive_landscape: document.getElementById('profileCompetitiveLandscape').value.split(',').map(s => s.trim()).filter(s => s),
        regulatory_environment: document.getElementById('profileRegulatoryEnvironment').value.split(',').map(s => s.trim()).filter(s => s),
        custom_context: document.getElementById('profileCustomContext').value
    };
    
    try {
        let response;
        if (currentEditingProfile) {
            // Update existing profile
            response = await fetch(`/api/organizational-profiles/${currentEditingProfile.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(profileData)
            });
        } else {
            // Create new profile
            response = await fetch('/api/organizational-profiles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(profileData)
            });
        }
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            await loadOrganizationalProfiles();
            cancelEdit();
        } else {
            showError(result.message || 'Failed to save profile');
        }
    } catch (error) {
        console.error('Error saving profile:', error);
        showError('Error saving profile: ' + error.message);
    }
}

async function deleteProfile(profileId) {
    const profile = currentProfiles.find(p => p.id === profileId);
    if (!profile) return;
    
    if (!confirm(`Are you sure you want to delete the profile "${profile.name}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/organizational-profiles/${profileId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            await loadOrganizationalProfiles();
            if (currentEditingProfile && currentEditingProfile.id === profileId) {
                cancelEdit();
            }
        } else {
            showError(result.message || 'Failed to delete profile');
        }
    } catch (error) {
        console.error('Error deleting profile:', error);
        showError('Error deleting profile: ' + error.message);
    }
}

// Configuration management functions (similar to futures cone)
function toggleCustomTimeframe() {
    const timeframe = document.getElementById('timeframe').value;
    const customDays = document.getElementById('customDays');
    
    if (timeframe === 'custom') {
        customDays.style.display = 'block';
        customDays.focus();
    } else {
        customDays.style.display = 'none';
        customDays.value = '';
    }
}

function updateLoadButton() {
    const topic = document.getElementById('topic').value;
    const model = document.getElementById('model').value;
    const loadBtn = document.getElementById('loadAnalysisBtn');
    const configureBtn = document.querySelector('[data-bs-target="#configModal"]');
    
    if (topic && model) {
        loadBtn.disabled = false;
        loadBtn.title = 'Generate Trend Convergence Analysis';
        configureBtn.innerHTML = '<i class="fas fa-check"></i>';
        configureBtn.title = 'Configured';
        configureBtn.classList.remove('btn-primary');
        configureBtn.classList.add('btn-success');
    } else {
        loadBtn.disabled = true;
        loadBtn.title = 'Generate Trend Convergence Analysis';
        configureBtn.innerHTML = '<i class="fas fa-cog"></i>';
        configureBtn.title = 'Configure Analysis';
        configureBtn.classList.remove('btn-success');
        configureBtn.classList.add('btn-primary');
    }
}

function saveConfigurationAndClose() {
    const topic = document.getElementById('topic').value;
    const model = document.getElementById('model').value;
    const timeframe = document.getElementById('timeframe').value;
    const analysisDepth = document.getElementById('analysisDepth').value;
    const sampleSizeMode = document.getElementById('sampleSizeMode').value;
    const customLimit = document.getElementById('customLimit').value;
    const profileId = document.getElementById('organizationalProfile').value;
    const consistencyMode = document.getElementById('consistencyMode').value;
    const enableCaching = document.getElementById('enableCaching').checked;
    
    if (!topic) {
        alert('Please select a topic');
        return;
    }
    
    if (!model) {
        alert('Please select a model');
        return;
    }
    
    const config = {
        topic,
        model,
        timeframe,
        analysisDepth,
        sampleSizeMode,
        customLimit,
        profileId,
        consistencyMode,
        enableCaching,
        timestamp: new Date().toISOString()
    };
    
    // Add custom days if timeframe is custom
    if (timeframe === 'custom') {
        const customDays = document.getElementById('customDays').value;
        if (customDays) {
            config.customDays = customDays;
        }
    }
    
    console.log('Saving configuration:', config);
    localStorage.setItem('trendConvergenceConfig', JSON.stringify(config));
    
    // Close modal
    const modalElement = document.getElementById('configModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
    
    updateLoadButton();
    showSuccess('Configuration saved! You can now generate the trend convergence analysis.');
}

function generateCacheKey(config) {
    const keyData = {
        topic: config.topic,
        timeframe: config.timeframe,
        customDays: config.customDays,
        model: config.model,
        analysisDepth: config.analysisDepth,
        sampleSizeMode: config.sampleSizeMode,
        customLimit: config.customLimit,
        profileId: config.profileId
    };
    
    const configString = JSON.stringify(keyData);
    let hash = 0;
    for (let i = 0; i < configString.length; i++) {
        const char = configString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    
    return `trendConvergenceResults_${Math.abs(hash)}`;
}

function getCurrentConfiguration() {
    const timeframe = document.getElementById('timeframe')?.value || '';
    let customDays = null;
    
    if (timeframe === 'custom') {
        customDays = document.getElementById('customDays')?.value || null;
    }
    
    return {
        topic: document.getElementById('topic')?.value || '',
        timeframe: timeframe,
        customDays: customDays,
        model: document.getElementById('model')?.value || '',
        analysisDepth: document.getElementById('analysisDepth')?.value || 'standard',
        sampleSizeMode: document.getElementById('sampleSizeMode')?.value || 'auto',
        customLimit: document.getElementById('customLimit')?.value || null,
        profileId: document.getElementById('organizationalProfile')?.value || null
    };
}

function saveAnalysisResults(data, config) {
    try {
        const cacheKey = generateCacheKey(config);
        const cacheData = {
            data,
            config,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
        console.log('Analysis results cached successfully with key:', cacheKey);
        
        // Clean up old cache entries (keep only the most recent 5)
        const allKeys = Object.keys(localStorage).filter(key => key.startsWith('trendConvergenceResults_'));
        if (allKeys.length > 5) {
            const cacheEntries = allKeys.map(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    return { key, timestamp: new Date(data.timestamp) };
                } catch (e) {
                    return { key, timestamp: new Date(0) };
                }
            });
            
            cacheEntries.sort((a, b) => b.timestamp - a.timestamp);
            cacheEntries.slice(5).forEach(entry => {
                localStorage.removeItem(entry.key);
                console.log('Removed old cache entry:', entry.key);
            });
        }
    } catch (e) {
        console.warn('Failed to cache analysis results:', e);
    }
}

function loadCachedResults(config) {
    try {
        const cacheKey = generateCacheKey(config);
        const cachedData = localStorage.getItem(cacheKey);
        
        if (cachedData) {
            const cache = JSON.parse(cachedData);
            const cacheAge = new Date() - new Date(cache.timestamp);
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours
            
            if (cacheAge < maxAge) {
                const configMatches = JSON.stringify(cache.config) === JSON.stringify(config);
                if (configMatches) {
                    console.log('Loading cached results from:', cache.timestamp);
                    return cache;
                } else {
                    console.log('Configuration mismatch, cache invalid');
                    localStorage.removeItem(cacheKey);
                }
            } else {
                console.log('Cached results expired, removing...');
                localStorage.removeItem(cacheKey);
            }
        }
    } catch (e) {
        console.warn('Failed to load cached results:', e);
    }
    return null;
}

async function loadSavedConfiguration() {
    try {
        const savedConfig = localStorage.getItem('trendConvergenceConfig');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            
            if (config.topic) document.getElementById('topic').value = config.topic;
            if (config.model) document.getElementById('model').value = config.model;
            if (config.timeframe) {
                document.getElementById('timeframe').value = config.timeframe;
                if (config.timeframe === 'custom' && config.customDays) {
                    document.getElementById('customDays').value = config.customDays;
                    document.getElementById('customDays').style.display = 'block';
                }
            }
            if (config.analysisDepth) document.getElementById('analysisDepth').value = config.analysisDepth;
            if (config.sampleSizeMode) {
                document.getElementById('sampleSizeMode').value = config.sampleSizeMode;
                handleSampleSizeModeChange();
            }
            if (config.customLimit) document.getElementById('customLimit').value = config.customLimit;
            if (config.profileId) {
                document.getElementById('organizationalProfile').value = config.profileId;
                handleProfileChange();
            }
            if (config.consistencyMode) {
                document.getElementById('consistencyMode').value = config.consistencyMode;
            }
            if (config.enableCaching !== undefined) {
                document.getElementById('enableCaching').checked = config.enableCaching;
            }
            
            updateLoadButton();
            return true;
        }
    } catch (e) {
        console.error('Failed to load saved configuration:', e);
    }
    return false;
}

function clearSavedConfiguration() {
    try {
        localStorage.removeItem('trendConvergenceConfig');
        
        const allKeys = Object.keys(localStorage).filter(key => key.startsWith('trendConvergenceResults_'));
        allKeys.forEach(key => {
            localStorage.removeItem(key);
        });
        
        console.log('Cleared all saved configuration and cached results');
        showSuccess(`Configuration and ${allKeys.length} cached result(s) cleared!`);
        
        // Reset form
        document.getElementById('topic').value = '';
        document.getElementById('model').value = '';
        document.getElementById('timeframe').value = '365d';
        document.getElementById('analysisDepth').value = 'standard';
        document.getElementById('sampleSizeMode').value = 'auto';
        document.getElementById('customLimit').value = '50';
        document.getElementById('customDays').style.display = 'none';
        document.getElementById('customLimit').style.display = 'none';
        
        // Hide container
        document.getElementById('trendConvergenceContainer').style.display = 'none';
        document.getElementById('topicSubtitle').textContent = 'Configure Analysis Below';
        
        updateLoadButton();
    } catch (e) {
        console.error('Error clearing configuration:', e);
        showError('Failed to clear configuration. Please try refreshing the page.');
    }
}

// Context limits and sample size calculation (copied from futures cone)
const contextLimits = {
    'gpt-3.5-turbo': 16385,
    'gpt-3.5-turbo-16k': 16385,
    'gpt-4': 8192,
    'gpt-4-32k': 32768,
    'gpt-4-turbo': 128000,
    'gpt-4-turbo-preview': 128000,
    'gpt-4o': 128000,
    'gpt-4o-mini': 128000,
    'gpt-4.1': 1000000,
    'gpt-4.1-mini': 1000000,
    'gpt-4.1-nano': 1000000,
    'claude-3-opus': 200000,
    'claude-3-sonnet': 200000,
    'claude-3-haiku': 200000,
    'claude-3.5-sonnet': 200000,
    'claude-4': 200000,
    'claude-4-opus': 200000,
    'claude-4-sonnet': 200000,
    'claude-4-haiku': 200000,
    'gemini-pro': 32768,
    'gemini-1.5-pro': 2097152,
    'llama-2-70b': 4096,
    'llama-3-70b': 8192,
    'mixtral-8x7b': 32768,
    'default': 16385
};

function handleSampleSizeModeChange() {
    const mode = document.getElementById('sampleSizeMode').value;
    const customLimit = document.getElementById('customLimit');
    
    if (mode === 'custom') {
        customLimit.style.display = 'block';
        customLimit.focus();
    } else {
        customLimit.style.display = 'none';
    }
    
    updateContextInfo();
}

function calculateOptimalSampleSize(model, message) {
    const mode = document.getElementById('sampleSizeMode').value;
    
    if (mode === 'custom') {
        return parseInt(document.getElementById('customLimit').value) || 50;
    }
    
    const contextLimit = contextLimits[model] || contextLimits.default;
    const isMegaContext = contextLimit >= 1000000;
    
    let baseSampleSize;
    switch (mode) {
        case 'focused':
            baseSampleSize = isMegaContext ? 50 : 25;
            break;
        case 'balanced':
            baseSampleSize = isMegaContext ? 100 : 50;
            break;
        case 'comprehensive':
            baseSampleSize = isMegaContext ? 200 : 100;
            break;
        case 'auto':
        default:
            const messageComplexity = (message?.length || 0) > 200 ? 1.2 : 1.0;
            let baseSize = isMegaContext ? 150 : 75;
            
            if (message && message.includes('trend convergence')) {
                baseSize = isMegaContext ? 180 : 90;
            }
            
            baseSampleSize = Math.round(baseSize * messageComplexity);
            break;
    }
    
    const maxLimit = isMegaContext ? 1000 : 400;
    const minLimit = 20;
    
    return Math.max(minLimit, Math.min(baseSampleSize, maxLimit));
}

function estimateTokens(text) {
    return Math.ceil((text?.length || 0) / 4);
}

function updateContextInfo() {
    const contextInfo = document.getElementById('contextInfo');
    const contextStats = document.getElementById('contextStats');
    
    if (!contextInfo || !contextStats) {
        return;
    }
    
    const model = document.getElementById('model')?.value;
    const message = 'trend convergence analysis';
    
    if (!model) {
        contextInfo.style.display = 'none';
        return;
    }
    
    const sampleSize = calculateOptimalSampleSize(model, message);
    const contextLimit = contextLimits[model] || contextLimits.default;
    
    const systemTokens = 600;
    const messageTokens = estimateTokens(message);
    const tokensPerArticle = 180;
    const articleTokens = sampleSize * tokensPerArticle;
    const totalTokens = systemTokens + messageTokens + articleTokens;
    
    const contextUsage = (totalTokens / contextLimit) * 100;
    
    const modelIndicator = contextLimit >= 1000000 ? ' üöÄ1M' : 
                          contextLimit >= 200000 ? ' ‚ö°200K' : 
                          contextLimit >= 100000 ? ' üí´100K' : '';
    
    const contextText = `Context: ${sampleSize} articles, ~${totalTokens.toLocaleString()} tokens (${contextUsage.toFixed(1)}%)${modelIndicator}`;
    contextStats.textContent = contextText;
    
    if (contextUsage > 90) {
        contextStats.style.color = '#dc3545';
        contextStats.style.fontWeight = 'bold';
    } else if (contextUsage > 70) {
        contextStats.style.color = '#fd7e14';
        contextStats.style.fontWeight = '600';
    } else if (contextUsage > 50) {
        contextStats.style.color = '#28a745';
        contextStats.style.fontWeight = '500';
    } else {
        contextStats.style.color = '#007bff';
        contextStats.style.fontWeight = '500';
    }
    
    contextInfo.style.display = 'block';
}

function showSuccess(message) {
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
    
    setTimeout(() => {
        const alert = errorContainer.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}

function showError(message) {
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
}

// Download Functions
async function downloadAsPDF() {
    try {
        showSuccess('Generating PDF... Please wait.');
        
        // Check if html2canvas and jsPDF are available
        if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
            // Load libraries dynamically
            await loadDownloadLibraries();
        }
        
        const { jsPDF } = window.jspdf;
        const analysisContainer = document.getElementById('trendConvergenceContainer');
        
        if (!analysisContainer || analysisContainer.style.display === 'none') {
            showError('No analysis to download. Please generate an analysis first.');
            return;
        }

        // Create a container with just the title and analysis content
        const exportContainer = document.createElement('div');
        exportContainer.style.cssText = `
            background: white;
            padding: 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
        `;
        
        // Add title
        const title = document.createElement('h1');
        title.style.cssText = `
            color: #FF69B4;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        `;
        title.innerHTML = '<i style="margin-right: 10px;">üîÆ</i>Trend Convergence Analysis';
        exportContainer.appendChild(title);
        
        // Add subtitle if available
        const subtitle = document.createElement('p');
        subtitle.style.cssText = `
            color: #666;
            font-size: 16px;
            text-align: center;
            margin-bottom: 30px;
        `;
        subtitle.textContent = 'Strategic planning and executive decision framework';
        exportContainer.appendChild(subtitle);
        
        // Clone the analysis content
        const clonedContent = analysisContainer.cloneNode(true);
        
        // Ensure all content is visible for export
        clonedContent.style.display = 'block';
        const hiddenElements = clonedContent.querySelectorAll('[style*="display: none"]');
        hiddenElements.forEach(el => el.style.display = 'block');
        
        exportContainer.appendChild(clonedContent);
        
        // Temporarily add to page for rendering
        exportContainer.style.position = 'absolute';
        exportContainer.style.left = '-9999px';
        exportContainer.style.top = '0';
        document.body.appendChild(exportContainer);

        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 500));

        // Generate canvas from the export container
        const canvas = await html2canvas(exportContainer, {
            useCORS: true,
            scale: 1.2,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff',
            removeContainer: true
        });

        // Remove temporary container
        document.body.removeChild(exportContainer);

        // Create PDF
        const imgData = canvas.toDataURL('image/png', 0.95);
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const pdfWidth = 210;
        const pdfHeight = 297;
        const imgWidth = pdfWidth - 20;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        const pageHeight = pdfHeight - 20;
        let y = 10;
        let remainingHeight = imgHeight;
        let sourceY = 0;

        // Add pages as needed
        while (remainingHeight > 0) {
            const heightToAdd = Math.min(remainingHeight, pageHeight);
            const sourceHeight = (heightToAdd / imgHeight) * canvas.height;
            
            const pageCanvas = document.createElement('canvas');
            pageCanvas.width = canvas.width;
            pageCanvas.height = sourceHeight;
            const pageCtx = pageCanvas.getContext('2d');
            
            pageCtx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);
            
            if (sourceY > 0) {
                pdf.addPage();
            }
            
            const pageImgData = pageCanvas.toDataURL('image/png', 0.95);
            pdf.addImage(pageImgData, 'PNG', 10, y, imgWidth, heightToAdd);
            
            remainingHeight -= heightToAdd;
            sourceY += sourceHeight;
            y = 10;
        }

        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const topic = getSelectedTopic() || 'trend-convergence';
        const filename = `trend-convergence-${topic}-${timestamp}.pdf`;
        
        pdf.save(filename);
        showSuccess('PDF analysis downloaded successfully!');
        
    } catch (error) {
        console.error('Error generating PDF:', error);
        showError('Failed to generate PDF: ' + error.message);
    }
}

async function downloadAsImage() {
    try {
        showSuccess('Generating image... Please wait.');
        
        // Check if html2canvas is available
        if (typeof html2canvas === 'undefined') {
            await loadDownloadLibraries();
        }
        
        const analysisContainer = document.getElementById('trendConvergenceContainer');
        
        if (!analysisContainer || analysisContainer.style.display === 'none') {
            showError('No analysis to download. Please generate an analysis first.');
            return;
        }

        // Create a container with just the title and analysis content
        const exportContainer = document.createElement('div');
        exportContainer.style.cssText = `
            background: white;
            padding: 40px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
        `;
        
        // Add title
        const title = document.createElement('h1');
        title.style.cssText = `
            color: #FF69B4;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        `;
        title.innerHTML = '<i style="margin-right: 10px;">üîÆ</i>Trend Convergence Analysis';
        exportContainer.appendChild(title);
        
        // Add subtitle
        const subtitle = document.createElement('p');
        subtitle.style.cssText = `
            color: #666;
            font-size: 18px;
            text-align: center;
            margin-bottom: 40px;
        `;
        subtitle.textContent = 'Strategic planning and executive decision framework';
        exportContainer.appendChild(subtitle);
        
        // Clone the analysis content
        const clonedContent = analysisContainer.cloneNode(true);
        
        // Ensure all content is visible for export
        clonedContent.style.display = 'block';
        const hiddenElements = clonedContent.querySelectorAll('[style*="display: none"]');
        hiddenElements.forEach(el => el.style.display = 'block');
        
        exportContainer.appendChild(clonedContent);
        
        // Temporarily add to page for rendering
        exportContainer.style.position = 'absolute';
        exportContainer.style.left = '-9999px';
        exportContainer.style.top = '0';
        document.body.appendChild(exportContainer);

        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 500));

        // Generate canvas
        const canvas = await html2canvas(exportContainer, {
            useCORS: true,
            scale: 2,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff',
            removeContainer: true
        });

        // Remove temporary container
        document.body.removeChild(exportContainer);

        // Create download link
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const topic = getSelectedTopic() || 'trend-convergence';
        const filename = `trend-convergence-${topic}-${timestamp}.png`;
        
        link.download = filename;
        link.href = canvas.toDataURL('image/png', 0.95);
        link.click();
        
        showSuccess('Image analysis downloaded successfully!');
        
    } catch (error) {
        console.error('Error generating image:', error);
        showError('Failed to generate image: ' + error.message);
    }
}

async function loadDownloadLibraries() {
    return new Promise((resolve, reject) => {
        let scriptsLoaded = 0;
        const totalScripts = 2;
        
        function checkComplete() {
            scriptsLoaded++;
            if (scriptsLoaded === totalScripts) {
                resolve();
            }
        }
        
        // Load html2canvas
        if (typeof html2canvas === 'undefined') {
            const script1 = document.createElement('script');
            script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script1.onload = checkComplete;
            script1.onerror = reject;
            document.head.appendChild(script1);
        } else {
            checkComplete();
        }
        
        // Load jsPDF
        if (typeof window.jspdf === 'undefined') {
            const script2 = document.createElement('script');
            script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script2.onload = checkComplete;
            script2.onerror = reject;
            document.head.appendChild(script2);
        } else {
            checkComplete();
        }
    });
}

function getSelectedTopic() {
    const topicSelect = document.getElementById('topic');
    return topicSelect ? topicSelect.value : null;
}

// Initialize page
window.addEventListener('load', async function() {
    try {
        console.log('üîÑ Starting page initialization...');
        
        // Load topics
        console.log('üìä Loading topics from /api/forecast-charts/topics...');
        let topicsData = null;
        try {
            const topicsResponse = await fetch('/api/forecast-charts/topics');
            console.log('üìä Topics response status:', topicsResponse.status);
            if (!topicsResponse.ok) {
                throw new Error(`HTTP ${topicsResponse.status}: ${topicsResponse.statusText}`);
            }
            topicsData = await topicsResponse.json();
            console.log('üìä Topics data:', topicsData);
        } catch (error) {
            console.error('‚ùå Failed to load topics:', error);
            topicsData = { success: false, topics: [] };
        }
        
        const topicSelect = document.getElementById('topic');
        
        if (topicsData.success && topicsData.topics && topicsData.topics.length > 0) {
            topicSelect.innerHTML = '<option value="">Select a topic...</option>';
            
            topicsData.topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                topicSelect.appendChild(option);
            });
            console.log('‚úÖ Topics loaded successfully:', topicsData.topics.length, 'topics');
        } else {
            console.log('‚ö†Ô∏è No topics found, using fallback');
            // Add fallback topics to ensure modal works
            const fallbackTopics = ['AI and Machine Learning', 'Technology Trends', 'Market Analysis'];
            topicSelect.innerHTML = '<option value="">Select a topic...</option>';
            fallbackTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.toLowerCase().replace(/ /g, '_');
                option.textContent = topic;
                topicSelect.appendChild(option);
            });
            console.log('‚úÖ Fallback topics loaded');
        }

        // Load models  
        console.log('ü§ñ Loading models from /api/ai_models...');
        let models = null;
        try {
            const modelsResponse = await fetch('/api/ai_models');
            console.log('ü§ñ Models response status:', modelsResponse.status);
            if (!modelsResponse.ok) {
                throw new Error(`HTTP ${modelsResponse.status}: ${modelsResponse.statusText}`);
            }
            models = await modelsResponse.json();
            console.log('ü§ñ Models data:', models);
        } catch (error) {
            console.error('‚ùå Failed to load models:', error);
            models = [];
        }
        
        const modelSelect = document.getElementById('model');
        
        if (models && models.length > 0) {
            modelSelect.innerHTML = '<option value="">Select model...</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.provider})`;
                modelSelect.appendChild(option);
            });
            console.log('‚úÖ Models loaded successfully:', models.length, 'models');
        } else {
            console.log('‚ö†Ô∏è No models found, using fallback');
            // Add fallback models to ensure modal works
            const fallbackModels = [
                {name: 'gpt-4o-mini', provider: 'openai'},
                {name: 'gpt-3.5-turbo', provider: 'openai'},
                {name: 'claude-3-haiku', provider: 'anthropic'}
            ];
            modelSelect.innerHTML = '<option value="">Select model...</option>';
            fallbackModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.provider})`;
                modelSelect.appendChild(option);
            });
            console.log('‚úÖ Fallback models loaded');
        }
        
        // Add event listeners for context updates
        modelSelect.addEventListener('change', updateContextInfo);
        document.getElementById('sampleSizeMode').addEventListener('change', updateContextInfo);
        document.getElementById('customLimit').addEventListener('input', updateContextInfo);
        
        // Initialize context info
        updateContextInfo();
        
        // Load organizational profiles
        await loadOrganizationalProfiles();
        
        // Load saved configuration
        setTimeout(async () => {
            await loadSavedConfiguration();
        }, 500);
        
        // Test modal functionality
        console.log('üîç Testing modal functionality...');
        const configModal = document.getElementById('configModal');
        const configButton = document.querySelector('[data-bs-target="#configModal"]');
        
        if (configModal && configButton) {
            console.log('‚úÖ Modal elements found');
            console.log('‚úÖ Bootstrap should be available after window load');
            
            // Debug form elements
            console.log('üîç Checking form elements:');
            const enableCachingElement = document.getElementById('enableCaching');
            console.log('  - enableCaching element found:', !!enableCachingElement);
            if (enableCachingElement) {
                console.log('  - enableCaching type:', enableCachingElement.type);
                console.log('  - enableCaching checked:', enableCachingElement.checked);
                console.log('  - enableCaching display:', window.getComputedStyle(enableCachingElement).display);
                console.log('  - enableCaching visibility:', window.getComputedStyle(enableCachingElement).visibility);
                console.log('  - enableCaching parent:', enableCachingElement.parentElement.className);
            }
                
                // Try to create a modal instance
                try {
                    const testModal = new bootstrap.Modal(configModal, { backdrop: false, keyboard: true });
                    console.log('‚úÖ Bootstrap Modal can be instantiated');
                    
                    // Add event listeners to ensure modal is interactive
                    configModal.addEventListener('shown.bs.modal', function () {
                        console.log('üéØ Modal fully opened and should be interactive');
                        
                        // Quick modal functionality check
                        console.log('üîç Checking modal functionality...');
                        
                        const modal = document.getElementById('configModal');
                        const modalDialog = modal.querySelector('.modal-dialog');
                        const modalContent = modal.querySelector('.modal-content');
                        const topicSelect = document.getElementById('topic');
                        
                        // Check for backdrop elements and fix them
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        console.log('üé≠ Found', backdrops.length, 'backdrop elements:');
                        backdrops.forEach((backdrop, i) => {
                            const backdropStyles = window.getComputedStyle(backdrop);
                            console.log(`  - Backdrop ${i}: z-index=${backdropStyles.zIndex}, pointer-events=${backdropStyles.pointerEvents}`);
                            
                            // FORCE FIX: Make backdrop non-blocking
                            backdrop.style.pointerEvents = 'none';
                            backdrop.style.opacity = '0';
                            backdrop.style.backgroundColor = 'transparent';
                            console.log(`  - üîß Fixed backdrop ${i}: pointer-events none, opacity 0, bg transparent`);
                        });
                        
                        // Check for manual backdrop
                        const manualBackdrop = document.getElementById('manual-backdrop');
                        if (manualBackdrop) {
                            const manualStyles = window.getComputedStyle(manualBackdrop);
                            console.log('üîß Manual backdrop found: z-index=' + manualStyles.zIndex + ', pointer-events=' + manualStyles.pointerEvents);
                        }
                        
                        // Test if form elements are clickable (what actually matters)
                        console.log('üñ±Ô∏è Testing form element functionality:');
                        const clickTestElements = [topicSelect, document.getElementById('model'), document.getElementById('enableCaching')];
                        let allWorking = true;
                        clickTestElements.forEach((el, i) => {
                            if (el) {
                                const rect = el.getBoundingClientRect();
                                const centerX = rect.left + rect.width / 2;
                                const centerY = rect.top + rect.height / 2;
                                const elementAtPoint = document.elementFromPoint(centerX, centerY);
                                const isWorking = el === elementAtPoint || el.contains(elementAtPoint);
                                console.log(`  - ${el.tagName}#${el.id}: ${isWorking ? '‚úÖ CLICKABLE' : '‚ùå BLOCKED'}`);
                                if (!isWorking) allWorking = false;
                            }
                        });
                        console.log(allWorking ? 'üéâ ALL FORM ELEMENTS ARE CLICKABLE!' : '‚ö†Ô∏è Some form elements may have issues');
                        
                        // Force refresh dropdown contents to ensure they're not stuck in loading state
                        const modelSelect = document.getElementById('model');
                        
                        // Check if dropdowns are in loading state and fix them
                        if (topicSelect && topicSelect.options.length <= 1) {
                            console.log('üîÑ Refreshing topics dropdown');
                            const fallbackTopics = ['AI and Machine Learning', 'Technology Trends', 'Market Analysis'];
                            topicSelect.innerHTML = '<option value="">Select a topic...</option>';
                            fallbackTopics.forEach(topic => {
                                const option = document.createElement('option');
                                option.value = topic.toLowerCase().replace(/ /g, '_');
                                option.textContent = topic;
                                topicSelect.appendChild(option);
                            });
                        }
                        
                        if (modelSelect && modelSelect.options.length <= 1) {
                            console.log('üîÑ Refreshing models dropdown');
                            const fallbackModels = [
                                {name: 'gpt-4o-mini', provider: 'openai'},
                                {name: 'gpt-3.5-turbo', provider: 'openai'},
                                {name: 'claude-3-haiku', provider: 'anthropic'}
                            ];
                            modelSelect.innerHTML = '<option value="">Select model...</option>';
                            fallbackModels.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.name;
                                option.textContent = `${model.name} (${model.provider})`;
                                modelSelect.appendChild(option);
                            });
                        }
                        
                        // Force focus to first form element to ensure interactivity
                        const firstInput = configModal.querySelector('select, input, button');
                        if (firstInput) {
                            setTimeout(() => firstInput.focus(), 100);
                        }
                        
                        // Ensure all form elements are enabled and visible
                        const modalFormElements = configModal.querySelectorAll('select, input, button');
                        modalFormElements.forEach(element => {
                            element.disabled = false;
                            element.style.pointerEvents = 'auto';
                            element.style.opacity = '1';
                            element.style.color = 'inherit';
                            element.style.backgroundColor = 'inherit';
                        });
                        
                        // Ensure all modal elements are properly interactive
                        const allModalElements = modal.querySelectorAll('input, select, button, textarea, .col-md-6, .row, .mb-3');
                        allModalElements.forEach(el => {
                            el.style.pointerEvents = 'auto';
                            el.style.position = 'relative';
                        });
                        
                        console.log('üîß Fixed', allModalElements.length, 'modal elements for proper interaction');
                        
                        console.log('‚úÖ Modal elements refreshed and forced interactive');
                    });
                    
                    configModal.addEventListener('show.bs.modal', function () {
                        console.log('üîÑ Modal is opening...');
                    });
                    
                    // Add click handler to configure button for debugging
                    configButton.addEventListener('click', function(e) {
                        console.log('üñ±Ô∏è Configure button clicked');
                        // Additional debugging
                        setTimeout(() => {
                            const modalInstance = bootstrap.Modal.getInstance(configModal);
                            console.log('üîç Modal instance after click:', modalInstance);
                            console.log('üîç Modal element display:', configModal.style.display);
                            console.log('üîç Modal classes:', configModal.className);
                            console.log('üîç Body classes:', document.body.className);
                        }, 500);
                    });
                    
                } catch (error) {
                    console.error('‚ùå Bootstrap Modal instantiation failed:', error);
                }
        } else {
            console.error('‚ùå Modal elements not found:', { configModal, configButton });
        }
        
        console.log('‚úÖ Page initialization completed successfully');
        
    } catch (error) {
        console.error('‚ùå Failed to load data:', error);
        console.error('Error details:', error.message, error.stack);
        showError('Failed to load available data.');
    }
});

// Consistency information display function
function showConsistencyInfo(mode, cachingEnabled) {
    const indicator = document.getElementById('consistencyIndicator');
    const message = document.getElementById('consistencyMessage');
    
    let infoText = '';
    switch(mode) {
        case 'deterministic':
            infoText = 'Using deterministic mode - results will be identical for same parameters.';
            break;
        case 'low_variance':
            infoText = 'Using low variance mode - results will be highly consistent with minor variations.';
            break;
        case 'balanced':
            infoText = 'Using balanced mode - good mix of consistency and fresh insights.';
            break;
        case 'creative':
            infoText = 'Using creative mode - results may vary significantly between runs.';
            break;
    }
    
    if (cachingEnabled) {
        infoText += ' Caching enabled for faster repeated queries.';
    }
    
    message.textContent = infoText;
    indicator.style.display = 'block';
    
    // Hide after 5 seconds
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %} 