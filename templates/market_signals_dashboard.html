{% extends "base.html" %}

{% block title %}Market Signals & Strategic Risks - AuNoo AI{% endblock %}

{% block extra_css %}
<style>
    /* Pink styling to match AuNoo AI theme */
    :root {
        --primary-color: var(--colors-accent-7);
        --primary-dark: var(--colors-accent-10);
        --text-color: var(--colors-neutral-11);
        --container-width: 1200px;
        --spacing-md: 1rem;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .header {
        text-align: center;
        margin-bottom: 40px;
        animation: fadeInDown 1s ease-out;
    }
    
    .header h1 {
        font-size: 3rem;
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .header .subtitle {
        font-size: 1.4rem;
        color: var(--primary-dark);
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .header p {
        font-size: 1.1rem;
        color: var(--colors-neutral-8);
        max-width: 700px;
        margin: 0 auto;
    }

    /* Form styling matching base.html patterns */
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid var(--colors-neutral-5);
        padding: 0.5rem 0.75rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .btn {
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
        transform: translateY(-1px);
    }
    
    .market-signal-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        margin-bottom: 20px;
    }
    
    .market-signal-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    
    .frequency-badge {
        border-radius: 20px;
        padding: 6px 12px;
        font-weight: 600;
        font-size: 0.875rem;
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 60px;
        /* Width will be set dynamically based on count */
        transition: all 0.3s ease;
    }
    
    .frequency-badge .count-indicator {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 0.75rem;
        font-weight: 500;
        min-width: 20px;
        text-align: center;
        margin-left: 6px;
    }
    
    .frequency-high {
        background: linear-gradient(135deg, #ff6b6b, #ff5252);
        color: white;
    }
    
    .frequency-moderate {
        background: linear-gradient(135deg, #ffa726, #ff9800);
        color: white;
    }
    
    .frequency-low {
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: white;
    }
    
    .risk-card {
        background: linear-gradient(135deg, #ffebee, #fce4ec);
        border-left: 4px solid #f44336;
    }
    
    .opportunity-card {
        background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
        border-left: 4px solid #4caf50;
    }
    
    .analyst-quote {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border-left: 4px solid var(--colors-accent-7);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
    }
    
    .analyst-quote::before {
        content: '"';
        font-size: 4rem;
        color: var(--colors-accent-7);
        position: absolute;
        top: -10px;
        left: 15px;
        opacity: 0.3;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px;
    }
    
    .spinner-border {
        color: var(--colors-accent-7);
    }

    /* Alert styling */
    .alert {
        border-radius: 8px;
        border: none;
    }

    .alert-info {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        color: var(--primary-dark);
        border-left: 4px solid var(--primary-color);
    }

    /* Market Signals Table */
    .market-signals-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .market-signals-table th,
    .market-signals-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--colors-neutral-5);
    }

    .market-signals-table th {
        background-color: var(--colors-neutral-2);
        font-weight: 600;
        color: var(--colors-neutral-11);
    }

    /* Risk and Opportunity Cards */
    .risk-opportunity-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    .card-icon {
        font-size: 1.2rem;
        margin-right: 8px;
    }

    .risk-icon {
        color: var(--colors-error-9);
    }

    .opportunity-icon {
        color: var(--colors-success-9);
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }

    .card-description {
        color: var(--colors-neutral-8);
        line-height: 1.5;
        margin-bottom: 10px;
    }

    .card-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        color: #888;
    }

    /* Article Insights Styling */
    .analyst-quote {
        border-left: 4px solid #007bff;
        padding-left: 15px;
        margin-bottom: 20px;
    }

    .quote-text {
        font-style: italic;
        color: var(--colors-neutral-11);
        line-height: 1.6;
        font-size: 1.05rem;
    }

    .quote-source {
        margin-top: 10px;
    }

    .quote-source a {
        color: #007bff;
        transition: color 0.2s;
    }

    .quote-source a:hover {
        color: #0056b3;
        text-decoration: underline !important;
    }

    @media (max-width: 768px) {
        .risk-opportunity-grid {
            grid-template-columns: 1fr;
        }
        
        .card-meta {
            flex-direction: column;
            gap: 5px;
        }
        
        .quote-text {
            font-size: 1rem;
        }
    }

    /* Tooltip Styling */
    .tooltip {
        font-size: 0.875rem;
    }
    
    .tooltip-inner {
        background-color: #2c3e50;
        color: white;
        border-radius: 6px;
        padding: 8px 12px;
        max-width: 300px;
        text-align: left;
        line-height: 1.4;
    }
    
    .tooltip.bs-tooltip-top .tooltip-arrow::before {
        border-top-color: #2c3e50;
    }
    
    .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
        border-bottom-color: #2c3e50;
    }
    
    .tooltip.bs-tooltip-start .tooltip-arrow::before {
        border-left-color: #2c3e50;
    }
    
    .tooltip.bs-tooltip-end .tooltip-arrow::before {
        border-right-color: #2c3e50;
    }
    
    .tooltip-trigger {
        cursor: help;
        text-decoration: underline;
        text-decoration-style: dotted;
        text-decoration-color: var(--colors-neutral-8);
    }
    
    .info-icon {
        color: var(--colors-neutral-8);
        font-size: 0.875rem;
        margin-left: 5px;
        cursor: help;
    }
    
    .info-icon:hover {
        color: var(--colors-neutral-9);
    }

    /* Square button styling */
    .btn-square {
        width: 38px;
        height: 38px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .btn-square:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transform: translateY(-1px);
    }

    .btn-square i {
        font-size: 14px;
        margin: 0;
    }

    /* Button divider */
    .btn-divider {
        width: 1px;
        height: 24px;
        background: var(--colors-neutral-5);
        margin: 0 4px;
        align-self: center;
    }

    /* Controls container animation */
    #controlsContainer {
        transition: all 0.3s ease;
        overflow: hidden;
    }

    #controlsContainer.collapsed {
        opacity: 0;
        max-width: 0;
        margin: 0;
    }

    /* Toggle button */
    #toggleControlsBtn {
        transition: all 0.2s ease;
    }

    #toggleIcon {
        transition: transform 0.2s ease;
    }

    #toggleIcon.rotated {
        transform: rotate(180deg);
    }

    /* Hide market signal analysis when collapsed */
    .market-signal-analysis-hidden {
        display: none !important;
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @media (max-width: 768px) {
        .header h1 {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>
            <i class="fas fa-chart-line me-2"></i>
            Market Signals & Strategic Risks
        </h1>
        <div class="subtitle" id="topicSubtitle">Configure Analysis Below</div>
        <p>AI-powered analysis of market trends, strategic risks, and emerging opportunities</p>
    </div>
    
    <!-- Collapsible Control Bar -->
    <div class="mb-4 d-flex justify-content-center">
        <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleControlsBtn" onclick="toggleControls()" title="Toggle controls">
                <i class="fas fa-chevron-up" id="toggleIcon"></i>
            </button>
            <div id="controlsContainer" class="d-flex gap-1">
                <button type="button" class="btn btn-sm btn-square btn-primary" data-bs-toggle="modal" data-bs-target="#configModal" title="Configure Analysis">
                    <i class="fas fa-cog"></i>
                </button>
                <button type="button" class="btn btn-sm btn-square btn-success" id="loadAnalysisBtn" onclick="loadMarketSignalsAnalysis()" disabled title="Load Analysis">
                    <i class="fas fa-play"></i>
                </button>
                <button type="button" class="btn btn-sm btn-square btn-outline-secondary" onclick="clearSavedConfiguration()" title="Clear Cache">
                    <i class="fas fa-trash"></i>
                </button>
                <div class="btn-divider"></div>
                <button type="button" class="btn btn-sm btn-square btn-outline-danger" onclick="downloadAsPDF()" title="Download PDF">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button type="button" class="btn btn-sm btn-square btn-outline-info" onclick="downloadAsImage()" title="Download PNG">
                    <i class="fas fa-image"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading market signals analysis...</p>
    </div>
    
    <div id="errorContainer"></div>
    
    <div id="marketSignalsContainer" style="display: none;">
                <!-- Market Signal Analysis -->
                <div class="market-signal-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Market Signal Analysis
                            <i class="fas fa-info-circle info-icon" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top"
                               data-bs-title="Analysis of future signals extracted from articles about your selected topic. Each signal represents a potential market scenario with its frequency of mention and expected timeline."></i>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="marketSignalsContent">
                            <table class="market-signals-table">
                                <thead>
                                    <tr>
                                        <th>
                                            Future Signal
                                            <i class="fas fa-question-circle info-icon" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top"
                                               data-bs-title="Market scenarios or trends identified from article analysis. These represent different potential futures mentioned by analysts and experts."></i>
                                        </th>
                                        <th>
                                            Frequency
                                            <i class="fas fa-question-circle info-icon" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top"
                                               data-bs-title="How often this signal appears in the analyzed articles. High = frequently mentioned (strong consensus), Moderate = regularly mentioned, Low = occasionally mentioned."></i>
                                        </th>
                                        <th>
                                            Time to Impact
                                            <i class="fas fa-question-circle info-icon" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top"
                                               data-bs-title="Expected timeline for this scenario to materialize based on expert analysis. Ranges from Immediate (0-1 year) to Long-term (5+ years)."></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="marketSignalsTableBody">
                                    <!-- Signals will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Risk and Opportunity Cards -->
                <div class="risk-opportunity-grid">
                    <div class="market-signal-card risk-card">
                        <div class="card-body">
                            <div class="card-title">
                                <i class="fas fa-exclamation-triangle risk-icon"></i>
                                <span id="criticalRiskTitle">Critical Risk</span>
                                <i class="fas fa-info-circle info-icon" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top"
                                   data-bs-title="AI-generated strategic risks based on market signal analysis. These identify potential threats or challenges that could impact your business or market position."></i>
                            </div>
                            <div id="criticalRiskContent">
                                <!-- Risk content will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="market-signal-card opportunity-card">
                        <div class="card-body">
                            <div class="card-title">
                                <i class="fas fa-lightbulb opportunity-icon"></i>
                                <span id="opportunityTitle">Key Opportunity</span>
                                <i class="fas fa-info-circle info-icon" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top"
                                   data-bs-title="AI-generated strategic opportunities based on market signal analysis. These highlight potential advantages or growth areas you could leverage."></i>
                            </div>
                            <div id="opportunityContent">
                                <!-- Opportunity content will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Risk/Opportunity Cards -->
                <div class="risk-opportunity-grid" id="additionalCards">
                    <!-- Additional cards will be populated here -->
                </div>

                <!-- Key Article Insights -->
                <div class="market-signal-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-newspaper me-2"></i>Key Article Insights
                            <i class="fas fa-info-circle info-icon" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top"
                               data-bs-title="Direct quotes and extracts from analyzed articles with links to original sources. These provide specific insights and evidence supporting the market signals analysis."></i>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="analystQuotes">
                            <!-- Article quotes and links will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configModalLabel">ðŸŽ¯ Configure Market Signals Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="topic" class="form-label">
                                Topic
                                <i class="fas fa-question-circle info-icon" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="right"
                                   data-bs-title="Select the topic area for analysis. Only articles tagged with this topic will be included in the market signals analysis."></i>
                            </label>
                            <select class="form-select" id="topic" required onchange="updateLoadButton()">
                                <option value="">Loading topics...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="timeframe" class="form-label">
                                Analysis Timeframe
                                <i class="fas fa-question-circle info-icon" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="right"
                                   data-bs-title="Time period for article analysis. Shorter timeframes show recent trends, longer periods provide more comprehensive analysis but may include outdated information."></i>
                            </label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="timeframe" onchange="toggleCustomTimeframe()">
                                    <option value="7d">Last 7 Days</option>
                                    <option value="30d">Last 30 Days</option>
                                    <option value="90d">Last 90 Days</option>
                                    <option value="180d">Last 180 Days</option>
                                    <option value="365d" selected>Last 365 Days</option>
                                    <option value="all">All Time</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="customDays" placeholder="Days" 
                                       style="display: none; width: 80px;" min="1" max="3650"
                                       data-bs-toggle="tooltip" 
                                       data-bs-title="Enter custom number of days to analyze (1-3650)">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="model" class="form-label">
                                AI Model
                                <i class="fas fa-question-circle info-icon" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="right"
                                   data-bs-title="AI model used for generating risk/opportunity analysis. Different models may provide varying perspectives and analysis quality."></i>
                            </label>
                            <select class="form-select" id="model" onchange="updateLoadButton()">
                                <option value="">Loading models...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="sampleSizeMode" class="form-label">Article Sample Size</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="sampleSizeMode" onchange="handleSampleSizeModeChange()">
                                    <option value="auto" selected>Auto-size</option>
                                    <option value="balanced">Balanced</option>
                                    <option value="comprehensive">Comprehensive</option>
                                    <option value="focused">Focused</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="customLimit" placeholder="Count" 
                                       style="display: none; width: 100px;" min="10" max="500" value="50">
                            </div>
                            <div class="context-info mt-2" id="contextInfo" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="contextStats">Context: 0 articles, ~0 tokens</span>
                                </small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="analysisDepth" class="form-label">Analysis Depth</label>
                            <select class="form-select" id="analysisDepth">
                                <option value="standard" selected>Standard Analysis</option>
                                <option value="detailed">Detailed Analysis</option>
                                <option value="comprehensive">Comprehensive Analysis</option>
                            </select>
                            <div class="form-text">Choose depth of market signals analysis</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfigurationAndClose()">
                    <i class="fas fa-save me-2"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Libraries for download functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// UI Control Functions
function toggleControls() {
    const controlsContainer = document.getElementById('controlsContainer');
    const toggleIcon = document.getElementById('toggleIcon');
    // Find the market signal analysis card (first card with "Market Signal Analysis" text)
    const marketSignalCard = Array.from(document.querySelectorAll('.market-signal-card')).find(card => 
        card.textContent.includes('Market Signal Analysis')
    );
    
    const isCollapsed = controlsContainer.classList.contains('collapsed');
    
    if (isCollapsed) {
        // Show controls
        controlsContainer.classList.remove('collapsed');
        toggleIcon.classList.remove('rotated');
        if (marketSignalCard) {
            marketSignalCard.classList.remove('market-signal-analysis-hidden');
        }
        localStorage.setItem('marketSignalsControlsCollapsed', 'false');
    } else {
        // Hide controls
        controlsContainer.classList.add('collapsed');
        toggleIcon.classList.add('rotated');
        if (marketSignalCard) {
            marketSignalCard.classList.add('market-signal-analysis-hidden');
        }
        localStorage.setItem('marketSignalsControlsCollapsed', 'true');
    }
}

function restoreControlsState() {
    const isCollapsed = localStorage.getItem('marketSignalsControlsCollapsed') === 'true';
    if (isCollapsed) {
        const controlsContainer = document.getElementById('controlsContainer');
        const toggleIcon = document.getElementById('toggleIcon');
        
        controlsContainer.classList.add('collapsed');
        toggleIcon.classList.add('rotated');
    }
}

async function autoLoadCachedAnalysis() {
    try {
        // Find the most recent cached result
        const allKeys = Object.keys(localStorage).filter(key => key.startsWith('marketSignalsResults_'));
        
        if (allKeys.length === 0) {
            console.log('No cached results found for auto-load');
            return;
        }

        // Get the most recent cache entry
        let latestCache = null;
        let latestTimestamp = 0;
        
        for (const key of allKeys) {
            try {
                const cacheData = JSON.parse(localStorage.getItem(key));
                const timestamp = new Date(cacheData.timestamp).getTime();
                
                if (timestamp > latestTimestamp) {
                    latestTimestamp = timestamp;
                    latestCache = cacheData;
                }
            } catch (e) {
                console.warn('Invalid cache entry:', key, e);
            }
        }

        if (latestCache) {
            console.log('Auto-loading cached result from:', latestCache.timestamp);
            
            // Display the cached analysis
            await displayMarketSignalsAnalysis(latestCache.results);
            
            // Hide the market signal card if controls are collapsed
            const isCollapsed = localStorage.getItem('marketSignalsControlsCollapsed') === 'true';
            if (isCollapsed) {
                setTimeout(() => {
                    const marketSignalCard = Array.from(document.querySelectorAll('.market-signal-card')).find(card => 
                        card.textContent.includes('Market Signal Analysis')
                    );
                    if (marketSignalCard) {
                        marketSignalCard.classList.add('market-signal-analysis-hidden');
                    }
                }, 100);
            }
            
            console.log('Auto-loaded cached analysis successfully');
        } else {
            console.log('No valid cached results found for auto-load');
        }
        
    } catch (error) {
        console.error('Error auto-loading cached result:', error);
    }
}

// Download Functions
async function downloadAsPDF() {
    try {
        showSuccess('Generating PDF... Please wait.');
        
        const { jsPDF } = window.jspdf;
        const marketSignalsContainer = document.getElementById('marketSignalsContainer');
        
        if (!marketSignalsContainer || marketSignalsContainer.style.display === 'none') {
            showError('No analysis results to download. Please load an analysis first.');
            return;
        }

        // Create a container with just the title and analysis content
        const exportContainer = document.createElement('div');
        exportContainer.style.cssText = `
            background: white;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
        `;
        
        // Add title
        const title = document.createElement('h1');
        title.style.cssText = `
            color: var(--colors-accent-7);
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        `;
        title.innerHTML = '<i style="margin-right: 10px;">ðŸ“ˆ</i>Market Signals & Strategic Risks Analysis';
        exportContainer.appendChild(title);
        
        // Add subtitle
        const subtitle = document.createElement('p');
        subtitle.style.cssText = `
            color: var(--colors-neutral-8);
            font-size: 16px;
            text-align: center;
            margin-bottom: 30px;
        `;
        subtitle.textContent = 'AI-powered analysis of market trends, strategic risks, and emerging opportunities';
        exportContainer.appendChild(subtitle);
        
        // Clone the actual analysis content
        if (marketSignalsContainer) {
            const clonedContent = marketSignalsContainer.cloneNode(true);
            
            // Remove any buttons from the cloned content
            const buttons = clonedContent.querySelectorAll('button');
            buttons.forEach(btn => btn.remove());
            
            exportContainer.appendChild(clonedContent);
        }
        
        // Temporarily add to page for rendering
        exportContainer.style.position = 'absolute';
        exportContainer.style.left = '-9999px';
        exportContainer.style.top = '0';
        document.body.appendChild(exportContainer);

        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 500));

        // Generate canvas from the export container
        const canvas = await html2canvas(exportContainer, {
            useCORS: true,
            scale: 1.2,
            logging: false,
            allowTaint: true,
            backgroundColor: 'var(--colors-white)',
            removeContainer: true
        });

        // Remove temporary container
        document.body.removeChild(exportContainer);

        // Create PDF with proper sizing
        const imgData = canvas.toDataURL('image/png', 0.95);
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const pdfWidth = 210;
        const pdfHeight = 297;
        const imgWidth = pdfWidth - 20;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        const pageHeight = pdfHeight - 20;
        let y = 10;
        let remainingHeight = imgHeight;
        let sourceY = 0;

        // Add pages as needed
        while (remainingHeight > 0) {
            const heightToAdd = Math.min(remainingHeight, pageHeight);
            const sourceHeight = (heightToAdd / imgHeight) * canvas.height;
            
            const pageCanvas = document.createElement('canvas');
            pageCanvas.width = canvas.width;
            pageCanvas.height = sourceHeight;
            const pageCtx = pageCanvas.getContext('2d');
            
            pageCtx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);
            
            if (sourceY > 0) {
                pdf.addPage();
            }
            
            const pageImgData = pageCanvas.toDataURL('image/png', 0.95);
            pdf.addImage(pageImgData, 'PNG', 10, y, imgWidth, heightToAdd);
            
            remainingHeight -= heightToAdd;
            sourceY += sourceHeight;
            y = 10;
        }

        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `market-signals-analysis-${timestamp}.pdf`;
        
        pdf.save(filename);
        showSuccess('PDF of analysis data downloaded successfully!');
        
    } catch (error) {
        console.error('Error generating PDF:', error);
        showError('Failed to generate PDF: ' + error.message);
    }
}

async function downloadAsImage() {
    try {
        showSuccess('Generating image... Please wait.');
        
        const marketSignalsContainer = document.getElementById('marketSignalsContainer');
        
        if (!marketSignalsContainer || marketSignalsContainer.style.display === 'none') {
            showError('No analysis results to download. Please load an analysis first.');
            return;
        }

        // Create a container with just the title and analysis content
        const exportContainer = document.createElement('div');
        exportContainer.style.cssText = `
            background: white;
            padding: 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
        `;
        
        // Add title
        const title = document.createElement('h1');
        title.style.cssText = `
            color: var(--colors-accent-7);
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        `;
        title.innerHTML = '<i style="margin-right: 10px;">ðŸ“ˆ</i>Market Signals & Strategic Risks Analysis';
        exportContainer.appendChild(title);
        
        // Add subtitle
        const subtitle = document.createElement('p');
        subtitle.style.cssText = `
            color: var(--colors-neutral-8);
            font-size: 18px;
            text-align: center;
            margin-bottom: 40px;
        `;
        subtitle.textContent = 'AI-powered analysis of market trends, strategic risks, and emerging opportunities';
        exportContainer.appendChild(subtitle);
        
        // Clone the actual analysis content
        if (marketSignalsContainer) {
            const clonedContent = marketSignalsContainer.cloneNode(true);
            
            // Remove any buttons from the cloned content
            const buttons = clonedContent.querySelectorAll('button');
            buttons.forEach(btn => btn.remove());
            
            exportContainer.appendChild(clonedContent);
        }
        
        // Temporarily add to page for rendering
        exportContainer.style.position = 'absolute';
        exportContainer.style.left = '-9999px';
        exportContainer.style.top = '0';
        document.body.appendChild(exportContainer);

        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 500));

        // Generate canvas from the export container
        const canvas = await html2canvas(exportContainer, {
            useCORS: true,
            scale: 2,
            logging: false,
            allowTaint: true,
            backgroundColor: 'var(--colors-white)',
            removeContainer: true
        });

        // Remove temporary container
        document.body.removeChild(exportContainer);

        // Create download link
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `market-signals-analysis-${timestamp}.png`;
        
        link.download = filename;
        link.href = canvas.toDataURL('image/png', 0.95);
        link.click();
        
        showSuccess('Image of analysis data downloaded successfully!');
        
    } catch (error) {
        console.error('Error generating image:', error);
        showError('Failed to generate image: ' + error.message);
    }
}

// Configuration and caching
const contextLimits = {
    'gpt-4': 8192,
    'gpt-4-turbo': 128000,
    'gpt-4o': 128000,
    'gpt-4o-mini': 128000,
    'claude-3-opus': 200000,
    'claude-3-sonnet': 200000,
    'claude-3.5-sonnet': 200000,
    'gemini-pro': 32768,
    'gemini-1.5-pro': 2097152,
    'default': 16385
};

async function loadMarketSignalsAnalysis() {
    const topicElement = document.getElementById('topic');
    const timeframeElement = document.getElementById('timeframe');
    const modelElement = document.getElementById('model');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const marketSignalsContainer = document.getElementById('marketSignalsContainer');
    
    if (!topicElement || !timeframeElement || !modelElement) {
        showError('Required form elements not found. Please refresh the page.');
        return;
    }
    
    const topic = topicElement.value;
    const timeframe = timeframeElement.value;
    const model = modelElement.value;
    
    if (!topic) {
        showError('Please select a topic');
        return;
    }
    
    if (!model) {
        showError('Please select a model');
        return;
    }
    
    // Get current configuration for caching
    const currentConfig = getCurrentConfiguration();
    
    // Check for cached results first with configuration matching
    const cachedResults = loadCachedResults(currentConfig);
    if (cachedResults && cachedResults.analysis) {
        console.log('Using cached results for configuration:', currentConfig);
        await displayMarketSignalsAnalysis(cachedResults.analysis);
        showSuccess('Loaded cached results (faster response)');
        return;
    }
    
    // Get custom timeframe if selected
    let actualTimeframe = timeframe;
    if (timeframe === 'custom') {
        const customDaysElement = document.getElementById('customDays');
        const customDays = customDaysElement ? parseInt(customDaysElement.value) : null;
        if (!customDays || customDays < 1) {
            showError('Please enter a valid number of days');
            return;
        }
        actualTimeframe = customDays;
    } else {
        // Convert timeframe format
        actualTimeframe = parseInt(timeframe.replace('d', '')) || 365;
    }
    
    // Show loading
    if (loadingSpinner) loadingSpinner.style.display = 'block';
    if (marketSignalsContainer) marketSignalsContainer.style.display = 'none';
    
    try {
        const response = await fetch(`/api/executive-summary/market-signals/${encodeURIComponent(topic)}?timeframe_days=${actualTimeframe}&model=${encodeURIComponent(model)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Cache the results with full configuration
        saveAnalysisResults(data, currentConfig);
        
        await displayMarketSignalsAnalysis(data);
        
    } catch (error) {
        showError(`Error loading market signals analysis: ${error.message}`);
    } finally {
        loadingSpinner.style.display = 'none';
    }
}

async function displayMarketSignalsAnalysis(data) {
    // Populate the dashboard
    populateMarketSignals(data.signals || []);
    populateRiskOpportunityCards(data.risks || [], data.opportunities || []);
    populateArticleInsights(data.quotes || []);
    
    document.getElementById('marketSignalsContainer').style.display = 'block';
}

function populateMarketSignals(signals) {
    const tbody = document.getElementById('marketSignalsTableBody');
    tbody.innerHTML = '';
    
    // Calculate min and max counts for width scaling
    const counts = signals.map(s => s.count || 0);
    const maxCount = Math.max(...counts);
    const minCount = Math.min(...counts);
    const countRange = maxCount - minCount || 1; // Avoid division by zero
    
    signals.forEach(signal => {
        const row = document.createElement('tr');
        
        // Create frequency badge with tooltip
        const frequencyTooltips = {
            'High': `This signal appears frequently in analyzed articles (${signal.count || 0} articles), indicating strong consensus or widespread discussion among experts and analysts.`,
            'Moderate': `This signal appears regularly in analyzed articles (${signal.count || 0} articles), suggesting moderate attention and discussion in the market.`,
            'Low': `This signal appears occasionally in analyzed articles (${signal.count || 0} articles), representing emerging or niche perspectives.`
        };
        
        const impactTooltips = {
            'Immediate': 'Expected to impact markets within 0-1 years',
            'Short-term': 'Expected to impact markets within 1-2 years', 
            'Mid-term': 'Expected to impact markets within 2-5 years',
            'Medium-term': 'Expected to impact markets within 2-5 years',
            'Long-term': 'Expected to impact markets beyond 5 years'
        };
        
        // Calculate dynamic width based on count (60px minimum, up to 200px maximum)
        const count = signal.count || 0;
        const normalizedCount = countRange > 0 ? (count - minCount) / countRange : 0;
        const badgeWidth = 60 + (normalizedCount * 140); // 60px base + up to 140px additional
        
        row.innerHTML = `
            <td>
                <span class="tooltip-trigger" 
                      data-bs-toggle="tooltip" 
                      data-bs-placement="left"
                      data-bs-title="Market scenario: ${signal.signal}. This represents a potential future direction identified through analysis of expert opinions and market discussions.">${signal.signal}</span>
            </td>
            <td>
                <span class="frequency-badge frequency-${signal.level}" 
                      data-bs-toggle="tooltip" 
                      data-bs-placement="top"
                      data-bs-title="${frequencyTooltips[signal.frequency] || 'Frequency of mention in analyzed articles'}"
                      style="width: ${badgeWidth}px;">
                    ${signal.frequency}
                    <span class="count-indicator">${signal.count || 0}</span>
                </span>
            </td>
            <td>
                <span data-bs-toggle="tooltip" 
                      data-bs-placement="right"
                      data-bs-title="${impactTooltips[signal.impact] || 'Expected timeline for this scenario to materialize'}">${signal.impact}</span>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Reinitialize tooltips for new content
    initializeTooltips();
}

function populateRiskOpportunityCards(risks, opportunities) {
    // Populate critical risk
    const criticalRiskContent = document.getElementById('criticalRiskContent');
    const criticalRiskTitle = document.getElementById('criticalRiskTitle');
    if (risks.length > 0) {
        const risk = risks[0];
        criticalRiskTitle.textContent = risk.title || 'Critical Risk';
        criticalRiskContent.innerHTML = `
            <p class="card-description">${risk.description}</p>
            <div class="card-meta">
                <span><strong>Timeline:</strong> ${risk.timeline || 'Unknown'}</span>
                <span><strong>Probability:</strong> ${risk.probability || 'Unknown'}</span>
            </div>
        `;
    }
    
    // Populate opportunity
    const opportunityContent = document.getElementById('opportunityContent');
    const opportunityTitle = document.getElementById('opportunityTitle');
    if (opportunities.length > 0) {
        const opportunity = opportunities[0];
        opportunityTitle.textContent = opportunity.title || 'Key Opportunity';
        opportunityContent.innerHTML = `
            <p class="card-description">${opportunity.description}</p>
            <div class="card-meta">
                <span><strong>Timeline:</strong> ${opportunity.timeline || 'Unknown'}</span>
                <span><strong>Probability:</strong> ${opportunity.probability || 'Unknown'}</span>
            </div>
        `;
    }
    
    // Populate additional cards
    const additionalCards = document.getElementById('additionalCards');
    additionalCards.innerHTML = '';
    
    // Add remaining risks and opportunities
    [...risks.slice(1), ...opportunities.slice(1)].forEach(item => {
        const cardClass = item.type === 'risk' ? 'risk-card' : 'opportunity-card';
        const iconClass = item.type === 'risk' ? 'risk-icon fas fa-exclamation-triangle' : 'opportunity-icon fas fa-lightbulb';
        
        const probabilityTooltips = {
            'High': 'High likelihood of occurrence based on current market trends and expert analysis',
            'Moderate': 'Moderate likelihood of occurrence, dependent on various market factors',
            'Low': 'Lower likelihood but still worth monitoring due to potential impact'
        };
        
        const card = document.createElement('div');
        card.className = `market-signal-card ${cardClass}`;
        card.innerHTML = `
            <div class="card-body">
                <div class="card-title">
                    <i class="${iconClass}"></i>
                    ${item.title}
                </div>
                <p class="card-description">${item.description}</p>
                <div class="card-meta">
                    <span><strong>Timeline:</strong> 
                        <span data-bs-toggle="tooltip" 
                              data-bs-placement="top"
                              data-bs-title="Expected timeframe for this ${item.type} to materialize or require action">${item.timeline || 'Unknown'}</span>
                    </span>
                    <span><strong>Probability:</strong> 
                        <span data-bs-toggle="tooltip" 
                              data-bs-placement="top"
                              data-bs-title="${probabilityTooltips[item.probability] || 'Likelihood assessment based on market analysis'}">${item.probability || 'Unknown'}</span>
                    </span>
                </div>
            </div>
        `;
        additionalCards.appendChild(card);
    });
    
    // Reinitialize tooltips for new content
    initializeTooltips();
}

function populateArticleInsights(insights) {
    const quotesContainer = document.getElementById('analystQuotes');
    quotesContainer.innerHTML = '';
    
    insights.forEach(insight => {
        const insightDiv = document.createElement('div');
        insightDiv.className = 'analyst-quote mb-3';
        
        // Create clickable title if URI exists
        let titleHtml = insight.title;
        if (insight.uri) {
            titleHtml = `<a href="${insight.uri}" target="_blank" class="text-decoration-none">
                ${insight.title} <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
            </a>`;
        }
        
        insightDiv.innerHTML = `
            <div class="quote-text mb-2">${insight.text}</div>
            <div class="quote-source">
                <strong>â€” ${insight.author}</strong>
                <div class="mt-1 text-muted small">${titleHtml}</div>
            </div>
        `;
        quotesContainer.appendChild(insightDiv);
    });
}

// Configuration management functions
function toggleCustomTimeframe() {
    const timeframe = document.getElementById('timeframe').value;
    const customDays = document.getElementById('customDays');
    
    if (timeframe === 'custom') {
        customDays.style.display = 'block';
        customDays.focus();
    } else {
        customDays.style.display = 'none';
        customDays.value = '';
    }
}

function handleSampleSizeModeChange() {
    const mode = document.getElementById('sampleSizeMode').value;
    const customLimit = document.getElementById('customLimit');
    
    if (mode === 'custom') {
        customLimit.style.display = 'block';
        customLimit.focus();
    } else {
        customLimit.style.display = 'none';
    }
    
    updateContextInfo();
}

function updateContextInfo() {
    const contextInfo = document.getElementById('contextInfo');
    const contextStats = document.getElementById('contextStats');
    
    if (!contextInfo || !contextStats) return;
    
    const model = document.getElementById('model')?.value;
    
    if (!model) {
        contextInfo.style.display = 'none';
        return;
    }
    
    const sampleSize = 100; // Example size
    const contextLimit = contextLimits[model] || contextLimits.default;
    const totalTokens = 500 + sampleSize * 180; // Estimate
    const contextUsage = (totalTokens / contextLimit) * 100;
    
    const contextText = `Context: ${sampleSize} articles, ~${totalTokens.toLocaleString()} tokens (${contextUsage.toFixed(1)}%)`;
    contextStats.textContent = contextText;
    
    contextInfo.style.display = 'block';
}

function updateLoadButton() {
    const topic = document.getElementById('topic').value;
    const model = document.getElementById('model').value;
    const loadBtn = document.getElementById('loadAnalysisBtn');
    const configureBtn = document.querySelector('[data-bs-target="#configModal"]');
    
    if (topic && model) {
        loadBtn.disabled = false;
        loadBtn.title = 'Load Analysis';
        configureBtn.innerHTML = '<i class="fas fa-check"></i>';
        configureBtn.title = 'Configured';
        configureBtn.classList.remove('btn-primary');
        configureBtn.classList.add('btn-success');
    } else {
        loadBtn.disabled = true;
        loadBtn.title = 'Load Analysis';
        configureBtn.innerHTML = '<i class="fas fa-cog"></i>';
        configureBtn.title = 'Configure Analysis';
        configureBtn.classList.remove('btn-success');
        configureBtn.classList.add('btn-primary');
    }
}

function saveConfigurationAndClose() {
    const topic = document.getElementById('topic').value;
    const model = document.getElementById('model').value;
    const timeframe = document.getElementById('timeframe').value;
    
    if (!topic) {
        alert('Please select a topic');
        return;
    }
    
    if (!model) {
        alert('Please select a model');
        return;
    }
    
    const config = {
        topic,
        model,
        timeframe,
        timestamp: new Date().toISOString()
    };
    
    // Add custom days if timeframe is custom
    if (timeframe === 'custom') {
        const customDays = document.getElementById('customDays').value;
        if (customDays) {
            config.customDays = customDays;
        }
    }
    
    // Save additional form fields
    const sampleSizeMode = document.getElementById('sampleSizeMode')?.value;
    if (sampleSizeMode) {
        config.sampleSizeMode = sampleSizeMode;
    }
    
    const customLimit = document.getElementById('customLimit')?.value;
    if (customLimit) {
        config.customLimit = customLimit;
    }
    
    const analysisDepth = document.getElementById('analysisDepth')?.value;
    if (analysisDepth) {
        config.analysisDepth = analysisDepth;
    }
    
    console.log('Saving configuration:', config);
    localStorage.setItem('marketSignalsConfig', JSON.stringify(config));
    
    // Improved modal cleanup to prevent backdrop issues
    const modalElement = document.getElementById('configModal');
    
    // Force cleanup of any existing backdrops first
    const existingBackdrops = document.querySelectorAll('.modal-backdrop');
    existingBackdrops.forEach(backdrop => backdrop.remove());
    
    // Get or create modal instance
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        modal = new bootstrap.Modal(modalElement);
    }
    
    // Set up one-time cleanup listener before hiding
    const cleanup = function() {
        // Force remove any remaining backdrops
        setTimeout(() => {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Restore body state
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // Remove modal-open class from html element too
            document.documentElement.classList.remove('modal-open');
        }, 100);
        
        // Remove this listener
        modalElement.removeEventListener('hidden.bs.modal', cleanup);
    };
    
    modalElement.addEventListener('hidden.bs.modal', cleanup, { once: true });
    
    // Hide the modal
    modal.hide();
    
    updateLoadButton();
    showSuccess('Configuration saved! You can now load the analysis.');
}

async function loadSavedConfiguration() {
    try {
        const savedConfig = localStorage.getItem('marketSignalsConfig');
        console.log('Loading saved configuration:', savedConfig);
        
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            console.log('Parsed configuration:', config);
            
            // Wait longer to ensure dropdowns are fully populated
            await new Promise(resolve => setTimeout(resolve, 200));
            
            let configApplied = false;
            
            // Set topic with validation and retry logic
            if (config.topic) {
                const topicSelect = document.getElementById('topic');
                if (topicSelect && topicSelect.options.length > 1) {
                    // Check if the option exists before setting
                    const topicOption = Array.from(topicSelect.options).find(opt => opt.value === config.topic);
                    if (topicOption) {
                        topicSelect.value = config.topic;
                        console.log('Restored topic:', config.topic);
                        configApplied = true;
                    } else {
                        console.warn('Saved topic not found in current options:', config.topic);
                        // Try to find a similar topic
                        const similarTopic = Array.from(topicSelect.options).find(opt => 
                            opt.value.toLowerCase().includes(config.topic.toLowerCase()) ||
                            config.topic.toLowerCase().includes(opt.value.toLowerCase())
                        );
                        if (similarTopic) {
                            topicSelect.value = similarTopic.value;
                            console.log('Found similar topic:', similarTopic.value);
                            configApplied = true;
                        }
                    }
                } else {
                    console.warn('Topic dropdown not ready or empty');
                }
            }
            
            // Set model with validation and retry logic
            if (config.model) {
                const modelSelect = document.getElementById('model');
                if (modelSelect && modelSelect.options.length > 1) {
                    // Check if the option exists before setting
                    const modelOption = Array.from(modelSelect.options).find(opt => opt.value === config.model);
                    if (modelOption) {
                        modelSelect.value = config.model;
                        console.log('Restored model:', config.model);
                        configApplied = true;
                    } else {
                        console.warn('Saved model not found in current options:', config.model);
                        // Try to find a similar model
                        const similarModel = Array.from(modelSelect.options).find(opt => 
                            opt.value.includes(config.model.split('-')[0]) || // Match base model name
                            config.model.includes(opt.value.split('-')[0])
                        );
                        if (similarModel) {
                            modelSelect.value = similarModel.value;
                            console.log('Found similar model:', similarModel.value);
                            configApplied = true;
                        }
                    }
                } else {
                    console.warn('Model dropdown not ready or empty');
                }
            }
            
            // Set timeframe
            if (config.timeframe) {
                const timeframeSelect = document.getElementById('timeframe');
                if (timeframeSelect) {
                    timeframeSelect.value = config.timeframe;
                    console.log('Restored timeframe:', config.timeframe);
                    
                    // Handle custom timeframe
                    if (config.timeframe === 'custom' && config.customDays) {
                        const customDays = document.getElementById('customDays');
                        if (customDays) {
                            customDays.value = config.customDays;
                            customDays.style.display = 'block';
                            console.log('Restored custom days:', config.customDays);
                        }
                    }
                    configApplied = true;
                }
            }
            
            // Set sample size mode
            if (config.sampleSizeMode) {
                const sampleSizeModeSelect = document.getElementById('sampleSizeMode');
                if (sampleSizeModeSelect) {
                    sampleSizeModeSelect.value = config.sampleSizeMode;
                    console.log('Restored sample size mode:', config.sampleSizeMode);
                    handleSampleSizeModeChange(); // Trigger any related UI updates
                    configApplied = true;
                }
            }
            
            // Set custom limit
            if (config.customLimit) {
                const customLimitInput = document.getElementById('customLimit');
                if (customLimitInput) {
                    customLimitInput.value = config.customLimit;
                    console.log('Restored custom limit:', config.customLimit);
                    configApplied = true;
                }
            }
            
            // Set analysis depth
            if (config.analysisDepth) {
                const analysisDepthSelect = document.getElementById('analysisDepth');
                if (analysisDepthSelect) {
                    analysisDepthSelect.value = config.analysisDepth;
                    console.log('Restored analysis depth:', config.analysisDepth);
                    configApplied = true;
                }
            }
            
            // Update UI
            updateLoadButton();
            updateContextInfo();
            
            if (configApplied) {
                console.log('Configuration loading completed successfully');
                return true;
            } else {
                console.warn('Configuration found but could not be applied');
                return false;
            }
        } else {
            console.log('No saved configuration found');
        }
    } catch (e) {
        console.error('Failed to load saved configuration:', e);
        return false;
    }
    return false;
}

function clearSavedConfiguration() {
    try {
        // Clear saved configuration
        localStorage.removeItem('marketSignalsConfig');
        
        // Clear all cached results (they have dynamic keys now)
        const allKeys = Object.keys(localStorage).filter(key => key.startsWith('marketSignalsResults_'));
        allKeys.forEach(key => {
            localStorage.removeItem(key);
        });
        
        console.log('Cleared all saved configuration and cached results');
        showSuccess(`Configuration and ${allKeys.length} cached result(s) cleared!`);
        
        // Reset UI to initial state
        document.getElementById('topic').value = '';
        document.getElementById('model').value = '';
        document.getElementById('timeframe').value = '365d';
        document.getElementById('sampleSizeMode').value = 'auto';
        document.getElementById('analysisDepth').value = 'standard';
        document.getElementById('customDays').style.display = 'none';
        document.getElementById('customLimit').style.display = 'none';
        
        // Hide results container
        document.getElementById('marketSignalsContainer').style.display = 'none';
        
        updateLoadButton();
    } catch (e) {
        console.error('Error clearing configuration:', e);
        showError('Failed to clear configuration. Please try refreshing the page.');
    }
}

// Debug function to check localStorage status and form state
function debugLocalStorage() {
    console.log('=== LocalStorage Debug Info ===');
    console.log('LocalStorage available:', typeof(Storage) !== "undefined");
    
    try {
        // Test localStorage write/read
        localStorage.setItem('test', 'value');
        const testRead = localStorage.getItem('test');
        localStorage.removeItem('test');
        console.log('LocalStorage test successful:', testRead === 'value');
        
        // Check existing data
        const config = localStorage.getItem('marketSignalsConfig');
        const results = localStorage.getItem('marketSignalsResults');
        
        console.log('Saved config exists:', !!config);
        if (config) {
            try {
                const parsedConfig = JSON.parse(config);
                console.log('Saved config:', parsedConfig);
            } catch (e) {
                console.log('Config parse error:', e);
            }
        }
        
        console.log('Cached results exist:', !!results);
        
        // Check current form state
        console.log('=== Current Form State ===');
        const topicSelect = document.getElementById('topic');
        const modelSelect = document.getElementById('model');
        const timeframeSelect = document.getElementById('timeframe');
        
        console.log('Topic options count:', topicSelect ? topicSelect.options.length : 'N/A');
        console.log('Topic current value:', topicSelect ? topicSelect.value : 'N/A');
        console.log('Model options count:', modelSelect ? modelSelect.options.length : 'N/A');
        console.log('Model current value:', modelSelect ? modelSelect.value : 'N/A');
        console.log('Timeframe current value:', timeframeSelect ? timeframeSelect.value : 'N/A');
        
        console.log('=== End Debug Info ===');
        
    } catch (e) {
        console.error('LocalStorage not available or error:', e);
    }
}

// Make debug function available globally
window.debugLocalStorage = debugLocalStorage;

function generateCacheKey(config) {
    // Create a unique cache key based on all configuration parameters
    const keyData = {
        topic: config.topic,
        timeframe: config.timeframe,
        customDays: config.customDays,
        model: config.model,
        sampleSizeMode: config.sampleSizeMode,
        customLimit: config.customLimit,
        analysisDepth: config.analysisDepth
    };
    
    // Create a hash of the configuration for the cache key
    const configString = JSON.stringify(keyData);
    let hash = 0;
    for (let i = 0; i < configString.length; i++) {
        const char = configString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    
    return `marketSignalsResults_${Math.abs(hash)}`;
}

function getCurrentConfiguration() {
    const timeframe = document.getElementById('timeframe')?.value || '';
    let customDays = null;
    
    if (timeframe === 'custom') {
        customDays = document.getElementById('customDays')?.value || null;
    }
    
    return {
        topic: document.getElementById('topic')?.value || '',
        timeframe: timeframe,
        customDays: customDays,
        model: document.getElementById('model')?.value || '',
        sampleSizeMode: document.getElementById('sampleSizeMode')?.value || 'auto',
        customLimit: document.getElementById('customLimit')?.value || null,
        analysisDepth: document.getElementById('analysisDepth')?.value || 'standard'
    };
}

function saveAnalysisResults(results, config) {
    try {
        const cacheKey = generateCacheKey(config);
        const cacheData = {
            results,
            config,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
        console.log('Analysis results cached successfully with key:', cacheKey);
        
        // Clean up old cache entries (keep only the most recent 5)
        const allKeys = Object.keys(localStorage).filter(key => key.startsWith('marketSignalsResults_'));
        if (allKeys.length > 5) {
            // Get timestamps for all cached results
            const cacheEntries = allKeys.map(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    return { key, timestamp: new Date(data.timestamp) };
                } catch (e) {
                    return { key, timestamp: new Date(0) }; // Invalid entries get old timestamp
                }
            });
            
            // Sort by timestamp (newest first) and remove old entries
            cacheEntries.sort((a, b) => b.timestamp - a.timestamp);
            cacheEntries.slice(5).forEach(entry => {
                localStorage.removeItem(entry.key);
                console.log('Removed old cache entry:', entry.key);
            });
        }
    } catch (e) {
        console.warn('Failed to cache analysis results:', e);
    }
}

function loadCachedResults(config) {
    try {
        const cacheKey = generateCacheKey(config);
        const cachedData = localStorage.getItem(cacheKey);
        
        if (cachedData) {
            const cache = JSON.parse(cachedData);
            const cacheAge = new Date() - new Date(cache.timestamp);
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours
            
            if (cacheAge < maxAge) {
                // Verify configuration matches
                const configMatches = JSON.stringify(cache.config) === JSON.stringify(config);
                if (configMatches) {
                    console.log('Loading cached results from:', cache.timestamp);
                    return { analysis: cache.results, config: cache.config };
                } else {
                    console.log('Configuration mismatch, cache invalid');
                    localStorage.removeItem(cacheKey);
                }
            } else {
                console.log('Cached results expired, removing...');
                localStorage.removeItem(cacheKey);
            }
        }
    } catch (e) {
        console.warn('Failed to load cached results:', e);
    }
    return null;
}

function showSuccess(message) {
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
    
    setTimeout(() => {
        const alert = errorContainer.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}

function showError(message) {
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
}

// Initialize tooltips without interfering with existing ones
function initializeTooltips() {
    // Only initialize tooltips that don't already have Bootstrap instances
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        // Check if tooltip is already initialized
        if (!bootstrap.Tooltip.getInstance(tooltipTriggerEl)) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true,
                delay: { show: 500, hide: 100 }
            });
        }
        return null;
    }).filter(Boolean);
}

// Initialize page
window.addEventListener('load', async function() {
    // Let Bootstrap handle its own initialization
    
    // Initialize tooltips
    initializeTooltips();
    
    // Restore controls state
    restoreControlsState();
    
    // Try to auto-load cached analysis
    setTimeout(() => {
        autoLoadCachedAnalysis();
    }, 500);
    
    try {
        // Load topics
        const topicsResponse = await fetch('/api/topics');
        const topicsData = await topicsResponse.json();

        const topicSelect = document.getElementById('topic');

        if (topicsData && topicsData.length > 0) {
            topicSelect.innerHTML = '<option value="">Select a topic...</option>';

            topicsData.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.name;
                option.textContent = topic.name;
                topicSelect.appendChild(option);
            });
        } else {
            topicSelect.innerHTML = '<option value="">No topics available</option>';
            showError('No topics with forecast data found.');
        }

        // Load models
        const modelsResponse = await fetch('/api/models');
        const models = await modelsResponse.json();
        
        const modelSelect = document.getElementById('model');
        
        if (models && models.length > 0) {
            modelSelect.innerHTML = '<option value="">Select model...</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.provider})`;
                modelSelect.appendChild(option);
            });
        } else {
            modelSelect.innerHTML = '<option value="">No models available</option>';
            showError('No AI models found.');
        }
        
        // Load saved configuration AFTER both dropdowns are populated
        // Add additional delay to ensure all data is loaded
        setTimeout(async () => {
            const configLoaded = await loadSavedConfiguration();
            
            // Check if we have a saved configuration to determine modal behavior
            const savedConfig = localStorage.getItem('marketSignalsConfig');
            if (!savedConfig) {
                console.log('No saved configuration found, showing configuration modal');
                setTimeout(() => {
                    const modal = new bootstrap.Modal(document.getElementById('configModal'));
                    modal.show();
                }, 500);
            } else {
                // Configuration was loaded, update the button state
                updateLoadButton();
                
                if (configLoaded) {
                    console.log('Configuration loaded from localStorage successfully');
                    // Show brief success message
                    setTimeout(() => {
                        showSuccess('Previous configuration restored automatically');
                    }, 1000);
                } else {
                    console.warn('Configuration existed but failed to load properly');
                    // Try to reload after a longer delay
                    setTimeout(async () => {
                        const retryLoaded = await loadSavedConfiguration();
                        if (retryLoaded) {
                            console.log('Configuration loaded successfully on retry');
                            updateLoadButton();
                            showSuccess('Configuration restored successfully');
                        } else {
                            showError('Saved configuration found but could not be loaded. Please reconfigure.');
                        }
                    }, 1000);
                }
            }
        }, 300);
        
    } catch (error) {
        console.warn('Failed to load data:', error);
        showError('Failed to load available data.');
    }
});

// Add cleanup on page unload for our modals only
window.addEventListener('beforeunload', function() {
    // Only clean up our modal artifacts before page unload
    const configModal = document.getElementById('configModal');
    if (configModal && !configModal.classList.contains('show')) {
        const configBackdrops = document.querySelectorAll('.modal-backdrop');
        configBackdrops.forEach(backdrop => {
            if (backdrop.nextElementSibling === configModal || 
                backdrop.previousElementSibling === configModal) {
                backdrop.remove();
            }
        });
    }
});

// Add click event delegation to handle modal backdrop clicks properly
// BUT be much more specific to avoid interfering with navigation
document.addEventListener('click', function(event) {
    // ONLY handle our specific modal backdrop - be extremely selective
    if (event.target.classList.contains('modal-backdrop') && 
        event.target.getAttribute('data-bs-backdrop') !== null &&
        event.target.nextElementSibling && 
        event.target.nextElementSibling.id === 'configModal') {
        
        // This is specifically our config modal backdrop
        setTimeout(() => {
            event.target.remove();
            
            // Only remove modal-open if no other modals are active
            const activeModals = document.querySelectorAll('.modal.show');
            if (activeModals.length === 0) {
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
                document.documentElement.classList.remove('modal-open');
            }
        }, 100);
    }
    
    // Don't handle any other clicks - let Bootstrap handle everything else
});
</script>
{% endblock %} 