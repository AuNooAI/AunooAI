{% extends "base_with_shared_nav.html" %}

{% block title %}Prompt Manager - Aunoo{% endblock %}

{% block content %}
<div class="prompt-manager-container">
    <!-- Breadcrumb Header -->
    <div class="page-breadcrumb-header">
        <div class="breadcrumb-text">
            <span>Settings</span>
            <span>/</span>
            <span class="font-medium">Prompt Engineering</span>
            <span>â€¢</span>
            <span>Manage and version AI prompts</span>
        </div>
        <div class="page-header-actions">
            <button type="button" class="btn btn-icon" title="Notifications">
                <i class="far fa-bell"></i>
            </button>
            <button class="btn-topic-setup" onclick="window.location.href='/onboarding?redo=true'" title="Set up a new topic">
                <span>Set up topic</span>
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Scrollable Content Area -->
    <div class="prompt-manager-scrollable">
        <div class="container mt-4">

    <div class="row">
        <div class="col-md-6">
            <h2>Prompt Selector</h2>
            <div class="prompt-selector">
                <select id="prompt-type" class="form-select">
                    <option value="">Select Prompt Type</option>
                    <option value="title_extraction">Title Extraction</option>
                    <option value="content_analysis">Content Analysis</option>
                </select>
                <select id="prompt-version" class="form-select" disabled>
                    <option value="">Select Version</option>
                </select>
            </div>

            <div class="prompt-editor mt-4">
                <h3>System Prompt</h3>
                <textarea id="system-prompt" rows="5" class="form-control" placeholder="System prompt..."></textarea>

                <h3>User Prompt</h3>
                <textarea id="user-prompt" rows="10" class="form-control" placeholder="User prompt..."></textarea>

                <div class="prompt-actions mt-3">
                    <button id="save-prompt" class="btn btn-primary">Save New Version</button>
                    <button id="restore-version" class="btn btn-secondary" disabled>Restore Selected Version</button>
                    <button id="compare-versions" class="btn btn-secondary" disabled>Compare with Current</button>
                    <button id="delete-version" class="btn btn-outline-danger" disabled>Delete Selected Version</button>
                </div>

                <div class="available-variables mt-4">
                    <h3>Available Variables</h3>
                    <div class="card">
                        <div class="card-body">
                            <h5>Content Analysis Variables:</h5>
                            <ul>
                                <li><code>{article_text}</code> - Full article content</li>
                                <li><code>{title}</code> - Article title</li>
                                <li><code>{source}</code> - Article source</li>
                                <li><code>{uri}</code> - Article URI</li>
                                <li><code>{summary_length}</code> - Requested summary length</li>
                                <li><code>{summary_voice}</code> - Summary voice style</li>
                                <li><code>{summary_type}</code> - Type of summary</li>
                                <li><code>{categories}</code> - Available categories</li>
                                <li><code>{future_signals}</code> - Available future signals</li>
                                <li><code>{sentiment_options}</code> - Available sentiment options</li>
                                <li><code>{time_to_impact_options}</code> - Available time to impact options</li>
                                <li><code>{driver_types}</code> - Available driver types</li>
                            </ul>

                            <h5>Date Extraction Variables:</h5>
                            <ul>
                                <li><code>{content}</code> - Article content (first 1000 chars)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <h2>Version History</h2>
            <div id="version-history" class="table-responsive">
                <!-- Will be populated dynamically -->
            </div>

            <div id="version-comparison" class="hidden mt-4">
                <h3>Version Comparison</h3>
                <div class="comparison-view">
                    <div class="version-a">
                        <h4>Selected Version <span class="version-label badge bg-secondary"></span></h4>
                        <div class="version-content">
                            <div class="version-info mb-2">
                                <span class="badge bg-secondary">Version: <span class="version-number"></span></span>
                                <span class="badge bg-info">Created: <span class="created-at"></span></span>
                            </div>
                            <pre class="prompt-content"></pre>
                        </div>
                    </div>
                    <div class="version-b">
                        <h4>Current Active Version <span class="badge bg-primary">Active</span></h4>
                        <div class="version-content">
                            <div class="version-info mb-2">
                                <span class="badge bg-secondary">Version: <span class="version-number"></span></span>
                                <span class="badge bg-info">Created: <span class="created-at"></span></span>
                            </div>
                            <pre class="prompt-content"></pre>
                        </div>
                    </div>
                </div>
                <button id="close-comparison" class="btn btn-secondary">Close Comparison</button>
            </div>
        </div>
    </div>
</div>

<script>
    // JavaScript functions related to prompt management
    function loadPromptTypes() {
        const promptTypeSelect = document.getElementById('prompt-type');
        
        fetch('/api/prompts/types')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                promptTypeSelect.innerHTML = '<option value="">Select Prompt Type</option>';
                if (data.types && Array.isArray(data.types)) {
                    data.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.name;
                        option.textContent = type.display_name;
                        promptTypeSelect.appendChild(option);
                    });
                    promptTypeSelect.disabled = false;
                } else {
                    throw new Error('Invalid response format');
                }
            })
            .catch(error => {
                console.error('Error loading prompt types:', error);
                promptTypeSelect.innerHTML = '<option value="">Error loading prompt types</option>';
                promptTypeSelect.disabled = true;
            });
    }

    function loadPromptVersions(promptType) {
        if (!promptType) {
            console.error('No prompt type specified');
            return;
        }

        const versionSelect = document.getElementById('prompt-version');
        versionSelect.innerHTML = '<option value="">Loading versions...</option>';
        versionSelect.disabled = true;

        fetch(`/api/prompts/${promptType}/versions`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                versionSelect.innerHTML = '<option value="">Select Version</option>';
                if (data.versions && Array.isArray(data.versions)) {
                    data.versions.forEach(version => {
                        const option = document.createElement('option');
                        option.value = version.hash;
                        option.textContent = `${version.version} (${new Date(version.created_at).toLocaleString()})`;
                        versionSelect.appendChild(option);
                    });
                    versionSelect.disabled = false;
                } else {
                    throw new Error('Invalid response format');
                }
            })
            .catch(error => {
                console.error('Error loading prompt versions:', error);
                versionSelect.innerHTML = '<option value="">Error loading versions</option>';
                versionSelect.disabled = true;
            });
    }

    function deleteVersion(promptType, versionHash) {
        if (confirm('Are you sure you want to delete this version? This action cannot be undone.')) {
            fetch(`/api/prompts/${promptType}/${versionHash}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                // Reload versions after successful deletion
                loadPromptVersions(promptType);
            })
            .catch(error => {
                console.error('Error deleting version:', error);
                alert('Error deleting version');
            });
        }
    }

    function loadPromptContent(promptType, versionHash) {
        fetch(`/api/prompts/${promptType}/${versionHash}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('system-prompt').value = data.system_prompt;
                document.getElementById('user-prompt').value = data.user_prompt;
                
                // Enable/disable buttons based on version
                const isCurrent = versionHash === 'current';
                document.getElementById('restore-version').disabled = isCurrent;
                document.getElementById('compare-versions').disabled = isCurrent;
                document.getElementById('delete-version').disabled = isCurrent;
            })
            .catch(error => {
                console.error('Error loading prompt content:', error);
                alert('Error loading prompt content');
            });
    }

    function savePromptVersion(promptType) {
        const promptData = {
            system_prompt: document.getElementById('system-prompt').value,
            user_prompt: document.getElementById('user-prompt').value
        };

        fetch(`/api/prompts/${promptType}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(promptData)
        })
        .then(response => response.json())
        .then(data => {
            alert('Prompt version saved successfully');
            loadPromptVersions(promptType);
        })
        .catch(error => {
            console.error('Error saving prompt version:', error);
            alert('Error saving prompt version');
        });
    }

    function restoreVersion(promptType, versionHash) {
        fetch(`/api/prompts/${promptType}/${versionHash}/restore`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert('Version restored successfully');
            loadPromptVersions(promptType);
        })
        .catch(error => {
            console.error('Error restoring version:', error);
            alert('Error restoring version');
        });
    }

    function createDiffHtml(textA, textB) {
        // Split into lines and create diff
        const linesA = textA.split('\n');
        const linesB = textB.split('\n');
        
        let diffHtmlA = '';
        let diffHtmlB = '';
        let i = 0, j = 0;
        
        while (i < linesA.length || j < linesB.length) {
            const lineA = i < linesA.length ? linesA[i] : '';
            const lineB = j < linesB.length ? linesB[j] : '';
            
            if (lineA === lineB) {
                // Lines are identical
                diffHtmlA += `<div class="diff-line">${escapeHtml(lineA)}</div>`;
                diffHtmlB += `<div class="diff-line">${escapeHtml(lineB)}</div>`;
                i++; j++;
            } else {
                // Lines are different
                if (lineA) {
                    diffHtmlA += `<div class="diff-line diff-removed">${escapeHtml(lineA)}</div>`;
                    i++;
                }
                if (lineB) {
                    diffHtmlB += `<div class="diff-line diff-added">${escapeHtml(lineB)}</div>`;
                    j++;
                }
            }
        }
        return { diffA: diffHtmlA, diffB: diffHtmlB };
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function compareVersions(promptType, versionHashA, versionHashB) {
        Promise.all([
            fetch(`/api/prompts/${promptType}/${versionHashA}`).then(r => r.json()),
            fetch(`/api/prompts/${promptType}/${versionHashB}`).then(r => r.json())
        ])
        .then(([versionA, versionB]) => {
            const formatDate = (dateStr) => {
                return new Date(dateStr).toLocaleString();
            };

            // Update version info
            document.querySelector('.version-a .version-number').textContent = versionA.version;
            document.querySelector('.version-a .created-at').textContent = formatDate(versionA.created_at);
            document.querySelector('.version-b .version-number').textContent = versionB.version;
            document.querySelector('.version-b .created-at').textContent = formatDate(versionB.created_at);

            // Create diffs for system and user prompts
            const systemDiff = createDiffHtml(versionA.system_prompt, versionB.system_prompt);
            const userDiff = createDiffHtml(versionA.user_prompt, versionB.user_prompt);

            // Update version A content (selected version)
            document.querySelector('.version-a .prompt-content').innerHTML = 
                `<div class="prompt-section">
                    <h5>System Prompt:</h5>
                    ${systemDiff.diffA}
                </div>
                <div class="prompt-section">
                    <h5>User Prompt:</h5>
                    ${userDiff.diffA}
                </div>`;

            // Update version B content (current version)
            document.querySelector('.version-b .prompt-content').innerHTML = 
                `<div class="prompt-section">
                    <h5>System Prompt:</h5>
                    ${systemDiff.diffB}
                </div>
                <div class="prompt-section">
                    <h5>User Prompt:</h5>
                    ${userDiff.diffB}
                </div>`;

            document.getElementById('version-comparison').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error comparing versions:', error);
            alert('Error comparing versions');
        });
    }

    // Event Listeners
    document.getElementById('prompt-type').addEventListener('change', function(e) {
        const promptType = e.target.value;
        const versionSelect = document.getElementById('prompt-version');
        
        // Reset version select
        versionSelect.innerHTML = '<option value="">Select Version</option>';
        versionSelect.disabled = true;
        
        // Reset buttons
        document.getElementById('restore-version').disabled = true;
        document.getElementById('compare-versions').disabled = true;
        document.getElementById('delete-version').disabled = true;
        
        // Clear prompts
        document.getElementById('system-prompt').value = '';
        document.getElementById('user-prompt').value = '';
        
        if (promptType) {
            loadPromptVersions(promptType);
        }
    });

    document.getElementById('prompt-version').addEventListener('change', function(e) {
        const promptType = document.getElementById('prompt-type').value;
        const isVersionSelected = e.target.value !== '';
        const isCurrent = e.target.value === 'current';
        
        // Enable/disable buttons based on selection
        document.getElementById('restore-version').disabled = !isVersionSelected || isCurrent;
        document.getElementById('compare-versions').disabled = !isVersionSelected || isCurrent;
        document.getElementById('delete-version').disabled = !isVersionSelected || isCurrent;
        
        if (e.target.value) {
            loadPromptContent(promptType, e.target.value);
        }
    });

    document.getElementById('save-prompt').addEventListener('click', function() {
        const promptType = document.getElementById('prompt-type').value;
        if (promptType) {
            savePromptVersion(promptType);
        }
    });

    document.getElementById('restore-version').addEventListener('click', function() {
        const promptType = document.getElementById('prompt-type').value;
        const versionHash = document.getElementById('prompt-version').value;
        if (promptType && versionHash) {
            restoreVersion(promptType, versionHash);
        }
    });

    document.getElementById('compare-versions').addEventListener('click', function() {
        const promptType = document.getElementById('prompt-type').value;
        const versionHash = document.getElementById('prompt-version').value;
        if (promptType && versionHash) {
            compareVersions(promptType, versionHash, 'current');
        }
    });

    document.getElementById('delete-version').addEventListener('click', function() {
        const promptType = document.getElementById('prompt-type').value;
        const versionHash = document.getElementById('prompt-version').value;
        if (promptType && versionHash) {
            deleteVersion(promptType, versionHash);
        }
    });

    document.getElementById('close-comparison').addEventListener('click', function() {
        document.getElementById('version-comparison').classList.add('hidden');
    });

    // Initialize prompt management
    document.addEventListener('DOMContentLoaded', function() {
        const promptTypeSelect = document.getElementById('prompt-type');
        promptTypeSelect.innerHTML = '<option value="">Loading prompt types...</option>';
        promptTypeSelect.disabled = true;

        loadPromptTypes();
    });
</script>

<style>
    :root {
        --primary-color: var(--colors-accent-7);  /* Hot Pink */
        --primary-dark: var(--colors-accent-10);   /* Deep Pink */
        --secondary-color: #32CD32;  /* Lime Green */
        --secondary-dark: #228B22;   /* Forest Green */
        --text-color: var(--colors-neutral-11);
        --light-gray: var(--colors-neutral-2);
        --medium-gray: var(--colors-neutral-4);
        --dark-gray: var(--colors-neutral-10);
    }

    h1, h2, h3 {
        color: var(--primary-color);
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    .btn-secondary {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
    }

    .btn-secondary:hover {
        background-color: var(--secondary-dark);
        border-color: var(--secondary-dark);
    }

    .badge.bg-primary {
        background-color: var(--primary-color) !important;
    }

    .badge.bg-info {
        background-color: var(--secondary-color) !important;
        color: white;
    }

    .config-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    .left-panel, .right-panel {
        flex: 1;
        min-width: 300px;
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .config-item {
        margin-bottom: 20px;
    }

    .prompt-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .prompt-selector select {
        flex: 1;
    }

    .prompt-editor {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .prompt-editor textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--colors-neutral-4);
        border-radius: 5px;
        font-family: monospace;
        resize: vertical;
    }

    .prompt-editor textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
    }

    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.25);
    }

    .prompt-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .prompt-actions button {
        white-space: nowrap;
    }

    .version-history {
        max-height: 400px;
        overflow-y: auto;
    }

    .comparison-view {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }

    .version-content {
        background-color: var(--colors-neutral-2);
        border-radius: 5px;
        padding: 15px;
    }

    .prompt-content {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: monospace;
        line-height: 1.5;
        padding: 10px;
        background: white;
        border: 1px solid var(--colors-neutral-5);
        border-radius: 4px;
    }

    .version-info {
        display: flex;
        gap: 10px;
    }

    .version-info .badge {
        font-size: 0.85em;
    }

    .hidden {
        display: none;
    }

    .available-variables {
        background-color: var(--colors-neutral-2);
        border-radius: 5px;
        padding: 15px;
    }

    .available-variables code {
        background-color: var(--colors-neutral-4);
        padding: 2px 4px;
        border-radius: 3px;
        color: var(--primary-color);
    }

    .available-variables ul {
        list-style-type: none;
        padding-left: 0;
    }

    .available-variables li {
        margin-bottom: 8px;
    }

    .card {
        border: 1px solid var(--colors-neutral-5);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .diff-line {
        padding: 2px 4px;
        font-family: monospace;
        white-space: pre-wrap;
        line-height: 1.4;
        margin-left: 15px;  /* Add space for the +/- indicators */
    }

    .diff-added {
        background-color: #e6ffe6;
        position: relative;
    }

    .diff-removed {
        background-color: #ffe6e6;
        position: relative;
    }

    .diff-added::before {
        content: '+';
        color: var(--secondary-color);
        position: absolute;
        left: -10px;
    }

    .diff-removed::before {
        content: '-';
        color: var(--colors-error-9);
        position: absolute;
        left: -10px;
    }

    .prompt-section {
        margin-bottom: 20px;
    }

    .prompt-section h5 {
        margin-bottom: 10px;
        color: var(--dark-gray);
    }

    .delete-version {
        float: right;
        margin-left: 10px;
        padding: 0 4px;
        font-size: 0.7em;
        line-height: 1.2;
    }

    .delete-version:hover {
        opacity: 0.7;
    }

    #prompt-version option {
        padding: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>

        </div> <!-- End container -->
    </div> <!-- End prompt-manager-scrollable -->
</div> <!-- End prompt-manager-container -->

<style>
/* Prompt Manager container matching other pages */
.prompt-manager-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.prompt-manager-scrollable {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

/* Breadcrumb Header */
.page-breadcrumb-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: white;
    border-bottom: 1px solid var(--colors-neutral-4);
    flex-shrink: 0;
}

.breadcrumb-text {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--colors-neutral-8);
}

.breadcrumb-text .font-medium {
    font-weight: 500;
    color: var(--colors-neutral-12);
}

.page-header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* Subtle button styling */
.btn-icon {
    background: white;
    border: 1px solid var(--colors-neutral-4);
    color: var(--colors-neutral-8);
    padding: 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
}

.btn-icon:hover {
    background: var(--colors-neutral-3);
    border-color: #d1d5db;
    color: var(--colors-neutral-12);
}

.btn-topic-setup {
    background: var(--colors-neutral-3);
    border: none;
    color: var(--colors-neutral-12);
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.btn-topic-setup:hover {
    background: var(--colors-neutral-4);
    color: var(--colors-neutral-12);
}

/* Override bright pink buttons to subtle style */
.btn-primary {
    background: white !important;
    border: 1px solid var(--colors-neutral-4) !important;
    color: var(--colors-accent-8) !important;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    background: var(--colors-accent-1) !important;
    border-color: var(--colors-accent-3) !important;
    color: var(--colors-accent-8) !important;
}

.btn-success {
    background: white !important;
    border: 1px solid var(--colors-neutral-4) !important;
    color: var(--colors-success-9) !important;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-success:hover {
    background: #f0fdf4 !important;
    border-color: #d1fae5 !important;
    color: var(--colors-success-9) !important;
}

.btn-secondary {
    background: white !important;
    border: 1px solid var(--colors-neutral-4) !important;
    color: var(--colors-neutral-12) !important;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: var(--colors-neutral-3) !important;
    border-color: #d1d5db !important;
    color: var(--colors-neutral-12) !important;
}

.btn-danger, .btn-outline-danger {
    background: white !important;
    border: 1px solid var(--colors-neutral-4) !important;
    color: var(--colors-error-7) !important;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-danger:hover, .btn-outline-danger:hover {
    background: #fef2f2 !important;
    border-color: #fecaca !important;
    color: var(--colors-error-7) !important;
}

.btn-warning {
    background: white !important;
    border: 1px solid var(--colors-neutral-4) !important;
    color: var(--colors-warning-6) !important;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-warning:hover {
    background: var(--colors-white)beb !important;
    border-color: #fde68a !important;
    color: var(--colors-warning-6) !important;
}

.btn-info {
    background: white !important;
    border: 1px solid var(--colors-neutral-4) !important;
    color: #3b82f6 !important;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-info:hover {
    background: #eff6ff !important;
    border-color: #bfdbfe !important;
    color: #3b82f6 !important;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .page-breadcrumb-header {
        padding: 0.5rem 1rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .breadcrumb-text {
        font-size: 0.75rem;
    }

    .page-header-actions {
        width: 100%;
        justify-content: flex-end;
    }

    .btn-topic-setup {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
    }
}
</style>
{% endblock %} 