{% extends "base.html" %}

{% block title %}AuNoo AI - Vantage Desk{% endblock %}

{% block extra_js %}
<!-- Chart.js for sentiment distribution chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: var(--colors-accent-7);
        --primary-dark: var(--colors-accent-10);
        --secondary-color: #32CD32;
        --secondary-dark: #228B22;
        --text-color: var(--colors-neutral-11);
        --light-gray: var(--colors-neutral-2);
        --medium-gray: var(--colors-neutral-4);
        --dark-gray: var(--colors-neutral-10);
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
    }

    body {
        background-color: var(--light-gray);
    }

    /* Dashboard Layout */
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .dashboard-header {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 24px;
        margin-bottom: 24px;
    }

    .dashboard-title {
        color: var(--primary-color);
        font-size: 2rem;
        font-weight: 600;
        margin: 0;
    }

    /* Feed Tabs */
    .feed-tabs-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 24px;
        overflow: hidden;
    }

    .tab-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--medium-gray);
    }

    .feed-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .feed-tab {
        background: var(--light-gray);
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .feed-tab:hover {
        background: var(--medium-gray);
        transform: translateY(-1px);
    }

    .feed-tab.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .tab-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .tab-count {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    /* Feed Content */
    .feed-content {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        min-height: 600px;
    }

    .feed-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--medium-gray);
        flex-wrap: wrap;
        gap: 16px;
    }

    .feed-items {
        padding: 24px;
        max-height: 80vh;
        overflow-y: auto;
        scroll-behavior: smooth;
    }

    .feed-item {
        background: white;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.2s;
        position: relative;
    }

    .feed-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .feed-item.starred {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(90deg, rgba(255, 105, 180, 0.05) 0%, rgba(255, 255, 255, 1) 20%);
    }

    .feed-item.starred:hover {
        box-shadow: 0 4px 12px rgba(255, 105, 180, 0.2);
    }

    /* ArXiv-specific styling */
    .feed-item.arxiv-item {
        border-left: 4px solid #b31b1b;
        background: linear-gradient(90deg, rgba(179, 27, 27, 0.03) 0%, rgba(255, 255, 255, 1) 15%);
        position: relative;
    }

    .feed-item.arxiv-item::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 3px;
        background: repeating-linear-gradient(
            to bottom,
            #b31b1b 0px,
            #b31b1b 8px,
            transparent 8px,
            transparent 16px
        );
        opacity: 0.3;
    }

    .feed-item.arxiv-item:hover {
        box-shadow: 0 4px 12px rgba(179, 27, 27, 0.15);
        border-left-color: #d12d2d;
    }

    .feed-item.arxiv-item.starred {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(90deg, rgba(255, 105, 180, 0.05) 0%, rgba(179, 27, 27, 0.03) 50%, rgba(255, 255, 255, 1) 80%);
    }

    .feed-item.arxiv-item .feed-item-title a {
        color: #8b1818;
    }

    .feed-item.arxiv-item .feed-item-title a:hover {
        color: #b31b1b;
    }

    /* Bluesky-specific styling */
    .feed-item.bluesky-item {
        border-left: 4px solid #0085ff;
        background: linear-gradient(90deg, rgba(0, 133, 255, 0.03) 0%, rgba(255, 255, 255, 1) 15%);
        position: relative;
    }

    .feed-item.bluesky-item::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 3px;
        background: repeating-linear-gradient(
            to bottom,
            #0085ff 0px,
            #0085ff 6px,
            transparent 6px,
            transparent 12px
        );
        opacity: 0.3;
    }

    .feed-item.bluesky-item:hover {
        box-shadow: 0 4px 12px rgba(0, 133, 255, 0.15);
        border-left-color: #00a3ff;
    }

    .feed-item.bluesky-item.starred {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(90deg, rgba(255, 105, 180, 0.05) 0%, rgba(0, 133, 255, 0.03) 50%, rgba(255, 255, 255, 1) 80%);
    }

    .feed-item.bluesky-item .feed-item-title a {
        color: #0066cc;
    }

    .feed-item.bluesky-item .feed-item-title a:hover {
        color: #0085ff;
    }

    /* TheNewsAPI-specific styling */
    .feed-item.thenewsapi-item {
        border-left: 4px solid #1e7e34;
        background: linear-gradient(90deg, rgba(30, 126, 52, 0.03) 0%, rgba(255, 255, 255, 1) 15%);
        position: relative;
    }

    .feed-item.thenewsapi-item::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 3px;
        background: repeating-linear-gradient(
            to bottom,
            #1e7e34 0px,
            #1e7e34 4px,
            transparent 4px,
            transparent 8px
        );
        opacity: 0.3;
    }

    .feed-item.thenewsapi-item:hover {
        box-shadow: 0 4px 12px rgba(30, 126, 52, 0.15);
        border-left-color: var(--colors-success-9);
    }

    .feed-item.thenewsapi-item.starred {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(90deg, rgba(255, 105, 180, 0.05) 0%, rgba(30, 126, 52, 0.03) 50%, rgba(255, 255, 255, 1) 80%);
    }

    .feed-item.thenewsapi-item .feed-item-title a {
        color: #155724;
    }

    .feed-item.thenewsapi-item .feed-item-title a:hover {
        color: #1e7e34;
    }

    /* Source badges */
    .source-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .source-badge.arxiv {
        background: linear-gradient(135deg, #b31b1b, #d12d2d);
        color: white;
        border: 1px solid #a01818;
    }

    .source-badge.bluesky {
        background: linear-gradient(135deg, #0085ff, #00a3ff);
        color: white;
        border: 1px solid #0070d9;
    }

    .source-badge.thenewsapi {
        background: linear-gradient(135deg, #1e7e34, var(--colors-success-9));
        color: white;
        border: 1px solid #1c6c32;
    }

    .source-badge i {
        font-size: 1rem;
    }

    /* Subtle watermark patterns for better source identification */
    .feed-item.arxiv-item::after {
        content: 'üìö';
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.2rem;
        opacity: 0.1;
        pointer-events: none;
    }

    .feed-item.bluesky-item::after {
        content: 'üê¶';
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.2rem;
        opacity: 0.1;
        pointer-events: none;
    }

    .feed-item.thenewsapi-item::after {
        content: 'üì∞';
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.2rem;
        opacity: 0.1;
        pointer-events: none;
    }

    /* Enhanced hover effects */
    .feed-item.arxiv-item:hover::after {
        opacity: 0.2;
        transform: scale(1.1);
        transition: all 0.2s ease;
    }

    .feed-item.bluesky-item:hover::after {
        opacity: 0.2;
        transform: scale(1.1);
        transition: all 0.2s ease;
    }

    .feed-item.thenewsapi-item:hover::after {
        opacity: 0.2;
        transform: scale(1.1);
        transition: all 0.2s ease;
    }

    .feed-item-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 12px;
    }

    .feed-item-title a {
        color: inherit;
        text-decoration: none;
    }

    .feed-item-title a:hover {
        color: var(--primary-color);
    }

    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 60px;
        flex-direction: column;
        gap: 16px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--light-gray);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .btn-tab-control {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid var(--medium-gray);
        background: white;
        color: var(--text-color);
        font-size: 0.9rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
    }

    .btn-tab-control:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-1px);
    }

    .btn-primary-control {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .btn-primary-control:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
        color: white;
    }

    .btn-enrichment {
        background: #9966CC;
        border-color: #9966CC;
        color: white;
    }

    .btn-enrichment:hover:not(:disabled) {
        background: #7A4FA0;
        border-color: #7A4FA0;
        color: white;
    }

    .btn-enrichment:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Square Icon Buttons */
    .btn-square {
        width: 34px;
        height: 34px;
        padding: 0;
        border: 1px solid var(--medium-gray);
        border-radius: 6px;
        background: white;
        color: var(--colors-neutral-9);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .btn-square:hover {
        background: var(--colors-neutral-2);
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-square:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .btn-square:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-square:disabled:hover {
        background: white;
        border-color: var(--medium-gray);
        color: var(--colors-neutral-9);
        transform: none;
        box-shadow: none;
    }

    /* Square Button Color Variants */
    .btn-square.btn-danger {
        background: var(--colors-error-9);
        border-color: var(--colors-error-9);
        color: white;
    }

    .btn-square.btn-danger:hover:not(:disabled) {
        background: #c82333;
        border-color: #bd2130;
        color: white;
    }

    .btn-square.btn-warning {
        background: var(--colors-warning-9);
        border-color: var(--colors-warning-9);
        color: var(--colors-neutral-11);
    }

    .btn-square.btn-warning:hover:not(:disabled) {
        background: #e0a800;
        border-color: #d39e00;
        color: var(--colors-neutral-11);
    }

    .btn-square.btn-info {
        background: var(--colors-info-9);
        border-color: var(--colors-info-9);
        color: white;
    }

    .btn-square.btn-info:hover:not(:disabled) {
        background: #138496;
        border-color: #117a8b;
        color: white;
    }

    .btn-square.btn-secondary {
        background: var(--colors-neutral-8);
        border-color: var(--colors-neutral-8);
        color: white;
    }

    .btn-square.btn-secondary:hover:not(:disabled) {
        background: #5a6268;
        border-color: #545b62;
        color: white;
    }

    .btn-square.btn-enrichment {
        background: #9966CC;
        border-color: #9966CC;
        color: white;
    }

    .btn-square.btn-enrichment:hover:not(:disabled) {
        background: #7A4FA0;
        border-color: #7A4FA0;
        color: white;
    }

    .btn-square.btn-success {
        background: var(--colors-success-9);
        border-color: var(--colors-success-9);
        color: white;
    }

    .btn-square.btn-success:hover:not(:disabled) {
        background: #218838;
        border-color: #1e7e34;
        color: white;
    }

    .btn-square.btn-primary {
        background: #007bff;
        border-color: #007bff;
        color: white;
    }

    .btn-square.btn-primary:hover:not(:disabled) {
        background: #0069d9;
        border-color: #0062cc;
        color: white;
    }

    /* Button Groups */
    .button-group {
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Additional styles for filter selects */
    .filter-select {
        border: 1px solid var(--medium-gray);
        border-radius: 6px;
        padding: 8px 12px;
        background: white;
        min-width: 120px;
        margin-left: 8px;
    }

    .filter-select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.2);
    }

    .filter-select:disabled {
        background-color: var(--light-gray);
        color: var(--medium-gray);
        border-color: var(--medium-gray);
        cursor: not-allowed;
        opacity: 0.7;
    }

    .feed-controls-left,
    .feed-controls-right {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .feed-filter {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Layout Modes - Compact Table */
    .layout-compact .compact-table {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .layout-compact .compact-table th {
        background: var(--colors-neutral-2) !important;
        border-bottom: 2px solid var(--colors-neutral-5) !important;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .layout-compact .compact-table tr {
        background: white;
        transition: background-color 0.15s ease;
    }

    .layout-compact .compact-table tr:hover {
        background: var(--colors-neutral-2) !important;
    }

    .layout-compact .compact-table tr:nth-child(even) {
        background: #fafafa;
    }

    .layout-compact .compact-table tr:nth-child(even):hover {
        background: #f0f0f0 !important;
    }

    .layout-compact .compact-table td {
        padding: 8px;
        vertical-align: middle;
        border-bottom: 1px solid var(--colors-neutral-4);
    }

    .layout-compact .compact-table td a {
        color: var(--colors-neutral-11);
        text-decoration: none;
        font-weight: 500;
    }

    .layout-compact .compact-table td a:hover {
        color: #007bff;
        text-decoration: underline;
    }

    .layout-compact .compact-table .compact-row.starred {
        background: var(--colors-warning-2) !important;
    }

    .layout-compact .compact-table .compact-row.starred:hover {
        background: #ffeaa7 !important;
    }

    /* Hide additional elements in compact mode */
    .layout-compact .feed-item::before {
        display: none !important;
    }

    .layout-compact .feed-item .badge {
        display: none !important;
    }

    /* Timeline Layout */
    .layout-timeline {
        position: relative;
        padding-left: 50px;
        background: linear-gradient(135deg, #fafbfc, var(--colors-white));
    }

    .layout-timeline::before {
        content: '';
        position: absolute;
        left: 25px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
        border-radius: 2px;
        opacity: 0.3;
    }

    .layout-timeline .feed-item {
        position: relative;
        margin-left: 25px;
        margin-bottom: 24px;
        padding: 16px 20px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--light-gray);
    }

    .layout-timeline .feed-item::before {
        content: '';
        position: absolute;
        left: -37px;
        top: 15px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.1);
        z-index: 2;
    }

    /* Source-specific timeline markers */
    .layout-timeline .feed-item.arxiv-item::before {
        border-color: #b31b1b;
        box-shadow: 0 0 0 3px rgba(179, 27, 27, 0.1);
    }

    .layout-timeline .feed-item.bluesky-item::before {
        border-color: #0085ff;
        box-shadow: 0 0 0 3px rgba(0, 133, 255, 0.1);
    }

    .layout-timeline .feed-item.thenewsapi-item::before {
        border-color: #1e7e34;
        box-shadow: 0 0 0 3px rgba(30, 126, 52, 0.1);
    }

    .layout-timeline .feed-item:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .layout-timeline .feed-item:hover::before {
        transform: scale(1.2);
        box-shadow: 0 0 0 6px rgba(255, 105, 180, 0.15);
    }

    /* Timeline date headers */
    .timeline-date-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 8px 16px;
        margin: 0 -20px 16px -20px;
        border-bottom: 1px solid var(--light-gray);
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--primary-color);
    }

    /* Search highlighting */
    .search-highlight {
        background-color: yellow;
        font-weight: bold;
    }

    /* Enrichment Results Styling */
    .result-item-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 6px;
        z-index: 10;
    }

    .summary-badge {
        font-size: 0.7rem;
        min-width: 24px;
        text-align: center;
    }

    .ai-summary {
        font-size: 0.85rem;
        line-height: 1.4;
    }

    /* Badge styling with icons */
    .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.35em 0.6em;
    }

    /* Column View Layout */
    .column-view-container {
        display: none;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
        max-height: 85vh;
    }

    .column-view-container.active {
        display: grid;
    }

    .feed-column {
        border: 1px solid var(--medium-gray);
        border-radius: var(--border-radius);
        background: white;
        box-shadow: var(--card-shadow);
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .feed-column-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--medium-gray);
        background: var(--light-gray);
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
    }

    .column-bulk-actions {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        align-items: center;
    }

    .column-bulk-actions .btn {
        padding: 2px 6px;
        font-size: 11px;
        border-radius: 3px;
        line-height: 1.2;
    }

    .column-item-checkbox {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 5;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .column-item-checkbox input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        margin: 0;
    }

    .column-item:hover .column-item-checkbox {
        opacity: 1;
    }

    .column-item.selected {
        background: #e7f3ff;
        border-color: #0d6efd;
    }

    .feed-column-title {
        font-weight: 600;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .feed-column-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        min-height: 0;
    }

    .column-item {
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        transition: all 0.2s;
        position: relative;
    }

    .column-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .column-item.starred {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(90deg, rgba(255, 105, 180, 0.05) 0%, rgba(255, 255, 255, 1) 20%);
    }

    .column-item-title {
        font-size: 0.95rem;
        font-weight: 600;
        line-height: 1.4;
        margin-bottom: 8px;
    }

    .column-item-title a {
        color: var(--text-color);
        text-decoration: none;
    }

    .column-item-title a:hover {
        color: var(--primary-color);
    }

    .column-item-meta {
        font-size: 0.8rem;
        color: var(--dark-gray);
        margin-bottom: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .column-item-content {
        font-size: 0.85rem;
        line-height: 1.4;
        color: var(--text-color);
        margin-bottom: 8px;
    }

    .column-item-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .column-item:hover .column-item-actions {
        opacity: 1;
    }

    .column-action-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.9);
        color: var(--dark-gray);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        transition: all 0.2s;
    }

    .column-action-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .column-action-btn.starred {
        background: var(--primary-color);
        color: white;
    }

    /* Media Bias Styling */
    .bias-badge {
        display: inline-block;
        padding: 0.15rem 0.4rem;
        border-radius: 8px;
        font-size: 0.65rem;
        font-weight: 500;
        margin-right: 4px;
    }

    .bias-left { background-color: #3373CC; color: white; }
    .bias-left-center { background-color: #6699EE; color: white; }
    .bias-least-biased, .bias-center { background-color: #88CC88; color: black; }
    .bias-right-center { background-color: #FF9966; color: black; }
    .bias-right { background-color: #CC3333; color: white; }
    .bias-pro-science { background-color: #9966CC; color: white; }
    .bias-conspiracy-pseudoscience { background-color: var(--colors-neutral-8)666; color: white; }
    .bias-questionable { background-color: #222222; color: white; }
    .bias-satire { background-color: #CCBB33; color: black; }

    .factual-very-high { background-color: #006600; color: white; }
    .factual-high, .factual-mostly-factual { background-color: #339933; color: white; }
    .factual-mixed { background-color: var(--colors-neutral-6)C00; color: black; }
    .factual-low, .factual-very-low { background-color: #CC0000; color: white; }

    /* Tag styles */
    .article-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }

    .article-tag {
        background: var(--light-gray);
        color: var(--dark-gray);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        border: 1px solid var(--medium-gray);
    }

    .tag-input {
        display: none;
        margin-top: 8px;
    }

    .tag-input input {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid var(--medium-gray);
        border-radius: 4px;
        font-size: 0.8rem;
    }

    /* Hide tab view when column view is active */
    .view-tabs .feed-tabs-container,
    .view-tabs .feed-content {
        display: block;
    }

    /* In column view, keep feed group tabs visible but hide the main feed content */
    .view-columns .feed-content {
        display: none;
    }

    /* Article Hover Details */
    .feed-item, .column-item {
        position: relative;
    }

    .article-hover-details {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 16px;
        z-index: 1000;
        max-height: 400px;
        overflow-y: auto;
        display: none;
        margin-top: 8px;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .feed-item:hover .article-hover-details,
    .column-item:hover .article-hover-details {
        display: block;
    }

    .article-hover-details h6 {
        color: var(--primary-color);
        margin-bottom: 8px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .article-hover-details .meta-item {
        margin-bottom: 6px;
        font-size: 0.8rem;
        color: var(--dark-gray);
    }

    .article-hover-details .content-preview {
        background: var(--light-gray);
        padding: 12px;
        border-radius: 6px;
        margin: 8px 0;
        font-size: 0.85rem;
        max-height: 150px;
        overflow-y: auto;
    }

    /* Responsive improvements */
    @media (max-width: 1200px) {
        .column-view-container {
            grid-template-columns: 1fr 1fr;
        }
        
        .feed-column:nth-child(3) {
            grid-column: 1 / -1;
        }
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: 0 16px;
        }

        .column-view-container {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .feed-tabs {
            flex-direction: column;
            width: 100%;
        }

        .feed-tab {
            justify-content: center;
        }

        .feed-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .feed-controls-left,
        .feed-controls-right {
            justify-content: center;
        }

        .result-item-actions {
            position: relative;
            top: 0;
            right: 0;
            margin-bottom: 8px;
        }

        /* Ensure bulk star buttons work well on mobile */
        #bulkStarBtn, #bulkUnstarBtn {
            font-size: 0.8rem;
        }
    }

    /* Media Bias Badges */
    .bias-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
        color: white;
        margin-right: 4px;
        background: var(--colors-neutral-8);
    }

    /* Bias-specific colors */
    .bias-left { background: #007bff; }
    .bias-left-center { background: var(--colors-info-9); }
    .bias-least-biased { background: var(--colors-success-9); }
    .bias-right-center { background: #fd7e14; }
    .bias-right { background: var(--colors-error-9); }
    .bias-mixed { background: #6f42c1; }
    .bias-satire { background: #e83e8c; }
    .bias-questionable { background: var(--colors-neutral-8); }

    /* Factual reporting colors */
    .factual-very-high { background: var(--colors-success-9); }
    .factual-high { background: #20c997; }
    .factual-mostly-factual { background: var(--colors-info-9); }
    .factual-mixed { background: #fd7e14; }
    .factual-low { background: var(--colors-error-9); }
    .factual-very-low { background: var(--colors-neutral-8); }

    /* Article Tags */
    .article-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-bottom: 8px;
    }

    .article-tag {
        background: var(--light-gray);
        color: var(--dark-gray);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Tag Input */
    .tag-input {
        display: none;
        margin-top: 8px;
    }

    .tag-input input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid var(--medium-gray);
        border-radius: 4px;
        font-size: 0.85rem;
    }

    /* Column Item Styles */
    .column-item {
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        background: white;
        position: relative;
        transition: all 0.2s ease;
    }

    .column-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .column-item.starred {
        border-color: var(--accent-color);
        background: linear-gradient(135deg, var(--colors-white) 0%, var(--colors-white)9c4 100%);
    }

    .column-item-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .enrichment-indicator {
        position: absolute;
        top: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        background: var(--colors-success-9);
        border-radius: 50%;
        border: 2px solid white;
        z-index: 10;
    }

    .enrichment-badges .badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        margin-right: 2px;
    }

    .column-item:hover .column-item-actions {
        opacity: 1;
    }

    .column-action-btn {
        background: white;
        border: 1px solid var(--medium-gray);
        border-radius: 4px;
        padding: 4px 6px;
        cursor: pointer;
        font-size: 0.8rem;
        color: var(--dark-gray);
        transition: all 0.2s ease;
    }

    .column-action-btn:hover {
        background: var(--light-gray);
        color: var(--primary-color);
    }

    .column-action-btn.starred {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .column-item-title {
        font-weight: 600;
        margin-bottom: 8px;
        padding-right: 80px;
        line-height: 1.3;
    }

    .column-item-title a {
        color: var(--text-color);
        text-decoration: none;
    }

    .column-item-title a:hover {
        color: var(--primary-color);
    }

    .column-item-meta {
        display: flex;
        gap: 12px;
        font-size: 0.8rem;
        color: var(--dark-gray);
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .column-item-content {
        font-size: 0.9rem;
        color: var(--text-color);
        line-height: 1.4;
        margin-bottom: 8px;
    }

    /* Column infinite scroll styles */
    .column-loading {
        padding: 10px;
        text-align: center;
        border-top: 1px solid var(--light-gray);
        background: rgba(0, 0, 0, 0.02);
    }

    .feed-column-content {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--medium-gray) transparent;
    }

    .feed-column-content::-webkit-scrollbar {
        width: 6px;
    }

    .feed-column-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .feed-column-content::-webkit-scrollbar-thumb {
        background-color: var(--medium-gray);
        border-radius: 3px;
    }

    .feed-column-content::-webkit-scrollbar-thumb:hover {
        background-color: var(--dark-gray);
    }

    /* Smart Clustering Styles */
    .clustering-section {
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .insight-item-card {
        background: white;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        padding: 16px;
        margin: 8px;
        flex: 1;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        position: relative;
    }

    .insight-item-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .insight-item-card .badge {
        font-size: 0.7rem;
        padding: 3px 8px;
    }

    .thematic-cluster {
        background: linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
        border-left: 4px solid var(--primary-color);
    }

    .sentiment-cluster {
        background: linear-gradient(135deg, rgba(50, 205, 50, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
        border-left: 4px solid var(--secondary-color);
    }

    .temporal-cluster {
        background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
        border-left: 4px solid #3498db;
    }

    .source-cluster {
        background: linear-gradient(135deg, rgba(155, 89, 182, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
        border-left: 4px solid #9b59b6;
    }

    .cluster-article-list {
        max-height: 200px;
        overflow-y: auto;
        border-top: 1px solid var(--medium-gray);
        margin-top: 12px;
        padding-top: 12px;
    }

    .cluster-article-item {
        padding: 8px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-size: 0.85rem;
    }

    .cluster-article-item:last-child {
        border-bottom: none;
    }

    .cluster-article-item a {
        color: var(--text-color);
        text-decoration: none;
        font-weight: 500;
    }

    .cluster-article-item a:hover {
        color: var(--primary-color);
        text-decoration: underline;
    }
    
    /* Enhanced Cluster Article Display */
    .cluster-filter-controls {
        border-bottom: 1px solid var(--colors-neutral-4);
        padding-bottom: 10px;
        margin-bottom: 10px;
    }
    
    .cluster-article-item {
        padding: 12px;
        border: 1px solid var(--colors-neutral-4);
        border-radius: 8px;
        margin-bottom: 10px;
        background: #fafafa;
        transition: all 0.2s ease;
    }
    
    .cluster-article-item:hover {
        background: #f0f8ff;
        border-color: #3498db;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
    }
    
    .cluster-actions {
        border-top: 1px solid var(--colors-neutral-4);
        padding-top: 10px;
        margin-top: 10px;
    }
    
    .cluster-actions .btn {
        margin-right: 8px;
        font-size: 0.8rem;
    }
    
    .article-actions {
        display: flex;
        gap: 5px;
    }
    
    .cluster-article-list {
        border-top: 2px solid var(--colors-neutral-4);
        padding-top: 15px;
        max-height: none; /* Override previous restriction */
    }

    .cluster-stats {
        display: flex;
        gap: 16px;
        margin-top: 12px;
        font-size: 0.8rem;
        color: var(--dark-gray);
    }

    .cluster-stat {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .temporal-timeline {
        position: relative;
        padding: 20px 0;
    }

    .temporal-timeline::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
    }

    .temporal-event {
        position: relative;
        padding: 16px 0 16px 50px;
        margin-bottom: 16px;
    }

    .temporal-event::before {
        content: '';
        position: absolute;
        left: 14px;
        top: 24px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary-color);
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .temporal-event-immediate::before { background: #e74c3c; }
    .temporal-event-short::before { background: #f39c12; }
    .temporal-event-medium::before { background: #3498db; }
    .temporal-event-long::before { background: #9b59b6; }

    .source-authority-bar {
        height: 4px;
        background: var(--medium-gray);
        border-radius: 2px;
        overflow: hidden;
        margin: 8px 0;
    }

    .source-authority-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        transition: width 0.3s ease;
    }

    .clustering-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--dark-gray);
    }

    .clustering-loading i {
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Multi-Combination Filter Styles */
    .multi-filter-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 24px;
        margin-bottom: 24px;
    }

    .filter-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .filter-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }

    .filter-icon {
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .filter-subtitle {
        color: var(--dark-gray);
        font-size: 0.9rem;
        margin-bottom: 20px;
        opacity: 0.8;
    }

    /* Add New Combination Section */
    .add-combination-section {
        background: var(--light-gray);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px dashed var(--medium-gray);
        transition: all 0.3s;
    }

    .add-combination-section:hover {
        border-color: var(--primary-color);
        background: rgba(255, 105, 180, 0.05);
    }

    .combination-form {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 180px;
    }

    .filter-label {
        font-weight: 500;
        color: var(--text-color);
        white-space: nowrap;
        font-size: 0.9rem;
    }

    .filter-connector {
        color: var(--primary-color);
        font-weight: 600;
        font-size: 1rem;
        margin: 0 4px;
    }

    .add-combination-btn {
        background: var(--primary-color);
        border: 1px solid var(--primary-color);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .add-combination-btn:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
        transform: translateY(-1px);
    }

    .add-combination-btn:disabled {
        background: var(--medium-gray);
        border-color: var(--medium-gray);
        cursor: not-allowed;
        transform: none;
    }

    /* Active Combinations Section */
    .active-combinations {
        margin-top: 20px;
    }

    .combinations-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .combinations-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }

    .clear-all-btn {
        background: transparent;
        border: 1px solid var(--medium-gray);
        color: var(--text-color);
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .clear-all-btn:hover {
        border-color: var(--colors-error-9);
        color: var(--colors-error-9);
    }

    .combination-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .combination-item {
        background: white;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
        position: relative;
    }

    .combination-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .combination-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .date-badge {
        background: var(--light-gray);
        border: 1px solid var(--medium-gray);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-color);
    }

    .remove-combination {
        background: var(--colors-error-9);
        border: none;
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .remove-combination:hover {
        background: #c82333;
        transform: scale(1.1);
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--dark-gray);
        opacity: 0.6;
    }

    .empty-state-icon {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    /* Multi-Filter Responsive design */
    @media (max-width: 768px) {
        .combination-form {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            min-width: auto;
            width: 100%;
        }

        .filter-select {
            min-width: auto;
            flex: 1;
        }

        .add-combination-btn {
            justify-content: center;
        }

        .combination-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .combination-item {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .remove-combination {
            align-self: flex-end;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container mt-4">
    <!-- Dashboard Header -->
            <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="dashboard-title">Vantage Desk</h1>
                    <p class="dashboard-subtitle" style="color: var(--dark-gray); margin: 8px 0 0 0; font-size: 1.1rem;">News, social media and academic content in one place</p>
                </div>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <!-- View Mode Toggle -->
                    <div class="btn-group" role="group" aria-label="View Mode">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="tabViewBtn" onclick="switchViewMode('tabs')" title="Tab View">
                            <i class="fas fa-folder"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="columnViewBtn" onclick="switchViewMode('columns')" title="Column View">
                            <i class="fas fa-columns"></i>
                        </button>
                    </div>

                    <!-- Auto-refresh controls -->
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="autoRefreshDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 0.85rem; padding: 4px 8px;">
                            <i class="fas fa-clock me-1"></i>
                            <span id="refreshStatusText">Manual</span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="autoRefreshDropdown">
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(0)">Manual Refresh</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(5)">Every 5 minutes</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(15)">Every 15 minutes</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(30)">Every 30 minutes</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(60)">Every hour</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(720)">Every 12 hours</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(1440)">Every 24 hours</a></li>
                        </ul>
                    </div>

                    <button class="btn-tab-control btn-success" onclick="toggleSmartClustering()" id="smartClusteringBtn" title="Toggle AI-powered content clustering and analysis">
                        <i class="fas fa-brain"></i>
                        Smart Clustering
                    </button>
                    <button class="btn-tab-control btn-warning" onclick="showOnlyStarredItems()" title="Quick filter to show only starred items">
                        <i class="fas fa-star"></i>
                        View Starred
                    </button>
                    <button class="btn-tab-control" onclick="refreshCurrentFeed()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <button class="btn-tab-control btn-primary-control" onclick="window.location.href='/feed-manager'">
                        <i class="fas fa-cog"></i>
                        Manage Groups
                    </button>
                </div>
            </div>
        </div>

    <!-- Feed Group Tabs -->
    <div class="feed-tabs-container">
        <div class="tab-header">
            <ul class="feed-tabs" id="feedTabs">
                <!-- Tabs will be populated by JavaScript -->
            </ul>
            <div style="display: flex; gap: 12px; align-items: center;">
                <!-- Collection Actions Group -->
                <div class="button-group" style="display: flex; gap: 2px; padding: 2px; background: rgba(40, 167, 69, 0.1); border-radius: 4px;">
                    <button class="btn-square btn-success" onclick="collectFeedItems()" title="Collect New Articles">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-square btn-primary" onclick="window.location.href='/feed-manager'" title="Create New Feed Group">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; margin-left: 16px; padding-left: 16px; border-left: 1px solid var(--medium-gray);">
                    <div style="display: flex; align-items: center; gap: 6px; color: var(--primary-color); font-weight: 500;">
                        <i class="fas fa-star"></i>
                        <span id="totalStarredCount">0</span>
                        <span style="color: var(--dark-gray); font-size: 0.9rem;">starred</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Clustering Section (Global) -->
    <div class="clustering-section" id="clusteringSection" style="display: none; margin-bottom: 24px; background: white; border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 24px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-brain me-2" style="color: var(--primary-color);"></i>
                Smart Content Clustering
            </h5>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="refreshClustering()" id="refreshClusteringBtn">
                    <i class="fas fa-sync-alt me-1"></i>
                    Refresh Analysis
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleClusteringView()" id="toggleClusteringBtn">
                    <i class="fas fa-eye-slash me-1"></i>
                    Hide Clustering
                </button>
            </div>
        </div>
        
        <!-- Clustering Tabs -->
        <ul class="nav nav-tabs nav-fill mb-3" id="clusteringTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="thematic-clustering-tab" data-bs-toggle="tab" data-bs-target="#thematic-clustering-content" type="button" role="tab" aria-controls="thematic-clustering-content" aria-selected="true" title="Group articles by themes and topics">
                    <i class="fas fa-sitemap me-1"></i>
                    Thematic Clusters
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sentiment-clustering-tab" data-bs-toggle="tab" data-bs-target="#sentiment-clustering-content" type="button" role="tab" aria-controls="sentiment-clustering-content" aria-selected="false" title="Group articles by sentiment and impact">
                    <i class="fas fa-chart-line me-1"></i>
                    Sentiment Analysis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="temporal-clustering-tab" data-bs-toggle="tab" data-bs-target="#temporal-clustering-content" type="button" role="tab" aria-controls="temporal-clustering-content" aria-selected="false" title="Timeline-based clustering with future impact">
                    <i class="fas fa-clock me-1"></i>
                    Temporal Impact
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="source-clustering-tab" data-bs-toggle="tab" data-bs-target="#source-clustering-content" type="button" role="tab" aria-controls="source-clustering-content" aria-selected="false" title="Group articles by source type and authority">
                    <i class="fas fa-layer-group me-1"></i>
                    Source Analysis
                </button>
            </li>
        </ul>
        
        <!-- Clustering Content -->
        <div class="tab-content" id="clusteringTabContent">
            <!-- Thematic Clustering -->
            <div class="tab-pane fade show active" id="thematic-clustering-content" role="tabpanel" aria-labelledby="thematic-clustering-tab">
                <div class="d-flex flex-row flex-wrap justify-content-start align-items-stretch" id="thematic-insights-container">
                    <div class="loading-indicator w-100 text-center">
                        <i class="fas fa-brain me-2"></i>
                        Analyzing themes and topics...
                    </div>
                </div>
            </div>
            
            <!-- Sentiment Clustering -->
            <div class="tab-pane fade" id="sentiment-clustering-content" role="tabpanel" aria-labelledby="sentiment-clustering-tab">
                <div class="row">
                    <div class="col-md-8">
                        <div id="sentiment-insights-container">
                            <div class="loading-indicator text-center">
                                <i class="fas fa-chart-line me-2"></i>
                                Analyzing sentiment patterns...
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="sentiment-summary-card" style="background: var(--light-gray); border-radius: 8px; padding: 16px;">
                            <h6 class="mb-3">Sentiment Distribution</h6>
                            <div id="sentiment-chart-container" style="height: 200px;">
                                <canvas id="sentimentDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Temporal Clustering -->
            <div class="tab-pane fade" id="temporal-clustering-content" role="tabpanel" aria-labelledby="temporal-clustering-tab">
                <div class="temporal-analysis-controls mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-3 align-items-center">
                            <label for="timeHorizonSelect" class="form-label mb-0">Time Horizon:</label>
                            <select class="form-select form-select-sm" id="timeHorizonSelect" style="width: auto;" onchange="updateTemporalClustering()">
                                <option value="immediate">Immediate (0-6 months)</option>
                                <option value="short" selected>Short-term (6-18 months)</option>
                                <option value="medium">Medium-term (1-3 years)</option>
                                <option value="long">Long-term (3-10 years)</option>
                            </select>
                        </div>
                        <div class="analysis-depth-control">
                            <label for="analysisDepthSelect" class="form-label mb-0 me-2">Analysis Depth:</label>
                            <select class="form-select form-select-sm" id="analysisDepthSelect" style="width: auto;" onchange="updateTemporalClustering()">
                                <option value="quick">Quick Analysis</option>
                                <option value="standard" selected>Standard Analysis</option>
                                <option value="deep">Deep Analysis</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="temporal-insights-container">
                    <div class="loading-indicator text-center">
                        <i class="fas fa-clock me-2"></i>
                        Analyzing temporal impact patterns...
                    </div>
                </div>
            </div>
            
            <!-- Source Clustering -->
            <div class="tab-pane fade" id="source-clustering-content" role="tabpanel" aria-labelledby="source-clustering-tab">
                <div class="row">
                    <div class="col-md-9">
                        <div id="source-insights-container">
                            <div class="loading-indicator text-center">
                                <i class="fas fa-layer-group me-2"></i>
                                Analyzing source patterns and authority...
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="source-metrics-card" style="background: var(--light-gray); border-radius: 8px; padding: 16px;">
                            <h6 class="mb-3">Source Metrics</h6>
                            <div id="source-metrics-content">
                                <div class="text-muted text-center">
                                    <i class="fas fa-chart-pie"></i>
                                    <div>Loading metrics...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feed Content Area -->
    <div class="feed-content">
        <!-- Feed Controls -->
        <div class="feed-controls">
            <div class="feed-controls-left">
                <div class="feed-filter">
                    <label for="searchInput">Search:</label>
                    <input type="text" id="searchInput" class="filter-select" placeholder="Search titles and content..." onkeyup="handleSearch(event)" style="min-width: 200px;">
                </div>
                <div class="feed-filter">
                    <label for="sourceFilter">Source:</label>
                    <select id="sourceFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">All Sources</option>
                        <option value="bluesky">üê¶ Bluesky Social</option>
                        <option value="arxiv">üìö ArXiv Academic</option>
                        <option value="thenewsapi">üì∞ News Articles</option>
                    </select>
                </div>
                <div class="feed-filter">
                    <label for="starredFilter">Starred:</label>
                    <select id="starredFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">All Items</option>
                        <option value="starred">Starred Only</option>
                        <option value="unstarred">Unstarred Only</option>
                    </select>
                </div>
                <div class="feed-filter">
                    <label for="sortBy">Sort by:</label>
                    <select id="sortBy" class="filter-select" onchange="applyFilters()">
                        <option value="publication_date">Newest First</option>
                        <option value="created_at">Recently Added</option>
                        <option value="engagement">Most Popular</option>
                    </select>
                </div>
                <div class="feed-filter">
                    <label for="topicFilter">Topic:</label>
                    <select id="topicFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">All Topics</option>
                        <!-- Topics will be populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="feed-controls-right">
                <div class="feed-filter">
                    <label for="itemsPerPage">Show:</label>
                    <select id="itemsPerPage" class="filter-select" onchange="applyFilters()">
                        <option value="20">20 items</option>
                        <option value="50" selected>50 items</option>
                        <option value="100">100 items</option>
                    </select>
                </div>
                <!-- Selected Actions Group -->
                <div class="button-group" style="display: flex; gap: 2px; margin-right: 12px; padding: 2px; background: rgba(108, 117, 125, 0.1); border-radius: 4px;">
                    <button class="btn-square" onclick="toggleSelectAll()" id="selectAllBtn" title="Select/Deselect All">
                        <i class="fas fa-check-square"></i>
                    </button>
                    <button class="btn-square btn-enrichment" onclick="enrichSelectedArticles()" disabled title="Enrich Selected Articles">
                        <i class="fas fa-brain"></i>
                    </button>
                    <button class="btn-square btn-info" onclick="sendSelectedToAuspex()" disabled id="sendSelectedBtn" title="Send Selected to Auspex AI">
                        <i class="fas fa-comment-dots"></i>
                    </button>
                    <button class="btn-square btn-danger" onclick="deleteSelectedItems()" disabled id="deleteSelectedBtn" title="Delete Selected Articles">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn-square btn-secondary" onclick="hideSelectedItems()" disabled id="hideSelectedBtn" title="Hide Selected Articles">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>

                <!-- Starred Actions Group -->
                <div class="button-group" style="display: flex; gap: 2px; margin-right: 12px; padding: 2px; background: rgba(255, 193, 7, 0.1); border-radius: 4px;">
                    <button class="btn-square btn-warning" onclick="bulkStarArticles()" disabled id="bulkStarBtn" title="Star Selected Articles">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="btn-square btn-secondary" onclick="bulkUnstarArticles()" disabled id="bulkUnstarBtn" title="Unstar Selected Articles">
                        <i class="far fa-star"></i>
                    </button>
                    <button class="btn-square btn-warning" onclick="enrichStarredItems()" title="Enrich All Starred Articles">
                        <i class="fas fa-star-half-alt"></i>
                    </button>
                    <button class="btn-square btn-info" onclick="sendStarredToAuspex()" title="Send Starred to Auspex AI">
                        <i class="fas fa-comment-dots"></i>
                    </button>
                    <button class="btn-square btn-info" onclick="exportStarredItems()" title="Export Starred Articles">
                        <i class="fas fa-download"></i>
                    </button>
                </div>

                <!-- System Actions Group -->
                <div class="button-group" style="display: flex; gap: 2px; margin-right: 12px; padding: 2px; background: rgba(33, 37, 41, 0.1); border-radius: 4px;">
                    <button class="btn-square" id="showHideArticleBtn" onclick="toggleHiddenItems()" title="Show/Hide Hidden Articles">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                    <button class="btn-square" onclick="toggleCustomizePanel()" title="Customize Dashboard">
                        <i class="fas fa-sliders-h"></i>
                    </button>
                    <button class="btn-square" onclick="toggleMultiFilter()" title="Multi-Combination Filter">
                        <i class="fas fa-layer-group"></i>
                    </button>
                </div>

                <!-- Hidden Save Button -->
                <button class="btn-tab-control btn-success" id="saveEnrichedBtn" onclick="bulkSaveEnrichedArticles()" style="display: none;">
                    <i class="fas fa-save"></i>
                    Save Enriched Articles
                </button>

                <!-- Status Display -->
                <div class="status-display" style="margin-left: auto; font-size: 0.85rem; color: var(--dark-gray); display: flex; align-items: center; gap: 8px;">
                    <span><i class="fas fa-check-square"></i> <span id="selectedCount">0</span> selected</span>
                    <span><i class="fas fa-star"></i> <span id="starredCount">0</span> starred</span>
                    <span><i class="fas fa-info-circle"></i> <span id="totalStarredCount">0</span> total starred</span>
                </div>
            </div>
        </div>

        <!-- Customization Panel (collapsible) -->
        <div id="customizePanel" style="display: none; border-top: 1px solid var(--medium-gray); padding: 20px 24px; background: var(--light-gray);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div class="feed-filter">
                    <label for="dateFilter">Date Range:</label>
                    <select id="dateFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
                <div class="feed-filter">
                    <label for="authorFilter">Author:</label>
                    <input type="text" id="authorFilter" class="filter-select" placeholder="Filter by author..." onkeyup="debounceFilter(applyFilters, 500)">
                </div>
                <div class="feed-filter">
                    <label for="engagementFilter">Min Engagement:</label>
                    <select id="engagementFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">Any</option>
                        <option value="10">10+ interactions</option>
                        <option value="50">50+ interactions</option>
                        <option value="100">100+ interactions</option>
                    </select>
                </div>
                <div class="feed-filter">
                    <label for="layoutMode">Layout:</label>
                    <select id="layoutMode" class="filter-select" onchange="changeLayout()">
                        <option value="cards">Cards</option>
                        <option value="compact">Compact</option>
                        <option value="timeline">Timeline</option>
                        <option value="topic-grouped">Group by Topic</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 16px; display: flex; gap: 8px;">
                <button class="btn-tab-control btn-primary-control" onclick="saveCustomizations()">
                    <i class="fas fa-save"></i>
                    Save Preferences
                </button>
                <button class="btn-tab-control" onclick="resetCustomizations()">
                    <i class="fas fa-undo"></i>
                    Reset
                </button>
            </div>
        </div>

        <!-- Multi-Combination Filter -->
        <div class="multi-filter-container" id="multiFilterContainer" style="display: none;">
            <div class="filter-header">
                <div class="filter-icon">‚ö°</div>
                <h3 class="filter-title">Multi-Combination Filter</h3>
            </div>
            
            <p class="filter-subtitle">Add multiple source + date combinations to create complex filters</p>
            
            <div class="add-combination-section">
                <div class="combination-form">
                    <div class="filter-group">
                        <label class="filter-label" for="newSource">Source:</label>
                        <select id="newSource" class="filter-select">
                            <option value="">Select Source</option>
                            <option value="bluesky">üê¶ Bluesky Social</option>
                            <option value="arxiv">üìö ArXiv Academic</option>
                            <option value="thenewsapi">üì∞ News Articles</option>
                        </select>
                    </div>
                    
                    <div class="filter-connector">+</div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="newDate">Date Range:</label>
                        <select id="newDate" class="filter-select">
                            <option value="">Select Date Range</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="alltime">All Time</option>
                        </select>
                    </div>
                    
                    <button class="add-combination-btn" onclick="addCombination()" id="addBtn">
                        ‚ûï Add Combination
                    </button>
                </div>
            </div>
            
            <div class="active-combinations">
                <div class="combinations-header">
                    <h4 class="combinations-title">Active Filter Combinations</h4>
                    <button class="clear-all-btn" onclick="clearAllCombinations()" id="clearAllBtn" style="display: none;">
                        üóëÔ∏è Clear All
                    </button>
                </div>
                
                <div class="combination-list" id="combinationList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No filter combinations added yet.<br>Add your first combination above!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feed Items -->
        <div class="feed-items" id="feedItems">
            <!-- Feed items will be populated by JavaScript -->
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>Loading your unified feed...</p>
            </div>
        </div>

        <!-- Infinite Scroll Loading Indicator -->
        <div class="text-center p-4" id="infiniteScrollLoader" style="display: none;">
            <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                            <p class="mt-2" style="color: var(--dark-gray);">Loading more articles...</p>
        </div>

        <!-- Load More Button (fallback) -->
        <div class="text-center p-4" id="loadMoreContainer" style="display: none;">
            <button class="btn-tab-control btn-primary-control" onclick="loadMoreItems()">
                <i class="fas fa-chevron-down"></i>
                Load More Items
            </button>
        </div>
    </div>

    <!-- Column View -->
    <div class="column-view-container" id="columnViewContainer">
        <div class="feed-column" id="blueSkyColumn">
            <div class="feed-column-header">
                <div class="feed-column-title">
                    <i class="fab fa-twitter" style="color: #0085ff;"></i>
                    Bluesky Social
                    <span class="badge bg-primary" id="blueSkyCount">0</span>
                    <span class="badge bg-secondary ms-1" id="blueSkySelectedCount" style="display: none;">0 selected</span>
                </div>
                <div class="column-bulk-actions" id="blueSkyBulkActions" style="display: none;">
                    <button class="btn btn-xs btn-outline-primary" onclick="toggleColumnSelectAll('bluesky')" title="Select All">
                        <i class="fas fa-check-square"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-info" onclick="enrichColumnSelected('bluesky')" title="Enrich Selected">
                        <i class="fas fa-brain"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-warning" onclick="sendColumnSelectedToAuspex('bluesky')" title="Send to Auspex">
                        <i class="fas fa-comment-dots"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-secondary" onclick="hideColumnSelected('bluesky')" title="Hide Selected">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-danger" onclick="deleteColumnSelected('bluesky')" title="Delete Selected">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="dropdown">
                    <button class="btn btn-xs btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="blueSkyRefreshBtn">
                        <i class="fas fa-cog me-1"></i>
                        <span id="blueSkyRefreshStatus">Manual</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="refreshColumn('bluesky')">Refresh</a></li>
                        <li><a class="dropdown-item" href="#" onclick="collectColumn('bluesky')">Collect New</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Auto-refresh</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('bluesky', 0)">Manual</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('bluesky', 5)">5 minutes</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('bluesky', 15)">15 minutes</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('bluesky', 30)">30 minutes</a></li>
                    </ul>
                </div>
            </div>
            <div class="feed-column-content" id="blueSkyContent">
                                    <div class="text-center p-4" style="color: var(--dark-gray);">Loading Bluesky posts...</div>
            </div>
        </div>

        <div class="feed-column" id="arXivColumn">
            <div class="feed-column-header">
                <div class="feed-column-title">
                    <i class="fas fa-university" style="color: #b31b1b;"></i>
                    ArXiv Academic
                    <span class="badge bg-primary" id="arXivCount">0</span>
                    <span class="badge bg-secondary ms-1" id="arXivSelectedCount" style="display: none;">0 selected</span>
                </div>
                <div class="column-bulk-actions" id="arXivBulkActions" style="display: none;">
                    <button class="btn btn-xs btn-outline-primary" onclick="toggleColumnSelectAll('arxiv')" title="Select All">
                        <i class="fas fa-check-square"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-info" onclick="enrichColumnSelected('arxiv')" title="Enrich Selected">
                        <i class="fas fa-brain"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-warning" onclick="sendColumnSelectedToAuspex('arxiv')" title="Send to Auspex">
                        <i class="fas fa-comment-dots"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-secondary" onclick="hideColumnSelected('arxiv')" title="Hide Selected">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-danger" onclick="deleteColumnSelected('arxiv')" title="Delete Selected">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="dropdown">
                    <button class="btn btn-xs btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="arXivRefreshBtn">
                        <i class="fas fa-cog me-1"></i>
                        <span id="arXivRefreshStatus">Manual</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="refreshColumn('arxiv')">Refresh</a></li>
                        <li><a class="dropdown-item" href="#" onclick="collectColumn('arxiv')">Collect New</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Auto-refresh</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('arxiv', 0)">Manual</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('arxiv', 15)">15 minutes</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('arxiv', 30)">30 minutes</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('arxiv', 60)">1 hour</a></li>
                    </ul>
                </div>
            </div>
            <div class="feed-column-content" id="arXivContent">
                                    <div class="text-center p-4" style="color: var(--dark-gray);">Loading ArXiv papers...</div>
            </div>
        </div>

        <div class="feed-column" id="newsColumn">
            <div class="feed-column-header">
                <div class="feed-column-title">
                    <i class="fas fa-newspaper" style="color: #1e7e34;"></i>
                    News Articles
                    <span class="badge bg-primary" id="newsCount">0</span>
                    <span class="badge bg-secondary ms-1" id="newsSelectedCount" style="display: none;">0 selected</span>
                </div>
                <div class="column-bulk-actions" id="newsBulkActions" style="display: none;">
                    <button class="btn btn-xs btn-outline-primary" onclick="toggleColumnSelectAll('thenewsapi')" title="Select All">
                        <i class="fas fa-check-square"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-info" onclick="enrichColumnSelected('thenewsapi')" title="Enrich Selected">
                        <i class="fas fa-brain"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-warning" onclick="sendColumnSelectedToAuspex('thenewsapi')" title="Send to Auspex">
                        <i class="fas fa-comment-dots"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-secondary" onclick="hideColumnSelected('thenewsapi')" title="Hide Selected">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                    <button class="btn btn-xs btn-outline-danger" onclick="deleteColumnSelected('thenewsapi')" title="Delete Selected">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="dropdown">
                    <button class="btn btn-xs btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="newsRefreshBtn">
                        <i class="fas fa-cog me-1"></i>
                        <span id="newsRefreshStatus">Manual</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="refreshColumn('thenewsapi')">Refresh</a></li>
                        <li><a class="dropdown-item" href="#" onclick="collectColumn('thenewsapi')">Collect New</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Auto-refresh</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('thenewsapi', 0)">Manual</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('thenewsapi', 15)">15 minutes</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('thenewsapi', 30)">30 minutes</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setColumnAutoRefresh('thenewsapi', 60)">1 hour</a></li>
                    </ul>
                </div>
            </div>
            <div class="feed-column-content" id="newsContent">
                                    <div class="text-center p-4" style="color: var(--dark-gray);">Loading news articles...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Global state management
let currentFeedGroup = null;
let feedGroups = [];
let feedItems = [];
let allFeedItems = []; // Store all items for client-side filtering
let currentPage = 0;
let hasMoreItems = true;

let isInitializing = true;
let currentViewMode = 'tabs'; // 'tabs' or 'columns'
let autoRefreshInterval = null;
let autoRefreshMinutes = 0;
let columnAutoRefreshIntervals = {}; // Track per-column refresh intervals
let columnScrollbackLimits = { bluesky: 1000, arxiv: 250, thenewsapi: 250 };
let columnItems = { bluesky: [], arxiv: [], thenewsapi: [] };
let columnOffsets = { bluesky: 0, arxiv: 0, thenewsapi: 0 }; // Track pagination offset for each column
let columnHasMore = { bluesky: true, arxiv: true, thenewsapi: true }; // Track if more items available
let columnLoading = { bluesky: false, arxiv: false, thenewsapi: false }; // Track loading state
let columnSelectedItems = { bluesky: [], arxiv: [], thenewsapi: [] }; // Track selected items per column

// Multi-combination filter state
let combinationCounter = 0;
let mediabiasCache = {}; // Cache for media bias data
const COLUMN_BATCH_SIZE = 50; // Items to load per batch for infinite scroll
let currentFilters = {
    source: '',
    sort: 'publication_date',
    limit: 50,
    search: '',
    dateRange: '',
    author: '',
    starred: '',
    topic: '',
    showHidden: false,
    minEngagement: '',
    layout: 'cards',
    combinations: [] // <-- Add combinations to filter state
};
const currentFiltersInitialState = {...currentFilters};

// Cache keys for localStorage
const CACHE_KEYS = {
    LAST_GROUP: 'aunoo_last_group',
    VIEW_MODE: 'aunoo_view_mode', 
    AUTO_REFRESH: 'aunoo_auto_refresh',
    COLUMN_REFRESH: 'aunoo_column_refresh'
};

// Debounce utility
let searchTimeout = null;

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    setupInfiniteScroll();
});

// Setup infinite scroll
function setupInfiniteScroll() {
    const feedItemsContainer = document.getElementById('feedItems');
    let isLoading = false;
    
    // Throttle scroll events for better performance
    let scrollTimeout = null;
    
    function handleScroll() {
        if (scrollTimeout) return;
        
        scrollTimeout = setTimeout(() => {
            const container = feedItemsContainer;
            const scrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            
            // Check if user scrolled to near bottom (within 200px)
            const nearBottom = scrollTop + clientHeight >= scrollHeight - 200;
            
            if (nearBottom && hasMoreItems && !isLoading && !isInitializing) {
                isLoading = true;
                showInfiniteScrollLoader();
                loadMoreItems().finally(() => {
                    hideInfiniteScrollLoader();
                    isLoading = false;
                });
            }
            
            scrollTimeout = null;
        }, 100);
    }
    
    // Add scroll listener to the feed items container
    feedItemsContainer.addEventListener('scroll', handleScroll);
    
    
}

// Infinite scroll loader helpers
function showInfiniteScrollLoader() {
    const loader = document.getElementById('infiniteScrollLoader');
    if (loader) {
        loader.style.display = 'block';
    }
}

function hideInfiniteScrollLoader() {
    const loader = document.getElementById('infiniteScrollLoader');
    if (loader) {
        loader.style.display = 'none';
    }
}

async function initializeDashboard() {
    try {

        // Load view mode and auto-refresh settings
        const cachedViewMode = localStorage.getItem(CACHE_KEYS.VIEW_MODE) || 'tabs';
        const cachedAutoRefresh = parseInt(localStorage.getItem(CACHE_KEYS.AUTO_REFRESH) || '0');
        const cachedColumnRefresh = JSON.parse(localStorage.getItem(CACHE_KEYS.COLUMN_REFRESH) || '{}');
        
        
        await loadFeedGroups();
        console.log('DEBUG: Loaded feed groups:', feedGroups);
        
        if (feedGroups.length > 0) {
            // Use cached last group or default to first
            const lastGroup = localStorage.getItem(CACHE_KEYS.LAST_GROUP);
            currentFeedGroup = lastGroup ? parseInt(lastGroup) : feedGroups[0].id;
            console.log('DEBUG: Selected feed group on init:', currentFeedGroup);
            console.log('DEBUG: Last group from cache:', lastGroup);
            
            await renderFeedTabs();
            await loadFilters();
            await loadFeedItems();
        } else {
            console.log('DEBUG: No feed groups found');
            renderEmptyState();
        }
        
        // Set up view mode
        switchViewMode(cachedViewMode);
        
        // Set up auto-refresh
        if (cachedAutoRefresh > 0) {
            setAutoRefresh(cachedAutoRefresh);
        } else {
            // Ensure status text shows "Manual" when no auto-refresh is set
            const refreshStatusText = document.getElementById('refreshStatusText');
            if (refreshStatusText) {
                refreshStatusText.textContent = 'Manual';
            }
        }
        
        // Set up column auto-refresh
        for (const [sourceType, minutes] of Object.entries(cachedColumnRefresh)) {
            if (minutes > 0) {
                setColumnAutoRefresh(sourceType, minutes);
            }
        }
        
        // Initialize column refresh status displays
        initializeColumnRefreshStatuses();
        
        // Mark initialization as complete
        isInitializing = false;
        console.log('DEBUG: Initialization complete, infinite scroll enabled');
    } catch (error) {
        console.error('Error initializing dashboard:', error);
        showError('Failed to load dashboard. Please refresh the page.');
        // Mark initialization as complete even on error
        isInitializing = false;
    }
}

async function loadFilters() {
    try {
        const response = await fetch(`/api/filters/${currentFeedGroup}`);
        console.log('DEBUG: loadFilters response status:', response.status);
        
        // Fetch filters for the current group and update currentFilters and UI
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('DEBUG: Loaded filters from database:', result);
        
        if (result.success && result.filters) {
            // Map API fields to currentFilters structure
            const filters = result.filters;
            currentFilters.source = filters.source_type || '';
            currentFilters.sort = filters.sort_by || '';
            currentFilters.limit = filters.limit_count || 50;
            currentFilters.search = filters.search_term || '';
            currentFilters.dateRange = filters.date_range || '';
            currentFilters.author = filters.author_filter || '';
            currentFilters.minEngagement = filters.min_engagement || '';
            currentFilters.starred = filters.starred_filter || '';
            currentFilters.showHidden = filters.include_hidden || false;
            currentFilters.layout = filters.layout_mode || 'cards';
            currentFilters.topic = filters.topic_filter || '';
            currentFilters.combinations = filters.source_date_combinations || [];

        } else {
            console.log('DEBUG: No filters found or API returned failure');
        }
        
        // Update UI elements to reflect loaded filters
        document.getElementById('sourceFilter').value = currentFilters.source;
        document.getElementById('sortBy').value = currentFilters.sort;
        document.getElementById('itemsPerPage').value = currentFilters.limit;
        document.getElementById('searchInput').value = currentFilters.search;
        document.getElementById('dateFilter').value = currentFilters.dateRange;
        document.getElementById('authorFilter').value = currentFilters.author;
        document.getElementById('engagementFilter').value = currentFilters.minEngagement;
        document.getElementById('starredFilter').value = currentFilters.starred;
        document.getElementById('topicFilter').value = currentFilters.topic;
        document.getElementById('layoutMode').value = currentFilters.layout;

        // Update show/hide button
        updateShowHideBtn();

        // update combination list
        updateCombinationList();

        if (currentFilters.combinations.length > 0) {
            disableSourceAndDateRangeFilters();
        }
        
        // update layout class
        const feedItemsContainer = document.getElementById('feedItems');
        feedItemsContainer.className = `feed-items layout-${currentFilters.layout}`;

    } catch (error) {
        console.error('Error loading filters:', error);
    }
}

async function saveFilters() {
    try {
        console.log('DEBUG: saveFilters called with currentFeedGroup:', currentFeedGroup);
        
        // Map currentFilters to the API payload structure
        const payload = {
            source_type: currentFilters.source,
            sort_by: currentFilters.sort,
            limit_count: currentFilters.limit,               
            search_term: currentFilters.search,
            date_range: currentFilters.dateRange,
            author_filter: currentFilters.author,
            min_engagement: currentFilters.minEngagement,
            starred_filter: currentFilters.starred,
            include_hidden: currentFilters.showHidden,
            layout_mode: currentFilters.layout,
            topic_filter: currentFilters.topic,
            source_date_combinations: currentFilters.combinations
        };
        console.log('DEBUG: Saving filters payload:', payload);

        const endpoint = `/api/filters/${currentFeedGroup}`
        console.log('DEBUG: API endpoint:', endpoint);
        
        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        }

        const response = await fetch(endpoint, options);
        

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result =  await response.json();
        console.log('DEBUG: API response:', result);

        if (result.success) {
            console.log('Filters saved successfully to database');
        } else {
            console.error('Failed to save filters:', result);
        }

        //save current feed group to cache
        localStorage.setItem(CACHE_KEYS.LAST_GROUP, currentFeedGroup.toString());

    } catch (error) {
        console.error('Error saving filters to database:', error);
    }
}

async function loadFeedGroups() {
    try {
        const response = await fetch('/api/feed-groups');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        feedGroups = await response.json();
        console.log('Loaded feed groups:', feedGroups);
    } catch (error) {
        console.error('Error loading feed groups:', error);
        throw error;
    }
}

async function renderFeedTabs() {
    const tabsContainer = document.getElementById('feedTabs');
    
    if (feedGroups.length === 0) {
        tabsContainer.innerHTML = '<li class="feed-tab">No feed groups available</li>';
        return;
    }
    
    // Add "All Groups" tab
    let tabsHTML = `
        <li class="feed-tab ${currentFeedGroup === null ? 'active' : ''}" 
            onclick="switchFeedGroup(null)"
            data-group-id="all">
            <i class="fas fa-globe"></i>
            <span>All Groups</span>
            <span class="tab-count" id="count-all">0</span>
        </li>
    `;
    
    // Add individual group tabs
    tabsHTML += feedGroups.map(group => `
        <li class="feed-tab ${group.id === currentFeedGroup ? 'active' : ''}" 
            onclick="switchFeedGroup(${group.id})"
            data-group-id="${group.id}">
            <div class="tab-color" style="background-color: ${group.color}"></div>
            <span>${group.name}</span>
            <span class="tab-count" id="count-${group.id}">0</span>
        </li>
    `).join('');
    
    tabsContainer.innerHTML = tabsHTML;
    
    // Load tab counters after rendering tabs
    await loadTabCounters();
}

// Tab Counter Functions
async function loadTabCounters() {
    try {
        // Load "All Groups" counter
        const allResponse = await fetch('/api/unified-feed?limit=1');
        if (allResponse.ok) {
            const allData = await allResponse.json();
            updateTabCounter('all', allData.total_count);
        }
        
        // Load individual group counters
        const promises = feedGroups.map(group => loadGroupTabCounter(group.id));
        await Promise.all(promises);
        
        // Load starred count
        await loadStarredCount();
        
    } catch (error) {
        console.error('Error loading tab counters:', error);
    }
}

// Load total starred count across all groups
async function loadStarredCount() {
    try {
        // Always get the total count across all groups (not just current view)
        // Load a larger sample from all groups to get accurate starred count (max limit is 200)
        const response = await fetch('/api/unified-feed?limit=200');
        if (response.ok) {
            const data = await response.json();
            // Count only items that are actually starred
            const actualStarredCount = data.items ? data.items.filter(item => item.is_starred).length : 0;
            updateStarredCount(actualStarredCount);
        }
    } catch (error) {
        console.error('Error loading starred count:', error);
        updateStarredCount(0);
    }
}

// Update starred count display
function updateStarredCount(count) {
    const countElement = document.getElementById('totalStarredCount');
    if (countElement) {
        countElement.textContent = count.toLocaleString();
        countElement.title = `${count} starred articles across all groups`;
    }
}

async function loadGroupTabCounter(groupId) {
    try {
        const response = await fetch(`/api/feed-groups/${groupId}/stats`);
        if (response.ok) {
            const stats = await response.json();
            updateTabCounter(groupId, stats.total_items);
        } else {
            updateTabCounter(groupId, 0);
        }
    } catch (error) {
        console.error(`Error loading counter for group ${groupId}:`, error);
        updateTabCounter(groupId, 0);
    }
}

function updateTabCounter(groupId, count) {
    const countElement = document.getElementById(`count-${groupId}`);
    if (countElement) {
        countElement.textContent = count.toLocaleString();
        countElement.title = `${count} total articles`;
    }
}

function refreshTabCounters() {
    loadTabCounters();
}

async function switchFeedGroup(groupId) {
    // update currentFilters to inital state
    currentFilters = {...currentFiltersInitialState};
    console.log('DEBUG: Switching to feed group:', groupId);
    currentFeedGroup = groupId;
    currentPage = 0;
    hasMoreItems = true;
    
    // Update tab active states
    document.querySelectorAll('.feed-tab').forEach(tab => {
        const tabGroupId = tab.dataset.groupId;
        const isActive = (groupId === null && tabGroupId === 'all') || 
                        (groupId !== null && parseInt(tabGroupId) === groupId);
        tab.classList.toggle('active', isActive);
    });
    await loadFilters();
    await loadFeedItems();
}

async function loadFeedItems(append = false) {
    try {
        if (!append) {
            document.getElementById('feedItems').innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>Loading feed items...</p>
                </div>
            `;
        }
        
        const params = new URLSearchParams({
            limit: currentFilters.limit,
            offset: currentPage * currentFilters.limit,
            include_hidden: currentFilters.showHidden
        });
        
        // If combination filter is active, use it for backend query
        if (currentFilters.combinations && currentFilters.combinations.length > 0) {
            const combinationSources = currentFilters.combinations.map(combo => combo.source);
            const combinationDates = currentFilters.combinations.map(combo => combo.date);
            params.append('combination_sources', combinationSources.join(','));
            params.append('combination_dates', combinationDates.join(','));
        } else if (currentFilters.source || currentFilters.dateRange) {
            // Add individual source filter
            if (currentFilters.source) {
                params.append('source_types', currentFilters.source);
            }
            // Add individual date range filter
            if (currentFilters.dateRange) {
                params.append('dateRange', currentFilters.dateRange);
            }
        }
        
        // Add all other filters
        if (currentFilters.search) {
            params.append('search', currentFilters.search);
        }
        if (currentFilters.author) {
            params.append('author', currentFilters.author);
        }
        if (currentFilters.minEngagement) {
            params.append('min_engagement', currentFilters.minEngagement);
        }
        if (currentFilters.starred) {
            params.append('starred', currentFilters.starred);
        }
        if (currentFilters.topic) {
            params.append('topic', currentFilters.topic);
        }
        if (currentFilters.sort) {
            params.append('sort', currentFilters.sort);
        }
        
        let endpoint = '/api/unified-feed';
        if (currentFeedGroup !== null) {
            endpoint = `/api/feed-groups/${currentFeedGroup}/feed`;
        }
        
        console.log('DEBUG: Loading feed items from endpoint:', endpoint);
        console.log('DEBUG: Current feed group:', currentFeedGroup);
        console.log('DEBUG: CurrentPage:', currentPage, 'Limit:', currentFilters.limit, 'Offset:', currentPage * currentFilters.limit);
        console.log('DEBUG: Params:', params.toString());
        console.log('DEBUG: Current filters:', currentFilters);
        
        const response = await fetch(`${endpoint}?${params}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        console.log('DEBUG: Received data:', data);
        console.log('DEBUG: Items count:', data.items ? data.items.length : 0);
        
        if (append) {
            feedItems = [...feedItems, ...data.items];
            allFeedItems = [...allFeedItems, ...data.items];
        } else {
            feedItems = data.items;
            allFeedItems = data.items; // Store all items for client-side filtering
        }
        
        // Enrich news items with media bias
        const newsItems = feedItems.filter(item => item.source_type === 'thenewsapi');
        if (newsItems.length > 0) {
            await enrichNewsWithMediaBias(newsItems);
        }
        
        console.log('DEBUG: Final feedItems count:', feedItems.length);
        console.log('DEBUG: Final allFeedItems count:', allFeedItems.length);
        
        hasMoreItems = data.has_more;
        renderFeedItems();
        updateLoadMoreButton();
        
    } catch (error) {
        console.error('Error loading feed items:', error);
        showError('Failed to load feed items. Please try again.');
    }
}

function renderFeedItems() {
    const container = document.getElementById('feedItems');
    
    // Ensure layout class is applied to container
    const layout = currentFilters.layout || 'cards';
    container.className = `feed-items layout-${layout}`;
    
    console.log('DEBUG: Rendering feed items, count:', feedItems.length);
    console.log('DEBUG: Sample of feedItems:', feedItems.slice(0, 2));
    
    if (feedItems.length === 0) {
        console.log('DEBUG: No feed items to render, showing empty state');
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--dark-gray);">
                <i class="fas fa-rss" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: 16px;"></i>
                <h3 style="color: var(--dark-gray); margin-bottom: 8px;">No feed items yet</h3>
                <p>Try collecting new items or check your feed group sources.</p>
                <button class="btn-tab-control btn-primary-control" onclick="collectFeedItems()">
                    <i class="fas fa-download"></i>
                    Collect Items
                </button>
                <button class="btn-tab-control" onclick="debugCompactView()">
                    <i class="fas fa-bug"></i>
                    Debug Compact
                </button>
            </div>
        `;
        return;
    }
    
    console.log('DEBUG: Rendering', feedItems.length, 'items');
    
    // Check layout mode and render accordingly
    const layoutMode = currentFilters.layout || 'cards';
    if (layoutMode === 'compact') {
        const tableHeader = `
            <table class="compact-table" style="width: 100%; border-collapse: collapse; background: white;">
                <thead>
                    <tr style="background: var(--colors-neutral-2); border-bottom: 2px solid var(--colors-neutral-5);">
                        <th style="width: 30px; padding: 8px; text-align: center; font-size: 0.75rem; color: var(--colors-neutral-8); font-weight: 600;">‚òë</th>
                        <th style="width: 30px; padding: 8px; text-align: center; font-size: 0.75rem; color: var(--colors-neutral-8); font-weight: 600;">SRC</th>
                        <th style="width: 80px; padding: 8px; text-align: left; font-size: 0.75rem; color: var(--colors-neutral-8); font-weight: 600;">DATE</th>
                        <th style="padding: 8px; text-align: left; font-size: 0.75rem; color: var(--colors-neutral-8); font-weight: 600;">TITLE</th>
                        <th style="width: 50px; padding: 8px; text-align: center; font-size: 0.75rem; color: var(--colors-neutral-8); font-weight: 600;">ENG</th>
                        <th style="width: 80px; padding: 8px; text-align: center; font-size: 0.75rem; color: var(--colors-neutral-8); font-weight: 600;">ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
        `;
        const tableFooter = `
                </tbody>
            </table>
        `;
        container.innerHTML = tableHeader + feedItems.map(item => renderFeedItem(item)).join('') + tableFooter;
    } else if (layoutMode === 'topic-grouped') {
        renderTopicGroupedView(container);
    } else {
        container.innerHTML = feedItems.map(item => renderFeedItem(item)).join('');
    }
}

function renderTopicGroupedView(container) {
    // Group articles by topic
    const topicGroups = {};
    
    feedItems.forEach(item => {
        const topic = item.topic || item.category || 'Uncategorized';
        if (!topicGroups[topic]) {
            topicGroups[topic] = [];
        }
        topicGroups[topic].push(item);
    });
    
    // Sort topics by article count (descending)
    const sortedTopics = Object.keys(topicGroups).sort((a, b) => 
        topicGroups[b].length - topicGroups[a].length
    );
    
    // Render grouped view
    let html = '<div class="topic-grouped-container">';
    
    sortedTopics.forEach(topic => {
        const articles = topicGroups[topic];
        const topicColor = getTopicColor(topic);
        
        html += `
            <div class="topic-group" style="margin-bottom: 32px; background: white; border-radius: 8px; box-shadow: var(--card-shadow); overflow: hidden;">
                <div class="topic-header" style="background: linear-gradient(135deg, ${topicColor}, ${adjustBrightness(topicColor, -20)}); color: white; padding: 16px 20px; display: flex; justify-content: between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h4 style="margin: 0; font-weight: 600;">
                            <i class="fas fa-layer-group me-2"></i>
                            ${topic}
                        </h4>
                        <span class="badge bg-light text-dark" style="font-size: 0.8rem; padding: 4px 8px;">${articles.length} articles</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-light" onclick="toggleTopicGroup('${topic}')" title="Collapse/Expand">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <button class="btn btn-sm btn-light" onclick="selectAllInTopic('${topic}')" title="Select All in Topic">
                            <i class="fas fa-check-square"></i>
                        </button>
                    </div>
                </div>
                <div class="topic-content" id="topic-${topic.replace(/[^a-zA-Z0-9]/g, '')}" style="padding: 0;">
                    ${articles.map(item => `
                        <div style="border-bottom: 1px solid #f0f0f0; padding: 16px 20px;">
                            ${renderTopicGroupItemCompact(item)}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Update topic filter dropdown
    updateTopicFilterOptions(sortedTopics);
}

function renderTopicGroupItemCompact(item) {
    const publishDate = item.publication_date ? 
        new Date(item.publication_date).toLocaleDateString() : 
        'No date';
    
    // Enhanced source badges
    let sourceBadge, sourceIcon;
    if (item.source_type === 'arxiv') {
        sourceBadge = '<span class="badge bg-danger" style="font-size: 0.7rem;"><i class="fas fa-university me-1"></i>ArXiv</span>';
        sourceIcon = '<i class="fas fa-university text-danger"></i>';
    } else if (item.source_type === 'bluesky') {
        sourceBadge = '<span class="badge bg-primary" style="font-size: 0.7rem;"><i class="fab fa-twitter me-1"></i>Bluesky</span>';
        sourceIcon = '<i class="fab fa-twitter text-primary"></i>';
    } else if (item.source_type === 'thenewsapi') {
        sourceBadge = '<span class="badge bg-success" style="font-size: 0.7rem;"><i class="fas fa-newspaper me-1"></i>News</span>';
        sourceIcon = '<i class="fas fa-newspaper text-success"></i>';
    } else {
        sourceBadge = '<span class="badge bg-secondary" style="font-size: 0.7rem;"><i class="fas fa-globe me-1"></i>Unknown</span>';
        sourceIcon = '<i class="fas fa-globe text-secondary"></i>';
    }
    
    const engagement = item.engagement_metrics || {};
    
    return `
        <div style="display: flex; align-items: flex-start; gap: 12px;">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 40px;">
                <input type="checkbox" class="item-checkbox" data-item-id="${item.id}" onchange="updateSelectedCount()" style="margin: 0;">
                ${sourceIcon}
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    ${sourceBadge}
                    <span style="color: ${item.group_color}; font-weight: 500; font-size: 0.8rem;">${item.group_name}</span>
                    <span style="color: var(--dark-gray); font-size: 0.8rem;">${publishDate}</span>
                    ${item.is_starred ? '<i class="fas fa-star text-warning" title="Starred"></i>' : ''}
                </div>
                <h6 style="margin: 0 0 8px 0; line-height: 1.3;">
                    <a href="${item.url}" target="_blank" style="text-decoration: none; color: var(--text-color); font-weight: 500;">
                        ${item.title}
                    </a>
                </h6>
                ${item.author ? `<div style="font-size: 0.8rem; color: var(--dark-gray); margin-bottom: 4px;"><i class="fas fa-user me-1"></i>${item.author}${item.author_handle ? ` (${item.author_handle})` : ''}</div>` : ''}
                ${item.content ? `<div style="font-size: 0.85rem; color: var(--text-color); line-height: 1.4; margin-bottom: 8px;">${truncateText(item.content, 150)}</div>` : ''}
                
                <!-- Engagement and Tags -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        ${engagement.likes ? `<span style="font-size: 0.75rem; color: var(--dark-gray);"><i class="fas fa-heart text-danger me-1"></i>${engagement.likes}</span>` : ''}
                        ${engagement.reposts ? `<span style="font-size: 0.75rem; color: var(--dark-gray);"><i class="fas fa-retweet text-success me-1"></i>${engagement.reposts}</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button style="padding: 4px 8px; border: none; border-radius: 4px; background: ${item.is_starred ? 'var(--primary-color)' : 'var(--light-gray)'}; color: ${item.is_starred ? 'white' : 'var(--dark-gray)'}; cursor: pointer; font-size: 0.75rem;" 
                                onclick="toggleStar(${item.id}, ${!item.is_starred})" title="${item.is_starred ? 'Unstar' : 'Star'} item">
                            <i class="fas fa-star"></i>
                        </button>
                        <button style="padding: 4px 8px; border: none; border-radius: 4px; background: #9966CC; color: white; cursor: pointer; font-size: 0.75rem;" 
                                onclick="enrichSingleArticle(${item.id})" title="Enrich article">
                            <i class="fas fa-brain"></i>
                        </button>
                        <button style="padding: 4px 8px; border: none; border-radius: 4px; background: var(--light-gray); color: var(--dark-gray); cursor: pointer; font-size: 0.75rem;" 
                                onclick="hideItem(${item.id})" title="Hide item">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getTopicColor(topic) {
    // Generate consistent colors for topics
    const colors = [
        '#FF6B35', '#F7931E', '#FFD23F', '#06FFA5', 
        '#118AB2', '#073B4C', '#8E44AD', '#E74C3C',
        '#2ECC71', '#F39C12', '#9B59B6', '#34495E'
    ];
    
    let hash = 0;
    for (let i = 0; i < topic.length; i++) {
        hash = topic.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}

function adjustBrightness(hex, percent) {
    // Remove the hash if it exists
    hex = hex.replace(/^#/, '');
    
    // Parse r, g, b values
    const num = parseInt(hex, 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    
    return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                  (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                  (B < 255 ? B < 1 ? 0 : B : 255))
                  .toString(16).slice(1);
}

function toggleTopicGroup(topic) {
    const content = document.getElementById(`topic-${topic.replace(/[^a-zA-Z0-9]/g, '')}`);
    const isVisible = content.style.display !== 'none';
    content.style.display = isVisible ? 'none' : 'block';
    
    // Update chevron icon
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    icon.className = isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
}

function selectAllInTopic(topic) {
    const topicContainer = document.getElementById(`topic-${topic.replace(/[^a-zA-Z0-9]/g, '')}`);
    const checkboxes = topicContainer.querySelectorAll('.item-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
    });
    
    updateSelectedCount();
}

function updateTopicFilterOptions(topics) {
    const topicFilter = document.getElementById('topicFilter');
    if (!topicFilter) return;
    
    // Clear existing options except "All Topics"
    topicFilter.innerHTML = '<option value="">All Topics</option>';
    
    // Add topic options
    topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic;
        option.textContent = topic;
        topicFilter.appendChild(option);
    });
}

function renderFeedItem(item) {
    const publishDate = item.publication_date ? 
        new Date(item.publication_date).toLocaleDateString() : 
        'No date';
    
    // Enhanced source badges with proper icons and styling
    let sourceBadge;
    let sourceIcon;
    if (item.source_type === 'arxiv') {
        sourceBadge = '<div class="source-badge arxiv"><i class="fas fa-university"></i> ArXiv</div>';
        sourceIcon = '<i class="fas fa-university"></i>';
    } else if (item.source_type === 'bluesky') {
        sourceBadge = '<div class="source-badge bluesky"><i class="fab fa-twitter"></i> Bluesky</div>';
        sourceIcon = '<i class="fab fa-twitter"></i>';
    } else if (item.source_type === 'thenewsapi') {
        sourceBadge = '<div class="source-badge thenewsapi"><i class="fas fa-newspaper"></i> News</div>';
        sourceIcon = '<i class="fas fa-newspaper"></i>';
    } else {
        sourceBadge = '<div class="source-badge"><i class="fas fa-globe"></i> Unknown</div>';
        sourceIcon = '<i class="fas fa-globe"></i>';
    }
    
    const engagement = item.engagement_metrics || {};
    const tags = item.tags || [];
    
    // Add source-specific CSS classes
    let sourceClass;
    if (item.source_type === 'arxiv') {
        sourceClass = 'arxiv-item';
    } else if (item.source_type === 'bluesky') {
        sourceClass = 'bluesky-item';
    } else if (item.source_type === 'thenewsapi') {
        sourceClass = 'thenewsapi-item';
    } else {
        sourceClass = 'unknown-item';
    }
    
    // Get current layout mode
    const layoutMode = currentFilters.layout || 'cards';
    
    // Debug: Log layout mode for first item only
    if (item.id === feedItems[0]?.id) {
        console.log('Rendering items with layout mode:', layoutMode, 'for item:', item.title.substring(0, 50));
    }
    
    // Render different layouts
    if (layoutMode === 'compact') {
        console.log('DEBUG: Rendering compact item for:', item.title.substring(0, 30));
        return renderCompactItem(item, sourceClass, sourceBadge, sourceIcon, publishDate, engagement, tags);
    } else if (layoutMode === 'timeline') {
        console.log('DEBUG: Rendering timeline item for:', item.title.substring(0, 30));
        return renderTimelineItem(item, sourceClass, sourceBadge, sourceIcon, publishDate, engagement, tags);
    } else {
        console.log('DEBUG: Rendering card item for:', item.title.substring(0, 30));
        return renderCardItem(item, sourceClass, sourceBadge, publishDate, engagement, tags);
    }
}

function renderCardItem(item, sourceClass, sourceBadge, publishDate, engagement, tags) {
    return `
        <div class="feed-item ${sourceClass}${item.is_starred ? ' starred' : ''}" data-item-id="${item.id}" style="animation: fadeIn 0.3s ease-in;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 12px; font-size: 0.9rem; color: var(--dark-gray);">
                    <input type="checkbox" class="item-checkbox" data-item-id="${item.id}" onchange="updateSelectedCount()" style="margin-right: 6px;">
                    ${sourceBadge}
                    <span>‚Ä¢</span>
                    <span style="color: ${item.group_color}; font-weight: 500;">${item.group_name}</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="enrich-btn-${item.id}" style="padding: 6px 10px; border: none; border-radius: 6px; background: #9966CC; color: white; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;" 
                            onclick="enrichSingleArticle(${item.id})"
                            title="Enrich this article">
                        <i class="fas fa-brain"></i>
                    </button>
                    <button id="results-btn-${item.id}" style="padding: 6px 10px; border: none; border-radius: 6px; background: var(--colors-success-9); color: white; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; display: none;" 
                            onclick="viewEnrichmentResults(${item.id})"
                            title="View enrichment results">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button style="padding: 6px 10px; border: none; border-radius: 6px; background: ${item.is_starred ? 'var(--primary-color)' : 'var(--light-gray)'}; color: ${item.is_starred ? 'white' : 'var(--dark-gray)'}; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;" 
                            onclick="toggleStar(${item.id}, ${!item.is_starred})"
                            title="${item.is_starred ? 'Unstar' : 'Star'} item">
                        <i class="fas fa-star"></i>
                    </button>
                    <button style="padding: 6px 10px; border: none; border-radius: 6px; background: var(--light-gray); color: var(--dark-gray); cursor: pointer; font-size: 0.85rem; transition: all 0.2s;" 
                            onclick="showTagInput(${item.id})"
                            title="Tag item">
                        <i class="fas fa-tag"></i>
                    </button>
                    <button style="padding: 6px 10px; border: none; border-radius: 6px; background: var(--light-gray); color: var(--dark-gray); cursor: pointer; font-size: 0.85rem; transition: all 0.2s;" 
                            onclick="hideItem(${item.id})"
                            title="Hide item">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
            </div>
            
            <h3 class="feed-item-title">
                <a href="${item.url}" target="_blank">${item.title}</a>
            </h3>
            
            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 12px; font-size: 0.9rem; color: var(--dark-gray);">
                ${item.author ? `<div><i class="fas fa-user"></i> ${item.author}</div>` : ''}
                <div><i class="fas fa-calendar"></i> ${publishDate}</div>
                ${item.author_handle ? `<div><i class="fab fa-at"></i> ${item.author_handle}</div>` : ''}
            </div>
            
            ${item.content ? `<div class="feed-item-content" style="color: var(--text-color); line-height: 1.6; margin-bottom: 16px;">${item.source_type === 'bluesky' ? item.content : truncateText(item.content, 300)}</div>` : ''}
            
            <!-- Media Bias Information (News only) -->
            ${item.source_type === 'thenewsapi' && item.media_bias ? createMediaBiasDisplay(item.media_bias) : ''}
            
            <!-- Analysis Metadata Badges -->
            ${(item.category || item.sentiment || item.future_signal || item.time_to_impact || item.driver_type) ? `
            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--light-gray);">
                ${item.category ? `<span class="badge bg-info" style="font-size: 0.75rem; font-weight: 500;"><i class="fas fa-tag me-1"></i>${item.category}</span>` : ''}
                ${item.sentiment ? `<span class="badge bg-secondary" style="font-size: 0.75rem; font-weight: 500;"><i class="fas fa-smile me-1"></i>${item.sentiment}</span>` : ''}
                ${item.future_signal ? `<span class="badge bg-warning text-dark" style="font-size: 0.75rem; font-weight: 500;"><i class="fas fa-chart-line me-1"></i>${item.future_signal}</span>` : ''}
                ${item.time_to_impact ? `<span class="badge bg-success" style="font-size: 0.75rem; font-weight: 500;"><i class="fas fa-clock me-1"></i>${item.time_to_impact}</span>` : ''}
                ${item.driver_type ? `<span class="badge bg-dark" style="font-size: 0.75rem; font-weight: 500;"><i class="fas fa-cogs me-1"></i>${item.driver_type}</span>` : ''}
            </div>` : ''}
            
            <!-- Tags Section -->
            ${(item.tags && item.tags.length > 0) ? `
            <div class="article-tags" style="margin-bottom: 12px;">
                ${item.tags.slice(0, 5).map(tag => `<span class="article-tag">${tag}</span>`).join('')}
                ${item.tags.length > 5 ? `<span class="article-tag">+${item.tags.length - 5} more</span>` : ''}
            </div>` : ''}
            
            <div class="tag-input" id="tagInput${item.id}" style="margin-bottom: 12px;">
                <input type="text" placeholder="Add tags (comma separated)" onkeypress="handleTagInput(event, ${item.id})" style="width: 100%; padding: 6px 8px; border: 1px solid var(--medium-gray); border-radius: 4px; font-size: 0.85rem;">
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--light-gray); flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    ${engagement.likes ? `<div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--light-gray); border-radius: 4px; font-size: 0.85rem;"><i class="fas fa-heart" style="color: var(--primary-color);"></i> ${engagement.likes}</div>` : ''}
                    ${engagement.reposts ? `<div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--light-gray); border-radius: 4px; font-size: 0.85rem;"><i class="fas fa-retweet" style="color: var(--primary-color);"></i> ${engagement.reposts}</div>` : ''}
                    ${engagement.replies ? `<div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--light-gray); border-radius: 4px; font-size: 0.85rem;"><i class="fas fa-reply" style="color: var(--primary-color);"></i> ${engagement.replies}</div>` : ''}
                </div>
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    ${tags.slice(0, 3).map(tag => `<span style="background: var(--light-gray); color: var(--dark-gray); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--medium-gray);">${tag}</span>`).join('')}
                    ${tags.length > 3 ? `<span style="background: var(--light-gray); color: var(--dark-gray); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--medium-gray);">+${tags.length - 3} more</span>` : ''}
                </div>
            </div>
            
            <!-- Hover Details -->
            <div class="article-hover-details">
                <h6>üìñ Full Article Details</h6>
                <div class="meta-item"><strong>Source:</strong> ${item.source_type.toUpperCase()}</div>
                ${item.author ? `<div class="meta-item"><strong>Author:</strong> ${item.author}${item.author_handle ? ` (${item.author_handle})` : ''}</div>` : ''}
                <div class="meta-item"><strong>Published:</strong> ${publishDate}</div>
                ${item.url ? `<div class="meta-item"><strong>URL:</strong> <a href="${item.url}" target="_blank" style="color: var(--primary-color); word-break: break-all;">${item.url}</a></div>` : ''}
                
                ${item.content ? `
                <div style="margin: 12px 0;">
                    <strong style="color: var(--primary-color);">Full Content:</strong>
                    <div class="content-preview">${item.content}</div>
                </div>` : ''}
                
                ${(item.category || item.sentiment || item.future_signal || item.time_to_impact || item.driver_type) ? `
                <div style="margin-top: 12px;">
                    <strong style="color: var(--primary-color);">AI Analysis:</strong>
                    <div style="margin-top: 6px;">
                        ${item.category ? `<div class="meta-item">Category: ${item.category}</div>` : ''}
                        ${item.sentiment ? `<div class="meta-item">Sentiment: ${item.sentiment}</div>` : ''}
                        ${item.future_signal ? `<div class="meta-item">Future Signal: ${item.future_signal}</div>` : ''}
                        ${item.time_to_impact ? `<div class="meta-item">Time to Impact: ${item.time_to_impact}</div>` : ''}
                        ${item.driver_type ? `<div class="meta-item">Driver Type: ${item.driver_type}</div>` : ''}
                    </div>
                </div>` : ''}
                
                ${engagement.likes || engagement.reposts || engagement.replies ? `
                <div style="margin-top: 12px;">
                    <strong style="color: var(--primary-color);">Engagement:</strong>
                    <div style="margin-top: 6px;">
                        ${engagement.likes ? `<div class="meta-item">‚ù§Ô∏è Likes: ${engagement.likes}</div>` : ''}
                        ${engagement.reposts ? `<div class="meta-item">üîÑ Reposts: ${engagement.reposts}</div>` : ''}
                        ${engagement.replies ? `<div class="meta-item">üí¨ Replies: ${engagement.replies}</div>` : ''}
                    </div>
                </div>` : ''}
            </div>
        </div>
    `;
}

function renderCompactItem(item, sourceClass, sourceBadge, sourceIcon, publishDate, engagement, tags) {
    const totalEngagement = (engagement.likes || 0) + (engagement.reposts || 0) + (engagement.replies || 0);
    
    // Get source color for the row border
    let borderColor = 'var(--colors-neutral-7)';
    if (sourceClass.includes('bluesky')) borderColor = '#0085ff';
    else if (sourceClass.includes('arxiv')) borderColor = '#b31b1b';
    else if (sourceClass.includes('thenewsapi')) borderColor = '#1e7e34';
    
    return `
        <tr class="compact-row ${sourceClass}${item.is_starred ? ' starred' : ''}" data-item-id="${item.id}" style="border-left: 3px solid ${borderColor};">
            <td style="width: 30px; text-align: center;">
                <input type="checkbox" class="item-checkbox" data-item-id="${item.id}" onchange="updateSelectedCount()">
            </td>
            <td style="width: 30px; text-align: center; font-size: 0.9rem;">
                ${sourceIcon}
            </td>
            <td style="width: 80px; font-size: 0.75rem; color: var(--colors-neutral-8); white-space: nowrap;">
                ${publishDate}
            </td>
            <td style="font-size: 0.9rem;">
                <a href="${item.url}" target="_blank" style="color: var(--colors-neutral-11); text-decoration: none;">${item.title}</a>
                ${item.content ? `<div style="font-size: 0.7rem; color: var(--colors-neutral-8); margin-top: 2px;">${item.source_type === 'bluesky' ? item.content : truncateText(item.content, 100)}</div>` : ''}
            </td>
            <td style="width: 50px; text-align: center; font-size: 0.75rem;">
                ${totalEngagement > 0 ? totalEngagement : ''}
            </td>
            <td style="width: 80px; text-align: center;">
                <button onclick="toggleStar(${item.id}, ${!item.is_starred})" style="padding: 2px 6px; margin-right: 4px; border: none; border-radius: 3px; background: ${item.is_starred ? '#007bff' : 'var(--colors-neutral-2)'}; color: ${item.is_starred ? 'white' : 'var(--colors-neutral-11)'}; cursor: pointer; font-size: 0.75rem;">‚òÖ</button>
                <button onclick="hideItem(${item.id})" style="padding: 2px 6px; border: none; border-radius: 3px; background: var(--colors-neutral-2); color: var(--colors-neutral-11); cursor: pointer; font-size: 0.75rem;">√ó</button>
            </td>
        </tr>
    `;
}

function renderTimelineItem(item, sourceClass, sourceBadge, sourceIcon, publishDate, engagement, tags) {
    const publishedDate = item.publication_date ? new Date(item.publication_date) : new Date();
    const timeAgo = getTimeAgo(publishedDate);
    
    return `
        <div class="feed-item ${sourceClass}${item.is_starred ? ' starred' : ''}" data-item-id="${item.id}" style="animation: fadeIn 0.3s ease-in;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: var(--dark-gray);">
                    <input type="checkbox" class="item-checkbox" data-item-id="${item.id}" onchange="updateSelectedCount()" style="margin-right: 4px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        ${sourceIcon}
                        <span style="font-weight: 500;">${item.source_type.toUpperCase()}</span>
                    </div>
                    <span>‚Ä¢</span>
                    <span style="color: ${item.group_color}; font-weight: 500; font-size: 0.8rem;">${item.group_name}</span>
                    <span>‚Ä¢</span>
                    <span style="font-size: 0.8rem; color: var(--dark-gray);">${timeAgo}</span>
                </div>
                
                <div style="display: flex; gap: 6px;">
                    <button onclick="toggleStar(${item.id}, ${!item.is_starred})" 
                            style="padding: 4px 8px; border: none; border-radius: 4px; background: ${item.is_starred ? 'var(--primary-color)' : 'var(--light-gray)'}; color: ${item.is_starred ? 'white' : 'var(--dark-gray)'}; cursor: pointer; font-size: 0.8rem;"
                            title="${item.is_starred ? 'Unstar' : 'Star'} item">
                        <i class="fas fa-star"></i>
                    </button>
                    <button onclick="hideItem(${item.id})" 
                            style="padding: 4px 8px; border: none; border-radius: 4px; background: var(--light-gray); color: var(--dark-gray); cursor: pointer; font-size: 0.8rem;"
                            title="Hide item">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
            </div>
            
            <h3 class="feed-item-title" style="margin-bottom: 8px; font-size: 1.1rem; line-height: 1.4;">
                <a href="${item.url}" target="_blank">${item.title}</a>
            </h3>
            
            ${item.content ? `<div class="feed-item-content" style="color: var(--text-color); line-height: 1.5; margin-bottom: 12px; font-size: 0.9rem;">${item.source_type === 'bluesky' ? item.content : truncateText(item.content, 200)}</div>` : ''}
            
            ${item.author ? `<div style="font-size: 0.85rem; color: var(--dark-gray); margin-bottom: 8px;"><i class="fas fa-user"></i> ${item.author}${item.author_handle ? ` (${item.author_handle})` : ''}</div>` : ''}
            
            <!-- Quick metadata and engagement -->
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--dark-gray);">
                <div style="display: flex; gap: 12px;">
                    ${engagement.likes ? `<span><i class="fas fa-heart" style="color: var(--primary-color);"></i> ${engagement.likes}</span>` : ''}
                    ${engagement.reposts ? `<span><i class="fas fa-retweet" style="color: var(--primary-color);"></i> ${engagement.reposts}</span>` : ''}
                    ${engagement.replies ? `<span><i class="fas fa-reply" style="color: var(--primary-color);"></i> ${engagement.replies}</span>` : ''}
                </div>
                
                <div style="display: flex; gap: 4px;">
                    ${tags.slice(0, 2).map(tag => `<span style="background: var(--light-gray); color: var(--dark-gray); padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">${tag}</span>`).join('')}
                    ${tags.length > 2 ? `<span style="background: var(--light-gray); color: var(--dark-gray); padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">+${tags.length - 2}</span>` : ''}
                </div>
            </div>
            
            <!-- Hover Details -->
            <div class="article-hover-details">
                <h6>üìñ Full Article Details</h6>
                <div class="meta-item"><strong>Source:</strong> ${item.source_type.toUpperCase()}</div>
                ${item.author ? `<div class="meta-item"><strong>Author:</strong> ${item.author}${item.author_handle ? ` (${item.author_handle})` : ''}</div>` : ''}
                <div class="meta-item"><strong>Published:</strong> ${publishDate}</div>
                ${item.url ? `<div class="meta-item"><strong>URL:</strong> <a href="${item.url}" target="_blank" style="color: var(--primary-color); word-break: break-all;">${item.url}</a></div>` : ''}
                
                ${item.content ? `
                <div style="margin: 12px 0;">
                    <strong style="color: var(--primary-color);">Full Content:</strong>
                    <div class="content-preview">${item.content}</div>
                </div>` : ''}
                
                ${(item.category || item.sentiment || item.future_signal || item.time_to_impact || item.driver_type) ? `
                <div style="margin-top: 12px;">
                    <strong style="color: var(--primary-color);">AI Analysis:</strong>
                    <div style="margin-top: 6px;">
                        ${item.category ? `<div class="meta-item">Category: ${item.category}</div>` : ''}
                        ${item.sentiment ? `<div class="meta-item">Sentiment: ${item.sentiment}</div>` : ''}
                        ${item.future_signal ? `<div class="meta-item">Future Signal: ${item.future_signal}</div>` : ''}
                        ${item.time_to_impact ? `<div class="meta-item">Time to Impact: ${item.time_to_impact}</div>` : ''}
                        ${item.driver_type ? `<div class="meta-item">Driver Type: ${item.driver_type}</div>` : ''}
                    </div>
                </div>` : ''}
                
                ${engagement.likes || engagement.reposts || engagement.replies ? `
                <div style="margin-top: 12px;">
                    <strong style="color: var(--primary-color);">Engagement:</strong>
                    <div style="margin-top: 6px;">
                        ${engagement.likes ? `<div class="meta-item">‚ù§Ô∏è Likes: ${engagement.likes}</div>` : ''}
                        ${engagement.reposts ? `<div class="meta-item">üîÑ Reposts: ${engagement.reposts}</div>` : ''}
                        ${engagement.replies ? `<div class="meta-item">üí¨ Replies: ${engagement.replies}</div>` : ''}
                    </div>
                </div>` : ''}
            </div>
        </div>
    `;
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) {
        return diffMins <= 0 ? 'Just now' : `${diffMins}m ago`;
    } else if (diffHours < 24) {
        return `${diffHours}h ago`;
    } else if (diffDays < 7) {
        return `${diffDays}d ago`;
    } else {
        return date.toLocaleDateString();
    }
}

function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

async function toggleStar(itemId, starred) {
    try {
        const response = await fetch(`/api/feed-items/${itemId}/star`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(starred)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // Update local state
        const item = feedItems.find(item => item.id === itemId);
        if (item) {
            item.is_starred = starred;
            renderFeedItems();
        }
        
        // Refresh starred count
        await loadStarredCount();
        
        showSuccess(starred ? 'Item starred!' : 'Item unstarred!');
        
    } catch (error) {
        console.error('Error toggling star:', error);
        showError('Failed to update item. Please try again.');
    }
}

async function hideItem(itemId) {
    try {
        const response = await fetch(`/api/feed-items/${itemId}/hide`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // Remove from current view if not showing hidden items
        if (!currentFilters.showHidden) {
            feedItems = feedItems.filter(item => item.id !== itemId);
            renderFeedItems();
        }
        
        showSuccess('Item hidden!');
        
    } catch (error) {
        console.error('Error hiding item:', error);
        showError('Failed to hide item. Please try again.');
    }
}

async function collectFeedItems() {
    try {
        showSuccess('Collecting new feed items...');
        
        let endpoint = '/api/feed-collection/collect-all';
        if (currentFeedGroup !== null) {
            endpoint = `/api/feed-groups/${currentFeedGroup}/collect?max_items=20`;
        }
        
        const response = await fetch(endpoint, { method: 'POST' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        showSuccess(`Collected ${result.total_items_collected || result.items_collected || 0} new items`);
        
        // Refresh the current feed
        await loadFeedItems();
        
        // Refresh tab counters
        await refreshTabCounters();
        
    } catch (error) {
        console.error('Error collecting feed items:', error);
        showError('Failed to collect new items. Please try again.');
    }
}

function debugCompactView() {
    console.log('DEBUG: === COMPACT VIEW DEBUG ===');
    console.log('DEBUG: currentFilters.layout:', currentFilters.layout);
    console.log('DEBUG: feedItems.length:', feedItems.length);
    
    const layoutSelector = document.getElementById('layoutMode');
    console.log('DEBUG: Layout selector value:', layoutSelector?.value);
    
    const feedContainer = document.getElementById('feedItems');
    console.log('DEBUG: Feed container classes:', feedContainer?.className);
    console.log('DEBUG: Feed container children count:', feedContainer?.children?.length);
    
    if (feedItems.length > 0) {
        console.log('DEBUG: Sample feed item:', feedItems[0]);
        
        // Force set to compact mode
        layoutSelector.value = 'compact';
        currentFilters.layout = 'compact';
        feedContainer.className = 'feed-items layout-compact';
        
        console.log('DEBUG: Forced compact mode, re-rendering...');
        renderFeedItems();
        
        // Add test text to check visibility
        setTimeout(() => {
            const compactRows = document.querySelectorAll('.compact-row');
            console.log('DEBUG: Found', compactRows.length, 'compact rows');
            
            if (compactRows.length > 0) {
                const firstRow = compactRows[0];
                console.log('DEBUG: First row HTML:', firstRow.outerHTML);
                
                const titleCol = firstRow.querySelector('.compact-title-col');
                const link = firstRow.querySelector('.compact-link');
                const preview = firstRow.querySelector('.compact-preview');
                
                console.log('DEBUG: Title column:', titleCol?.innerText);
                console.log('DEBUG: Link text:', link?.innerText);
                console.log('DEBUG: Preview text:', preview?.innerText);
                
                // Force visible test text
                if (link) {
                    link.innerText = 'TEST TITLE - VISIBLE?';
                    link.style.color = 'red';
                    link.style.fontSize = '16px';
                    console.log('DEBUG: Added test text to link');
                }
                
                if (preview) {
                    preview.innerText = 'TEST PREVIEW - VISIBLE?';
                    preview.style.color = 'blue';
                    preview.style.fontSize = '14px';
                    console.log('DEBUG: Added test text to preview');
                }
            }
        }, 200);
        
        // Check styles after render
        setTimeout(() => {
            const firstItem = document.querySelector('.feed-item');
            const compactItem = document.querySelector('.compact-item');
            
            console.log('DEBUG: First item (.feed-item):', firstItem?.className);
            console.log('DEBUG: First compact item (.compact-item):', compactItem?.className);
            
            if (firstItem) {
                const styles = window.getComputedStyle(firstItem);
                console.log('DEBUG: .feed-item computed styles:', {
                    display: styles.display,
                    padding: styles.padding,
                    maxHeight: styles.maxHeight,
                    minHeight: styles.minHeight,
                    marginBottom: styles.marginBottom,
                    borderLeft: styles.borderLeft,
                    background: styles.background
                });
            }
            
            if (compactItem) {
                const compactStyles = window.getComputedStyle(compactItem);
                console.log('DEBUG: .compact-item computed styles:', {
                    display: compactStyles.display,
                    padding: compactStyles.padding,
                    maxHeight: compactStyles.maxHeight,
                    minHeight: compactStyles.minHeight,
                    marginBottom: compactStyles.marginBottom,
                    borderLeft: compactStyles.borderLeft
                });
            }
            
            // Check if layout-compact class is on container
            console.log('DEBUG: Container has layout-compact class:', feedContainer.classList.contains('layout-compact'));
            
            // Check actual HTML structure
            if (firstItem) {
                console.log('DEBUG: First item HTML (first 200 chars):', firstItem.outerHTML.substring(0, 200));
            }
        }, 100);
    } else {
        console.log('DEBUG: No feed items available - try loading items first');
        showError('No feed items available. Try collecting items first.');
    }
}

function applyFilters() {
    // Update filters from UI
    currentFilters.source = document.getElementById('sourceFilter').value;
    currentFilters.sort = document.getElementById('sortBy').value;
    currentFilters.limit = parseInt(document.getElementById('itemsPerPage').value);
    currentFilters.search = document.getElementById('searchInput').value;
    currentFilters.dateRange = document.getElementById('dateFilter')?.value || '';
    currentFilters.author = document.getElementById('authorFilter')?.value || '';
    currentFilters.minEngagement = document.getElementById('engagementFilter')?.value || '';
    currentFilters.starred = document.getElementById('starredFilter').value;
    currentFilters.topic = document.getElementById('topicFilter').value;
    
    // Preserve layout mode
    const layoutSelector = document.getElementById('layoutMode');
    if (layoutSelector) {
        currentFilters.layout = layoutSelector.value;
    }

    // save filters to database 
    saveFilters();
    // Always reset pagination when applying filters
    currentPage = 0;
    hasMoreItems = true;
    
    // All filtering is now done on the backend
    loadFeedItems();
}


function disableSourceAndDateRangeFilters() {
    // Clear the values
    currentFilters.source = '';
    currentFilters.dateRange = '';

    const sourceFilterEl = document.getElementById('sourceFilter');
    const dateRangeFilterEl   = document.getElementById('dateFilter');

    // Clear the values
    sourceFilterEl.value = '';
    dateRangeFilterEl.value   = '';

    // Disable the controls
    sourceFilterEl.disabled = true;
    dateRangeFilterEl.disabled   = true;

    // Add tooltip to explain why they are disabled
    sourceFilterEl.title = 'Source filter is disabled when combination filter is active';
    dateRangeFilterEl.title   = 'DateRange filter is disabled when combination filter is active';
}

function enableSourceAndDateRangeFilters() {
    const sourceFilterEl = document.getElementById('sourceFilter');
    const dateFilterEl   = document.getElementById('dateFilter');

    // Enable the controls
    sourceFilterEl.disabled = false;
    dateFilterEl.disabled   = false;

    // Remove tooltip when controls are active
    sourceFilterEl.removeAttribute('title');
    dateFilterEl.removeAttribute('title');
}

function getDateFromRange(range, now) {
    switch (range) {
        case 'today':
            return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        case 'week':
            const weekAgo = new Date(now);
            weekAgo.setDate(now.getDate() - 7);
            return weekAgo;
        case 'month':
            const monthAgo = new Date(now);
            monthAgo.setMonth(now.getMonth() - 1);
            return monthAgo;
        case 'quarter':
            const quarterAgo = new Date(now);
            quarterAgo.setMonth(now.getMonth() - 3);
            return quarterAgo;
        default:
            return new Date(0); // Beginning of time
    }
}

function getEngagementScore(item) {
    const engagement = item.engagement_metrics || {};
    return (engagement.likes || 0) + (engagement.reposts || 0) + (engagement.replies || 0);
}

// Search functionality
function handleSearch(event) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        applyFilters();
    }, 300);
    
    // Handle Enter key
    if (event.key === 'Enter') {
        clearTimeout(searchTimeout);
        applyFilters();
    }
}

function debounceFilter(func, delay) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(func, delay);
}

// Customization panel
function toggleCustomizePanel() {
    const panel = document.getElementById('customizePanel');
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
    
    // Update button text
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    icon.className = isVisible ? 'fas fa-sliders-h' : 'fas fa-times';
}

function changeLayout() {
    const layout = document.getElementById('layoutMode').value;
    console.log('DEBUG: Changing layout to:', layout);
    
    currentFilters.layout = layout;
    saveFilters();
    
    const feedItemsContainer = document.getElementById('feedItems');
    feedItemsContainer.className = `feed-items layout-${layout}`;
    console.log('DEBUG: Applied layout class:', feedItemsContainer.className);
    console.log('DEBUG: Container classes after change:', feedItemsContainer.classList);
    console.log('DEBUG: feedItems.length:', feedItems.length);
    
    // Re-render items with new layout
    renderFeedItems();
    
    // Debug: Check if compact styles are being applied
    if (layout === 'compact') {
        console.log('DEBUG: Compact layout selected, checking if styles are applied');
        setTimeout(() => {
            const firstItem = document.querySelector('.feed-item');
            if (firstItem) {
                const styles = window.getComputedStyle(firstItem);
                console.log('DEBUG: First item computed styles - padding:', styles.padding, 'max-height:', styles.maxHeight);
            } else {
                console.log('DEBUG: No feed items found after layout change');
            }
        }, 100);
    }
}

function saveCustomizations() {
    applyFilters();
    showSuccess('Preferences saved!');
    toggleCustomizePanel();
}

function resetCustomizations() {
    // Reset all filters
    currentFilters = {...currentFiltersInitialState};
    saveFilters();
    
    // Reset UI
    document.getElementById('sourceFilter').value = '';
    document.getElementById('sortBy').value = 'publication_date';
    document.getElementById('itemsPerPage').value = '50';
    document.getElementById('searchInput').value = '';
    document.getElementById('starredFilter').value = '';
    if (document.getElementById('dateFilter')) document.getElementById('dateFilter').value = '';
    if (document.getElementById('authorFilter')) document.getElementById('authorFilter').value = '';
    if (document.getElementById('engagementFilter')) document.getElementById('engagementFilter').value = '';
    document.getElementById('layoutMode').value = 'cards';
    document.getElementById('topicFilter').value = '';
    document.getElementById('showHideArticleBtn').checked = false;
    
    // Apply changes
    changeLayout();
    loadFilters();
    
    showSuccess('Preferences reset to defaults!');
}

function updateShowHideBtn() {
    const toggleBtn = document.getElementById('showHideArticleBtn');
    
    if (currentFilters.showHidden) {
        toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
        toggleBtn.title = 'Hide Hidden Articles';
    } else {
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        toggleBtn.title = 'Show Hidden Articles';
    }
}

function toggleHiddenItems() {
    currentFilters.showHidden = !currentFilters.showHidden;
    
    // Update square button icon and tooltip
    const toggleBtn = event.target.closest('button');
    if (toggleBtn) {
        if (currentFilters.showHidden) {
            toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
            toggleBtn.title = 'Hide Hidden Articles';
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            toggleBtn.title = 'Show Hidden Articles';
        }
    }
    
    currentPage = 0;
    hasMoreItems = true;
    saveFilters();
    loadFeedItems();
}

async function loadMoreItems() {
    if (hasMoreItems) {
        console.log('DEBUG: loadMoreItems() called - incrementing currentPage from', currentPage, 'to', currentPage + 1);
        console.trace('DEBUG: Stack trace for loadMoreItems() call');
        currentPage++;
        await loadFeedItems(true);
    }
}

function updateLoadMoreButton() {
    const container = document.getElementById('loadMoreContainer');
    // Hide load more button since we have infinite scroll
    // Only show if infinite scroll isn't working for some reason
    container.style.display = 'none';
}

function refreshCurrentFeed() {
    currentPage = 0;
    hasMoreItems = true;
    loadFeedItems();
}

// Quick function to show only starred items
function showOnlyStarredItems() {
    document.getElementById('starredFilter').value = 'starred';
    applyFilters();
    
    // Show visual feedback
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-star"></i> Showing Starred';
    btn.classList.add('btn-primary-control');
    btn.classList.remove('btn-warning');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-primary-control');
        btn.classList.add('btn-warning');
    }, 2000);
}

// Utility functions
function showSuccess(message) {
    console.log('Success:', message);
    // Simple success indicator - could be enhanced with a toast system
    const button = event?.target;
    if (button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> ' + message;
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    }
}

function showError(message) {
    console.error('Error:', message);
    alert('Error: ' + message);
}

function showInfo(message) {
    console.log('Info:', message);
    // Simple info indicator - could be enhanced with a toast system
    const button = event?.target;
    if (button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-info-circle"></i> ' + message;
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    }
}

function renderEmptyState() {
    document.getElementById('feedItems').innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: var(--dark-gray);">
            <i class="fas fa-rss" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: 16px;"></i>
            <h3 style="color: var(--dark-gray); margin-bottom: 8px;">Welcome to Your Unified Feed!</h3>
            <p>Create your first feed group to start aggregating content from social media and academic sources.</p>
            <button class="btn-tab-control btn-primary-control" onclick="window.location.href='/feed-manager'">
                <i class="fas fa-plus"></i>
                Create Your First Group
            </button>
        </div>
    `;
}

// Article Enrichment Functionality
let selectedArticles = [];
let currentEnrichmentResults = [];

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    const count = checkboxes.length;
    
    document.getElementById('selectedCount').textContent = count;
    
    // Update selected articles array
    selectedArticles = Array.from(checkboxes).map(cb => {
        const itemId = parseInt(cb.dataset.itemId);
        return feedItems.find(item => item.id === itemId);
    }).filter(Boolean);
    
    // Update bulk star operation counts
    const starredCount = selectedArticles.filter(item => item.is_starred).length;
    const unstarredCount = selectedArticles.filter(item => !item.is_starred).length;
    
    // Enable/disable bulk star buttons
    const bulkStarBtn = document.getElementById('bulkStarBtn');
    const bulkUnstarBtn = document.getElementById('bulkUnstarBtn');
    
    if (bulkStarBtn) {
        bulkStarBtn.disabled = unstarredCount === 0;
    }
    if (bulkUnstarBtn) {
        bulkUnstarBtn.disabled = starredCount === 0;
    }
    
    // Enable/disable action buttons based on selection
    const enrichBtn = document.querySelector('.btn-enrichment');
    const sendSelectedBtn = document.getElementById('sendSelectedBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const hideSelectedBtn = document.getElementById('hideSelectedBtn');
    
    if (enrichBtn) {
        enrichBtn.disabled = count === 0;
    }
    if (sendSelectedBtn) {
        sendSelectedBtn.disabled = count === 0;
    }
    if (deleteSelectedBtn) {
        deleteSelectedBtn.disabled = count === 0;
    }
    if (hideSelectedBtn) {
        hideSelectedBtn.disabled = count === 0;
    }
    
    // Update starred count in the toolbar
    const totalStarredItems = feedItems.filter(item => item.is_starred).length;
    const starredCountElement = document.getElementById('starredCount');
    const totalStarredCountElement = document.getElementById('totalStarredCount');
    
    if (starredCountElement) {
        starredCountElement.textContent = starredCount;
    }
    if (totalStarredCountElement) {
        totalStarredCountElement.textContent = totalStarredItems;
    }
    
    // Update select all button icon only (no text for square button)
    const selectAllBtn = document.getElementById('selectAllBtn');
    const allCheckboxes = document.querySelectorAll('.item-checkbox');
    const allSelected = Array.from(allCheckboxes).every(cb => cb.checked);
    
    if (selectAllBtn) {
        if (allSelected && allCheckboxes.length > 0) {
            selectAllBtn.innerHTML = '<i class="fas fa-square"></i>';
            selectAllBtn.title = 'Deselect All';
        } else {
            selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i>';
            selectAllBtn.title = 'Select All';
        }
    }
}

// Bulk Star Operations
async function bulkStarArticles() {
    const unstarredItems = selectedArticles.filter(item => !item.is_starred);
    if (unstarredItems.length === 0) {
        showError('No unstarred items selected');
        return;
    }
    
    const confirmStar = confirm(`Star ${unstarredItems.length} selected articles?`);
    if (!confirmStar) return;
    
    const bulkStarBtn = document.getElementById('bulkStarBtn');
    const originalText = bulkStarBtn.innerHTML;
    
    try {
        bulkStarBtn.disabled = true;
        bulkStarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starring...';
        
        let successCount = 0;
        let errorCount = 0;
        
        for (const item of unstarredItems) {
            try {
                await toggleStar(item.id, true);
                successCount++;
            } catch (error) {
                console.error(`Error starring item ${item.id}:`, error);
                errorCount++;
            }
        }
        
        showSuccess(`Successfully starred ${successCount} articles${errorCount > 0 ? ` (${errorCount} failed)` : ''}`);
        
        // Refresh the display and starred count
        await loadFeedItems();
        await loadStarredCount();
        
    } catch (error) {
        console.error('Error during bulk star operation:', error);
        showError('Failed to star articles. Please try again.');
    } finally {
        bulkStarBtn.disabled = false;
        bulkStarBtn.innerHTML = originalText;
    }
}

async function bulkUnstarArticles() {
    const starredItems = selectedArticles.filter(item => item.is_starred);
    if (starredItems.length === 0) {
        showError('No starred items selected');
        return;
    }
    
    const confirmUnstar = confirm(`Unstar ${starredItems.length} selected articles?`);
    if (!confirmUnstar) return;
    
    const bulkUnstarBtn = document.getElementById('bulkUnstarBtn');
    const originalText = bulkUnstarBtn.innerHTML;
    
    try {
        bulkUnstarBtn.disabled = true;
        bulkUnstarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Unstarring...';
        
        let successCount = 0;
        let errorCount = 0;
        
        for (const item of starredItems) {
            try {
                await toggleStar(item.id, false);
                successCount++;
            } catch (error) {
                console.error(`Error unstarring item ${item.id}:`, error);
                errorCount++;
            }
        }
        
        showSuccess(`Successfully unstarred ${successCount} articles${errorCount > 0 ? ` (${errorCount} failed)` : ''}`);
        
        // Refresh the display and starred count
        await loadFeedItems();
        await loadStarredCount();
        
    } catch (error) {
        console.error('Error during bulk unstar operation:', error);
        showError('Failed to unstar articles. Please try again.');
    } finally {
        bulkUnstarBtn.disabled = false;
        bulkUnstarBtn.innerHTML = originalText;
    }
}

// Export Starred Items
async function exportStarredItems() {
    const exportBtn = event.target;
    const originalText = exportBtn.innerHTML;
    
    try {
        exportBtn.disabled = true;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        
        // Get all starred items across all groups using pagination
        let allStarredItems = [];
        let offset = 0;
        const limit = 200; // Maximum allowed limit
        let hasMore = true;
        
        while (hasMore) {
            exportBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Collecting... (${allStarredItems.length} starred found)`;
            
            const response = await fetch(`/api/unified-feed?limit=${limit}&offset=${offset}`, {
                method: 'GET'
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            const starredItems = data.items ? data.items.filter(item => item.is_starred) : [];
            allStarredItems = allStarredItems.concat(starredItems);
            
            hasMore = data.has_more;
            offset += limit;
            
            // Prevent infinite loops
            if (offset > 10000) break;
        }
        
        const starredItems = allStarredItems;
        
        exportBtn.innerHTML = `<i class="fas fa-download"></i> Exporting ${starredItems.length} starred items...`;
        
        if (starredItems.length === 0) {
            showError('No starred articles found to export');
            return;
        }
        
        // Prepare export data
        const exportData = starredItems.map(item => ({
            title: item.title,
            url: item.url,
            source: item.source_type,
            author: item.author,
            author_handle: item.author_handle,
            publication_date: item.publication_date,
            content: item.content,
            feed_group: item.group_name,
            tags: Array.isArray(item.tags) ? item.tags.join(', ') : item.tags,
            engagement_likes: item.engagement_metrics?.likes || 0,
            engagement_reposts: item.engagement_metrics?.reposts || 0,
            engagement_replies: item.engagement_metrics?.replies || 0,
            starred_date: new Date().toISOString(),
            // Analysis data if available
            category: item.category,
            sentiment: item.sentiment,
            future_signal: item.future_signal,
            time_to_impact: item.time_to_impact,
            driver_type: item.driver_type
        }));
        
        // Export as CSV
        const csvContent = convertToCSV(exportData);
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `starred_articles_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        exportBtn.innerHTML = '<i class="fas fa-check"></i> Export Complete!';
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
        }, 3000);
        
        showSuccess(`Successfully exported ${starredItems.length} starred articles to CSV!`);
        
    } catch (error) {
        console.error('Error exporting starred items:', error);
        showError('Failed to export starred articles. Please try again.');
    } finally {
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalText;
    }
}

// Helper function to convert data to CSV format
function convertToCSV(data) {
    if (data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const csvHeaders = headers.join(',');
    
    const csvRows = data.map(row => {
        return headers.map(header => {
            let value = row[header];
            // Handle null/undefined values
            if (value === null || value === undefined) {
                value = '';
            }
            // Escape quotes and wrap in quotes if contains comma or quote
            value = String(value).replace(/"/g, '""');
            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                value = `"${value}"`;
            }
            return value;
        }).join(',');
    });
    
    return [csvHeaders, ...csvRows].join('\n');
}

function enrichSingleArticle(itemId) {
    const article = feedItems.find(item => item.id === itemId);
    if (!article) return;
    
    selectedArticles = [article];
    openEnrichmentModal();
}

function enrichSelectedArticles() {
    if (selectedArticles.length === 0) {
        showError('Please select articles to enrich');
        return;
    }
    
    openEnrichmentModal();
}

async function openEnrichmentModal() {
    // Load topics and models
    await Promise.all([
        loadEnrichmentTopics(),
        loadEnrichmentModels()
    ]);
    
    // Populate selected articles list
    populateEnrichmentArticlesList();
    
    // Reset modal state
    resetEnrichmentModalState();
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('articleEnrichmentModal'));
    modal.show();
}

async function loadEnrichmentTopics() {
    try {
        const response = await fetch('/api/topics');
        const topics = await response.json();
        const topicSelect = document.getElementById('enrichmentTopicSelect');
        
        topicSelect.innerHTML = '<option value="">Select a topic</option>';
        topics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic.name;
            option.textContent = topic.name;
            topicSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading topics:', error);
    }
}

async function loadEnrichmentModels() {
    try {
        const response = await fetch('/api/available_models');
        const models = await response.json();
        const modelSelect = document.getElementById('enrichmentModelSelect');
        
        modelSelect.innerHTML = '<option value="">Select a model</option>';
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.name;
            option.textContent = `${model.name} (${model.provider})`;
            modelSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading models:', error);
    }
}

function populateEnrichmentArticlesList() {
    const listContainer = document.getElementById('enrichmentSelectedArticlesList');
    const countElement = document.getElementById('enrichmentSelectedCount');
    
    countElement.textContent = selectedArticles.length;
    listContainer.innerHTML = '';
    
    selectedArticles.forEach((article, index) => {
        const listItem = document.createElement('div');
        listItem.className = 'list-group-item';
        listItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${article.title || 'Untitled'}</h6>
                    <p class="mb-1 small text-muted">${article.source_type?.toUpperCase() || 'Unknown Source'}</p>
                    <small class="text-muted">${article.url}</small>
                </div>
                <span class="badge bg-primary">#${index + 1}</span>
            </div>
        `;
        listContainer.appendChild(listItem);
    });
}

function resetEnrichmentModalState() {
    currentEnrichmentResults = [];
    
    // Hide progress and results sections
    document.getElementById('enrichmentProgressContainer').style.display = 'none';
    document.getElementById('enrichmentResultsContainer').style.display = 'none';
    document.getElementById('saveEnrichmentResultsBtn').style.display = 'none';
    
    // Reset progress bar
    const progressBar = document.getElementById('enrichmentProgressBar');
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
    
    // Reset save button
    const saveBtn = document.getElementById('saveEnrichmentResultsBtn');
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save All Articles';
    saveBtn.classList.remove('btn-success');
    saveBtn.classList.add('btn-primary');
    
    // Reset options
    document.getElementById('enrichmentBackgroundProcessing').checked = true;
    document.getElementById('enrichmentQualityControl').checked = true;
    
    // Enable start button
    document.getElementById('startEnrichmentBtn').disabled = false;
}

async function startArticleEnrichment() {
    const topic = document.getElementById('enrichmentTopicSelect').value;
    const model = document.getElementById('enrichmentModelSelect').value;
    
    if (!topic || !model) {
        showError('Please select both a topic and AI model');
        return;
    }
    
    const backgroundProcessing = document.getElementById('enrichmentBackgroundProcessing').checked;
    const qualityControl = document.getElementById('enrichmentQualityControl').checked;
    
    try {
        // Disable start button and show progress
        document.getElementById('startEnrichmentBtn').disabled = true;
        document.getElementById('enrichmentProgressContainer').style.display = 'block';
        
        // Prepare request data
        const enrichmentUrls = selectedArticles.map(article => article.url);
        
        // Store URLs for debugging
        window.lastEnrichmentUrls = enrichmentUrls;
        console.log('üîß DEBUG: URLs being sent for enrichment:', enrichmentUrls);
        
        const requestData = {
            urls: enrichmentUrls,
            summaryType: "curious_ai_long",
            modelName: model,
            topic: topic,
            preservedMetadata: selectedArticles.map(article => ({
                title: article.title,
                source: article.source_type,
                url: article.url,
                publication_date: article.publication_date,
                author: article.author,
                summary: article.content
            })),
            options: {
                backgroundProcessing: backgroundProcessing,
                qualityControl: qualityControl
            }
        };
        
        if (backgroundProcessing) {
            const qcText = qualityControl ? ' with Quality Control' : '';
            showSuccess(`Enrichment started in background for ${selectedArticles.length} articles${qcText}`);
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('articleEnrichmentModal'));
                if (modal) modal.hide();
            }, 1000);
        }
        
        // Start streaming enrichment
        await performStreamingEnrichment(requestData);
        
    } catch (error) {
        console.error('Error during enrichment:', error);
        showError(`Enrichment failed: ${error.message}`);
        resetEnrichmentModalState();
    }
}

async function performStreamingEnrichment(requestData) {
    const progressText = document.getElementById('enrichmentProgressText');
    const progressBar = document.getElementById('enrichmentProgressBar');
    
    let processedCount = 0;
    const totalCount = requestData.urls.length;
    
    const response = await fetch('/api/bulk-research-stream', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Accept: 'application/x-ndjson'
        },
        body: JSON.stringify(requestData)
    });

    if (!response.ok || !response.body) {
        throw new Error(`Server error: ${response.status}`);
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();
        
        for (const line of lines) {
            if (!line.trim()) continue;
            
            try {
                const result = JSON.parse(line);
                currentEnrichmentResults.push(result);
                processedCount++;
                
                // Update progress
                const percentage = (processedCount / totalCount) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
                
                // Show quality control status if enabled
                const qualityControl = document.getElementById('enrichmentQualityControl').checked;
                const qcText = qualityControl ? ' (with Quality Control)' : '';
                progressText.textContent = `Processed ${processedCount} of ${totalCount} articles${qcText}...`;
                
            } catch (e) {
                console.error('Failed to parse NDJSON line', line, e);
            }
        }
    }
    
    // Analysis complete
    const qualityControl = document.getElementById('enrichmentQualityControl').checked;
    const qcCompleteText = qualityControl ? ' (Quality Control completed)' : '';
    progressText.textContent = `Enrichment complete! Processed ${currentEnrichmentResults.length} articles${qcCompleteText}.`;
    progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
    progressBar.style.width = '100%';
    
    // Show quality control summary if enabled
    if (qualityControl && currentEnrichmentResults.length > 0) {
        const approvedCount = currentEnrichmentResults.filter(r => r.review_recommendation === 'approve').length;
        const rejectedCount = currentEnrichmentResults.filter(r => r.review_recommendation === 'reject').length;
        const reviewCount = currentEnrichmentResults.filter(r => r.review_recommendation === 'review').length;
        const noQcCount = currentEnrichmentResults.length - approvedCount - rejectedCount - reviewCount;
        
        let qcSummary = `Successfully enriched ${currentEnrichmentResults.length} articles!`;
        if (approvedCount > 0 || rejectedCount > 0 || reviewCount > 0) {
            qcSummary += ` Quality Control: ${approvedCount} approved`;
            if (reviewCount > 0) qcSummary += `, ${reviewCount} flagged for review`;
            if (rejectedCount > 0) qcSummary += `, ${rejectedCount} rejected`;
            if (noQcCount > 0) qcSummary += `, ${noQcCount} not reviewed`;
        }
        showSuccess(qcSummary);
    } else {
        showSuccess(`Successfully enriched ${currentEnrichmentResults.length} articles!`);
    }
    
    // Show results and save button if we have enrichment results
    if (currentEnrichmentResults.length > 0) {
        // Show the enrichment results container
        document.getElementById('enrichmentResultsContainer').style.display = 'block';
        
        // Show save button
        document.getElementById('saveEnrichmentResultsBtn').style.display = 'inline-block';
        
        // Populate results
        displayEnrichmentResults(currentEnrichmentResults);
    }
    
}

// Display enrichment results in the modal
function displayEnrichmentResults(results) {
    const container = document.getElementById('enrichmentResultsList');
    container.innerHTML = '';
    
    results.forEach((result, index) => {
        const resultItem = document.createElement('div');
        resultItem.className = 'list-group-item border rounded p-3 mb-2 bg-light';
        resultItem.dataset.resultIndex = index;
        resultItem.dataset.resultUri = result.uri;
        
        resultItem.innerHTML = `
            <div class="result-item-actions">
                <button class="btn btn-outline-primary btn-sm" onclick="editEnrichmentResult(${index})" title="Edit result">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="removeEnrichmentResult(${index})" title="Remove result">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 pe-5 pt-2">
                                            <h6 class="mb-1">${result.title || 'Untitled'}</h6>
                        <div class="summary-section mb-2">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-success me-2 summary-badge" title="AI-generated summary">AI</span>
                                <p class="mb-0 small ai-summary">${result.summary || 'No AI summary available'}</p>
                            </div>
                        </div>
                        ${result.review_recommendation && result.review_recommendation !== 'approve' ? `
                        <div class="alert alert-${result.review_recommendation === 'reject' ? 'danger' : 'warning'} py-2 mb-2">
                            <small><i class="fas fa-${result.review_recommendation === 'reject' ? 'times-circle' : 'exclamation-triangle'} me-1"></i><strong>Quality Control:</strong> ${result.review_recommendation === 'reject' ? 'Rejected' : 'Flagged for review'}${result.quality_issues ? ` - ${result.quality_issues}` : ''}</small>
                        </div>` : ''}
                    <div class="d-flex flex-wrap gap-1 mt-2">
                        ${result.category ? `<span class="badge bg-info"><i class="fas fa-tag me-1"></i>${result.category}</span>` : ''}
                        ${result.sentiment ? `<span class="badge bg-secondary"><i class="fas fa-smile me-1"></i>${result.sentiment}</span>` : ''}
                        ${result.future_signal ? `<span class="badge bg-warning text-dark"><i class="fas fa-chart-line me-1"></i>${result.future_signal}</span>` : ''}
                        ${result.time_to_impact ? `<span class="badge bg-success"><i class="fas fa-clock me-1"></i>${result.time_to_impact}</span>` : ''}
                        ${result.driver_type ? `<span class="badge bg-dark"><i class="fas fa-cogs me-1"></i>${result.driver_type}</span>` : ''}
                        ${result.quality_score ? `<span class="badge bg-success"><i class="fas fa-shield-check me-1"></i>Quality: ${Math.round(result.quality_score * 100)}/100</span>` : ''}
                        ${result.review_recommendation ? `<span class="badge ${result.review_recommendation === 'approve' ? 'bg-success' : result.review_recommendation === 'reject' ? 'bg-danger' : 'bg-warning text-dark'}"><i class="fas fa-${result.review_recommendation === 'approve' ? 'check' : result.review_recommendation === 'reject' ? 'times' : 'exclamation'} me-1"></i>QC: ${result.review_recommendation}</span>` : ''}
                    </div>
                    <small class="text-muted">${result.news_source || result.uri}</small>
                    ${result.quality_issues ? `<div class="mt-2 p-2 bg-warning bg-opacity-25 border border-warning rounded"><small><i class="fas fa-exclamation-triangle me-1"></i><strong>Quality Issues:</strong> ${result.quality_issues}</small></div>` : ''}
                    ${result.review_notes ? `<div class="mt-2 p-2 bg-info bg-opacity-25 border border-info rounded"><small><i class="fas fa-info-circle me-1"></i><strong>Review Notes:</strong> ${result.review_notes}</small></div>` : ''}
                </div>
                <span class="badge bg-primary mt-4">#${index + 1}</span>
            </div>
        `;
        container.appendChild(resultItem);
    });
    
    // Update count
    document.getElementById('enrichmentResultsCount').textContent = results.length;
}

// Save enrichment results directly (like keyword_alerts does)
async function saveEnrichmentResults() {
    const saveBtn = document.getElementById('saveEnrichmentResultsBtn');
    const topic = document.getElementById('enrichmentTopicSelect').value;
    
    if (currentEnrichmentResults.length === 0) {
        showError('No enrichment results to save');
        return;
    }
    
    try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Prepare articles for saving (same format as keyword_alerts)
        const articles = currentEnrichmentResults.map(result => ({
            ...result,
            topic: topic,
            tags: Array.isArray(result.tags) ? result.tags : (result.tags ? result.tags.split(',').map(tag => tag.trim()) : []),
            submission_date: new Date().toISOString(),
            analyzed: true
        }));
        
        const response = await fetch('/api/save-bulk-articles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ articles }),
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success && result.success.length > 0) {
            showSuccess(`${result.success.length} articles saved successfully!`);
            
            // Update button to show success
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved Successfully';
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('btn-success');
            
            // Hide the modal after a delay
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('articleEnrichmentModal'));
                if (modal) modal.hide();
            }, 2000);
        }
        
        if (result.errors && result.errors.length > 0) {
            const errorMessage = result.errors.map(error => `${error.uri}: ${error.error}`).join('\n');
            showError(`Some articles could not be saved:\n${errorMessage}`);
        }
        
    } catch (error) {
        console.error('Error saving enrichment results:', error);
        showError(`Error saving articles: ${error.message}`);
    } finally {
        if (!saveBtn.classList.contains('btn-success')) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save All Articles';
        }
    }
}

// View detailed results for a specific article
function viewDetailedResults(index) {
    const result = currentEnrichmentResults[index];
    if (!result) return;
    
    // Use the same modal as individual article results
    showEnrichmentResultsModal(result, null);
}

// Function to edit enrichment result
async function editEnrichmentResult(index) {
    const result = currentEnrichmentResults[index];
    if (!result) return;
    
    // Get the selected topic for fetching options
    const topicSelect = document.getElementById('enrichmentTopicSelect');
    const selectedTopic = topicSelect ? topicSelect.value : 'AI and Machine Learning'; // Default fallback
    
    try {
        // Fetch topic options from API
        const response = await fetch(`/api/topic-options/${encodeURIComponent(selectedTopic)}`);
        const topicOptions = await response.json();
        
        // Create dropdown options
        const sentimentOptions = topicOptions.sentiments?.map(sentiment => 
            `<option value="${sentiment}" ${result.sentiment === sentiment ? 'selected' : ''}>${sentiment}</option>`
        ).join('') || '<option value="">No sentiments available</option>';
        
        const timeToImpactOptions = topicOptions.timeToImpacts?.map(time => 
            `<option value="${time}" ${result.time_to_impact === time ? 'selected' : ''}>${time}</option>`
        ).join('') || '<option value="">No time to impact options available</option>';
        
        const driverTypeOptions = topicOptions.driverTypes?.map(driver => 
            `<option value="${driver}" ${result.driver_type === driver ? 'selected' : ''}>${driver}</option>`
        ).join('') || '<option value="">No driver types available</option>';
        
        const categoryOptions = topicOptions.categories?.map(category => 
            `<option value="${category}" ${result.category === category ? 'selected' : ''}>${category}</option>`
        ).join('') || '<option value="">No categories available</option>';
        
        const futureSignalOptions = topicOptions.futureSignals?.map(signal => 
            `<option value="${signal}" ${result.future_signal === signal ? 'selected' : ''}>${signal}</option>`
        ).join('') || '<option value="">No future signals available</option>';
        
        // Create a simple edit dialog
        const editModal = document.createElement('div');
        editModal.className = 'modal fade';
        editModal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Enrichment Result</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="editResultTitle" value="${result.title || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">AI-Generated Summary</label>
                            <textarea class="form-control" id="editResultSummary" rows="3">${result.summary || ''}</textarea>
                            <div class="form-text">This is the AI-generated summary that will be saved to the database.</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-control" id="editResultCategory">
                                        <option value="">Select category</option>
                                        ${categoryOptions}
                                    </select>
                                    <div class="form-text">Available categories from topic: ${topicOptions.categories?.length || 0}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Sentiment</label>
                                    <select class="form-control" id="editResultSentiment">
                                        <option value="">Select sentiment</option>
                                        ${sentimentOptions}
                                    </select>
                                    <div class="form-text">Available sentiments: ${topicOptions.sentiments?.length || 0}</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Time to Impact</label>
                                    <select class="form-control" id="editResultTimeToImpact">
                                        <option value="">Select time frame</option>
                                        ${timeToImpactOptions}
                                    </select>
                                    <div class="form-text">Available timeframes: ${topicOptions.timeToImpacts?.length || 0}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Driver Type</label>
                                    <select class="form-control" id="editResultDriverType">
                                        <option value="">Select driver type</option>
                                        ${driverTypeOptions}
                                    </select>
                                    <div class="form-text">Available drivers: ${topicOptions.driverTypes?.length || 0}</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Future Signal</label>
                            <select class="form-control" id="editResultFutureSignal">
                                <option value="">Select future signal</option>
                                ${futureSignalOptions}
                            </select>
                            <div class="form-text">Available signals: ${topicOptions.futureSignals?.length || 0}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveEditedEnrichmentResult(${index})">Save Changes</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(editModal);
        const modal = new bootstrap.Modal(editModal);
        modal.show();
        
        // Remove modal from DOM when hidden
        editModal.addEventListener('hidden.bs.modal', () => {
            editModal.remove();
        });
        
    } catch (error) {
        console.error('Error loading topic options:', error);
        showError('Failed to load topic options. Using basic fields only.');
        
        // Fallback to basic modal if API fails
        showBasicEditModal(result, index);
    }
}

// Fallback function for basic edit modal without API options
function showBasicEditModal(result, index) {
    const editModal = document.createElement('div');
    editModal.className = 'modal fade';
    editModal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Enrichment Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="editResultTitle" value="${result.title || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">AI-Generated Summary</label>
                        <textarea class="form-control" id="editResultSummary" rows="3">${result.summary || ''}</textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" id="editResultCategory" value="${result.category || ''}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sentiment</label>
                                <input type="text" class="form-control" id="editResultSentiment" value="${result.sentiment || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Time to Impact</label>
                                <input type="text" class="form-control" id="editResultTimeToImpact" value="${result.time_to_impact || ''}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Driver Type</label>
                                <input type="text" class="form-control" id="editResultDriverType" value="${result.driver_type || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Future Signal</label>
                        <input type="text" class="form-control" id="editResultFutureSignal" value="${result.future_signal || ''}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedEnrichmentResult(${index})">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(editModal);
    const modal = new bootstrap.Modal(editModal);
    modal.show();
    
    editModal.addEventListener('hidden.bs.modal', () => {
        editModal.remove();
    });
}

// Function to save edited enrichment result
function saveEditedEnrichmentResult(index) {
    const result = currentEnrichmentResults[index];
    result.title = document.getElementById('editResultTitle').value;
    result.summary = document.getElementById('editResultSummary').value;
    result.category = document.getElementById('editResultCategory').value;
    result.sentiment = document.getElementById('editResultSentiment').value;
    result.time_to_impact = document.getElementById('editResultTimeToImpact').value;
    result.driver_type = document.getElementById('editResultDriverType').value;
    result.future_signal = document.getElementById('editResultFutureSignal').value;
    
    // Update the display
    displayEnrichmentResults(currentEnrichmentResults);
    
    // Close the edit modal
    const modal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
    if (modal) modal.hide();
    
    showSuccess('Enrichment result updated successfully!');
}

// Function to remove enrichment result
function removeEnrichmentResult(index) {
    if (confirm('Remove this enrichment result?')) {
        currentEnrichmentResults.splice(index, 1);
        
        // Re-display all results
        displayEnrichmentResults(currentEnrichmentResults);
        
        showSuccess('Enrichment result removed');
    }
}

// Bulk save enriched articles
async function bulkSaveEnrichedArticles() {
    const enrichedItems = [];
    
    // Find all items that have enrichment results available
    for (const item of feedItems) {
        const resultsBtn = document.getElementById(`results-btn-${item.id}`);
        if (resultsBtn && resultsBtn.style.display !== 'none') {
            enrichedItems.push(item);
        }
    }
    
    if (enrichedItems.length === 0) {
        showError('No enriched articles found to save');
        return;
    }
    
    const confirmSave = confirm(`Save ${enrichedItems.length} enriched articles to the main database?`);
    if (!confirmSave) return;
    
    const saveBtn = document.getElementById('saveEnrichedBtn');
    const originalText = saveBtn.innerHTML;
    
    try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        let savedCount = 0;
        let alreadyExisted = 0;
        let errors = 0;
        
        for (const item of enrichedItems) {
            try {
                const response = await fetch(`/api/feed-items/${item.id}/save-enriched`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.already_existed) {
                        alreadyExisted++;
                    } else {
                        savedCount++;
                    }
                } else {
                    errors++;
                }
            } catch (error) {
                console.error(`Error saving item ${item.id}:`, error);
                errors++;
            }
        }
        
        // Show results
        let message = '';
        if (savedCount > 0) message += `Saved ${savedCount} new articles. `;
        if (alreadyExisted > 0) message += `${alreadyExisted} already existed. `;
        if (errors > 0) message += `${errors} failed to save.`;
        
        if (errors === 0) {
            showSuccess(message || 'All articles processed successfully!');
        } else {
            showError(message);
        }
        
    } catch (error) {
        console.error('Error during bulk save:', error);
        showError('Failed to save articles. Please try again.');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}



// View enrichment results for a specific item
async function viewEnrichmentResults(itemId) {
    try {
        const response = await fetch(`/api/feed-items/${itemId}/enrichment`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (!result.enriched) {
            showError('No enrichment data available for this item');
            return;
        }
        
        // Populate and show the enrichment results modal
        showEnrichmentResultsModal(result.data, itemId);
        
    } catch (error) {
        console.error('Error fetching enrichment results:', error);
        showError('Failed to load enrichment results');
    }
}

// Show enrichment results in modal
function showEnrichmentResultsModal(data, itemId) {
    const modal = document.getElementById('enrichmentResultsModal');
    const item = feedItems.find(item => item.id === itemId);
    
    // Populate modal content
    document.getElementById('enrichmentResultsTitle').textContent = item ? item.title : 'Article Results';
    document.getElementById('enrichmentResultsUrl').textContent = item ? item.url : '';
    document.getElementById('enrichmentResultsUrl').href = item ? item.url : '#';
    
    // Analysis Results
    document.getElementById('resultCategory').textContent = data.category || 'Not categorized';
    document.getElementById('resultSentiment').textContent = data.sentiment || 'Not analyzed';
    document.getElementById('resultSentimentExplanation').textContent = data.sentiment_explanation || 'No explanation available';
    document.getElementById('resultDriverType').textContent = data.driver_type || 'Not analyzed';
    document.getElementById('resultDriverTypeExplanation').textContent = data.driver_type_explanation || 'No explanation available';
    document.getElementById('resultTimeToImpact').textContent = data.time_to_impact || 'Not analyzed';
    document.getElementById('resultTimeToImpactExplanation').textContent = data.time_to_impact_explanation || 'No explanation available';
    document.getElementById('resultFutureSignal').textContent = data.future_signal || 'Not analyzed';
    document.getElementById('resultFutureSignalExplanation').textContent = data.future_signal_explanation || 'No explanation available';
    
    // Quality Control
    document.getElementById('resultQualityScore').textContent = data.quality_score ? `${Math.round(data.quality_score * 100)}/100` : 'Not scored';
    document.getElementById('resultQualityIssues').textContent = data.quality_issues || 'No issues identified';
    document.getElementById('resultConfidenceScore').textContent = data.confidence_score ? `${Math.round(data.confidence_score * 100)}/100` : 'Not scored';
    
    // Review Status
    const reviewRecommendation = data.review_recommendation || 'Not reviewed';
    const reviewBadge = document.getElementById('resultReviewRecommendation');
    reviewBadge.textContent = reviewRecommendation.charAt(0).toUpperCase() + reviewRecommendation.slice(1);
    reviewBadge.className = `badge ms-2 ${
        reviewRecommendation === 'approve' ? 'bg-success' : 
        reviewRecommendation === 'reject' ? 'bg-danger' : 
        reviewRecommendation === 'review' ? 'bg-warning text-dark' : 
        'bg-secondary'
    }`;
    
    document.getElementById('resultReviewNotes').textContent = data.review_notes || 'No review notes available';
    
    // Relevance Scores
    document.getElementById('resultTopicAlignment').textContent = data.topic_alignment_score ? `${data.topic_alignment_score}/100` : 'Not scored';
    document.getElementById('resultKeywordRelevance').textContent = data.keyword_relevance_score ? `${data.keyword_relevance_score}/100` : 'Not scored';
    document.getElementById('resultOverallExplanation').textContent = data.overall_match_explanation || 'No explanation available';
    
    // Additional Data
    document.getElementById('resultExtractedTopics').textContent = data.extracted_topics || 'None extracted';
    document.getElementById('resultExtractedKeywords').textContent = data.extracted_keywords || 'None extracted';
    document.getElementById('resultTags').textContent = data.tags || 'No tags';
    document.getElementById('resultSummary').textContent = data.summary || 'No summary available';
    
    // Metadata
    document.getElementById('resultAutoIngested').textContent = data.auto_ingested ? 'Yes' : 'No';
    document.getElementById('resultIngestStatus').textContent = data.ingest_status || 'Unknown';
    document.getElementById('resultSubmissionDate').textContent = data.submission_date ? new Date(data.submission_date).toLocaleString() : 'Not available';
    
    // Store current item ID for saving
    modal.setAttribute('data-item-id', itemId);
    
    // Show the modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Save enriched article to main articles database
async function saveEnrichedArticle() {
    const modal = document.getElementById('enrichmentResultsModal');
    const itemId = modal.getAttribute('data-item-id');
    const saveBtn = document.getElementById('saveEnrichedArticleBtn');
    
    if (!itemId) {
        showError('No article selected for saving');
        return;
    }
    
    try {
        // Disable save button
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        const response = await fetch(`/api/feed-items/${itemId}/save-enriched`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Article saved successfully to main database!');
            
            // Update button to show saved state
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('btn-success');
            
            setTimeout(() => {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                if (bootstrapModal) bootstrapModal.hide();
            }, 1500);
        } else {
            throw new Error(result.message || 'Save failed');
        }
        
    } catch (error) {
        console.error('Error saving enriched article:', error);
        showError(`Failed to save article: ${error.message}`);
        
        // Re-enable save button
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save to Database';
    }
}

// Add fadeIn animation
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;
document.head.appendChild(style);

// ======================
// VIEW MODE FUNCTIONS
// ======================

function switchViewMode(mode) {
    currentViewMode = mode;
    localStorage.setItem(CACHE_KEYS.VIEW_MODE, mode);
    
    const dashboardContainer = document.querySelector('.dashboard-container');
    const columnViewContainer = document.getElementById('columnViewContainer');
    const tabViewBtn = document.getElementById('tabViewBtn');
    const columnViewBtn = document.getElementById('columnViewBtn');
    
    if (mode === 'columns') {
        dashboardContainer.classList.remove('view-tabs');
        dashboardContainer.classList.add('view-columns');
        columnViewContainer.classList.add('active');
        
        tabViewBtn.classList.remove('btn-primary');
        tabViewBtn.classList.add('btn-outline-primary');
        columnViewBtn.classList.remove('btn-outline-primary');
        columnViewBtn.classList.add('btn-primary');
        
        // Load column data
        loadColumnView();
    } else {
        dashboardContainer.classList.remove('view-columns');
        dashboardContainer.classList.add('view-tabs');
        columnViewContainer.classList.remove('active');
        
        columnViewBtn.classList.remove('btn-primary');
        columnViewBtn.classList.add('btn-outline-primary');
        tabViewBtn.classList.remove('btn-outline-primary');
        tabViewBtn.classList.add('btn-primary');
    }
}

// ======================
// AUTO-REFRESH FUNCTIONS
// ======================

function setAutoRefresh(minutes) {
    // Clear existing interval
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    
    autoRefreshMinutes = minutes;
    localStorage.setItem(CACHE_KEYS.AUTO_REFRESH, minutes.toString());
    
    const refreshStatusText = document.getElementById('refreshStatusText');
    
    if (minutes === 0) {
        refreshStatusText.textContent = 'Manual';
    } else {
        const text = minutes < 60 ? `${minutes}m` : 
                     minutes === 60 ? '1h' :
                     minutes === 720 ? '12h' :
                     minutes === 1440 ? '24h' : `${minutes}m`;
        refreshStatusText.textContent = text;
        
        // Set up interval
        autoRefreshInterval = setInterval(() => {
            if (currentViewMode === 'tabs') {
                refreshCurrentFeed();
            } else {
                refreshAllColumns();
            }
        }, minutes * 60 * 1000);
    }
    
    showSuccess(`Auto-refresh set to ${minutes === 0 ? 'manual' : formatRefreshInterval(minutes)}`);
}

function setColumnAutoRefresh(sourceType, minutes) {
    // Clear existing interval for this column
    if (columnAutoRefreshIntervals[sourceType]) {
        clearInterval(columnAutoRefreshIntervals[sourceType]);
        delete columnAutoRefreshIntervals[sourceType];
    }
    
    const settings = JSON.parse(localStorage.getItem(CACHE_KEYS.COLUMN_REFRESH) || '{}');
    settings[sourceType] = minutes;
    localStorage.setItem(CACHE_KEYS.COLUMN_REFRESH, JSON.stringify(settings));
    
    if (minutes > 0) {
        columnAutoRefreshIntervals[sourceType] = setInterval(() => {
            refreshColumn(sourceType);
        }, minutes * 60 * 1000);
        
        showSuccess(`${sourceType} column will refresh every ${formatRefreshInterval(minutes)}`);
    } else {
        showSuccess(`${sourceType} column auto-refresh disabled`);
    }
    
    // Update column refresh status display
    updateColumnRefreshStatus(sourceType, minutes);
}

function updateColumnRefreshStatus(sourceType, minutes) {
    const statusMap = {
        'bluesky': 'blueSkyRefreshStatus',
        'arxiv': 'arXivRefreshStatus', 
        'thenewsapi': 'newsRefreshStatus'
    };
    
    const statusElement = document.getElementById(statusMap[sourceType]);
    if (statusElement) {
        if (minutes === 0) {
            statusElement.textContent = 'Manual';
        } else if (minutes < 60) {
            statusElement.textContent = `${minutes}m`;
        } else if (minutes === 60) {
            statusElement.textContent = '1h';
        } else {
            statusElement.textContent = `${Math.floor(minutes / 60)}h`;
        }
    }
}

// Initialize column refresh statuses on page load
function initializeColumnRefreshStatuses() {
    const settings = JSON.parse(localStorage.getItem(CACHE_KEYS.COLUMN_REFRESH) || '{}');
    
    // Update status displays
    ['bluesky', 'arxiv', 'thenewsapi'].forEach(sourceType => {
        const minutes = settings[sourceType] || 0;
        updateColumnRefreshStatus(sourceType, minutes);
        
        // Set up intervals if needed
        if (minutes > 0) {
            columnAutoRefreshIntervals[sourceType] = setInterval(() => {
                refreshColumn(sourceType);
            }, minutes * 60 * 1000);
        }
    });
}

function formatRefreshInterval(minutes) {
    if (minutes < 60) return `${minutes} minutes`;
    if (minutes === 60) return '1 hour';
    if (minutes === 720) return '12 hours';
    if (minutes === 1440) return '24 hours';
    return `${Math.floor(minutes / 60)} hours`;
}

function refreshAllColumns() {
    refreshColumn('bluesky');
    refreshColumn('arxiv');
    refreshColumn('thenewsapi');
}

// ======================
// COLUMN VIEW FUNCTIONS
// ======================

async function loadColumnView() {
    try {
        // Reset pagination state for all columns
        columnOffsets = { bluesky: 0, arxiv: 0, thenewsapi: 0 };
        columnHasMore = { bluesky: true, arxiv: true, thenewsapi: true };
        columnItems = { bluesky: [], arxiv: [], thenewsapi: [] };
        
        // Load initial batch for each source type separately
        await Promise.all([
            loadColumnItems('bluesky'),
            loadColumnItems('arxiv'),  
            loadColumnItems('thenewsapi')
        ]);
        
        // Set up infinite scroll for columns after initial load
        setupColumnInfiniteScroll();
    } catch (error) {
        console.error('Error loading column view:', error);
        showError('Failed to load column view');
    }
}

async function loadColumnItems(sourceType, append = false) {
    if (columnLoading[sourceType]) return; // Prevent concurrent loads
    
    try {
        columnLoading[sourceType] = true;
        
        const limit = COLUMN_BATCH_SIZE;
        const offset = append ? columnOffsets[sourceType] : 0;
        const response = await fetch(`/api/unified-feed?source_types=${sourceType}&limit=${limit}&offset=${offset}`);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        const newItems = data.items || [];
        
        if (append) {
            columnItems[sourceType] = [...columnItems[sourceType], ...newItems];
        } else {
            columnItems[sourceType] = newItems;
            columnOffsets[sourceType] = 0;
        }
        
        // Update pagination state
        columnOffsets[sourceType] += newItems.length;
        columnHasMore[sourceType] = data.has_more && newItems.length > 0;
        
        // Apply media bias enrichment for news items
        if (sourceType === 'thenewsapi') {
            await enrichNewsWithMediaBias(newItems);
        }
        
        renderColumnItems(sourceType);
        updateColumnCount(sourceType);
        
    } catch (error) {
        console.error(`Error loading ${sourceType} items:`, error);
        const contentDiv = document.getElementById(`${getColumnId(sourceType)}Content`);
        if (!append) {
            contentDiv.innerHTML = `<div class="text-center p-4" style="color: var(--colors-error-9); font-weight: 500;">Failed to load ${sourceType} items</div>`;
        } else {
            showError(`Failed to load more ${sourceType} items`);
        }
    } finally {
        columnLoading[sourceType] = false;
    }
}

async function loadMoreColumnItems(sourceType) {
    if (!columnHasMore[sourceType] || columnLoading[sourceType]) {
        return;
    }

    // Show loading indicator at bottom of column
    const contentDiv = document.getElementById(`${getColumnId(sourceType)}Content`);
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'column-loading';
    loadingDiv.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm me-2"></div>
            Loading more...
        </div>
    `;
    contentDiv.appendChild(loadingDiv);

    try {
        await loadColumnItems(sourceType, true);
    } finally {
        // Remove loading indicator
        const loader = contentDiv.querySelector('.column-loading');
        if (loader) {
            loader.remove();
        }
    }
}

function getColumnId(sourceType) {
    const mapping = {
        'bluesky': 'blueSky',
        'arxiv': 'arXiv',
        'thenewsapi': 'news'
    };
    return mapping[sourceType] || sourceType;
}

function renderColumnItems(sourceType) {
    const items = columnItems[sourceType] || [];
    const contentDiv = document.getElementById(`${getColumnId(sourceType)}Content`);
    
    if (items.length === 0 && !columnLoading[sourceType]) {
        contentDiv.innerHTML = `<div class="text-center p-4" style="color: var(--dark-gray);">No ${sourceType} items found</div>`;
        return;
    }
    
    let html = items.map(item => renderColumnItem(item, sourceType)).join('');
    
    // Add "Load More" indicator if there are more items available
    if (columnHasMore[sourceType] && !columnLoading[sourceType]) {
        html += `
            <div class="text-center py-3">
                <button class="btn btn-outline-secondary btn-sm" onclick="loadMoreColumnItems('${sourceType}')" id="loadMore${getColumnId(sourceType)}">
                    <i class="fas fa-chevron-down me-1"></i>
                    Load More ${sourceType} Items
                </button>
            </div>
        `;
    } else if (!columnHasMore[sourceType] && items.length > 0) {
        html += `
            <div class="text-center py-3" style="color: var(--dark-gray);">
                <small><i class="fas fa-check-circle me-1"></i>All ${sourceType} items loaded</small>
            </div>
        `;
    }
    
    contentDiv.innerHTML = html;
    
    // Clear column selections when re-rendering
    columnSelectedItems[sourceType] = [];
    updateColumnSelectedCount(sourceType);
}

function renderColumnItem(item, sourceType) {
    const publishDate = item.publication_date ? 
        new Date(item.publication_date).toLocaleDateString() : 
        'No date';
    
    // Get media bias display for news items
    let mediaBiasHtml = '';
    if (sourceType === 'thenewsapi' && item.media_bias) {
        mediaBiasHtml = createMediaBiasDisplay(item.media_bias);
    }
    
    // Get tags display
    const tagsHtml = (item.tags || []).length > 0 ? `
        <div class="article-tags">
            ${item.tags.slice(0, 3).map(tag => `<span class="article-tag">${tag}</span>`).join('')}
            ${item.tags.length > 3 ? `<span class="article-tag">+${item.tags.length - 3}</span>` : ''}
        </div>
    ` : '';
    
    return `
        <div class="column-item ${item.is_starred ? 'starred' : ''}" data-item-id="${item.id}">
            <div class="column-item-checkbox">
                <input type="checkbox" class="column-checkbox" data-item-id="${item.id}" data-source-type="${sourceType}" onchange="updateColumnSelectedCount('${sourceType}')">
            </div>
            <div class="column-item-actions">
                ${(item.category || item.sentiment || item.future_signal || item.time_to_impact || item.driver_type) ? `
                <div class="enrichment-indicator" title="Article has been AI-enriched" style="position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background: var(--colors-success-9); border-radius: 50%; border: 2px solid white;">
                    <i class="fas fa-brain" style="font-size: 6px; color: white; position: absolute; top: 1px; left: 1px;"></i>
                </div>` : ''}
                <button class="column-action-btn ${item.is_starred ? 'starred' : ''}" 
                        onclick="toggleColumnStar(${item.id}, ${!item.is_starred})" 
                        title="${item.is_starred ? 'Unstar' : 'Star'}">
                    <i class="fas fa-star"></i>
                </button>
                <button class="column-action-btn" onclick="showTagInput(${item.id})" title="Tag article">
                    <i class="fas fa-tag"></i>
                </button>
                <button class="column-action-btn" onclick="hideColumnItem(${item.id})" title="Hide">
                    <i class="fas fa-eye-slash"></i>
                </button>
            </div>
            
            <div class="column-item-title">
                <a href="${item.url}" target="_blank">${item.title}</a>
            </div>
            
            <div class="column-item-meta">
                ${item.author ? `<span><i class="fas fa-user"></i> ${item.author}</span>` : ''}
                <span><i class="fas fa-calendar"></i> ${publishDate}</span>
                ${getEngagementDisplay(item.engagement_metrics)}
            </div>
            
            ${item.content ? `<div class="column-item-content">${sourceType === 'bluesky' ? item.content : truncateText(item.content, 120)}</div>` : ''}
            
            ${mediaBiasHtml}
            
            <!-- Enrichment Status Indicators -->
            ${(item.category || item.sentiment || item.future_signal || item.time_to_impact || item.driver_type) ? `
            <div class="enrichment-badges" style="display: flex; flex-wrap: wrap; gap: 4px; margin: 8px 0;">
                ${item.category ? `<span class="badge bg-info" style="font-size: 0.7rem; padding: 2px 6px;"><i class="fas fa-tag me-1"></i>${item.category}</span>` : ''}
                ${item.sentiment ? `<span class="badge bg-secondary" style="font-size: 0.7rem; padding: 2px 6px;"><i class="fas fa-smile me-1"></i>${item.sentiment}</span>` : ''}
                ${item.future_signal ? `<span class="badge bg-warning text-dark" style="font-size: 0.7rem; padding: 2px 6px;"><i class="fas fa-chart-line me-1"></i>${item.future_signal}</span>` : ''}
                ${item.time_to_impact ? `<span class="badge bg-success" style="font-size: 0.7rem; padding: 2px 6px;"><i class="fas fa-clock me-1"></i>${item.time_to_impact}</span>` : ''}
                ${item.driver_type ? `<span class="badge bg-dark" style="font-size: 0.7rem; padding: 2px 6px;"><i class="fas fa-cogs me-1"></i>${item.driver_type}</span>` : ''}
            </div>` : ''}
            
            ${tagsHtml}
            
            <div class="tag-input" id="tagInput${item.id}">
                <input type="text" placeholder="Add tags (comma separated)" onkeypress="handleTagInput(event, ${item.id})">
            </div>
            
            <!-- Hover Details -->
            <div class="article-hover-details">
                <h6>üìñ Full Article Details</h6>
                <div class="meta-item"><strong>Source:</strong> ${item.source_type.toUpperCase()}</div>
                ${item.author ? `<div class="meta-item"><strong>Author:</strong> ${item.author}${item.author_handle ? ` (${item.author_handle})` : ''}</div>` : ''}
                <div class="meta-item"><strong>Published:</strong> ${publishDate}</div>
                ${item.url ? `<div class="meta-item"><strong>URL:</strong> <a href="${item.url}" target="_blank" style="color: var(--primary-color); word-break: break-all;">${item.url}</a></div>` : ''}
                
                ${item.content ? `
                <div style="margin: 12px 0;">
                    <strong style="color: var(--primary-color);">Full Content:</strong>
                    <div class="content-preview">${item.content}</div>
                </div>` : ''}
                
                ${(item.category || item.sentiment || item.future_signal || item.time_to_impact || item.driver_type) ? `
                <div style="margin-top: 12px;">
                    <strong style="color: var(--primary-color);">AI Analysis:</strong>
                    <div style="margin-top: 6px;">
                        ${item.category ? `<div class="meta-item">Category: ${item.category}</div>` : ''}
                        ${item.sentiment ? `<div class="meta-item">Sentiment: ${item.sentiment}</div>` : ''}
                        ${item.future_signal ? `<div class="meta-item">Future Signal: ${item.future_signal}</div>` : ''}
                        ${item.time_to_impact ? `<div class="meta-item">Time to Impact: ${item.time_to_impact}</div>` : ''}
                        ${item.driver_type ? `<div class="meta-item">Driver Type: ${item.driver_type}</div>` : ''}
                    </div>
                </div>` : ''}
                
                ${item.engagement_metrics && Object.keys(item.engagement_metrics).length > 0 ? `
                <div style="margin-top: 12px;">
                    <strong style="color: var(--primary-color);">Engagement:</strong>
                    <div style="margin-top: 6px;">
                        ${item.engagement_metrics.likes ? `<div class="meta-item">‚ù§Ô∏è Likes: ${item.engagement_metrics.likes}</div>` : ''}
                        ${item.engagement_metrics.reposts ? `<div class="meta-item">üîÑ Reposts: ${item.engagement_metrics.reposts}</div>` : ''}
                        ${item.engagement_metrics.replies ? `<div class="meta-item">üí¨ Replies: ${item.engagement_metrics.replies}</div>` : ''}
                    </div>
                </div>` : ''}
            </div>
        </div>
    `;
}

function getEngagementDisplay(engagement) {
    if (!engagement) return '';
    
    const total = (engagement.likes || 0) + (engagement.reposts || 0) + (engagement.replies || 0);
    return total > 0 ? `<span><i class="fas fa-heart"></i> ${total}</span>` : '';
}

async function toggleColumnStar(itemId, starred) {
    try {
        const response = await fetch(`/api/feed-items/${itemId}/star`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(starred)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // Update local state in all relevant arrays
        [feedItems, allFeedItems, ...Object.values(columnItems)].forEach(items => {
            const item = items.find(item => item.id === itemId);
            if (item) item.is_starred = starred;
        });
        
        // Re-render affected columns
        for (const [sourceType, items] of Object.entries(columnItems)) {
            if (items.find(item => item.id === itemId)) {
                renderColumnItems(sourceType);
                break;
            }
        }
        
        // Update starred count
        await loadStarredCount();
        
    } catch (error) {
        console.error('Error toggling star:', error);
        showError('Failed to update star status');
    }
}

async function hideColumnItem(itemId) {
    try {
        const response = await fetch(`/api/feed-items/${itemId}/hide`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // Remove from column display
        for (const [sourceType, items] of Object.entries(columnItems)) {
            const index = items.findIndex(item => item.id === itemId);
            if (index !== -1) {
                items.splice(index, 1);
                renderColumnItems(sourceType);
                updateColumnCount(sourceType);
                break;
            }
        }
        
        showSuccess('Item hidden');
        
    } catch (error) {
        console.error('Error hiding item:', error);
        showError('Failed to hide item');
    }
}

function updateColumnCount(sourceType) {
    const count = columnItems[sourceType]?.length || 0;
    const countElement = document.getElementById(`${getColumnId(sourceType)}Count`);
    if (countElement) {
        countElement.textContent = count;
    }
}

// Column Selection and Bulk Actions
function updateColumnSelectedCount(sourceType) {
    const checkboxes = document.querySelectorAll(`.column-checkbox[data-source-type="${sourceType}"]:checked`);
    const selectedCount = checkboxes.length;
    
    // Update selected items array
    columnSelectedItems[sourceType] = Array.from(checkboxes).map(cb => {
        const itemId = parseInt(cb.dataset.itemId);
        return columnItems[sourceType].find(item => item.id === itemId);
    }).filter(item => item);
    
    // Show/hide bulk actions
    const bulkActions = document.getElementById(`${getColumnId(sourceType)}BulkActions`);
    const selectedCountElement = document.getElementById(`${getColumnId(sourceType)}SelectedCount`);
    
    if (selectedCount > 0) {
        bulkActions.style.display = 'flex';
        selectedCountElement.style.display = 'inline';
        selectedCountElement.textContent = `${selectedCount} selected`;
        
        // Add selected class to items
        document.querySelectorAll(`.column-checkbox[data-source-type="${sourceType}"]`).forEach(cb => {
            const item = cb.closest('.column-item');
            if (cb.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    } else {
        bulkActions.style.display = 'none';
        selectedCountElement.style.display = 'none';
        
        // Remove selected class from all items in this column
        document.querySelectorAll(`#${getColumnId(sourceType)}Content .column-item`).forEach(item => {
            item.classList.remove('selected');
        });
    }
}

function toggleColumnSelectAll(sourceType) {
    const checkboxes = document.querySelectorAll(`.column-checkbox[data-source-type="${sourceType}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });
    
    updateColumnSelectedCount(sourceType);
}

async function enrichColumnSelected(sourceType) {
    const selectedItems = columnSelectedItems[sourceType];
    if (selectedItems.length === 0) {
        showError('Please select items to enrich');
        return;
    }
    
    // Set selectedArticles for the enrichment modal
    selectedArticles = selectedItems;
    
    // Open enrichment modal
    await openEnrichmentModal();
}

async function sendColumnSelectedToAuspex(sourceType) {
    const selectedItems = columnSelectedItems[sourceType];
    if (selectedItems.length === 0) {
        showError('Please select items to send to Auspex');
        return;
    }
    
    try {
        // Create comprehensive analysis data
        const totalItems = selectedItems.length;
        const sourceBreakdown = {};
        const authorBreakdown = {};
        const contentThemes = [];
        
        selectedItems.forEach(item => {
            // Source breakdown
            const source = item.source_type || 'unknown';
            sourceBreakdown[source] = (sourceBreakdown[source] || 0) + 1;
            
            // Author breakdown
            if (item.author) {
                authorBreakdown[item.author] = (authorBreakdown[item.author] || 0) + 1;
            }
            
            // Content themes (extract keywords from titles)
            if (item.title) {
                const words = item.title.toLowerCase().split(/\s+/).filter(word => word.length > 4);
                contentThemes.push(...words);
            }
        });
        
        // Get top themes
        const themeCount = {};
        contentThemes.forEach(theme => {
            themeCount[theme] = (themeCount[theme] || 0) + 1;
        });
        const topThemes = Object.entries(themeCount)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5)
            .map(([theme, count]) => `${theme} (${count})`);
        
        // Create summary
        const summary = `Analysis of ${totalItems} selected ${sourceType} items:\n\n` +
            `Source Breakdown:\n${Object.entries(sourceBreakdown).map(([source, count]) => `‚Ä¢ ${source}: ${count} items`).join('\n')}\n\n` +
            `${Object.keys(authorBreakdown).length > 0 ? `Top Authors:\n${Object.entries(authorBreakdown).sort(([,a], [,b]) => b - a).slice(0, 5).map(([author, count]) => `‚Ä¢ ${author}: ${count} articles`).join('\n')}\n\n` : ''}` +
            `Content Themes:\n${topThemes.length > 0 ? topThemes.map(theme => `‚Ä¢ ${theme}`).join('\n') : 'No common themes identified'}\n\n` +
            `Selected Items:\n${selectedItems.map((item, idx) => `${idx + 1}. ${escapeHtml(item.title)} (${item.source_type})`).join('\n')}`;
        
        // Send to Auspex
        const response = await fetch('/auspex/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: summary,
                context: 'feed_analysis'
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        showSuccess(`Successfully sent ${totalItems} selected ${sourceType} items to Auspex for analysis`);
        
        // Clear selection
        document.querySelectorAll(`.column-checkbox[data-source-type="${sourceType}"]`).forEach(cb => {
            cb.checked = false;
        });
        updateColumnSelectedCount(sourceType);
        
    } catch (error) {
        console.error('Error sending to Auspex:', error);
        showError('Failed to send selected items to Auspex');
    }
}

async function hideColumnSelected(sourceType) {
    const selectedItems = columnSelectedItems[sourceType];
    if (selectedItems.length === 0) {
        showError('Please select items to hide');
        return;
    }
    
    if (!confirm(`Hide ${selectedItems.length} selected items?`)) return;
    
    try {
        const hidePromises = selectedItems.map(item => 
            fetch(`/api/feed-items/${item.id}/hide`, { method: 'POST' })
        );
        
        await Promise.all(hidePromises);
        
        // Remove from column display
        selectedItems.forEach(item => {
            const index = columnItems[sourceType].findIndex(i => i.id === item.id);
            if (index !== -1) {
                columnItems[sourceType].splice(index, 1);
            }
        });
        
        renderColumnItems(sourceType);
        updateColumnCount(sourceType);
        updateColumnSelectedCount(sourceType);
        
        showSuccess(`Hidden ${selectedItems.length} items`);
        
    } catch (error) {
        console.error('Error hiding items:', error);
        showError('Failed to hide selected items');
    }
}

async function deleteColumnSelected(sourceType) {
    const selectedItems = columnSelectedItems[sourceType];
    if (selectedItems.length === 0) {
        showError('Please select items to delete');
        return;
    }
    
    if (!confirm(`Permanently delete ${selectedItems.length} selected items? This cannot be undone.`)) return;
    
    try {
        const deletePromises = selectedItems.map(item => 
            fetch(`/api/feed-items/${item.id}`, { method: 'DELETE' })
        );
        
        await Promise.all(deletePromises);
        
        // Remove from column display
        selectedItems.forEach(item => {
            const index = columnItems[sourceType].findIndex(i => i.id === item.id);
            if (index !== -1) {
                columnItems[sourceType].splice(index, 1);
            }
        });
        
        renderColumnItems(sourceType);
        updateColumnCount(sourceType);
        updateColumnSelectedCount(sourceType);
        
        showSuccess(`Deleted ${selectedItems.length} items`);
        
    } catch (error) {
        console.error('Error deleting items:', error);
        showError('Failed to delete selected items');
    }
}

function getColumnId(sourceType) {
    const mapping = {
        'bluesky': 'blueSky',
        'arxiv': 'arXiv', 
        'thenewsapi': 'news'
    };
    return mapping[sourceType] || sourceType;
}

function setupColumnInfiniteScroll() {
    const sourceTypes = ['bluesky', 'arxiv', 'thenewsapi'];
    
    sourceTypes.forEach(sourceType => {
        const columnId = getColumnId(sourceType);
        const contentDiv = document.getElementById(`${columnId}Content`);
        
        if (!contentDiv) return;
        
        // Remove existing listeners
        contentDiv.removeEventListener('scroll', contentDiv._scrollHandler);
        
        // Create scroll handler
        const scrollHandler = debounce(() => {
            const scrollTop = contentDiv.scrollTop;
            const scrollHeight = contentDiv.scrollHeight;
            const clientHeight = contentDiv.clientHeight;
            
            // Check if user scrolled to near bottom (within 150px)
            const nearBottom = scrollTop + clientHeight >= scrollHeight - 150;
            
            if (nearBottom && columnHasMore[sourceType] && !columnLoading[sourceType]) {
                loadMoreColumnItems(sourceType);
            }
        }, 100);
        
        // Store handler reference for cleanup
        contentDiv._scrollHandler = scrollHandler;
        
        // Add scroll listener
        contentDiv.addEventListener('scroll', scrollHandler);
    });
}

// Debounce utility function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function refreshColumn(sourceType) {
    const contentDiv = document.getElementById(`${getColumnId(sourceType)}Content`);
    contentDiv.innerHTML = '<div class="text-center p-4" style="color: var(--dark-gray);"><div class="spinner-border spinner-border-sm me-2"></div>Refreshing...</div>';
    
    try {
        // Reset pagination state
        columnOffsets[sourceType] = 0;
        columnHasMore[sourceType] = true;
        columnItems[sourceType] = [];
        
        await loadColumnItems(sourceType);
        showSuccess(`${sourceType} column refreshed`);
    } catch (error) {
        console.error(`Error refreshing ${sourceType}:`, error);
        showError(`Failed to refresh ${sourceType} column`);
    }
}

async function collectColumn(sourceType) {
    try {
        const response = await fetch(`/api/feed-collection/collect?source_type=${sourceType}&max_items=20`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        showSuccess(`Collected ${result.items_collected || 0} new ${sourceType} items`);
        
        // Refresh the column
        await refreshColumn(sourceType);
        
    } catch (error) {
        console.error(`Error collecting ${sourceType}:`, error);
        showError(`Failed to collect ${sourceType} items`);
    }
}

// ======================
// MEDIA BIAS FUNCTIONS
// ======================

async function enrichNewsWithMediaBias(newsItems) {
    if (!newsItems || newsItems.length === 0) return;
    
    try {
        // Get media bias data for news sources
        const sources = [...new Set(newsItems.map(item => extractDomain(item.url)).filter(Boolean))];
        
        for (const source of sources) {
            if (!mediabiasCache[source]) {
                try {
                    const response = await fetch(`/api/media_bias?source=${encodeURIComponent(source)}`);
                    if (response.ok) {
                        const data = await response.json();
                        mediabiasCache[source] = data.data;
                    }
                } catch (error) {
                    // Silently skip media bias for sources that don't have data
                    console.debug(`No media bias data available for ${source}`);
                }
            }
        }
        
        // Apply media bias data to items
        newsItems.forEach(item => {
            const domain = extractDomain(item.url);
            if (domain && mediabiasCache[domain]) {
                item.media_bias = mediabiasCache[domain];
            }
        });
        
    } catch (error) {
        console.error('Error enriching with media bias:', error);
    }
}

function extractDomain(url) {
    try {
        const domain = new URL(url).hostname.replace('www.', '');
        return domain;
    } catch {
        return null;
    }
}

function createMediaBiasDisplay(biasData) {
    if (!biasData) return '';
    
    let html = '<div class="d-flex flex-wrap gap-1 mt-1">';
    
    if (biasData.bias) {
        const biasClass = getBiasClass(biasData.bias);
        html += `<span class="bias-badge ${biasClass}" title="Media Bias: ${biasData.bias}">${biasData.bias}</span>`;
    }
    
    if (biasData.factual_reporting) {
        const factualClass = getFactualClass(biasData.factual_reporting);
        html += `<span class="bias-badge ${factualClass}" title="Factual Reporting: ${biasData.factual_reporting}">${biasData.factual_reporting}</span>`;
    }
    
    html += '</div>';
    return html;
}

function getBiasClass(bias) {
    if (!bias) return '';
    const normalized = bias.toLowerCase().replace(/[^a-z]/g, '-');
    return `bias-${normalized}`;
}

function getFactualClass(factual) {
    if (!factual) return '';
    const normalized = factual.toLowerCase().replace(/[^a-z]/g, '-');
    return `factual-${normalized}`;
}

// ======================
// TAGGING FUNCTIONS
// ======================

function showTagInput(itemId) {
    const tagInput = document.getElementById(`tagInput${itemId}`);
    if (tagInput) {
        tagInput.style.display = tagInput.style.display === 'none' ? 'block' : 'none';
        if (tagInput.style.display === 'block') {
            tagInput.querySelector('input').focus();
        }
    }
}

async function handleTagInput(event, itemId) {
    if (event.key === 'Enter') {
        const input = event.target;
        const tags = input.value.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
        
        if (tags.length > 0) {
            await addTagsToItem(itemId, tags);
            input.value = '';
            document.getElementById(`tagInput${itemId}`).style.display = 'none';
        }
    }
}

async function addTagsToItem(itemId, tags) {
    try {
        const response = await fetch(`/api/feed-items/${itemId}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tags })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // Update local state
        [feedItems, allFeedItems, ...Object.values(columnItems)].forEach(items => {
            const item = items.find(item => item.id === itemId);
            if (item) {
                item.tags = [...(item.tags || []), ...tags];
            }
        });
        
        // Re-render affected views
        if (currentViewMode === 'columns') {
            for (const [sourceType, items] of Object.entries(columnItems)) {
                if (items.find(item => item.id === itemId)) {
                    renderColumnItems(sourceType);
                    break;
                }
            }
        } else {
            renderFeedItems();
        }
        
        showSuccess(`Added tags: ${tags.join(', ')}`);
        
    } catch (error) {
        console.error('Error adding tags:', error);
        showError('Failed to add tags');
    }
}

// New action functions
async function enrichStarredItems() {
    const starredItems = feedItems.filter(item => item.is_starred);
    
    if (starredItems.length === 0) {
        showError('No starred items found to enrich.');
        return;
    }
    
    if (confirm(`Are you sure you want to enrich ${starredItems.length} starred items?`)) {
        try {
            showInfo(`Starting enrichment of ${starredItems.length} starred items...`);
            
            // Use the existing enrichment functionality
            const selectedItemIds = starredItems.map(item => item.id);
            setSelectedItems(selectedItemIds);
            enrichSelectedArticles();
            
        } catch (error) {
            console.error('Error enriching starred items:', error);
            showError('Failed to enrich starred items: ' + error.message);
        }
    }
}

async function sendStarredToAuspex() {
    const starredItems = feedItems.filter(item => item.is_starred);
    
    if (starredItems.length === 0) {
        showError('No starred items found to send to Auspex.');
        return;
    }
    
    if (starredItems.length > 100) {
        showError('Too many starred items. Please limit to 100 items for Auspex analysis.');
        return;
    }
    
    try {
        showInfo(`Analyzing ${starredItems.length} starred items...`);
        
        // Since feed items may not be in the vector database yet,
        // create a comprehensive summary using available data
        const simpleSummary = createDetailedSummary(starredItems, 'Starred');
        showAuspexResults(simpleSummary, starredItems, 'Starred');
        
        // Optional: Try vector analysis in the background for enhanced results
        tryVectorAnalysis(starredItems);
        
    } catch (error) {
        console.error('Error analyzing starred items:', error);
        showError('Failed to analyze starred items: ' + error.message);
    }
}

async function sendSelectedToAuspex() {
    const selectedItems = getSelectedItems();
    
    if (selectedItems.length === 0) {
        showError('No items selected to send to Auspex.');
        return;
    }
    
    if (selectedItems.length > 100) {
        showError('Too many selected items. Please limit to 100 items for Auspex analysis.');
        return;
    }
    
    try {
        showInfo(`Analyzing ${selectedItems.length} selected items...`);
        
        // Since feed items may not be in the vector database yet,
        // create a comprehensive summary using available data
        const simpleSummary = createDetailedSummary(selectedItems, 'Selected');
        showAuspexResults(simpleSummary, selectedItems, 'Selected');
        
        // Optional: Try vector analysis in the background for enhanced results
        tryVectorAnalysis(selectedItems);
        
    } catch (error) {
        console.error('Error analyzing selected items:', error);
        showError('Failed to analyze selected items: ' + error.message);
    }
}

// Try vector analysis in the background (non-blocking)
async function tryVectorAnalysis(starredItems) {
    try {
        // Use URLs as potential vector IDs
        const itemIds = starredItems.map(item => item.url);
        
        const response = await fetch('/api/vector-summary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ids: itemIds,
                model: null
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.response) {
                // Update the modal with enhanced AI analysis
                const enhancedSummary = `${createDetailedSummary(starredItems)}

---

## ü§ñ Enhanced AI Analysis

${result.response}

*This enhanced analysis was generated using the vector database and AI analysis.*`;
                updateAuspexResults(enhancedSummary);
                showSuccess('Enhanced AI analysis completed!');
            }
        }
    } catch (error) {
        console.log('Vector analysis not available:', error.message);
        // This is okay - we already showed a basic summary
    }
}

// Helper function to create a detailed summary of items
function createDetailedSummary(items, type = 'Articles') {
    const sources = [...new Set(items.map(item => item.source_type))];
    const totalItems = items.length;
    const sourceBreakdown = sources.map(source => {
        const count = items.filter(item => item.source_type === source).length;
        const percentage = Math.round((count / totalItems) * 100);
        return `**${source.toUpperCase()}**: ${count} items (${percentage}%)`;
    }).join('\n');
    
    // Get date range
    const dates = items.map(item => new Date(item.publication_date || item.created_at)).filter(d => !isNaN(d));
    const latestDate = dates.length > 0 ? new Date(Math.max(...dates)).toLocaleDateString() : 'Unknown';
    const oldestDate = dates.length > 0 ? new Date(Math.min(...dates)).toLocaleDateString() : 'Unknown';
    
    // Top articles by engagement
    const topEngaged = items
        .map(item => ({
            ...item,
            totalEngagement: Object.values(item.engagement_metrics || {}).reduce((sum, val) => sum + (val || 0), 0)
        }))
        .sort((a, b) => b.totalEngagement - a.totalEngagement)
        .slice(0, 5);
    
    // Authors breakdown
    const authors = items.filter(item => item.author).map(item => item.author);
    const authorCounts = authors.reduce((acc, author) => {
        acc[author] = (acc[author] || 0) + 1;
        return acc;
    }, {});
    const topAuthors = Object.entries(authorCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5)
        .map(([author, count]) => `‚Ä¢ ${author} (${count} articles)`)
        .join('\n');
    
    // Tags analysis
    const allTags = items.flatMap(item => item.tags || []);
    const tagCounts = allTags.reduce((acc, tag) => {
        acc[tag] = (acc[tag] || 0) + 1;
        return acc;
    }, {});
    const topTags = Object.entries(tagCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 8)
        .map(([tag, count]) => `#${tag} (${count})`)
        .join(', ');
    
    return `# üìä ${type} Items Analysis

## üìà Overview
- **Total Articles**: ${totalItems}
- **Date Range**: ${oldestDate} ‚Üí ${latestDate}
- **Sources Distribution**:
${sourceBreakdown}

## üî• Top Engaged Articles
${topEngaged.map((item, index) => 
    `${index + 1}. **${item.title}** (${item.source_type.toUpperCase()})
   üìä ${item.totalEngagement} interactions ‚Ä¢ üë§ ${item.author || 'Unknown'}`
).join('\n\n')}

## ‚úçÔ∏è Top Authors
${topAuthors || 'No author data available'}

## üè∑Ô∏è Popular Tags
${topTags || 'No tags available'}

## üìù Content Themes
${items.slice(0, 3).map(item => {
    const preview = item.content ? item.content.substring(0, 150).replace(/\n/g, ' ') + '...' : 'No content preview';
    return `**${item.source_type.toUpperCase()}**: ${item.title}
*"${preview}"*`;
}).join('\n\n')}

---
*Generated from ${totalItems} ${type.toLowerCase()} articles ‚Ä¢ ${new Date().toLocaleString()}*
`;
}

// Function to update the Auspex results modal with new content
function updateAuspexResults(newSummary) {
    const modalBody = document.querySelector('#auspexResultsModal .modal-body');
    if (modalBody) {
        const summaryDiv = modalBody.querySelector('.auspex-summary');
        if (summaryDiv) {
            summaryDiv.innerHTML = newSummary.replace(/\n/g, '<br>');
        }
    }
}

async function deleteSelectedItems() {
    const selectedItems = getSelectedItems();
    
    if (selectedItems.length === 0) {
        showError('No items selected for deletion.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedItems.length} selected items? This action cannot be undone.`)) {
        try {
            showInfo(`Deleting ${selectedItems.length} selected items...`);
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const item of selectedItems) {
                try {
                    // Hide the item immediately for better UX
                    hideItem(item.id);
                    successCount++;
                } catch (error) {
                    console.error(`Error deleting item ${item.id}:`, error);
                    errorCount++;
                }
            }
            
            if (successCount > 0) {
                showSuccess(`Successfully deleted ${successCount} items.`);
                clearSelection();
                applyFilters(); // Refresh the view
            }
            
            if (errorCount > 0) {
                showError(`Failed to delete ${errorCount} items.`);
            }
            
        } catch (error) {
            console.error('Error deleting selected items:', error);
            showError('Failed to delete selected items: ' + error.message);
        }
    }
}

function hideSelectedItems() {
    const selectedItems = getSelectedItems();
    
    if (selectedItems.length === 0) {
        showError('No items selected to hide.');
        return;
    }
    
    if (confirm(`Are you sure you want to hide ${selectedItems.length} selected items?`)) {
        try {
            selectedItems.forEach(item => {
                hideItem(item.id);
            });
            
            showSuccess(`Hidden ${selectedItems.length} items.`);
            clearSelection();
            applyFilters(); // Refresh the view
            
        } catch (error) {
            console.error('Error hiding selected items:', error);
            showError('Failed to hide selected items: ' + error.message);
        }
    }
}

function toggleSelectAll() {
    const allCheckboxes = document.querySelectorAll('.item-checkbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const allSelected = Array.from(allCheckboxes).every(cb => cb.checked);
    
    if (allSelected) {
        // Unselect all
        allCheckboxes.forEach(cb => {
            cb.checked = false;
        });
        selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Select All';
        clearSelection();
    } else {
        // Select all
        allCheckboxes.forEach(cb => {
            cb.checked = true;
        });
        selectAllBtn.innerHTML = '<i class="fas fa-square"></i> Unselect All';
        
        // Add all visible items to selection
        setSelectedItems(feedItems.map(item => item.id.toString()));
    }
    
    updateSelectedCount();
}

// Helper function to get selected items
function getSelectedItems() {
    const selectedIds = [];
    document.querySelectorAll('.item-checkbox:checked').forEach(cb => {
        selectedIds.push(cb.dataset.itemId);
    });
    return feedItems.filter(item => selectedIds.includes(item.id.toString()));
}

// Helper function to set selected items
function setSelectedItems(itemIds) {
    document.querySelectorAll('.item-checkbox').forEach(cb => {
        cb.checked = itemIds.includes(cb.dataset.itemId);
    });
    updateSelectedCount();
}

// Helper function to clear selection
function clearSelection() {
    document.querySelectorAll('.item-checkbox').forEach(cb => {
        cb.checked = false;
    });
    updateSelectedCount();
}

// Global variable to store current analysis data
let currentAnalysisData = null;

// Helper function to show Auspex results
function showAuspexResults(summary, articles, type = 'Articles') {
    // Store articles data globally to avoid encoding issues
    currentAnalysisData = articles;
    
    // Create a modal for Auspex results with proper ID for updates
    const modal = document.createElement('div');
    modal.id = 'auspexResultsModal';
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-brain me-2" style="color: var(--primary-color);"></i>
                        ${type} Articles Analysis
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">üìä Analysis Results (${articles.length} ${type.toLowerCase()} articles)</h6>
                            <span class="badge bg-primary">${articles.length} articles analyzed</span>
                        </div>
                        <div class="auspex-summary p-3 bg-light rounded" style="max-height: 500px; overflow-y: auto; font-family: system-ui, -apple-system, sans-serif; line-height: 1.6;">
                            ${summary.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/#{1,3}\s(.*?)(<br>|$)/g, '<h5 style="color: var(--primary-color); margin-top: 1.5em; margin-bottom: 0.5em;">$1</h5>')}
                        </div>
                    </div>
                    
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">üìö Article List</h6>
                            <small class="text-muted">${articles.length} articles</small>
                        </div>
                        <div style="max-height: 250px; overflow-y: auto;" class="border rounded p-2">
                            ${articles.map((article, index) => `
                                <div class="d-flex align-items-start mb-2 pb-2 ${index < articles.length - 1 ? 'border-bottom' : ''}" style="font-size: 0.9rem;">
                                    <span class="badge bg-secondary me-2 mt-1" style="min-width: 24px;">${index + 1}</span>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">
                                            <a href="${escapeHtml(article.url)}" target="_blank" class="text-decoration-none">${escapeHtml(article.title)}</a>
                                        </div>
                                        <div class="text-muted small">
                                            ${article.source_type.toUpperCase()} ‚Ä¢ ${escapeHtml(article.author || 'Unknown Author')} ‚Ä¢ 
                                            ${new Date(article.publication_date || article.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="exportCurrentAnalysisReport()">
                        <i class="fas fa-download me-1"></i>
                        Export Report
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal when closed
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
        currentAnalysisData = null; // Clean up global data
    });
}

// Export analysis report using the global data
function exportCurrentAnalysisReport() {
    try {
        if (!currentAnalysisData || currentAnalysisData.length === 0) {
            showError('No analysis data available to export');
            return;
        }
        
        const articles = currentAnalysisData;
        
        // Create CSV data - sanitize strings to avoid encoding issues
        const csvData = articles.map(article => ({
            title: sanitizeForCSV(article.title),
            source: article.source_type,
            author: sanitizeForCSV(article.author || ''),
            url: article.url,
            publication_date: article.publication_date || '',
            engagement_total: Object.values(article.engagement_metrics || {}).reduce((sum, val) => sum + (val || 0), 0),
            tags: sanitizeForCSV((article.tags || []).join('; '))
        }));
        
        const csv = convertToCSV(csvData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `articles_analysis_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showSuccess('Analysis report exported successfully!');
    } catch (error) {
        console.error('Error exporting report:', error);
        showError('Failed to export report');
    }
}

// Helper function to escape HTML entities
function escapeHtml(text) {
    if (typeof text !== 'string') return text;
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Helper function to sanitize strings for CSV export
function sanitizeForCSV(text) {
    if (typeof text !== 'string') return text;
    // Remove or replace problematic Unicode characters
    return text
        .replace(/[\u2018\u2019]/g, "'") // Smart quotes to regular quotes
        .replace(/[\u201C\u201D]/g, '"') // Smart quotes to regular quotes
        .replace(/[\u2013\u2014]/g, '-') // Em/en dashes to regular dash
        .replace(/[\u2026]/g, '...') // Ellipsis
        .replace(/[^\x00-\x7F]/g, '?'); // Replace other non-ASCII with ?
}

// === Smart Clustering Functions ===

// Global variables for clustering
let clusteringEnabled = false;
let currentClusteringData = null;
let sentimentChartInstance = null;

// Toggle Smart Clustering view
function toggleSmartClustering() {
    const section = document.getElementById('clusteringSection');
    const btn = document.getElementById('smartClusteringBtn');
    
    if (clusteringEnabled) {
        // Hide clustering
        section.style.display = 'none';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        btn.innerHTML = '<i class="fas fa-brain"></i> Smart Clustering';
        clusteringEnabled = false;
    } else {
        // Show clustering
        section.style.display = 'block';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-success');
        btn.innerHTML = '<i class="fas fa-brain"></i> Hide Clustering';
        clusteringEnabled = true;
        
        // Load initial clustering data
        loadThematicClustering();
    }
}

// Toggle clustering view (from within clustering section)
function toggleClusteringView() {
    toggleSmartClustering();
}

// Refresh all clustering analyses
function refreshClustering() {
    const activeTab = document.querySelector('#clusteringTabs .nav-link.active').id;
    
    switch (activeTab) {
        case 'thematic-clustering-tab':
            loadThematicClustering();
            break;
        case 'sentiment-clustering-tab':
            loadSentimentClustering();
            break;
        case 'temporal-clustering-tab':
            loadTemporalClustering();
            break;
        case 'source-clustering-tab':
            loadSourceClustering();
            break;
    }
}

// Load thematic clustering analysis
async function loadThematicClustering() {
    const container = document.getElementById('thematic-insights-container');
    container.innerHTML = '<div class="loading-indicator w-100 text-center"><i class="fas fa-brain me-2"></i>Analyzing themes and topics...</div>';
    
    try {
        // Get current feed group
        const activeTab = document.querySelector('.feed-tab.active');
        const feedGroupId = activeTab ? activeTab.dataset.groupId : null;
        
        const params = new URLSearchParams();
        if (feedGroupId) params.set('feed_group_id', feedGroupId);
        params.set('limit', '100'); // Analyze more items for better clustering
        
        const response = await fetch(`/api/feed-clustering/thematic?${params.toString()}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        renderThematicClusters(data);
        
    } catch (error) {
        console.error('Error loading thematic clustering:', error);
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">Failed to load thematic analysis. Please try again.</div>';
    }
}

// Render thematic clusters
function renderThematicClusters(clusters) {
    const container = document.getElementById('thematic-insights-container');
    container.innerHTML = '';
    
    if (!clusters || clusters.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No thematic clusters found for current feed items.</div>';
        return;
    }
    
    clusters.forEach((cluster, index) => {
        const card = document.createElement('div');
        card.className = 'insight-item-card thematic-cluster';
        card.id = `cluster-${index}`;
        
        // Source diversity indicators
        const sourceTypes = cluster.source_types || [];
        const sourceBadges = sourceTypes.map(type => {
            const color = type === 'arxiv' ? 'primary' : 
                         type === 'bluesky' ? 'info' : 
                         type === 'thenewsapi' ? 'success' : 'secondary';
            return `<span class="badge bg-${color} me-1">${type.toUpperCase()}</span>`;
        }).join('');
        
        // Article filtering controls
        const filterControls = `
            <div class="cluster-filter-controls mb-2" style="display: none;" id="filter-controls-${index}">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <small class="text-muted">Filter by source:</small>
                    <select class="form-select form-select-sm" style="width: auto;" onchange="filterClusterArticles(${index}, this.value)">
                        <option value="">All sources</option>
                        ${sourceTypes.map(type => `<option value="${type}">${type.toUpperCase()}</option>`).join('')}
                    </select>
                </div>
            </div>
        `;
        
        // Articles list (initially hidden)
        let articlesHtml = `
            <div class="cluster-article-list" id="articles-list-${index}" style="display: none;">
                ${filterControls}
                <div class="cluster-articles-container" id="articles-container-${index}">
        `;
        
        if (cluster.articles && cluster.articles.length > 0) {
            cluster.articles.forEach((article, articleIndex) => {
                const pubDate = article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'N/A';
                const sourceColor = article.source_type === 'arxiv' ? 'primary' : 
                                   article.source_type === 'bluesky' ? 'info' : 
                                   article.source_type === 'thenewsapi' ? 'success' : 'secondary';
                
                articlesHtml += `
                    <div class="cluster-article-item" data-source="${article.source_type}" data-cluster="${index}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <a href="${article.url}" target="_blank" rel="noopener" class="text-decoration-none">
                                    <strong>${article.title || 'Untitled Article'}</strong>
                                </a>
                                <div class="text-muted small mt-1">
                                    <span class="badge bg-${sourceColor} me-2">${article.source_type?.toUpperCase() || 'Unknown'}</span>
                                    <i class="fas fa-calendar me-1"></i>${pubDate}
                                    ${article.author ? `<i class="fas fa-user ms-2 me-1"></i>${article.author}` : ''}
                                </div>
                                ${article.content ? `<p class="small text-muted mt-1 mb-0">${article.content.substring(0, 200)}...</p>` : ''}
                            </div>
                            <div class="article-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="selectSingleArticle(${article.id || articleIndex})" title="Select Article">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
        }
        articlesHtml += '</div></div>';
        
        const stats = `
            <div class="cluster-stats">
                <div class="cluster-stat">
                    <i class="fas fa-file-alt"></i>
                    <span>${cluster.article_count || cluster.articles?.length || 0} articles</span>
                </div>
                <div class="cluster-stat">
                    <i class="fas fa-percentage"></i>
                    <span>${Math.round((cluster.confidence || 0) * 100)}% confidence</span>
                </div>
                <div class="cluster-stat">
                    <i class="fas fa-layer-group"></i>
                    <span>${cluster.source_diversity || 1} sources</span>
                </div>
            </div>
        `;
        
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">${cluster.theme_name || `Theme ${index + 1}`}</h6>
                <div class="d-flex align-items-center gap-2">
                    ${sourceBadges}
                    <span class="badge bg-info">Thematic</span>
                </div>
            </div>
            <p class="mb-2 small">${cluster.theme_summary || cluster.description || 'No summary available for this theme.'}</p>
            ${stats}
            <div class="cluster-actions mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="toggleClusterArticles(${index})">
                    <i class="fas fa-eye"></i> <span id="toggle-text-${index}">Show Articles</span>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="selectAllClusterArticles(${index})">
                    <i class="fas fa-check-square"></i> Select All
                </button>
            </div>
            ${articlesHtml}
        `;
        
        container.appendChild(card);
    });
}

// Load sentiment clustering analysis
async function loadSentimentClustering() {
    const container = document.getElementById('sentiment-insights-container');
    container.innerHTML = '<div class="loading-indicator text-center"><i class="fas fa-chart-line me-2"></i>Analyzing sentiment patterns...</div>';
    
    try {
        const activeTab = document.querySelector('.feed-tab.active');
        const feedGroupId = activeTab ? activeTab.dataset.groupId : null;
        
        const params = new URLSearchParams();
        if (feedGroupId) params.set('feed_group_id', feedGroupId);
        
        const response = await fetch(`/api/feed-clustering/sentiment?${params.toString()}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        renderSentimentClusters(data);
        
    } catch (error) {
        console.error('Error loading sentiment clustering:', error);
        container.innerHTML = '<div class="text-muted p-2 small text-center">Failed to load sentiment analysis. Please try again.</div>';
    }
}

// Render sentiment clusters
function renderSentimentClusters(data) {
    const container = document.getElementById('sentiment-insights-container');
    container.innerHTML = '';
    
    if (!data || !data.clusters) {
        container.innerHTML = '<div class="text-muted p-2 small text-center">No sentiment data available.</div>';
        return;
    }
    
    // Render sentiment clusters
    data.clusters.forEach(cluster => {
        const card = document.createElement('div');
        card.className = 'insight-item-card sentiment-cluster mb-3';
        
        const sentimentColor = cluster.sentiment === 'positive' ? '#2ecc71' : 
                              cluster.sentiment === 'negative' ? '#e74c3c' : '#95a5a6';
        
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0" style="color: ${sentimentColor};">
                    <i class="fas fa-${cluster.sentiment === 'positive' ? 'smile' : cluster.sentiment === 'negative' ? 'frown' : 'meh'}"></i>
                    ${cluster.sentiment.charAt(0).toUpperCase() + cluster.sentiment.slice(1)} Sentiment
                </h6>
                <span class="badge" style="background-color: ${sentimentColor};">${cluster.article_count} articles</span>
            </div>
            <p class="mb-2 small">${cluster.summary || 'Cluster summary not available.'}</p>
            <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar" style="width: ${cluster.percentage}%; background-color: ${sentimentColor};"></div>
            </div>
            <small class="text-muted">${cluster.percentage}% of analyzed content</small>
        `;
        
        container.appendChild(card);
    });
    
    // Update sentiment chart
    updateSentimentChart(data.distribution);
}

// Update sentiment distribution chart
function updateSentimentChart(distribution) {
    const ctx = document.getElementById('sentimentDistributionChart');
    if (!ctx) return;
    
    if (sentimentChartInstance) {
        sentimentChartInstance.destroy();
    }
    
    sentimentChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Positive', 'Negative', 'Neutral'],
            datasets: [{
                data: [
                    distribution.positive || 0,
                    distribution.negative || 0,
                    distribution.neutral || 0
                ],
                backgroundColor: ['#2ecc71', '#e74c3c', '#95a5a6'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        fontSize: 12,
                        padding: 10
                    }
                }
            }
        }
    });
}

// Load temporal clustering analysis
async function loadTemporalClustering() {
    const container = document.getElementById('temporal-insights-container');
    const timeHorizon = document.getElementById('timeHorizonSelect').value;
    const analysisDepth = document.getElementById('analysisDepthSelect').value;
    
    container.innerHTML = '<div class="loading-indicator text-center"><i class="fas fa-clock me-2"></i>Analyzing temporal impact patterns...</div>';
    
    try {
        const activeTab = document.querySelector('.feed-tab.active');
        const feedGroupId = activeTab ? activeTab.dataset.groupId : null;
        
        const params = new URLSearchParams();
        if (feedGroupId) params.set('feed_group_id', feedGroupId);
        params.set('time_horizon', timeHorizon);
        params.set('analysis_depth', analysisDepth);
        
        const response = await fetch(`/api/feed-clustering/temporal?${params.toString()}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        renderTemporalClusters(data);
        
    } catch (error) {
        console.error('Error loading temporal clustering:', error);
        container.innerHTML = '<div class="text-muted p-2 small text-center">Failed to load temporal analysis. Please try again.</div>';
    }
}

// Update temporal clustering when controls change
function updateTemporalClustering() {
    if (clusteringEnabled && document.getElementById('temporal-clustering-tab').classList.contains('active')) {
        loadTemporalClustering();
    }
}

// Render temporal clusters
function renderTemporalClusters(data) {
    const container = document.getElementById('temporal-insights-container');
    container.innerHTML = '';
    
    if (!data || !data.timeline_events) {
        container.innerHTML = '<div class="text-muted p-2 small text-center">No temporal patterns identified.</div>';
        return;
    }
    
    const timeline = document.createElement('div');
    timeline.className = 'temporal-timeline';
    
    data.timeline_events.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = `temporal-event temporal-event-${event.impact_timeframe || 'short'}`;
        
        eventDiv.innerHTML = `
            <div class="temporal-cluster">
                <h6 class="mb-2 text-primary">${event.title || 'Temporal Event'}</h6>
                <p class="mb-2 small">${event.description || 'No description available.'}</p>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-warning">${event.impact_timeframe || 'Unknown'} Impact</span>
                    <span class="text-muted small">${event.article_count || 0} related articles</span>
                </div>
                <div class="small text-muted">
                    <i class="fas fa-bolt me-1"></i>Impact Level: ${event.impact_level || 'Medium'}
                </div>
            </div>
        `;
        
        timeline.appendChild(eventDiv);
    });
    
    container.appendChild(timeline);
}

// Load source clustering analysis
async function loadSourceClustering() {
    const container = document.getElementById('source-insights-container');
    container.innerHTML = '<div class="loading-indicator text-center"><i class="fas fa-layer-group me-2"></i>Analyzing source patterns and authority...</div>';
    
    try {
        const activeTab = document.querySelector('.feed-tab.active');
        const feedGroupId = activeTab ? activeTab.dataset.groupId : null;
        
        const params = new URLSearchParams();
        if (feedGroupId) params.set('feed_group_id', feedGroupId);
        
        const response = await fetch(`/api/feed-clustering/sources?${params.toString()}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        renderSourceClusters(data);
        
    } catch (error) {
        console.error('Error loading source clustering:', error);
        container.innerHTML = '<div class="text-muted p-2 small text-center">Failed to load source analysis. Please try again.</div>';
    }
}

// Render source clusters
function renderSourceClusters(data) {
    const container = document.getElementById('source-insights-container');
    const metricsContainer = document.getElementById('source-metrics-content');
    
    container.innerHTML = '';
    
    if (!data || !data.clusters) {
        container.innerHTML = '<div class="text-muted p-2 small text-center">No source clustering data available.</div>';
        return;
    }
    
    // Render source clusters
    data.clusters.forEach(cluster => {
        const card = document.createElement('div');
        card.className = 'insight-item-card source-cluster mb-3';
        
        const authorityScore = Math.round((cluster.authority_score || 0.5) * 100);
        
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-${cluster.source_type === 'arxiv' ? 'graduation-cap' : cluster.source_type === 'bluesky' ? 'comments' : 'newspaper'}"></i>
                    ${cluster.source_name || cluster.source_type || 'Unknown Source'}
                </h6>
                <span class="badge bg-secondary">${cluster.article_count} articles</span>
            </div>
            <p class="mb-2 small">${cluster.description || 'Source analysis not available.'}</p>
            <div class="mb-2">
                <small class="text-muted">Authority Score</small>
                <div class="source-authority-bar">
                    <div class="source-authority-fill" style="width: ${authorityScore}%;"></div>
                </div>
                <small class="text-muted">${authorityScore}/100</small>
            </div>
            <div class="cluster-stats">
                <div class="cluster-stat">
                    <i class="fas fa-eye"></i>
                    <span>${cluster.avg_engagement || 0} avg views</span>
                </div>
                <div class="cluster-stat">
                    <i class="fas fa-clock"></i>
                    <span>${cluster.recency || 'Unknown'} recency</span>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    // Update source metrics
    if (data.metrics && metricsContainer) {
        metricsContainer.innerHTML = `
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <small>Academic Sources</small>
                    <small>${data.metrics.academic_percentage || 0}%</small>
                </div>
                <div class="progress mb-2" style="height: 4px;">
                    <div class="progress-bar bg-success" style="width: ${data.metrics.academic_percentage || 0}%;"></div>
                </div>
            </div>
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <small>Social Media</small>
                    <small>${data.metrics.social_percentage || 0}%</small>
                </div>
                <div class="progress mb-2" style="height: 4px;">
                    <div class="progress-bar bg-info" style="width: ${data.metrics.social_percentage || 0}%;"></div>
                </div>
            </div>
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <small>News Sources</small>
                    <small>${data.metrics.news_percentage || 0}%</small>
                </div>
                <div class="progress mb-2" style="height: 4px;">
                    <div class="progress-bar bg-warning" style="width: ${data.metrics.news_percentage || 0}%;"></div>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <small class="text-muted">Overall Authority: <strong>${Math.round((data.metrics.overall_authority || 0.5) * 100)}/100</strong></small>
            </div>
        `;
    }
}

// Add event listeners for clustering tabs
document.addEventListener('DOMContentLoaded', function() {
    // Add clustering tab event listeners
    document.getElementById('thematic-clustering-tab').addEventListener('click', function() {
        if (clusteringEnabled) setTimeout(loadThematicClustering, 100);
    });
    
    document.getElementById('sentiment-clustering-tab').addEventListener('click', function() {
        if (clusteringEnabled) setTimeout(loadSentimentClustering, 100);
    });
    
    document.getElementById('temporal-clustering-tab').addEventListener('click', function() {
        if (clusteringEnabled) setTimeout(loadTemporalClustering, 100);
    });
    
    document.getElementById('source-clustering-tab').addEventListener('click', function() {
        if (clusteringEnabled) setTimeout(loadSourceClustering, 100);
    });
});

// Clustering article management functions
function toggleClusterArticles(clusterIndex) {
    const articlesList = document.getElementById(`articles-list-${clusterIndex}`);
    const filterControls = document.getElementById(`filter-controls-${clusterIndex}`);
    const toggleText = document.getElementById(`toggle-text-${clusterIndex}`);
    
    if (articlesList.style.display === 'none') {
        articlesList.style.display = 'block';
        filterControls.style.display = 'block';
        toggleText.textContent = 'Hide Articles';
    } else {
        articlesList.style.display = 'none';
        filterControls.style.display = 'none';
        toggleText.textContent = 'Show Articles';
    }
}

function filterClusterArticles(clusterIndex, sourceType) {
    const container = document.getElementById(`articles-container-${clusterIndex}`);
    const articles = container.querySelectorAll('.cluster-article-item');
    
    articles.forEach(article => {
        const articleSource = article.dataset.source;
        if (!sourceType || articleSource === sourceType) {
            article.style.display = 'block';
        } else {
            article.style.display = 'none';
        }
    });
}

function selectAllClusterArticles(clusterIndex) {
    const container = document.getElementById(`articles-container-${clusterIndex}`);
    const articles = container.querySelectorAll('.cluster-article-item');
    
    articles.forEach(article => {
        if (article.style.display !== 'none') {
            const button = article.querySelector('button');
            if (button) {
                button.click(); // Trigger the select single article function
            }
        }
    });
    
    showSuccess(`Selected visible articles from cluster`);
}

function selectSingleArticle(articleId) {
    // Find the article in the current feed items
    const article = feedItems.find(item => item.id === articleId);
    if (article) {
        // Add to selected articles if not already selected
        if (!selectedArticles.some(selected => selected.id === articleId)) {
            selectedArticles.push(article);
            updateSelectedArticlesDisplay();
            showSuccess(`Added "${article.title}" to selection`);
        } else {
            showInfo('Article already selected');
        }
    }
}

// Multi-Combination Filter Functions
function toggleMultiFilter() {
    const container = document.getElementById('multiFilterContainer');
    const isVisible = container.style.display !== 'none';
    container.style.display = isVisible ? 'none' : 'block';
}

function addCombination() {
    // Disable source and date range filters if this is the first combination
    const isFirstCombination = currentFilters.combinations.length === 0;
    if (isFirstCombination) {
        disableSourceAndDateRangeFilters();
    }

    const sourceSelect = document.getElementById('newSource');
    const dateSelect = document.getElementById('newDate');
    const sourceValue = sourceSelect.value;
    const dateValue = dateSelect.value;
    
    if (!sourceValue || !dateValue) {
        alert('Please select both a source and date range');
        return;
    }
    
    const sourceText = sourceSelect.options[sourceSelect.selectedIndex].text;
    const dateText = dateSelect.options[dateSelect.selectedIndex].text;
    
    // Check if source already exists (regardless of date)
    const existingCombination = currentFilters.combinations.find(combo => 
        combo.source === sourceValue
    );
    
    if (existingCombination) {
        // Update existing combination with new date range
        existingCombination.date = dateValue;
        existingCombination.dateText = dateText;
    } else {
        // Create new combination
        const combination = {
            id: ++combinationCounter,
            source: sourceValue,
            date: dateValue,
            sourceText: sourceText,
            dateText: dateText
        };
        
        currentFilters.combinations.push(combination);
    }
    
    // Reset form
    sourceSelect.value = '';
    dateSelect.value = '';
    
    updateCombinationList();
    applyFilters();
}

function removeCombination(id) {
    currentFilters.combinations = currentFilters.combinations.filter(combo => combo.id !== id);
    if (currentFilters.combinations.length === 0) {
        enableSourceAndDateRangeFilters();
    }
    updateCombinationList();
    applyFilters();
}

function clearAllCombinations() {
    currentFilters.combinations = [];
    enableSourceAndDateRangeFilters();
    updateCombinationList();
    applyFilters();
}

function updateCombinationList() {
    const container = document.getElementById('combinationList');
    const clearAllBtn = document.getElementById('clearAllBtn');
    
    if (currentFilters.combinations.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <p>No filter combinations added yet.<br>Add your first combination above!</p>
            </div>
        `;
        clearAllBtn.style.display = 'none';
        return;
    }
    
    clearAllBtn.style.display = 'block';
    container.innerHTML = '';
    
    currentFilters.combinations.forEach(combo => {
        const item = document.createElement('div');
        item.className = 'combination-item';
        item.innerHTML = `
            <div class="combination-content">
                <div class="source-badge ${combo.source}">
                    ${combo.sourceText}
                </div>
                <div class="filter-connector">+</div>
                <div class="date-badge">
                    ${combo.dateText}
                </div>
            </div>
            <button class="remove-combination" onclick="removeCombination(${combo.id})">
                √ó
            </button>
        `;
        container.appendChild(item);
    });
}




</script>

<!-- Enrichment Results Modal -->
<div class="modal fade" id="enrichmentResultsModal" tabindex="-1" aria-labelledby="enrichmentResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="enrichmentResultsModalLabel">Enrichment Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Article Info -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">Article Information</h6>
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong>Title:</strong> <span id="enrichmentResultsTitle">Loading...</span>
                        </div>
                        <div class="col-12 mb-2">
                            <strong>URL:</strong> <a id="enrichmentResultsUrl" href="#" target="_blank" class="text-break">Loading...</a>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">Analysis Results</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Category:</strong> <span id="resultCategory" class="badge bg-primary ms-2">Loading...</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Sentiment:</strong> <span id="resultSentiment" class="badge bg-info ms-2">Loading...</span>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Sentiment Explanation:</strong>
                            <div id="resultSentimentExplanation" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Driver Type:</strong> <span id="resultDriverType" class="badge bg-warning ms-2">Loading...</span>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Driver Type Explanation:</strong>
                            <div id="resultDriverTypeExplanation" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Time to Impact:</strong> <span id="resultTimeToImpact" class="badge bg-secondary ms-2">Loading...</span>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Time to Impact Explanation:</strong>
                            <div id="resultTimeToImpactExplanation" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Future Signal:</strong> <span id="resultFutureSignal" class="badge bg-dark ms-2">Loading...</span>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Future Signal Explanation:</strong>
                            <div id="resultFutureSignalExplanation" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Quality Control -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">Quality Control</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <strong>Quality Score:</strong> <span id="resultQualityScore" class="badge bg-success ms-2">Loading...</span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <strong>Confidence Score:</strong> <span id="resultConfidenceScore" class="badge bg-info ms-2">Loading...</span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <strong>Review Status:</strong> <span id="resultReviewRecommendation" class="badge bg-secondary ms-2">Loading...</span>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Quality Issues:</strong>
                            <div id="resultQualityIssues" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Review Notes:</strong>
                            <div id="resultReviewNotes" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Relevance Scores -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">Relevance Scores</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Topic Alignment:</strong> <span id="resultTopicAlignment" class="badge bg-primary ms-2">Loading...</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Keyword Relevance:</strong> <span id="resultKeywordRelevance" class="badge bg-secondary ms-2">Loading...</span>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Overall Match Explanation:</strong>
                            <div id="resultOverallExplanation" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Extracted Data -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">Extracted Data</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Extracted Topics:</strong>
                            <div id="resultExtractedTopics" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Extracted Keywords:</strong>
                            <div id="resultExtractedKeywords" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Tags:</strong>
                            <div id="resultTags" class="mt-1 p-2 bg-light rounded small">Loading...</div>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>AI Summary:</strong>
                            <div id="resultSummary" class="mt-1 p-2 bg-light rounded small" style="max-height: 150px; overflow-y: auto;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">Processing Metadata</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <strong>Auto Ingested:</strong> <span id="resultAutoIngested" class="badge bg-info ms-2">Loading...</span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <strong>Ingest Status:</strong> <span id="resultIngestStatus" class="badge bg-secondary ms-2">Loading...</span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <strong>Submission Date:</strong> <span id="resultSubmissionDate" class="text-muted small">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEnrichedArticleBtn" onclick="saveEnrichedArticle()">
                    <i class="fas fa-save"></i>
                    Save to Database
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Article Enrichment Modal -->
<div class="modal fade" id="articleEnrichmentModal" tabindex="-1" aria-labelledby="articleEnrichmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="articleEnrichmentModalLabel">Enrich Selected Articles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Configuration Section -->
                <div class="mb-4">
                    <h6>Analysis Configuration</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="enrichmentTopicSelect" class="form-label">Topic</label>
                            <select id="enrichmentTopicSelect" class="form-select">
                                <option value="">Select a topic</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="enrichmentModelSelect" class="form-label">AI Model</label>
                            <select id="enrichmentModelSelect" class="form-select">
                                <option value="">Select a model</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Processing Options -->
                <div class="mb-4">
                    <h6>Processing Options</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enrichmentBackgroundProcessing" checked>
                        <label class="form-check-label" for="enrichmentBackgroundProcessing">
                            Background Processing (continue using interface)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enrichmentQualityControl" checked>
                        <label class="form-check-label" for="enrichmentQualityControl">
                            Quality Control (AI-powered content validation)
                        </label>
                        <div class="form-text small text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i>Uses AI to detect paywalls, cookie notices, low-quality content, and other issues. Provides quality scores and approval recommendations.
                        </div>
                    </div>
                </div>

                <!-- Selected Articles List -->
                <div class="mb-4">
                    <h6>Selected Articles (<span id="enrichmentSelectedCount">0</span>)</h6>
                    <div id="enrichmentSelectedArticlesList" class="list-group" style="max-height: 200px; overflow-y: auto;">
                        <!-- Articles will be populated here -->
                    </div>
                </div>

                <!-- Progress Section (hidden initially) -->
                <div id="enrichmentProgressContainer" style="display: none;">
                    <h6>Processing Progress</h6>
                    <div class="progress mb-2">
                        <div id="enrichmentProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="enrichmentProgressText" class="text-muted small">Preparing...</div>
                </div>

                <!-- Enrichment Results Section (hidden initially) -->
                <div id="enrichmentResultsContainer" style="display: none;">
                    <h6>Enrichment Results (<span id="enrichmentResultsCount">0</span>)</h6>
                    <div id="enrichmentResultsList" class="list-group" style="max-height: 300px; overflow-y: auto;">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="saveEnrichmentResultsBtn" onclick="saveEnrichmentResults()" style="display: none;">
                    <i class="fas fa-save"></i>
                    Save All Articles
                </button>
                <button type="button" class="btn btn-primary" id="startEnrichmentBtn" onclick="startArticleEnrichment()">
                    <i class="fas fa-brain"></i>
                    Start Enrichment
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %} 