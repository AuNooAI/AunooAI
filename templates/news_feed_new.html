{% extends 'base_with_shared_nav.html' %}
{% block title %}News Narrator - AuNoo AI{% endblock %}

{% block extra_js %}
<!-- Marked.js for markdown rendering in insights -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block content %}
<!--
==================================================
  NEWS FEED 
==================================================
-->
<style>
/* ==============================================
   CSS CUSTOM PROPERTIES (THEME COLORS)
   ============================================== */
:root {
    --primary-dark: #1a1a1a;
    --primary-gray: #4a4a4a;
    --light-gray: #f5f5f7;
    --border-light: #e5e5e5;
    --accent-pink: var(--colors-accent-8);
    --accent-pink-light: var(--colors-accent-1);
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
    --transition-fast: 0.2s ease;
}

/* Modal z-index fix - ensure modals appear above navbar */
.modal {
    z-index: 9999 !important;
}
.modal-backdrop {
    z-index: 9998 !important;
}

/* ==============================================
   MODERN MINIMALIST DESIGN
   ============================================== */
.news-feed-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

@media (max-width: 768px) {
    .news-feed-container {
        padding: 0;
    }
}

/* Hide the old News Narrator header */
.news-header {
    display: none;
}

/* New breadcrumb header matching Anticipate/Operations HQ */
.page-breadcrumb-header {
    background-color: white;
    border-bottom: 1px solid var(--colors-neutral-4);
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.breadcrumb-text {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--colors-neutral-8);
}

.breadcrumb-text span {
    color: var(--colors-neutral-8);
}

.breadcrumb-text span.font-medium {
    color: var(--colors-neutral-12);
    font-weight: 500;
}

.page-header-icons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.page-header-icons button {
    padding: 0.5rem;
    border-radius: 0.375rem;
    background: transparent;
    border: none;
    color: var(--colors-neutral-8);
    cursor: pointer;
    transition: background-color 0.15s ease;
}

.page-header-icons button:hover {
    background-color: var(--colors-neutral-3);
}

/* Page header actions - matching keyword_alerts.html */
.page-header-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.page-header-actions .btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    border-radius: 0.375rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    font-weight: 500;
    border: 1px solid transparent;
}

.page-header-actions .btn i {
    font-size: 0.875rem;
}

/* Icon-only button for bell */
.page-header-actions .btn-icon {
    padding: 0.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--colors-neutral-8);
}

.page-header-actions .btn-icon:hover {
    background: var(--colors-neutral-3);
    color: var(--colors-neutral-12);
}

/* Topic setup button - matching React trend-convergence (bg-gray-100 hover:bg-gray-200) */
.btn-topic-setup {
    background: var(--colors-neutral-3); /* bg-gray-100 */
    border: none;
    color: var(--colors-neutral-12); /* text-gray-900 */
    font-size: 0.875rem; /* text-sm */
    font-weight: 500; /* font-medium */
    padding: 0.5rem 1rem; /* px-4 py-2 */
    border-radius: 0.375rem; /* rounded-md */
    display: inline-flex;
    align-items: center;
    gap: 0.5rem; /* gap-2 */
    transition: all 0.2s ease;
    cursor: pointer;
}

.btn-topic-setup:hover {
    background: var(--colors-neutral-4); /* hover:bg-gray-200 */
    color: var(--colors-neutral-12);
}

/* Scrollable content area */
.news-feed-scrollable {
    flex: 1;
    overflow-y: visible;
    padding: 24px 48px;
    background-color: var(--colors-neutral-3);
}

@media (max-width: 768px) {
    .news-feed-scrollable {
        padding: 24px 16px;
    }
}

.news-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    background: linear-gradient(135deg, var(--colors-accent-7), var(--colors-accent-10));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    align-items: center;
    gap: 8px;
}

.news-title-icon {
    color: var(--colors-accent-7);
    -webkit-text-fill-color: var(--colors-accent-7);
}

.news-date {
    font-size: 0.9rem;
    color: var(--colors-neutral-8);
    margin-top: 5px;
}

/* ==============================================
   STICKY NAVIGATION TABS
   ============================================== */
.news-nav {
    margin: 20px 0 24px;
    border-bottom: 1px solid var(--border-light);
    position: sticky;
    top: 0;
    background: white;
    z-index: 100;
    padding: 8px 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.nav-tabs {
    border-bottom: none;
    gap: 4px;
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--primary-gray);
    font-weight: 600;
    padding: 12px 24px;
    background: none;
    transition: var(--transition-fast);
    border-radius: 8px 8px 0 0;
}

.nav-tabs .nav-link.active {
    border-bottom-color: var(--primary-dark);
    color: var(--primary-dark);
    background: var(--light-gray);
}

.nav-tabs .nav-link:hover:not(.active) {
    border-bottom-color: var(--primary-gray);
    color: var(--primary-dark);
    background: rgba(0, 0, 0, 0.02);
}

/* ==============================================
   CARD-BASED ARTICLE GRID
   ============================================== */
#articles-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr));
    gap: 20px;
    margin-top: 24px;
}

/* Single column layout for Article Investigator - wide cards stacked vertically */
@media (min-width: 992px) {
    #articles-list {
        grid-template-columns: 1fr;
        max-width: 100%;
    }
}

.story-item,
.article-card {
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 20px;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-sm);
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
    height: auto; /* Changed from 100% to auto */
    min-height: 250px;
}

/* Prevent internal content squashing */
.story-item > *,
.article-card > * {
    width: 100%;
}

.story-item .row,
.story-item .d-flex,
.article-card .row,
.article-card .d-flex {
    flex-wrap: wrap !important;
    gap: 8px;
}

/* Ensure metadata sections don't get squashed */
.story-item .metadata-section,
.story-item .article-details {
    display: block;
    width: 100%;
}

.story-item .col,
.story-item .col-6,
.story-item .col-md-6 {
    min-width: 200px;
    flex: 1 1 auto;
}

/* Article expanded state - span full grid width inline */
.list-group-item.expanded {
    grid-column: 1 / -1 !important;
    display: flex;
    flex-direction: column;
}

.article-details {
    width: 100% !important;
    max-width: 100% !important;
}

/* Grid layout for expanded article details on desktop */
@media (min-width: 992px) {
    .article-details-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
    }
}

@media (max-width: 991px) {
    .article-details-grid {
        display: block;
    }
}

/* Improved metadata layout in expanded state */
.article-details .metadata-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 16px;
    max-width: 100%;
    overflow-x: auto;
}

.article-details .metadata-badges .badge {
    padding: 4px 10px;
    font-size: 0.8rem;
    white-space: nowrap;
    flex-shrink: 0;
}

@media (max-width: 768px) {
    .article-details .metadata-badges {
        flex-direction: column;
        align-items: flex-start;
    }

    .article-details .metadata-badges .badge {
        font-size: 0.75rem;
    }
}

/* Card metadata badges - prevent overflow in collapsed view */
.story-item .col-md-4 .badge,
.list-group-item .col-md-4 .badge {
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-shrink: 0;
}

/* Cache indicator - small badge style */
.cache-indicator {
    display: inline-block !important;
    font-size: 0.65rem !important;
    padding: 2px 8px !important;
    background: #e3f2fd !important;
    border: 1px solid #90caf9 !important;
    border-radius: 12px !important;
    margin-top: 12px !important;
    margin-bottom: 0 !important;
    color: #1976d2 !important;
    font-weight: 500 !important;
    width: auto !important;
    max-width: fit-content !important;
    flex-basis: 100% !important;  /* Force to new line in flex container */
    order: 999 !important;  /* Ensure it appears last */
}

/* Handle list-group-item class from JavaScript */
.list-group-item {
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 0;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-sm);
}

.list-group-item:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--accent-blue);
    transform: translateY(-2px);
}

/* Override Bootstrap list-group defaults */
.list-group {
    display: grid;
    grid-template-columns: inherit;
    gap: inherit;
}

/* Table view - full width */
#articles-list.table-view {
    display: block !important;
    width: 100%;
}

#articles-list.table-view .table-responsive {
    width: 100%;
    max-width: 100%;
}

/* Table expand arrow - matches card view */
.expand-arrow-btn-table {
    width: 20px;
    height: 40px;
    padding: 0;
    font-size: 12px;
    border: none;
    background: var(--colors-info-5);
    color: white;
    border-radius: 0 8px 8px 0;
    cursor: pointer;
    transition: all 0.2s ease;
    position: absolute;
    left: -2px;
    top: 50%;
    transform: translateY(-50%);
    box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}

.expand-arrow-btn-table:hover {
    background: #3498db;
}

.expand-arrow-btn-table.expanded {
    background: var(--colors-success-9);
}

/* Grouped article styling */
.list-group-item.grouped-article {
    /* Removed blue border for multi-source cards */
    background: white;
}

.grouped-sources-badge {
    background: var(--colors-info-5);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
}

.story-item:hover,
.article-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--accent-blue);
    transform: translateY(-2px);
}

.story-headline {
    font-size: 1.1rem;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 12px;
    color: var(--primary-dark);
}

.story-headline a {
    color: inherit;
    text-decoration: none;
    transition: color var(--transition-fast);
}

.story-headline a:hover {
    color: var(--accent-blue);
}

.story-summary {
    font-size: 0.9rem;
    color: var(--primary-gray);
    margin-bottom: 16px;
    flex-grow: 1;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.story-meta {
    font-size: 0.8rem;
    color: var(--colors-neutral-7);
    margin-bottom: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
}

.source-info {
    display: inline-block;
    margin-right: 15px;
}

.bias-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 5px;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.bias-left { background: #e3f2fd; color: #1976d2; }
.bias-left-center { background: #e8f5e8; color: #388e3c; }
.bias-center { background: #f3e5f5; color: #7b1fa2; }
.bias-right-center { background: var(--colors-white)3e0; color: #f57c00; }
.bias-right { background: #ffebee; color: #d32f2f; }
.bias-mixed { background: var(--colors-neutral-3); color: #616161; }

.factuality-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 5px;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.factuality-very-high { background: #e8f5e8; color: #2e7d32; }
.factuality-high { background: #e8f5e8; color: #388e3c; }
.factuality-mostly-factual { background: #f3e5f5; color: #7b1fa2; }
.factuality-mixed { background: var(--colors-white)3e0; color: #f57c00; }
.factuality-low { background: #ffebee; color: #d32f2f; }

.related-articles {
    margin-top: 15px;
    padding-left: 20px;
    border-left: 3px solid var(--colors-neutral-4);
}

.related-articles h6 {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--colors-neutral-8);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.related-item {
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.related-item a {
    color: var(--colors-info-5);
    text-decoration: none;
}

.related-item a:hover {
    text-decoration: underline;
}

/* ==============================================
   STREAMLINED CONFIGURATION PANEL
   ============================================== */
.controls {
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 0;
    margin-bottom: 24px;
    box-shadow: var(--shadow-sm);
    overflow: visible;
}

.controls-header {
    padding: 8px 12px;
    background: var(--colors-neutral-2);
    border-bottom: 1px solid var(--border-light);
    border-radius: 12px 12px 0 0;
}

.controls-header h6 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 600;
}

#controlsContent {
    padding: 16px 20px;
    background: white;
    border-radius: 0 0 12px 12px;
    transition: all 0.3s ease;
    overflow: visible;
}

/* Ensure dropdown menus in configuration panel are not clipped */
#controlsContent .row,
#controlsContent .col-md-6,
#controlsContent .col-6 {
    overflow: visible !important;
}

/* ==============================================
   LEFT SIDEBAR NAVIGATION
   ============================================== */
.page-layout-container {
    display: flex;
    gap: 0;
    align-items: flex-start;
}

.sidebar-nav {
    width: 220px;
    background: var(--colors-white);
    border-right: 1px solid var(--colors-neutral-5);
    padding: 12px;
    flex-shrink: 0;
    min-height: 500px;
}

.sidebar-nav .nav {
    flex-direction: column;
    gap: 8px;
}

.sidebar-nav .nav-link {
    color: var(--colors-accent-8);
    padding: 10px 12px;
    border: none;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: var(--colors-white);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-sizing: border-box;
    width: 100%;
}

.sidebar-nav .nav-link i {
    width: 18px;
    min-width: 18px;
    text-align: center;
    font-size: 0.95rem;
    flex-shrink: 0;
    color: var(--colors-accent-8);
}

.sidebar-nav .nav-link span {
    overflow: hidden;
    text-overflow: ellipsis;
    /* Do not add flex: 1 - this breaks centering */
}

.sidebar-nav .nav-link:hover {
    background: var(--colors-accent-1);
    border-color: transparent;
    color: var(--colors-accent-8);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(236, 72, 153, 0.1);
}

.sidebar-nav .nav-link.active {
    background: linear-gradient(135deg, var(--colors-accent-7), var(--colors-accent-10));
    border-color: var(--colors-accent-7);
    color: var(--colors-white);
    font-weight: 500;
}

.main-content-area {
    flex-grow: 1;
    min-width: 0;
    padding-left: 24px;
}

/* Page tab navigation - matching React Trend Convergence with pink underline */
.page-tab-navigation {
    background-color: white;
    padding: 0.75rem 1.5rem 0;
    border-bottom: 1px solid var(--colors-neutral-4);
    margin-bottom: 1.5rem;
}

.tab-nav-container {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--colors-neutral-3);
}

.tab-nav-btn {
    padding: 0.75rem 1.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    border: none;
    background: transparent;
    color: var(--colors-neutral-8);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    position: relative;
}

.tab-nav-btn.active {
    color: var(--colors-accent-8);
    border-bottom-color: var(--colors-accent-8);
    font-weight: 600;
}

.tab-nav-btn:hover:not(.active) {
    color: var(--colors-neutral-12);
    background-color: var(--colors-neutral-2);
}

/* Hide old sidebar navigation */
.sidebar-nav {
    display: none !important;
}

/* Hide old horizontal tabs */
.news-nav {
    display: none !important;
}

/* Make main content area full width */
.main-content-area-full {
    width: 100%;
    padding: 0;
}

/* Tab content - let body scroll naturally */
.main-content-area-full .tab-content {
    padding: 0 48px 24px 48px;
}

/* Subtle pink action buttons - matching React Trend Convergence */
.btn-action-subtle {
    background: white;
    border: 1px solid var(--colors-neutral-4);
    color: var(--colors-accent-8); /* text-pink-500 */
    font-size: 0.875rem; /* text-sm */
    font-weight: 500; /* font-medium */
    padding: 0.5rem 0.75rem; /* px-3 py-2 */
    border-radius: 0.375rem; /* rounded-md */
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
}

.btn-action-subtle:hover {
    background: var(--colors-accent-1); /* hover:bg-pink-50 */
    color: var(--colors-accent-8);
    border-color: var(--colors-accent-3);
}

.btn-action-subtle i {
    color: var(--colors-accent-8);
}

/* Mobile responsiveness - show horizontal tabs on small screens */
@media (max-width: 768px) {
    .page-layout-container {
        flex-direction: column;
    }

    .sidebar-nav {
        display: none;
    }

    .news-nav {
        display: block;
    }

    .main-content-area {
        padding-left: 0;
    }
}

.controls-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: center;
}

.control-group-inline {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.control-group-inline label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--primary-gray);
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.selected-date-compact {
    font-size: 0.9rem;
    color: var(--bs-primary);
    margin-right: 0.5rem;
}

/* Bootstrap-based Calendar Styles */
#calendar-container {
    max-width: 400px;
    width: 100%;
    margin-top: 8px;
}

#calendar-view {
    max-width: 100%;
}

.calendar-month {
    margin-bottom: 1rem;
}

.calendar-month-header {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--bs-dark);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--bs-border-color);
    text-align: center;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 0.5rem;
    width: 100%;
    max-width: 350px;
}

.calendar-day-header {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--bs-secondary);
    padding: 0.25rem;
    background-color: var(--bs-light);
    border-radius: var(--bs-border-radius-sm);
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    border-radius: var(--bs-border-radius);
    cursor: default;
    position: relative;
    min-height: 32px;
    border: 1px solid transparent;
}

.calendar-day.has-articles {
    background-color: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
    cursor: pointer;
    font-weight: 600;
    border: 1px solid var(--bs-primary-border-subtle);
}

.calendar-day.has-articles:hover {
    background-color: var(--bs-primary);
    color: var(--bs-white);
    transform: scale(1.05);
    transition: all 0.15s ease-in-out;
}

.calendar-day.selected {
    background-color: var(--bs-primary) !important;
    color: var(--bs-white) !important;
    border-color: var(--bs-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

.calendar-day.other-month {
    color: var(--bs-secondary);
    opacity: 0.5;
}

.calendar-day.has-articles .badge {
    position: absolute;
    bottom: 1px;
    right: 1px;
    font-size: 0.6rem;
    padding: 0.1rem 0.25rem;
    line-height: 1;
}

.calendar-day.selected .badge {
    background-color: var(--bs-white) !important;
    color: var(--bs-primary) !important;
}

/* Old control-group styles removed - now using control-group-inline */

.form-select, .form-control {
    font-size: 0.9rem;
    padding: 5px 10px;
    border: 1px solid var(--colors-neutral-5);
    border-radius: 3px;
}

/* ==============================================
   MODERN BUTTON STYLES
   ============================================== */
.btn {
    font-size: 0.9rem;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    transition: var(--transition-fast);
}

.btn-primary {
    background: linear-gradient(135deg, var(--colors-accent-7), var(--colors-accent-10));
    border-color: var(--colors-accent-7);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--colors-accent-10), var(--colors-accent-7));
    border-color: var(--colors-accent-10);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 105, 180, 0.3);
}

.btn-outline-primary {
    color: var(--colors-accent-8);
    border-color: var(--colors-accent-7);
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, var(--colors-accent-7), var(--colors-accent-10));
    border-color: var(--colors-accent-7);
    color: white !important;
}

.btn-outline-primary:hover i {
    color: white !important;
}

.btn-outline-primary.active,
.btn-outline-primary:active,
.btn-outline-primary:focus,
.btn-outline-primary.show,
.btn-outline-primary.dropdown-toggle.show,
.btn-group .btn-outline-primary.active {
    background: linear-gradient(135deg, var(--colors-accent-7), var(--colors-accent-10)) !important;
    border-color: var(--colors-accent-7) !important;
    color: white !important;
    -webkit-text-fill-color: white !important;
    background-clip: border-box !important;
    -webkit-background-clip: border-box !important;
}

.btn-outline-primary.active i,
.btn-outline-primary:active i,
.btn-outline-primary:focus i,
.btn-outline-primary.show i,
.btn-outline-primary.dropdown-toggle.show i,
.btn-group .btn-outline-primary.active i {
    color: white !important;
    -webkit-text-fill-color: white !important;
}

/* Specific button IDs for MAXIMUM specificity - target ALL states */
#filter-dropdown-btn-articles,
#filter-dropdown-btn-articles.active,
#filter-dropdown-btn-articles:active,
#filter-dropdown-btn-articles:focus,
#filter-dropdown-btn-articles:hover,
#filter-dropdown-btn-insights,
#filter-dropdown-btn-insights.active,
#filter-dropdown-btn-insights:active,
#filter-dropdown-btn-insights:focus,
#filter-dropdown-btn-insights:hover,
#article-card-view-btn,
#article-card-view-btn.active,
#article-card-view-btn:active,
#article-card-view-btn:focus,
#article-card-view-btn:hover,
#article-table-view-btn,
#article-table-view-btn.active,
#article-table-view-btn:active,
#article-table-view-btn:focus,
#article-table-view-btn:hover,
#incident-card-view-btn,
#incident-card-view-btn.active,
#incident-card-view-btn:active,
#incident-card-view-btn:focus,
#incident-card-view-btn:hover,
#incident-table-view-btn,
#incident-table-view-btn.active,
#incident-table-view-btn:active,
#incident-table-view-btn:focus,
#incident-table-view-btn:hover {
    background: linear-gradient(135deg, var(--colors-accent-7), var(--colors-accent-10)) !important;
    border-color: var(--colors-accent-7) !important;
    color: white !important;
    -webkit-text-fill-color: white !important;
    background-clip: border-box !important;
    -webkit-background-clip: border-box !important;
}

#filter-dropdown-btn-articles i,
#filter-dropdown-btn-articles.active i,
#filter-dropdown-btn-articles:active i,
#filter-dropdown-btn-articles:focus i,
#filter-dropdown-btn-articles:hover i,
#filter-dropdown-btn-insights i,
#filter-dropdown-btn-insights.active i,
#filter-dropdown-btn-insights:active i,
#filter-dropdown-btn-insights:focus i,
#filter-dropdown-btn-insights:hover i,
#article-card-view-btn i,
#article-card-view-btn.active i,
#article-card-view-btn:active i,
#article-card-view-btn:focus i,
#article-card-view-btn:hover i,
#article-table-view-btn i,
#article-table-view-btn.active i,
#article-table-view-btn:active i,
#article-table-view-btn:focus i,
#article-table-view-btn:hover i,
#incident-card-view-btn i,
#incident-card-view-btn.active i,
#incident-card-view-btn:active i,
#incident-card-view-btn:focus i,
#incident-card-view-btn:hover i,
#incident-table-view-btn i,
#incident-table-view-btn.active i,
#incident-table-view-btn:active i,
#incident-table-view-btn:focus i,
#incident-table-view-btn:hover i {
    color: white !important;
    -webkit-text-fill-color: white !important;
}

/* Profile management buttons - FORCE WHITE */
.d-flex.gap-1 > button.btn-outline-primary,
.d-flex.gap-1 > button.btn-outline-primary:hover,
.d-flex.gap-1 > button.btn-outline-primary:focus,
.d-flex.gap-1 > button.btn-outline-primary:active {
    background: linear-gradient(135deg, var(--colors-accent-7), var(--colors-accent-10)) !important;
    border-color: var(--colors-accent-7) !important;
    color: white !important;
}

.d-flex.gap-1 > button.btn-outline-primary i,
.d-flex.gap-1 > button.btn-outline-primary:hover i,
.d-flex.gap-1 > button.btn-outline-primary:focus i,
.d-flex.gap-1 > button.btn-outline-primary:active i {
    color: white !important;
}

/* Topic dropdown button styling - DARK TEXT for visibility */
#topic-select-btn,
#topic-select-btn .text-truncate,
#topic-select-label {
    color: var(--colors-accent-8) !important;
}

#topic-select-count {
    background-color: rgba(255, 255, 255, 0.3) !important;
    color: white !important;
}

.btn-baby-blue {
    background: var(--colors-info-5);
    border-color: var(--colors-info-5);
    color: white;
}

.btn-baby-blue:hover {
    background: #3498db;
    border-color: #3498db;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(93, 173, 226, 0.3);
}

.btn-outline-baby-blue {
    background: white;
    border: 1px solid var(--colors-info-5);
    color: var(--colors-info-5);
}

.btn-outline-baby-blue:hover {
    background: var(--colors-info-5);
    border-color: var(--colors-info-5);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(93, 173, 226, 0.3);
}

/* ==============================================
   LOADING STATES & SKELETON SCREENS
   ============================================== */
.loading {
    text-align: center;
    padding: 48px 24px;
    color: var(--primary-gray);
}

.loading .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
    color: var(--accent-blue);
}

.skeleton {
    background: linear-gradient(
        90deg,
        var(--border-light) 0%,
        #f0f0f0 50%,
        var(--border-light) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: 8px;
}

@keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skeleton-card {
    height: 250px;
    margin-bottom: 20px;
}

.skeleton-text {
    height: 16px;
    margin-bottom: 12px;
    width: 100%;
}

.skeleton-text.short {
    width: 60%;
}

.error-message {
    background: #ffebee;
    color: #c62828;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid #c62828;
    box-shadow: var(--shadow-sm);
}

/* ==============================================
   FILTER DROPDOWN PANEL
   ============================================== */
.filter-dropdown-panel {
    position: absolute;
    right: 0;
    top: calc(100% + 8px);
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    width: 400px;
    max-width: 95vw;
    z-index: 2000;
    animation: slideDown 0.2s ease;
}

/* Fix Topics button arrow - grey triangle, no background */
button#topic-select-btn.dropdown-toggle::after {
    display: inline-block !important;
    width: 0 !important;
    height: 0 !important;
    margin-left: 0.5em !important;
    vertical-align: 0.15em !important;
    content: "" !important;
    border-top: 5px solid #6c757d !important;
    border-right: 5px solid transparent !important;
    border-bottom: 0 !important;
    border-left: 5px solid transparent !important;
    background-color: transparent !important;
}

/* Ensure Topics button has white background */
button#topic-select-btn {
    background-color: white !important;
    border-color: #dee2e6 !important;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.filter-dropdown-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--border-light);
}

.filter-dropdown-header h6 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary-dark);
}

.filter-dropdown-body {
    padding: 16px;
    max-height: 60vh;
    overflow-y: auto;
}

.filter-section {
    margin-bottom: 20px;
}

.filter-section:last-child {
    margin-bottom: 0;
}

/* Fix dropdown z-index to appear above sticky table headers */
.dropdown-menu {
    z-index: 1060 !important;
}

.filter-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--primary-gray);
    margin-bottom: 8px;
}

.filter-chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--accent-pink-light);
    border: 1px solid var(--accent-pink);
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--accent-pink);
    cursor: pointer;
    transition: var(--transition-fast);
}

.filter-chip:hover {
    background: var(--accent-pink);
    color: white;
}

.filter-chip.active {
    background: var(--accent-pink);
    color: white;
}

.filter-chip .count-badge {
    background: white;
    color: var(--accent-pink);
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 700;
}

.filter-chip.active .count-badge {
    background: rgba(255,255,255,0.3);
    color: white;
}

.filter-dropdown-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-top: 1px solid var(--border-light);
    gap: 8px;
}

.executive-summary {
    background: var(--light-gray);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    border-left: 4px solid var(--accent-blue);
}

.key-themes {
    margin-bottom: 30px;
}

.key-themes h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--primary-dark);
}

.theme-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.theme-tag {
    background: var(--colors-neutral-4);
    color: var(--colors-neutral-9);
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 500;
}

.perspective-breakdown {
    margin-top: 15px;
    padding: 15px;
    background: var(--colors-neutral-2);
    border-radius: 5px;
}

.perspective-breakdown h6 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--colors-black);
}

.perspective-item {
    margin-bottom: 8px;
    font-size: 0.85rem;
}

.perspective-label {
    font-weight: 600;
    text-transform: capitalize;
    margin-right: 8px;
}

/* ==============================================
   MOBILE RESPONSIVE OPTIMIZATIONS
   ============================================== */
@media (max-width: 768px) {
    .news-feed-container {
        padding: 16px;
    }

    .news-header {
        padding-bottom: 12px;
    }

    .news-title {
        font-size: 1.5rem;
    }

    .story-headline {
        font-size: 1rem;
    }

    /* Single column article grid on mobile */
    #articles-list {
        grid-template-columns: 1fr !important;
        gap: 16px;
    }

    /* Allow full-width content on mobile */
    .story-item .col,
    .story-item .col-6,
    .story-item .col-md-6 {
        min-width: 100%;
        flex: 1 1 100%;
    }

    /* Stack configuration controls vertically */
    .controls-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .control-group-inline {
        width: 100%;
    }

    .control-group-inline label {
        font-size: 0.7rem;
    }

    /* Make tabs scrollable on mobile */
    .nav-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .nav-tabs .nav-link {
        flex-shrink: 0;
        padding: 10px 16px;
        font-size: 0.85rem;
    }

    /* Touch-friendly buttons */
    .btn {
        min-height: 44px;
        padding: 10px 16px;
    }

    /* Sticky nav adjustment */
    .news-nav {
        top: 50px;
    }
    }

    /* Add styles for metadata tags like topic_dashboard.html */
    .metadata-tag {
        display: inline-block;
        padding: 0.2em 0.6em;
        margin-right: 0.3em;
        margin-bottom: 0.3em;
        font-size: 0.75em;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        border: 1px solid transparent;
    }

    .tag-category {
        background-color: #e6f3ff;
        color: var(--colors-info-5);
        border-color: #99ccff;
    }

    .tag-driver {
        background-color: var(--colors-white)0e6;
        color: #cc6600;
        border-color: #ffcc99;
    }

    .tag-tti {
        background-color: #f0f0ff;
        color: #4b0082;
        border-color: #c0c0ff;
    }

    .tag-sentiment {
        border-width: 1px;
        border-style: solid;
    }

    .sentiment-critical {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .sentiment-hyperbolic {
        background-color: var(--colors-white)ae6;
        color: #997a00;
        border-color: #ffe680;
    }

    .sentiment-mixed {
        background-color: #f9f9f9;
        color: var(--colors-neutral-8)666;
        border-color: var(--colors-neutral-5)ddd;
    }

    .sentiment-positive { background-color: #d1e7dd; color: #0a5132; border: 1px solid #a3cfbb; }
    .sentiment-negative { background-color: var(--colors-error-2); color: #842029; border: 1px solid #f1aeb5; }
    .sentiment-neutral { background-color: #e2e3e5; color: #41464b; border: 1px solid #c3c6ca; }
    .sentiment-unknown { background-color: var(--colors-neutral-2); color: var(--colors-neutral-8); border: 1px solid var(--colors-neutral-5); }

    /* Bias tags */
    .tag-bias-left {
        background-color: #e6f2ff;
        color: var(--colors-info-5);
        border-color: #99ccff;
    }

    .tag-bias-right {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .tag-bias-center {
        background-color: #f0f0ff;
        color: #4b0082;
        border-color: #c0c0ff;
    }

    .tag-bias-factual {
        background-color: #e6ffe6;
        color: #006600;
        border-color: #99ff99;
    }

    .tag-bias-unknown {
        background-color: #f9f9f9;
        color: var(--colors-neutral-8)666;
        border-color: var(--colors-neutral-5)ddd;
    }

    /* Factual reporting tags */
    .tag-factual-high {
        background-color: #e6ffe6;
        color: #006600;
        border-color: #99ff99;
    }

    .tag-factual-mostly {
        background-color: #f0fff0;
        color: #228b22;
        border-color: #90ee90;
    }

    .tag-factual-mixed {
        background-color: var(--colors-white)ae6;
        color: #997a00;
        border-color: #ffe680;
    }

    .tag-factual-low {
        background-color: #ffe6e6;
        color: #cc0000;
        border-color: #ffb3b3;
    }

    .tag-factual-unknown {
        background-color: #f9f9f9;
        color: var(--colors-neutral-8)666;
        border-color: var(--colors-neutral-5)ddd;
    }

    /* Insights Tab Styling - Pink text, white background */
    /* Insights navigation - subtle styling matching React Trend Convergence */
    .insights-nav .nav-link {
        border: 1px solid var(--colors-neutral-4); /* light gray border */
        border-radius: 8px;
        margin: 0 2px;
        background-color: white;
        color: var(--colors-accent-8); /* text-pink-500 */
        font-weight: 500;
        padding: 8px 16px;
        transition: all 0.2s ease;
    }

    .insights-nav .nav-link i {
        color: var(--colors-accent-8);
    }

    /* Active state - subtle pink background instead of gradient */
    .insights-nav .nav-link.active,
    .insights-nav .nav-link.active:hover,
    .insights-nav .nav-link.active:focus,
    .nav-pills .insights-nav .nav-link.active {
        background: #fce7f3 !important; /* bg-pink-100 - very light pink */
        border-color: var(--colors-accent-3) !important; /* pink-200 border */
        color: #be185d !important; /* text-pink-700 - darker pink for contrast */
    }

    .insights-nav .nav-link.active i,
    .insights-nav .nav-link.active:hover i,
    .insights-nav .nav-link.active:focus i {
        color: #be185d !important; /* darker pink icon */
    }

    /* Global override for nav-pills active state - subtle styling */
    .nav-pills .nav-link.active,
    .nav-pills .show > .nav-link {
        background: #fce7f3 !important; /* bg-pink-100 */
        border-color: var(--colors-accent-3) !important;
        color: #be185d !important;
    }

    .nav-pills .nav-link.active i,
    .nav-pills .show > .nav-link i {
        color: #be185d !important;
    }

    /* Hover state - very subtle */
    .insights-nav .nav-link:hover:not(.active) {
        background-color: var(--colors-accent-1); /* hover:bg-pink-50 */
        border-color: var(--colors-accent-3);
        color: var(--colors-accent-8);
        transform: none; /* remove upward movement for subtlety */
        box-shadow: none; /* remove shadow for subtlety */
    }

    .insights-nav .nav-link:hover:not(.active) i {
        color: var(--colors-accent-8);
    }

    /* Insight Card Styling - matching topic dashboard */
    .insight-item-card {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        flex: 1 1 320px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        background-color: var(--colors-white);
        min-width: 300px;
        max-width: 400px;
    }

    .insight-item-card h6 {
        font-size: 1rem;
        color: var(--bs-primary);
        margin-bottom: 0.75rem;
    }

    .insight-item-card p {
        font-size: 0.9rem;
        flex-grow: 1;
        max-height: 200px;
        overflow-y: auto;
        word-wrap: break-word;
        margin-bottom: 0.5rem;
    }

    .insight-content {
        width: 100%;
    }

    .insight-content ul, .insight-content ol {
        padding-left: 1.5rem;
    }

    .insight-content p {
        margin-bottom: 0.5rem;
    }

    /* Category Insights Grid */
    #category-insights-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.25rem;
        width: 100%;
        box-sizing: border-box;
    }

    #category-insights-container .insight-item-card {
        margin-bottom: 0;
    }

    /* Thematic Clustering Styles */
    .thematic-cluster {
        background: linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
        border-left: 4px solid var(--colors-accent-7);
    }

    .cluster-article-list {
        max-height: 200px;
        overflow-y: auto;
        border-top: 1px solid var(--colors-neutral-4);
        margin-top: 12px;
        padding-top: 12px;
    }

    .cluster-article-item {
        padding: 8px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-size: 0.85rem;
    }

    .cluster-article-item:last-child {
        border-bottom: none;
    }

    .cluster-article-item a {
        color: var(--colors-neutral-11);
        text-decoration: none;
        font-weight: 500;
    }

    .cluster-article-item a:hover {
        color: var(--colors-accent-7);
        text-decoration: underline;
    }

    .cluster-stats {
        display: flex;
        gap: 16px;
        margin-top: 12px;
        font-size: 0.8rem;
        color: var(--colors-neutral-10);
    }

    .cluster-stat {
        display: flex;
        align-items: center;
        gap: 4px;
    }

/* ============================================
   MODERN NEWS TICKER DESIGN
   ============================================ */

.news-ticker-container {
    background: var(--light-gray);
    border: 1px solid var(--border-light);
    border-left: 4px solid var(--accent-blue);
    padding: 0;
    margin: -24px -24px 24px -24px;
    position: relative;
    overflow: hidden;
    height: 44px;
    display: none; /* Hidden by default */
    box-shadow: var(--shadow-sm);
    border-radius: 0 0 12px 12px;

    /* Performance optimization */
    will-change: transform;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.news-ticker-container.visible {
    display: block;
}

/* Breaking News Label */
.ticker-header {
    background: var(--accent-blue);
    color: white;
    padding: 0 16px;
    font-weight: 700;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 12;
    display: flex;
    align-items: center;
    gap: 6px;
    min-width: 100px;
    border-right: 1px solid var(--border-light);
    border-radius: 0 0 0 12px;
}

.ticker-header i {
    margin-right: 6px;
    font-size: 0.75rem;
}

/* Ticker Controls */
.ticker-controls {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 11;
    display: flex;
    gap: 4px;
}

.ticker-controls .btn {
    padding: 3px 8px;
    font-size: 0.7rem;
    border: 1px solid var(--colors-neutral-5);
    background: var(--colors-white);
    color: var(--colors-neutral-8);
    transition: all 0.2s ease;
    border-radius: 3px;
}

.ticker-controls .btn:hover {
    background: var(--colors-neutral-4);
    color: var(--colors-info-5);
    border-color: var(--colors-info-5);
}

.ticker-controls .btn:active {
    background: var(--colors-neutral-5);
}

/* Scrolling Content Container */
.ticker-content-wrapper {
    position: absolute;
    left: 95px; /* Space for LATEST label */
    right: 140px; /* Space for controls */
    top: 0;
    bottom: 0;
    overflow: hidden;
}

.ticker-content {
    display: inline-flex;
    white-space: nowrap;
    align-items: center;
    height: 100%;

    /* GPU-accelerated animation */
    animation: scroll-left 120s linear infinite;
    transform: translateZ(0); /* Force GPU acceleration */
    backface-visibility: hidden;
    perspective: 1000px;
}

/* Pause on hover */
.ticker-content:hover {
    animation-play-state: paused;
}

/* Paused state (via JS) */
.ticker-content.paused {
    animation-play-state: paused;
}

/* Scroll animation */
@keyframes scroll-left {
    0% {
        transform: translateX(0) translateZ(0);
    }
    100% {
        transform: translateX(-50%) translateZ(0);
    }
}

/* Individual Ticker Items */
.ticker-item {
    display: inline-flex;
    align-items: center;
    padding: 0 20px;
    border-right: 1px solid var(--colors-neutral-5);
    font-size: 0.85rem;
    line-height: 1.3;
    height: 100%;
}

.ticker-item:last-child {
    border-right: none;
}

.ticker-item a {
    color: var(--colors-neutral-11);
    text-decoration: none;
    transition: color 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.ticker-item a:hover {
    color: var(--colors-info-5);
    text-decoration: none;
}

/* Ticker Metadata */
.ticker-time {
    color: var(--colors-neutral-7);
    font-size: 0.7rem;
    font-weight: 400;
    margin-right: 8px;
    white-space: nowrap;
}

.ticker-source {
    color: var(--colors-neutral-8);
    font-size: 0.65rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-left: 8px;
    padding: 2px 5px;
    background: var(--colors-neutral-4);
    border-radius: 2px;
}

/* Topic Badge (optional) */
.ticker-topic {
    display: inline-block;
    font-size: 0.65rem;
    padding: 2px 5px;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 2px;
    margin-left: 6px;
    font-weight: 500;
}

/* Loading State */
.ticker-loading {
    position: absolute;
    left: 105px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--colors-neutral-8);
    font-size: 0.8rem;
}

.ticker-loading i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Empty State */
.ticker-empty {
    position: absolute;
    left: 105px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--colors-neutral-8);
    font-size: 0.8rem;
    font-style: italic;
}

/* ============================================
   RESPONSIVE DESIGN
   ============================================ */

@media (max-width: 992px) {
    .ticker-content-wrapper {
        left: 90px;
        right: 120px;
    }

    .ticker-header {
        min-width: 85px;
        font-size: 0.75rem;
        padding: 0 10px;
    }
}

@media (max-width: 768px) {
    .news-ticker-container {
        height: 38px;
        margin: -15px -15px 15px -15px;
    }

    .ticker-header {
        min-width: 70px;
        font-size: 0.7rem;
        padding: 0 8px;
    }

    .ticker-content-wrapper {
        left: 75px;
        right: 100px;
    }

    .ticker-item {
        padding: 0 15px;
        font-size: 0.8rem;
    }

    .ticker-time,
    .ticker-source {
        display: none; /* Hide metadata on mobile */
    }

    .ticker-controls {
        right: 8px;
    }

    .ticker-controls .btn {
        padding: 2px 6px;
        font-size: 0.65rem;
    }
}

@media (max-width: 480px) {
    .news-ticker-container {
        height: 36px;
    }

    .ticker-header {
        min-width: 60px;
        font-size: 0.65rem;
        letter-spacing: 0.3px;
    }

    .ticker-content-wrapper {
        left: 65px;
        right: 85px;
    }

    .ticker-item {
        padding: 0 12px;
        font-size: 0.75rem;
    }
}

/* ============================================
   ACCESSIBILITY
   ============================================ */

/* Respect user's motion preferences */
@media (prefers-reduced-motion: reduce) {
    .ticker-content {
        animation: none !important;
        animation-play-state: paused !important;
    }

    .ticker-header {
        animation: none !important;
    }

    .ticker-header i {
        animation: none !important;
    }

    /* Show as static list instead */
    .ticker-content-wrapper {
        overflow-x: auto;
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
    }

    .ticker-content {
        display: flex;
        flex-wrap: nowrap;
    }

    .ticker-item {
        scroll-snap-align: start;
        flex-shrink: 0;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .news-ticker-container {
        border: 2px solid var(--primary-dark);
        border-left-width: 4px;
    }

    .ticker-item {
        border-right: 2px solid var(--primary-dark);
    }

    .ticker-header {
        border-right: 2px solid var(--primary-dark);
    }

    .ticker-controls .btn {
        border: 2px solid var(--primary-dark);
    }
}

/* Focus styles for keyboard navigation */
.ticker-item a:focus-visible {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
    border-radius: 6px;
}

.ticker-controls .btn:focus-visible {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
}

/* ============================================
   PRINT STYLES
   ============================================ */

@media print {
    .news-ticker-container {
        display: none;
    }
}
</style>

<div class="news-feed-container">
    <!-- Breadcrumb Header matching Anticipate/Operations HQ -->
    <div class="page-breadcrumb-header">
        <div class="breadcrumb-text">
            <span>Explore</span>
            <span>/</span>
            <span class="font-medium">News Feed</span>
            <span>â€¢</span>
            <span>Explore and narrate your news feed</span>
        </div>
        <div class="page-header-actions">
            <button type="button" class="btn btn-icon" title="Notifications">
                <i class="far fa-bell"></i>
            </button>
            <button class="btn-topic-setup" onclick="window.location.href='/trend-convergence?onboarding=true'">
                <span>Set up topic</span>
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Scrollable Content Area -->
    <div class="news-feed-scrollable">
    <!-- ============================================
         NEWS TICKER COMPONENT
         ============================================ -->
    <div class="news-ticker-container" id="news-ticker"
         role="marquee"
         aria-live="polite"
         aria-atomic="false"
         aria-label="Latest news ticker">

        <!-- Breaking News Label -->
        <div class="ticker-header" aria-hidden="true">
            <i class="fas fa-bolt"></i>
            <span>LATEST</span>
        </div>

        <!-- Control Buttons -->
        <div class="ticker-controls">
            <button type="button"
                    class="btn btn-sm"
                    id="ticker-pause-btn"
                    onclick="pauseResumeTicker()"
                    aria-label="Pause ticker"
                    title="Pause/Resume">
                <i class="fas fa-pause" id="ticker-pause-icon"></i>
            </button>
            <button type="button"
                    class="btn btn-sm"
                    onclick="showTickerSettings()"
                    aria-label="Ticker settings"
                    title="Settings">
                <i class="fas fa-cog"></i>
            </button>
            <button type="button"
                    class="btn btn-sm"
                    onclick="refreshTicker()"
                    aria-label="Refresh ticker"
                    title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button type="button"
                    class="btn btn-sm"
                    onclick="toggleTicker()"
                    aria-label="Hide ticker"
                    title="Hide">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Scrolling Content Wrapper -->
        <div class="ticker-content-wrapper">
            <!-- Loading State -->
            <div class="ticker-loading" id="ticker-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Loading articles...
            </div>

            <!-- Empty State -->
            <div class="ticker-empty" id="ticker-empty" style="display: none;">
                No recent articles available
            </div>

            <!-- Scrolling Content -->
            <div class="ticker-content"
                 id="ticker-content"
                 role="region"
                 aria-label="Scrolling news headlines">
                <!-- Ticker items dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="news-header" style="position: relative;">
        <h1 class="news-title">
            <i class="fas fa-newspaper news-title-icon"></i>
            News Narrator <span style="font-size: 0.5em; color: var(--colors-success-9); margin-left: 10px;">REDESIGNED</span>
        </h1>
        <button id="show-ticker-btn"
                class="btn btn-sm btn-outline-primary"
                onclick="NewsTicker.show()"
                style="display: none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%);"
                title="Show news ticker">
            <i class="fas fa-newspaper me-1"></i>Show Ticker
        </button>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="controls-header d-flex justify-content-between align-items-center">
            <h6>
                Configuration
            </h6>
            <button class="btn btn-sm text-decoration-none p-0" onclick="toggleControlsPanel()" title="Collapse/Expand configuration" style="background: none; border: none;">
                <i class="fas fa-caret-down" id="controlsToggleIcon" style="color: #6c757d !important;"></i>
            </button>
        </div>
        <div id="controlsContent">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Date Range:</label>
                            <select id="date-range-select" class="form-select form-select-sm" onchange="handleDateRangeChange()" style="display: none;">
                                <option value="24h">Last 24 Hours</option>
                                <option value="72h">Last 72 Hours</option>
                                <option value="7d" selected>Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="custom">Custom Date</option>
                            </select>
                            <div class="dropdown">
                                <button class="btn btn-sm dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: white; color: #333; border: 1px solid #dee2e6;">
                                    <span id="date-range-display-btn">Last 7 Days</span>
                                </button>
                                <ul class="dropdown-menu w-100">
                                    <li><a class="dropdown-item date-range-option" href="#" data-value="24h" onclick="setDateRange('24h'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>Last 24 Hours</a></li>
                                    <li><a class="dropdown-item date-range-option" href="#" data-value="72h" onclick="setDateRange('72h'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>Last 72 Hours</a></li>
                                    <li><a class="dropdown-item date-range-option" href="#" data-value="7d" onclick="setDateRange('7d'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: visible;"></i>Last 7 Days</a></li>
                                    <li><a class="dropdown-item date-range-option" href="#" data-value="30d" onclick="setDateRange('30d'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>Last 30 Days</a></li>
                                    <li><a class="dropdown-item date-range-option" href="#" data-value="custom" onclick="setDateRange('custom'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>Custom Date</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Topics:</label>
                            <!-- v2.1 - Cache bust -->
                            <div class="dropdown">
                                <button class="btn btn-sm dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center" type="button" id="topic-select-btn" data-bs-toggle="dropdown" aria-expanded="false" style="overflow: hidden; background-color: white; color: #333; border: 1px solid #dee2e6;" title="Select topics to monitor">
                                    <span id="topic-select-label" class="text-truncate" style="flex: 1;">Select Topics</span>
                                    <span id="topic-select-count" class="badge bg-dark text-white ms-2" style="display: none;">0</span>
                                </button>
                                <ul class="dropdown-menu w-100" id="topic-select-dropdown">
                                    <li><a class="dropdown-item" href="#" onclick="selectAllTopics(); return false;">
                                        <i class="fas fa-check-double me-1"></i> Select All
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="clearAllTopics(); return false;">
                                        <i class="fas fa-times me-1"></i> Clear All
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <!-- Topics will be dynamically loaded here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div id="date-range-display" class="small text-muted">
                            <i class="fas fa-clock"></i> <strong id="date-range-text">Last 90 Days</strong> 
                    (<span id="selected-date-count">loading...</span> articles)
                </div>
                <div id="custom-date-section" style="display: none;" class="mt-1">
                            <input type="date" id="custom-date-input" class="form-control form-control-sm" value="2025-09-15">
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-1" data-bs-toggle="collapse" data-bs-target="#calendar-collapse">
                        <i class="fas fa-calendar-alt"></i>
                </button>
                </div>
            </div>
            </div>
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Model:</label>
                            <select id="model-select" class="form-select form-select-sm" style="display: none;">
                                <option value="gpt-4o-mini" selected>GPT-4o Mini</option>
                                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4.1">GPT-4.1</option>
                                <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                                <option value="claude-4-sonnet-latest">Claude 4 Sonnet</option>
                                <option value="claude-3-5-sonnet-latest">Claude 3.5 Sonnet</option>
                                <option value="gemini-pro">Gemini Pro</option>
                            </select>
                            <div class="dropdown">
                                <button class="btn btn-sm dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: white; color: #333; border: 1px solid #dee2e6;">
                                    <span id="model-display-btn">GPT-4o Mini</span>
                                </button>
                                <ul class="dropdown-menu w-100">
                                    <li><a class="dropdown-item model-option" href="#" data-value="gpt-4o-mini" onclick="setModel('gpt-4o-mini'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: visible;"></i>GPT-4o Mini</a></li>
                                    <li><a class="dropdown-item model-option" href="#" data-value="gpt-4.1-mini" onclick="setModel('gpt-4.1-mini'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>GPT-4.1 Mini</a></li>
                                    <li><a class="dropdown-item model-option" href="#" data-value="gpt-4o" onclick="setModel('gpt-4o'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>GPT-4o</a></li>
                                    <li><a class="dropdown-item model-option" href="#" data-value="gpt-4.1" onclick="setModel('gpt-4.1'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>GPT-4.1</a></li>
                                    <li><a class="dropdown-item model-option" href="#" data-value="gpt-4.1-nano" onclick="setModel('gpt-4.1-nano'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>GPT-4.1 Nano</a></li>
                                    <li><a class="dropdown-item model-option" href="#" data-value="claude-4-sonnet-latest" onclick="setModel('claude-4-sonnet-latest'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>Claude 4 Sonnet</a></li>
                                    <li><a class="dropdown-item model-option" href="#" data-value="claude-3-5-sonnet-latest" onclick="setModel('claude-3-5-sonnet-latest'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>Claude 3.5 Sonnet</a></li>
                                    <li><a class="dropdown-item model-option" href="#" data-value="gemini-pro" onclick="setModel('gemini-pro'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>Gemini Pro</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Profile:</label>
                            <div class="d-flex gap-1">
                                <select id="profile-select" class="form-select form-select-sm" style="display: none;">
                                    <option value="">General Analysis</option>
                                </select>
                                <div class="dropdown flex-grow-1">
                                    <button class="btn btn-sm dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: white; color: #333; border: 1px solid #dee2e6;">
                                        <span id="profile-display-btn">General Analysis</span>
                                    </button>
                                    <ul class="dropdown-menu w-100" id="profile-dropdown-menu">
                                        <li><a class="dropdown-item profile-option" href="#" data-value="" onclick="setProfile(''); return false;"><i class="fas fa-check me-2 text-success" style="visibility: visible;"></i>General Analysis</a></li>
                                    </ul>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="showProfileManager()" title="Manage Profiles">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="saveCurrentAsDefaults()" title="Save current settings as defaults">
                                    <i class="fas fa-star"></i>
                                </button>
                            </div>
                        </div>
            </div>
                    <div class="mt-2">
                        
                    <div class="mt-2 d-flex gap-2">
                        <button id="restore-articles-btn" class="btn btn-outline-warning btn-sm" onclick="clearExcludedArticles()" style="display: none;" title="Restore hidden articles">
                            <i class="fas fa-undo"></i> Restore Hidden
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Collapsible Calendar -->
        <div class="collapse mt-3" id="calendar-collapse">
            <div class="card" style="max-width: 400px;">
                <div class="card-body">
                    <div id="calendar-loading" class="text-center text-muted p-3">
                        <i class="fas fa-spinner fa-spin"></i> Loading available dates...
                    </div>
                    <div id="calendar-view" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <input type="hidden" id="selected-date" value="2025-09-15" />
    </div>

    <!-- Tab Navigation - matching React Trend Convergence -->
    <div class="page-tab-navigation">
        <div class="tab-nav-container">
            <button class="tab-nav-btn active" id="articles-tab" data-target="articles-content" type="button" role="tab" aria-controls="articles-content" aria-selected="true">
                Article Investigator
            </button>
            <button class="tab-nav-btn" id="insights-tab" data-target="insights-content" type="button" role="tab" aria-controls="insights-content" aria-selected="false">
                Narrative Explorer
            </button>
            <button class="tab-nav-btn" id="six-articles-tab" data-target="six-articles-content" type="button" role="tab" aria-controls="six-articles-content" aria-selected="false">
                Six Articles
            </button>
        </div>
    </div>

    <!-- ========================================
         ARTICLE INVESTIGATOR TOOLBAR
         ======================================== -->
    <div id="toolbar-article-investigator" class="align-items-center justify-content-between px-3 pt-2 pb-2 bg-white border-bottom" style="gap: 8px; display: flex;">
        <div class="d-flex align-items-center gap-2">
            <strong class="small text-muted">View Options</strong>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary active" id="article-card-view-btn" onclick="toggleArticleView('cards')" title="Card view">
                    <i class="fas fa-th-large"></i>
                </button>
                <button class="btn btn-outline-primary" id="article-table-view-btn" onclick="toggleArticleView('table')" title="Table view">
                    <i class="fas fa-table"></i>
                </button>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-action-subtle dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-download"></i> Export
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportArticlesCSV()"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportArticlesPDF()"><i class="fas fa-file-pdf me-2"></i>Export PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportArticlesMarkdown()"><i class="fab fa-markdown me-2"></i>Export Markdown</a></li>
                </ul>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="filter-dropdown-btn-articles" onclick="toggleFilterDropdown()">
                <i class="fas fa-filter"></i> Filter
            </button>
        </div>
    </div>

    <!-- ========================================
         NARRATIVE EXPLORER TOOLBAR
         ======================================== -->
    <div id="toolbar-narrative-explorer" class="align-items-center justify-content-between px-3 pt-2 pb-2 bg-white border-bottom" style="gap: 8px; display: none;">
        <div class="d-flex align-items-center gap-2">
            <strong class="small text-muted">View Options</strong>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary active" id="incident-card-view-btn" onclick="toggleIncidentView('cards')" title="Card view">
                    <i class="fas fa-th-large"></i>
                </button>
                <button class="btn btn-outline-primary" id="incident-table-view-btn" onclick="toggleIncidentView('table')" title="Table view">
                    <i class="fas fa-table"></i>
                </button>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <button id="insights-generate-btn-toolbar" class="btn btn-sm btn-baby-blue" onclick="smartGenerateInsights(true)">
                <i class="fas fa-brain me-2"></i> Generate Insights
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-action-subtle dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-download"></i> Export
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportDashboardMarkdown()"><i class="fab fa-markdown me-2"></i>Export Markdown</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportDashboardPDF()"><i class="fas fa-file-pdf me-2"></i>Export PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportDashboardCSV()"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                </ul>
            </div>
            <button type="button" class="btn btn-sm btn-action-subtle" onclick="showIncidentConfigModal()" title="Configure prompt settings">
                <i class="fas fa-sliders-h"></i> Config
            </button>
            <button class="btn btn-sm btn-outline-primary" id="filter-dropdown-btn-insights" onclick="toggleFilterDropdown()">
                <i class="fas fa-filter"></i> Filter
            </button>
        </div>
    </div>

    <!-- Narrative Explorer Filter Container (matches Article Investigator pattern) -->
    <div class="position-relative" id="insights-filter-container">
        <!-- Panel created dynamically by createIncidentFilterPanel() -->
    </div>

    <!-- ========================================
         SIX ARTICLES TOOLBAR
         ======================================== -->
    <div id="toolbar-six-articles" class="align-items-center justify-content-end px-3 pt-2 pb-2 bg-white border-bottom" style="gap: 8px; display: none;">
        <div class="d-flex align-items-center gap-2">
            <button id="six-articles-generate-btn-toolbar" class="btn btn-sm btn-baby-blue" onclick="handleSixArticlesGenerate()">
                <i class="fas fa-pen me-2" id="six-articles-generate-icon-toolbar"></i>
                <span id="six-articles-generate-text-toolbar">Write</span>
            </button>
            <!-- Article Generation Settings Dropdown -->
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-action-subtle dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <ul class="dropdown-menu">
                    <li class="dropdown-header">Target Persona</li>
                    <li><a class="dropdown-item persona-option" href="#" data-persona="CEO" onclick="setPersona('CEO'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i><i class="fas fa-user-tie me-1"></i>CEO</a></li>
                    <li><a class="dropdown-item persona-option" href="#" data-persona="CMO" onclick="setPersona('CMO'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i><i class="fas fa-bullhorn me-1"></i>CMO</a></li>
                    <li><a class="dropdown-item persona-option" href="#" data-persona="CTO" onclick="setPersona('CTO'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i><i class="fas fa-laptop-code me-1"></i>CTO</a></li>
                    <li><a class="dropdown-item persona-option" href="#" data-persona="CISO" onclick="setPersona('CISO'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i><i class="fas fa-shield-alt me-1"></i>CISO</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="dropdown-header">Article Count</li>
                    <li><a class="dropdown-item count-option" href="#" data-count="3" onclick="setArticleCount(3); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>3 Articles</a></li>
                    <li><a class="dropdown-item count-option" href="#" data-count="4" onclick="setArticleCount(4); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>4 Articles</a></li>
                    <li><a class="dropdown-item count-option" href="#" data-count="5" onclick="setArticleCount(5); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>5 Articles</a></li>
                    <li><a class="dropdown-item count-option" href="#" data-count="6" onclick="setArticleCount(6); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>6 Articles (Recommended)</a></li>
                    <li><a class="dropdown-item count-option" href="#" data-count="7" onclick="setArticleCount(7); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>7 Articles</a></li>
                    <li><a class="dropdown-item count-option" href="#" data-count="8" onclick="setArticleCount(8); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>8 Articles</a></li>
                </ul>
            </div>
            <button type="button" class="btn btn-sm btn-action-subtle" onclick="showSixArticlesConfigModal()" title="Configure AI prompts and persona settings">
                <i class="fas fa-sliders-h"></i> Config
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-action-subtle dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-download"></i> Export
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportDashboardMarkdown()"><i class="fab fa-markdown me-2"></i>Export Markdown</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportSixArticlesMarkdown()"><i class="fab fa-markdown me-2"></i>Six Articles Markdown</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportSixArticlesHTML()"><i class="fas fa-code me-2"></i>Download HTML (Classic)</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportSixArticlesEnhanced()"><i class="fas fa-paint-brush me-2"></i>Download HTML (Enhanced)</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="exportDashboardPDF()"><i class="fas fa-file-pdf me-2"></i>Export to PDF</a></li>
                </ul>
            </div>
            <button type="button" class="btn btn-sm btn-action-subtle" onclick="generateSixArticlesPodcast()">
                <i class="fas fa-microphone"></i> Podcast
            </button>
        </div>
    </div>

    <!-- ========================================
         FILTER DROPDOWN PANEL (Shared)
         ======================================== -->
    <div class="position-relative">
        <div id="filter-dropdown-panel" class="filter-dropdown-panel" style="display: none; position: absolute; right: 48px; top: 0; z-index: 2000;">
            <div class="filter-dropdown-header">
                <h6 class="mb-0">Filters</h6>
                <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="toggleFilterDropdown()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="filter-dropdown-body" id="filter-dropdown-content">
                <!-- Content will be dynamically populated based on active tab -->
            </div>

            <div class="filter-dropdown-footer">
                <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
                    <i class="fas fa-times"></i> Clear All
                </button>
                <button class="btn btn-sm btn-primary" onclick="toggleFilterDropdown()">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content-area-full">
        <!-- Content -->
        <div class="tab-content" id="news-content">
            <!-- Articles Tab -->
            <div class="tab-pane fade show active" id="articles-content">
                <div id="articles-loading" class="loading" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>Loading articles...</div>
                </div>
                <div id="articles-error" class="error-message" style="display: none;"></div>

                <div id="articles-list"></div>

            <!-- Pagination Controls -->
            <div id="pagination-container" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                <div class="pagination-info">
                    <small class="text-muted">
                        Showing <span id="articles-start">1</span>-<span id="articles-end">25</span> of <span id="articles-total">0</span> articles
                    </small>
                </div>
                <div class="pagination-controls">
                    <button id="prev-page-btn" class="btn btn-outline-secondary btn-sm me-2" onclick="previousPage()" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span class="mx-2">
                        Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                    </span>
                    <button id="next-page-btn" class="btn btn-outline-secondary btn-sm ms-2" onclick="nextPage()" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Six Articles Tab -->
        <div class="tab-pane fade" id="six-articles-content">
            <!-- Hidden form elements for toolbar dropdown to reference -->
            <select id="six-articles-persona" style="display: none;" onchange="handlePersonaChange()">
                <option value="CEO" selected>CEO</option>
                <option value="CMO">CMO</option>
                <option value="CTO">CTO</option>
                <option value="CISO">CISO</option>
            </select>
            <select id="six-articles-count" style="display: none;" onchange="handleArticleCountChange()">
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6" selected>6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
            <select id="six-articles-voice" style="display: none;">
                <option value="21m00Tcm4TlvDq8ikWAM" selected>Rachel</option>
            </select>
            <select id="six-articles-length" style="display: none;">
                <option value="90" selected>90</option>
            </select>

            <div id="six-articles-loading" class="loading" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Analyzing top articles...</div>
            </div>
            <div id="six-articles-error" class="error-message" style="display: none;"></div>
            <div id="six-articles-report"></div>
        </div>

        <!-- Insights Tab -->
        <div class="tab-pane fade" id="insights-content">
            <!-- Insights Navigation -->
            <!-- Insights Sub-Navigation (Topic Analysis removed in v2) -->
            <ul class="nav nav-pills nav-fill mb-3 insights-nav" id="insights-nav">
                <li class="nav-item">
                    <a class="nav-link active" id="incident-tracking-nav" data-bs-toggle="pill" href="#incident-tracking-panel">
                        <i class="fas fa-crosshairs me-1"></i> Highlights
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="article-insights-nav" data-bs-toggle="pill" href="#article-insights-panel">
                        <i class="fas fa-lightbulb me-1"></i> Narratives
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="realtime-signals-nav" data-bs-toggle="pill" href="#realtime-signals-panel">
                        <i class="fas fa-broadcast-tower me-1"></i> Investigators
                    </a>
                </li>
            </ul>

            <!-- Insights Content -->
            <div class="tab-content" id="insights-tab-content">
                <!-- Article Insights Panel -->
                <div class="tab-pane fade" id="article-insights-panel">
                    <div id="article-insights-loading" class="loading" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Analyzing article themes...</div>
                    </div>
                    <div id="article-insights-error" class="error-message" style="display: none;"></div>
                    <div class="d-flex flex-row flex-wrap justify-content-start align-items-stretch" id="article-insights-container">
                        <div class="text-center p-5 w-100">
                            <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                            <h5>Article Theme Analysis</h5>
                            <p class="text-muted mb-3">AI-powered thematic analysis of current articles with research suggestions.</p>
                            <p class="text-muted mb-4">Select topics and date range above, then click the button below to generate insights.</p>
                            <button class="btn btn-baby-blue btn-lg" onclick="generateInsights()">
                                <i class="fas fa-magic me-2"></i>Generate Insights
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Category Insights Panel - REMOVED IN V2 -->
                <!-- This feature has been removed to simplify the UI. -->
                <!-- The multi-topic limitation made it less useful for most users. -->

                <!-- Incident Tracking Panel -->
                <div class="tab-pane fade show active" id="incident-tracking-panel">
                    <div id="incident-tracking-loading" class="loading" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Tracking incidents. This may take a few minutes.</div>
                    </div>
                    <div id="incident-tracking-error" class="error-message" style="display: none;"></div>
                    <div class="d-flex flex-row flex-wrap justify-content-start align-items-stretch" id="incident-tracking-container" style="gap: 0.5rem;">
                        <div class="text-center p-5 w-100">
                            <i class="fas fa-crosshairs fa-3x text-muted mb-3"></i>
                            <h5>Incident Tracking</h5>
                            <p class="text-muted mb-3">Track specific incidents, entities, and events for threat hunting.</p>
                            <p class="text-muted mb-4">Select topics and date range above, then click the button below to generate insights.</p>
                            <button class="btn btn-baby-blue btn-lg" onclick="generateInsights()">
                                <i class="fas fa-magic me-2"></i>Generate Insights
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Real-time Signals Panel -->
                <div class="tab-pane fade" id="realtime-signals-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-radar me-2"></i>Reporter Instructions
                        </h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-success" onclick="runAllSignals()" title="Run all active reporters">
                                <i class="fas fa-play me-1"></i>Run All
                            </button>
                            <button class="btn btn-primary" onclick="showAddSignalModal()">
                                <i class="fas fa-plus me-1"></i>Add Reporter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Signal Configuration -->
                    <div class="mb-3">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto">
                                <label class="form-label mb-0 small fw-bold">Topic:</label>
                            </div>
                            <div class="col">
                                <select id="signal-topic-select" class="form-select form-select-sm" onchange="handleSignalTopicChange()">
                                    <option value="">All Topics</option>
                                    <option value="AI and Machine Learning">AI and Machine Learning</option>
                                    <option value="Quantum Computing">Quantum Computing</option>
                                    <option value="Cybersecurity">Cybersecurity</option>
                                    <option value="Blockchain">Blockchain</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="form-label mb-0 small fw-bold">Days Back:</label>
                            </div>
                            <div class="col-auto">
                                <select id="signal-days-select" class="form-select form-select-sm" onchange="handleSignalConfigChange()">
                                    <option value="1">1 Day</option>
                                    <option value="3">3 Days</option>
                                    <option value="7" selected>7 Days</option>
                                    <option value="14">14 Days</option>
                                    <option value="30">30 Days</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-light text-dark" id="signal-article-count">0 articles</span>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-outline-info btn-sm" onclick="loadTopicsForSignals()" title="Refresh topics">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="signal-instructions-list" class="mb-3">
                        <div class="text-center p-3 text-muted">
                            <i class="fas fa-info-circle me-2"></i>No signal instructions yet. Add one to start monitoring.
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-bell me-2"></i>Signal Alerts
                        </h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="loadSignalAlerts()" title="Refresh alerts">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                            <button class="btn btn-outline-warning" onclick="acknowledgeAllAlerts()" title="Mark all as acknowledged">
                                <i class="fas fa-check me-1"></i>Ack All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Signal Alert Filters -->
                    <div id="signal-alert-filters" class="controls mb-3" style="display: none;">
                        <div class="controls-header d-flex justify-content-between align-items-center">
                            <h6>
                                <i class="fas fa-filter me-2"></i>Filter Alerts
                            </h6>
                            <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="toggleAlertFilters()" title="Collapse/Expand filters">
                                <i class="fas fa-chevron-up" id="alert-filter-collapse-icon"></i>
                            </button>
                        </div>
                        <div id="alert-filter-content" class="p-3">
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <div class="d-flex align-items-center gap-1">
                                    <span class="text-muted small">Instruction:</span>
                                    <div id="instruction-filters" class="d-flex flex-wrap gap-1"></div>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <span class="text-muted small">Threat Level:</span>
                                    <div id="threat-level-filters" class="d-flex flex-wrap gap-1"></div>
                                </div>
                                <div class="d-flex align-items-center gap-2 ms-auto">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearAlertFilters()" title="Clear all filters">
                                        <i class="fas fa-times me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="signal-alerts-list" class="mb-3">
                        <div class="text-center p-3 text-muted">
                            <i class="fas fa-info-circle me-2"></i>No alerts yet. Run signal instructions to generate alerts.
                        </div>
                    </div>
                    
                    <!-- Alerts Pagination -->
                    <div id="signal-alerts-pagination" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                        <div class="pagination-info">
                            <small class="text-muted">
                                Showing <span id="alerts-start">1</span>-<span id="alerts-end">10</span> of <span id="alerts-total">0</span> alerts
                            </small>
                        </div>
                        <div class="pagination-controls">
                            <button id="prev-alerts-btn" class="btn btn-outline-secondary btn-sm me-2" onclick="previousAlertsPage()" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span class="mx-2">
                                Page <span id="current-alerts-page">1</span> of <span id="total-alerts-pages">1</span>
                            </span>
                            <button id="next-alerts-btn" class="btn btn-outline-secondary btn-sm ms-2" onclick="nextAlertsPage()" disabled>
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div id="realtime-signals-loading" class="loading" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Analyzing signals...</div>
                    </div>
                    <div id="realtime-signals-error" class="error-message" style="display: none;"></div>
                    <div class="d-flex flex-row flex-wrap justify-content-start align-items-stretch" id="realtime-signals-container">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div><!-- END main-content-area -->
    </div><!-- END page-layout-container -->

<!-- Add Signal Instruction Modal -->
<div class="modal fade" id="addSignalModal" tabindex="-1" aria-labelledby="addSignalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSignalModalLabel">Add Signal Instruction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="signalName" class="form-label">Signal Name</label>
                    <input type="text" class="form-control" id="signalName" placeholder="e.g., Elon Musk AI Mentions">
                    <div class="form-text">Give your signal a descriptive name</div>
                </div>
                <div class="mb-3">
                    <label for="signalDescription" class="form-label">Description</label>
                    <input type="text" class="form-control" id="signalDescription" placeholder="What this signal watches for">
                    <div class="form-text">Brief description of the monitoring purpose</div>
                </div>
                <div class="mb-3">
                    <label for="signalTopic" class="form-label">Topic</label>
                    <select class="form-select" id="signalTopic">
                        <option value="">All Topics (Global Signal)</option>
                        <option value="AI and Machine Learning">AI and Machine Learning</option>
                        <option value="Quantum Computing">Quantum Computing</option>
                        <option value="Cybersecurity">Cybersecurity</option>
                        <option value="Blockchain">Blockchain</option>
                    </select>
                    <div class="form-text">Choose which topic this signal applies to</div>
                </div>
                <div class="mb-3">
                    <label for="signalInstruction" class="form-label">LLM Instruction</label>
                    <textarea class="form-control" id="signalInstruction" rows="4" 
                        placeholder="Flag any articles that mention Elon Musk, especially regarding AI, Tesla, or SpaceX developments. Look for direct quotes, business decisions, or policy statements."></textarea>
                    <div class="form-text">Detailed instruction for the AI to follow when analyzing articles</div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="signalActive" checked>
                    <label class="form-check-label" for="signalActive">
                        Active (monitor this signal)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSignalInstruction()">Save Signal</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Feed Modal -->
<div class="modal fade" id="saveFeedModal" tabindex="-1" aria-labelledby="saveFeedModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveFeedModalLabel">Save News Feed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Save this news feed for later viewing:</p>
                <div class="mb-3">
                    <label for="feedNameInput" class="form-label">Feed Name:</label>
                    <input type="text" class="form-control" id="feedNameInput" placeholder="e.g., AI News Sept 12, 2025">
                </div>
                <div class="mb-3">
                    <label for="feedDescriptionInput" class="form-label">Description (optional):</label>
                    <textarea class="form-control" id="feedDescriptionInput" rows="3" placeholder="Brief description of this feed..."></textarea>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeArticles" checked>
                    <label class="form-check-label" for="includeArticles">
                        Include article list
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeSixArticles" checked>
                    <label class="form-check-label" for="includeSixArticles">
                        Include six articles analysis
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFeedBtn">Save Feed</button>
            </div>
        </div>
    </div>
</div>

<!-- Saved Feeds Modal -->
<div class="modal fade" id="savedFeedsModal" tabindex="-1" aria-labelledby="savedFeedsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savedFeedsModalLabel">Saved News Feeds</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="savedFeedsList">
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-bookmark fa-2x mb-3"></i>
                        <p>No saved feeds yet.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-danger" id="clearAllFeeds">Clear All</button>
            </div>
        </div>
    </div>
</div>

<!-- Incident Tracking Configuration Modal -->
<div class="modal fade" id="incidentConfigModal" tabindex="-1" aria-labelledby="incidentConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incidentConfigModalLabel">
                    <i class="fas fa-cogs me-2"></i>
                    Configure Incident Tracking
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Navigation tabs for different configuration sections -->
                <ul class="nav nav-tabs" id="incidentConfigTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-panel" type="button" role="tab">
                            <i class="fas fa-info-circle me-1"></i>Info
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="prompt-tab" data-bs-toggle="tab" data-bs-target="#prompt-panel" type="button" role="tab">
                            <i class="fas fa-comment-dots me-1"></i>System Prompt
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ontology-tab" data-bs-toggle="tab" data-bs-target="#ontology-panel" type="button" role="tab">
                            <i class="fas fa-sitemap me-1"></i>Ontology
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="guidance-tab" data-bs-toggle="tab" data-bs-target="#guidance-panel" type="button" role="tab">
                            <i class="fas fa-lightbulb me-1"></i>AI Guidance
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="incidentConfigTabContent">
                    <!-- Info Panel -->
                    <div class="tab-pane fade" id="info-panel" role="tabpanel">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle me-2"></i>About Incident Tracking Configuration</h5>
                            <p class="mb-2">This configuration panel controls how the AI analyzes your articles to identify incidents, trends, entities, and emerging narratives.</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-comment-dots me-2 text-primary"></i>System Prompt</h6>
                                        <p class="card-text small">The core instructions that guide the AI's analysis approach. Defines what the AI should look for, how it should structure findings, and what patterns to identify in your content.</p>
                                        <p class="card-text small mb-0"><strong>Use this when:</strong> You want to change what types of incidents are detected or how they're categorized.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-sitemap me-2 text-success"></i>Ontology</h6>
                                        <p class="card-text small">Defines the vocabulary, entity types, and relationships the AI should recognize. Think of it as teaching the AI your domain's language and important concepts.</p>
                                        <p class="card-text small mb-0"><strong>Use this when:</strong> You need domain-specific terminology or want the AI to recognize specialized entities.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-lightbulb me-2 text-warning"></i>AI Guidance</h6>
                                        <p class="card-text small">Additional instructions and examples that refine the AI's behavior. Helps improve accuracy and consistency of analysis across different types of content.</p>
                                        <p class="card-text small mb-0"><strong>Use this when:</strong> Fine-tuning analysis quality or providing domain-specific examples.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-building me-2 text-info"></i>Organizational Profile</h6>
                                        <p class="card-text small">Context about your organization, industry, and strategic priorities. Helps the AI provide analysis relevant to your specific situation and goals.</p>
                                        <p class="card-text small mb-0"><strong>Use this when:</strong> You want analysis tailored to your organization's context and priorities.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notes</h6>
                            <ul class="mb-0 small">
                                <li>Changes to prompts and ontology affect all future analyses, not existing results</li>
                                <li>Use the template variables (like {topic}, {ontology_text}) to make prompts dynamic</li>
                                <li>Test changes with a small dataset before running on all your content</li>
                                <li>You can reset to defaults using the action buttons in each configuration section</li>
                            </ul>
                        </div>
                    </div>

                    <!-- System Prompt Panel -->
                    <div class="tab-pane fade show active" id="prompt-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold">System Prompt Template</h6>
                                <p class="text-muted small">
                                    Customize the system prompt used for incident tracking analysis. Use {topic} and {ontology_text} as placeholders.
                                </p>
                                <textarea id="incidentSystemPrompt" class="form-control" rows="15" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;"></textarea>
                                
                                <div class="mt-3">
                                    <h6 class="fw-bold">User Prompt Template</h6>
                                    <p class="text-muted small">
                                        Customize how articles are presented to the AI. Use {topic} and {articles_text} as placeholders.
                                    </p>
                                    <textarea id="incidentUserPrompt" class="form-control" rows="3" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;"></textarea>
                                </div>
                                
                                <div class="mt-3">
                                    <h6 class="fw-bold">Organizational Profile Integration</h6>
                                    <p class="text-muted small">
                                        Configure how organizational profiles are integrated into the analysis context.
                                    </p>
                                    <div class="mb-2">
                                        <label class="form-label">Profile Context Template:</label>
                                        <textarea id="profileContextTemplate" class="form-control" rows="4" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Template for how profile information is included in prompts..."></textarea>
                                        <small class="text-muted">Use {profile_name}, {industry}, {key_concerns}, {strategic_priorities}, etc. as placeholders</small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableProfileIntegration" checked>
                                        <label class="form-check-label" for="enableProfileIntegration">
                                            Enable organizational profile integration
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-info-circle me-1"></i>Available Placeholders</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <code>{topic}</code>
                                            <small class="d-block text-muted">Current analysis topic</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{ontology_text}</code>
                                            <small class="d-block text-muted">Generated ontology guidance</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{articles_text}</code>
                                            <small class="d-block text-muted">Formatted article content</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{profile_context}</code>
                                            <small class="d-block text-muted">Organizational profile context</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{analysis_instructions}</code>
                                            <small class="d-block text-muted">AI analysis instructions</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{quality_guidelines}</code>
                                            <small class="d-block text-muted">Quality control guidelines</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-history me-1"></i>Template Actions</h6>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="loadDefaultPromptTemplate()">
                                            <i class="fas fa-undo me-1"></i>Reset to Default
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="previewPrompt()">
                                            <i class="fas fa-eye me-1"></i>Preview with Sample Data
                                        </button>
                                        <button class="btn btn-outline-success btn-sm w-100" onclick="validatePromptTemplate()">
                                            <i class="fas fa-check me-1"></i>Validate Template
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ontology Panel -->
                    <div class="tab-pane fade" id="ontology-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold">Ontology Configuration</h6>
                                <p class="text-muted small">
                                    Define the types, subtypes, and classification rules for incident tracking.
                                </p>
                                
                                <!-- Base Ontology -->
                                <div class="mb-4">
                                    <h6>Base Ontology</h6>
                                    <textarea id="baseOntology" class="form-control" rows="12" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;"></textarea>
                                </div>
                                
                                <!-- Domain Overlays -->
                                <div class="mb-4">
                                    <h6>Domain-Specific Overlays</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Domain Key:</label>
                                        <input type="text" id="domainKey" class="form-control" placeholder="e.g., scientific_publisher, finance, healthcare">
                                        <small class="text-muted">Use 'vanilla' for no domain-specific overlay</small>
                                    </div>
                                    <textarea id="domainOverlay" class="form-control" rows="8" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Domain-specific rules and examples..."></textarea>
                                </div>
                                
                                <!-- Examples -->
                                <div class="mb-4">
                                    <h6>Classification Examples</h6>
                                    <textarea id="ontologyExamples" class="form-control" rows="6" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-layer-group me-1"></i>Ontology Structure</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>7-Type Classification:</strong>
                                            <ul class="list-unstyled ms-2 small">
                                                <li><code>incident</code> - Disruptive occurrences requiring response</li>
                                                <li><code>event</code> - Noteworthy developments and announcements</li>
                                                <li><code>entity</code> - Organizations, people, products tracked</li>
                                                <li><code>expertise</code> - Expert analysis and authoritative insights</li>
                                                <li><code>informed_insider</code> - Insider perspectives and leaks</li>
                                                <li><code>trend_signal</code> - Market trends and behavioral shifts</li>
                                                <li><code>strategic_shift</code> - Major strategic and policy changes</li>
                                            </ul>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Required Fields:</strong>
                                            <ul class="list-unstyled ms-2 small">
                                                <li>name, type, subtype</li>
                                                <li>description, timeline</li>
                                                <li>significance, plausibility</li>
                                                <li>investigation_leads</li>
                                                <li>source_quality, misinfo_flags</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-tools me-1"></i>Ontology Actions</h6>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="loadDefaultOntology()">
                                            <i class="fas fa-undo me-1"></i>Reset to Default
                                        </button>
                                        <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="addDomainOverlay()">
                                            <i class="fas fa-plus me-1"></i>Add Domain Overlay
                                        </button>
                                        <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="validateOntology()">
                                            <i class="fas fa-check me-1"></i>Validate Structure
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Guidance Panel -->
                    <div class="tab-pane fade" id="guidance-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold">Analysis Guidance</h6>
                                <p class="text-muted small">
                                    Provide specific instructions and examples to guide the AI's analysis behavior.
                                </p>
                                
                                <div class="mb-4">
                                    <h6>Analysis Instructions</h6>
                                    <textarea id="analysisInstructions" class="form-control" rows="8" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Specific instructions for how the AI should analyze articles and classify incidents..."></textarea>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Quality Control Guidelines</h6>
                                    <textarea id="qualityGuidelines" class="form-control" rows="6" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Guidelines for assessing credibility, handling extraordinary claims, source quality evaluation..."></textarea>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Output Format Requirements</h6>
                                    <textarea id="outputFormat" class="form-control" rows="4" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;" placeholder="Specific JSON structure and formatting requirements..."></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-brain me-1"></i>Best Practices</h6>
                                    </div>
                                    <div class="card-body small">
                                        <div class="mb-3">
                                            <strong>Analysis Quality:</strong>
                                            <ul class="list-unstyled ms-2">
                                                <li>â€¢ Be specific about credibility assessment</li>
                                                <li>â€¢ Include source quality indicators</li>
                                                <li>â€¢ Flag extraordinary claims</li>
                                                <li>â€¢ Provide investigation leads</li>
                                                <li>â€¢ Be inclusive rather than restrictive</li>
                                            </ul>
                                        </div>
                                        <div class="mb-3">
                                            <strong>7-Type Classification:</strong>
                                            <ul class="list-unstyled ms-2">
                                                <li>â€¢ <strong>Incident</strong>: Immediate response needed</li>
                                                <li>â€¢ <strong>Event</strong>: Significant developments</li>
                                                <li>â€¢ <strong>Entity</strong>: Organizations/people tracked</li>
                                                <li>â€¢ <strong>Expertise</strong>: Expert insights/warnings</li>
                                                <li>â€¢ <strong>Informed Insider</strong>: Privileged information</li>
                                                <li>â€¢ <strong>Trend Signal</strong>: Market/behavioral patterns</li>
                                                <li>â€¢ <strong>Strategic Shift</strong>: Major strategic changes</li>
                                            </ul>
                                        </div>
                                        <div class="mb-3">
                                            <strong>Profile Context:</strong>
                                            <ul class="list-unstyled ms-2">
                                                <li>â€¢ Consider organizational priorities</li>
                                                <li>â€¢ Align with risk tolerance</li>
                                                <li>â€¢ Focus on relevant stakeholders</li>
                                                <li>â€¢ Account for industry context</li>
                                                <li>â€¢ Tailor investigation leads</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-flask me-1"></i>Testing</h6>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="testWithSampleArticles()">
                                            <i class="fas fa-play me-1"></i>Test with Sample Articles
                                        </button>
                                        <button class="btn btn-outline-info btn-sm w-100" onclick="showGuidanceExamples()">
                                            <i class="fas fa-book me-1"></i>View Examples
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-warning" onclick="resetAllToDefaults()">
                    <i class="fas fa-undo me-1"></i>Reset All to Defaults
                </button>
                <button type="button" class="btn btn-primary" onclick="saveIncidentConfiguration()">
                    <i class="fas fa-save me-1"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Six Articles Configuration Modal -->
<div class="modal fade" id="sixArticlesConfigModal" tabindex="-1" aria-labelledby="sixArticlesConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sixArticlesConfigModalLabel">
                    <i class="fas fa-newspaper me-2"></i>
                    Configure Six Articles Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Navigation tabs for different configuration sections -->
                <ul class="nav nav-tabs" id="sixArticlesConfigTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="six-prompt-tab" data-bs-toggle="tab" data-bs-target="#six-prompt-panel" type="button" role="tab">
                            <i class="fas fa-comment-dots me-1"></i>System Prompt
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="six-personas-tab" data-bs-toggle="tab" data-bs-target="#six-personas-panel" type="button" role="tab">
                            <i class="fas fa-users me-1"></i>Personas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="six-format-tab" data-bs-toggle="tab" data-bs-target="#six-format-panel" type="button" role="tab">
                            <i class="fas fa-file-code me-1"></i>Output Format
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="six-rationale-tab" data-bs-toggle="tab" data-bs-target="#six-rationale-panel" type="button" role="tab">
                            <i class="fas fa-info-circle me-1"></i>Why Six Articles?
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="sixArticlesConfigTabContent">
                    <!-- System Prompt Panel -->
                    <div class="tab-pane fade show active" id="six-prompt-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold">Analyst Prompt Template</h6>
                                <p class="text-muted small">
                                    Customize the system prompt used for Six Articles analysis. Available placeholders: {persona}, {article_count}, {audience_profile}, {articles_summary}
                                </p>
                                <textarea id="sixArticlesSystemPrompt" class="form-control" rows="20" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 11px;"></textarea>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-info-circle me-1"></i>Available Placeholders</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <code>{persona}</code>
                                            <small class="d-block text-muted">Target persona (CEO, CMO, CTO, CISO)</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{article_count}</code>
                                            <small class="d-block text-muted">Number of articles to select (1-8)</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{audience_profile}</code>
                                            <small class="d-block text-muted">Organizational profile context</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{articles_summary}</code>
                                            <small class="d-block text-muted">Corpus of candidate articles</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{persona_priorities}</code>
                                            <small class="d-block text-muted">Persona-specific priorities</small>
                                        </div>
                                        <div class="mb-2">
                                            <code>{starred_instruction}</code>
                                            <small class="d-block text-muted">Instructions for starred articles</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="card bg-light mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-history me-1"></i>Template Actions</h6>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="loadDefaultSixArticlesPrompt()">
                                            <i class="fas fa-undo me-1"></i>Reset to Default
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="previewSixArticlesPrompt()">
                                            <i class="fas fa-eye me-1"></i>Preview with Sample Data
                                        </button>
                                        <button class="btn btn-outline-success btn-sm w-100" onclick="validateSixArticlesPrompt()">
                                            <i class="fas fa-check me-1"></i>Validate Template
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Personas Panel -->
                    <div class="tab-pane fade" id="six-personas-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-12">
                                <h6 class="fw-bold">Persona Definitions</h6>
                                <p class="text-muted small">
                                    Define or customize the characteristics, priorities, and focus areas for each persona.
                                </p>

                                <!-- CEO Persona -->
                                <div class="mb-4">
                                    <h6 class="text-primary"><i class="fas fa-user-tie me-2"></i>CEO (Chief Executive Officer)</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label small">Priorities:</label>
                                            <textarea id="ceoPersonaPriorities" class="form-control form-control-sm" rows="2" placeholder="e.g., Regulation, enterprise adoption, market dynamics..."></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Risk Appetite:</label>
                                            <select id="ceoRiskAppetite" class="form-select form-select-sm">
                                                <option value="low">Low (Conservative)</option>
                                                <option value="moderate" selected>Moderate (Balanced)</option>
                                                <option value="high">High (Aggressive)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label small">Focus Areas:</label>
                                        <textarea id="ceoFocus" class="form-control form-control-sm" rows="2" placeholder="e.g., business strategy, market positioning, competitive advantage..."></textarea>
                                    </div>
                                </div>

                                <!-- CMO Persona -->
                                <div class="mb-4">
                                    <h6 class="text-success"><i class="fas fa-bullhorn me-2"></i>CMO (Chief Marketing Officer)</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label small">Priorities:</label>
                                            <textarea id="cmoPersonaPriorities" class="form-control form-control-sm" rows="2" placeholder="e.g., Market trends, customer behavior, brand impact..."></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Risk Appetite:</label>
                                            <select id="cmoRiskAppetite" class="form-select form-select-sm">
                                                <option value="low">Low (Conservative)</option>
                                                <option value="moderate">Moderate (Balanced)</option>
                                                <option value="high" selected>High (Aggressive)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label small">Focus Areas:</label>
                                        <textarea id="cmoFocus" class="form-control form-control-sm" rows="2" placeholder="e.g., marketing strategies, customer engagement, brand differentiation..."></textarea>
                                    </div>
                                </div>

                                <!-- CTO Persona -->
                                <div class="mb-4">
                                    <h6 class="text-info"><i class="fas fa-code me-2"></i>CTO (Chief Technology Officer)</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label small">Priorities:</label>
                                            <textarea id="ctoPersonaPriorities" class="form-control form-control-sm" rows="2" placeholder="e.g., Technical breakthroughs, infrastructure, scalability..."></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Risk Appetite:</label>
                                            <select id="ctoRiskAppetite" class="form-select form-select-sm">
                                                <option value="low">Low (Conservative)</option>
                                                <option value="moderate">Moderate (Balanced)</option>
                                                <option value="high" selected>High (Aggressive)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label small">Focus Areas:</label>
                                        <textarea id="ctoFocus" class="form-control form-control-sm" rows="2" placeholder="e.g., technical architecture, development practices, engineering excellence..."></textarea>
                                    </div>
                                </div>

                                <!-- CISO Persona -->
                                <div class="mb-4">
                                    <h6 class="text-danger"><i class="fas fa-shield-alt me-2"></i>CISO (Chief Information Security Officer)</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label small">Priorities:</label>
                                            <textarea id="cisoPersonaPriorities" class="form-control form-control-sm" rows="2" placeholder="e.g., Security threats, vulnerabilities, compliance..."></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Risk Appetite:</label>
                                            <select id="cisoRiskAppetite" class="form-select form-select-sm">
                                                <option value="low" selected>Low (Conservative)</option>
                                                <option value="moderate">Moderate (Balanced)</option>
                                                <option value="high">High (Aggressive)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label small">Focus Areas:</label>
                                        <textarea id="cisoFocus" class="form-control form-control-sm" rows="2" placeholder="e.g., security risks, compliance requirements, threat mitigation..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Output Format Panel -->
                    <div class="tab-pane fade" id="six-format-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold">JSON Output Format Specification</h6>
                                <p class="text-muted small">
                                    Define the required JSON schema and field constraints for Six Articles output.
                                </p>
                                <textarea id="sixArticlesFormatSpec" class="form-control" rows="18" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 11px;"></textarea>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-check-circle me-1"></i>Required Fields</h6>
                                    </div>
                                    <div class="card-body small">
                                        <ul class="list-unstyled">
                                            <li class="mb-1"><code>title</code> - With source & date</li>
                                            <li class="mb-1"><code>source</code> - Publisher name</li>
                                            <li class="mb-1"><code>date</code> - YYYY-MM-DD</li>
                                            <li class="mb-1"><code>url</code> - Canonical URL</li>
                                            <li class="mb-1"><code>executive_takeaway</code> - ~15 words</li>
                                            <li class="mb-1"><code>summary</code> - 2-3 sentences</li>
                                            <li class="mb-1"><code>strategic_relevance</code> - Why it matters</li>
                                            <li class="mb-1"><code>time_horizon</code> - Immediate/Medium/Long-term</li>
                                            <li class="mb-1"><code>risk_opportunity</code> - risk/opportunity/mixed</li>
                                            <li class="mb-1"><code>signal_strength</code> - weak/moderate/strong</li>
                                            <li class="mb-1"><code>executive_action</code> - Array of actions</li>
                                            <li class="mb-1"><code>category</code> - policy/market/tech/etc</li>
                                            <li class="mb-1"><code>scores</code> - Relevance/novelty/credibility/rep</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rationale Panel -->
                    <div class="tab-pane fade" id="six-rationale-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <h6 class="fw-bold"><i class="fas fa-lightbulb me-2"></i>Why "Six Articles"?</h6>
                                    <p class="mb-2">
                                        News isn't just background noise. It's the <strong>raw material for forecasting, risk management, and stakeholder engagement</strong>.
                                        For any leader tasked with briefing the C-Suite, the bar is high: every summary must be <strong>razor-sharp</strong>, every alert <strong>perfectly timed</strong>.
                                    </p>
                                </div>

                                <h6 class="fw-bold mt-3">The Research: News as Strategic Intelligence</h6>
                                <p>
                                    According to the <a href="https://www.stagwellglobal.com/ceos-and-board-directors-view-news-media-as-powerful-advertising-tool-to-influence-key-stakeholders-and-say-brand-safety-is-overapplied-reveals-stagwell-future-of-news-stgw-study" target="_blank" rel="noopener">Stagwell "Future of News" Study</a>,
                                    <strong>CEOs and board directors view news media as a powerful tool to influence key stakeholders</strong>. The study reveals that C-Suite executives consistently rely on news for:
                                </p>
                                <ul>
                                    <li><strong>Forecasting</strong> - Identifying emerging trends before they become mainstream</li>
                                    <li><strong>Risk Management</strong> - Early detection of regulatory, competitive, and reputational threats</li>
                                    <li><strong>Stakeholder Engagement</strong> - Understanding how different narratives shape investor, customer, and employee perceptions</li>
                                </ul>

                                <h6 class="fw-bold mt-3">The Sweet Spot: Why Six?</h6>
                                <p>
                                    The number "six" is not arbitrary. Research in cognitive science and executive decision-making shows that:
                                </p>
                                <ul>
                                    <li><strong>Cognitive Load</strong> - Executives can effectively process 5-9 distinct items in working memory (Miller's Law)</li>
                                    <li><strong>Diversity</strong> - Six articles allows coverage of multiple domains (policy, market, tech, workforce, security, society) without overwhelming</li>
                                    <li><strong>Time Constraint</strong> - Reading 6 curated articles with executive takeaways takes approximately 8-12 minutesâ€”ideal for morning briefings</li>
                                    <li><strong>Decision Quality</strong> - Studies show that decision quality plateaus after 5-7 data points; more information adds noise without improving outcomes</li>
                                </ul>

                                <div class="alert alert-success mt-3">
                                    <h6 class="fw-bold"><i class="fas fa-check-circle me-2"></i>Design Principles</h6>
                                    <p class="mb-1"><strong>Comprehensive Without Overwhelming</strong> - Six articles cover breadth without drowning in detail</p>
                                    <p class="mb-1"><strong>Actionable Intelligence</strong> - Each article includes executive actions and strategic relevance</p>
                                    <p class="mb-1"><strong>Persona-Specific</strong> - Tailored to the priorities and risk appetite of different C-Suite roles</p>
                                    <p class="mb-0"><strong>Time-Respecting</strong> - Optimized for busy executives who need insights, not information</p>
                                </div>

                                <h6 class="fw-bold mt-3">Flexibility Beyond Six</h6>
                                <p>
                                    While "six" is the research-backed sweet spot, this system allows 1-8 articles to accommodate different use cases:
                                </p>
                                <ul>
                                    <li><strong>1-2 articles</strong> - Crisis mode: focus on immediate threats</li>
                                    <li><strong>3-4 articles</strong> - Quick daily scan for time-constrained executives</li>
                                    <li><strong>6 articles</strong> - Optimal balance (recommended default)</li>
                                    <li><strong>7-8 articles</strong> - Deep dive mode for research-intensive roles or weekly digests</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-warning" onclick="resetSixArticlesToDefaults()">
                    <i class="fas fa-undo me-1"></i>Reset All to Defaults
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSixArticlesConfiguration()">
                    <i class="fas fa-save me-1"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Profile Management Modal -->
<div class="modal fade" id="profileManagerModal" tabindex="-1" aria-labelledby="profileManagerModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileManagerModalLabel">ðŸ¢ Organizational Profile Manager</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Profile List -->
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Profiles</h6>
                            <button type="button" class="btn btn-primary btn-sm" onclick="createNewProfile()">
                                <i class="fas fa-plus me-1"></i>New
                            </button>
                        </div>
                        <div class="list-group" id="profileList">
                            <!-- Profiles will be loaded here -->
                        </div>
                    </div>

                    <!-- Profile Editor -->
                    <div class="col-md-8">
                        <div id="profileEditor" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0" id="editorTitle">New Profile</h6>
                                <div>
                                    <button type="button" class="btn btn-success btn-sm" onclick="saveProfile()">
                                        <i class="fas fa-save me-1"></i>Save
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelEdit()">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </button>
                                </div>
                            </div>

                            <form id="profileForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileName" class="form-label">Name *</label>
                                            <input type="text" class="form-control" id="profileName" required>
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileIndustry" class="form-label">Industry</label>
                                            <input type="text" class="form-control" id="profileIndustry"
                                                   placeholder="e.g., Academic Publishing, Technology, Healthcare">
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileOrganizationType" class="form-label">Organization Type</label>
                                            <select class="form-select" id="profileOrganizationType">
                                                <option value="">Select type...</option>
                                                <option value="publisher">Publisher</option>
                                                <option value="enterprise">Enterprise</option>
                                                <option value="startup">Startup</option>
                                                <option value="government">Government</option>
                                                <option value="ngo">Non-Profit/NGO</option>
                                                <option value="academic">Academic Institution</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileRiskTolerance" class="form-label">Risk Tolerance</label>
                                            <select class="form-select" id="profileRiskTolerance">
                                                <option value="low">Conservative (Low Risk)</option>
                                                <option value="medium" selected>Balanced (Medium Risk)</option>
                                                <option value="high">Aggressive (High Risk)</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileInnovationAppetite" class="form-label">Innovation Appetite</label>
                                            <select class="form-select" id="profileInnovationAppetite">
                                                <option value="conservative">Conservative</option>
                                                <option value="moderate" selected>Moderate</option>
                                                <option value="aggressive">Aggressive</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileRegion" class="form-label">Region</label>
                                            <select class="form-select" id="profileRegion">
                                                <option value="">Select region...</option>
                                                <option value="global">Global</option>
                                                <option value="north_america">North America</option>
                                                <option value="europe">Europe</option>
                                                <option value="asia_pacific">Asia Pacific</option>
                                                <option value="latin_america">Latin America</option>
                                                <option value="middle_east_africa">Middle East & Africa</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileDecisionMakingStyle" class="form-label">Decision Making Style</label>
                                            <select class="form-select" id="profileDecisionMakingStyle">
                                                <option value="collaborative" selected>Collaborative</option>
                                                <option value="data-driven">Data-Driven</option>
                                                <option value="hierarchical">Hierarchical</option>
                                                <option value="agile">Agile</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileDescription" class="form-label">Description</label>
                                            <textarea class="form-control" id="profileDescription" rows="3"
                                                    placeholder="Brief description of the organization"></textarea>
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileKeyConcerns" class="form-label">Key Concerns</label>
                                            <textarea class="form-control" id="profileKeyConcerns" rows="3"
                                                    placeholder="Enter concerns separated by commas (e.g., R&D funding, copyright protection, peer review)"></textarea>
                                            <div class="form-text">Separate multiple concerns with commas</div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileStrategicPriorities" class="form-label">Strategic Priorities</label>
                                            <textarea class="form-control" id="profileStrategicPriorities" rows="3"
                                                    placeholder="Enter priorities separated by commas (e.g., digital transformation, market expansion)"></textarea>
                                            <div class="form-text">Separate multiple priorities with commas</div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="profileStakeholderFocus" class="form-label">Key Stakeholders</label>
                                            <textarea class="form-control" id="profileStakeholderFocus" rows="2"
                                                    placeholder="Enter stakeholders separated by commas (e.g., researchers, authors, subscribers)"></textarea>
                                            <div class="form-text">Separate multiple stakeholders with commas</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileCompetitiveLandscape" class="form-label">Competitive Landscape</label>
                                            <textarea class="form-control" id="profileCompetitiveLandscape" rows="2"
                                                    placeholder="Key competitors and market dynamics (comma-separated)"></textarea>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="profileRegulatoryEnvironment" class="form-label">Regulatory Environment</label>
                                            <textarea class="form-control" id="profileRegulatoryEnvironment" rows="2"
                                                    placeholder="Key regulations and compliance requirements (comma-separated)"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="profileCustomContext" class="form-label">Additional Context</label>
                                    <textarea class="form-control" id="profileCustomContext" rows="3"
                                            placeholder="Any additional context or specific considerations for this organization"></textarea>
                                </div>
                            </form>
                        </div>

                        <div id="profileEditorPlaceholder" class="text-center text-muted py-5">
                            <i class="fas fa-building fa-3x mb-3 opacity-50"></i>
                            <p>Select a profile to edit or create a new one</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================
     TICKER SETTINGS MODAL
     ============================================ -->
<div class="modal fade"
     id="tickerSettingsModal"
     tabindex="-1"
     aria-labelledby="tickerSettingsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tickerSettingsModalLabel">
                    <i class="fas fa-cog me-2"></i>News Ticker Settings
                </h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ticker-settings-form">
                    <!-- Article Count -->
                    <div class="mb-3">
                        <label for="ticker-article-count" class="form-label">
                            <i class="fas fa-list-ol me-1"></i>Number of Articles:
                        </label>
                        <select id="ticker-article-count" class="form-select" required>
                            <option value="5">5 articles</option>
                            <option value="10" selected>10 articles</option>
                            <option value="15">15 articles</option>
                            <option value="20">20 articles</option>
                            <option value="25">25 articles</option>
                        </select>
                        <div class="form-text">
                            More articles = longer scroll cycle
                        </div>
                    </div>

                    <!-- Time Range -->
                    <div class="mb-3">
                        <label for="ticker-time-range" class="form-label">
                            <i class="fas fa-clock me-1"></i>Time Range:
                        </label>
                        <select id="ticker-time-range" class="form-select" required>
                            <option value="1h">Last Hour</option>
                            <option value="6h">Last 6 Hours</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="72h">Last 3 Days</option>
                            <option value="7d">Last 7 Days</option>
                        </select>
                    </div>

                    <!-- Topic Filter -->
                    <div class="mb-3">
                        <label for="ticker-topic-filter" class="form-label">
                            <i class="fas fa-filter me-1"></i>Topic Filter:
                        </label>
                        <select id="ticker-topic-filter" class="form-select">
                            <option value="">All Topics</option>
                            <!-- Topics loaded dynamically -->
                        </select>
                        <div class="form-text">
                            Leave blank to show all topics
                        </div>
                    </div>

                    <!-- Scroll Speed -->
                    <div class="mb-3">
                        <label for="ticker-speed" class="form-label">
                            <i class="fas fa-tachometer-alt me-1"></i>Scroll Speed:
                        </label>
                        <select id="ticker-speed" class="form-select" required>
                            <option value="lazy" selected>Lazy (120 seconds)</option>
                            <option value="slow">Slow (90 seconds)</option>
                            <option value="medium">Medium (60 seconds)</option>
                            <option value="fast">Fast (30 seconds)</option>
                        </select>
                        <div class="form-text">
                            Slower speeds are easier to read
                        </div>
                    </div>

                    <!-- Auto-Refresh -->
                    <div class="mb-3">
                        <label for="ticker-refresh-interval" class="form-label">
                            <i class="fas fa-sync-alt me-1"></i>Auto-Refresh:
                        </label>
                        <select id="ticker-refresh-interval" class="form-select" required>
                            <option value="0">Disabled</option>
                            <option value="60">Every 1 minute</option>
                            <option value="300" selected>Every 5 minutes</option>
                            <option value="600">Every 10 minutes</option>
                            <option value="1800">Every 30 minutes</option>
                        </select>
                        <div class="form-text">
                            Automatically load new articles
                        </div>
                    </div>

                    <!-- Display Options -->
                    <div class="mb-3">
                        <label class="form-label">Display Options:</label>
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="ticker-show-source"
                                   checked>
                            <label class="form-check-label" for="ticker-show-source">
                                Show article source
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="ticker-show-time"
                                   checked>
                            <label class="form-check-label" for="ticker-show-time">
                                Show publish time
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="ticker-show-topic">
                            <label class="form-check-label" for="ticker-show-topic">
                                Show topic tags
                            </label>
                        </div>
                    </div>

                    <!-- Enable on Load -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="ticker-enabled"
                                   checked>
                            <label class="form-check-label" for="ticker-enabled">
                                <strong>Enable ticker on page load</strong>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button"
                        class="btn btn-outline-danger"
                        onclick="resetTickerSettings()">
                    <i class="fas fa-undo me-1"></i>Reset to Defaults
                </button>
                <button type="button"
                        class="btn btn-primary"
                        onclick="saveTickerSettings()">
                    <i class="fas fa-save me-1"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

    </div> <!-- Close news-feed-scrollable -->
</div> <!-- Close news-feed-container -->

<script>
// Global fetch wrapper to surface rate-limit (HTTP 429) errors to users
(function enhanceGlobalFetchForRateLimit(){
    if (window.__fetchRateLimitWrapped) return;
    window.__fetchRateLimitWrapped = true;
    const originalFetch = window.fetch.bind(window);
    window.fetch = async function(input, init) {
        try {
            const response = await originalFetch(input, init);
            if (response && response.status === 429) {
                let apiMsg = '';
                try {
                    const cloned = response.clone();
                    const body = await cloned.json().catch(() => null);
                    apiMsg = (body && (body.detail || body.message)) ? ` (${body.detail || body.message})` : '';
                } catch (_) { /* best-effort */ }
                const msg = `We are experiencing heavy load and hit a rate limit. Please wait a bit and try again${apiMsg}.`;
                try { if (typeof showNotification === 'function') showNotification(msg, 'warning'); } catch(_) {}
            }
            return response;
        } catch (error) {
            const text = String(error && (error.message || error))
            if (text.includes('RateLimit') || text.includes('429')) {
                try { if (typeof showNotification === 'function') showNotification('We are temporarily rate-limited. Please try again shortly.', 'warning'); } catch(_) {}
            }
            throw error;
        }
    };
})();

// Sidebar Navigation Handler
document.addEventListener('DOMContentLoaded', function() {
    // Initialize horizontal tab navigation (manual tab switching)
    const tabButtons = document.querySelectorAll('.tab-nav-btn');
    const tabPanes = document.querySelectorAll('.tab-pane');

    function switchTab(targetId) {
        console.log('[SWITCH TAB] ===== FUNCTION CALLED ===== targetId:', targetId);
        // Hide all tab panes
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // Remove active class from all buttons
        tabButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });

        // Show target pane
        const targetPane = document.getElementById(targetId);
        if (targetPane) {
            targetPane.classList.add('show', 'active');
        }

        // Activate clicked button
        const activeButton = document.querySelector(`[data-target="${targetId}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
            activeButton.setAttribute('aria-selected', 'true');
        }

        // Trigger load functions based on which tab was shown
        const tabId = activeButton?.id;

        // Show/hide appropriate toolbar based on active tab
        const toolbarArticles = document.getElementById('toolbar-article-investigator');
        const toolbarInsights = document.getElementById('toolbar-narrative-explorer');
        const toolbarSixArticles = document.getElementById('toolbar-six-articles');

        // Hide all toolbars first
        if (toolbarArticles) toolbarArticles.style.display = 'none';
        if (toolbarInsights) toolbarInsights.style.display = 'none';
        if (toolbarSixArticles) toolbarSixArticles.style.display = 'none';

        // Show the appropriate toolbar
        if (tabId === 'articles-tab' && toolbarArticles) {
            toolbarArticles.style.display = 'flex';
            updateFilterDropdownContent('articles');
        } else if (tabId === 'insights-tab' && toolbarInsights) {
            toolbarInsights.style.display = 'flex';
            updateFilterDropdownContent('insights');
        } else if (tabId === 'six-articles-tab' && toolbarSixArticles) {
            toolbarSixArticles.style.display = 'flex';
        }

        // Clear insights containers when navigating away from insights tab
        if (tabId !== 'insights-tab') {
            const incidentContainer = document.getElementById('incident-tracking-container');
            const narrativesContainer = document.getElementById('article-insights-container');
            const categoryContainer = document.getElementById('category-insights-container');

            // Only clear if they have actual content (not welcome messages)
            if (incidentContainer?.querySelector('.insight-item-card')) {
                console.log('[Tab Switch] Clearing incident container');
                incidentContainer.innerHTML = `
                    <div class="text-center p-5 w-100">
                        <i class="fas fa-crosshairs fa-3x text-muted mb-3"></i>
                        <h5>Incident Tracking</h5>
                        <p class="text-muted mb-3">Track specific incidents, entities, and events for threat hunting.</p>
                        <p class="text-muted mb-4">Select topics and date range above, then click the button below to generate insights.</p>
                        <button class="btn btn-primary btn-lg" onclick="generateInsights()">
                            <i class="fas fa-magic me-2"></i>Generate Insights
                        </button>
                    </div>`;
            }
            if (narrativesContainer?.querySelector('.insight-item-card')) {
                console.log('[Tab Switch] Clearing narratives container');
                narrativesContainer.innerHTML = '';
            }
            if (categoryContainer?.querySelector('.insight-item-card')) {
                console.log('[Tab Switch] Clearing category container');
                categoryContainer.innerHTML = '';
            }
        }

        if (tabId === 'articles-tab') {
            // Trigger articles loading
            if (typeof autoLoadArticles === 'function') {
                autoLoadArticles();
            }
        } else if (tabId === 'six-articles-tab') {
            // Trigger six articles loading
            if (typeof loadSixArticles === 'function') {
                loadSixArticles();
            }
        } else if (tabId === 'insights-tab') {
            // Trigger insights loading
            console.log('[TAB SWITCH] ===== INSIGHTS TAB CLICKED =====');
            if (typeof checkInsightsCache === 'function') {
                console.log('[TAB SWITCH] checkInsightsCache function exists, calling it...');
                checkInsightsCache().then(() => {
                    console.log('[Tab Switch] checkInsightsCache completed, now checking containers...');
                    // Check which containers have cache and which are empty
                    const incidentContainer = document.getElementById('incident-tracking-container');
                    const narrativesContainer = document.getElementById('article-insights-container');
                    const categoryContainer = document.getElementById('category-insights-container');

                    const incidentEmpty = !incidentContainer || !incidentContainer.querySelector('.insight-item-card');
                    const narrativesEmpty = !narrativesContainer || !narrativesContainer.querySelector('.insight-item-card');
                    const categoryEmpty = !categoryContainer || !categoryContainer.querySelector('.insight-item-card');

                    // Debug: Log what's actually in the containers
                    console.log('[Tab Switch] Container contents:');
                    console.log('  - incident cards:', incidentContainer?.querySelectorAll('.insight-item-card').length || 0);
                    console.log('  - narrative cards:', narrativesContainer?.querySelectorAll('.insight-item-card').length || 0);
                    console.log('  - category cards:', categoryContainer?.querySelectorAll('.insight-item-card').length || 0);

                    const hasIncidentCache = window.insightsState?.hasIncidentCache;
                    const hasArticleCache = window.insightsState?.hasArticleCache;
                    const hasCategoryCache = window.insightsState?.hasCategoryCache;

                    // Auto-load if any cached content exists but its container is empty
                    const shouldAutoLoad = (hasIncidentCache && incidentEmpty) ||
                                          (hasArticleCache && narrativesEmpty) ||
                                          (hasCategoryCache && categoryEmpty);

                    console.log('[Tab Switch] Container status - incident:', incidentEmpty ? 'empty' : 'loaded',
                               'narratives:', narrativesEmpty ? 'empty' : 'loaded',
                               'category:', categoryEmpty ? 'empty' : 'loaded');
                    console.log('[Tab Switch] Cache status - incident:', hasIncidentCache,
                               'narratives:', hasArticleCache,
                               'category:', hasCategoryCache);
                    console.log('[Tab Switch] shouldAutoLoad:', shouldAutoLoad);

                    if (shouldAutoLoad) {
                        console.log('[Tab Switch] Auto-loading cached insights');

                        // Activate the appropriate sub-tab based on which cache is available
                        if (hasIncidentCache && incidentEmpty) {
                            console.log('[Tab Switch] Activating Highlights sub-tab for incident cache');
                            const highlightsTab = document.getElementById('incident-tracking-nav');
                            if (highlightsTab) {
                                // Programmatically activate the Highlights sub-tab
                                highlightsTab.click();

                                // Wait for tab to become visible before auto-loading
                                setTimeout(() => {
                                    console.log('[Tab Switch] Highlights tab activated, now auto-loading...');
                                    if (typeof autoLoadCachedInsights === 'function') {
                                        autoLoadCachedInsights();
                                    }
                                }, 100);
                                return; // Exit early since we'll auto-load after timeout
                            }
                        } else if (hasArticleCache && narrativesEmpty) {
                            console.log('[Tab Switch] Narratives cache available, keeping current sub-tab');
                        }

                        if (typeof autoLoadCachedInsights === 'function') {
                            autoLoadCachedInsights();
                        } else {
                            console.error('[Tab Switch] autoLoadCachedInsights function not found!');
                        }
                    } else if (incidentEmpty && narrativesEmpty && categoryEmpty) {
                        console.log('[Tab Switch] All containers empty, no cache available');
                        if (typeof showInsightsWelcomeMessage === 'function') {
                            showInsightsWelcomeMessage();
                        }
                    } else {
                        console.log('[Tab Switch] Cached insights already loaded, skipping auto-load');
                    }
                }).catch(error => {
                    console.error('[Tab Switch] Error in checkInsightsCache:', error);
                });
            }
        }
    }

    // Add click listeners to tab buttons
    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const buttonId = this.id;
            console.log('[CLICK] Tab button clicked - id:', buttonId, 'target:', targetId);
            if (targetId) {
                switchTab(targetId);
            } else {
                console.error('[CLICK] No target ID found for button:', buttonId);
            }
        });
    });

    // Initialize first tab as active
    const firstActiveButton = document.querySelector('.tab-nav-btn.active');
    if (firstActiveButton) {
        const initialTarget = firstActiveButton.getAttribute('data-target');
        if (initialTarget) {
            const initialPane = document.getElementById(initialTarget);
            if (initialPane) {
                initialPane.classList.add('show', 'active');
            }
        }
    }
});

// Update filter dropdown content based on active tab
function updateFilterDropdownContent(tabType) {
    const filterContent = document.getElementById('filter-dropdown-content');
    if (!filterContent) return;

    if (tabType === 'articles') {
        // Article Investigator filters
        filterContent.innerHTML = `
            <!-- Search -->
            <div class="mb-3">
                <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Search Title, Summaries, Keywords..." onkeyup="handleSearchInput()">
            </div>

            <!-- Bias Filter -->
            <div class="filter-section">
                <label class="filter-label">Bias</label>
                <div id="bias-filters" class="filter-chips-container"></div>
            </div>

            <!-- Factuality Filter -->
            <div class="filter-section">
                <label class="filter-label">Factuality</label>
                <div id="factuality-filters" class="filter-chips-container"></div>
            </div>

            <!-- Category Filter -->
            <div class="filter-section">
                <label class="filter-label">Category</label>
                <div id="category-filters" class="filter-chips-container"></div>
            </div>

            <!-- Signals Filter -->
            <div class="filter-section">
                <label class="filter-label">Signals</label>
                <div id="signal-filters" class="filter-chips-container"></div>
            </div>

            <!-- Sort -->
            <div class="filter-section">
                <label class="filter-label">Sort By</label>
                <select id="sort-select" class="form-select form-select-sm" onchange="handleSortChange()">
                    <option value="date_asc">Date (Oldest First)</option>
                    <option value="date_desc" selected>Date (Newest First)</option>
                    <option value="category_date_asc">Category (Oldest First)</option>
                    <option value="category_date_desc">Category (Newest First)</option>
                    <option value="bias_date_asc">Political Bias (Oldest First)</option>
                    <option value="bias_date_desc">Political Bias (Newest First)</option>
                </select>
            </div>
        `;
        // Re-initialize article filters
        if (typeof initializeFilterChips === 'function') {
            initializeFilterChips();
        }
    } else if (tabType === 'insights') {
        // Narrative Explorer (Incident) filters
        filterContent.innerHTML = `
            <!-- Type Filter -->
            <div class="filter-section">
                <label class="filter-label">Type</label>
                <div id="incident-type-filters-dropdown" class="filter-chips-container"></div>
            </div>

            <!-- Significance Filter -->
            <div class="filter-section">
                <label class="filter-label">Significance</label>
                <div id="incident-significance-filters-dropdown" class="filter-chips-container"></div>
            </div>

            <!-- Status Filter -->
            <div class="filter-section">
                <label class="filter-label">Status</label>
                <div id="incident-status-filters-dropdown" class="filter-chips-container"></div>
            </div>

            <!-- Sort -->
            <div class="filter-section">
                <label class="filter-label">Sort By</label>
                <select id="incident-sort-select-dropdown" class="form-select form-select-sm" onchange="handleIncidentSortChange()">
                    <option value="significance_desc">Significance (High â†’ Low)</option>
                    <option value="significance_asc">Significance (Low â†’ High)</option>
                    <option value="entity_asc">Entity (A â†’ Z)</option>
                    <option value="entity_desc">Entity (Z â†’ A)</option>
                    <option value="type_asc">Type (A â†’ Z)</option>
                    <option value="type_desc">Type (Z â†’ A)</option>
                    <option value="name_asc">Name (A â†’ Z)</option>
                    <option value="name_desc">Name (Z â†’ A)</option>
                    <option value="timeline_desc">Timeline (Recent â†’ Old)</option>
                    <option value="timeline_asc">Timeline (Old â†’ Recent)</option>
                </select>
            </div>
        `;
        // Re-initialize incident filters
        if (typeof populateIncidentFilters === 'function') {
            populateIncidentFilters();
        }
    }
}

// Article Investigator export functions
function exportArticlesCSV() {
    showToast('Info', 'CSV export functionality will be implemented soon.', 'info');
    // TODO: Implement CSV export
}

function exportArticlesPDF() {
    showToast('Info', 'PDF export functionality will be implemented soon.', 'info');
    // TODO: Implement PDF export
}

function exportArticlesMarkdown() {
    showToast('Info', 'Markdown export functionality will be implemented soon.', 'info');
    // TODO: Implement Markdown export
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== FIRST DOMContentLoaded handler executing ===');
    // Initialize with the selected date (September 15, 2025)
    const selectedDateObj = new Date(2025, 8, 15); // September 15, 2025
    const currentDateEl = document.getElementById('current-date');
    if (currentDateEl) {
        currentDateEl.textContent = selectedDateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    // Persist selected model between sessions
    try {
        const savedModel = localStorage.getItem('newsFeedDefaultModel');
        if (savedModel) {
            const modelSelect = document.getElementById('model-select');
            if (modelSelect && Array.from(modelSelect.options).some(o => o.value === savedModel)) {
                modelSelect.value = savedModel;
            }
        }
        const modelSelectEl = document.getElementById('model-select');
        if (modelSelectEl) {
            modelSelectEl.addEventListener('change', () => {
                localStorage.setItem('newsFeedDefaultModel', modelSelectEl.value);
            });
        }
    } catch (_) { /* best-effort */ }

    // Profile persistence is now handled in loadOrganizationalProfiles() after profiles are loaded

    // Load available voices for podcast generation
    loadAvailableVoices();

    // Default to last 7 days
    try {
        const dr = document.getElementById('date-range-select');
        if (dr) {
            dr.value = '7d';
            document.getElementById('date-range-text').textContent = 'Last 7 Days';
            handleDateRangeChange();
        }
    } catch (_) { /* best-effort */ }

    // Generate button is now in Six Articles tab - event listener added there

    // Tab change handlers are now handled in the manual tab switching code above
    // (see the switchTab function in the DOMContentLoaded handler)

    // Initialize insights sub-navigation
    document.querySelectorAll('#insights-nav .nav-link').forEach(navLink => {
        navLink.addEventListener('click', function(e) {
            e.preventDefault();

            // Update active states for insights nav
            document.querySelectorAll('#insights-nav .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            this.classList.add('active');

            // Show corresponding panel
            const targetId = this.getAttribute('href').substring(1);
            document.querySelectorAll('#insights-tab-content .tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });

            const targetPanel = document.getElementById(targetId);
            if (targetPanel) {
                targetPanel.classList.add('show', 'active');

                // Show warning if Category Insights tab is opened with multiple topics
                if (targetId === 'category-insights-panel') {
                    const topics = getSelectedTopics();
                    const warning = document.getElementById('category-multi-topic-warning');
                    if (warning) {
                        warning.style.display = topics && topics.length > 1 ? 'block' : 'none';
                    }
                }
            }
        });
    });

    // Check if Insights tab is active on page load and auto-load cached content
    setTimeout(async () => {
        const insightsTab = document.getElementById('insights-tab');
        const insightsTabContent = document.getElementById('insights-tab-content-main');

        // Check if insights tab is currently active (after page refresh)
        if (insightsTab && insightsTab.classList.contains('active')) {
            console.log('[Page Load] Insights tab is active, checking for cached content...');
            await checkInsightsCache();

            // Check which containers have cache and which are empty
            const incidentContainer = document.getElementById('incident-tracking-container');
            const narrativesContainer = document.getElementById('article-insights-container');
            const categoryContainer = document.getElementById('category-insights-container');

            const incidentEmpty = !incidentContainer || !incidentContainer.querySelector('.insight-item-card');
            const narrativesEmpty = !narrativesContainer || !narrativesContainer.querySelector('.insight-item-card');
            const categoryEmpty = !categoryContainer || !categoryContainer.querySelector('.insight-item-card');

            const hasIncidentCache = window.insightsState?.hasIncidentCache;
            const hasArticleCache = window.insightsState?.hasArticleCache;
            const hasCategoryCache = window.insightsState?.hasCategoryCache;

            // Auto-load if any cached content exists but its container is empty
            const shouldAutoLoad = (hasIncidentCache && incidentEmpty) ||
                                  (hasArticleCache && narrativesEmpty) ||
                                  (hasCategoryCache && categoryEmpty);

            if (shouldAutoLoad) {
                console.log('[Page Load] Found cached insights with empty containers, auto-loading...');

                // Activate the appropriate sub-tab based on which cache is available
                if (hasIncidentCache && incidentEmpty) {
                    console.log('[Page Load] Activating Highlights sub-tab for incident cache');
                    const highlightsTab = document.getElementById('incident-tracking-nav');
                    if (highlightsTab) {
                        highlightsTab.click();

                        // Wait for tab to become visible before auto-loading
                        setTimeout(async () => {
                            console.log('[Page Load] Highlights tab activated, now auto-loading...');
                            await autoLoadCachedInsights();
                        }, 100);
                        return; // Exit early since we'll auto-load after timeout
                    }
                }

                await autoLoadCachedInsights();
            } else if (incidentEmpty && narrativesEmpty && categoryEmpty) {
                console.log('[Page Load] No cached insights found, showing welcome message');
                showInsightsWelcomeMessage();
            } else {
                console.log('[Page Load] Cached insights already loaded, skipping auto-load');
            }
        }
    }, 500); // Small delay to ensure DOM is fully ready

    // Try to restore cached article data from localStorage
    try {
        const cachedArticles = localStorage.getItem('newsNarratorArticlesCache');
        const cacheTimestamp = localStorage.getItem('newsNarratorArticlesCacheTime');
        const cacheExpiry = 60 * 60 * 1000; // 1 hour cache

        if (cachedArticles && cacheTimestamp) {
            const cacheAge = Date.now() - parseInt(cacheTimestamp);
            if (cacheAge < cacheExpiry) {
                console.log('[Page Load] Found cached articles, restoring...');
                const data = JSON.parse(cachedArticles);
                window.lastArticlesData = data;
                renderArticles(data);
            } else {
                console.log('[Page Load] Cached articles expired');
                localStorage.removeItem('newsNarratorArticlesCache');
                localStorage.removeItem('newsNarratorArticlesCacheTime');
            }
        }
    } catch (e) {
        console.error('[Page Load] Error restoring cached articles:', e);
    }

    // If no cache, show a helpful message in the articles area
    const articlesContainer = document.getElementById('articles-list');
    if (articlesContainer && !articlesContainer.querySelector('.article-item')) {
        articlesContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Ready to Generate News Feed</h5>
                <p class="text-muted">Click "Generate Feed" to load articles for the selected date.</p>
            </div>
        `;
    }
    
    // Try to restore cached Six Articles from localStorage
    try {
        const cachedSixArticles = localStorage.getItem('newsNarratorSixArticlesCache');
        const cacheTimestamp = localStorage.getItem('newsNarratorSixArticlesCacheTime');
        const cacheExpiry = 60 * 60 * 1000; // 1 hour cache

        if (cachedSixArticles && cacheTimestamp) {
            const cacheAge = Date.now() - parseInt(cacheTimestamp);
            if (cacheAge < cacheExpiry) {
                console.log('[Page Load] Found cached Six Articles, restoring...');
                const data = JSON.parse(cachedSixArticles);
                renderSixArticles(data);
            } else {
                console.log('[Page Load] Cached Six Articles expired');
                localStorage.removeItem('newsNarratorSixArticlesCache');
                localStorage.removeItem('newsNarratorSixArticlesCacheTime');
            }
        }
    } catch (e) {
        console.error('[Page Load] Error restoring cached Six Articles:', e);
    }

    // Show a helpful message in the six articles area too if no cache
    const sixArticlesContainer = document.getElementById('six-articles-report');
    if (sixArticlesContainer && !sixArticlesContainer.querySelector('.article-analysis')) {
        sixArticlesContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-star fa-3x text-muted mb-3"></i>
                <h5>Six Articles Analysis</h5>
                <p class="text-muted">Generate a feed first, then click this tab to see the strategic analysis.</p>
            </div>
        `;
    }
    
    // Populate topics dropdown with checkboxes
    try {
        const dropdown = document.getElementById('topic-select-dropdown');
        if (dropdown) {
            console.log('Fetching topics for multi-select dropdown...');
            fetch('/api/topics')
                .then(r => {
                    console.log('Topics API response status:', r.status);
                    return r.json();
                })
                .then(topics => {
                    console.log('Topics loaded:', topics);

                    // Build checkbox list (keep Select All/Clear All, add topics after divider)
                    const topicCheckboxes = topics.map(t => {
                        let topicName = t.name.trim();

                        // Flatten topic hierarchy - remove parent indicators and show only leaf name
                        const lastSeparator = Math.max(
                            topicName.lastIndexOf(' > '),
                            topicName.lastIndexOf(' - '),
                            topicName.lastIndexOf(' / ')
                        );
                        const displayName = lastSeparator > -1
                            ? topicName.substring(lastSeparator + 3).trim()
                            : topicName;

                        return `
                            <li>
                                <a class="dropdown-item topic-option" href="#" data-topic="${escapeHtml(topicName)}" onclick="toggleTopic(this); return false;">
                                    <i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>
                                    ${escapeHtml(displayName)}
                                </a>
                            </li>
                        `;
                    }).join('');

                    // Find the divider and append topics after it
                    const divider = dropdown.querySelector('hr.dropdown-divider');
                    if (divider && divider.parentElement) {
                        // Remove existing topic checkboxes (in case of reload)
                        const existingTopics = dropdown.querySelectorAll('li:not(:has(a)), li:has(label)');
                        existingTopics.forEach(el => {
                            if (el !== divider.parentElement && !el.querySelector('.dropdown-divider')) {
                                el.remove();
                            }
                        });

                        // Insert topics after divider
                        divider.parentElement.insertAdjacentHTML('afterend', topicCheckboxes);
                    }

                    console.log('Topic checkboxes populated with', topics.length, 'topics');

                    // Restore saved topics from localStorage
                    const savedTopicsJson = localStorage.getItem('newsFeedTopics');
                    if (savedTopicsJson) {
                        try {
                            const savedTopics = JSON.parse(savedTopicsJson);
                            console.log('Restoring saved topics:', savedTopics);
                            if (Array.isArray(savedTopics)) {
                                savedTopics.forEach(topic => {
                                    const item = dropdown.querySelector(`.topic-option[data-topic="${topic}"]`);
                                    if (item) {
                                        const checkmark = item.querySelector('.fa-check');
                                        if (checkmark) {
                                            checkmark.style.visibility = 'visible';
                                        }
                                    }
                                });
                                updateTopicSelectorDisplay();
                            }
                        } catch (e) {
                            console.error('Error parsing saved topics:', e);
                        }
                    }
                })
                .catch(err => {
                    console.error('Error loading topics:', err);
                });
        } else {
            console.error('topic-select-dropdown element not found');
        }
    } catch (err) {
        console.error('Error in topic multi-select setup:', err);
    }

    // Load saved feeds when modal is opened
    document.getElementById('savedFeedsModal').addEventListener('show.bs.modal', loadSavedFeeds);
    
    // Clear all feeds functionality
    document.getElementById('clearAllFeeds').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all saved feeds?')) {
            localStorage.removeItem('savedNewsFeeds');
            loadSavedFeeds();
        }
    });
    
    // Save feed functionality
    document.getElementById('saveFeedBtn').addEventListener('click', saveFeedFromModal);
});

function loadSavedFeeds() {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const container = document.getElementById('savedFeedsList');
    
    if (savedFeeds.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-bookmark fa-2x mb-3"></i>
                <p>No saved feeds yet.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    savedFeeds.forEach(feed => {
        const createdDate = new Date(feed.created).toLocaleDateString();
        const createdTime = new Date(feed.created).toLocaleTimeString();
        
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${escapeHTML(feed.name)}</h6>
                            ${feed.description ? `<p class="card-text small mb-2">${escapeHTML(feed.description)}</p>` : ''}
                            <p class="card-text small text-muted mb-2">
                                <i class="fas fa-calendar me-1"></i>Feed Date: ${feed.date}
                                ${feed.topic ? `<span class="ms-2"><i class="fas fa-tag me-1"></i>Topic: ${escapeHTML(feed.topic)}</span>` : ''}
                            </p>
                            <p class="card-text small text-muted mb-0">
                                <i class="fas fa-clock me-1"></i>Saved: ${createdDate} ${createdTime}
                                <span class="ms-2">
                                    ${feed.includeArticles ? '<i class="fas fa-list me-1"></i>Articles' : ''}
                                    ${feed.includeSixArticles ? '<i class="fas fa-star me-1 ms-2"></i>Analysis' : ''}
                                </span>
                            </p>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-3">
                            <button class="btn btn-outline-primary" onclick="loadSavedFeed(${feed.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-outline-success" onclick="exportSavedFeed(${feed.id})">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteSavedFeed(${feed.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function deleteSavedFeed(feedId) {
    if (confirm('Are you sure you want to delete this saved feed?')) {
        const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
        const filteredFeeds = savedFeeds.filter(feed => feed.id !== feedId);
        localStorage.setItem('savedNewsFeeds', JSON.stringify(filteredFeeds));
        loadSavedFeeds();
    }
}

function saveFeed() {
    // Open the save modal
    const saveModal = new bootstrap.Modal(document.getElementById('saveFeedModal'));
    
    // Pre-fill the name with date range and topic
    const dateRange = document.getElementById('date-range-select').value;
    const topic = document.getElementById('topic-input').value.trim();
    
    let formattedDate;
    if (dateRange === 'custom') {
        const customDate = document.getElementById('custom-date-input').value;
        if (customDate) {
            const dateObj = new Date(customDate);
            formattedDate = dateObj.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        } else {
            formattedDate = 'Custom Date';
        }
    } else {
        // Use the display text for date ranges
        const displayText = document.getElementById('date-range-text').textContent;
        formattedDate = displayText;
    }
    
    const defaultName = topic ? `${topic} - ${formattedDate}` : `News Feed - ${formattedDate}`;
    document.getElementById('feedNameInput').value = defaultName;
    
    saveModal.show();
}

function saveFeedFromModal() {
    const feedName = document.getElementById('feedNameInput').value.trim();
    const feedDescription = document.getElementById('feedDescriptionInput').value.trim();
    const includeArticles = document.getElementById('includeArticles').checked;
    const includeSixArticles = document.getElementById('includeSixArticles').checked;
    
    if (!feedName) {
        alert('Please enter a feed name');
        return;
    }
    
    if (!includeArticles && !includeSixArticles) {
        alert('Please select at least one content type to save');
        return;
    }
    
    // Collect current feed data
    const dateRange = document.getElementById('date-range-select').value;
    const selectedDate = dateRange === 'custom' ? 
        document.getElementById('custom-date-input').value || document.getElementById('selected-date').value :
        dateRange;
    const topic = document.getElementById('topic-input').value.trim();
    const model = document.getElementById('model-select').value;
    
    // Get articles data if requested
    let articlesData = null;
    if (includeArticles) {
        const articleElements = document.querySelectorAll('#articles-list .list-group-item');
        articlesData = Array.from(articleElements).map(element => {
            const title = element.querySelector('h6 a')?.textContent || 'Untitled';
            const url = element.querySelector('h6 a')?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summary = element.querySelector('.small')?.textContent || '';
            
            return { title, url, source, summary };
        });
    }
    
    // Get six articles data if requested
    let sixArticlesData = null;
    if (includeSixArticles) {
        const sixArticlesContainer = document.getElementById('six-articles-report');
        if (sixArticlesContainer && sixArticlesContainer.innerHTML.trim()) {
            const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
            sixArticlesData = Array.from(articles).map(article => {
                const title = article.querySelector('h4')?.textContent || 'Article';
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown';
                const sections = Array.from(article.querySelectorAll('.section')).map(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    return { title: sectionTitle, content: sectionContent };
                });
                return { title, source, sections };
            });
        }
    }
    
    // Create feed object
    const feedData = {
        id: Date.now(),
        name: feedName,
        description: feedDescription,
        date: selectedDate,
        date_range: dateRange,
        topic: topic,
        model: model,
        includeArticles: includeArticles,
        includeSixArticles: includeSixArticles,
        articlesData: articlesData,
        sixArticlesData: sixArticlesData,
        created: new Date().toISOString()
    };
    
    // Save to localStorage
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    savedFeeds.unshift(feedData);
    localStorage.setItem('savedNewsFeeds', JSON.stringify(savedFeeds));
    
    // Close modal and show success
    const saveModal = bootstrap.Modal.getInstance(document.getElementById('saveFeedModal'));
    saveModal.hide();
    
    showNotification(`Feed "${feedName}" saved successfully!`, 'success');
}

function loadSavedFeed(feedId) {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const feed = savedFeeds.find(f => f.id === feedId);
    
    if (!feed) {
        showNotification('Feed not found', 'danger');
        return;
    }
    
    // Set the date range and other parameters
    if (feed.date_range) {
        document.getElementById('date-range-select').value = feed.date_range;
        handleDateRangeChange(); // Update display
    } else {
        // Legacy feed - treat as custom date
        document.getElementById('date-range-select').value = 'custom';
        document.getElementById('custom-date-input').value = feed.date;
        document.getElementById('selected-date').value = feed.date;
        handleDateRangeChange();
    }
    
    if (feed.topic) document.getElementById('topic-input').value = feed.topic;
    document.getElementById('model-select').value = feed.model;
    
    // Load the saved data
    if (feed.includeArticles && feed.articlesData) {
        // Render saved articles
        renderSavedArticles(feed.articlesData);
    }
    
    if (feed.includeSixArticles && feed.sixArticlesData) {
        // Render saved six articles
        renderSavedSixArticles(feed.sixArticlesData);
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('savedFeedsModal'));
    modal.hide();
    
    showNotification(`Loaded feed: ${feed.name}`, 'success');
}

function exportSavedFeed(feedId) {
    const savedFeeds = JSON.parse(localStorage.getItem('savedNewsFeeds') || '[]');
    const feed = savedFeeds.find(f => f.id === feedId);
    
    if (!feed) {
        showNotification('Feed not found', 'danger');
        return;
    }
    
    // Generate markdown for saved feed
    let markdown = '';
    const dateObj = new Date(feed.date);
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Header
    markdown += `# ${feed.name}\n\n`;
    markdown += `**Date:** ${formattedDate}\n`;
    if (feed.topic) markdown += `**Topic:** ${feed.topic}\n`;
    if (feed.description) markdown += `**Description:** ${feed.description}\n`;
    markdown += `**Model:** ${feed.model}\n`;
    markdown += `**Saved:** ${new Date(feed.created).toLocaleString()}\n\n`;
    
    // Add six articles if included
    if (feed.includeSixArticles && feed.sixArticlesData) {
        markdown += `## Six Most Important Articles Analysis\n\n`;
        feed.sixArticlesData.forEach((article, index) => {
            markdown += `### ${index + 1}. ${article.title}\n\n`;
            markdown += `**Source:** ${article.source}\n\n`;
            
            article.sections.forEach(section => {
                if (section.title && section.content) {
                    markdown += `**${section.title}**\n\n${section.content}\n\n`;
                }
            });
            
            markdown += `---\n\n`;
        });
    }
    
    // Add articles if included
    if (feed.includeArticles && feed.articlesData) {
        markdown += `## Article List\n\n`;
        feed.articlesData.forEach((article, index) => {
            markdown += `### ${index + 1}. [${article.title}](${article.url})\n\n`;
            markdown += `**Source:** ${article.source}\n\n`;
            if (article.summary && article.summary.trim() !== 'No summary available.') {
                const cleanSummary = article.summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            markdown += `---\n\n`;
        });
    }
    
    downloadMarkdown(markdown, `${feed.name.replace(/[^a-zA-Z0-9]/g, '_')}_${feed.date}.md`);
}

function renderSavedArticles(articlesData) {
    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '';
    
    const articlesList = document.createElement('div');
    articlesList.className = 'list-group list-group-flush mt-2';
    
    articlesData.forEach(article => {
        const articleItem = document.createElement('div');
        articleItem.className = 'list-group-item';
        
        articleItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1"><a href="${article.url}" target="_blank" rel="noopener">${article.title}</a></h6>
                <small>Saved</small>
            </div>
            <p class="mb-1"><small class="text-muted">${article.source}</small></p>
            <p class="mb-1 small">${article.summary}</p>
        `;
        
        articlesList.appendChild(articleItem);
    });
    
    listContainer.appendChild(articlesList);
}

function renderSavedSixArticles(sixArticlesData) {
    const container = document.getElementById('six-articles-report');
    if (!container) return;
    
    let html = `
        <div class="six-articles-analysis">
            <h3>Strategic Analysis: Six Most Important Articles (Saved)</h3>
            <p class="mb-4">Previously saved analysis of the most important articles.</p>
        </div>
    `;
    
    sixArticlesData.forEach((article, index) => {
        html += `
            <div class="article-analysis mb-5 p-4 border rounded">
                <div class="article-header mb-3">
                    <h4 class="text-primary">${index + 1}. ${article.title}</h4>
                    <p class="text-muted mb-1"><strong>Source:</strong> ${article.source}</p>
                </div>
                <div class="article-content">
        `;
        
        article.sections.forEach(section => {
            if (section.title && section.content) {
                html += `
                    <div class="section mb-3">
                        <h6 class="text-secondary">${section.title}</h6>
                        <p>${section.content}</p>
                    </div>
                `;
            }
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Article exclusion functionality
let excludedArticles = new Set();
let currentArticlesPage = 1;

function excludeArticle(articleUri, buttonElement) {
    if (confirm('Remove this article from the current view?')) {
        // Add to excluded set
        excludedArticles.add(articleUri);
        
        // Find and hide the article element
        const articleElement = buttonElement.closest('.list-group-item');
        if (articleElement) {
            articleElement.style.transition = 'opacity 0.3s ease-out';
            articleElement.style.opacity = '0';
            setTimeout(() => {
                articleElement.remove();
                updateArticleCount();
                updateRestoreButton();
            }, 300);
        }
        
        // Show success message
        showNotification('Article removed from view', 'success');
    }
}

function updateRestoreButton() {
    const restoreBtn = document.getElementById('restore-articles-btn');
    if (restoreBtn) {
        if (excludedArticles.size > 0) {
            restoreBtn.style.display = 'inline-block';
            restoreBtn.innerHTML = `<i class="fas fa-undo"></i> Restore Hidden (${excludedArticles.size})`;
        } else {
            restoreBtn.style.display = 'none';
        }
    }
}

function updateArticleCount() {
    const remainingArticles = document.querySelectorAll('#articles-list .list-group-item').length;
    const countEl = document.getElementById('selected-date-count');
    if (countEl && remainingArticles > 0) {
        const originalText = countEl.textContent;
        const originalCount = parseInt(originalText) || 0;
        if (remainingArticles < originalCount) {
            countEl.textContent = `${remainingArticles} (${originalCount - remainingArticles} hidden)`;
        }
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) notification.remove();
    }, 3000);
}

function clearExcludedArticles() {
    if (excludedArticles.size > 0 && confirm(`Restore ${excludedArticles.size} hidden articles?`)) {
        excludedArticles.clear();
        updateRestoreButton();
        loadArticles(currentArticlesPage); // Reload current page
        showNotification('All articles restored', 'success');
    }
}

// Markdown export functionality
async function exportToMarkdown() {
    try {
    const selectedDate = document.getElementById('selected-date').value;
    const selectedModel = document.getElementById('model-select').value;
    const topic = document.getElementById('topic-input').value.trim();
    const profileId = document.getElementById('profile-select').value;
        
        // Get current tab to determine what to export
        const activeTab = document.querySelector('#news-tabs .nav-link.active');
        const isArticlesTab = activeTab.id === 'articles-tab';
        
        let markdown = '';
        const dateObj = new Date(selectedDate);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Header
        markdown += `# News Investigator\n\n`;
        markdown += `**Date:** ${formattedDate}\n`;
        if (topic) markdown += `**Topic Filter:** ${topic}\n`;
        markdown += `**Generated:** ${new Date().toLocaleString()}\n`;
        markdown += `**Model:** ${selectedModel}\n\n`;
        
        // Export both six articles and article list
        await exportCombinedContent(markdown);
        
    } catch (error) {
        console.error('Error exporting to markdown:', error);
        showNotification('Error exporting to markdown', 'danger');
    }
}

async function exportArticlesList(baseMarkdown) {
    let markdown = baseMarkdown;
    markdown += `## Article List\n\n`;
    
    // Get visible articles from the current view
    const articleElements = document.querySelectorAll('#articles-list .list-group-item');
    
    if (articleElements.length === 0) {
        markdown += `*No articles available.*\n\n`;
    } else {
        articleElements.forEach((element, index) => {
            const title = element.querySelector('h6 a')?.textContent || 'Untitled';
            const url = element.querySelector('h6 a')?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summary = element.querySelector('.small')?.textContent || '';
            
            markdown += `### ${index + 1}. [${title}](${url})\n\n`;
            markdown += `**Source:** ${source}\n\n`;
            
            if (summary && summary.trim() !== 'No summary available.') {
                const cleanSummary = summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            
            // Add metadata tags if visible
            const metadataTags = element.querySelectorAll('.metadata-tag');
            if (metadataTags.length > 0) {
                markdown += `**Tags:** `;
                const tags = Array.from(metadataTags).map(tag => tag.textContent.trim()).join(', ');
                markdown += `${tags}\n\n`;
            }
            
            markdown += `---\n\n`;
        });
    }
    
    downloadMarkdown(markdown, `news-articles-${document.getElementById('selected-date').value}.md`);
}

async function exportCombinedContent(baseMarkdown) {
    let markdown = baseMarkdown;
    
    // First, add six articles analysis if available
    const sixArticlesContainer = document.getElementById('six-articles-report');
    if (sixArticlesContainer && sixArticlesContainer.innerHTML.trim()) {
        const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
        
        if (articles.length > 0) {
            markdown += `## Six Most Important Articles Analysis\n\n`;
            
            articles.forEach((article, index) => {
                const title = article.querySelector('h4')?.textContent || `Article ${index + 1}`;
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown source';
                
                markdown += `### ${index + 1}. ${title}\n\n`;
                markdown += `**Source:** ${source}\n\n`;
                
                const sections = article.querySelectorAll('.section');
                sections.forEach(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    
                    if (sectionTitle && sectionContent) {
                        markdown += `**${sectionTitle}**\n\n${sectionContent}\n\n`;
                    }
                });
                
                // Get perspectives if available
                const perspectives = article.querySelector('.row');
                if (perspectives) {
                    markdown += `**Political & Ideological Perspectives:**\n\n`;
                    const cols = perspectives.querySelectorAll('.col-md-4');
                    cols.forEach(col => {
                        const perspectiveTitle = col.querySelector('strong')?.textContent || '';
                        const perspectiveContent = col.querySelector('p')?.textContent || '';
                        
                        if (perspectiveTitle && perspectiveContent) {
                            markdown += `- **${perspectiveTitle}** ${perspectiveContent}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n`;
            });
        }
    }
    
    // Then add the article list
    markdown += `## Article List\n\n`;
    
    const articleElements = document.querySelectorAll('#articles-list .list-group-item');
    
    if (articleElements.length === 0) {
        markdown += `*No articles available.*\n\n`;
    } else {
        articleElements.forEach((element, index) => {
            const titleElement = element.querySelector('h6 a');
            const title = titleElement?.textContent || 'Untitled';
            const url = titleElement?.href || '#';
            const source = element.querySelector('.text-muted')?.textContent || 'Unknown source';
            const summaryElement = element.querySelector('.small');
            const summary = summaryElement?.getAttribute('title') || summaryElement?.textContent || 'No summary available.';
            
            markdown += `### ${index + 1}. [${title}](${url})\n\n`;
            markdown += `**Source:** ${source}\n\n`;
            
            if (summary && summary.trim() !== 'No summary available.') {
                const cleanSummary = summary.replace(/\.\.\.$/, '').trim();
                markdown += `**Summary:** ${cleanSummary}\n\n`;
            }
            
            markdown += `---\n\n`;
        });
    }
    
    const filename = `news-feed-complete-${document.getElementById('selected-date').value}.md`;
    downloadMarkdown(markdown, filename);
}

async function exportSixArticles(baseMarkdown) {
    let markdown = baseMarkdown;
    markdown += `## Six Most Important Articles Analysis\n\n`;
    
    // Get six articles data from the current view
    const sixArticlesContainer = document.getElementById('six-articles-report');
    
    if (!sixArticlesContainer || !sixArticlesContainer.innerHTML.trim()) {
        markdown += `*No six articles analysis available. Please generate the report first.*\n\n`;
    } else {
        const articles = sixArticlesContainer.querySelectorAll('.article-analysis');
        
        if (articles.length === 0) {
            markdown += `*No articles found in the analysis.*\n\n`;
        } else {
            articles.forEach((article, index) => {
                const title = article.querySelector('h4')?.textContent || `Article ${index + 1}`;
                const source = article.querySelector('.text-muted')?.textContent?.replace('Source: ', '') || 'Unknown';
                
                markdown += `### ${title}\n\n`;
                markdown += `**Source:** ${source}\n\n`;
                
                // Get sections
                const sections = article.querySelectorAll('.section');
                sections.forEach(section => {
                    const sectionTitle = section.querySelector('h6')?.textContent || '';
                    const sectionContent = section.querySelector('p')?.textContent || '';
                    
                    if (sectionTitle && sectionContent) {
                        markdown += `**${sectionTitle}**\n\n${sectionContent}\n\n`;
                    }
                });
                
                // Get perspectives if available
                const perspectives = article.querySelector('.row');
                if (perspectives) {
                    markdown += `**Political & Ideological Perspectives:**\n\n`;
                    const cols = perspectives.querySelectorAll('.col-md-4');
                    cols.forEach(col => {
                        const perspectiveTitle = col.querySelector('strong')?.textContent || '';
                        const perspectiveContent = col.querySelector('p')?.textContent || '';
                        
                        if (perspectiveTitle && perspectiveContent) {
                            markdown += `- **${perspectiveTitle}** ${perspectiveContent}\n\n`;
                        }
                    });
                }
                
                markdown += `---\n\n`;
            });
        }
    }
    
    downloadMarkdown(markdown, `six-articles-${document.getElementById('selected-date').value}.md`);
}

function downloadMarkdown(content, filename) {
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification(`Exported as ${filename}`, 'success');
}

async function generateNewsFeed() {
    console.log('Generate button clicked');
    const selectedDate = document.getElementById('selected-date').value;
    const selectedModel = document.getElementById('model-select').value;
    console.log('Selected date:', selectedDate, 'Model:', selectedModel);
    
    // Clear existing content
    document.getElementById('articles-list').innerHTML = '';
    document.getElementById('six-articles-report').innerHTML = '';

    // Reset count indicator while loading
    const selectedDateCountEl = document.getElementById('selected-date-count');
    if (selectedDateCountEl) selectedDateCountEl.textContent = 'loading...';
    
    // Load both tabs
    await Promise.all([loadArticles(), loadSixArticles()]);
}

async function loadArticles(page = 1) {
    currentArticlesPage = page;
    const loadingEl = document.getElementById('articles-loading');
    const errorEl = document.getElementById('articles-error');
    const contentEl = document.getElementById('articles-list');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        // Use the news feed articles API
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            model: document.getElementById('model-select').value,
            page: page.toString(),
            per_page: '20'
        });
        
        // Only add date parameter for custom date selection
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            params.append('date', customDate);
        }

        const selectedTopics = getSelectedTopics();
        if (selectedTopics.length > 0) {
            // Send comma-separated topics or first topic depending on API support
            params.append('topic', selectedTopics.join(','));
        }
        
        const profileId = document.getElementById('profile-select').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }
        
        // Add starred articles if any
        if (starredArticles.size > 0) {
            params.append('starred_articles', Array.from(starredArticles).join(','));
        }

        console.log('Loading articles with params:', params.toString());
        const response = await fetch(`/api/news-feed/articles?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`No articles found: ${errorData.detail || 'No articles available for the selected date and criteria'}`);
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        // Update the selected-date count from response
        const selectedDateCountElSuccess = document.getElementById('selected-date-count');
        if (selectedDateCountElSuccess) {
            const total = (data && data.articles && typeof data.articles.total_items === 'number')
                ? data.articles.total_items
                : (data && data.articles && Array.isArray(data.articles.items))
                    ? data.articles.items.length
                    : 0;
            selectedDateCountElSuccess.textContent = String(total);
        }
        console.log('Articles data received:', data);
        console.log('Data.articles exists:', !!data.articles);
        console.log('Data.articles.items exists:', !!(data.articles && data.articles.items));
        console.log('Items count:', data.articles && data.articles.items ? data.articles.items.length : 'N/A');
        console.log('Sample article fields:', data.articles && data.articles.items && data.articles.items.length > 0 ? Object.keys(data.articles.items[0]) : 'No items');
        
        if (data.articles && data.articles.items && data.articles.items.length > 0) {
            console.log('First article sample:', data.articles.items[0]);
            // Ensure total_items is set in the data object
            if (!data.articles.total_items && data.articles.items) {
                data.articles.total_items = data.articles.items.length;
            }
            window.lastArticlesData = data.articles; // Store for filtering

            // Save to localStorage for page refresh restoration
            try {
                localStorage.setItem('newsNarratorArticlesCache', JSON.stringify(data.articles));
                localStorage.setItem('newsNarratorArticlesCacheTime', Date.now().toString());
                console.log('[Cache] Articles saved to localStorage');
            } catch (e) {
                console.error('[Cache] Error saving articles to localStorage:', e);
            }

            // DEBUG: Log article topics to verify they're loaded correctly
            console.log('=== ARTICLES LOADED ===');
            console.log(`Total articles: ${data.articles.items?.length || 0}`);
            if (data.articles.items && data.articles.items.length > 0) {
                console.log('First 3 articles topics:');
                data.articles.items.slice(0, 3).forEach((art, i) => {
                    console.log(`  ${i+1}. Title: "${art.title?.substring(0, 50)}..."`);
                    console.log(`     Topic: "${art.topic}" | Category: "${art.category}"`);
                    console.log(`     Has topic field: ${'topic' in art}`);
                });
            }
            console.log('=======================');

            renderArticles(data.articles);  // News feed API returns data.articles
            renderArticlesPagination(data.articles);
        } else {
            console.log('No articles found in response - showing friendly message');
            // Show friendly message instead of error
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
            errorEl.style.display = 'block';
            return; // Exit early, don't throw error
        }
        showSaveButton();

    } catch (error) {
        console.error('Error loading overview:', error);
        if (error.message.includes('404')) {
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
        } else {
            errorEl.textContent = `Error loading overview: ${error.message}`;
            errorEl.className = 'error-message'; // Keep error styling
        }
        // Ensure the selected-date count reflects zero on error
        const selectedDateCountElError = document.getElementById('selected-date-count');
        if (selectedDateCountElError) selectedDateCountElError.textContent = '0';
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

// Wrapper function to handle Write/Rewrite button
function handleSixArticlesGenerate() {
    // Always force regeneration when user clicks Write/Rewrite button
    loadSixArticles(true);
}

// Handle persona change - reset button to "Write" to indicate new generation needed
function handlePersonaChange() {
    const generateBtn = document.getElementById('six-articles-generate-btn');
    const generateIcon = document.getElementById('six-articles-generate-icon');
    const generateText = document.getElementById('six-articles-generate-text');

    if (generateBtn && generateIcon && generateText) {
        generateIcon.className = 'fas fa-pen me-2';
        generateText.textContent = 'Write';
    }

    // Show notification that settings changed
    showNotification('Persona changed. Click "Write" to generate analysis for this persona.', 'info');
}

// Handle article count change - reset button to "Write"
function handleArticleCountChange() {
    const generateBtn = document.getElementById('six-articles-generate-btn');
    const generateIcon = document.getElementById('six-articles-generate-icon');
    const generateText = document.getElementById('six-articles-generate-text');

    if (generateBtn && generateIcon && generateText) {
        generateIcon.className = 'fas fa-pen me-2';
        generateText.textContent = 'Write';
    }

    // Show notification that settings changed
    const count = document.getElementById('six-articles-count')?.value || '6';
    showNotification(`Article count changed to ${count}. Click "Write" to generate.`, 'info');
}

// Helper functions for toolbar dropdown settings
function setPersona(persona) {
    const select = document.getElementById('six-articles-persona');
    if (select) {
        select.value = persona;
        handlePersonaChange();
    }

    // Update visual state in dropdown - show checkmark on selected item
    document.querySelectorAll('.persona-option').forEach(item => {
        const check = item.querySelector('.fa-check');
        if (check) {
            if (item.dataset.persona === persona) {
                check.style.visibility = 'visible';
            } else {
                check.style.visibility = 'hidden';
            }
        }
    });
}

// Helper functions for configuration panel dropdowns
function setDateRange(value) {
    const select = document.getElementById('date-range-select');
    if (select) {
        select.value = value;
        handleDateRangeChange();
    }

    // Update button text
    const btn = document.getElementById('date-range-display-btn');
    const textMap = {
        '24h': 'Last 24 Hours',
        '72h': 'Last 72 Hours',
        '7d': 'Last 7 Days',
        '30d': 'Last 30 Days',
        'custom': 'Custom Date'
    };
    if (btn) btn.textContent = textMap[value] || value;

    // Update checkmarks
    document.querySelectorAll('.date-range-option').forEach(item => {
        const check = item.querySelector('.fa-check');
        if (check) {
            check.style.visibility = (item.dataset.value === value) ? 'visible' : 'hidden';
        }
    });
}

function setModel(value) {
    const select = document.getElementById('model-select');
    if (select) {
        select.value = value;
    }

    // Update button text
    const btn = document.getElementById('model-display-btn');
    const textMap = {
        'gpt-4o-mini': 'GPT-4o Mini',
        'gpt-4.1-mini': 'GPT-4.1 Mini',
        'gpt-4o': 'GPT-4o',
        'gpt-4.1': 'GPT-4.1',
        'gpt-4.1-nano': 'GPT-4.1 Nano',
        'claude-4-sonnet-latest': 'Claude 4 Sonnet',
        'claude-3-5-sonnet-latest': 'Claude 3.5 Sonnet',
        'gemini-pro': 'Gemini Pro'
    };
    if (btn) btn.textContent = textMap[value] || value;

    // Update checkmarks
    document.querySelectorAll('.model-option').forEach(item => {
        const check = item.querySelector('.fa-check');
        if (check) {
            check.style.visibility = (item.dataset.value === value) ? 'visible' : 'hidden';
        }
    });
}

function setProfile(value) {
    const select = document.getElementById('profile-select');
    if (select) {
        select.value = value;
    }

    // Update button text
    const btn = document.getElementById('profile-display-btn');
    const selectedOption = select ? select.options[select.selectedIndex] : null;
    if (btn && selectedOption) {
        btn.textContent = selectedOption.textContent;
    }

    // Update checkmarks
    document.querySelectorAll('.profile-option').forEach(item => {
        const check = item.querySelector('.fa-check');
        if (check) {
            check.style.visibility = (item.dataset.value === value) ? 'visible' : 'hidden';
        }
    });
}

function setArticleCount(count) {
    const select = document.getElementById('six-articles-count');
    if (select) {
        select.value = count;
        handleArticleCountChange();
    }

    // Update visual state in dropdown - show checkmark on selected item
    document.querySelectorAll('.count-option').forEach(item => {
        const check = item.querySelector('.fa-check');
        if (check) {
            if (item.dataset.count === String(count)) {
                check.style.visibility = 'visible';
            } else {
                check.style.visibility = 'hidden';
            }
        }
    });
}

async function loadSixArticles(forceRegenerate = false) {
    const loadingEl = document.getElementById('six-articles-loading');
    const errorEl = document.getElementById('six-articles-error');
    const contentEl = document.getElementById('six-articles-report');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        const dateRangeValue = document.getElementById('date-range-select').value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            model: document.getElementById('model-select').value,
            per_page: '20'
        });

        // Only add date parameter for custom date selection
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            params.append('date', customDate);
        }

        const selectedTopics = getSelectedTopics();
        if (selectedTopics.length > 0) {
            // Send comma-separated topics or first topic depending on API support
            params.append('topic', selectedTopics.join(','));
        }

        const profileId = document.getElementById('profile-select').value;
        if (profileId) {
            params.append('profile_id', profileId);
        }

        // Add persona and article count
        const persona = document.getElementById('six-articles-persona').value;
        if (persona) {
            params.append('persona', persona);
        }

        const articleCount = document.getElementById('six-articles-count').value;
        if (articleCount) {
            params.append('article_count', articleCount);
        }

        // Add starred articles if any
        if (starredArticles.size > 0) {
            params.append('starred_articles', Array.from(starredArticles).join(','));
        }

        if (forceRegenerate) {
            params.append('force_regenerate', 'true');
        }
        const response = await fetch(`/api/news-feed/six-articles?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`No articles found: ${errorData.detail || 'No articles available for the selected date and criteria'}`);
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Six articles response data:', data);
        window.lastSixArticles = data.six_articles || [];
        // Stamp generated date at top of report
        const generatedAt = new Date().toLocaleString();
        const header = document.createElement('div');
        header.className = 'small text-muted mb-2';
        header.innerHTML = `<i class="far fa-clock me-1"></i>Generated: ${generatedAt}`;
        const container = document.getElementById('six-articles-report');
        if (container) container.prepend(header);
        console.log('Six articles array:', data.six_articles);
        if (data.six_articles && data.six_articles.length > 0) {
            console.log('First article related_articles:', data.six_articles[0].related_articles);
        }
        renderSixArticles(data.six_articles);

        // Auto-save to database
        await autoSaveDashboard('six_articles', { articles: data.six_articles }, {
            view_type: 'Six Articles',
            model_used: data.model_used || 'gpt-4o-mini'
        });

        // Save to localStorage for page refresh restoration
        try {
            localStorage.setItem('newsNarratorSixArticlesCache', JSON.stringify(data.six_articles));
            localStorage.setItem('newsNarratorSixArticlesCacheTime', Date.now().toString());
            console.log('[Cache] Six Articles saved to localStorage');
        } catch (e) {
            console.error('[Cache] Error saving Six Articles to localStorage:', e);
        }

        // Update button to "Rewrite" after successful generation
        const generateBtn = document.getElementById('six-articles-generate-btn');
        const generateIcon = document.getElementById('six-articles-generate-icon');
        const generateText = document.getElementById('six-articles-generate-text');
        if (generateBtn && generateIcon && generateText) {
            generateIcon.className = 'fas fa-pen-fancy me-2';
            generateText.textContent = 'Rewrite';
        }

    } catch (error) {
        console.error('Error loading six articles:', error);
        if (error.message.includes('404')) {
            errorEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No articles available for this date. Please select a date with articles from the calendar.</div>';
            errorEl.className = 'mb-3'; // Remove error styling
        } else {
            errorEl.textContent = `Error loading six articles: ${error.message}`;
            errorEl.className = 'error-message'; // Keep error styling
        }
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

// Helper function to escape HTML content for safe display
function escapeHTML(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str).replace(/[&<>"']/g, function (match) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        }[match];
    });
}

// Escape string for use in JavaScript string literals (for onclick attributes)
function escapeJS(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str).replace(/[\\'"\r\n]/g, function (match) {
        return {
            '\\': '\\\\',
            "'": "\\'",
            '"': '\\"',
            '\r': '\\r',
            '\n': '\\n'
        }[match];
    });
}

// Safe formatter for article source. Falls back to hostname from URI when missing
function formatSource(newsSource, uri) {
    if (newsSource && String(newsSource).trim()) return escapeHTML(newsSource);
    try {
        if (!uri) return 'Unknown';
        const url = new URL(uri);
        const host = url.hostname.replace(/^www\./i, '');
        return host || 'Unknown';
    } catch (_) {
        return 'Unknown';
    }
}

// Safe formatter for publication date
function formatPubDate(dateStr, includeTime) {
    if (!dateStr) return 'Unknown date';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return 'Unknown date';
    return includeTime ? d.toLocaleString() : d.toLocaleDateString();
}

// Helper function to get bias CSS class
function getBiasClass(bias) {
    if (!bias) return 'tag-bias-unknown';
    const biasLower = bias.toLowerCase();
    if (biasLower.includes('left')) return 'tag-bias-left';
    if (biasLower.includes('right')) return 'tag-bias-right';
    if (biasLower.includes('center') || biasLower.includes('mixed')) return 'tag-bias-center';
    if (biasLower.includes('least') || biasLower.includes('factual')) return 'tag-bias-factual';
    return 'tag-bias-unknown';
}

// Helper function to get factual reporting CSS class
function getFactualClass(factual) {
    if (!factual) return 'tag-factual-unknown';
    const factualLower = factual.toLowerCase();
    if (factualLower.includes('high') || factualLower === 'very high') return 'tag-factual-high';
    if (factualLower.includes('mostly') || factualLower === 'mostly factual') return 'tag-factual-mostly';
    if (factualLower.includes('mixed')) return 'tag-factual-mixed';
    if (factualLower.includes('low')) return 'tag-factual-low';
    return 'tag-factual-unknown';
}

// Helper function to get MBFC credibility CSS class
function getMBFCCredibilityClass(credibility) {
    if (!credibility) return 'bg-secondary';
    const credLower = credibility.toLowerCase();
    if (credLower.includes('high') || credLower === 'very high') return 'bg-success';
    if (credLower.includes('mostly') || credLower.includes('moderate')) return 'bg-info';
    if (credLower.includes('mixed')) return 'bg-warning text-dark';
    if (credLower.includes('low')) return 'bg-danger';
    return 'bg-secondary';
}

// Removed old renderArticles function - using new one with star and filter functionality

function renderPagination(totalPages, currentPage) {
    const paginationContainer = document.getElementById('articles-pagination');
    paginationContainer.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous Button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
    paginationContainer.appendChild(prevLi);

    // Page Number Buttons
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        paginationContainer.appendChild(pageLi);
    }

    // Next Button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
    paginationContainer.appendChild(nextLi);

    // Add click handlers
    paginationContainer.querySelectorAll('.page-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page);
            if (page && page !== currentPage) {
                loadArticles(page);
            }
        });
    });
}

function renderOverview(overview) {
    const contentEl = document.getElementById('overview-stories');
    
    let html = '';
    
    overview.top_stories.forEach((story, index) => {
        html += `
            <div class="story-item">
                <h2 class="story-headline">
                    <a href="${story.primary_article.uri}" target="_blank">${story.headline}</a>
                </h2>
                
                <div class="story-summary">${story.summary}</div>
                
                <div class="story-meta">
                    <span class="source-info">
                        ${story.primary_article.source.name}
                        ${getBiasBadge(story.primary_article.source.bias)}
                        ${getFactualityBadge(story.primary_article.source.factuality)}
                    </span>
                    ${story.primary_article.publication_date ? 
                        `<span class="publish-date">${new Date(story.primary_article.publication_date).toLocaleDateString()}</span>` : 
                        ''
                    }
                </div>
                
                ${story.topic_description ? 
                    `<div class="story-context"><strong>Why it matters:</strong> ${story.topic_description}</div>` : 
                    ''
                }
                
                ${story.related_articles.length > 0 ? `
                    <div class="related-articles">
                        <h6>More Coverage</h6>
                        ${story.related_articles.map(related => `
                            <div class="related-item">
                                <strong>${related.source}</strong>${getBiasBadge(related.bias)}: 
                                ${related.url ? `<a href="${related.url}" target="_blank">${related.title}</a>` : related.title}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    contentEl.innerHTML = html;
}

function renderSixArticles(articles) {
    window.lastSixArticles = Array.isArray(articles) ? articles : [];
    const contentEl = document.getElementById('six-articles-report');

    console.log('renderSixArticles called with:', articles);
    console.log('Articles length:', articles ? articles.length : 'null/undefined');
    if (articles && articles.length > 0) {
        console.log('First article format:', articles[0].executive_takeaway ? 'New CEO Daily format' : 'Legacy format');
        console.log('Available fields:', Object.keys(articles[0]));
    }

    if (!articles || articles.length === 0) {
        contentEl.innerHTML = '<div class="alert alert-info">No articles available for analysis.</div>';
        return;
    }

    // Get current persona and article count from dropdowns
    const persona = document.getElementById('six-articles-persona')?.value || 'CEO';
    const articleCount = articles.length;

    // Map persona to full title
    const personaTitles = {
        'CEO': 'Chief Executive Officer',
        'CMO': 'Chief Marketing Officer',
        'CTO': 'Chief Technology Officer',
        'CISO': 'Chief Information Security Officer',
        'Custom': 'Executive'
    };
    const personaTitle = personaTitles[persona] || 'Executive';

    let html = `
        <div class="six-articles-analysis">
            <h3>ðŸŽ¯ ${persona} Daily - ${articleCount} Article${articleCount !== 1 ? 's' : ''}</h3>
            <p class="mb-2"><em>Curated for ${personaTitle}s</em></p>
            <p class="mb-4">Selected based on strategic relevance, novelty, credibility, and representativeness for executive decision-makers.</p>
            <div class="small text-muted mb-2">
                <i class="far fa-clock me-1"></i>Generated: ${new Date().toLocaleString()}
            </div>
        </div>
    `;
    
    // Render each article with new CEO format
    articles.forEach((article, index) => {
        const isStarred = article.uri && starredArticles.has(article.uri);
        
        // Get category color and icon
        const categoryColors = {
            'policy': 'text-danger',
            'market': 'text-success', 
            'tech': 'text-primary',
            'workforce': 'text-warning',
            'security': 'text-dark',
            'society': 'text-info'
        };
        const categoryColor = categoryColors[article.category] || 'text-secondary';
        
        // Get time horizon badge color
        const timeHorizonColors = {
            'Immediate': 'bg-danger',
            'Medium': 'bg-warning',
            'Long-term': 'bg-info'
        };
        const timeHorizonColor = timeHorizonColors[article.time_horizon] || 'bg-secondary';
        
        // Get risk/opportunity badge color
        const riskOpportunityColors = {
            'risk': 'bg-danger',
            'opportunity': 'bg-success',
            'mixed': 'bg-warning text-dark'
        };
        const riskOpportunityColor = riskOpportunityColors[article.risk_opportunity] || 'bg-secondary';
        
        // Get signal strength badge color
        const signalStrengthColors = {
            'weak': 'bg-light text-dark',
            'moderate': 'bg-warning text-dark',
            'strong': 'bg-success'
        };
        const signalStrengthColor = signalStrengthColors[article.signal_strength] || 'bg-secondary';
        
        html += `
            <div class="article-analysis mb-5 p-4 border rounded">
                <div class="article-header mb-3">
                    <h4 class="text-primary">${index + 1}. ${article.title} ${isStarred ? '<span class="badge bg-warning text-dark ms-2">Starred</span>' : ''}</h4>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                    <p class="text-muted mb-1"><strong>Source:</strong> ${article.source}</p>
                    ${article.date ? `<p class="text-muted mb-0"><strong>Date:</strong> ${article.date}</p>` : ''}
                            ${article.url ? `<p class="text-muted mb-0"><strong>URL:</strong> <a href="${article.url}" target="_blank" class="text-decoration-none">${article.url}</a></p>` : ''}
                        </div>
                        <div class="text-end">
                            ${article.category ? `<span class="badge bg-light text-dark mb-1 ${categoryColor}">${article.category.toUpperCase()}</span><br>` : ''}
                            ${article.scores ? `<small class="text-muted">Score: ${article.scores.relevance || 'N/A'}/5</small>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="article-content">
                    ${article.executive_takeaway ? `
                    <div class="section mb-3">
                        <h6 class="text-primary"><i class="fas fa-bullseye me-2"></i>Executive Takeaway</h6>
                        <div class="alert alert-primary py-2">
                            <strong>${article.executive_takeaway}</strong>
                    </div>
                    </div>` : ''}
                    
                    <div class="section mb-3">
                        <h6 class="text-secondary"><i class="fas fa-file-text me-2"></i>Summary</h6>
                        <p>${article.summary}</p>
                    </div>
                    
                    ${article.strategic_relevance ? `
                    <div class="section mb-3">
                        <h6 class="text-success"><i class="fas fa-chess me-2"></i>Strategic Relevance</h6>
                        <p>${article.strategic_relevance}</p>
                    </div>` : ''}
                    
                    <!-- Executive Indicators Row -->
                    ${(article.time_horizon || article.risk_opportunity || article.signal_strength) ? `
                    <div class="section mb-3">
                        <h6 class="text-info"><i class="fas fa-tachometer-alt me-2"></i>Executive Indicators</h6>
                        <div class="row">
                            ${article.time_horizon ? `
                            <div class="col-md-4 mb-2">
                                <small class="text-muted d-block">Time Horizon</small>
                                <span class="badge ${timeHorizonColor}">${article.time_horizon}</span>
                            </div>` : ''}
                            ${article.risk_opportunity ? `
                            <div class="col-md-4 mb-2">
                                <small class="text-muted d-block">Risk/Opportunity</small>
                                <span class="badge ${riskOpportunityColor}">${article.risk_opportunity}</span>
                            </div>` : ''}
                            ${article.signal_strength ? `
                            <div class="col-md-4 mb-2">
                                <small class="text-muted d-block">Signal Strength</small>
                                <span class="badge ${signalStrengthColor}">${article.signal_strength}</span>
                            </div>` : ''}
                    </div>
                    </div>` : ''}
                    
                    ${article.executive_action && Array.isArray(article.executive_action) && article.executive_action.length > 0 ? `
                    <div class="section mb-3">
                        <h6 class="text-warning"><i class="fas fa-tasks me-2"></i>Executive Actions</h6>
                        <ul class="mb-0">
                            ${article.executive_action.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                    
                    ${article.scores ? `
                    <div class="section mb-3">
                        <h6 class="text-dark"><i class="fas fa-chart-bar me-2"></i>Selection Scores</h6>
                        <div class="row">
                            <div class="col-6 col-md-3 mb-1">
                                <small class="text-muted">Relevance</small><br>
                                <span class="badge bg-primary">${article.scores.relevance || 'N/A'}/5</span>
                            </div>
                            <div class="col-6 col-md-3 mb-1">
                                <small class="text-muted">Novelty</small><br>
                                <span class="badge bg-info">${article.scores.novelty || 'N/A'}/5</span>
                            </div>
                            <div class="col-6 col-md-3 mb-1">
                                <small class="text-muted">Credibility</small><br>
                                <span class="badge bg-success">${article.scores.credibility || 'N/A'}/5</span>
                            </div>
                            <div class="col-6 col-md-3 mb-1">
                                <small class="text-muted">Representativeness</small><br>
                                <span class="badge bg-warning text-dark">${article.scores.representativeness || 'N/A'}/5</span>
                        </div>
                    </div>
                    </div>` : ''}
                    
                    <!-- Fallback: Show legacy fields if new format not available (excluding political perspectives) -->
                    ${(!article.executive_takeaway && !article.strategic_relevance && article.why_interesting) ? `
                    <div class="section mb-3">
                        <h6 class="text-success">Why It Matters</h6>
                        <p>${article.why_interesting}</p>
                    </div>` : ''}
                    
                    <!-- Format status notice -->
                    ${!article.executive_takeaway ? `
                    <div class="section mb-3" style="background: var(--colors-warning-2); padding: 15px; border-radius: 5px; border-left: 4px solid var(--colors-warning-9);">
                        <h6 class="text-warning"><i class="fas fa-sync-alt me-2"></i>New CEO Daily Format Available</h6>
                        <div class="text-dark small">
                            <p class="mb-2">This analysis uses the legacy format. Regenerate to get the new <strong>CEO Daily Top-6</strong> format with:</p>
                            <ul class="mb-2 small">
                                <li><strong>Executive Takeaway</strong> - Critical insight in ~15 words</li>
                                <li><strong>Strategic Relevance</strong> - Why it matters for executives</li>
                                <li><strong>Time Horizon</strong> - Immediate/Medium/Long-term impact</li>
                                <li><strong>Risk/Opportunity</strong> - Assessment for decision-makers</li>
                                <li><strong>Executive Actions</strong> - Specific next steps to take</li>
                                <li><strong>Selection Scores</strong> - Relevance/novelty/credibility ratings</li>
                            </ul>
                            <button class="btn btn-sm btn-warning" onclick="loadSixArticles(true)">
                                <i class="fas fa-magic me-1"></i>Regenerate with CEO Daily Format
                            </button>
                        </div>
                    </div>` : ''}
                    
                    <!-- Research Actions -->
                    <div class="section">
                        <h6 class="text-primary"><i class="fas fa-search me-2"></i>Research & Analysis Options</h6>
                        
                        <!-- Primary Analysis Options -->
                        <div class="mb-2">
                            <small class="text-muted fw-bold">Deep Analysis:</small>
                            <div class="d-flex gap-1 flex-wrap mt-1">
                                <button class="btn btn-sm btn-outline-primary" onclick="launchSixArticleDeepDive('${escapeHTML(article.title)}', '${article.url || ''}')">
                                    <i class="fas fa-microscope me-1"></i>Deep Dive
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="launchSixArticleConsensus('${escapeHTML(article.title)}', '${article.url || ''}')">
                                    <i class="fas fa-balance-scale me-1"></i>Consensus Analysis
                                </button>
                                <button class="btn btn-sm btn-outline-dark" onclick="launchSixArticleTimeline('${escapeHTML(article.title)}', '${article.url || ''}')">
                                    <i class="fas fa-clock me-1"></i>Impact Timeline
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="launchSixArticleChat('${escapeHTML(article.title)}', '${article.url || ''}')">
                                    <i class="fas fa-comments me-1"></i>Ask Auspex
                                </button>
                            </div>
                        </div>
                        
                        <!-- Thematic Research Options -->
                        ${(article.category || article.strategic_relevance) ? `
                        <div class="mb-2">
                            <small class="text-muted fw-bold">Thematic Research:</small>
                            <div class="d-flex gap-1 flex-wrap mt-1">
                                ${article.category ? `
                                <button class="btn btn-sm btn-outline-success" onclick="launchAuspexResearchFromInsight('${escapeJS(article.category)} developments in AI', 'category_deep')">
                                    <i class="fas fa-layer-group me-1"></i>${article.category} Trends
                                </button>` : ''}
                                ${article.strategic_relevance ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="launchAuspexResearchFromInsight('strategic implications of ${escapeJS(article.title)}', 'strategic_analysis')">
                                    <i class="fas fa-chess me-1"></i>Strategic Impact
                                </button>` : ''}
                                ${article.time_horizon ? `
                                <button class="btn btn-sm btn-outline-info" onclick="launchAuspexResearchFromInsight('${article.time_horizon.toLowerCase()} impact scenarios for ${escapeJS(article.title)}', 'timeline_analysis')">
                                    <i class="fas fa-hourglass me-1"></i>${article.time_horizon} Impact
                                </button>` : ''}
                            </div>
                        </div>` : ''}
                        
                        <!-- Utility Options -->
                        <div>
                            <small class="text-muted fw-bold">View Options:</small>
                            <div class="d-flex gap-1 flex-wrap mt-1">
                                ${article.url ? `
                                <button class="btn btn-sm btn-outline-info" onclick="window.open('${article.url}', '_blank')" title="View original article">
                                    <i class="fas fa-external-link-alt me-1"></i>Read Original
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="window.open('https://12ft.io/${article.url}', '_blank')" title="Bypass paywall">
                                    <i class="fas fa-unlock-alt me-1"></i>12ft.io
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="window.open('https://archive.is/${article.url}', '_blank')" title="Archived version">
                                    <i class="fas fa-archive me-1"></i>Archive
                                </button>` : ''}
                                <button class="btn btn-sm btn-outline-success" onclick="openSixArticleAnnotation('${article.url || ''}', '${escapeHTML(article.title)}')">
                                    <i class="fas fa-sticky-note me-1"></i>Annotate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Related Articles Section (if available) -->
                    ${article.related_articles && article.related_articles.length > 0 ? `
                    <div class="section mt-3">
                        <h6 class="text-primary">Related Articles</h6>
                        <ul class="list-unstyled mb-0">
                            ${article.related_articles.map(related => `
                                <li class="py-1">
                                    <div class="d-flex align-items-start justify-content-between gap-2">
                                        <div class="flex-grow-1">
                                            <a href="${related.url}" target="_blank" rel="noopener" class="text-decoration-none small fw-semibold">${related.title}</a>
                                            <div class="small text-muted">
                                                <strong>Source:</strong> ${related.source}
                                                ${related.similarity_score ? `<span class=\"ms-2 badge bg-secondary\">${(related.similarity_score * 100).toFixed(0)}% similar</span>` : ''}
                                            </div>
                                            ${related.summary ? `<div class=\"small text-secondary\">${related.summary.length > 110 ? related.summary.substring(0,110) + 'â€¦' : related.summary}</div>` : ''}
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    contentEl.innerHTML = html;
}

function exportSixArticlesMarkdown() {
    const articles = window.lastSixArticles || [];
    if (!articles.length) {
        showNotification('No Six Articles to export. Generate first.', 'warning');
        return;
    }

    // Read current persona and article count selections
    const persona = document.getElementById('six-articles-persona')?.value || 'CEO';
    const articleCount = document.getElementById('six-articles-count')?.value || articles.length;

    const lines = [];
    // Dynamic title based on persona and article count
    lines.push(`# ${persona} Daily - ${articleCount} Article${articleCount != 1 ? 's' : ''}`);
    lines.push('');
    lines.push('_News as Strategic Intelligence: Curated for Executive Decision-Making_');
    lines.push('');
    const generatedAt = new Date().toISOString();
    lines.push(`**Generated:** ${generatedAt}`);
    lines.push(`**Persona:** ${persona} (Chief ${persona === 'CEO' ? 'Executive' : persona === 'CMO' ? 'Marketing' : persona === 'CTO' ? 'Technology' : persona === 'CISO' ? 'Information Security' : 'Executive'} Officer)`);
    lines.push('');
    articles.forEach((a, idx) => {
        const title = a.title || 'Untitled';
        const url = a.url || a.uri || '';
        const header = url ? `${idx+1}. ${title} [link](${url})` : `${idx+1}. ${title}`;
        lines.push(`## ${header}`);
        if (a.executive_takeaway) {
            lines.push(`> ${a.executive_takeaway}`);
        }
        if (a.summary) {
            lines.push('');
            lines.push(a.summary);
        }
        const meta = [];
        if (a.source) meta.push(`Source: ${a.source}`);
        if (a.date) meta.push(`Date: ${a.date}`);
        if (a.time_horizon) meta.push(`Time horizon: ${a.time_horizon}`);
        if (a.risk_opportunity) meta.push(`Risk/Opportunity: ${a.risk_opportunity}`);
        if (a.signal_strength) meta.push(`Signal strength: ${a.signal_strength}`);
        if (meta.length) {
            lines.push('');
            lines.push(meta.map(m => `- ${m}`).join('\n'));
        }
        if (Array.isArray(a.executive_action) && a.executive_action.length) {
            lines.push('');
            lines.push('**Executive actions**');
            a.executive_action.forEach(act => lines.push(`- ${act}`));
        }
        if (Array.isArray(a.related_articles) && a.related_articles.length) {
            lines.push('');
            lines.push('**Related coverage**');
            a.related_articles.forEach(r => {
                const rt = r.title || 'Related';
                if (r.url) lines.push(`- ${r.source ? r.source+': ' : ''}[${rt}](${r.url})`);
                else lines.push(`- ${r.source ? r.source+': ' : ''}${rt}`);
            });
        }
        lines.push('');
    });
    const blob = new Blob([lines.join('\n')], { type: 'text/markdown;charset=utf-8' });
    const urlObj = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlObj;
    // Dynamic filename based on persona and date
    a.download = `${persona.toLowerCase()}-daily-${articleCount}-articles-${new Date().toISOString().slice(0,10)}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(urlObj);
}

function exportSixArticlesHTML() {
    const articles = window.lastSixArticles || [];
    if (!articles.length) {
        showNotification('No Six Articles to export. Generate first.', 'warning');
        return;
    }

    // Read current persona and article count selections
    const persona = document.getElementById('six-articles-persona')?.value || 'CEO';
    const articleCount = document.getElementById('six-articles-count')?.value || articles.length;

    const esc = (s) => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const items = articles.map((a, idx) => `
<article class="sa-item">
  <h2>${idx+1}. ${esc(a.title || 'Untitled')}</h2>
  ${a.url || a.uri ? `<p><a href="${esc(a.url || a.uri)}" target="_blank" rel="noopener">Read original</a></p>` : ''}
  ${a.executive_takeaway ? `<blockquote>${esc(a.executive_takeaway)}</blockquote>` : ''}
  ${a.summary ? `<p>${esc(a.summary)}</p>` : ''}
  <ul class="sa-meta">
    ${a.source ? `<li><strong>Source:</strong> ${esc(a.source)}</li>` : ''}
    ${a.date ? `<li><strong>Date:</strong> ${esc(a.date)}</li>` : ''}
    ${a.time_horizon ? `<li><strong>Time horizon:</strong> ${esc(a.time_horizon)}</li>` : ''}
    ${a.risk_opportunity ? `<li><strong>Risk/Opportunity:</strong> ${esc(a.risk_opportunity)}</li>` : ''}
    ${a.signal_strength ? `<li><strong>Signal strength:</strong> ${esc(a.signal_strength)}</li>` : ''}
  </ul>
  ${Array.isArray(a.executive_action) && a.executive_action.length ? `
  <div class="sa-actions">
    <h3>Executive actions</h3>
    <ul>
      ${a.executive_action.map(act => `<li>${esc(act)}</li>`).join('')}
    </ul>
  </div>` : ''}
  ${Array.isArray(a.related_articles) && a.related_articles.length ? `
  <div class="sa-related">
    <h4>Related coverage</h4>
    <ul>
      ${a.related_articles.map(r => `<li>${esc(r.source || '')}${r.source ? ': ' : ''}${r.url ? `<a href="${esc(r.url)}" target="_blank" rel="noopener">${esc(r.title || 'Related')}</a>` : esc(r.title || 'Related')}</li>`).join('')}
    </ul>
  </div>` : ''}
</article>`).join('\n');

    const personaFullName = persona === 'CEO' ? 'Chief Executive Officer' :
                             persona === 'CMO' ? 'Chief Marketing Officer' :
                             persona === 'CTO' ? 'Chief Technology Officer' :
                             persona === 'CISO' ? 'Chief Information Security Officer' : 'Executive';

    const html = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${persona} Daily - ${articleCount} Article${articleCount != 1 ? 's' : ''}</title>
  <style>
    body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.6;}
    h1{font-size: 1.8rem; margin: 0 0 10px;}
    .subtitle{color:var(--colors-neutral-8); font-style:italic; margin-bottom:20px;}
    .meta-info{background:var(--colors-neutral-2); border-left:4px solid var(--colors-info-5); padding:10px 15px; margin-bottom:20px;}
    .sa-item{border-top: 1px solid var(--colors-neutral-4); padding-top: 20px; margin-top: 20px;}
    blockquote{background:var(--colors-neutral-2); border-left:4px solid var(--colors-neutral-5); margin:10px 0; padding:10px 15px;}
    .sa-meta{color:#555}
  </style>
  <meta name="robots" content="noindex,follow">
</head>
<body>
  <h1>${persona} Daily - ${articleCount} Article${articleCount != 1 ? 's' : ''}</h1>
  <p class="subtitle">News as Strategic Intelligence: Curated for Executive Decision-Making</p>
  <div class="meta-info">
    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
    <p><strong>Persona:</strong> ${persona} (${personaFullName})</p>
  </div>
  ${items}
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const urlObj = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlObj;
    // Dynamic filename based on persona and date
    a.download = `${persona.toLowerCase()}-daily-${articleCount}-articles-${new Date().toISOString().slice(0,10)}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(urlObj);
}

function exportSixArticlesEnhanced() {
    const articles = window.lastSixArticles || [];
    if (!articles.length) {
        showNotification('No Six Articles to export. Generate first.', 'warning');
        return;
    }
    const esc = (s) => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    const items = articles.map((a, idx) => `
    <article class="article-card">
        <div class="article-number">${idx + 1}</div>
        <div class="article-content">
            <h2 class="article-title">${esc(a.title || 'Untitled')}</h2>

            ${a.url || a.uri ? `<a class="article-link" href="${esc(a.url || a.uri)}" target="_blank" rel="noopener">
                <i class="link-icon">ðŸ”—</i> Read original article
            </a>` : ''}

            ${a.executive_takeaway ? `
            <div class="executive-takeaway">
                <div class="section-label">ðŸ’¡ Executive Takeaway</div>
                <p>${esc(a.executive_takeaway)}</p>
            </div>` : ''}

            ${a.summary ? `
            <div class="article-summary">
                <div class="section-label">ðŸ“ Summary</div>
                <p>${esc(a.summary)}</p>
            </div>` : ''}

            <div class="article-meta">
                ${a.source ? `<span class="meta-item"><strong>Source:</strong> ${esc(a.source)}</span>` : ''}
                ${a.date ? `<span class="meta-item"><strong>Date:</strong> ${esc(a.date)}</span>` : ''}
                ${a.time_horizon ? `<span class="meta-item time-horizon"><strong>â±ï¸ Time Horizon:</strong> ${esc(a.time_horizon)}</span>` : ''}
                ${a.risk_opportunity ? `<span class="meta-item risk-opp"><strong>âš¡ Type:</strong> ${esc(a.risk_opportunity)}</span>` : ''}
                ${a.signal_strength ? `<span class="meta-item signal-strength"><strong>ðŸ“¡ Signal:</strong> ${esc(a.signal_strength)}</span>` : ''}
            </div>

            ${Array.isArray(a.executive_action) && a.executive_action.length ? `
            <div class="executive-actions">
                <div class="section-label">ðŸŽ¯ Recommended Actions</div>
                <ul class="actions-list">
                    ${a.executive_action.map(act => `<li>${esc(act)}</li>`).join('')}
                </ul>
            </div>` : ''}

            ${Array.isArray(a.related_articles) && a.related_articles.length ? `
            <div class="related-articles">
                <div class="section-label">ðŸ”— Related Coverage</div>
                <ul class="related-list">
                    ${a.related_articles.map(r => `
                    <li>
                        ${r.url ? `<a href="${esc(r.url)}" target="_blank" rel="noopener">${esc(r.title || 'Related article')}</a>` : esc(r.title || 'Related article')}
                        ${r.source ? `<span class="related-source">${esc(r.source)}</span>` : ''}
                    </li>`).join('')}
                </ul>
            </div>` : ''}
        </div>
    </article>`).join('\n');

    const html = `<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Six Most Important Articles - Executive Briefing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
            line-height: 1.6;
            color: #2d3748;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 40px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-bottom: 4px solid var(--colors-accent-7);
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .header .subtitle {
            color: #718096;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .generated-date {
            margin-top: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 25px;
            display: inline-block;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .articles-container {
            background: white;
            padding: 40px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .article-card {
            background: linear-gradient(135deg, #f6f8fb 0%, var(--colors-white) 100%);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-left: 6px solid;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .article-card:nth-child(6n+1) { border-left-color: var(--colors-accent-7); }
        .article-card:nth-child(6n+2) { border-left-color: #667eea; }
        .article-card:nth-child(6n+3) { border-left-color: #f093fb; }
        .article-card:nth-child(6n+4) { border-left-color: #4facfe; }
        .article-card:nth-child(6n+5) { border-left-color: #43e97b; }
        .article-card:nth-child(6n+6) { border-left-color: #fa709a; }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .article-number {
            position: absolute;
            top: -12px;
            left: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .article-title {
            font-size: 1.75rem;
            color: #1a202c;
            margin-bottom: 16px;
            font-weight: 700;
            line-height: 1.3;
        }

        .article-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 20px;
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .article-link:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(4px);
        }

        .link-icon {
            font-style: normal;
        }

        .section-label {
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #4a5568;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .executive-takeaway {
            background: linear-gradient(135deg, var(--colors-white)5f7 0%, var(--colors-white)bf0 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--colors-accent-7);
        }

        .executive-takeaway p {
            color: #2d3748;
            font-size: 1.05rem;
            font-weight: 500;
            line-height: 1.7;
        }

        .article-summary {
            margin: 20px 0;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .article-summary p {
            color: #4a5568;
            line-height: 1.8;
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin: 24px 0;
            padding: 16px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .meta-item {
            font-size: 0.9rem;
            color: #4a5568;
            padding: 6px 12px;
            background: #f7fafc;
            border-radius: 6px;
        }

        .meta-item strong {
            color: #2d3748;
        }

        .time-horizon { background: rgba(102, 126, 234, 0.1); }
        .risk-opp { background: rgba(246, 173, 85, 0.1); }
        .signal-strength { background: rgba(67, 233, 123, 0.1); }

        .executive-actions {
            margin: 24px 0;
            padding: 20px;
            background: linear-gradient(135deg, #e0f2fe 0%, #e0e7ff 100%);
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .actions-list {
            list-style: none;
            margin-top: 12px;
        }

        .actions-list li {
            padding: 12px 16px 12px 40px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .actions-list li:before {
            content: "â†’";
            position: absolute;
            left: 16px;
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .related-articles {
            margin: 24px 0;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .related-list {
            list-style: none;
            margin-top: 12px;
        }

        .related-list li {
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .related-list li:last-child {
            border-bottom: none;
        }

        .related-list a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .related-list a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .related-source {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: #e2e8f0;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #4a5568;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            color: #718096;
            font-size: 0.9rem;
        }

        @media print {
            body {
                background: white;
                padding: 20px;
            }
            .article-card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #e2e8f0;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            .article-title {
                font-size: 1.4rem;
            }
            .article-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
    <meta name="robots" content="noindex,follow">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Six Most Important Articles</h1>
            <p class="subtitle">Executive Strategic Briefing</p>
            <div class="generated-date">Generated: ${new Date().toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}</div>
        </div>
        <div class="articles-container">
            ${items}
        </div>
        <div class="footer">
            <p><strong>Aunoo AI</strong> - Strategic Intelligence Platform</p>
            <p style="margin-top: 8px; font-size: 0.85rem;">This briefing was curated by AI to highlight the most strategically important developments</p>
        </div>
    </div>
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const urlObj = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlObj;
    a.download = `six-articles-enhanced-${new Date().toISOString().slice(0,10)}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(urlObj);
    showNotification('Enhanced HTML exported successfully!', 'success');
}

async function generateSixArticlesPodcast() {
    const articles = window.lastSixArticles || [];
    if (!articles.length) {
        showNotification('No Six Articles available. Generate the report first.', 'warning');
        return;
    }

    // Show loading state
    showPodcastLoading();

    try {
        // Extract article URIs from the six articles data
        const articleUris = articles.map(article => {
            // Try different possible URI fields
            return article.uri || article.url || article.article_uri;
        }).filter(Boolean);

        if (!articleUris.length) {
            throw new Error('No valid article URIs found in Six Articles data');
        }

        // Get user selections
        const model = document.getElementById('model-select').value;
        const voiceId = document.getElementById('six-articles-voice').value;
        const lengthPerArticle = parseInt(document.getElementById('six-articles-length').value);
        const articleCount = parseInt(document.getElementById('six-articles-count').value);

        const response = await fetch('/api/generate_tts_podcast', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                podcast_name: "Six Articles Briefing",
                episode_title: `Six Articles - ${new Date().toLocaleDateString()}`,
                mode: "bulletin",
                model: model,
                host_voice_id: voiceId,
                article_uris: articleUris,
                length_per_article: lengthPerArticle,
                article_count: articleCount
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        pollPodcastStatus(result.podcast_id);
    } catch (error) {
        hidePodcastLoading();
        showNotification('Error generating podcast: ' + error.message, 'error');
    }
}

function showPodcastLoading() {
    // Find the export dropdown button and show loading state
    const exportBtn = document.querySelector('.btn-group .dropdown-toggle');
    if (exportBtn) {
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        exportBtn.disabled = true;
    }
    
    // Show notification
    showNotification('Generating podcast from Six Articles...', 'info');
}

function hidePodcastLoading() {
    // Restore the export dropdown button
    const exportBtn = document.querySelector('.btn-group .dropdown-toggle');
    if (exportBtn) {
        exportBtn.innerHTML = '<i class="fas fa-download me-2"></i>Export';
        exportBtn.disabled = false;
    }
}

async function loadAvailableVoices() {
    try {
        const response = await fetch('/api/available_voices');
        if (!response.ok) {
            console.error('Failed to load voices');
            return;
        }

        const voices = await response.json();
        const voiceSelect = document.getElementById('six-articles-voice');
        if (!voiceSelect) return;

        // Clear existing options
        voiceSelect.innerHTML = '';

        // Add voices from API
        voices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.voice_id;
            option.textContent = `${voice.name}${voice.category ? ` (${voice.category})` : ''}`;

            // Select Rachel as default
            if (voice.voice_id === '21m00Tcm4TlvDq8ikWAM') {
                option.selected = true;
            }

            voiceSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading voices:', error);
    }
}

function pollPodcastStatus(podcastId) {
    const checkStatus = async () => {
        try {
            const response = await fetch(`/api/podcast/status/${podcastId}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            switch (data.status) {
                case 'completed':
                    hidePodcastLoading();
                    showPodcastDownload(data.audio_url, data.title);
                    break;
                case 'failed':
                    hidePodcastLoading();
                    showNotification('Podcast generation failed', 'error');
                    break;
                case 'processing':
                default:
                    // Continue polling
                    setTimeout(checkStatus, 5000);
                    break;
            }
        } catch (error) {
            hidePodcastLoading();
            showNotification('Error checking podcast status: ' + error.message, 'error');
        }
    };
    
    // Start polling
    checkStatus();
}

function showPodcastDownload(audioUrl, title) {
    // Create download link
    const downloadLink = document.createElement('a');
    downloadLink.href = audioUrl;
    downloadLink.download = `${title || 'six-articles-podcast'}.mp3`;
    downloadLink.className = 'btn btn-success btn-sm';
    downloadLink.innerHTML = '<i class="fas fa-download me-2"></i>Download Podcast';
    
    // Find the Six Articles export area specifically
    const sixArticlesTab = document.getElementById('six-articles-content');
    const exportArea = sixArticlesTab ? sixArticlesTab.querySelector('.d-flex.gap-2') : null;
    if (exportArea) {
        // Remove any existing podcast download link
        const existingLink = exportArea.querySelector('.podcast-download-link');
        if (existingLink) {
            existingLink.remove();
        }
        
        // Add new download link
        downloadLink.classList.add('podcast-download-link');
        exportArea.appendChild(downloadLink);
    }
    
    showNotification('Podcast generated successfully!', 'success');
}

function getBiasBadge(bias) {
    if (!bias) return '';
    
    const biasClasses = {
        'left': 'bias-left',
        'left-center': 'bias-left-center',
        'center': 'bias-center',
        'right-center': 'bias-right-center',
        'right': 'bias-right',
        'mixed': 'bias-mixed'
    };
    
    const className = biasClasses[bias] || 'bias-mixed';
    return `<span class="bias-badge ${className}">${bias}</span>`;
}

function getFactualityBadge(factuality) {
    if (!factuality) return '';
    
    const factualityClasses = {
        'very-high': 'factuality-very-high',
        'high': 'factuality-high',
        'mostly-factual': 'factuality-mostly-factual',
        'mixed': 'factuality-mixed',
        'low': 'factuality-low',
        'very-low': 'factuality-low'
    };
    
    const className = factualityClasses[factuality] || 'factuality-mixed';
    const displayText = factuality.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
    return `<span class="factuality-badge ${className}">${displayText}</span>`;
}

// Legacy share functionality - replaced with save feed functionality above

// Old share functionality removed - these elements no longer exist

function showSaveButton() {
    // Save and export buttons have been removed - this function is now a no-op
    // Keep for compatibility with existing calls
}

function renderArticlesPagination(data) {
    const paginationContainer = document.getElementById('articles-pagination');
    if (!paginationContainer || !data.total_pages || data.total_pages <= 1) {
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }

    const currentPage = data.page || 1;
    const totalPages = data.total_pages;
    
    let html = '<nav><ul class="pagination pagination-sm justify-content-center">';
    
    // Previous button
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${currentPage - 1}); return false;">Previous</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Previous</span></li>';
    }
    
    // Page numbers (show max 5 pages around current)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(1); return false;">1</a></li>';
        if (startPage > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${i}); return false;">${i}</a></li>`;
        }
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadArticles(${currentPage + 1}); return false;">Next</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Next</span></li>';
    }
    
    html += '</ul></nav>';
    paginationContainer.innerHTML = html;
}

// Calendar functionality
let availableDates = {};
let selectedDate = '2025-09-15';
// Set calendar to show September 2025 (month of selected date)
let currentCalendarMonth = 8; // September (0-based)
let currentCalendarYear = 2025;

async function loadAvailableDates() {
    console.log('Starting loadAvailableDates...');
    try {
        console.log('Fetching available dates from API...');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch('/api/news-feed/available-dates', {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        console.log('Response received:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Data parsed:', data);
        
        if (data.success) {
            console.log('Processing dates...');
            availableDates = {};
            data.dates.forEach(dateInfo => {
                availableDates[dateInfo.date] = dateInfo.count;
            });
            console.log('Available dates processed:', Object.keys(availableDates).length, 'dates');
            
            console.log('Rendering calendar...');
            renderCalendar();
            console.log('Calendar rendered');

            // Hide loading, show calendar
            const loading = document.getElementById('calendar-loading');
            const view = document.getElementById('calendar-view');
            if (loading) loading.style.display = 'none';
            if (view) view.style.display = 'block';

            // Update selected-date count if known and initialize calendar to selected date month
            const countEl = document.getElementById('selected-date-count');
            const currentDate = document.getElementById('selected-date')?.value;
            if (countEl) countEl.textContent = String(availableDates[currentDate] ?? 0);
            
            // Set calendar to show the month of the selected date
            if (currentDate) {
                const [year, month] = currentDate.split('-').map(Number);
                currentCalendarYear = year;
                currentCalendarMonth = month - 1; // JS months are 0-based
            }
            console.log('loadAvailableDates completed successfully');
        } else {
            console.error('API returned success: false', data);
            throw new Error(data.message || 'Unknown error from API');
        }
    } catch (error) {
        console.error('Error loading available dates:', error);
        const loading = document.getElementById('calendar-loading');
        if (loading) {
            if (error.name === 'AbortError') {
                loading.innerHTML = `
                    <div class="text-danger">Calendar loading timed out.</div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableDates()">Retry</button>
                    <div class="mt-2 small text-muted">You can still use the date picker above to select dates.</div>
                `;
            } else {
                loading.innerHTML = `
                    <div class="text-danger">Failed to load calendar: ${error.message}</div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableDates()">Retry</button>
                    <div class="mt-2 small text-muted">You can still use the date picker above to select dates.</div>
                `;
            }
        }
    }
}

function renderCalendar() {
    console.log('renderCalendar started');
    const view = document.getElementById('calendar-view');
    const loading = document.getElementById('calendar-loading');
    if (!view) {
        console.error('calendar-view element not found');
        return;
    }

    if (loading) loading.style.display = 'none';
    console.log('Calendar loading hidden, building HTML...');

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Get first day of month and number of days
    const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
    const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeCalendarMonth(-1)">â€¹ Prev</button>
            <h6 class="mb-0">${monthNames[currentCalendarMonth]} ${currentCalendarYear}</h6>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeCalendarMonth(1)">Next â€º</button>
        </div>`;

    // Calendar header
    html += '<div class="row g-1 mb-2">';
    for (const day of dayNames) {
        html += `<div class="col text-center"><small class="text-muted fw-bold">${day}</small></div>`;
    }
    html += '</div>';

    // Calendar days
    html += '<div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
    
    // Empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day-empty" style="height: 40px;"></div>';
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const count = availableDates[dateStr] ?? 0;
        const isSelected = dateStr === selectedDate;
        const hasArticles = count > 0;
        
        let buttonClass = 'btn btn-sm w-100 h-100 d-flex flex-column justify-content-center align-items-center';
        if (isSelected) {
            buttonClass += ' btn-primary';
        } else if (hasArticles) {
            buttonClass += ' btn-outline-primary';
        } else {
            buttonClass += ' btn-outline-light text-muted';
        }

        html += `
            <button type="button" class="${buttonClass}" data-date="${dateStr}" style="height: 40px; font-size: 0.8rem;" ${!hasArticles ? 'disabled' : ''}>
                <div>${day}</div>
                ${hasArticles ? `<small class="badge bg-secondary rounded-pill" style="font-size: 0.6rem;">${count}</small>` : ''}
            </button>`;
    }

    html += '</div>';
    console.log('Calendar HTML built, setting innerHTML...');
    view.innerHTML = html;
    view.style.display = 'block';
    console.log('Calendar HTML set, wiring click handlers...');

    // Wire click handlers
    view.querySelectorAll('[data-date]:not([disabled])').forEach((btn) => {
        btn.addEventListener('click', () => {
            const d = btn.getAttribute('data-date');
            setSelectedDate(d);
        });
    });
    console.log('renderCalendar completed');
}

function changeCalendarMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    }
    renderCalendar();
}

function setSelectedDate(dateStr) {
    // Update global and hidden input
    selectedDate = dateStr;
    const hidden = document.getElementById('selected-date');
    if (hidden) hidden.value = dateStr;

    // Update header display
    const [y, m, d] = dateStr.split('-').map(Number);
    const display = document.getElementById('selected-date-text');
    if (display) {
        const dateObj = new Date(y, m - 1, d);
        display.textContent = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Update count immediately if known, otherwise loading
    const countEl = document.getElementById('selected-date-count');
    if (countEl) countEl.textContent = (availableDates[dateStr] ?? 'loading...');

    // Close the calendar collapse if open
    try {
        const collapseEl = document.getElementById('calendar-collapse');
        if (collapseEl && collapseEl.classList.contains('show') && window.bootstrap && bootstrap.Collapse) {
            const instance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
            instance.hide();
        }
    } catch (_) { /* no-op if bootstrap not available */ }

    // Reload content for the newly selected date
    loadArticles(1);
    loadSixArticles();
}

// Organizational profile management
async function loadOrganizationalProfiles() {
    try {
        const response = await fetch('/api/organizational-profiles');
        const data = await response.json();

        if (data.success && data.profiles) {
            const profileSelect = document.getElementById('profile-select');
            const profileDropdownMenu = document.getElementById('profile-dropdown-menu');

            // Clear existing options except the first
            profileSelect.innerHTML = '<option value="">General Analysis (No Profile)</option>';

            // Clear and rebuild dropdown menu
            if (profileDropdownMenu) {
                profileDropdownMenu.innerHTML = '<li><a class="dropdown-item profile-option" href="#" data-value="" onclick="setProfile(\'\'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: visible;"></i>General Analysis</a></li>';
            }

            // Add profiles
            data.profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name}${profile.is_default ? ' (Default)' : ''}`;
                option.title = `${profile.industry || 'General'} â€¢ ${profile.organization_type || 'Organization'}`;
                profileSelect.appendChild(option);

                // Also add to dropdown menu
                if (profileDropdownMenu) {
                    const li = document.createElement('li');
                    const profileText = `${profile.name}${profile.is_default ? ' (Default)' : ''}`;
                    li.innerHTML = `<a class="dropdown-item profile-option" href="#" data-value="${profile.id}" onclick="setProfile('${profile.id}'); return false;"><i class="fas fa-check me-2 text-success" style="visibility: hidden;"></i>${profileText}</a>`;
                    profileDropdownMenu.appendChild(li);
                }
            });

            // Restore saved profile selection after loading profiles
            const savedProfile = localStorage.getItem('newsFeedProfileId');
            if (savedProfile) {
                const opt = Array.from(profileSelect.options).find(o => o.value === savedProfile);
                if (opt) {
                    profileSelect.value = savedProfile;
                    setProfile(savedProfile); // Update visual state
                    console.log(`Restored saved profile: ${savedProfile}`);
                } else {
                    console.warn(`Saved profile ${savedProfile} not found in loaded profiles`);
                }
            }

            // Add change listener to save future selections (if not already added)
            if (!profileSelect.dataset.listenerAdded) {
                profileSelect.addEventListener('change', () => {
                    localStorage.setItem('newsFeedProfileId', profileSelect.value);
                    console.log(`Saved profile selection: ${profileSelect.value}`);
                    updateArticleCountForDateRange();
                });
                profileSelect.dataset.listenerAdded = 'true';
            }

            console.log(`Loaded ${data.profiles.length} organizational profiles`);
        }
    } catch (error) {
        console.error('Error loading organizational profiles:', error);
        showNotification('Failed to load organizational profiles', 'warning');
    }
}

// Profile Manager Functions
let currentEditingProfile = null;
let currentProfiles = [];

function showProfileManager() {
    loadOrganizationalProfilesForManager().then(() => {
        const modal = new bootstrap.Modal(document.getElementById('profileManagerModal'));
        modal.show();
    });
}

async function loadOrganizationalProfilesForManager() {
    try {
        const response = await fetch('/api/organizational-profiles');
        const data = await response.json();

        if (data.success && data.profiles) {
            currentProfiles = data.profiles;
            renderProfileList();

            // Also update the main dropdown
            loadOrganizationalProfiles();
        }
    } catch (error) {
        console.error('Error loading profiles for manager:', error);
        showNotification('Failed to load profiles', 'warning');
    }
}

function renderProfileList() {
    const profileList = document.getElementById('profileList');
    profileList.innerHTML = '';

    if (currentProfiles.length === 0) {
        profileList.innerHTML = '<div class="text-center text-muted p-3">No profiles yet. Create one to get started.</div>';
        return;
    }

    currentProfiles.forEach(profile => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${escapeHTML(profile.name)}</h6>
                    <small class="text-muted">${escapeHTML(profile.industry || 'General')} â€¢ ${escapeHTML(profile.organization_type || 'Organization')}</small>
                </div>
                <div class="btn-group-vertical btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editProfile(${profile.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteProfile(${profile.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        item.onclick = (e) => {
            e.preventDefault();
            editProfile(profile.id);
        };
        profileList.appendChild(item);
    });
}

function createNewProfile() {
    currentEditingProfile = null;
    clearProfileForm();
    document.getElementById('editorTitle').textContent = 'New Profile';
    showProfileEditor();
}

function editProfile(profileId) {
    const profile = currentProfiles.find(p => p.id === profileId);
    if (!profile) return;

    currentEditingProfile = profile;
    populateProfileForm(profile);
    document.getElementById('editorTitle').textContent = `Edit Profile: ${profile.name}`;
    showProfileEditor();
}

function showProfileEditor() {
    document.getElementById('profileEditorPlaceholder').style.display = 'none';
    document.getElementById('profileEditor').style.display = 'block';
}

function cancelEdit() {
    document.getElementById('profileEditor').style.display = 'none';
    document.getElementById('profileEditorPlaceholder').style.display = 'block';
    clearProfileForm();
    currentEditingProfile = null;
}

function clearProfileForm() {
    document.getElementById('profileName').value = '';
    document.getElementById('profileDescription').value = '';
    document.getElementById('profileIndustry').value = '';
    document.getElementById('profileOrganizationType').value = '';
    document.getElementById('profileRegion').value = '';
    document.getElementById('profileKeyConcerns').value = '';
    document.getElementById('profileStrategicPriorities').value = '';
    document.getElementById('profileRiskTolerance').value = 'medium';
    document.getElementById('profileInnovationAppetite').value = 'moderate';
    document.getElementById('profileDecisionMakingStyle').value = 'collaborative';
    document.getElementById('profileStakeholderFocus').value = '';
    document.getElementById('profileCompetitiveLandscape').value = '';
    document.getElementById('profileRegulatoryEnvironment').value = '';
    document.getElementById('profileCustomContext').value = '';
}

function populateProfileForm(profile) {
    document.getElementById('profileName').value = profile.name || '';
    document.getElementById('profileDescription').value = profile.description || '';
    document.getElementById('profileIndustry').value = profile.industry || '';
    document.getElementById('profileOrganizationType').value = profile.organization_type || '';
    document.getElementById('profileRegion').value = profile.region || '';
    document.getElementById('profileKeyConcerns').value = (profile.key_concerns || []).join(', ');
    document.getElementById('profileStrategicPriorities').value = (profile.strategic_priorities || []).join(', ');
    document.getElementById('profileRiskTolerance').value = profile.risk_tolerance || 'medium';
    document.getElementById('profileInnovationAppetite').value = profile.innovation_appetite || 'moderate';
    document.getElementById('profileDecisionMakingStyle').value = profile.decision_making_style || 'collaborative';
    document.getElementById('profileStakeholderFocus').value = (profile.stakeholder_focus || []).join(', ');
    document.getElementById('profileCompetitiveLandscape').value = (profile.competitive_landscape || []).join(', ');
    document.getElementById('profileRegulatoryEnvironment').value = (profile.regulatory_environment || []).join(', ');
    document.getElementById('profileCustomContext').value = profile.custom_context || '';
}

async function saveProfile() {
    const form = document.getElementById('profileForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const profileData = {
        name: document.getElementById('profileName').value,
        description: document.getElementById('profileDescription').value,
        industry: document.getElementById('profileIndustry').value,
        organization_type: document.getElementById('profileOrganizationType').value,
        region: document.getElementById('profileRegion').value,
        key_concerns: document.getElementById('profileKeyConcerns').value.split(',').map(s => s.trim()).filter(s => s),
        strategic_priorities: document.getElementById('profileStrategicPriorities').value.split(',').map(s => s.trim()).filter(s => s),
        risk_tolerance: document.getElementById('profileRiskTolerance').value,
        innovation_appetite: document.getElementById('profileInnovationAppetite').value,
        decision_making_style: document.getElementById('profileDecisionMakingStyle').value,
        stakeholder_focus: document.getElementById('profileStakeholderFocus').value.split(',').map(s => s.trim()).filter(s => s),
        competitive_landscape: document.getElementById('profileCompetitiveLandscape').value.split(',').map(s => s.trim()).filter(s => s),
        regulatory_environment: document.getElementById('profileRegulatoryEnvironment').value.split(',').map(s => s.trim()).filter(s => s),
        custom_context: document.getElementById('profileCustomContext').value
    };

    try {
        let response;
        if (currentEditingProfile) {
            // Update existing profile
            response = await fetch(`/api/organizational-profiles/${currentEditingProfile.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(profileData)
            });
        } else {
            // Create new profile
            response = await fetch('/api/organizational-profiles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(profileData)
            });
        }

        const result = await response.json();

        if (result.success) {
            showNotification(result.message || 'Profile saved successfully', 'success');
            await loadOrganizationalProfilesForManager();
            cancelEdit();
        } else {
            showNotification(result.message || 'Failed to save profile', 'error');
        }
    } catch (error) {
        console.error('Error saving profile:', error);
        showNotification('Error saving profile: ' + error.message, 'error');
    }
}

async function deleteProfile(profileId) {
    const profile = currentProfiles.find(p => p.id === profileId);
    if (!profile) return;

    if (!confirm(`Are you sure you want to delete the profile "${profile.name}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/organizational-profiles/${profileId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showNotification(result.message || 'Profile deleted successfully', 'success');
            await loadOrganizationalProfilesForManager();
            if (currentEditingProfile && currentEditingProfile.id === profileId) {
                cancelEdit();
            }
        } else {
            showNotification(result.message || 'Failed to delete profile', 'error');
        }
    } catch (error) {
        console.error('Error deleting profile:', error);
        showNotification('Error deleting profile: ' + error.message, 'error');
    }
}

// Date range handling
function handleDateRangeChange() {
    const dateRangeSelect = document.getElementById('date-range-select');
    const customDateSection = document.getElementById('custom-date-section');
    const dateRangeText = document.getElementById('date-range-text');
    const selectedDateInput = document.getElementById('selected-date');
    
    const selectedRange = dateRangeSelect.value;
    
    if (selectedRange === 'custom') {
        customDateSection.style.display = 'block';
        dateRangeText.textContent = 'Custom Date';
        // Use the custom date input value
        selectedDateInput.value = document.getElementById('custom-date-input').value;
    } else {
        customDateSection.style.display = 'none';
        
        // Calculate date range and update display
        const now = new Date();
        let startDate, endDate = now;
        let displayText = '';
        
        switch (selectedRange) {
            case '24h':
                startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                displayText = 'Last 24 Hours';
                selectedDateInput.value = now.toISOString().split('T')[0];
                break;
            case '72h':
                startDate = new Date(now.getTime() - 72 * 60 * 60 * 1000);
                displayText = 'Last 72 Hours';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '7d':
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                displayText = 'Last 7 Days';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
            case '30d':
                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                displayText = 'Last 30 Days';
                selectedDateInput.value = ''; // Clear single date, use date_range instead
                break;
        }
        
        dateRangeText.textContent = displayText;
        
        // Update the info text
        const dateRangeInfo = document.getElementById('date-range-info');
        if (dateRangeInfo) {
            if (selectedRange === 'all') {
                dateRangeInfo.textContent = 'All available articles';
            } else {
                const startDateStr = startDate ? startDate.toLocaleDateString() : '';
                const endDateStr = endDate.toLocaleDateString();
                dateRangeInfo.textContent = `${startDateStr} to ${endDateStr}`;
            }
        }
    }
    
    // Auto-reload articles when date range changes
    autoLoadArticles();
    
    // Clear insights when date range changes
    clearInsightsContent();
}

// Update article count for date range changes
async function updateArticleCountForDateRange() {
    const countEl = document.getElementById('selected-date-count');
    if (!countEl) return;
    
    try {
        countEl.textContent = 'loading...';
        
        const dateRangeEl = document.getElementById('date-range-select');
        if (!dateRangeEl) {
            console.warn('date-range-select element not found');
            countEl.textContent = '0';
            return;
        }
        const dateRangeValue = dateRangeEl.value;
        const params = new URLSearchParams({
            date_range: dateRangeValue,
            count_only: 'true'
        });
        
        // Add custom date if needed
        if (dateRangeValue === 'custom') {
            const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
            if (customDate) {
                params.append('date', customDate);
            }
        }
        
        // Add topic filter if set
        const topicEl = document.getElementById('topic-select');
        if (topicEl && topicEl.value) {
            params.append('topic', topicEl.value.trim());
        }
        
        // Make a lightweight request to get just the count
        const response = await fetch(`/api/news-feed/articles?${params}&per_page=1&page=1`);
        
        if (response.ok) {
            const data = await response.json();
            const total = data.articles?.total_items || 0;
            countEl.textContent = total.toString();
        } else {
            countEl.textContent = '0';
        }
    } catch (error) {
        console.error('Error updating article count:', error);
        countEl.textContent = '?';
    }
}

// Star functionality for articles
let starredArticles = new Set();

// Filter functionality for articles
let activeFilters = {
    bias: new Set(),
    factuality: new Set(),
    category: new Set(),
    signals: new Set()  // Add signal filtering
};

// Article view management (card vs table)
let currentArticleView = 'cards';
let groupDuplicateArticles = true; // Default to grouping enabled

function toggleArticleView(viewType) {
    currentArticleView = viewType;

    // Update button states
    document.getElementById('article-card-view-btn').classList.toggle('active', viewType === 'cards');
    document.getElementById('article-table-view-btn').classList.toggle('active', viewType === 'table');

    // Save preference
    try {
        localStorage.setItem('newsNarratorArticleView', viewType);
    } catch (e) {
        console.warn('Failed to save view preference:', e);
    }

    // Re-render with current view
    if (window.lastArticlesData) {
        renderArticles(window.lastArticlesData);
    }
}

// Load saved view preferences
document.addEventListener('DOMContentLoaded', function() {
    try {
        const savedView = localStorage.getItem('newsNarratorArticleView');
        if (savedView) {
            currentArticleView = savedView;
            document.getElementById('article-card-view-btn').classList.toggle('active', savedView === 'cards');
            document.getElementById('article-table-view-btn').classList.toggle('active', savedView === 'table');
        }

        // Grouping by title is always enabled
        groupDuplicateArticles = true;
    } catch (e) {
        console.warn('Failed to load view preferences:', e);
    }
});

function renderArticles(articlesData) {
    console.log('[DEBUG] renderArticles called with articlesData:', articlesData);
    console.log('[DEBUG] articlesData.items?', articlesData.items ? articlesData.items.length : 'undefined');

    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;

    // Remove table-view class for card view
    listContainer.classList.remove('table-view');

    listContainer.innerHTML = '';

    if (!articlesData.items || articlesData.items.length === 0) {
        console.log('[DEBUG] No articles in articlesData.items - showing alert');
        listContainer.innerHTML = '<div class="alert alert-info">No articles available for the current filters. Try adjusting your search or date range.</div>';
        return;
    }

    console.log('[DEBUG] Building filter badges from', articlesData.items.length, 'articles');
    // Build filter badges from available data
    buildFilterBadges(articlesData.items);

    console.log('[DEBUG] Applying article filters to', articlesData.items.length, 'articles');
    // Apply current filters
    let filteredArticles = applyArticleFilters(articlesData.items);
    console.log('[DEBUG] After filtering, have', filteredArticles.length, 'articles');

    // Group duplicates if enabled
    if (groupDuplicateArticles) {
        filteredArticles = groupArticlesByTitle(filteredArticles);
    }

    // Render based on current view
    if (currentArticleView === 'table') {
        renderArticleTable(filteredArticles);
        return;
    }

    // Card view rendering
    const articlesList = document.createElement('div');
    articlesList.className = 'list-group list-group-flush mt-2';
    
    filteredArticles.forEach(article => {
        const articleItem = document.createElement('div');
        const isGrouped = article.grouped && article.groupedArticles;
        articleItem.className = `list-group-item position-relative ${isGrouped ? 'grouped-article' : ''}`;

        const isStarred = starredArticles.has(article.uri);
        
        articleItem.innerHTML = `
            <!-- Remove button (top-right) -->
            <button class="btn btn-sm position-absolute" 
                    style="top: 8px; right: 8px; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; border: none; background: rgba(220, 53, 69, 0.1); color: var(--colors-error-9); border-radius: 50%;"
                    onclick="excludeArticle('${article.uri}', this)"
                    onmouseover="this.style.background='var(--colors-error-9)'; this.style.color='white';"
                    onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'; this.style.color='var(--colors-error-9)';"
                    title="Remove article">Ã—</button>
            
            <!-- Star button (top-left) -->
            <button class="btn btn-sm position-absolute star-btn ${isStarred ? 'starred' : ''}" 
                    style="top: 8px; left: 8px; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 1; border: none; background: ${isStarred ? 'var(--colors-warning-9)' : 'rgba(255, 193, 7, 0.1)'}; color: ${isStarred ? 'white' : 'var(--colors-warning-9)'}; border-radius: 50%;"
                    onclick="toggleStarArticle('${article.uri}', this)"
                    title="${isStarred ? 'Remove from Six Articles' : 'Add to Six Articles'}">â˜…</button>
            
            
            <!-- Expand arrow (left side) -->
            <button class="btn btn-sm position-absolute expand-arrow-btn"
                    style="top: 50%; left: -2px; transform: translateY(-50%); width: 20px; height: 40px; padding: 0; font-size: 12px; border: none; background: var(--colors-info-5); color: white; border-radius: 0 8px 8px 0; box-shadow: 2px 0 4px rgba(0,0,0,0.1);"
                    onclick="toggleArticleDetails('${article.uri}', this)"
                    title="Show detailed view">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Content -->
            <div style="margin-left: 30px; margin-right: 30px;">
                <h6 class="mb-2">
                    <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                        ${escapeHTML(article.title)}
                    </a>
                    ${article.grouped && article.groupedArticles ? `<span class="grouped-sources-badge ms-2"><i class="fas fa-layer-group me-1"></i>${article.groupedArticles.length} sources</span>` : ''}
                    <span class="cached-indicator" id="cached-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none;">
                        <span class="badge bg-info text-white ms-2" style="font-size: 8px;">
                            <i class="fas fa-database me-1"></i>Cached
                        </span>
                    </span>
                    <span class="signal-flags" id="signal-flags-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}"></span>
                </h6>

                <!-- Metadata badges row -->
                <div class="d-flex flex-wrap gap-2 mb-2">
                    ${article.bias ? `<span class="badge ${getBiasClass(article.bias)}">${article.bias}</span>` : ''}
                    ${article.factual_reporting ? `<span class="badge ${getFactualityClass(article.factual_reporting)}">${article.factual_reporting}</span>` : ''}
                    ${article.mbfc_credibility_rating ? `<span class="badge bg-info text-white">${article.mbfc_credibility_rating}</span>` : ''}
                    ${article.category ? `<span class="badge bg-light text-dark">${article.category}</span>` : ''}
                </div>

                <p class="mb-1 small text-muted">
                    <i class="fas fa-building me-1"></i>${formatSource(article.news_source, article.uri)}
                    <span class="ms-2">
                        <i class="fas fa-calendar me-1"></i>${formatPubDate(article.publication_date, false)}
                    </span>
                </p>
                <p class="mb-0 small text-secondary" style="line-height: 1.4;">
                    ${escapeHTML(article.summary)}
                </p>
            </div>
            
            <!-- Detailed View (Initially Hidden) -->
            <div class="article-details" id="details-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-left: 20px; margin-right: 10px; margin-top: 15px; padding: 20px; background: var(--colors-neutral-2); border-radius: 8px; border-left: 4px solid var(--colors-info-5); position: relative;">

                <!-- Close button at top-right -->
                <button class="btn btn-sm position-absolute"
                        style="top: 8px; right: 8px; width: 28px; height: 28px; padding: 0; border-radius: 50%; background: white; border: 1px solid var(--colors-neutral-5); color: var(--colors-neutral-8); font-size: 16px; line-height: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10;"
                        onclick="toggleArticleDetails('${article.uri}', this.closest('.list-group-item').querySelector('.expand-arrow-btn'))"
                        onmouseover="this.style.background='var(--colors-error-9)'; this.style.color='white'; this.style.borderColor='var(--colors-error-9)';"
                        onmouseout="this.style.background='white'; this.style.color='var(--colors-neutral-8)'; this.style.borderColor='var(--colors-neutral-5)';"
                        title="Close detailed view">
                    <i class="fas fa-times"></i>
                </button>

                <!-- Metadata Badges (Horizontal Layout - Full Width) -->
                <div class="metadata-badges mb-3">
                    ${article.bias ? `<span class="badge ${getBiasClass(article.bias)}"><i class="fas fa-balance-scale me-1"></i>${article.bias}</span>` : ''}
                    ${article.factual_reporting ? `<span class="badge ${getFactualityClass(article.factual_reporting)}"><i class="fas fa-check-circle me-1"></i>${article.factual_reporting}</span>` : ''}
                    ${article.mbfc_credibility_rating ? `<span class="badge bg-info text-white"><i class="fas fa-certificate me-1"></i>${article.mbfc_credibility_rating}</span>` : ''}
                    ${article.category ? `<span class="badge bg-light text-dark"><i class="fas fa-folder me-1"></i>${article.category}</span>` : ''}
                    ${article.sentiment ? `<span class="badge ${getSentimentClass(article.sentiment)}"><i class="fas fa-heart me-1"></i>${article.sentiment}</span>` : ''}
                </div>

                <!-- Two Column Grid Layout -->
                <div class="article-details-grid">
                    <!-- Left Column: Main Content -->
                    <div>
                        <!-- Full Summary Section -->
                        <div class="mb-3">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-align-left me-2"></i>Full Summary
                            </h6>
                            <p class="small mb-0">${escapeHTML(article.summary)}</p>
                        </div>

                        <!-- Auspex Analysis Section -->
                        <div class="mb-3">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-search-plus me-2"></i>Auspex Analysis
                            </h6>
                            <div class="analysis-content bg-white p-3 rounded border" id="analysis-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                <div class="analysis-text bg-light p-2 rounded small text-muted">
                                    Analysis will be generated automatically when you expand this article.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Sidebar Content -->
                    <div>
                        ${article.grouped && article.groupedArticles ? `
                        <!-- Grouped Sources Section -->
                        <div class="mb-3 p-3 bg-white rounded border">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-newspaper me-2"></i>All Sources (${article.groupedArticles.length})
                            </h6>
                            <div class="d-flex flex-column gap-2">
                                ${article.groupedArticles.map(ga => `
                                    <div class="border rounded p-2 small">
                                        <div class="mb-1">
                                            <a href="${ga.uri}" target="_blank" class="text-decoration-none">${formatSource(ga.news_source, ga.uri)}</a>
                                        </div>
                                        <div>
                                            ${ga.bias ? `<span class="badge ${getBiasClass(ga.bias)} me-1" style="font-size: 10px;">${ga.bias}</span>` : ''}
                                            ${ga.factual_reporting ? `<span class="badge ${getFactualityClass(ga.factual_reporting)}" style="font-size: 10px;">${ga.factual_reporting}</span>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Additional Metadata -->
                        <div class="metadata-grid mb-3">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>Complete Metadata
                        </h6>
                        
                        <div class="metadata-grid">
                            <!-- Enhanced metadata for detailed view -->
                            ${article.sentiment ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Sentiment</small>
                                <span class="badge ${getSentimentClass(article.sentiment)}">${article.sentiment}</span>
                                ${article.sentiment_explanation ? `<br><small class="text-muted">${article.sentiment_explanation}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.driver_type || article.driver_type_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Driver Type</small>
                                ${article.driver_type ? `<span class=\"badge bg-secondary\">${article.driver_type}</span>` : ''}
                                ${article.driver_type_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.driver_type_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.time_to_impact || article.time_to_impact_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Time to Impact</small>
                                ${article.time_to_impact ? `<span class=\"badge bg-warning text-dark\">${article.time_to_impact}</span>` : ''}
                                ${article.time_to_impact_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.time_to_impact_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${(article.future_signal || article.future_signal_explanation) ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Future Signal</small>
                                ${article.future_signal ? `<span class=\"badge bg-dark text-white\">${article.future_signal}</span>` : ''}
                                ${article.future_signal_explanation ? `<br><small class=\"text-muted\">${escapeHTML(article.future_signal_explanation)}</small>` : ''}
                            </div>` : ''}
                            
                            ${article.tags ? `
                            <div class="metadata-item mb-2">
                                <small class="text-muted d-block">Tags</small>
                                <div class="d-flex flex-wrap gap-1">
                                    ${(() => {
                                        let tags = [];
                                        if (Array.isArray(article.tags)) {
                                            tags = article.tags;
                                        } else if (typeof article.tags === 'string') {
                                            tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                                        }
                                        return tags.map(tag => {
                                            // Highlight signal tags differently
                                            if (tag.startsWith('signal:')) {
                                                const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                                                return `<span class="badge bg-danger text-white" style="font-size: 8px;" title="Flagged by signal: ${escapeHTML(signalName)}"><i class="fas fa-flag me-1"></i>${escapeHTML(signalName)}</span>`;
                                            } else {
                                                return `<span class="badge bg-light text-dark" style="font-size: 8px;">${escapeHTML(tag)}</span>`;
                                            }
                                        }).join('');
                                    })()}
                                </div>
                            </div>` : ''}
                            
            <!-- View & Analysis Options (Detailed View Only) -->
            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                <small class="text-muted d-block mb-1">View Options</small>
                <div class="d-flex flex-wrap gap-1 mb-2">
                    <button class="btn btn-outline-info btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="window.open('https://12ft.io/${article.uri}', '_blank')"
                            title="View via 12ft.io (bypass paywall)">
                        <i class="fas fa-unlock-alt me-1"></i>12ft
                    </button>
                    <button class="btn btn-outline-warning btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="window.open('https://archive.is/${article.uri}', '_blank')"
                            title="View archived version">
                        <i class="fas fa-archive me-1"></i>Archive
                    </button>
                    <button class="btn btn-outline-success btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="openAnnotationModal('${article.uri}')"
                            title="Add annotation">
                        <i class="fas fa-sticky-note me-1"></i>Note
                    </button>
                </div>
                <small class="text-muted d-block mb-1">Analysis Options</small>
                <div class="d-flex flex-wrap gap-1 mb-1">
                    <button class="btn btn-outline-primary btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchAuspexDeepDive('${article.uri}')"
                            title="Generate comprehensive deep-dive analysis">
                        <i class="fas fa-microscope me-1"></i>Deep Dive
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchConsensusAnalysis('${article.uri}')"
                            title="Compare article claims to consensus">
                        <i class="fas fa-balance-scale me-1"></i>Consensus
                    </button>
                    <button class="btn btn-outline-dark btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchTimelineAnalysis('${article.uri}')"
                            title="Analyze impact timeline">
                        <i class="fas fa-clock me-1"></i>Timeline
                    </button>
                </div>
                <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-outline-info btn-sm" 
                            style="font-size: 9px; padding: 1px 4px;"
                            onclick="launchAuspexChat('${article.uri}')"
                            title="Chat with Auspex about this article">
                        <i class="fas fa-comments me-1"></i>Ask Auspex
                    </button>
                </div>
            </div>

                            <!-- Research Themes Section (Detailed View Only) -->
                            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                                <small class="text-muted d-block mb-1">Research Themes</small>
                                <div class="research-themes-sidebar" id="themes-sidebar-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="text-muted small">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Loading themes...
                                    </div>
                                </div>
                            </div>

                            <!-- Related Articles Section (Detailed View Only) -->
                            <div class="metadata-item mb-2 mt-3 pt-2 border-top">
                                <small class="text-muted d-block mb-1">Related Articles</small>
                                <div class="related-articles-sidebar" id="related-sidebar-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="text-muted small">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Loading...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End article-details-grid -->
            </div>
            <!-- End article-details -->
        `;

        articlesList.appendChild(articleItem);
    });
    
    listContainer.appendChild(articlesList);
    updateStarredCount();
    
    // Check for cached analysis and show indicators
    checkCachedAnalysisIndicators(articlesData.items);
    
    // Add signal flags to articles
    addSignalFlagsToArticles(articlesData.items);
    
    // Update count display to show filtered vs total
    const countEl = document.getElementById('selected-date-count');
    if (countEl) {
        // Use total_items from articlesData if available, otherwise fall back to items.length
        const totalCount = articlesData.total_items || articlesData.items.length;
        const filteredCount = filteredArticles.length;
        if (filteredCount !== totalCount) {
            countEl.textContent = `${filteredCount} of ${totalCount}`;
        } else {
            countEl.textContent = totalCount.toString();
        }
    }
    
    // Update pagination based on filtered results
    updatePaginationForFilters(articlesData, filteredArticles);
}

function renderArticleTable(articles) {
    const listContainer = document.getElementById('articles-list');
    if (!listContainer) return;

    // Add table-view class for full-width styling
    listContainer.classList.add('table-view');

    if (!articles || articles.length === 0) {
        listContainer.innerHTML = '<div class="alert alert-info">No articles match the current filters.</div>';
        return;
    }

    let html = `
        <div class="table-responsive" style="width: 100%;">
            <table class="table table-hover table-sm" style="min-width: 1400px; width: 100%;">
                <thead class="table-light sticky-top">
                    <tr>
                        <th style="width: 50px;"></th>
                        <th style="width: 400px;">Title</th>
                        <th style="width: 180px;">Source</th>
                        <th style="width: 120px;">Date</th>
                        <th style="width: 130px;">Bias</th>
                        <th style="width: 150px;">Factuality</th>
                        <th style="width: 120px;">Credibility</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    articles.forEach((article, index) => {
        const isStarred = starredArticles.has(article.uri);
        const isGrouped = article.grouped && article.groupedArticles;
        const articleId = article.uri.replace(/[^a-zA-Z0-9]/g, '_');

        html += `
            <tr style="${isGrouped ? 'background: white;' : ''}">
                <td class="text-center" style="position: relative; padding-left: 30px;">
                    <!-- Expand arrow - matches card view -->
                    <button class="expand-arrow-btn-table"
                            id="expand-btn-${articleId}"
                            onclick="toggleArticleDetailsInTableRow('${article.uri}', this)"
                            title="Show detailed view">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <!-- Star button -->
                    <button class="btn btn-sm star-btn"
                            style="width: 24px; height: 24px; padding: 0; font-size: 12px; border: none; background: ${isStarred ? 'var(--colors-warning-9)' : 'rgba(255, 193, 7, 0.1)'}; color: ${isStarred ? 'white' : 'var(--colors-warning-9)'};"
                            onclick="toggleStarArticle('${article.uri}', this)"
                            title="${isStarred ? 'Remove from Six Articles' : 'Add to Six Articles'}">â˜…</button>
                </td>
                <td>
                    <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                        ${escapeHTML(article.title)}
                    </a>
                    ${isGrouped ? `<span class="grouped-sources-badge ms-2"><i class="fas fa-layer-group me-1"></i>${article.groupedArticles.length} sources</span>` : ''}
                </td>
                <td class="small">${formatSource(article.news_source, article.uri)}</td>
                <td class="small">${formatPubDate(article.publication_date, false)}</td>
                <td>${article.bias ? `<span class="badge ${getBiasClass(article.bias)}">${article.bias}</span>` : '<span class="text-muted">N/A</span>'}</td>
                <td>${article.factual_reporting ? `<span class="badge ${getFactualityClass(article.factual_reporting)}">${article.factual_reporting}</span>` : '<span class="text-muted">N/A</span>'}</td>
                <td>${article.mbfc_credibility_rating ? `<span class="badge bg-info text-white">${article.mbfc_credibility_rating}</span>` : '<span class="text-muted">N/A</span>'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="excludeArticle('${article.uri}', this)" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
            <tr id="details-row-${articleId}" style="display: none;">
                <td colspan="8" class="p-0">
                    <div class="article-details" style="margin-left: 20px; margin-right: 10px; margin-top: 15px; margin-bottom: 15px; padding: 20px; background: var(--colors-neutral-2); border-radius: 8px; border-left: 4px solid var(--colors-info-5);">

                        <!-- Metadata Badges (Horizontal Layout - Full Width) -->
                        <div class="metadata-badges mb-3">
                            ${article.bias ? `<span class="badge ${getBiasClass(article.bias)}"><i class="fas fa-balance-scale me-1"></i>${article.bias}</span>` : ''}
                            ${article.factual_reporting ? `<span class="badge ${getFactualityClass(article.factual_reporting)}"><i class="fas fa-check-circle me-1"></i>${article.factual_reporting}</span>` : ''}
                            ${article.mbfc_credibility_rating ? `<span class="badge bg-info text-white"><i class="fas fa-certificate me-1"></i>${article.mbfc_credibility_rating}</span>` : ''}
                            ${article.category ? `<span class="badge bg-light text-dark"><i class="fas fa-folder me-1"></i>${article.category}</span>` : ''}
                        </div>

                        <!-- Two Column Grid Layout -->
                        <div class="article-details-grid">
                            <!-- Left Column: Main Content -->
                            <div>
                                <!-- Full Summary Section -->
                                <div class="mb-3">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-align-left me-2"></i>Full Summary
                                    </h6>
                                    <p class="small mb-0">${escapeHTML(article.summary)}</p>
                                </div>

                                <!-- Auspex Analysis Section -->
                                <div class="mb-3">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-search-plus me-2"></i>Auspex Analysis
                                    </h6>
                                    <div class="analysis-content bg-white p-3 rounded border" id="analysis-${articleId}">
                                        <div class="analysis-text bg-light p-2 rounded small text-muted">
                                            Analysis will be generated automatically when you expand this article.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Sidebar Content -->
                            <div>
                                ${isGrouped ? `
                                <!-- Grouped Sources Section -->
                                <div class="mb-3 p-3 bg-white rounded border">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-newspaper me-2"></i>All Sources (${article.groupedArticles.length})
                                    </h6>
                                    <div class="d-flex flex-column gap-2">
                                        ${article.groupedArticles.map(ga => `
                                            <div class="border rounded p-2 small">
                                                <div class="mb-1">
                                                    <a href="${ga.uri}" target="_blank" class="text-decoration-none">${formatSource(ga.news_source, ga.uri)}</a>
                                                </div>
                                                <div>
                                                    ${ga.bias ? `<span class="badge ${getBiasClass(ga.bias)} me-1" style="font-size: 10px;">${ga.bias}</span>` : ''}
                                                    ${ga.factual_reporting ? `<span class="badge ${getFactualityClass(ga.factual_reporting)}" style="font-size: 10px;">${ga.factual_reporting}</span>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <!-- End article-details-grid -->
                    </div>
                    <!-- End article-details -->
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    listContainer.innerHTML = html;
}

function toggleArticleDetailsInTableRow(uri, buttonElement) {
    const articleId = uri.replace(/[^a-zA-Z0-9]/g, '_');
    const detailsRow = document.getElementById(`details-row-${articleId}`);
    const icon = buttonElement.querySelector('i');

    if (!detailsRow) return;

    if (detailsRow.style.display === 'none') {
        // Expand
        detailsRow.style.display = '';
        icon.className = 'fas fa-chevron-down';
        buttonElement.title = 'Hide detailed view';
        buttonElement.classList.add('expanded');

        // Animate expansion
        detailsRow.style.opacity = '0';
        setTimeout(() => {
            detailsRow.style.transition = 'opacity 0.3s ease';
            detailsRow.style.opacity = '1';
        }, 10);

        // Trigger analysis generation like in card view
        generateArticleAnalysis(uri);
    } else {
        // Collapse
        detailsRow.style.transition = 'opacity 0.3s ease';
        detailsRow.style.opacity = '0';
        setTimeout(() => {
            detailsRow.style.display = 'none';
        }, 300);

        buttonElement.classList.remove('expanded');
        icon.className = 'fas fa-chevron-right';
        buttonElement.title = 'Show detailed view';
    }
}

function groupArticlesByTitle(articles) {
    // Group articles by normalized title (lowercase, remove punctuation)
    const titleGroups = new Map();

    articles.forEach(article => {
        const normalizedTitle = article.title.toLowerCase()
            .replace(/[^\w\s]/g, '')
            .replace(/\s+/g, ' ')
            .trim();

        if (!titleGroups.has(normalizedTitle)) {
            titleGroups.set(normalizedTitle, []);
        }
        titleGroups.get(normalizedTitle).push(article);
    });

    // Convert groups to array, combining duplicates
    const groupedArticles = [];
    titleGroups.forEach((group, normalizedTitle) => {
        if (group.length === 1) {
            // Single article, no grouping needed
            groupedArticles.push(group[0]);
        } else {
            // Multiple articles with same title - create grouped article
            const primaryArticle = { ...group[0] };
            primaryArticle.grouped = true;
            primaryArticle.groupedArticles = group;
            groupedArticles.push(primaryArticle);
        }
    });

    return groupedArticles;
}

function buildFilterBadges(articles) {
    // Collect unique values
    const biasValues = new Set();
    const factualityValues = new Set();
    const categoryValues = new Set();
    const signalValues = new Set();
    
    articles.forEach(article => {
        if (article.bias) biasValues.add(article.bias);
        if (article.factual_reporting) factualityValues.add(article.factual_reporting);
        if (article.category) categoryValues.add(article.category);
        
        // Check for signal tags
        if (article.tags && Array.isArray(article.tags)) {
            article.tags.forEach(tag => {
                if (tag.startsWith('signal:')) {
                    // Extract signal name: "signal:SIGNAL_NAME" -> "NAME"
                    const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                    signalValues.add(signalName);
                }
            });
        } else if (article.tags && typeof article.tags === 'string') {
            const tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            tags.forEach(tag => {
                if (tag.startsWith('signal:')) {
                    // Extract signal name: "signal:SIGNAL_NAME" -> "NAME"
                    const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                    signalValues.add(signalName);
                }
            });
        }
        
    });
    
    // Build bias filter badges
    const biasContainer = document.getElementById('bias-filters');
    biasContainer.innerHTML = '';
    biasValues.forEach(bias => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm ${getBiasClass(bias)} filter-badge ${activeFilters.bias.has(bias) ? 'active' : ''}`;
        badge.textContent = bias;
        badge.onclick = () => toggleFilter('bias', bias);
        biasContainer.appendChild(badge);
    });
    
    // Build factuality filter badges
    const factualityContainer = document.getElementById('factuality-filters');
    factualityContainer.innerHTML = '';
    factualityValues.forEach(factuality => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm ${getFactualityClass(factuality)} filter-badge ${activeFilters.factuality.has(factuality) ? 'active' : ''}`;
        badge.textContent = factuality;
        badge.onclick = () => toggleFilter('factuality', factuality);
        factualityContainer.appendChild(badge);
    });
    
    // Build category filter badges
    const categoryContainer = document.getElementById('category-filters');
    categoryContainer.innerHTML = '';
    categoryValues.forEach(category => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm bg-light text-dark filter-badge ${activeFilters.category.has(category) ? 'active' : ''}`;
        badge.textContent = category;
        badge.onclick = () => toggleFilter('category', category);
        categoryContainer.appendChild(badge);
    });
    
    // Build signal filter badges
    const signalContainer = document.getElementById('signal-filters');
    if (signalContainer) {
        signalContainer.innerHTML = '';
        signalValues.forEach(signal => {
            const badge = document.createElement('button');
            badge.className = `btn btn-sm bg-danger text-white filter-badge ${activeFilters.signals.has(signal) ? 'active' : ''}`;
            badge.innerHTML = `<i class="fas fa-flag me-1"></i>${signal}`;
            badge.onclick = () => toggleFilter('signals', signal);
            signalContainer.appendChild(badge);
        });
    }

    // Filter badges are now always available in the dropdown
}

function toggleFilter(filterType, value) {
    if (activeFilters[filterType].has(value)) {
        activeFilters[filterType].delete(value);
    } else {
        activeFilters[filterType].add(value);
    }
    
    // Re-render articles with new filters
    const articlesData = window.lastArticlesData; // Store this when loading articles
    if (articlesData) {
        renderArticles(articlesData);
    }
}

function applyArticleFilters(articles) {
    console.log('[DEBUG] applyArticleFilters called with', articles.length, 'articles');
    console.log('[DEBUG] activeFilters state:', {
        bias: activeFilters.bias.size,
        factuality: activeFilters.factuality.size,
        category: activeFilters.category.size,
        signals: activeFilters.signals.size
    });

    const result = articles.filter(article => {
        // Check bias filter
        if (activeFilters.bias.size > 0 && !activeFilters.bias.has(article.bias)) {
            console.log('[DEBUG] Article filtered out by bias:', article.title, 'has bias:', article.bias);
            return false;
        }

        // Check factuality filter
        if (activeFilters.factuality.size > 0 && !activeFilters.factuality.has(article.factual_reporting)) {
            console.log('[DEBUG] Article filtered out by factuality:', article.title, 'has factuality:', article.factual_reporting);
            return false;
        }

        // Check category filter
        if (activeFilters.category.size > 0 && !activeFilters.category.has(article.category)) {
            console.log('[DEBUG] Article filtered out by category:', article.title, 'has category:', article.category);
            return false;
        }

        // Check signal filter
        if (activeFilters.signals.size > 0) {
            let hasMatchingSignal = false;
            if (article.tags) {
                const tags = Array.isArray(article.tags) ? article.tags :
                            (typeof article.tags === 'string' ? article.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : []);

                for (const tag of tags) {
                    if (tag.startsWith('signal:')) {
                        const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                        if (activeFilters.signals.has(signalName)) {
                            hasMatchingSignal = true;
                            break;
                        }
                    }
                }
            }
            if (!hasMatchingSignal) {
                console.log('[DEBUG] Article filtered out by signals:', article.title);
                return false;
            }
        }

        return true;
    });

    console.log('[DEBUG] applyArticleFilters returning', result.length, 'articles (filtered out', articles.length - result.length, ')');
    return result;
}

let factualFilterMode = 'factual'; // 'factual' or 'opinion'

function toggleFactualFilter() {
    const btn = document.getElementById('factual-toggle-btn');
    
    // Check what factuality values are actually available
    const articlesData = window.lastArticlesData;
    if (!articlesData || !articlesData.items) {
        showNotification('No articles data available for filtering', 'warning');
        return;
    }
    
    // Clear existing filters first
    activeFilters.bias.clear();
    activeFilters.factuality.clear();
    activeFilters.category.clear();
    
    // Collect all factuality values to see what's available
    const availableFactuality = new Set();
    articlesData.items.forEach(article => {
        if (article.factual_reporting) {
            availableFactuality.add(article.factual_reporting);
        }
    });
    
    if (factualFilterMode === 'factual') {
        // Switch to opinion mode
        factualFilterMode = 'opinion';
        btn.innerHTML = '<i class="fas fa-comment"></i> Opinion Only';
        btn.title = 'Showing opinion articles only';
        
        // Add opinion/low factuality filters
        const opinionFactuality = Array.from(availableFactuality).filter(factuality => {
            const lower = factuality.toLowerCase();
            return lower.includes('mixed') || 
                   lower.includes('low') ||
                   lower === 'mixed';
        });
        
        opinionFactuality.forEach(factuality => {
            activeFilters.factuality.add(factuality);
        });
        
        showNotification(`Showing ${opinionFactuality.length} opinion/mixed factuality types`, 'info');
    } else {
        // Switch to factual mode
        factualFilterMode = 'factual';
        btn.innerHTML = '<i class="fas fa-shield-alt"></i> Factual Only';
        btn.title = 'Showing factual articles only';
        
        // Add high-quality factuality filters
        const highQualityFactuality = Array.from(availableFactuality).filter(factuality => {
            const lower = factuality.toLowerCase();
            return lower.includes('high') || 
                   lower.includes('mostly') || 
                   lower.includes('factual') ||
                   lower === 'very high' ||
                   lower === 'high' ||
                   lower === 'mostly factual';
        });
        
        if (highQualityFactuality.length === 0) {
            // If no high-quality matches found, be more lenient
            const acceptableFactuality = Array.from(availableFactuality).filter(factuality => {
                const lower = factuality.toLowerCase();
                return !lower.includes('low') && !lower.includes('very low');
            });
            
            acceptableFactuality.forEach(factuality => {
                activeFilters.factuality.add(factuality);
            });
            
            showNotification(`Showing ${acceptableFactuality.length > 0 ? 'acceptable' : 'all available'} quality sources`, 'info');
        } else {
            highQualityFactuality.forEach(factuality => {
                activeFilters.factuality.add(factuality);
            });
            
            showNotification(`Showing ${highQualityFactuality.length} high-quality source types`, 'success');
        }
    }
    
    // Re-render articles with quality filters
    renderArticles(articlesData);
}

function updatePaginationForFilters(originalData, filteredArticles) {
    const paginationContainer = document.getElementById('articles-pagination');
    if (!paginationContainer) return;
    
    // If filtering is active and reduces results significantly, hide pagination
    const hasActiveFilters = activeFilters.bias.size > 0 || activeFilters.factuality.size > 0 || activeFilters.category.size > 0;
    
    if (hasActiveFilters) {
        // Hide pagination when filtering since we're showing filtered subset
        paginationContainer.innerHTML = '';
        
        // Show filter info instead
        if (filteredArticles.length !== originalData.items.length) {
            paginationContainer.innerHTML = `
                <div class="text-center text-muted small mt-2">
                    <i class="fas fa-filter me-1"></i>
                    Showing ${filteredArticles.length} filtered articles of ${originalData.items.length} total
                    ${originalData.total_pages > 1 ? ` (from ${originalData.total_pages} pages)` : ''}
                </div>
            `;
        }
    } else {
        // Show normal pagination when no filters active
        renderArticlesPagination(originalData);
    }
}

function clearAllFilters() {
    activeFilters.bias.clear();
    activeFilters.factuality.clear();
    activeFilters.category.clear();

    // Re-render articles without filters
    const articlesData = window.lastArticlesData;
    if (articlesData) {
        renderArticles(articlesData);
        showNotification('All filters cleared', 'info');
    }
}

function toggleFilterDropdown() {
    // Determine which tab is active to show the correct filter panel
    const articlesTab = document.getElementById('article-investigator-content');
    const insightsTab = document.getElementById('insights-content');

    const isArticlesActive = articlesTab && (articlesTab.classList.contains('show') || articlesTab.classList.contains('active'));
    const isInsightsActive = insightsTab && (insightsTab.classList.contains('show') || insightsTab.classList.contains('active'));

    let panel, btn;

    if (isArticlesActive) {
        panel = document.getElementById('filter-dropdown-panel');
        btn = document.getElementById('filter-dropdown-btn-articles');
    } else if (isInsightsActive) {
        // For insights tab, we need to show incident filters
        panel = document.getElementById('filter-dropdown-panel-insights');
        btn = document.getElementById('filter-dropdown-btn-insights');

        // If panel doesn't exist yet, create it
        if (!panel) {
            panel = createIncidentFilterPanel();
        }
    } else {
        // Default to article filters
        panel = document.getElementById('filter-dropdown-panel');
        btn = document.getElementById('filter-dropdown-btn-articles');
    }

    if (!panel) return;

    if (panel.style.display === 'none' || !panel.style.display) {
        panel.style.display = 'block';
        if (btn) btn.classList.add('active');
    } else {
        panel.style.display = 'none';
        if (btn) btn.classList.remove('active');
    }
}

// Create incident filter panel for Narrative Explorer (matches Article Investigator pattern)
function createIncidentFilterPanel() {
    // Find the static container (same pattern as Article Investigator)
    const container = document.getElementById('insights-filter-container');
    if (!container) return null;

    // Create panel with SAME inline styles as Article Investigator
    const panel = document.createElement('div');
    panel.id = 'filter-dropdown-panel-insights';
    panel.className = 'filter-dropdown-panel';
    panel.style.display = 'none';
    panel.style.position = 'absolute';
    panel.style.right = '48px';
    panel.style.top = '0';
    panel.style.zIndex = '2000';

    panel.innerHTML = `
        <div class="filter-dropdown-header">
            <h6 class="mb-0">Filters</h6>
            <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="toggleIncidentFilterPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="filter-dropdown-body">
            <div class="mb-3">
                <label class="small text-muted mb-1">Priority</label>
                <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-sm btn-danger filter-badge" data-filter-type="priority" data-filter-value="critical">Critical</button>
                    <button class="btn btn-sm btn-warning filter-badge" data-filter-type="priority" data-filter-value="high">High</button>
                    <button class="btn btn-sm btn-info filter-badge" data-filter-type="priority" data-filter-value="medium">Medium</button>
                    <button class="btn btn-sm btn-secondary filter-badge" data-filter-type="priority" data-filter-value="low">Low</button>
                </div>
            </div>
            <div class="mb-3">
                <label class="small text-muted mb-1">Entity Type</label>
                <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-sm btn-primary filter-badge" data-filter-type="entity-type" data-filter-value="person">Person</button>
                    <button class="btn btn-sm btn-primary filter-badge" data-filter-type="entity-type" data-filter-value="organization">Organization</button>
                    <button class="btn btn-sm btn-primary filter-badge" data-filter-type="entity-type" data-filter-value="location">Location</button>
                    <button class="btn btn-sm btn-primary filter-badge" data-filter-type="entity-type" data-filter-value="event">Event</button>
                </div>
            </div>
        </div>

        <div class="filter-dropdown-footer">
            <button class="btn btn-sm btn-outline-secondary" onclick="clearIncidentFilters()">
                <i class="fas fa-times"></i> Clear All
            </button>
            <button class="btn btn-sm btn-primary" onclick="toggleIncidentFilterPanel()">
                Done
            </button>
        </div>
    `;

    // Insert panel directly into static container
    container.appendChild(panel);

    return panel;
}

function clearIncidentFilters() {
    // Clear any active incident filters
    const filterChips = document.querySelectorAll('#filter-dropdown-panel-insights .filter-chip.active');
    filterChips.forEach(chip => chip.classList.remove('active'));

    // Re-render without filters
    const incidents = window.lastIncidentsData;
    if (incidents) {
        renderIncidentTracking(incidents);
        showNotification('Filters cleared', 'info');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    // Handle article investigator filter panel
    const panel = document.getElementById('filter-dropdown-panel');
    const btn = document.getElementById('filter-dropdown-btn-articles');

    if (panel && btn && panel.style.display === 'block') {
        // Check if click is outside both the panel and button
        if (!panel.contains(event.target) && !btn.contains(event.target)) {
            panel.style.display = 'none';
            btn.classList.remove('active');
        }
    }

    // Handle narrative explorer filter panel
    const panelInsights = document.getElementById('filter-dropdown-panel-insights');
    const btnInsights = document.getElementById('filter-dropdown-btn-insights');

    if (panelInsights && btnInsights && panelInsights.style.display === 'block') {
        // Check if click is outside both the panel and button
        if (!panelInsights.contains(event.target) && !btnInsights.contains(event.target)) {
            panelInsights.style.display = 'none';
            btnInsights.classList.remove('active');
        }
    }
});

// Toggle incident filters panel visibility
function toggleIncidentFilters() {
    const content = document.getElementById('incident-filter-content');
    const icon = document.getElementById('incident-filter-collapse-icon');

    if (!content || !icon) return;

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// Toggle alert filters panel visibility
function toggleAlertFilters() {
    const content = document.getElementById('alert-filter-content');
    const icon = document.getElementById('alert-filter-collapse-icon');

    if (!content || !icon) return;

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// Toggle Six Articles settings panel visibility
function toggleSixArticlesSettings() {
    const content = document.getElementById('six-articles-settings-content');
    const icon = document.getElementById('six-articles-settings-collapse-icon');

    if (!content || !icon) return;

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// Article detailed view functionality - inline expansion
function toggleArticleDetails(articleUri, buttonElement) {
    const detailsId = `details-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const detailsDiv = document.getElementById(detailsId);
    const icon = buttonElement.querySelector('i');

    if (!detailsDiv) return;

    // Find the parent list-group-item to add expanded class
    const articleCard = buttonElement.closest('.list-group-item');

    if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
        // Expand inline
        detailsDiv.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
        buttonElement.title = 'Hide detailed view';
        buttonElement.style.background = 'var(--colors-success-9)'; // Green when expanded

        // Add expanded class to span full grid width
        if (articleCard) {
            articleCard.classList.add('expanded');
        }

        // Animate expansion
        detailsDiv.style.opacity = '0';
        detailsDiv.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            detailsDiv.style.transition = 'all 0.3s ease';
            detailsDiv.style.opacity = '1';
            detailsDiv.style.transform = 'translateY(0)';
        }, 10);

        // Auto-generate AI analysis and related articles on expand if a valid model is selected
        try {
            const model = document.getElementById('model-select')?.value;
            const isValid = model && typeof model === 'string' && model.trim().length > 0;
            const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const analysisDiv = document.getElementById(analysisId);

            if (!isValid) {
                showNotification('Select a valid AI model to generate analysis', 'warning');
            } else {
                console.log(`Analysis div check: exists=${!!analysisDiv}, loaded=${analysisDiv?.dataset.loaded}`);
                if (analysisDiv && !analysisDiv.dataset.loaded) {
                    console.log(`Generating analysis for ${articleUri}`);
                    generateArticleAnalysis(articleUri);
                } else {
                    console.log(`Skipping analysis generation - already loaded or div missing`);
                }
                // Load related articles for sidebar
                loadRelatedArticlesSidebar(articleUri);

                // Generate research themes for sidebar (check if already loaded)
                const themesDiv = document.getElementById(`themes-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`);
                console.log(`Themes div check: exists=${!!themesDiv}, loaded=${themesDiv?.dataset.loaded}`);
                if (themesDiv && !themesDiv.dataset.loaded) {
                    console.log(`Generating themes for ${articleUri}`);
                    generateResearchThemes(articleUri);
                } else {
                    console.log(`Skipping themes generation - already loaded or div missing`);
                }
            }
        } catch (_) { /* best-effort */ }
    } else {
        // Collapse inline
        detailsDiv.style.transition = 'all 0.3s ease';
        detailsDiv.style.opacity = '0';
        detailsDiv.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            detailsDiv.style.display = 'none';
        }, 300);

        // Remove expanded class
        if (articleCard) {
            articleCard.classList.remove('expanded');
        }

        icon.className = 'fas fa-chevron-right';
        buttonElement.title = 'Show detailed view';
        buttonElement.style.background = 'var(--colors-info-5)'; // Baby blue when collapsed
    }
}

async function generateArticleAnalysis(articleUri) {
    const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const analysisDiv = document.getElementById(analysisId);
    
    if (!analysisDiv) return;
    
    // Check for cached analysis first (database + localStorage fallback)
    const selectedModel = document.getElementById('model-select')?.value;
    
    console.log(`=== CACHE CHECK START ===`);
    console.log(`Article URI: ${articleUri}`);
    console.log(`Selected Model: ${selectedModel}`);
    console.log(`Analysis div loaded: ${analysisDiv.dataset.loaded}`);
    
    // Try database cache first
    try {
        console.log(`Checking cache for: ${articleUri} with model: ${selectedModel}`);
        const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(articleUri)}&analysis_type=summary&model=${encodeURIComponent(selectedModel)}`);
        console.log(`Cache response status: ${cacheResponse.status}`);
        
        if (cacheResponse.ok) {
            const cacheData = await cacheResponse.json();
            console.log('Cache response data:', cacheData);
            
            if (cacheData.cached) {
                console.log('Using cached analysis from database');
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                analysisDiv.innerHTML = `
                    <div class="analysis-text bg-info-subtle p-3 rounded border">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-database me-2 text-info"></i>
                                <strong class="text-info">Strategic Analysis (DB Cache)</strong>
                                <span class="badge bg-info ms-2">${cacheData.model_used}</span>
                            </div>
                            <small class="text-muted">Generated: ${cacheDate}</small>
                        </div>
                        ${cacheData.content}
                    </div>
                `;
                analysisDiv.dataset.loaded = 'true';
                return;
            } else {
                console.log('No cached analysis found in database');
            }
        } else {
            console.warn(`Cache API returned ${cacheResponse.status}`);
        }
    } catch (e) {
        console.warn('Database cache failed, checking localStorage:', e);
    }
    
    // Fallback to localStorage cache
    try {
        const localCacheKey = `analysis_cache_${articleUri}_summary_${selectedModel}`;
        const localCache = localStorage.getItem(localCacheKey);
        if (localCache) {
            const cacheData = JSON.parse(localCache);
            const cacheAge = new Date() - new Date(cacheData.generated_at);
            const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
            
            if (cacheAge < maxAge) {
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                analysisDiv.innerHTML = `
                    <div class="analysis-text bg-warning-subtle p-3 rounded border">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-hdd me-2 text-warning"></i>
                                <strong class="text-warning">Strategic Analysis (Local Cache)</strong>
                                <span class="badge bg-warning ms-2">${cacheData.model_used}</span>
                            </div>
                            <small class="text-muted">Generated: ${cacheDate}</small>
                        </div>
                        ${cacheData.content}
                    </div>
                `;
                analysisDiv.dataset.loaded = 'true';
                return;
            } else {
                // Cache expired, remove it
                localStorage.removeItem(localCacheKey);
            }
        }
    } catch (e) {
        console.warn('localStorage cache check failed:', e);
    }
    
    try {
        analysisDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Generating analysis...
            </div>
        `;
        
        // Get the selected model
        const selectedModel = document.getElementById('model-select').value;
        console.log(`Generating analysis for ${articleUri} using model: ${selectedModel}`);
        
        // Get the article data from our current dataset
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Article not found in current dataset');
        }
        
        // Prefer raw-text endpoint, fall back to legacy metadata summary
        let response = await fetch('/api/vector-summary-raw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: [articleUri], model: selectedModel || 'gpt-4.1-mini' })
        });
        if (!response.ok) {
            console.warn('Raw summary failed, falling back to legacy summary');
            response = await fetch('/api/vector-summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: [articleUri], model: selectedModel || 'gpt-4.1-mini' })
            });
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error Response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
        }
        
        const responseText = await response.text();
        console.log('Raw API response:', responseText);
        
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (jsonError) {
            console.error('JSON Parse Error:', jsonError);
            console.log('Response that failed to parse:', responseText);
            throw new Error(`Invalid JSON response: ${jsonError.message}`);
        }
        
        let analysis = result.response || result.message || result.content || 'No analysis available';
        // Normalize to single-article framing
        analysis = analysis
            // Remove common cluster lead-ins
            .replace(/^\s*Cluster Summary:.*$/gmi, '')
            .replace(/^\s*Summary of .*?cluster.*$/gmi, 'Article Summary')
            .replace(/^\s*This cluster[^\n]*$/gmi, '')
            .replace(/^\s*Overall, the cluster[^\n]*$/gmi, '')
            // Re-label section headers
            .replace(/^\s*Key Themes\s*$/gmi, '## Key Themes')
            .replace(/^\s*Sentiment\s*$/gmi, '## Sentiment')
            // Drop multi-article sections entirely
            .replace(/(^\s*(Notable|Key) Articles[\s\S]*?)(?=^\s*##\s|^\s*#\s|\Z)/gmi, '')
            // Tone down remaining cluster words
            .replace(/\b[Cc]lusters\b/g, 'articles')
            .replace(/\b[Cc]luster\b/g, 'article')
            // Clean horizontal rules
            .replace(/^\s*-{3,}\s*$/gm, '')
            .trim();
        
        if (!analysis || analysis.trim() === '') {
            throw new Error('Empty analysis response');
        }
        
        // Format the response properly
        const formattedAnalysis = formatMarkdownAnalysis(analysis);
        const timestamp = new Date().toISOString();
        const displayDate = new Date().toLocaleString();
        
        // Cache the analysis in database with localStorage fallback
        try {
            const cacheResponse = await fetch('/api/save-analysis-cache', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    article_uri: articleUri,
                    analysis_type: 'summary',
                    content: formattedAnalysis,
                    model_name: selectedModel
                })
            });
            
            if (cacheResponse.ok) {
                console.log('Analysis cached to database successfully');
            } else {
                throw new Error(`Database cache failed: ${cacheResponse.status}`);
            }
        } catch (cacheError) {
            console.warn('Database cache failed, using localStorage fallback:', cacheError);
            
            // Fallback to localStorage
            const cacheData = {
                content: formattedAnalysis,
                model_used: selectedModel,
                generated_at: new Date().toISOString(),
                analysis_type: 'summary'
            };
            localStorage.setItem(`analysis_cache_${articleUri}_summary_${selectedModel}`, JSON.stringify(cacheData));
        }
        
        analysisDiv.innerHTML = `
            <div class="analysis-text bg-success-subtle p-3 rounded border">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                    <i class="fas fa-robot me-2 text-success"></i>
                    <strong class="text-success">Strategic Analysis</strong>
                    <span class="badge bg-success ms-2">${selectedModel}</span>
                    </div>
                    <small class="text-muted">Generated: ${displayDate}</small>
                </div>
                ${formattedAnalysis}
            </div>
        `;
        analysisDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error generating article analysis:', error);
        
        // Show clear error message about server configuration
        analysisDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Analysis Unavailable</h6>
                <p class="mb-2">Vector routes not mounted on server. Analysis endpoints returning 404.</p>
                <small class="text-muted">
                    <strong>Solution:</strong> Ensure your server instance mounts vector_routes via app/core/routers.py
                </small>
            </div>
        `;
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (article) {
            const enhancedAnalysis = generateEnhancedAnalysis(article);
            analysisDiv.innerHTML = `
                <div class="analysis-text bg-warning-subtle p-3 rounded border">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        <strong class="text-warning">Analysis Failed</strong>
                        <span class="badge bg-warning text-dark ms-2">Using Enhanced Metadata</span>
                    </div>
                    <div class="alert alert-warning alert-sm mb-3">
                        <small><strong>Error:</strong> ${error.message}</small>
                    </div>
                    ${enhancedAnalysis}
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="generateArticleAnalysis('${articleUri}')">
                            <i class="fas fa-sync me-1"></i>Retry Analysis
                        </button>
                    </div>
                </div>
            `;
        } else {
            analysisDiv.innerHTML = `
                <div class="text-danger small">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }
}

// Enhanced Analysis feature removed per requirements

async function loadRelatedArticles(articleUri) {
    const relatedId = `related-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const relatedDiv = document.getElementById(relatedId);
    
    if (!relatedDiv) return;
    
    try {
        relatedDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Finding related articles...
            </div>
        `;
        
        // Call vector similarity API
        const response = await fetch(`/api/vector-similar?uri=${encodeURIComponent(articleUri)}&top_k=5`);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const relatedArticles = result.results || [];
        
        if (relatedArticles.length === 0) {
            relatedDiv.innerHTML = `
                <div class="text-muted small">
                    <i class="fas fa-info-circle me-2"></i>
                    No related articles found
                </div>
            `;
            return;
        }
        
        let relatedHtml = '<ul class="list-unstyled mb-0">';
        relatedArticles.forEach((related) => {
            const metadata = related.metadata || {};
            const similarity = (related.score * 100).toFixed(0);
            const truncatedSummary = (metadata.summary || '').trim();
            const summaryShort = truncatedSummary ? escapeHTML(truncatedSummary.substring(0, 110)) + (truncatedSummary.length > 110 ? 'â€¦' : '') : '';
            relatedHtml += `
                <li class="py-1 border-0">
                    <div class="d-flex align-items-start justify-content-between gap-2">
                        <div class="flex-grow-1">
                            <a href="${metadata.uri}" target="_blank" rel="noopener" class="text-decoration-none small fw-semibold">${escapeHTML(metadata.title || 'Untitled')}</a>
                            <div class="small text-muted">
                                <i class="fas fa-building me-1"></i>${escapeHTML(metadata.news_source || 'Unknown')}
                                ${metadata.category ? `<span class="ms-2 badge bg-light text-dark">${metadata.category}</span>` : ''}
                                ${metadata.bias ? `<span class="ms-1 badge ${getBiasClass(metadata.bias)}">${metadata.bias}</span>` : ''}
                                ${metadata.factual_reporting ? `<span class="ms-1 badge ${getFactualityClass(metadata.factual_reporting)}">${metadata.factual_reporting}</span>` : ''}
                            </div>
                            ${summaryShort ? `<div class="small text-secondary">${summaryShort}</div>` : ''}
                        </div>
                        <span class="badge bg-secondary align-self-start">${similarity}%</span>
                    </div>
                </li>`;
        });
        relatedHtml += '</ul>';
        
        relatedDiv.innerHTML = relatedHtml;
        relatedDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error loading related articles:', error);
        relatedDiv.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading related articles: ${error.message}
            </div>
        `;
    }
}

function formatMarkdownAnalysis(markdown) {
    // Convert markdown to HTML for better display
    let html = markdown;
    
    // Convert headers
    html = html.replace(/^### (.*$)/gm, '<h6 class="text-primary mt-3 mb-2">$1</h6>');
    html = html.replace(/^## (.*$)/gm, '<h5 class="text-primary mt-4 mb-3">$1</h5>');
    html = html.replace(/^# (.*$)/gm, '<h4 class="text-primary mt-4 mb-3">$1</h4>');
    
    // Convert bold text
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert bullet points
    html = html.replace(/^- (.*$)/gm, '<li class="mb-1">$1</li>');
    
    // Wrap consecutive list items in ul tags
    html = html.replace(/(<li.*?<\/li>\s*)+/g, '<ul class="mb-3">$&</ul>');
    
    // Convert paragraphs (double line breaks)
    html = html.replace(/\n\n/g, '</p><p class="mb-2">');
    html = '<p class="mb-2">' + html + '</p>';
    
    // Clean up empty paragraphs
    html = html.replace(/<p class="mb-2"><\/p>/g, '');
    html = html.replace(/<p class="mb-2">\s*<\/p>/g, '');
    
    // Convert horizontal rules
    html = html.replace(/^---$/gm, '<hr class="my-3">');
    
    // Clean up any remaining newlines
    html = html.replace(/\n/g, '<br>');
    
    return html;
}


// Enhanced markdown formatter for Auspex research results
function formatAuspexMarkdown(markdown) {
    if (!markdown || typeof markdown !== 'string') {
        return '<div class="text-muted">No content available</div>';
    }
    
    // Use marked.js for proper markdown rendering if available
    if (typeof marked !== 'undefined') {
        try {
            // Configure marked for better rendering
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            
            let html = marked.parse(markdown);
            
            // Add Bootstrap classes for better styling
            html = html.replace(/<table>/g, '<table class="table table-striped table-sm mt-3">');
            html = html.replace(/<h1>/g, '<h1 class="text-primary">');
            html = html.replace(/<h2>/g, '<h2 class="text-primary mt-4 mb-3">');
            html = html.replace(/<h3>/g, '<h3 class="text-primary mt-3 mb-2">');
            html = html.replace(/<h4>/g, '<h4 class="text-secondary mt-3 mb-2">');
            html = html.replace(/<h5>/g, '<h5 class="text-secondary mt-2 mb-2">');
            html = html.replace(/<h6>/g, '<h6 class="text-secondary mt-2 mb-1">');
            html = html.replace(/<ul>/g, '<ul class="mb-3">');
            html = html.replace(/<ol>/g, '<ol class="mb-3">');
            html = html.replace(/<li>/g, '<li class="mb-1">');
            html = html.replace(/<blockquote>/g, '<blockquote class="blockquote border-start border-primary ps-3 ms-3">');
            html = html.replace(/<code>/g, '<code class="bg-light text-dark px-1 rounded">');
            html = html.replace(/<pre>/g, '<pre class="bg-light p-3 rounded">');
            html = html.replace(/<hr>/g, '<hr class="my-4">');
            
            return html;
        } catch (error) {
            console.warn('Marked.js parsing failed, falling back to simple formatting:', error);
        }
    }
    
    // Fallback to simple formatting if marked.js isn't available
    return formatMarkdownAnalysis(markdown);
}

function generateEnhancedAnalysis(article) {
    let analysis = '';
    
    // Strategic insights section
    analysis += '<h6 class="text-primary mt-0 mb-2">Key Strategic Insights</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.category) {
        analysis += `<li class="mb-1">Categorized as <strong>${article.category}</strong>, indicating relevance to current sector developments</li>`;
    }
    
    if (article.time_to_impact && article.driver_type) {
        analysis += `<li class="mb-1">Expected <strong>${article.time_to_impact.toLowerCase()}</strong> impact, acting as a <strong>${article.driver_type.toLowerCase()}</strong> for related trends</li>`;
    }
    
    if (article.future_signal) {
        analysis += `<li class="mb-1">Signals <strong>${article.future_signal.toLowerCase()}</strong> future developments in the sector</li>`;
    }
    
    analysis += '</ul>';
    
    // Source credibility assessment
    analysis += '<h6 class="text-primary mb-2">Source Credibility</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.factual_reporting) {
        const factualityAssessment = article.factual_reporting.toLowerCase().includes('high') ? 'highly reliable' : 
                                   article.factual_reporting.toLowerCase().includes('mostly') ? 'generally reliable' :
                                   article.factual_reporting.toLowerCase().includes('mixed') ? 'moderately reliable' : 'reliability unclear';
        analysis += `<li class="mb-1">Factual reporting rated as <strong>${article.factual_reporting}</strong> - ${factualityAssessment}</li>`;
    }
    
    if (article.bias) {
        const biasImpact = article.bias.toLowerCase().includes('center') ? 'minimal bias impact on factual content' :
                          article.bias.toLowerCase().includes('left') ? 'may emphasize regulatory/social aspects' :
                          article.bias.toLowerCase().includes('right') ? 'may emphasize market/business aspects' : 'bias impact unclear';
        analysis += `<li class="mb-1">Political bias: <strong>${article.bias}</strong> - ${biasImpact}</li>`;
    }
    
    if (article.mbfc_credibility_rating) {
        analysis += `<li class="mb-1">Overall credibility: <strong>${article.mbfc_credibility_rating}</strong> rating</li>`;
    }
    
    analysis += '</ul>';
    
    // Strategic implications
    analysis += '<h6 class="text-primary mb-2">Strategic Implications</h6>';
    analysis += '<ul class="mb-3">';
    
    if (article.sentiment) {
        const sentimentImplication = article.sentiment.toLowerCase() === 'positive' ? 'suggests optimistic market outlook' :
                                   article.sentiment.toLowerCase() === 'negative' ? 'indicates potential challenges or concerns' :
                                   article.sentiment.toLowerCase() === 'critical' ? 'highlights significant issues requiring attention' :
                                   'presents balanced perspective';
        analysis += `<li class="mb-1">Sentiment is <strong>${article.sentiment.toLowerCase()}</strong> - ${sentimentImplication}</li>`;
    }
    
    // Add organizational context if available
    const profileSelect = document.getElementById('profile-select');
    if (profileSelect && profileSelect.value) {
        const selectedProfile = profileSelect.options[profileSelect.selectedIndex].text;
        analysis += `<li class="mb-1">For <strong>${selectedProfile}</strong>: Consider alignment with organizational risk tolerance and strategic priorities</li>`;
    }
    
    analysis += '</ul>';
    
    // Risk considerations
    analysis += '<h6 class="text-primary mb-2">Risk Considerations</h6>';
    analysis += '<ul class="mb-0">';
    
    if (article.bias && !article.bias.toLowerCase().includes('center')) {
        analysis += `<li class="mb-1">Source bias (${article.bias}) may influence framing - consider alternative perspectives</li>`;
    }
    
    if (article.time_to_impact && article.time_to_impact.toLowerCase().includes('long')) {
        analysis += `<li class="mb-1">Long-term impact timeline suggests gradual rather than immediate strategic implications</li>`;
    }
    
    if (!article.factual_reporting || article.factual_reporting.toLowerCase().includes('mixed')) {
        analysis += `<li class="mb-1">Factual reporting quality suggests verifying key claims with additional sources</li>`;
    }
    
    analysis += '<li class="mb-1">Consider this analysis alongside broader market trends and organizational context</li>';
    analysis += '</ul>';
    
    return analysis;
}

function generateSimpleAnalysisHTML(article) {
    // This version is for template rendering - returns HTML directly
    let analysis = '';
    
    // Sentiment analysis
    if (article.sentiment) {
        analysis += `<p class="mb-2 small"><strong>Sentiment:</strong> ${article.sentiment}`;
        if (article.sentiment_explanation) {
            analysis += ` - ${escapeHTML(article.sentiment_explanation)}`;
        }
        analysis += '</p>';
    }
    
    // Source quality
    if (article.bias && article.factual_reporting) {
        analysis += `<p class="mb-2 small"><strong>Source Quality:</strong> ${article.bias} bias, ${article.factual_reporting} factual reporting`;
        if (article.mbfc_credibility_rating) {
            analysis += `, ${article.mbfc_credibility_rating} credibility`;
        }
        analysis += '</p>';
    }
    
    // Impact timing
    if (article.time_to_impact) {
        analysis += `<p class="mb-2 small"><strong>Impact Timing:</strong> ${article.time_to_impact}`;
        if (article.driver_type) {
            analysis += ` (${article.driver_type})`;
        }
        analysis += '</p>';
    }
    
    // Future signals
    if (article.future_signal) {
        analysis += `<p class="mb-2 small"><strong>Future Signal:</strong> ${article.future_signal}</p>`;
    }
    
    return analysis || '<p class="mb-2 small text-muted">Limited metadata available.</p>';
}

function generateSimpleAnalysis(article) {
    let analysis = '';
    
    // Sentiment analysis
    if (article.sentiment) {
        analysis += `<p class="mb-2 small"><strong>Sentiment Analysis:</strong> This article has a ${article.sentiment.toLowerCase()} tone`;
        if (article.sentiment_explanation) {
            analysis += ` - ${article.sentiment_explanation}`;
        }
        analysis += '.</p>';
    }
    
    // Bias and factuality assessment
    if (article.bias && article.factual_reporting) {
        analysis += `<p class="mb-2 small"><strong>Source Quality:</strong> Published by a ${article.bias.toLowerCase()} source with ${article.factual_reporting.toLowerCase()} factual reporting standards`;
        if (article.mbfc_credibility_rating) {
            analysis += ` and ${article.mbfc_credibility_rating.toLowerCase()} credibility rating`;
        }
        analysis += '.</p>';
    }
    
    // Impact and timing analysis
    if (article.time_to_impact || article.driver_type) {
        analysis += `<p class="mb-2 small"><strong>Impact Assessment:</strong> `;
        if (article.time_to_impact) {
            analysis += `Expected to have ${article.time_to_impact.toLowerCase()} impact`;
        }
        if (article.driver_type) {
            analysis += `${article.time_to_impact ? ' and acts as a ' : 'Acts as a '}${article.driver_type.toLowerCase()} for related developments`;
        }
        analysis += '.</p>';
    }
    
    // Future signals
    if (article.future_signal) {
        analysis += `<p class="mb-2 small"><strong>Future Implications:</strong> This article signals ${article.future_signal.toLowerCase()} future developments in the ${article.category || 'relevant'} sector.</p>`;
    }
    
    // Category context
    if (article.category) {
        analysis += `<p class="mb-2 small"><strong>Thematic Context:</strong> Categorized under ${article.category}, indicating relevance to ongoing developments in this area.</p>`;
    }
    
    if (!analysis) {
        analysis = '<p class="mb-2 small text-muted">Limited metadata available for analysis.</p>';
    }
    
    return analysis;
}

// Generate research themes for sidebar
async function generateResearchThemes(articleUri) {
    const themesId = `themes-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const themesDiv = document.getElementById(themesId);
    
    if (!themesDiv || themesDiv.dataset.loaded) return;
    
    // Check for cached themes first
    const selectedModel = document.getElementById('model-select')?.value;
    try {
        const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(articleUri)}&analysis_type=themes&model=${encodeURIComponent(selectedModel)}`);
        if (cacheResponse.ok) {
            const cacheData = await cacheResponse.json();
            if (cacheData.cached && cacheData.metadata && cacheData.metadata.research_themes) {
                // Use cached structured themes
                const themes = cacheData.metadata.research_themes;
                let html = '<div class="d-flex flex-wrap gap-1">';
                themes.forEach((theme, index) => {
                    html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                            style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                            onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                            title="Launch Auspex research on: ${escapeHTML(theme)}">
                        <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                    </button>`;
                });
                html += '</div>';
                const cacheDate = new Date(cacheData.generated_at).toLocaleString();
                html += `<small class="text-muted d-block mt-1" style="font-size: 8px;">Cached: ${cacheDate}</small>`;
                themesDiv.innerHTML = html;
                themesDiv.dataset.loaded = 'true';
                return;
            }
        }
    } catch (e) {
        console.warn('Failed to check themes cache, proceeding with generation:', e);
    }
    
    try {
        themesDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <small>Generating themes...</small>
            </div>
        `;
        
        const selectedModel = document.getElementById('model-select').value;
        
        const response = await fetch('/api/article-insights', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel || 'gpt-4o-mini',
                structured: true
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Research themes API response:', data);
        console.log('Response keys:', Object.keys(data));
        console.log('Has research_themes:', !!data.research_themes);
        console.log('Has response:', !!data.response);
        console.log('Structured flag sent:', true);
        
        console.log('Research themes array:', data.research_themes);
        console.log('Research themes length:', data.research_themes?.length);
        
        if (data.research_themes && data.research_themes.length > 0) {
            // Compact sidebar format - just theme buttons
            let html = '<div class="d-flex flex-wrap gap-1">';
            data.research_themes.forEach((theme, index) => {
                html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                        style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                        onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                        title="Launch Auspex research on: ${escapeHTML(theme)}">
                    <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                </button>`;
            });
            html += '</div>';
            html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
            themesDiv.innerHTML = html;
        } else if (data.response) {
            // Fallback to markdown - extract just themes
            const themesMatch = data.response.match(/## Research themes\n(.*?)(?=\n##|\n$)/s);
            if (themesMatch) {
                const themeLines = themesMatch[1].split('\n').filter(line => line.trim().startsWith('-'));
                let html = '<div class="d-flex flex-wrap gap-1">';
                themeLines.forEach(line => {
                    const theme = line.replace(/^-\s*/, '').trim();
                    if (theme) {
                        html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                                style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                                onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                                title="Launch Auspex research on: ${escapeHTML(theme)}">
                            <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                        </button>`;
                    }
                });
                html += '</div>';
                html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
                themesDiv.innerHTML = html;
            } else {
                themesDiv.innerHTML = '<small class="text-muted">No themes available</small>';
            }
        } else if (data.response) {
            // Try to extract themes from markdown response as fallback
            console.log('Attempting to parse themes from markdown response:', data.response);
            const themesMatch = data.response.match(/## Research themes\n(.*?)(?=\n##|\n$)/s);
            if (themesMatch) {
                const themeLines = themesMatch[1].split('\n').filter(line => line.trim().startsWith('-'));
                if (themeLines.length > 0) {
                    let html = '<div class="d-flex flex-wrap gap-1">';
                    themeLines.forEach(line => {
                        const theme = line.replace(/^-\s*/, '').trim();
                        if (theme) {
                            html += `<button class="btn btn-outline-primary btn-sm research-theme-btn" 
                                    style="font-size: 10px; padding: 2px 6px; border-radius: 10px;"
                                    onclick="launchAuspexResearch('${escapeHTML(theme)}', '${articleUri}')"
                                    title="Launch Auspex research on: ${escapeHTML(theme)}">
                                <i class="fas fa-search me-1"></i>${escapeHTML(theme)}
                            </button>`;
                        }
                    });
                    html += '</div>';
                    html += '<small class="text-muted d-block mt-1" style="font-size: 9px;">Click to research</small>';
                    themesDiv.innerHTML = html;
                } else {
                    themesDiv.innerHTML = '<small class="text-warning">No themes found in response</small>';
                }
            } else {
                themesDiv.innerHTML = '<small class="text-warning">Could not parse themes</small>';
            }
        } else {
            console.warn('No research themes or response in API data:', data);
            console.log('Full response object:', JSON.stringify(data, null, 2));
            
            // Show what we actually got for debugging
            if (data && typeof data === 'object') {
                const keys = Object.keys(data);
                themesDiv.innerHTML = `<small class="text-warning">Debug: Got keys: ${keys.join(', ')}</small>`;
            } else {
                themesDiv.innerHTML = '<small class="text-muted">API returned no data</small>';
            }
        }
        
        themesDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error generating research themes:', error);
        
        // Show clear error about server configuration
        themesDiv.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <small>Vector routes not mounted (404)</small>
            </div>
        `;
    }
}

// Generate deep dive analysis
async function generateDeepDive(articleUri) {
    try {
        const selectedModel = document.getElementById('model-select').value;
        if (!selectedModel) {
            showNotification('Select a valid AI model to generate deep-dive analysis', 'warning');
            return;
        }
        
        showNotification('Generating deep-dive analysis...', 'info');
        
        const response = await fetch('/api/article-deep-dive', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.response) {
            throw new Error('No deep-dive content received');
        }
        
        // Create a modal to show the deep dive
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-microscope me-2"></i>Deep-Dive Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="deep-dive-content">
                            ${formatMarkdownAnalysis(data.response)}
                        </div>
                        <div class="text-end mt-3">
                            <small class="text-muted">
                                Generated: ${data.generated_at ? new Date(data.generated_at).toLocaleString() : 'Just now'} | Model: ${selectedModel}
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
        
        showNotification('Deep-dive analysis generated successfully!', 'success');
        
    } catch (error) {
        console.error('Error generating deep dive:', error);
        showNotification(`Failed to generate deep-dive: ${error.message}`, 'error');
    }
}

// Check for cached analysis and show indicators
async function checkCachedAnalysisIndicators(articles) {
    const selectedModel = document.getElementById('model-select')?.value;
    if (!selectedModel || !articles || articles.length === 0) return;
    
    // Check cache for each article (database + localStorage fallback)
    for (const article of articles) {
        let hasCachedAnalysis = false;
        
        // Try database cache first
        try {
            const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(article.uri)}&analysis_type=summary&model=${encodeURIComponent(selectedModel)}`);
            if (cacheResponse.ok) {
                const cacheData = await cacheResponse.json();
                if (cacheData.cached) {
                    hasCachedAnalysis = true;
                }
            }
        } catch (e) {
            // Database failed, check localStorage
            try {
                const localCacheKey = `analysis_cache_${article.uri}_summary_${selectedModel}`;
                const localCache = localStorage.getItem(localCacheKey);
                if (localCache) {
                    const cacheData = JSON.parse(localCache);
                    const cacheAge = new Date() - new Date(cacheData.generated_at);
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
                    
                    if (cacheAge < maxAge) {
                        hasCachedAnalysis = true;
                    }
                }
            } catch (localError) {
                console.debug(`Local cache check failed for ${article.uri}:`, localError);
            }
        }
        
        // Show indicator if cached analysis found
        if (hasCachedAnalysis) {
            const indicator = document.getElementById(`cached-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (indicator) {
                indicator.style.display = 'inline';
            }
        }
    }
}

// Pagination and filtering variables
let allArticlesData = [];
let filteredArticlesData = [];
let currentPage = 1;
const articlesPerPage = 25;
let currentSort = 'date_desc';
let currentSearchTerm = '';

// Handle sort change
function handleSortChange() {
    currentSort = document.getElementById('sort-select').value;
    currentPage = 1; // Reset to first page
    applyFiltersAndDisplay();
}

// Handle search input with debouncing
let searchTimeout;
function handleSearchInput() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        currentSearchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        currentPage = 1; // Reset to first page
        applyFiltersAndDisplay();
    }, 300);
}

// Apply filters and display current page
function applyFiltersAndDisplay() {
    console.log('[DEBUG] applyFiltersAndDisplay called - allArticlesData.length:', allArticlesData ? allArticlesData.length : 'null');
    if (!allArticlesData || !Array.isArray(allArticlesData) || allArticlesData.length === 0) {
        console.warn('[DEBUG] No valid articles data available for filtering');
        return;
    }

    console.log('[DEBUG] Filtering with search term:', currentSearchTerm || '(empty)');
    // Filter articles based on search term
    filteredArticlesData = allArticlesData.filter(article => {
        if (!currentSearchTerm) return true;

        const searchableText = [
            article.title || '',
            article.summary || '',
            article.tags || '',
            article.category || ''
        ].join(' ').toLowerCase();

        return searchableText.includes(currentSearchTerm);
    });
    console.log('[DEBUG] After search filter: filteredArticlesData.length:', filteredArticlesData.length);
    
    // Sort articles
    filteredArticlesData.sort((a, b) => {
        switch (currentSort) {
            case 'date_desc':
                return new Date(b.publication_date || 0) - new Date(a.publication_date || 0);
            case 'date_asc':
                return new Date(a.publication_date || 0) - new Date(b.publication_date || 0);
            case 'category_date_asc':
                // Sort by category first, then by date asc within category
                if (a.category !== b.category) {
                    return (a.category || '').localeCompare(b.category || '');
                }
                return new Date(a.publication_date || 0) - new Date(b.publication_date || 0);
            case 'category_date_desc':
                // Sort by category first, then by date desc within category
                if (a.category !== b.category) {
                    return (a.category || '').localeCompare(b.category || '');
                }
                return new Date(b.publication_date || 0) - new Date(a.publication_date || 0);
            case 'bias_date_asc':
                // Sort by political bias first, then by date asc within bias
                if (a.bias !== b.bias) {
                    return (a.bias || '').localeCompare(b.bias || '');
                }
                return new Date(a.publication_date || 0) - new Date(b.publication_date || 0);
            case 'bias_date_desc':
                // Sort by political bias first, then by date desc within bias
                if (a.bias !== b.bias) {
                    return (a.bias || '').localeCompare(b.bias || '');
                }
                return new Date(b.publication_date || 0) - new Date(a.publication_date || 0);
            default:
                return 0;
        }
    });
    
    // Update pagination info
    updatePaginationInfo();
    
    // Display current page
    displayCurrentPage();
}

// Update pagination information
function updatePaginationInfo() {
    const totalArticles = filteredArticlesData.length;
    const totalPages = Math.ceil(totalArticles / articlesPerPage);
    const start = (currentPage - 1) * articlesPerPage + 1;
    const end = Math.min(currentPage * articlesPerPage, totalArticles);
    
    document.getElementById('articles-start').textContent = totalArticles > 0 ? start : 0;
    document.getElementById('articles-end').textContent = end;
    document.getElementById('articles-total').textContent = totalArticles;
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages;
    
    // Update button states
    document.getElementById('prev-page-btn').disabled = currentPage <= 1;
    document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
    
    // Show/hide pagination container
    const paginationContainer = document.getElementById('pagination-container');
    if (paginationContainer) {
        paginationContainer.style.display = totalArticles > articlesPerPage ? 'flex' : 'none';
    }
}

// Display current page of articles
function displayCurrentPage() {
    console.log('[DEBUG] displayCurrentPage called - filteredArticlesData.length:', filteredArticlesData.length);
    const start = (currentPage - 1) * articlesPerPage;
    const end = start + articlesPerPage;
    const pageArticles = filteredArticlesData.slice(start, end);
    console.log('[DEBUG] Slicing articles from', start, 'to', end, '- got', pageArticles.length, 'articles');

    // Pass total_items from window.lastArticlesData to preserve the correct count
    const totalItems = (window.lastArticlesData && window.lastArticlesData.total_items)
        ? window.lastArticlesData.total_items
        : filteredArticlesData.length;
    console.log('[DEBUG] totalItems:', totalItems);

    console.log('[DEBUG] Calling renderArticles with', pageArticles.length, 'articles');
    renderArticles({ items: pageArticles, total_items: totalItems });

    // Check for cached analysis indicators
    checkCachedAnalysisIndicators(pageArticles);
}

// Pagination navigation
function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        displayCurrentPage();
        updatePaginationInfo();
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredArticlesData.length / articlesPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayCurrentPage();
        updatePaginationInfo();
    }
}

// Auto-load database articles on page load (no LLM generation)
async function autoLoadArticles() {
    try {
        console.log('Auto-loading database articles...');

        // Get current settings
        const dateRange = document.getElementById('date-range-select')?.value || '3m';
        const selectedTopics = getSelectedTopics();
        const topic = selectedTopics.length > 0 ? selectedTopics.join(',') : '';

        // Convert date range to days for database query
        let days = 90; // Default
        if (dateRange.endsWith('d')) {
            days = parseInt(dateRange.replace('d', ''));
        } else if (dateRange.endsWith('h')) {
            days = Math.max(1, parseInt(dateRange.replace('h', '')) / 24);
        } else if (dateRange === '3m') {
            days = 90; // 3 months = 90 days
        } else if (dateRange === '1y') {
            days = 365; // 1 year = 365 days
        } else if (dateRange === 'all') {
            days = 9999; // Large number for "all time"
        }
        
        console.log(`Date range: ${dateRange} -> ${days} days back`);
        
        // Calculate actual start date for the API
        const now = new Date();
        const startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
        const dateParam = startDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        console.log(`Calculated date range: ${dateParam} to ${now.toISOString().split('T')[0]} (${days} days)`);
        
        // Build database query parameters to match news_feed_routes.py endpoint
        const params = new URLSearchParams({
            date_range: dateRange, // Use the original date_range parameter
            per_page: '100', // Match endpoint max limit
            page: '1',
            max_articles: '100'
        });
        
        if (topic) params.append('topic', topic);
        
        console.log(`API call: /api/news-feed/articles?${params.toString()}`);
        console.log(`Date range: ${dateRange} -> should get ${days} days of articles`);
        
        // Load articles directly from database (not LLM-generated)
        const response = await fetch(`/api/news-feed/articles?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Database articles loaded:', data);
        
        // Handle response structure and extract total count
        let articles = [];
        let totalCount = 0;

        if (Array.isArray(data)) {
            articles = data;
            totalCount = data.length;
        } else if (data.articles) {
            // Check if data.articles is an array or has nested structure
            if (Array.isArray(data.articles)) {
                articles = data.articles;
                totalCount = data.total_items || data.articles.length;
            } else if (data.articles.items && Array.isArray(data.articles.items)) {
                articles = data.articles.items;
                totalCount = data.articles.total_items || data.articles.items.length;
            } else if (data.articles.articles && Array.isArray(data.articles.articles)) {
                articles = data.articles.articles;
                totalCount = data.articles.total_items || data.articles.articles.length;
            } else {
                console.warn('data.articles is not an array:', data.articles);
                console.log('data.articles keys:', Object.keys(data.articles));
                articles = [];
                totalCount = 0;
            }
        } else if (data.items && Array.isArray(data.items)) {
            articles = data.items;
            totalCount = data.total_items || data.items.length;
        } else if (data.results && Array.isArray(data.results)) {
            articles = data.results;
            totalCount = data.total_items || data.results.length;
        } else {
            console.warn('Unexpected database response structure:', data);
            console.log('Available keys:', Object.keys(data));
            articles = [];
            totalCount = 0;
        }

        // Store all articles and initialize filtering
        allArticlesData = articles;
        currentPage = 1;

        // Also store in window.lastArticlesData for analysis functions
        window.lastArticlesData = { items: articles, total_items: totalCount };

        console.log(`Loaded ${allArticlesData.length} database articles, total available: ${totalCount}`);

        // Update article count display with total from API response
        const countEl = document.getElementById('selected-date-count');
        if (countEl) {
            countEl.textContent = totalCount.toString();
        }

        // Apply initial filters and display
        if (allArticlesData.length > 0) {
            applyFiltersAndDisplay();
        } else {
            // Show empty state
            const listContainer = document.getElementById('articles-list');
            if (listContainer) {
                listContainer.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Articles Found</h5>
                        <p class="text-muted">No articles found for the selected criteria.</p>
                        <small class="text-muted">Date range: ${dateRange}${topic ? `, Topic: ${topic}` : ''}</small>
                    </div>
                `;
            }
        }

        console.log(`Database articles auto-loaded: ${allArticlesData.length} total`);
        
    } catch (error) {
        console.error('Error auto-loading database articles:', error);

        // Update article count display to 0 on error
        const countEl = document.getElementById('selected-date-count');
        if (countEl) {
            countEl.textContent = '0';
        }

        // Show error in articles list
        const listContainer = document.getElementById('articles-list');
        if (listContainer) {
            listContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Failed to Load Articles</h6>
                    <p class="mb-0">Error: ${error.message}</p>
                </div>
            `;
        }
    }
}

// Toggle controls panel visibility
function toggleControlsPanel() {
    const controlsContent = document.getElementById('controlsContent');
    const toggleIcon = document.getElementById('controlsToggleIcon');
    const isCollapsed = controlsContent.style.display === 'none';

    if (isCollapsed) {
        // Show controls
        controlsContent.style.display = 'block';
        toggleIcon.className = 'fas fa-caret-up';
        localStorage.setItem('newsFeedControlsCollapsed', 'false');
    } else {
        // Hide controls
        controlsContent.style.display = 'none';
        toggleIcon.className = 'fas fa-caret-down';
        localStorage.setItem('newsFeedControlsCollapsed', 'true');
    }
}

// Restore controls panel state
function restoreControlsState() {
    const isCollapsed = localStorage.getItem('newsFeedControlsCollapsed') === 'true';
    if (isCollapsed) {
        const controlsContent = document.getElementById('controlsContent');
        const toggleIcon = document.getElementById('controlsToggleIcon');

        if (controlsContent && toggleIcon) {
            controlsContent.style.display = 'none';
            toggleIcon.className = 'fas fa-caret-down';
        }
    }
}

// Save all current settings as defaults
function saveCurrentAsDefaults() {
    try {
        const settings = {
            dateRange: document.getElementById('date-range-select')?.value,
            topic: document.getElementById('topic-select')?.value,
            model: document.getElementById('model-select')?.value,
            profile: document.getElementById('profile-select')?.value,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('newsFeedDefaults', JSON.stringify(settings));
        showNotification('Current settings saved as defaults!', 'success');
        console.log('Saved defaults:', settings);
    } catch (error) {
        console.error('Error saving defaults:', error);
        showNotification('Failed to save defaults', 'error');
    }
}

// Load saved defaults
function loadSavedDefaults() {
    try {
        const savedDefaults = localStorage.getItem('newsFeedDefaults');
        if (savedDefaults) {
            const settings = JSON.parse(savedDefaults);

            // Apply saved settings
            if (settings.dateRange) {
                const dateRangeEl = document.getElementById('date-range-select');
                if (dateRangeEl) dateRangeEl.value = settings.dateRange;
            }

            // Don't set topic here - the topic dropdown loading code handles this
            // after topics are fetched from the API (line 1785-1786)

            if (settings.model) {
                const modelEl = document.getElementById('model-select');
                if (modelEl) modelEl.value = settings.model;
            }

            console.log('Loaded saved defaults:', settings);
            return true;
        }
    } catch (error) {
        console.error('Error loading defaults:', error);
    }
    return false;
}

// Get the currently selected topic from the news feed (DEPRECATED - use getSelectedTopics())
function getCurrentTopic() {
    const selected = getSelectedTopics();
    return selected.length > 0 ? selected[0] : null;
}

// Get all selected topics as an array
// Toggle topic selection (using checkmark visibility like Date Range dropdown)
function toggleTopic(element) {
    const checkmark = element.querySelector('.fa-check');
    if (checkmark) {
        // Toggle visibility
        if (checkmark.style.visibility === 'visible') {
            checkmark.style.visibility = 'hidden';
        } else {
            checkmark.style.visibility = 'visible';
        }
        updateTopicSelectorDisplay();
    }
}

function getSelectedTopics() {
    const items = document.querySelectorAll('#topic-select-dropdown .topic-option');
    const selected = [];
    items.forEach(item => {
        const checkmark = item.querySelector('.fa-check');
        if (checkmark && checkmark.style.visibility === 'visible') {
            selected.push(item.dataset.topic);
        }
    });
    return selected;
}

// Update topic selector display with count badge inside button
function updateTopicSelectorDisplay() {
    const selected = getSelectedTopics();
    const label = document.getElementById('topic-select-label');
    const countBadge = document.getElementById('topic-select-count');

    console.log('updateTopicSelectorDisplay called:', {
        selected: selected,
        labelFound: !!label,
        badgeFound: !!countBadge
    });

    if (!label || !countBadge) {
        console.error('Topic selector elements not found!', { label, countBadge });
        return;
    }

    if (selected.length === 0) {
        label.textContent = 'Select Topics';
        countBadge.textContent = '0';
        countBadge.style.display = 'none';
    } else if (selected.length === 1) {
        // Show just the topic name if only one selected
        const firstItem = document.querySelector(`#topic-select-dropdown .topic-option[data-topic="${selected[0]}"]`);
        label.textContent = firstItem ? firstItem.textContent.trim() : selected[0];
        countBadge.textContent = '1';
        countBadge.style.display = 'none';
    } else {
        label.textContent = `${selected.length} topics selected`;
        countBadge.textContent = selected.length;
        countBadge.style.display = 'inline-block';
    }

    console.log('Display updated:', {
        labelText: label.textContent,
        badgeText: countBadge.textContent,
        badgeDisplay: countBadge.style.display
    });

    // Save selected topics to localStorage for persistence
    try {
        localStorage.setItem('newsFeedTopics', JSON.stringify(selected));
        console.log('Saved topics to localStorage:', selected);
    } catch (e) {
        console.error('Failed to save topics to localStorage:', e);
    }
}

// Select all topics
function selectAllTopics() {
    document.querySelectorAll('#topic-select-dropdown .topic-option .fa-check').forEach(check => {
        check.style.visibility = 'visible';
    });
    updateTopicSelectorDisplay();
}

// Clear all topics
function clearAllTopics() {
    document.querySelectorAll('#topic-select-dropdown .topic-option .fa-check').forEach(check => {
        check.style.visibility = 'hidden';
    });
    updateTopicSelectorDisplay();
}

// Remove specific topic from selection
function removeTopicFromSelection(topic) {
    const item = document.querySelector(`#topic-select-dropdown .topic-option[data-topic="${topic}"]`);
    if (item) {
        const checkmark = item.querySelector('.fa-check');
        if (checkmark) {
            checkmark.style.visibility = 'hidden';
            updateTopicSelectorDisplay();
        }
    }
}

// Helper: escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get color for topic badge (consistent hashing for unknown topics)
function getTopicColor(topic) {
    const colors = {
        'AI': '#3498db',
        'Cybersecurity': '#e74c3c',
        'Quantum': '#9b59b6',
        'Blockchain': '#f39c12',
        'Cloud': '#1abc9c',
        'IoT': '#16a085',
        'Fintech': '#27ae60',
        'Healthtech': '#2980b9',
        'Automation': '#8e44ad',
        'Privacy': '#c0392b'
    };
    // Generate consistent color for unknown topics using hash
    if (colors[topic]) return colors[topic];

    let hash = 0;
    for (let i = 0; i < topic.length; i++) {
        hash = topic.charCodeAt(i) + ((hash << 5) - hash);
    }
    return `hsl(${Math.abs(hash) % 360}, 70%, 50%)`;
}

// Launch Auspex research for a specific theme
async function launchAuspexResearch(theme, sourceArticleUri) {
    try {
        showNotification(`Launching Auspex research on: ${theme}`, 'info');
        
        // Get the article data to extract the actual topic and context
        const article = window.lastArticlesData?.items?.find(a => a.uri === sourceArticleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }
        
        // Use the article's topic, not the theme as topic
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning'; // Fallback to default topic
        
        console.log(`Research setup: Theme="${theme}", Topic="${actualTopic}", Article="${article.title}"`);
        
        // Create Auspex chat session with the actual topic
        // Create Auspex chat session with organizational profile
        const chatId = await createAuspexChatSession(actualTopic, `Deep Research: ${theme}`);
        
        // Get the selected model from the news feed UI
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Build comprehensive research prompt with article context
        const researchPrompt = `Conduct a comprehensive analysis of "${theme}" using your tools to search recent articles, analyze trends, and provide strategic insights.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Summary: ${article.summary}
Why Interesting: ${article.why_interesting || 'Key insights for analysis'}

RESEARCH FOCUS: "${theme}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for recent articles related to "${theme}" in the topic "${actualTopic}"
2. Analyze current developments and key players in this space
3. Identify market trends and their implications
4. Assess future outlook and potential impacts
5. Provide strategic recommendations for decision-makers

The context article above sparked this research into "${theme}" - use it as a starting point but expand the analysis using your tools to find additional relevant articles and insights.

Provide a thorough analysis using the structured format from your system prompt.`;
        
        // Send initial research message
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: researchPrompt,
                model: selectedModel,
                profile_id: getCurrentProfileId(),
                limit: 50,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });
        
        if (!messageResponse.ok) {
            throw new Error(`Failed to send research message: ${messageResponse.status}`);
        }
        
        // Open Auspex chat modal and connect to the existing session
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));
        
        // Store the chat ID for the modal to use
        window.auspexActiveChatId = chatId;
        window.auspexActiveTheme = theme;
        
        // Set the topic and model in the modal properly
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');
        
        if (topicSelect) {
            topicSelect.value = actualTopic;
            topicSelect.dispatchEvent(new Event('change'));
        }
        
        if (modelSelect) {
            modelSelect.value = selectedModel;
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        // Enable the chat input and send button
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');
            
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Continue research on ${theme}...`;
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Clear existing messages and add our research status
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>Research Session Active</strong><br>
                        I'm conducting comprehensive research on "<strong>${theme}</strong>". 
                        The analysis has been started and results will appear here shortly...
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Analyzing articles and generating insights...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Open the modal
        auspexModal.show();
        
        // Start polling for the research results
        pollForAuspexResults(chatId, theme);
        
        showNotification(`Auspex research launched! Analyzing: ${theme}`, 'success');
        
        // Log for debugging
        console.log(`Launched Auspex research - Theme: ${theme}, Chat ID: ${chatId}, Source: ${sourceArticleUri}`);
        
    } catch (error) {
        console.error('Error launching Auspex research:', error);
        showNotification(`Failed to launch Auspex research: ${error.message}`, 'error');
    }
}

// Poll for Auspex research results
async function pollForAuspexResults(chatId, theme) {
    let pollCount = 0;
    const maxPolls = 120; // Poll for up to 4 minutes (LLM might take longer)
    const pollInterval = 2000; // Poll every 2 seconds
    
    console.log(`Starting polling for research results - Chat ID: ${chatId}, Theme: ${theme}`);
    
    const poll = async () => {
        try {
            // Get chat history to see if there are new messages
            const response = await fetch(`/api/auspex/chat/sessions/${chatId}/messages`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to get chat history: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            console.log(`Poll ${pollCount}: Response data:`, data);
            
            // Handle different response structures - the API returns {chat_id, messages, topic}
            const messages = data.messages || [];
            console.log(`Poll ${pollCount}: Got ${messages.length} messages for chat ${chatId}`);
            
            // Log message details for debugging
            if (messages.length > 0) {
                messages.forEach((msg, idx) => {
                    console.log(`Poll ${pollCount}: Message ${idx}: role=${msg.role}, content_length=${msg.content?.length || 0}, is_complete=${msg.is_complete}`);
                });
            } else {
                console.log(`Poll ${pollCount}: No messages yet, LLM might still be processing...`);
            }
            
            // Look for assistant messages (responses) - exclude system messages
            const assistantMessages = messages.filter(msg => msg.role === 'assistant' && msg.content && msg.content.trim().length > 0);
            console.log(`Poll ${pollCount}: Found ${assistantMessages.length} assistant messages`);
            
            // We need at least 2 messages: the initial system message and our research response
            if (assistantMessages.length > 0) {
                // Get the latest assistant message
                const latestResponse = assistantMessages[assistantMessages.length - 1];
                
                // Make sure it's not just an error message or empty response
                if (latestResponse.content && latestResponse.content.length > 50) {
                    displayAuspexResult(latestResponse.content, theme);
                    return; // Stop polling
                }
            }
            
            pollCount++;
            if (pollCount < maxPolls) {
                setTimeout(poll, pollInterval);
            } else {
                // Timeout - show error message
                displayAuspexTimeout(theme);
            }
            
        } catch (error) {
            console.error('Error polling for Auspex results:', error);
            displayAuspexError(error.message, theme);
        }
    };
    
    // Start polling after a brief delay
    setTimeout(poll, pollInterval);
}

// Display Auspex research result
function displayAuspexResult(content, theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        // Use marked.js for proper markdown rendering
        const formattedContent = formatAuspexMarkdown(content);
        
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Complete: ${theme}</strong><br>
                    <div class="mt-2 auspex-research-content">
                        ${formattedContent}
                    </div>
                    <div id="auspex-followups" class="mt-3"></div>
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    showNotification(`Research complete for: ${theme}`, 'success');
    try { renderFollowUpActionsFromContent(content); } catch(_) {}
}
// Parse model output to extract Next Steps and Suggested Queries, render actionable badges
function renderFollowUpActionsFromContent(markdownText) {
    const container = document.getElementById('auspex-followups');
    if (!container || !markdownText) return;
    const text = String(markdownText);
    const nextSteps = [];
    const queries = [];
    const lines = text.split(/\r?\n/);
    let inNext = false, inQueries = false;
    for (const raw of lines) {
        const line = raw.trim();
        const lower = line.toLowerCase();
        // Section headers with or without markdown '#' and with variants
        if (/^#+\s*next steps/i.test(line) || lower.startsWith('next steps') || lower.startsWith('next steps:')) { inNext = true; inQueries = false; continue; }
        if (/^#+\s*suggested.*(query|search|filter)/i.test(line) || (lower.includes('suggested') && (lower.includes('query') || lower.includes('search') || lower.includes('filter')))) { inNext = false; inQueries = true; continue; }
        if (/^#+\s/.test(line)) { inNext = false; inQueries = false; }
        let bullet = line.replace(/^[-*â€¢]\s+/, '').trim();
        if (!bullet) continue;
        // Strip ordered list prefix like "1. "
        bullet = bullet.replace(/^\d+\.|^\d+\)\s*/, '').trim();
        if (inNext && bullet.length > 3) {
            nextSteps.push(bullet.replace(/[\u201C\u201D]/g,'"'));
            continue;
        }
        if (inQueries) {
            // Accept non-bulleted lines too
            let candidate = bullet;
            // Prefer quoted phrase
            const m = candidate.match(/[\"\u201C]([^\"\u201D]+)[\"\u201D]/);
            if (m && m[1]) {
                queries.push(m[1].trim());
                continue;
            }
            // Otherwise, cut before dash or filter explanation
            const splitIdx = candidate.search(/[â€”â€“\-]\s|\swith\s|\sfocusing\s|\sfiltered\s|\scombining\s/i);
            if (splitIdx > 0) candidate = candidate.slice(0, splitIdx).trim();
            candidate = candidate.replace(/^"|"$/g,'');
            if (candidate.length > 3) queries.push(candidate);
        }
    }
    const makeBtn = (label, type) => {
        const cls = type === 'query' ? 'btn btn-sm btn-outline-info me-1 mb-1' : 'btn btn-sm btn-outline-primary me-1 mb-1';
        const enc = encodeURIComponent(label);
        return `<button class="${cls}" data-type="${type}" data-text="${enc}" onclick="handleFollowUpClick(this)" title="${escapeHTML(label)}"><i class=\"fas fa-bolt me-1\"></i>${escapeHTML(label)}</button>`;
    };
    let html = '';
    if (nextSteps.length) {
        html += '<div class="mb-2"><small class="text-muted fw-bold">Next Steps:</small><div class="mt-1">';
        html += nextSteps.slice(0, 12).map(step => makeBtn(step, 'action')).join('');
        html += '</div></div>';
    }
    if (queries.length) {
        html += '<div class="mb-2"><small class="text-muted fw-bold">Suggested Dataset Searches:</small><div class="mt-1">';
        html += queries.slice(0, 20).map(q => makeBtn(q, 'query')).join('');
        html += '</div></div>';
    }
    if (!html) return;
    container.innerHTML = html;
}

// Unified click handler to avoid brittle inline JS quoting
function handleFollowUpClick(buttonEl) {
    try {
        const type = buttonEl.getAttribute('data-type');
        const text = decodeURIComponent(buttonEl.getAttribute('data-text') || '');
        if (!text) return;
        if (type === 'query') return runDatasetQuery(text);
        return runFollowUpAction(text);
    } catch (e) {
        console.error('Failed to handle follow-up click', e);
        showNotification('Could not run follow-up action', 'error');
    }
}

// Execute a follow-up action by launching a targeted Auspex prompt in the same chat
async function runFollowUpAction(actionText) {
    try {
        const chatId = window.currentAuspexChatId; // set during polling/launch
        if (!chatId) { showNotification('Chat session not found', 'warning'); return; }
        const selectedModel = document.getElementById('floatingModelSelect')?.value || 'gpt-4o-mini';
        const prompt = `Follow-up action requested: ${actionText}\n\nPlease execute this action using dataset-first analysis. Cite URIs.`;
        await fetch('/api/auspex/chat/message', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: chatId, message: prompt, model: selectedModel, limit: 50, profile_id: getCurrentProfileId() }) });
        pollForAuspexResults(chatId, 'Follow-up');
        showNotification('Running follow-up action...', 'info');
    } catch (e) {
        console.error('Follow-up action failed', e);
        showNotification('Failed to run follow-up action', 'error');
    }
}

// Run a dataset query by reusing our dataset-first prompt pattern
async function runDatasetQuery(queryText) {
    try {
        const chatId = window.currentAuspexChatId; // set during polling/launch
        if (!chatId) { showNotification('Chat session not found', 'warning'); return; }
        const topic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        const currentArticles = window.lastArticlesData?.items || [];
        const { detailedLines } = buildDatasetContext(queryText, currentArticles, 12, 20);
        const prompt = `Dataset-first follow-up search: "${queryText}" in topic ${topic}.\n\nRelevant dataset items:\n${detailedLines || '(no strong matches; propose dataset search expansions)'}\n\nPlease analyze these items, cite URIs, and propose next dataset filters.`;
        await fetch('/api/auspex/chat/message', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: chatId, message: prompt, model: selectedModel, limit: 50, profile_id: getCurrentProfileId() }) });
        pollForAuspexResults(chatId, 'Dataset Search');
        showNotification('Running dataset search...', 'info');
    } catch (e) {
        console.error('Dataset query failed', e);
        showNotification('Failed to run dataset search', 'error');
    }
}

// Display timeout message
function displayAuspexTimeout(theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Timeout</strong><br>
                    The research for "${theme}" is taking longer than expected. You can continue chatting in this session - the results may still appear.
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// Display error message
function displayAuspexError(errorMessage, theme) {
    const chatMessages = document.getElementById('floatingChatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = `
            <div class="floating-message assistant">
                <div class="floating-message-avatar">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                </div>
                <div class="floating-message-content">
                    <strong>Research Error</strong><br>
                    There was an error with the research for "${theme}": ${errorMessage}
                </div>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// Load related articles for sidebar (headlines only)
async function loadRelatedArticlesSidebar(articleUri) {
    const sidebarId = `related-sidebar-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const sidebarDiv = document.getElementById(sidebarId);
    
    if (!sidebarDiv || sidebarDiv.dataset.loaded) return;
    
    try {
        const response = await fetch(`/api/vector-similar?uri=${encodeURIComponent(articleUri)}&top_k=8`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const results = data.results || [];
        
        if (results.length > 0) {
            let html = '<div class="related-articles-compact">';
            results.forEach((related, index) => {
                if (index < 8) { // Show up to 8 in sidebar
                    html += `<div class="mb-1 d-flex align-items-center gap-1">
                        <a href="${related.id}" target="_blank"
                           class="text-decoration-none small flex-grow-1"
                           style="font-size: 10px; line-height: 1.2; color: var(--colors-info-5);"
                           title="${escapeHTML(related.metadata?.title || 'Related article')}">
                            <i class="fas fa-external-link-alt me-1 text-muted"></i>
                            ${escapeHTML((related.metadata?.title || 'Related article').substring(0, 50))}${(related.metadata?.title || '').length > 50 ? '...' : ''}
                        </a>
                        <button class="btn btn-outline-primary btn-sm" 
                                style="font-size: 8px; padding: 0px 2px; line-height: 1;"
                                onclick="loadRelatedArticleAnalysis('${related.id}')"
                                title="Analyze this related article">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>`;
                }
            });
            html += '</div>';
            sidebarDiv.innerHTML = html;
        } else {
            sidebarDiv.innerHTML = '<small class="text-muted">No related articles</small>';
        }
        
        sidebarDiv.dataset.loaded = 'true';
        
    } catch (error) {
        console.error('Error loading related articles for sidebar:', error);
        sidebarDiv.innerHTML = '<small class="text-warning">Failed to load</small>';
    }
}

// Open annotation modal
function openAnnotationModal(articleUri) {
    // Create annotation modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'annotationModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sticky-note me-2"></i>Add Annotation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Article URL</label>
                        <input type="url" class="form-control" value="${articleUri}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Annotation</label>
                        <textarea class="form-control" id="annotationContent" rows="4" 
                                  placeholder="Add your analysis or comments..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="annotationPrivate">
                        <label class="form-check-label" for="annotationPrivate">
                            Private note (not included in analysis)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAnnotationFromModal('${articleUri}')">
                        <i class="fas fa-save me-1"></i>Save Annotation
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal after it's hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Save annotation from modal
async function saveAnnotationFromModal(articleUri) {
    const content = document.getElementById('annotationContent').value.trim();
    const isPrivate = document.getElementById('annotationPrivate').checked;
    
    if (!content) {
        showNotification('Please enter annotation content', 'warning');
        return;
    }
    
    try {
        const doubleEncodedUri = encodeURIComponent(encodeURIComponent(articleUri));
        
        const response = await fetch(`/api/articles/${doubleEncodedUri}/annotations`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content,
                is_private: isPrivate
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || 'Failed to save annotation');
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('annotationModal'));
        modal.hide();
        
        showNotification('Annotation saved successfully!', 'success');
        
    } catch (error) {
        console.error('Error saving annotation:', error);
        showNotification(`Failed to save annotation: ${error.message}`, 'error');
    }
}

// Load related article analysis in-app
async function loadRelatedArticleAnalysis(articleUri) {
    try {
        showNotification('Loading related article analysis...', 'info');
        
        // Find if this article is already in our current dataset
        const existingArticle = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        
        if (existingArticle) {
            // Article already loaded - just scroll to it and expand
            const articleElement = document.querySelector(`[onclick*="${articleUri}"]`);
            if (articleElement) {
                articleElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Trigger expansion
                const expandButton = articleElement.closest('.list-group-item').querySelector('.expand-arrow-btn');
                if (expandButton && expandButton.querySelector('i').className.includes('chevron-right')) {
                    expandButton.click();
                }
                showNotification('Scrolled to related article', 'success');
                return;
            }
        }
        
        // Article not in current view - load it in a modal
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Get article analysis
        const response = await fetch('/api/vector-summary-raw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to load article: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Create modal to show the related article
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-newspaper me-2"></i>Related Article Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="related-article-content">
                            ${formatMarkdownAnalysis(data.response || 'Analysis not available')}
                        </div>
                        <div class="text-end mt-3">
                            <small class="text-muted">
                                <a href="${articleUri}" target="_blank" class="text-decoration-none">
                                    <i class="fas fa-external-link-alt me-1"></i>View original article
                                </a>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
        
        showNotification('Related article loaded', 'success');
        
    } catch (error) {
        console.error('Error loading related article:', error);
        showNotification(`Failed to load related article: ${error.message}`, 'error');
    }
}

// Launch Auspex Deep Dive analysis
async function launchAuspexDeepDive(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }

        const actualTopic = article.topic || getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching Auspex deep-dive analysis...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Deep Dive: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build deep dive prompt using the deepdiveprompt.md template
        const deepDivePrompt = `Conduct a comprehensive deep-dive analysis of the topic covered in this article using the Deep Dive Template framework.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Date: ${article.date}
Summary: ${article.summary}
Why Interesting: ${article.why_interesting || 'Key insights for analysis'}

DEEP DIVE INSTRUCTIONS:
Use your tools to search for articles related to the themes in this article and conduct a comprehensive analysis following the Deep Dive Template structure:

1. Topic Definition & Context Setting
2. Multi-Dimensional Analysis (4-5 relevant dimensions)
3. Strategic Summary Analysis  
4. Consensus vs Industry Narrative Comparison
5. Strategic Breakdown & Evidence
6. Synthesis & Strategic Insights
7. Final Assessment

Focus on providing evidence-based analysis grounded in multiple sources, not just the context article. Use your search tools to find related articles and build a comprehensive picture.

Target length: 900-1200 words with specific data points and strategic insights.`;
        
        await launchAuspexWithPrompt(chatId, deepDivePrompt, selectedModel, actualTopic, 'Deep Dive Analysis');
        
    } catch (error) {
        console.error('Error launching deep dive:', error);
        showNotification(`Failed to launch deep dive: ${error.message}`, 'error');
    }
}

// Launch Consensus vs Fringe Voices analysis
async function launchConsensusAnalysis(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }

        // Debug logging
        console.log('=== CONSENSUS ANALYSIS DEBUG ===');
        console.log('Article URI:', articleUri);
        console.log('Article found:', !!article);
        console.log('Article.topic:', article.topic);
        console.log('getCurrentTopic():', getCurrentTopic());
        console.log('Article keys:', Object.keys(article));

        const actualTopic = article.topic || getCurrentTopic() || 'AI and Machine Learning';
        console.log('Final topic selected:', actualTopic);
        console.log('=================================');

        // Show visible notification with ALL the debug info
        const topicDebug = 'TOPIC: article=' + article.topic + ' | filter=' + getCurrentTopic() + ' | USING=' + actualTopic;
        showNotification(topicDebug, 'warning');

        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';

        showNotification('Launching consensus vs fringe analysis...', 'info');
        
        // Create Auspex chat session
        console.log('Creating Auspex session with topic:', actualTopic);
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic.trim(),  // Trim whitespace from topic
                title: `Consensus Analysis: ${article.title}`
            })
        });
        console.log('Session creation response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Extract key claims from the article
        const consensusPrompt = `Analyze the consensus vs fringe voices regarding the claims made in this article.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Summary: ${article.summary}

CONSENSUS ANALYSIS INSTRUCTIONS:
1. Identify the key claims or predictions made in this article
2. Use your tools to search for related articles in the topic "${actualTopic}"
3. Analyze whether these claims represent:
   - Mainstream consensus (majority view)
   - Emerging consensus (growing agreement)
   - Fringe perspective (minority/outlier view)
   - Mixed views (no clear consensus)

4. Provide evidence-based analysis showing:
   - What the consensus actually says about these topics
   - How this article's perspective compares to the broader evidence
   - Timeline consensus (when impacts are expected)
   - Confidence levels in different scenarios
   - Notable outlier perspectives (both optimistic and pessimistic)

5. Structure your response with clear sections showing the comparison between this article's claims and the broader consensus patterns.

Use your search and analysis tools to gather comprehensive evidence from multiple sources.`;
        
        await launchAuspexWithPrompt(chatId, consensusPrompt, selectedModel, actualTopic, 'Consensus Analysis');
        
    } catch (error) {
        console.error('Error launching consensus analysis:', error);
        showNotification(`Failed to launch consensus analysis: ${error.message}`, 'error');
    }
}

// Launch Impact Timeline analysis
async function launchTimelineAnalysis(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }

        const actualTopic = article.topic || getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Launching impact timeline analysis...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Timeline Analysis: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Extract themes and build timeline prompt
        const timelinePrompt = `Analyze the impact timeline and strategic planning horizons for the themes discussed in this article.

CONTEXT ARTICLE:
Title: ${article.title}
Source: ${article.source}
Category: ${article.category || 'Not specified'}
Future Signal: ${article.future_signal || 'Not specified'}
Time to Impact: ${article.time_to_impact || 'Not specified'}
Summary: ${article.summary}

TIMELINE ANALYSIS INSTRUCTIONS:
1. Identify the key themes and developments mentioned in this article
2. Use your tools to search for related articles in "${actualTopic}" to build a comprehensive timeline
3. Create strategic planning horizons showing:
   - Immediate impacts (2025)
   - Short-term developments (2025-2027)
   - Mid-term transformations (2027-2030)
   - Long-term implications (2030-2035+)

4. For each timeframe, provide:
   - Key milestones and decision points
   - Strategic implications for decision-makers
   - Risk and opportunity windows
   - Evidence from multiple sources

5. Structure your analysis to help strategic planning with specific timelines, actionable insights, and evidence-based projections.

Use your search and analysis tools to gather comprehensive timeline evidence from multiple sources.`;
        
        await launchAuspexWithPrompt(chatId, timelinePrompt, selectedModel, actualTopic, 'Timeline Analysis');
        
    } catch (error) {
        console.error('Error launching timeline analysis:', error);
        showNotification(`Failed to launch timeline analysis: ${error.message}`, 'error');
    }
}

// Helper function to get current profile ID
function getCurrentProfileId() {
    const profileSelect = document.getElementById('profile-select');
    return profileSelect && profileSelect.value ? parseInt(profileSelect.value) : null;
}

// Helper function to create Auspex chat session with profile
async function createAuspexChatSession(topic, title) {
    const profileId = getCurrentProfileId();
    
    const response = await fetch('/api/auspex/chat/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            topic: topic,
            title: title,
            profile_id: profileId
        })
    });
    
    if (!response.ok) {
        throw new Error(`Failed to create chat session: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (profileId) {
        console.log(`Created Auspex chat session ${data.chat_id} with organizational profile ${profileId}`);
    }
    
    return data.chat_id;
}

// Common function to launch Auspex with a specific prompt
async function launchAuspexWithPrompt(chatId, prompt, model, topic, analysisType) {
    try {
        // Open Auspex modal IMMEDIATELY with loading state
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));

        // Set the topic and model in the modal properly
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');

        if (topicSelect) {
            topicSelect.value = topic;
            topicSelect.dispatchEvent(new Event('change'));
        }

        if (modelSelect) {
            modelSelect.value = model;
            modelSelect.dispatchEvent(new Event('change'));
        }

        // Clear existing messages and add our analysis status
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>${analysisType} Starting</strong><br>
                        Preparing comprehensive ${analysisType.toLowerCase()} analysis...
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Initializing analysis...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Open the modal IMMEDIATELY
        auspexModal.show();

        // Get the selected organizational profile
        const profileSelect = document.getElementById('profile-select');
        const selectedProfileId = profileSelect && profileSelect.value ? parseInt(profileSelect.value) : null;

        // NOW send the analysis prompt with profile context (async, after modal is visible)
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: prompt,
                model: model,
                limit: 50,
                profile_id: selectedProfileId,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });

        if (!messageResponse.ok) {
            throw new Error(`Failed to send analysis message: ${messageResponse.status}`);
        }

        // Enable the chat input and send button after message is sent
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');

            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Continue ${analysisType.toLowerCase()}...`;
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Start polling for the analysis results
        pollForAuspexResults(chatId, analysisType);

        // Expose chat id for follow-up actions
        window.currentAuspexChatId = chatId;
        
        showNotification(`${analysisType} launched successfully!`, 'success');
        
    } catch (error) {
        console.error(`Error launching ${analysisType}:`, error);
        showNotification(`Failed to launch ${analysisType}: ${error.message}`, 'error');
    }
}

function toggleStarArticle(articleUri, buttonElement) {
    if (starredArticles.has(articleUri)) {
        // Remove star
        starredArticles.delete(articleUri);
        buttonElement.classList.remove('starred');
        buttonElement.style.background = 'rgba(255, 193, 7, 0.1)';
        buttonElement.style.color = 'var(--colors-warning-9)';
        buttonElement.title = 'Add to Six Articles';
        showNotification('Article removed from Six Articles selection', 'info');
    } else {
        // Add star
        if (starredArticles.size >= 6) {
            showNotification('Maximum 6 articles can be starred for Six Articles analysis', 'warning');
            return;
        }
        
        starredArticles.add(articleUri);
        buttonElement.classList.add('starred');
        buttonElement.style.background = 'var(--colors-warning-9)';
        buttonElement.style.color = 'white';
        buttonElement.title = 'Remove from Six Articles';
        showNotification('Article added to Six Articles selection', 'success');
    }
    
    updateStarredCount();
}

function updateStarredCount() {
    // Update any UI elements that show starred count
    const starredCount = starredArticles.size;
    
    // Update six articles tab to show starred count
    const sixArticlesTab = document.getElementById('six-articles-tab');
    if (sixArticlesTab) {
        const originalText = sixArticlesTab.textContent.replace(/ \(\d+\)$/, '');
        sixArticlesTab.textContent = starredCount > 0 ? `${originalText} (${starredCount})` : originalText;
    }
    
    // Show warning if more than 6 are starred (shouldn't happen due to limit, but safety check)
    if (starredCount > 6) {
        showNotification('Too many articles starred! Please unstar some to keep 6 or fewer.', 'danger');
    }
}

// Helper functions for bias and factuality display
function getBiasClass(bias) {
    if (!bias) return 'bg-light text-dark';

    const biasClasses = {
        'left': 'bg-primary',
        'left-center': 'bg-info',
        'center': 'bg-secondary',
        'right-center': 'bg-warning text-dark',
        'right': 'bg-danger',
        'mixed': 'bg-dark'
    };

    return biasClasses[bias.toLowerCase()] || 'bg-light text-dark';
}

function getFactualityClass(factuality) {
    if (!factuality) return 'bg-light text-dark';

    const factualityClasses = {
        'very high': 'bg-success',
        'high': 'bg-success',
        'mostly factual': 'bg-info',
        'mixed': 'bg-warning text-dark',
        'low': 'bg-danger',
        'very low': 'bg-danger'
    };

    return factualityClasses[factuality.toLowerCase()] || 'bg-light text-dark';
}

// Add CSS for filter badges
const style = document.createElement('style');
style.textContent = `
    .filter-badge {
        transition: all 0.2s ease;
        opacity: 0.7;
        border: 1px solid transparent;
    }
    
    .filter-badge:hover {
        opacity: 1;
        transform: translateY(-1px);
    }
    
    .filter-badge.active {
        opacity: 1;
        border: 2px solid var(--colors-white);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }
    
    .selected-date-compact {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        background: rgba(0,123,255,0.1);
        border-radius: 4px;
        border: 1px solid rgba(0,123,255,0.2);
    }
`;
document.head.appendChild(style);

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing news feed...');

    // Restore controls state first
    // restoreControlsState(); // Commented out - controls should always start expanded

    // Load saved defaults
    loadSavedDefaults();
    
    // Load calendar and other data
    loadAvailableDates();
    
    // Load organizational profiles (this will restore profile selection)
    loadOrganizationalProfiles();

    // Initialize article count for default date range
    updateArticleCountForDateRange();

    // Initialize filter dropdown content for Article Investigator (default tab)
    updateFilterDropdownContent('articles');

    // Initialize toolbar visibility - show only Article Investigator toolbar by default
    const toolbarArticles = document.getElementById('toolbar-article-investigator');
    const toolbarInsights = document.getElementById('toolbar-narrative-explorer');
    const toolbarSixArticles = document.getElementById('toolbar-six-articles');
    if (toolbarArticles) toolbarArticles.style.display = 'flex';
    if (toolbarInsights) toolbarInsights.style.display = 'none';
    if (toolbarSixArticles) toolbarSixArticles.style.display = 'none';

    // Auto-load articles with 90-day default
    setTimeout(() => {
        autoLoadArticles();
    }, 1000); // Delay to ensure all settings are loaded
});

// Helper function for sentiment styling
function getSentimentClass(sentiment) {
    if (!sentiment) return 'bg-light text-dark';
    const sentimentLower = sentiment.toLowerCase();
    if (sentimentLower.includes('positive')) return 'bg-success text-white';
    if (sentimentLower.includes('negative') || sentimentLower.includes('critical')) return 'bg-danger text-white';
    if (sentimentLower.includes('neutral')) return 'bg-secondary text-white';
    return 'bg-light text-dark';
}

// Launch Ask Auspex chat with article context
async function launchAuspexChat(articleUri) {
    try {
        const article = window.lastArticlesData?.items?.find(a => a.uri === articleUri);
        if (!article) {
            throw new Error('Source article not found in current dataset');
        }

        const actualTopic = article.topic || getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        showNotification('Setting up Auspex chat for this article...', 'info');
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Article Discussion: ${article.title}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Get the current analysis if available
        const analysisId = `analysis-${articleUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const analysisDiv = document.getElementById(analysisId);
        const existingAnalysis = analysisDiv?.querySelector('.analysis-text')?.textContent || 'No analysis available yet';
        
        // Build context prompt with article and analysis
        const contextPrompt = `I'd like to discuss this article with you. Here's the full context:

ARTICLE DETAILS:
Title: ${article.title}
Source: ${article.source}
Date: ${article.date}
URL: ${article.uri}
Category: ${article.category || 'Not specified'}
Sentiment: ${article.sentiment || 'Not specified'}
Future Signal: ${article.future_signal || 'Not specified'}
Time to Impact: ${article.time_to_impact || 'Not specified'}
Driver Type: ${article.driver_type || 'Not specified'}
Tags: ${article.tags || 'None'}

ARTICLE SUMMARY:
${article.summary}

CURRENT ANALYSIS:
${existingAnalysis}

I'm ready to discuss this article with you. You can use your tools to search for related information, analyze trends, or dive deeper into any aspect of this article. What would you like to explore?`;
        
        // Send the context message
        const messageResponse = await fetch('/api/auspex/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                message: contextPrompt,
                model: selectedModel,
                profile_id: getCurrentProfileId(),
                limit: 50,
                tools_config: {
                    search_articles: true,
                    get_sentiment_analysis: true,
                    semantic_search_and_analyze: true
                }
            })
        });
        
        if (!messageResponse.ok) {
            throw new Error(`Failed to send context message: ${messageResponse.status}`);
        }
        
        // Open Auspex modal and set it up for conversation
        const auspexModal = new bootstrap.Modal(document.getElementById('floatingChatModal'));
        
        // Set the topic and model in the modal
        const topicSelect = document.getElementById('floatingTopicSelect');
        const modelSelect = document.getElementById('floatingModelSelect');
        
        if (topicSelect) {
            topicSelect.value = actualTopic;
            topicSelect.dispatchEvent(new Event('change'));
        }
        
        if (modelSelect) {
            modelSelect.value = selectedModel;
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        // Enable the chat input for continued conversation
        setTimeout(() => {
            const chatInput = document.getElementById('floatingChatInput');
            const sendButton = document.getElementById('floatingChatSend');
            
            if (chatInput) {
                chatInput.disabled = false;
                chatInput.placeholder = `Ask me anything about: ${article.title.substring(0, 50)}...`;
                chatInput.focus();
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
        }, 200);
        
        // Show initial message
        const chatMessages = document.getElementById('floatingChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="floating-message assistant">
                    <div class="floating-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="floating-message-content">
                        <strong>Article Context Loaded</strong><br>
                        I've analyzed the article "<strong>${article.title}</strong>" and I'm ready to discuss it with you.
                        <div class="mt-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Processing article context...</small>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Open the modal
        auspexModal.show();
        
        // Poll for the context response, then enable chat
        pollForAuspexResults(chatId, 'Article Context');
        
        showNotification('Auspex chat ready for article discussion!', 'success');
        
    } catch (error) {
        console.error('Error launching Auspex chat:', error);
        showNotification(`Failed to launch Auspex chat: ${error.message}`, 'error');
    }
}

// ===== INSIGHTS TAB FUNCTIONALITY =====

window.insightsState = {
    hasArticleCache: false,
    hasCategoryCache: false,
    hasIncidentCache: false,
    isLoading: false
};
const insightsState = window.insightsState; // Alias for backward compatibility

function updateInsightsButton() {
    const insightsBtn = document.getElementById('insights-generate-btn');
    const insightsBtnText = document.getElementById('insights-generate-text');
    const insightsIcon = insightsBtn ? insightsBtn.querySelector('i') : null;

    if (!insightsBtn) return;

    if (insightsState.isLoading) {
        insightsBtn.disabled = true;
        if (insightsIcon) insightsIcon.className = 'fas fa-spinner fa-spin me-2';
        if (insightsBtnText) insightsBtnText.textContent = 'Generating...';
    } else if (insightsState.hasArticleCache || insightsState.hasCategoryCache || insightsState.hasIncidentCache) {
        insightsBtn.disabled = false;
        if (insightsIcon) insightsIcon.className = 'fas fa-sync-alt me-2';
        if (insightsBtnText) insightsBtnText.textContent = 'Regenerate';
        insightsBtn.classList.remove('btn-baby-blue', 'btn-info');
        insightsBtn.classList.add('btn-outline-baby-blue');
        // When cached data exists, clicking regenerates
        insightsBtn.onclick = () => smartGenerateInsights(true);
    } else {
        insightsBtn.disabled = false;
        if (insightsIcon) insightsIcon.className = 'fas fa-brain me-2';
        if (insightsBtnText) insightsBtnText.textContent = 'Generate Insights';
        insightsBtn.classList.remove('btn-info', 'btn-outline-baby-blue');
        insightsBtn.classList.add('btn-baby-blue');
        // When no cache, clicking generates normally
        insightsBtn.onclick = () => smartGenerateInsights(false);
    }
}

async function checkInsightsCache() {
    const topics = getSelectedTopics();
    if (!topics || topics.length === 0) {
        console.log('[Cache Check] No topics selected');
        insightsState.hasArticleCache = false;
        insightsState.hasCategoryCache = false;
        insightsState.hasIncidentCache = false;
        updateInsightsButton();
        return;
    }

    let currentArticles = window.lastArticlesData?.items || [];
    if (currentArticles.length === 0) {
        console.log('[Cache Check] No articles loaded yet - triggering article load first');
        // Load articles first, then retry cache check
        if (typeof autoLoadArticles === 'function') {
            await autoLoadArticles();
            // Wait a bit for articles to populate
            await new Promise(resolve => setTimeout(resolve, 1000));
            // Retry with newly loaded articles
            currentArticles = window.lastArticlesData?.items || [];
            if (currentArticles.length === 0) {
                console.log('[Cache Check] Still no articles after load attempt');
                updateInsightsButton();
                return;
            }
            console.log('[Cache Check] Articles loaded, count:', currentArticles.length, 'first URI:', currentArticles[0]?.uri);
        } else {
            updateInsightsButton();
            return;
        }
    } else {
        console.log('[Cache Check] Articles already loaded, count:', currentArticles.length, 'first URI:', currentArticles[0]?.uri);
    }

    const cacheUri = currentArticles[0].uri;
    // Use 'all_topics' for multiple topics to match caching logic
    const topicsKey = topics.length > 1 ? 'all_topics' : topics[0];

    try {
        // Check article insights cache
        const articleCacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=article_insights_${topicsKey}&model=dashboard_api`);
        if (articleCacheResponse.ok) {
            const articleCache = await articleCacheResponse.json();
            insightsState.hasArticleCache = articleCache.cached;
            console.debug('[Cache Check] Article insights cache:', articleCache.cached, 'key:', topicsKey);
        }

        // Check category insights cache
        const categoryCacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=category_insights_${topicsKey}&model=dashboard_api`);
        if (categoryCacheResponse.ok) {
            const categoryCache = await categoryCacheResponse.json();
            insightsState.hasCategoryCache = categoryCache.cached;
            console.debug('[Cache Check] Category insights cache:', categoryCache.cached, 'key:', topicsKey);
        }

        // Check incident tracking cache (uses sorted comma-joined topics)
        const incidentTopicsKey = topics.slice().sort().join(',');
        const incidentCheckUrl = `/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=incident_tracking_${incidentTopicsKey}&model=incident_analysis`;
        console.log('[Cache Check] Checking incident tracking cache:', incidentCheckUrl);
        const incidentCacheResponse = await fetch(incidentCheckUrl);
        if (incidentCacheResponse.ok) {
            const incidentCache = await incidentCacheResponse.json();
            insightsState.hasIncidentCache = incidentCache.cached;
            console.log('[Cache Check] Incident tracking cache:', incidentCache.cached, 'key:', incidentTopicsKey, 'response:', incidentCache);
        } else {
            console.log('[Cache Check] Incident tracking cache check failed:', incidentCacheResponse.status);
        }

    } catch (error) {
        console.debug('Cache check failed:', error);
    }

    updateInsightsButton();
}

async function autoLoadCachedInsights() {
    const topics = getSelectedTopics();
    console.log('[Auto-load] Starting auto-load check, topics:', topics);

    if (!topics || topics.length === 0) {
        console.log('[Auto-load] No topics selected, showing welcome message');
        showInsightsWelcomeMessage();
        return;
    }

    await checkInsightsCache();

    console.log('[Auto-load] Cache check complete. State:', {
        hasArticleCache: insightsState.hasArticleCache,
        hasCategoryCache: insightsState.hasCategoryCache,
        hasIncidentCache: insightsState.hasIncidentCache
    });

    // If we have any cached data, auto-load it
    if (insightsState.hasArticleCache || insightsState.hasCategoryCache || insightsState.hasIncidentCache) {
        console.log('[Auto-load] Cached insights found, calling smartGenerateInsights...');
        try {
            await smartGenerateInsights(false, true); // false = don't force, true = auto-load
            console.log('[Auto-load] smartGenerateInsights completed successfully');
        } catch (error) {
            console.error('[Auto-load] Error in smartGenerateInsights:', error);
        }
    } else {
        console.log('[Auto-load] No cached insights found');
        showInsightsWelcomeMessage();
    }
}

async function smartGenerateInsights(forceRegenerate = false, isAutoLoad = false) {
    if (isAutoLoad) {
        console.log('[smartGenerateInsights] Auto-load mode, forceRegenerate:', forceRegenerate);
    } else {
        console.log('Smart insights button clicked', forceRegenerate ? '(force regenerate)' : '');
    }

    insightsState.isLoading = true;
    updateInsightsButton();

    try {
        console.log('[smartGenerateInsights] Calling generateInsights...');
        await generateInsights(forceRegenerate);
        console.log('[smartGenerateInsights] generateInsights completed');

        // After generating insights, check cache status to update button correctly
        // (insights are now cached after generation)
        await checkInsightsCache();

    } finally {
        insightsState.isLoading = false;
        updateInsightsButton();
    }
}

function showInsightsWelcomeMessage() {
    // Show welcome messages in each panel if they're empty
    const articleContainer = document.getElementById('article-insights-container');
    const categoryContainer = document.getElementById('category-insights-container');
    const thematicContainer = document.getElementById('thematic-insights-container');
    
    if (articleContainer && !articleContainer.querySelector('.insight-item-card')) {
        articleContainer.innerHTML = `
            <div class="text-center p-5 w-100">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Article Theme Analysis</h5>
                <p class="text-muted mb-3">AI-powered thematic analysis of current articles with research suggestions.</p>
                <p class="text-muted mb-4">Select topics and date range above, then click the button below to generate insights.</p>
                <button class="btn btn-primary btn-lg" onclick="generateInsights()">
                    <i class="fas fa-magic me-2"></i>Generate Insights
                </button>
            </div>
        `;
    }
    
    if (categoryContainer && !categoryContainer.querySelector('.insight-item-card')) {
        categoryContainer.innerHTML = `
            <div class="text-center p-5">
                <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                <h5>Category Distribution</h5>
                <p class="text-muted mb-3">See how articles are distributed across categories.</p>
                <p class="text-muted mb-4">Select topics and date range above, then click the button below to generate insights.</p>
                <button class="btn btn-primary btn-lg" onclick="generateInsights()">
                    <i class="fas fa-magic me-2"></i>Generate Insights
                </button>
            </div>
        `;
    }
    
    if (thematicContainer && !thematicContainer.querySelector('.insight-item-card')) {
        thematicContainer.innerHTML = `
            <div class="text-center p-4 w-100">
                <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                <h5>Thematic Clusters</h5>
                <p class="text-muted">Generate insights to see AI-powered thematic groupings of articles.</p>
            </div>
        `;
    }
}

async function loadArticleInsights(topics, startDate, endDate, daysLimit, forceRegenerate = false) {
    // Handle both array and string input
    let topic;
    if (Array.isArray(topics)) {
        if (topics.length === 0) {
            console.error('[ArticleInsights] No topics provided');
            return;
        } else if (topics.length === 1) {
            topic = topics[0];
        } else {
            // Multiple topics selected - use "all_topics" to get insights across all topics
            topic = "all_topics";
            console.log(`[ArticleInsights] Multiple topics selected (${topics.length}), analyzing all topics together`);
        }
    } else {
        topic = topics;
    }

    if (!topic) {
        console.error('[ArticleInsights] No topic provided');
        return;
    }

    const loadingEl = document.getElementById('article-insights-loading');
    const errorEl = document.getElementById('article-insights-error');
    const containerEl = document.getElementById('article-insights-container');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';

    try {
        // Check database cache first using representative article URI
        const cacheKey = `article_insights_${topic}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit}`;
        let cacheUri = null;

        // Use the first article URI from current dataset as cache reference
        const currentArticles = window.lastArticlesData?.items || [];
        console.log('[ArticleInsights] forceRegenerate:', forceRegenerate, 'topic:', topic, 'startDate:', startDate, 'endDate:', endDate, 'daysLimit:', daysLimit);
        console.log('[ArticleInsights] lastArticlesData.items length:', currentArticles.length);
        if (currentArticles.length > 0) {
            cacheUri = currentArticles[0].uri; // Use first article as cache anchor
        }
        console.log('[ArticleInsights] cacheKey:', cacheKey, 'cacheUri:', cacheUri);
        
        if (cacheUri && !forceRegenerate) {
            try {
                const cacheCheckUrl = `/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=article_insights_${topic}&model=dashboard_api`;
                console.log('[ArticleInsights] Checking DB cache:', cacheCheckUrl);
                const cacheResponse = await fetch(cacheCheckUrl);
                console.log('[ArticleInsights] Cache response status:', cacheResponse.status);
                if (cacheResponse.ok) {
                    const cacheData = await cacheResponse.json();
                    console.log('[ArticleInsights] Cache metadata:', cacheData && cacheData.metadata);
                    if (cacheData.cached && cacheData.metadata) {
                        // Check if cache matches our parameters
                        const metadata = cacheData.metadata;
                        console.log('[ArticleInsights] Computed cacheKey:', cacheKey, 'Stored cache_key:', metadata.cache_key);
                        if (metadata.cache_key === cacheKey) {
                            console.log('[ArticleInsights] Using cached article insights from database');
                            const cachedInsights = JSON.parse(cacheData.content || '[]');
                            console.log('[ArticleInsights] Cached insights length:', Array.isArray(cachedInsights) ? cachedInsights.length : 'n/a');
                            
                            // Add cache indicator
                            const containerEl = document.getElementById('article-insights-container');
                            renderArticleInsights(cachedInsights);
                            
                            // Add cache timestamp
                            const cacheTimestamp = cacheData.generated_at ? new Date(cacheData.generated_at).toLocaleString() : 'unknown time';
                            const cacheIndicator = document.createElement('div');
                            cacheIndicator.className = 'cache-indicator';
                            cacheIndicator.innerHTML = `<i class="fas fa-database me-1"></i>Loaded from database cache (generated: ${cacheTimestamp})`;
                            containerEl.parentElement.appendChild(cacheIndicator);
                            
                            return;
                        } else {
                            console.log('[ArticleInsights] Cache key mismatch; bypassing cache');
                        }
                    } else {
                        console.log('[ArticleInsights] No cached content available');
                    }
                } else {
                    console.log('[ArticleInsights] Cache check not OK:', cacheResponse.status);
                }
            } catch (cacheError) {
                console.debug('[ArticleInsights] Database cache check failed, proceeding with API call:', cacheError);
            }
        } else if (forceRegenerate) {
            console.log('[ArticleInsights] Force regenerate is true; skipping DB cache');
        }
        
        const params = new URLSearchParams();
        if (startDate && endDate) {
            params.append('start_date', startDate);
            params.append('end_date', endDate);
        } else {
            params.append('days_limit', daysLimit.toString());
        }
        
        if (forceRegenerate) {
            params.append('force_regenerate', 'true');
        }
        
        // Add model parameter
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
        params.append('model', selectedModel);
        
        const insightsUrl = `/api/dashboard/article-insights/${encodeURIComponent(topic)}?${params}`;
        console.log('[ArticleInsights] Fetching insights:', insightsUrl);
        const response = await fetch(insightsUrl);
        
        if (!response.ok) {
            // Handle specific HTTP error codes with user-friendly messages
            if (response.status === 404) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `No articles found for topic '${topic}' in the specified date range. Try expanding the date range or selecting a different topic.`);
            } else if (response.status === 422) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Insufficient articles for meaningful insights. Try expanding the date range or selecting a different topic.`);
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
        
        const data = await response.json();
        console.log('[ArticleInsights] API insights length:', Array.isArray(data) ? data.length : 'n/a');
        if (!Array.isArray(data) || data.length === 0) {
            console.log('[ArticleInsights] Empty insights from API; will NOT cache empty result');
        }
        
        // Cache insights in database using representative article URI
        try {
            const cacheKey = `article_insights_${topic}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit}`;
            const currentArticles = window.lastArticlesData?.items || [];
            
            if (currentArticles.length > 0 && Array.isArray(data) && data.length > 0) {
                const cacheUri = currentArticles[0].uri; // Use first article as cache anchor
                const cacheContent = JSON.stringify(data, null, 2);
                const cacheMetadata = {
                    cache_key: cacheKey,
                    topic: topic,
                    start_date: startDate,
                    end_date: endDate,
                    days_limit: daysLimit,
                    insight_type: 'article_themes',
                    article_count: currentArticles.length
                };
                
                console.log('[ArticleInsights] Saving insights to cache for uri:', cacheUri, 'metadata:', cacheMetadata);
                const cacheResponse = await fetch('/api/save-analysis-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        article_uri: cacheUri,
                        analysis_type: `article_insights_${topic}`,
                        content: cacheContent,
                        model_name: 'dashboard_api',
                        metadata: cacheMetadata
                    })
                });
                
                if (cacheResponse.ok) {
                    console.log('[ArticleInsights] Cached article insights in database');
                } else {
                    console.warn('[ArticleInsights] Failed to cache article insights - server error:', cacheResponse.status);
                }
            } else if (!Array.isArray(data) || data.length === 0) {
                console.warn('[ArticleInsights] Skipping cache save because insights are empty');
            } else {
                console.warn('[ArticleInsights] No articles available for cache anchoring');
            }
        } catch (cacheError) {
            console.warn('[ArticleInsights] Failed to cache article insights:', cacheError);
        }

        renderArticleInsights(data);

        // Auto-save to dashboard cache
        await autoSaveDashboard('narratives', { insights: data }, {
            view_type: 'Narratives',
            model_used: 'dashboard_api'
        });

    } catch (error) {
        console.error('Error loading article insights:', error);
        
        // Provide specific error messages based on the error content
        let errorMessage = error.message;
        let errorIcon = 'fas fa-exclamation-triangle';
        let errorClass = 'alert-warning';
        
        if (error.message.includes('No articles found') || error.message.includes('Insufficient articles')) {
            errorIcon = 'fas fa-info-circle';
            errorClass = 'alert-info';
        }
        
        errorEl.innerHTML = `<div class="alert ${errorClass}"><i class="${errorIcon} me-2"></i>${errorMessage}</div>`;
        errorEl.style.display = 'block';
        
        // Show appropriate fallback message
        if (error.message.includes('No articles found') || error.message.includes('Insufficient articles')) {
            containerEl.innerHTML = `
                <div class="text-center p-4 w-100">
                    <i class="fas fa-calendar-times fa-2x text-info mb-3"></i>
                    <h5>Insufficient Data for Insights</h5>
                    <p class="text-muted">Try expanding your date range to include more articles, or select a topic with more activity.</p>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            Tip: Article insights require at least 3 articles to generate meaningful themes.
                        </small>
                    </div>
                </div>
            `;
        } else {
            containerEl.innerHTML = `
                <div class="text-center p-4 w-100">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                    <h5>Article Insights Unavailable</h5>
                    <p class="text-muted">Unable to generate article insights. Please try again or contact support if the problem persists.</p>
                </div>
            `;
        }
    } finally {
        loadingEl.style.display = 'none';
    }
}

async function loadCategoryInsights(topics, startDate, endDate, daysLimit, forceRegenerate = false) {
    // Handle both array and string input
    let topic;
    if (Array.isArray(topics)) {
        if (topics.length === 0) {
            console.error('[CategoryInsights] No topics provided');
            return;
        } else if (topics.length === 1) {
            topic = topics[0];
        } else {
            // Multiple topics selected - use "all_topics" to get insights across all topics
            topic = "all_topics";
            console.log(`[CategoryInsights] Multiple topics selected (${topics.length}), analyzing all topics together`);
        }
    } else {
        topic = topics;
    }

    if (!topic) {
        console.error('[CategoryInsights] No topic provided');
        return;
    }

    const loadingEl = document.getElementById('category-insights-loading');
    const errorEl = document.getElementById('category-insights-error');
    const containerEl = document.getElementById('category-insights-container');

    // Category insights removed in v2 - skip if elements don't exist
    if (!loadingEl || !errorEl || !containerEl) {
        console.log('[CategoryInsights] Category insights panel not found (removed in v2)');
        return;
    }

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';

    try {
        // Check database cache first using representative article URI
        const cacheKey = `category_insights_${topic}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit}`;
        let cacheUri = null;

        // Use the first article URI from current dataset as cache reference
        const currentArticles = window.lastArticlesData?.items || [];
        if (currentArticles.length > 0) {
            cacheUri = currentArticles[0].uri; // Use first article as cache anchor
        }
        
        if (cacheUri) {
            try {
                const cacheResponse = await fetch(`/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=category_insights_${topic}&model=dashboard_api`);
                if (cacheResponse.ok) {
                    const cacheData = await cacheResponse.json();
                    if (cacheData.cached && cacheData.metadata) {
                        // Check if cache matches our parameters
                        const metadata = cacheData.metadata;
                        if (metadata.cache_key === cacheKey) {
                            if (forceRegenerate) {
                                console.log('Bypassing cached category insights due to force regenerate');
                            } else {
                                console.log('Using cached category insights from database');
                                const cachedInsights = JSON.parse(cacheData.content);
                                
                                // Add cache indicator
                                const containerEl = document.getElementById('category-insights-container');
                                renderCategoryInsights(cachedInsights);
                                
                                // Add cache timestamp
                                const cacheTimestamp = new Date(cacheData.generated_at).toLocaleString();
                                const cacheIndicator = document.createElement('div');
                                cacheIndicator.className = 'cache-indicator';
                                cacheIndicator.innerHTML = `<i class="fas fa-database me-1"></i>Loaded from database cache (generated: ${cacheTimestamp})`;
                                containerEl.parentElement.appendChild(cacheIndicator);
                                
                                return;
                            }
                        }
                    }
                }
            } catch (cacheError) {
                console.debug('Database cache check failed, proceeding with API call:', cacheError);
            }
        }
        
        const params = new URLSearchParams();
        if (startDate && endDate) {
            params.append('start_date', startDate);
            params.append('end_date', endDate);
        } else {
            params.append('days_limit', daysLimit.toString());
        }
        
        if (forceRegenerate) {
            params.append('force_regenerate', 'true');
        }
        
        // Add model parameter
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
        params.append('model', selectedModel);
        
        const response = await fetch(`/api/dashboard/category-insights/${encodeURIComponent(topic)}?${params}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Cache category insights in database using representative article URI
        try {
            const cacheKey = `category_insights_${topic}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit}`;
            const currentArticles = window.lastArticlesData?.items || [];
            
            if (currentArticles.length > 0) {
                const cacheUri = currentArticles[0].uri; // Use first article as cache anchor
                const cacheContent = JSON.stringify(data, null, 2);
                const cacheMetadata = {
                    cache_key: cacheKey,
                    topic: topic,
                    start_date: startDate,
                    end_date: endDate,
                    days_limit: daysLimit,
                    insight_type: 'category_distribution',
                    article_count: currentArticles.length
                };
                
                const cacheResponse = await fetch('/api/save-analysis-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        article_uri: cacheUri,
                        analysis_type: `category_insights_${topic}`,
                        content: cacheContent,
                        model_name: 'dashboard_api',
                        metadata: cacheMetadata
                    })
                });
                
                if (cacheResponse.ok) {
                    console.log('Cached category insights in database');
                } else {
                    console.warn('Failed to cache category insights - server error:', cacheResponse.status);
                }
            } else {
                console.warn('No articles available for cache anchoring');
            }
        } catch (cacheError) {
            console.warn('Failed to cache category insights:', cacheError);
        }
        
        renderCategoryInsights(data);
        
    } catch (error) {
        console.error('Error loading category insights:', error);
        errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load category insights: ${error.message}</div>`;
        errorEl.style.display = 'block';
        
        // Show fallback message
        containerEl.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                <h5>Category Analysis Unavailable</h5>
                <p class="text-muted">Unable to generate category insights. Please try again or check if the topic has sufficient articles.</p>
            </div>
        `;
    } finally {
        loadingEl.style.display = 'none';
    }
}

async function loadThematicInsights(topic, startDate, endDate, daysLimit) {
    const loadingEl = document.getElementById('thematic-insights-loading');
    const errorEl = document.getElementById('thematic-insights-error');
    const containerEl = document.getElementById('thematic-insights-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        // Require a topic (dashboard article-insights is topic-scoped)
        const topicSelect = document.getElementById('topic-select');
        const selectedTopic = topicSelect ? (topicSelect.value || '').trim() : '';
        if (!selectedTopic) {
            errorEl.innerHTML = `<div class="alert alert-warning"><i class=\"fas fa-info-circle me-2\"></i>Select a topic to generate thematic clusters.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Build time params from the current date range
        const drSel = document.getElementById('date-range-select');
        const drVal = drSel ? drSel.value : '3m';
        const params = new URLSearchParams();
        let periodLabel = 'this period';
        switch (drVal) {
            case '24h':
                params.append('days_limit', '1'); periodLabel = 'the last 24 hours'; break;
            case '7d':
                params.append('days_limit', '7'); periodLabel = 'the last 7 days'; break;
            case '30d':
                params.append('days_limit', '30'); periodLabel = 'the last 30 days'; break;
            case '3m':
                params.append('days_limit', '90'); periodLabel = 'the last 3 months'; break;
            case '1y':
                params.append('days_limit', '365'); periodLabel = 'the last year'; break;
            case 'all':
                // Let the backend decide; do not pass days_limit
                periodLabel = 'all time'; break;
            case 'custom':
                // Use the selected date as both start and end
                const customDate = document.getElementById('custom-date-input')?.value || document.getElementById('selected-date')?.value;
                if (customDate) {
                    params.append('start_date', customDate);
                    params.append('end_date', customDate);
                    periodLabel = 'the selected date';
                } else {
                    params.append('days_limit', '1');
                    periodLabel = 'the last 24 hours';
                }
                break;
            default:
                params.append('days_limit', '90'); periodLabel = 'the last 3 months';
        }
        
        // Call topic dashboard article-insights (same logic as topic_dashboard.html)
        const response = await fetch(`/api/dashboard/article-insights/${encodeURIComponent(selectedTopic)}?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();

        // If no themes returned, show explicit reason (no fallback rendering)
        if (!data || (Array.isArray(data) && data.length === 0)) {
            errorEl.innerHTML = `<div class=\"alert alert-warning\"><i class=\"fas fa-info-circle me-2\"></i>No thematic clusters available. Reason: insufficient thematic signal for ${periodLabel}.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Transform dashboard themes -> cluster format used by renderThematicInsights
        const currentArticles = (window.lastArticlesData && window.lastArticlesData.items) ? window.lastArticlesData.items : [];
        const transformed = (Array.isArray(data) ? data : []).map((theme, idx) => {
            // Try to find article details from current dataset by URIs if provided
            let articles = [];
            const articleUris = theme.article_uris || theme.articleIds || theme.article_ids || [];
            if (Array.isArray(articleUris) && articleUris.length > 0 && currentArticles.length > 0) {
                articles = articleUris.map(uri => currentArticles.find(a => a.uri === uri)).filter(Boolean);
            }
            // Fallback: if API already includes article objects
            if ((!articles || articles.length === 0) && Array.isArray(theme.articles)) {
                articles = theme.articles;
            }
            // Compute simple source diversity
            const sourceDiversity = [...new Set((articles || []).map(a => a?.source_type || a?.news_source || 'unknown'))].length;
            
            return {
                theme_name: theme.theme_name || theme.name || `Theme ${idx + 1}`,
                theme_summary: theme.theme_summary || theme.summary || '',
                articles: articles || [],
                article_count: (articles || []).length,
                confidence: typeof theme.confidence === 'number' ? theme.confidence : undefined,
                source_diversity: sourceDiversity
            };
        });

        if (!transformed || transformed.length === 0) {
            errorEl.innerHTML = `<div class=\"alert alert-warning\"><i class=\"fas fa-info-circle me-2\"></i>No thematic clusters available. Reason: the topic has themes but no matching articles were loaded for ${periodLabel}. Try regenerating articles or adjusting the date range.</div>`;
            errorEl.style.display = 'block';
            return;
        }
        
        renderThematicInsights(transformed);
    } catch (error) {
        console.error('Error loading thematic insights:', error);
        errorEl.innerHTML = `<div class=\"alert alert-warning\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load thematic insights: ${error.message}</div>`;
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function renderArticleInsights(data) {
    const container = document.getElementById('article-insights-container');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No article insights available for this period.</div>';
        return;
    }
    
    console.log(`Rendering ${data.length} article insights:`, data);
    
    data.forEach((themeItem, index) => {
        const insightCard = document.createElement('div');
        insightCard.className = 'insight-item-card';
        
        // Build articles list with links
        let articlesHtml = '<ul class="list-unstyled mt-2 mb-0 small">';
        if (themeItem.articles && themeItem.articles.length > 0) {
            themeItem.articles.forEach(article => {
                const pubDate = article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'N/A';
                articlesHtml += `
                    <li class="mb-1">
                        <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                            ${article.title || 'Untitled Article'}
                        </a>
                        <small class="text-muted d-block">${formatSource(article.news_source, article.uri)} - ${pubDate}</small>
                        ${article.summary ? `<p class="mb-0 fst-italic text-muted" style="font-size: 0.8rem;">${article.summary.substring(0, 100)}...</p>` : ''}
                    </li>`;
            });
        } else {
            articlesHtml += '<li class="text-muted">No specific articles listed for this theme.</li>';
        }
        articlesHtml += '</ul>';

        insightCard.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">${themeItem.theme_name || 'Unnamed Theme'}</h6>
                <span class="badge bg-warning text-dark">Theme</span>
            </div>
            <p class="mb-1 small">${themeItem.theme_summary || 'No summary provided for this theme.'}</p>
            ${articlesHtml}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(themeItem.theme_name)}', 'article_theme')">
                    <i class="fas fa-search me-1"></i>Research with Auspex
                </button>
            </div>
        `;
        container.appendChild(insightCard);
    });
}

function renderCategoryInsights(data) {
    const container = document.getElementById('category-insights-container');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No category insights available for this period.</div>';
        return;
    }
    
    data.forEach(categoryItem => {
        const card = document.createElement('div');
        card.className = 'insight-item-card';
        
        // Prefer backend-provided sample articles; fallback to current feed filter
        let categoryArticles = [];
        if (Array.isArray(categoryItem.sample_articles) && categoryItem.sample_articles.length > 0) {
            categoryArticles = categoryItem.sample_articles;
        } else {
            const currentArticles = window.lastArticlesData?.items || [];
            categoryArticles = currentArticles.filter(article => 
                article.category && article.category.toLowerCase() === categoryItem.category.toLowerCase()
            ).slice(0, 5); // Show up to 5 articles
        }
        
        // Build articles list
        let articlesHtml = '';
        if (categoryArticles.length > 0) {
            articlesHtml = `
                <div class="mt-2 mb-2">
                    <small class="text-muted fw-bold">Sample Articles:</small>
                    <ul class="list-unstyled mt-1 mb-0 small">
                        ${categoryArticles.map(article => {
                            const pubDate = article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'N/A';
                            return `
                                <li class="mb-1">
                                    <a href="${article.uri}" target="_blank" rel="noopener" class="text-decoration-none">
                                        ${article.title || 'Untitled Article'}
                                    </a>
                                    <small class="text-muted d-block">${formatSource(article.news_source, article.uri)} - ${pubDate}</small>
                                </li>`;
                        }).join('')}
                    </ul>
                </div>
            `;
        }

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">${categoryItem.category}</h6>
                <span class="badge bg-success text-dark">Category</span>
            </div>
            <p class="mb-1 small"><strong>Article Count:</strong> ${categoryItem.article_count}</p>
            <p class="mb-2 small fst-italic">${categoryItem.insight_text || 'Further analysis for this category will be available soon.'}</p>
            ${articlesHtml}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(categoryItem.category)}', 'category')">
                    <i class="fas fa-search me-1"></i>Research Category
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

function renderThematicInsights(data) {
    const container = document.getElementById('thematic-insights-container');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No thematic clusters available for this period.</div>';
        return;
    }
    
    data.forEach((cluster, index) => {
        const card = document.createElement('div');
        card.className = 'insight-item-card thematic-cluster';
        
        // Source diversity indicators
        const sourceTypes = cluster.source_types || [];
        const sourceBadges = sourceTypes.map(type => {
            const color = type === 'arxiv' ? 'primary' : 
                         type === 'bluesky' ? 'info' : 
                         type === 'thenewsapi' ? 'success' : 'secondary';
            return `<span class="badge bg-${color} me-1">${type.toUpperCase()}</span>`;
        }).join('');
        
        // Articles list (initially hidden)
        let articlesHtml = '';
        if (cluster.articles && cluster.articles.length > 0) {
            articlesHtml = `
                <div class="cluster-article-list" id="cluster-articles-${index}" style="display: none;">
                    ${cluster.articles.map(article => `
                        <div class="cluster-article-item">
                            <a href="${article.url || '#'}" target="_blank" rel="noopener">
                                <strong>${article.title || 'Untitled Article'}</strong>
                            </a>
                            <div class="text-muted small mt-1">
                                ${article.source_type ? `<span class="badge bg-secondary me-2">${article.source_type.toUpperCase()}</span>` : ''}
                                ${article.publication_date ? new Date(article.publication_date).toLocaleDateString() : 'No date'}
                                ${article.author ? ` â€¢ ${article.author}` : ''}
                            </div>
                            ${article.content ? `<p class="small text-muted mt-1 mb-0">${article.content.substring(0, 150)}...</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        const stats = `
            <div class="cluster-stats">
                <div class="cluster-stat">
                    <i class="fas fa-file-alt"></i>
                    <span>${cluster.article_count || cluster.articles?.length || 0} articles</span>
                </div>
                <div class="cluster-stat">
                    <i class="fas fa-percentage"></i>
                    <span>${Math.round((cluster.confidence || 0) * 100)}% confidence</span>
                </div>
                <div class="cluster-stat">
                    <i class="fas fa-layer-group"></i>
                    <span>${cluster.source_diversity || 1} sources</span>
                </div>
            </div>
        `;
        
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-primary">${cluster.theme_name || `Theme ${index + 1}`}</h6>
                <div class="d-flex align-items-center gap-2">
                    ${sourceBadges}
                    <span class="badge bg-info">Thematic</span>
                </div>
            </div>
            <p class="mb-2 small">${cluster.theme_summary || cluster.description || 'No summary available for this theme.'}</p>
            ${stats}
            ${cluster.articles && cluster.articles.length > 0 ? `
            <div class="mt-2 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="toggleClusterArticles(${index})">
                    <i class="fas fa-eye"></i> <span id="toggle-text-${index}">Show Articles</span>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="launchAuspexResearchFromInsight('${escapeHTML(cluster.theme_name || `Theme ${index + 1}`)}', 'thematic_cluster')">
                    <i class="fas fa-search me-1"></i>Research Theme
                </button>
            </div>
            ${articlesHtml}` : ''}
        `;
        
        container.appendChild(card);
    });
}

function toggleClusterArticles(clusterIndex) {
    const articlesList = document.getElementById(`cluster-articles-${clusterIndex}`);
    const toggleText = document.getElementById(`toggle-text-${clusterIndex}`);
    
    if (!articlesList) return;
    
    if (articlesList.style.display === 'none') {
        articlesList.style.display = 'block';
        if (toggleText) toggleText.textContent = 'Hide Articles';
    } else {
        articlesList.style.display = 'none';
        if (toggleText) toggleText.textContent = 'Show Articles';
    }
}

function clearInsightsContent() {
    // Clear all insights content when topic or date range changes
    const articleContainer = document.getElementById('article-insights-container');
    const categoryContainer = document.getElementById('category-insights-container');
    const thematicContainer = document.getElementById('thematic-insights-container');
    
    if (articleContainer) {
        articleContainer.innerHTML = `
            <div class="text-center p-5 w-100">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Article Theme Analysis</h5>
                <p class="text-muted mb-3">AI-powered thematic analysis of current articles with research suggestions.</p>
                <p class="text-muted mb-4">Select topics and date range above, then click the button below to generate insights.</p>
                <button class="btn btn-primary btn-lg" onclick="generateInsights()">
                    <i class="fas fa-magic me-2"></i>Generate Insights
                </button>
            </div>
        `;
    }

    if (categoryContainer) {
        categoryContainer.innerHTML = `
            <div class="text-center p-5">
                <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                <h5>Category Distribution</h5>
                <p class="text-muted mb-3">See how articles are distributed across categories.</p>
                <p class="text-muted mb-4">Select topics and date range above, then click the button below to generate insights.</p>
                <button class="btn btn-primary btn-lg" onclick="generateInsights()">
                    <i class="fas fa-magic me-2"></i>Generate Insights
                </button>
            </div>
        `;
    }
    
    if (thematicContainer) {
        thematicContainer.innerHTML = `
            <div class="text-center p-4 w-100">
                <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                <h5>Thematic Clusters</h5>
                <p class="text-muted">Generate insights to see AI-powered thematic groupings of articles.</p>
            </div>
        `;
    }
}

// Helper: build dataset-anchored context to avoid generic prompts
function buildDatasetContext(insightTopic, articles, detailedLimit = 15, extraLimit = 35) {
    if (!Array.isArray(articles) || articles.length === 0) return { detailedLines: '', uriLines: '', matches: [] };
    const topic = String(insightTopic || '').toLowerCase();
    const SYNONYMS = {
        'deal': ['deal', 'dealmaking', 'acquisition', 'acquire', 'merger', 'm&a', 'investment', 'funding', 'raise', 'round', 'series a', 'series b', 'financing', 'partnership', 'agreement', 'contract', 'buyout', 'ipo', 'alliance', 'joint venture'],
        'regulation': ['regulation', 'regulatory', 'policy', 'compliance', 'dsa', 'gdpr', 'antitrust', 'lawsuit', 'complaint', 'fine', 'ban', 'oversight'],
        'safety': ['safety', 'governance', 'risk', 'alignment', 'responsibility', 'ethics', 'ethical'],
        'incident': ['incident', 'breach', 'leak', 'lawsuit', 'complaint', 'investigation']
    };
    const terms = new Set(topic.split(/\W+/).filter(Boolean));
    Object.entries(SYNONYMS).forEach(([key, words]) => {
        if (topic.includes(key) || terms.has(key)) words.forEach(w => terms.add(w));
    });
    const scoreFor = (text, weight) => {
        if (!text) return 0;
        const lower = String(text).toLowerCase();
        let s = 0;
        terms.forEach(t => { if (t && lower.includes(t)) s += weight; });
        return s;
    };
    const scored = articles.map(a => {
        const s = (scoreFor(a.title, 3) + scoreFor(a.summary, 1) + scoreFor(a.category, 2) + scoreFor((a.tags||[]).join(' '), 2));
        return { article: a, score: s };
    }).sort((x, y) => y.score - x.score);
    const positive = scored.filter(x => x.score > 0).map(x => x.article);
    const topDetailed = positive.slice(0, detailedLimit);
    const remaining = positive.slice(detailedLimit, detailedLimit + extraLimit);
    const detailedLines = topDetailed.map((article, idx) => {
        const date = formatPubDate(article.publication_date, false);
        const source = formatSource(article.news_source, article.uri);
        const brief = (article.summary || '').slice(0, 140).replace(/\n+/g, ' ');
        return `${idx + 1}. ${article.title} (${source}, ${date})\n   URI: ${article.uri}\n   Brief: ${brief}${brief.length >= 140 ? '...' : ''}`;
    }).join('\n');
    const uriLines = remaining.map(a => `- ${a.title} â€” ${a.uri}`).join('\n');
    return { detailedLines, uriLines, matches: topDetailed.concat(remaining) };
}

// Launch Auspex research from insights (similar to article research themes)
async function launchAuspexResearchFromInsight(insightTopic, insightType) {
    try {
        showNotification(`Launching Auspex research on: ${insightTopic}`, 'info');
        
        // Get the current topic and articles context
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const currentArticles = window.lastArticlesData?.items || [];
        
        console.log(`Research setup: Insight="${insightTopic}", Type="${insightType}", Topic="${actualTopic}"`);
        
        // Create Auspex chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `${insightType === 'category' ? 'Category' : insightType === 'thematic_cluster' ? 'Theme' : 'Article'} Research: ${insightTopic}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Get the selected model from the news feed UI
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Build comprehensive research prompt based on insight type
        let researchPrompt = '';
        
        if (insightType === 'ceo_article') {
            // CEO article deep dive research prompt
            researchPrompt = `Conduct executive-level deep dive analysis on: "${insightTopic}"

This article was selected as one of the top 6 most important AI articles for CEOs and senior decision-makers.

RESEARCH FOCUS: Executive deep dive on "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for related articles and background context on this topic
2. Analyze strategic implications for executive decision-making
3. Identify competitive landscape and market dynamics
4. Assess regulatory and policy implications
5. Evaluate risks and opportunities for organizations
6. Provide actionable recommendations for senior leadership
7. Identify key stakeholders and decision points
8. Analyze potential timeline and impact scenarios

Focus on executive-level strategic insights that would be valuable for C-suite decision-making and board discussions.`;
        } else if (insightType === 'category') {
            // Category research prompt
            const categoryArticles = currentArticles.filter(article => 
                article.category && article.category.toLowerCase() === insightTopic.toLowerCase()
            );
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, categoryArticles, 18, 42);
            
            researchPrompt = `Conduct comprehensive research on the "${insightTopic}" category in ${actualTopic}.

CONTEXT FROM NEWS FEED:
Top matching articles in our dataset (detailed):\n${detailedLines || '(no strong matches in current feed)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: "${insightTopic}" category analysis

Please use your tools to:
1. First analyze the dataset articles above (cite URIs). Build connections and timelines across them.
2. Identify key entities, organizations, and deal terms appearing repeatedly.
3. Summarize developments, trends, and market implications specific to this dataset.
4. Suggest exactly 2-3 high-priority follow-up questions that users could ask to expand coverage.
5. Only if necessary, suggest 1-2 external research angles as follow-up.

Write follow-up questions as natural language that users would ask, not as technical function calls.

Respond with sections: Dataset Findings, Key Entities, Timeline, Gaps, Suggested Follow-up Questions (limit to 2-3), Optional Research Angles (limit to 1-2).`;
        } else if (insightType === 'thematic_cluster') {
            // Thematic cluster research prompt
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, currentArticles, 18, 42);
            researchPrompt = `Conduct deep research on the theme "${insightTopic}" within ${actualTopic}.

CONTEXT FROM THEMATIC ANALYSIS:
This theme was identified through AI analysis of current articles in the news feed.

DATASET CONTEXT (top matches):\n${detailedLines || '(no strong matches found; derive related terms and search dataset)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: "${insightTopic}" thematic analysis

Please use your tools to:
1. Prioritize the dataset items above (cite URIs) and synthesize cross-article insights.
2. Identify trends, entities, and relationships evidenced by these articles.
3. Provide dataset-first analysis, then suggest exactly 2-3 follow-up questions users could ask.
4. Provide actionable insights for stakeholders.

Write follow-up questions as natural language that users would ask, not as technical function calls.`;
        } else if (insightType === 'incident') {
            // Incident tracking research prompt
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, currentArticles, 18, 42);
            researchPrompt = `Conduct detailed incident investigation on: "${insightTopic}"

CONTEXT FROM INCIDENT TRACKING:
This incident was identified through AI-powered threat hunting analysis of current articles.

DATASET CONTEXT (potentially related):\n${detailedLines || '(use dataset search to find related incident articles)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: Incident investigation - "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search within our dataset for all articles related to this incident (cite URIs)
2. Build a comprehensive timeline of events and developments
3. Identify key entities, organizations, and stakeholders involved
4. Analyze the scope, impact, and implications of this incident
5. Track related incidents or patterns that might be connected
6. Assess current status and ongoing developments
7. Identify potential risks, vulnerabilities, or threat indicators
8. Provide actionable intelligence and recommendations

Treat this as a comprehensive incident investigation using all available tools and sources.`;
        } else if (insightType === 'signal_investigation') {
            // Signal investigation research prompt  
            researchPrompt = `Conduct deep signal analysis on: "${insightTopic}"

CONTEXT FROM REAL-TIME SIGNALS:
This signal was flagged by custom threat hunting instructions as requiring investigation.

RESEARCH FOCUS: Signal investigation - "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for articles matching this signal pattern
2. Analyze the threat landscape and context around this signal
3. Identify related signals, patterns, or indicators
4. Assess the severity and potential impact of developments
5. Track historical patterns and precedents
6. Evaluate current threat level and trajectory
7. Identify key stakeholders and affected parties
8. Provide actionable threat intelligence and recommendations

Focus on providing comprehensive threat analysis and strategic intelligence.`;
        } else if (insightType === 'investigation_lead') {
            // Investigation lead research prompt
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, currentArticles, 18, 42);
            researchPrompt = `Conduct focused investigation on the lead: "${insightTopic}"

CONTEXT FROM INCIDENT TRACKING:
This investigation lead was identified through AI-powered incident analysis as a key area requiring deeper research.

DATASET CONTEXT (top matches):\n${detailedLines || '(no direct matches found; derive related terms and search the dataset)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: Investigation lead - "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search within our dataset for articles related to this lead (cite URIs)
2. Analyze connections to ongoing incidents or patterns
3. Identify key entities, organizations, or individuals involved
4. Assess the significance and potential implications
5. Track historical context and related developments
6. Evaluate current status and recent activities
7. Identify exactly 2-3 additional investigation angles or related leads
8. Provide actionable intelligence and next steps

Prioritize dataset-first analysis. Suggest exactly 2-3 follow-up questions users could ask to continue the investigation.

Write follow-up questions as natural language that users would ask, not as technical function calls.`;
        } else {
            // Article theme research prompt
            const { detailedLines, uriLines } = buildDatasetContext(insightTopic, currentArticles, 18, 42);
            researchPrompt = `Conduct comprehensive analysis of the theme "${insightTopic}" identified from recent ${actualTopic} articles.

CONTEXT FROM ARTICLE ANALYSIS:
This theme emerged from AI analysis of recent articles in the news feed.

DATASET CONTEXT (top matches):\n${detailedLines || '(derive related terms and search dataset)'}

Additional relevant articles (compact list):\n${uriLines}

RESEARCH FOCUS: "${insightTopic}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Start with the dataset items above; synthesize cross-article findings and cite URIs.
2. Identify trends, entities, relationships, and implications grounded in the dataset.
3. Suggest exactly 2-3 follow-up questions users could ask to expand analysis.
4. Provide strategic recommendations for decision-makers.

Write follow-up questions as natural language that users would ask, not as technical function calls.`;
        }
        
        // Use the same launch pattern as working article analysis
        const displayNames = {
            'category': 'Category Analysis',
            'incident': 'Incident Investigation',
            'signal_investigation': 'Signal Analysis', 
            'article_theme': 'Theme Research',
            'thematic_cluster': 'Thematic Analysis',
            'category_deep': 'Category Deep Dive',
            'strategic_analysis': 'Strategic Analysis',
            'timeline_analysis': 'Timeline Analysis',
            'investigation_lead': 'Investigation Lead'
        };
        
        const analysisDisplayName = displayNames[insightType] || `${insightType} Research`;
        await launchAuspexWithPrompt(chatId, researchPrompt, selectedModel, actualTopic, analysisDisplayName);
        
        showNotification(`Auspex research launched: ${insightTopic}`, 'success');
        
    } catch (error) {
        console.error('Error launching Auspex research:', error);
        showNotification(`Failed to launch Auspex research: ${error.message}`, 'error');
    }
}

// ===== ENHANCED SIX ARTICLES RESEARCH FUNCTIONS =====

// Launch Deep Dive analysis for six articles
async function launchSixArticleDeepDive(articleTitle, articleUrl) {
    try {
        // Find article in lastSixArticles by title to get topic
        const article = window.lastSixArticles?.find(a => a.title === articleTitle);
        const actualTopic = (article?.topic) || getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';

        // Debug logging
        console.log('=== SIX ARTICLE DEEP DIVE DEBUG ===');
        console.log('Article title:', articleTitle);
        console.log('Article found:', !!article);
        console.log('Article topic:', article?.topic);
        console.log('getCurrentTopic():', getCurrentTopic());
        console.log('Using topic:', actualTopic);
        console.log('===================================');
        
        showNotification('Launching deep-dive analysis...', 'info');
        
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `CEO Deep Dive: ${articleTitle}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        const deepDivePrompt = `Conduct a comprehensive executive-level deep-dive analysis of this CEO Daily Top-6 article using the Deep Dive Template framework.

CONTEXT ARTICLE (CEO Daily Selected):
Title: ${articleTitle}
URL: ${articleUrl}
Selected as: One of the 6 most strategically important AI articles for executives

EXECUTIVE DEEP DIVE INSTRUCTIONS:
Use your tools to search for articles related to the themes in this CEO Daily selection and conduct a comprehensive C-suite analysis following the Deep Dive Template structure:

1. Executive Summary & Context Setting
2. Strategic Dimensions Analysis (4-5 relevant dimensions for executives)
3. Market & Competitive Impact Analysis  
4. Regulatory & Risk Assessment
5. Strategic Implications & Evidence
6. Executive Decision Framework
7. Recommended Actions & Timeline

Focus on providing evidence-based analysis grounded in multiple sources that would be valuable for board discussions and executive decision-making. Use your search tools to find related articles and build a comprehensive strategic picture.

Target: Executive briefing quality, 900-1200 words with specific data points and actionable strategic insights.`;
        
        await launchAuspexWithPrompt(chatId, deepDivePrompt, selectedModel, actualTopic, 'CEO Deep Dive Analysis');
        
    } catch (error) {
        console.error('Error launching six article deep dive:', error);
        showNotification(`Failed to launch deep dive: ${error.message}`, 'error');
    }
}

// Launch Consensus analysis for six articles
async function launchSixArticleConsensus(articleTitle, articleUrl) {
    try {
        // Find article in lastSixArticles by title to get topic
        const article = window.lastSixArticles?.find(a => a.title === articleTitle);
        const actualTopic = (article?.topic) || getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';

        // Debug logging
        console.log('=== SIX ARTICLE CONSENSUS DEBUG ===');
        console.log('Article title:', articleTitle);
        console.log('Article found:', !!article);
        console.log('Article topic:', article?.topic);
        console.log('getCurrentTopic():', getCurrentTopic());
        console.log('Using topic:', actualTopic);
        console.log('====================================');
        
        showNotification('Launching consensus analysis...', 'info');
        
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Consensus Analysis: ${articleTitle}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        const consensusPrompt = `Analyze the consensus vs outlier perspectives regarding this CEO Daily Top-6 article.

CONTEXT ARTICLE (CEO Daily Selected):
Title: ${articleTitle}
URL: ${articleUrl}
Strategic Importance: Selected as one of 6 most important AI articles for executives

CONSENSUS ANALYSIS INSTRUCTIONS:
1. Identify the key claims or predictions made in this strategically important article
2. Use your tools to search for related articles in "${actualTopic}"
3. Analyze whether these claims represent:
   - Executive consensus (majority C-suite/analyst view)
   - Emerging consensus (growing agreement among experts)
   - Contrarian perspective (minority/outlier executive view)
   - Mixed expert views (no clear consensus)

4. Provide evidence-based executive analysis showing:
   - What the market consensus actually says about these topics
   - How this article's perspective compares to mainstream executive thinking
   - Timeline consensus among industry leaders (when impacts are expected)
   - Confidence levels in different strategic scenarios
   - Notable outlier perspectives from credible sources

5. Structure your response for executive consumption with clear sections showing the comparison between this article's strategic claims and broader market consensus.

Use your search and analysis tools to gather comprehensive evidence from authoritative sources.`;
        
        await launchAuspexWithPrompt(chatId, consensusPrompt, selectedModel, actualTopic, 'Executive Consensus Analysis');
        
    } catch (error) {
        console.error('Error launching six article consensus:', error);
        showNotification(`Failed to launch consensus analysis: ${error.message}`, 'error');
    }
}

// Launch Timeline analysis for six articles
async function launchSixArticleTimeline(articleTitle, articleUrl) {
    try {
        // Find article in lastSixArticles by title to get topic
        const article = window.lastSixArticles?.find(a => a.title === articleTitle);
        const actualTopic = (article?.topic) || getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';

        // Debug logging
        console.log('=== SIX ARTICLE TIMELINE DEBUG ===');
        console.log('Article title:', articleTitle);
        console.log('Article found:', !!article);
        console.log('Article topic:', article?.topic);
        console.log('getCurrentTopic():', getCurrentTopic());
        console.log('Using topic:', actualTopic);
        console.log('===================================');
        
        showNotification('Launching timeline analysis...', 'info');
        
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Executive Timeline: ${articleTitle}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        const timelinePrompt = `Analyze the executive timeline and strategic planning horizons for this CEO Daily Top-6 article.

CONTEXT ARTICLE (CEO Daily Selected):
Title: ${articleTitle}
URL: ${articleUrl}
Strategic Priority: Selected as one of 6 most important AI articles for C-suite

EXECUTIVE TIMELINE ANALYSIS INSTRUCTIONS:
1. Identify the key strategic themes and business implications mentioned in this article
2. Use your tools to search for related articles in "${actualTopic}" to build a comprehensive executive timeline
3. Create strategic planning horizons for C-suite decision-making:
   - Immediate actions (Q4 2025)
   - Short-term strategic moves (2025-2027)
   - Mid-term transformations (2027-2030)
   - Long-term strategic positioning (2030-2035+)

4. For each timeframe, provide:
   - Key business milestones and executive decision points
   - Strategic implications for market positioning and competitive advantage
   - Risk and opportunity windows for executives
   - Investment and resource allocation considerations
   - Regulatory and compliance timeline factors
   - Evidence from authoritative industry sources

5. Structure your analysis for board-level strategic planning with specific timelines, actionable insights, and evidence-based executive recommendations.

Use your search and analysis tools to gather comprehensive timeline evidence from credible business and industry sources.`;
        
        await launchAuspexWithPrompt(chatId, timelinePrompt, selectedModel, actualTopic, 'Executive Timeline Analysis');
        
    } catch (error) {
        console.error('Error launching six article timeline:', error);
        showNotification(`Failed to launch timeline analysis: ${error.message}`, 'error');
    }
}

// Launch Chat with Auspex for six articles
async function launchSixArticleChat(articleTitle, articleUrl) {
    try {
        // Find article in lastSixArticles by title to get topic
        const article = window.lastSixArticles?.find(a => a.title === articleTitle);
        const actualTopic = (article?.topic) || getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';

        // Debug logging
        console.log('=== SIX ARTICLE CHAT DEBUG ===');
        console.log('Article title:', articleTitle);
        console.log('Article found:', !!article);
        console.log('Article topic:', article?.topic);
        console.log('getCurrentTopic():', getCurrentTopic());
        console.log('Using topic:', actualTopic);
        console.log('===============================');
        
        showNotification('Setting up Auspex chat for CEO article...', 'info');
        
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `CEO Article Discussion: ${articleTitle}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        const contextPrompt = `I'd like to discuss this CEO Daily Top-6 article with you.

ARTICLE CONTEXT (CEO Daily Selected):
Title: ${articleTitle}
URL: ${articleUrl}
Strategic Importance: This was selected as one of the 6 most important AI articles for executives and senior decision-makers.

EXECUTIVE DISCUSSION SETUP:
This article was chosen based on high scores for strategic relevance, novelty, credibility, and representativeness. It's designed for C-suite consumption and strategic decision-making.

I'm ready to discuss this article with you from an executive perspective. You can use your tools to search for related information, analyze market implications, assess competitive dynamics, or dive deeper into any strategic aspect of this article.

What executive-level insights or strategic analysis would you like to explore about this article?`;
        
        await launchAuspexWithPrompt(chatId, contextPrompt, selectedModel, actualTopic, 'CEO Article Discussion');
        
    } catch (error) {
        console.error('Error launching six article chat:', error);
        showNotification(`Failed to launch Auspex chat: ${error.message}`, 'error');
    }
}

// Open annotation modal for six articles
function openSixArticleAnnotation(articleUrl, articleTitle) {
    if (!articleUrl) {
        showNotification('No URL available for annotation', 'warning');
        return;
    }
    
    // Reuse the existing annotation modal functionality
    openAnnotationModal(articleUrl, articleTitle, 'CEO Daily Top-6 Article', 'CEO Daily Selection');
}
// ===== SIGNAL MANAGEMENT FUNCTIONS =====

function showAddSignalModal() {
    const modal = new bootstrap.Modal(document.getElementById('addSignalModal'));
    
    // Clear form
    document.getElementById('signalName').value = '';
    document.getElementById('signalDescription').value = '';
    document.getElementById('signalInstruction').value = '';
    document.getElementById('signalActive').checked = true;
    
    // Pre-select current topic if one is selected
    const currentTopicSelect = document.getElementById('topic-select');
    const signalTopicSelect = document.getElementById('signalTopic');
    if (currentTopicSelect && signalTopicSelect) {
        signalTopicSelect.value = currentTopicSelect.value || '';
    }
    
    modal.show();
}

async function saveSignalInstruction() {
    const name = document.getElementById('signalName').value.trim();
    const description = document.getElementById('signalDescription').value.trim();
    const instruction = document.getElementById('signalInstruction').value.trim();
    const isActive = document.getElementById('signalActive').checked;
    const signalTopic = document.getElementById('signalTopic').value.trim() || null;
    
    if (!name || !instruction) {
        showNotification('Please provide both a name and instruction', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/signal-instructions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                description: description,
                instruction: instruction,
                topic: signalTopic,
                is_active: isActive
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addSignalModal'));
        modal.hide();
        
        // Refresh signal instructions list
        loadSignalInstructions();
        
        // Clear any cached real-time signals since instructions changed
        clearRealTimeSignalsCache();
        
        // Auto-trigger re-analysis if we're currently on the real-time signals tab
        const activeTab = document.querySelector('#insights-nav .nav-link.active');
        if (activeTab && activeTab.id === 'realtime-signals-nav') {
            setTimeout(() => {
                analyzeRealTimeSignals();
            }, 1000); // Small delay to let the UI update
        }
        
        showNotification(`Signal instruction '${name}' saved successfully!`, 'success');
        
    } catch (error) {
        console.error('Error saving signal instruction:', error);
        showNotification(`Failed to save signal instruction: ${error.message}`, 'error');
    }
}

async function loadSignalInstructions() {
    try {
        // Use the signal-specific topic selector instead of main topic
        const signalTopicSelect = document.getElementById('signal-topic-select');
        const signalTopic = signalTopicSelect ? signalTopicSelect.value : null;
        
        const params = new URLSearchParams();
        if (signalTopic) {
            params.append('topic', signalTopic);
        }
        
        const response = await fetch(`/api/signal-instructions?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        const container = document.getElementById('signal-instructions-list');
        
        if (!data.instructions || data.instructions.length === 0) {
            container.innerHTML = `
                <div class="text-center p-3 text-muted">
                    <i class="fas fa-info-circle me-2"></i>No signal instructions yet. Add one to start monitoring.
                </div>
            `;
            return;
        }
        
        // Get alert counts for each instruction
        const alertCounts = {};
        try {
            for (const instruction of data.instructions) {
                const alertParams = new URLSearchParams();
                alertParams.append('instruction_id', instruction.id.toString());
                alertParams.append('acknowledged', 'false');
                alertParams.append('limit', '1000'); // Get all to count
                
                const alertResponse = await fetch(`/api/signal-alerts?${alertParams}`);
                if (alertResponse.ok) {
                    const alertData = await alertResponse.json();
                    alertCounts[instruction.id] = alertData.total || 0;
                } else {
                    alertCounts[instruction.id] = 0;
                }
            }
        } catch (error) {
            console.warn('Error getting alert counts:', error);
        }
        
        let html = '';
        data.instructions.forEach(instruction => {
            const statusBadge = instruction.is_active ? 
                '<span class="badge bg-success">Active</span>' : 
                '<span class="badge bg-secondary">Inactive</span>';
            
            const topicBadge = instruction.topic ? 
                `<span class="badge bg-info">${instruction.topic}</span>` : 
                '<span class="badge bg-light text-dark">Global</span>';
            
            const flaggedCount = alertCounts[instruction.id] || 0;
            const flaggedBadge = flaggedCount > 0 ? 
                `<span class="badge bg-danger" title="${flaggedCount} articles flagged">${flaggedCount}</span>` : 
                '<span class="badge bg-light text-muted">0</span>';
            
            html += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${escapeHTML(instruction.name)} ${statusBadge} ${topicBadge} ${flaggedBadge}</h6>
                                <p class="mb-1 small text-muted">${escapeHTML(instruction.description)}</p>
                                <p class="mb-0 small"><strong>Instruction:</strong> ${escapeHTML(instruction.instruction.substring(0, 100))}${instruction.instruction.length > 100 ? '...' : ''}</p>
                            </div>
                            <div class="btn-group-vertical btn-group-sm ms-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="runSingleSignal(${instruction.id})" title="Run this signal">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteSignalInstruction(${instruction.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading signal instructions:', error);
        const container = document.getElementById('signal-instructions-list');
        container.innerHTML = `<div class="alert alert-danger">Failed to load signal instructions: ${error.message}</div>`;
    }
}

async function deleteSignalInstruction(instructionId) {
    if (!confirm('Are you sure you want to delete this signal instruction?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/signal-instructions/${instructionId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        loadSignalInstructions(); // Refresh list
        
        // Clear any cached real-time signals since instructions changed
        clearRealTimeSignalsCache();
        
        // Auto-trigger re-analysis if we're currently on the real-time signals tab
        const activeTab = document.querySelector('#insights-nav .nav-link.active');
        if (activeTab && activeTab.id === 'realtime-signals-nav') {
            setTimeout(() => {
                analyzeRealTimeSignals();
            }, 1000); // Small delay to let the UI update
        }
        
        showNotification('Signal instruction deleted successfully', 'success');
        
    } catch (error) {
        console.error('Error deleting signal instruction:', error);
        showNotification(`Failed to delete signal instruction: ${error.message}`, 'error');
    }
}

// ===== INCIDENT TRACKING FUNCTIONS =====

async function loadIncidentTracking(topics, startDate, endDate, daysLimit, forceRegenerate = false) {
    const loadingEl = document.getElementById('incident-tracking-loading');
    const errorEl = document.getElementById('incident-tracking-error');
    const containerEl = document.getElementById('incident-tracking-container');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';

    try {
        // Handle both array and string input for backward compatibility
        const topicsArray = Array.isArray(topics) ? topics : (topics ? [topics] : []);

        if (topicsArray.length === 0) {
            errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>Select at least one topic to track incidents.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Get the selected model from feed configuration
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';

        // Build cache key from sorted topics for consistent caching
        const topicsStr = topicsArray.slice().sort().join(',');
        const cacheKey = `incident_tracking_${topicsStr}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit || 14}`;
        let cacheUri = null;

        // Use the first article URI from current dataset as cache reference
        const currentArticles = window.lastArticlesData?.items || [];
        console.log('[IncidentTracking] forceRegenerate:', forceRegenerate, 'topics:', topicsArray, 'startDate:', startDate, 'endDate:', endDate, 'daysLimit:', daysLimit);
        console.log('[IncidentTracking] lastArticlesData.items length:', currentArticles.length);
        if (currentArticles.length > 0) {
            cacheUri = currentArticles[0].uri; // Use first article as cache anchor
        }
        console.log('[IncidentTracking] cacheKey:', cacheKey, 'cacheUri:', cacheUri);

        if (cacheUri && !forceRegenerate) {
            try {
                const cacheCheckUrl = `/api/analysis-cache?article_uri=${encodeURIComponent(cacheUri)}&analysis_type=incident_tracking_${topicsStr}&model=incident_analysis`;
                console.log('[IncidentTracking] Checking DB cache:', cacheCheckUrl);
                const cacheResponse = await fetch(cacheCheckUrl);
                console.log('[IncidentTracking] Cache response status:', cacheResponse.status);
                if (cacheResponse.ok) {
                    const cacheData = await cacheResponse.json();
                    console.log('[IncidentTracking] Cache metadata:', cacheData && cacheData.metadata);
                    if (cacheData.cached && cacheData.metadata) {
                        // Check if cache matches our parameters
                        const metadata = cacheData.metadata;
                        console.log('[IncidentTracking] Computed cacheKey:', cacheKey, 'Stored cache_key:', metadata.cache_key);
                        if (metadata.cache_key === cacheKey) {
                            console.log('[IncidentTracking] Using cached incident tracking from database');
                            const cachedIncidents = JSON.parse(cacheData.content || '[]');
                            console.log('[IncidentTracking] Cached incidents length:', Array.isArray(cachedIncidents) ? cachedIncidents.length : 'n/a');

                            // Render cached incidents
                            renderIncidentTracking(cachedIncidents);

                            // Add cache timestamp indicator
                            const cacheTimestamp = cacheData.generated_at ? new Date(cacheData.generated_at).toLocaleString() : 'unknown time';
                            const cacheIndicator = document.createElement('div');
                            cacheIndicator.className = 'cache-indicator';
                            cacheIndicator.innerHTML = `<i class="fas fa-database me-1"></i>Loaded from database cache (generated: ${cacheTimestamp})`;
                            containerEl.parentElement.appendChild(cacheIndicator);

                            return;
                        } else {
                            console.log('[IncidentTracking] Cache key mismatch; bypassing cache');
                        }
                    } else {
                        console.log('[IncidentTracking] No cached content available');
                    }
                } else {
                    console.log('[IncidentTracking] Cache check not OK:', cacheResponse.status);
                }
            } catch (cacheError) {
                console.debug('[IncidentTracking] Database cache check failed, proceeding with API call:', cacheError);
            }
        } else if (forceRegenerate) {
            console.log('[IncidentTracking] Force regenerate is true; skipping DB cache');
        }

        // Get the selected organizational profile
        const profileSelect = document.getElementById('profile-select');
        const selectedProfileId = profileSelect && profileSelect.value ? parseInt(profileSelect.value) : null;

        // Use passed parameters instead of reading from DOM
        let requestBody = {
            topics: topicsArray,  // Send topics array instead of single topic
            max_articles: 100,
            model: selectedModel,
            force_regenerate: forceRegenerate || false
        };

        // Add profile_id if selected
        if (selectedProfileId) {
            requestBody.profile_id = selectedProfileId;
            console.log(`Using organizational profile ID: ${selectedProfileId} for incident tracking`);
        }

        // Use passed date parameters
        if (startDate && endDate) {
            requestBody.start_date = startDate;
            requestBody.end_date = endDate;
        } else {
            requestBody.days_limit = daysLimit || 14;
        }
        
        const response = await fetch('/api/incident-tracking', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();

        if (!data.incidents || data.incidents.length === 0) {
            const message = data.message || 'No incidents found';
            errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>${message}</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Cache incident tracking results in database
        try {
            const cacheKey = `incident_tracking_${topicsStr}_${startDate || 'no_start'}_${endDate || 'no_end'}_${daysLimit || 14}`;
            const currentArticles = window.lastArticlesData?.items || [];

            if (currentArticles.length > 0 && Array.isArray(data.incidents) && data.incidents.length > 0) {
                const cacheUri = currentArticles[0].uri; // Use first article as cache anchor
                const cacheContent = JSON.stringify(data.incidents, null, 2);
                const cacheMetadata = {
                    cache_key: cacheKey,
                    topic: topicsStr,
                    start_date: startDate,
                    end_date: endDate,
                    days_limit: daysLimit || 14,
                    insight_type: 'incident_tracking',
                    incident_count: data.incidents.length,
                    article_count: currentArticles.length,
                    model: selectedModel
                };

                console.log('[IncidentTracking] Saving incidents to cache for uri:', cacheUri, 'metadata:', cacheMetadata);
                const cacheResponse = await fetch('/api/save-analysis-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        article_uri: cacheUri,
                        analysis_type: `incident_tracking_${topicsStr}`,
                        content: cacheContent,
                        model_name: 'incident_analysis',
                        metadata: cacheMetadata
                    })
                });

                if (cacheResponse.ok) {
                    console.log('[IncidentTracking] Cached incident tracking results in database');
                } else {
                    console.warn('[IncidentTracking] Failed to cache incident tracking - server error:', cacheResponse.status);
                }
            } else if (!Array.isArray(data.incidents) || data.incidents.length === 0) {
                console.warn('[IncidentTracking] Skipping cache save because incidents are empty');
            } else {
                console.warn('[IncidentTracking] No articles available for cache anchoring');
            }
        } catch (cacheError) {
            console.warn('[IncidentTracking] Failed to cache incident tracking:', cacheError);
        }

        renderIncidentTracking(data.incidents);

        // Auto-save to dashboard cache
        console.log('ðŸŽ¯ Calling autoSaveDashboard for highlights with', data.incidents.length, 'incidents');
        await autoSaveDashboard('highlights', { incidents: data.incidents }, {
            view_type: 'Highlights',
            model_used: selectedModel
        });
        console.log('ðŸŽ¯ autoSaveDashboard completed for highlights');

    } catch (error) {
        console.error('Error loading incident tracking:', error);
        errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load incident tracking: ${error.message}</div>`;
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function renderIncidentTracking(incidents) {
    const container = document.getElementById('incident-tracking-container');
    container.innerHTML = '';
    // Persist last set
    window._lastIncidents = Array.isArray(incidents) ? incidents.slice() : [];

    // Store all incidents for filtering
    allIncidents = Array.isArray(incidents) ? incidents.slice() : [];

    // Scroll to top of the panel to ensure content is visible after render
    setTimeout(() => {
        const insightsContent = document.getElementById('insights-content');
        const incidentPanel = document.getElementById('incident-tracking-panel');
        if (insightsContent) insightsContent.scrollTop = 0;
        if (incidentPanel) incidentPanel.scrollTop = 0;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);

    // Build filter badges
    buildIncidentFilterBadges(allIncidents);

    // Apply current filters
    const filteredIncidents = applyIncidentFilters(allIncidents);
    
    // Toggle to hide implausible/low-quality - DISABLED
    // const toggleId = 'incident-hide-low-toggle';
    let hideLow = false; // Always show all incidents
    // try { const saved = localStorage.getItem(toggleId); if (saved !== null) hideLow = saved === 'true'; } catch(_) {}

    // REMOVED: Hide low-quality toggle UI
    // const controlsHtml = `
    //     <div class="form-check form-switch d-flex align-items-center gap-2 m-0" id="incident-controls-switch">
    //         <input class="form-check-input" type="checkbox" id="${toggleId}" ${hideLow ? 'checked' : ''}>
    //         <label class="form-check-label small mb-0" for="${toggleId}">Hide implausible or low-quality source incidents</label>
    //     </div>
    // `;
    // // Insert controls into top toolbar (preserve existing buttons); fallback into container
    // const toolbar = document.getElementById('incident-toolbar-right');
    // if (toolbar) {
    //     // Check if quality controls already exist to avoid duplicates
    //     if (!toolbar.querySelector(`#${toggleId}`)) {
    //         // Preserve existing buttons (like Configure) and add quality controls
    //         toolbar.insertAdjacentHTML('beforeend', controlsHtml);
    //     }
    // } else {
    //     container.insertAdjacentHTML('afterbegin', `<div class="insight-item-card p-2 mb-2">${controlsHtml}</div>`);
    // }
    
    const riskFlags = new Set(['extraordinary_claim','no_independent_verification','low_factuality_source','low_credibility_source','fringe_bias']);
    
    // Apply filter badges first, then quality filter
    let incidentsToRender = filteredIncidents;
    
    // Compute global timeline range for ruler scaling
    let globalMin = null, globalMax = null;
    incidentsToRender.forEach(inc => {
        if (Array.isArray(inc?.timeline) && inc.timeline.length > 0) {
            const first = new Date(inc.timeline[0]).getTime();
            const last = new Date(inc.timeline[inc.timeline.length - 1]).getTime();
            if (!isNaN(first) && !isNaN(last)) {
                globalMin = (globalMin === null) ? first : Math.min(globalMin, first);
                globalMax = (globalMax === null) ? last : Math.max(globalMax, last);
            }
        }
    });
    if (globalMin !== null && globalMax !== null && globalMax < globalMin) {
        const t = globalMin; globalMin = globalMax; globalMax = t;
    }
    
    // Apply quality filter (hide low quality) on top of badge filters
    const filtered = hideLow
        ? incidentsToRender.filter(inc => {
            if (!inc) return false;
            const plaus = String(inc.plausibility || '').toLowerCase();
            const quality = String(inc.source_quality || '').toLowerCase();
            const flags = Array.isArray(inc.misinfo_flags) ? inc.misinfo_flags.map(f => String(f).toLowerCase()) : [];
            const hasLowFlags = flags.some(f => f === 'low_factuality_source' || f === 'low_credibility_source' || f === 'fringe_bias');
            return plaus !== 'implausible' && quality !== 'low' && !hasLowFlags;
        })
        : incidentsToRender;
    
    // Use the new filtered rendering function
    renderIncidentTrackingFiltered(filteredIncidents);
    return;
    
    // Old rendering code below (kept for reference but not executed)
    if (!filtered || filtered.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No incidents found for this period.</div>';
        return;
    }
    
    filtered.forEach((incident, index) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6 col-lg-4';
        const card = document.createElement('div');
        card.className = 'insight-item-card h-100';
        
        // Determine badge color based on type and significance
        const typeBadgeColor = incident.type === 'incident' ? 'danger' : 
                              incident.type === 'entity' ? 'primary' : 'success';
        const significanceBadgeColor = incident.significance === 'high' ? 'danger' : 
                                     incident.significance === 'medium' ? 'warning' : 'secondary';
        const plausibility = String(incident.plausibility || '').toLowerCase();
        const sourceQuality = String(incident.source_quality || '').toLowerCase();
        const plausibilityBadge = plausibility === 'likely' ? 'success' : plausibility === 'questionable' ? 'warning' : 'danger';
        const sourceQualityBadge = sourceQuality === 'high' ? 'success' : sourceQuality === 'mixed' ? 'warning' : 'danger';
        
        // Build timeline section (supports arrays -> start/end badges + mini ruler)
        let timelineSection = '';
        if (Array.isArray(incident.timeline)) {
            const dates = incident.timeline.filter(Boolean);
            if (dates.length > 0) {
                const start = dates[0];
                const end = dates[dates.length - 1];
                // Ruler positions
                let fillHtml = '';
                if (globalMin !== null && globalMax !== null && globalMax !== globalMin) {
                    const s = new Date(start).getTime();
                    const e = new Date(end).getTime();
                    const startPct = Math.max(0, Math.min(100, ((s - globalMin) / (globalMax - globalMin)) * 100));
                    const endPctRaw = Math.max(0, Math.min(100, ((e - globalMin) / (globalMax - globalMin)) * 100));
                    const endPct = Math.max(startPct + 2, endPctRaw); // ensure visible width
                    fillHtml = `
                        <div style="position:relative;height:6px;background:#eef1f5;border-radius:3px;margin-top:2px;">
                            <div style="position:absolute;left:${startPct}%;width:${endPct - startPct}%;height:100%;background:#b6d4fe;border-radius:3px;"></div>
                            <span style="position:absolute;left:${startPct}%;top:-4px;width:8px;height:8px;background:#0d6efd;border-radius:50%;transform:translateX(-50%);"></span>
                            ${end !== start ? `<span style=\"position:absolute;left:${endPct}%;top:-4px;width:8px;height:8px;background:#0d6efd;border-radius:50%;transform:translateX(-50%);\"></span>` : ''}
                        </div>`;
                }
                timelineSection = `
                    <div class="mb-1 small"><strong>Timeline:</strong>
                        <span class="badge bg-light text-dark border me-1" title="Start">${start}</span>
                        ${end !== start ? `<span class=\"badge bg-light text-dark border me-1\" title=\"End\">${end}</span>` : ''}
                        ${fillHtml}
                    </div>
                `;
            }
        } else {
            const timelineText = (typeof incident.timeline === 'string')
                ? incident.timeline
                : (incident.timeline && (incident.timeline.summary || incident.timeline.text))
                    ? (incident.timeline.summary || incident.timeline.text)
                    : '';
            if (timelineText) {
                timelineSection = `<p class="mb-1 small"><strong>Timeline:</strong> ${timelineText}</p>`;
            }
        }
        
        // Build articles list with MBFC quality indicators
        let articlesHtml = '';
        if (incident.article_uris && incident.article_uris.length > 0) {
            articlesHtml = `
                <div class="mt-2">
                    <small class="text-muted fw-bold">Related Articles (${incident.article_uris.length}):</small>
                    <ul class="list-unstyled mt-1 mb-0 small">
                        ${incident.article_uris.slice(0, 5).map(uri => {
                            const article = window.lastArticlesData?.items?.find(a => a.uri === uri);
                            const derivedTitle = (function(u){
                                try {
                                    const url = new URL(u);
                                    const parts = url.pathname.split('/').filter(Boolean);
                                    const last = parts[parts.length - 1] || '';
                                    const cleaned = decodeURIComponent(last.replace(/[-_]/g, ' ')).trim();
                                    if (cleaned && cleaned.length > 3) return cleaned;
                                } catch(_) {}
                                return 'Article';
                            })(uri);
                            const title = article?.title || derivedTitle;
                            
                            // Add MBFC quality indicators for each article
                            let qualityIndicators = '';
                            if (article) {
                                const qualityBadges = [];
                                if (article.factual_reporting) {
                                    const factualClass = getFactualityClass(article.factual_reporting);
                                    qualityBadges.push(`<span class="badge ${factualClass}" style="font-size: 8px;">${article.factual_reporting}</span>`);
                                }
                                if (article.mbfc_credibility_rating) {
                                    const mbfcClass = getMBFCCredibilityClass(article.mbfc_credibility_rating);
                                    qualityBadges.push(`<span class="badge ${mbfcClass}" style="font-size: 8px;">${article.mbfc_credibility_rating}</span>`);
                                }
                                if (qualityBadges.length > 0) {
                                    qualityIndicators = `<br>${qualityBadges.join(' ')}`;
                                }
                            }
                            
                            return `<li class="mb-1">
                                <a href="${uri}" target="_blank" rel="noopener" class="text-decoration-none">${escapeHTML(title)}</a>
                                ${qualityIndicators}
                            </li>`;
                        }).join('')}
                        ${incident.article_uris.length > 5 ? `<li class="text-muted">... and ${incident.article_uris.length - 5} more</li>` : ''}
                    </ul>
                </div>
            `;
        }
        
        // Build investigation leads as clickable Auspex research buttons
        let leadsHtml = '';
        if (incident.investigation_leads && incident.investigation_leads.length > 0) {
            leadsHtml = `
                <div class="mt-2">
                    <small class="text-muted fw-bold">Leads:</small>
                    <div class="d-flex gap-1 flex-wrap mt-1" style="max-width: 100%; overflow: hidden; word-break: break-word;">
                        ${incident.investigation_leads.map(lead => `
                            <button class="btn btn-outline-primary btn-sm"
                                    onclick="launchAuspexResearchFromInsight('${escapeHTML(lead)}', 'investigation_lead')"
                                    title="Launch Auspex research on: ${escapeHTML(lead)}"
                                    style="font-size: 10px; padding: 2px 6px; border-radius: 12px; max-width: 100%; text-overflow: ellipsis; overflow: hidden;">
                                <i class="fas fa-search me-1"></i>${escapeHTML(lead.length > 20 ? lead.substring(0, 20) + '...' : lead)}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Risk warnings and devil's advocate
        const flags = Array.isArray(incident.misinfo_flags) ? incident.misinfo_flags : [];
        const highRisk = flags.filter(f => riskFlags.has(String(f)));
        const prettyFlag = (f) => {
            switch (String(f)) {
                case 'extraordinary_claim': return 'Extraordinary claim';
                case 'no_independent_verification': return 'No independent verification';
                case 'low_factuality_source': return 'Check Source';
                case 'low_credibility_source': return 'Check Source (credibility)';
                case 'fringe_bias': return 'Fringe bias';
                default: return String(f).replace(/_/g, ' ');
            }
        };
        const warningHtml = highRisk.length > 0 ? `
            <div class="alert alert-danger py-1 px-2 small mt-2 mb-1">
                <strong>Potential misinformation risk:</strong> ${highRisk.map(prettyFlag).join(', ')}
            </div>
        ` : '';
        const devilsAdvocate = highRisk.includes('extraordinary_claim') ? "<span class=\"badge bg-danger\" title=\"Devil's advocate smell test\">Hyperbolic Claim</span>" : '';
        const credibilitySummary = incident.credibility_summary ? `<small class="text-muted d-block">${incident.credibility_summary}</small>` : '';

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 ${incident.significance === 'high' ? 'text-danger' : 'text-primary'}">${incident.name}</h6>
                <div class="d-flex flex-wrap gap-1 align-items-center text-end">
                    <span class="badge bg-${typeBadgeColor}" title="Type">${incident.type.toUpperCase()}</span>
                    <span class="badge bg-${significanceBadgeColor}" title="Significance">${incident.significance.toUpperCase()}</span>
                    ${plausibility ? `<span class="badge bg-${plausibilityBadge}" title="Plausibility">Plausibility: ${plausibility.toUpperCase()}</span>` : ''}
                    ${sourceQuality ? `<span class="badge bg-${sourceQualityBadge}" title="Source Quality">Source: ${sourceQuality.toUpperCase()}</span>` : ''}
                    ${devilsAdvocate}
                </div>
            </div>
            <p class="mb-1 small">${incident.description}</p>
            ${incident.organizational_relevance ? `
            <div class="alert alert-info py-2 mb-2">
                <small><strong><i class="fas fa-building me-1"></i>Why This Matters to Your Organization:</strong> ${incident.organizational_relevance}</small>
            </div>` : ''}
            ${timelineSection}
            ${credibilitySummary}
            ${warningHtml}
            ${articlesHtml}
            ${leadsHtml}
            <!-- Detailed Analysis Section (Initially Hidden) -->
            <div class="incident-analysis" id="incident-analysis-${escapeHTML(incident.name).replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-top: 15px; padding: 15px; background: var(--colors-neutral-2); border-radius: 8px; border-left: 4px solid var(--colors-info-5);">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-search-plus me-2"></i>Article Analysis
                </h6>
                <div class="analysis-content bg-white p-3 rounded border" id="incident-article-analysis-${escapeHTML(incident.name).replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="analysis-text bg-light p-2 rounded small text-muted">
                        Analysis will be generated when you click "Show Analysis" below.
                    </div>
                </div>
            </div>
            
            <div class="mt-2">
                <!-- Analysis Tools -->
                <div class="mb-2">
                    <small class="text-muted fw-bold d-block mb-1">Analysis</small>
                    <div class="d-flex flex-wrap gap-1">
                        ${incident.article_uris && incident.article_uris.length > 0 ? `
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleIncidentAnalysis('${escapeHTML(incident.name)}', '${incident.article_uris[0]}', this)" title="Show Analysis">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="launchIncidentDeepDive('${escapeHTML(incident.name)}', '${incident.article_uris[0]}')" title="Deep Dive">
                                <i class="fas fa-microscope"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="launchIncidentConsensus('${escapeHTML(incident.name)}', '${incident.article_uris[0]}')" title="Consensus Check">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="launchIncidentAdjacent('${escapeHTML(incident.name)}', '${incident.article_uris[0]}')" title="Adjacent Topics">
                                <i class="fas fa-project-diagram"></i>
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(incident.name)}', 'incident')" title="Investigate">
                                <i class="fas fa-search"></i>
                            </button>
                        `}
                    </div>
                </div>

                <!-- Admin Actions -->
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold d-block mb-1">Actions</small>
                        <div class="d-flex flex-wrap gap-1">
                            ${incident.article_uris && incident.article_uris.length > 0 ? `
                                <button class="btn btn-sm btn-outline-success" onclick="openAnnotationModal('${incident.article_uris[0]}')" title="Annotate">
                                    <i class="fas fa-sticky-note"></i>
                                </button>
                            ` : ''}
                            ${status !== 'seen' ? `
                                <button class="btn btn-sm btn-outline-info" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'seen')" title="Mark as seen">
                                    <i class="fas fa-eye"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'active')" title="Mark as unseen">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                            `}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteIncident('${escapeHTML(incident.name)}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        col.appendChild(card);
        container.appendChild(col);
    });

    // Wire up toggles (moved to after rendering)
    setTimeout(() => {
        // Quality toggle
        const toggleEl = document.getElementById(toggleId);
        if (toggleEl && !toggleEl.dataset.wired) {
            toggleEl.addEventListener('change', () => {
                try { localStorage.setItem(toggleId, toggleEl.checked ? 'true' : 'false'); } catch(_) {}
                // Re-render with current filters
                const filteredIncidents = applyIncidentFilters(allIncidents);
                renderIncidentTrackingFiltered(filteredIncidents);
            });
            toggleEl.dataset.wired = 'true';
        }

    }, 100);
}

// ===== ENHANCED TAB NAVIGATION =====

// Add to existing insights tab navigation handlers:
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    // Add handlers for new tabs
    document.getElementById('incident-tracking-nav')?.addEventListener('click', function() {
        // Don't auto-load - wait for Generate Insights button
        const container = document.getElementById('incident-tracking-container');
        if (container && !container.querySelector('.insight-item-card')) {
            // Show helpful message instead of auto-loading
            container.innerHTML = `
                <div class="text-center p-4 w-100">
                    <i class="fas fa-crosshairs fa-3x text-muted mb-3"></i>
                    <h5>Incident Tracking</h5>
                    <p class="text-muted">Click "Generate Insights" to track specific incidents, entities, and events for threat hunting.</p>
                </div>
            `;
        }
    });

    document.getElementById('realtime-signals-nav')?.addEventListener('click', function() {
        loadSignalInstructions();
    });
});

// ===== ENHANCED GENERATE INSIGHTS FUNCTION =====

async function generateInsights(forceRegenerate = false) {
    console.log('Generate insights button clicked', forceRegenerate ? '(force regenerate)' : '');

    // Get selected topics (multi-select)
    const selectedTopics = getSelectedTopics();
    if (selectedTopics.length === 0) {
        showNotification('Please select at least one topic to generate insights', 'warning');
        return;
    }

    // Get current date range parameters
    const dateRangeValue = document.getElementById('date-range-select').value;
    let startDate = null;
    let endDate = null;
    let daysLimit = 30;

    if (dateRangeValue === 'custom') {
        const customDate = document.getElementById('custom-date-input').value || document.getElementById('selected-date').value;
        if (customDate) {
            startDate = customDate;
            endDate = customDate;
        }
    } else if (dateRangeValue !== 'all') {
        // Calculate date range based on selection
        const now = new Date();
        endDate = now.toISOString().split('T')[0];

        switch (dateRangeValue) {
            case '24h': daysLimit = 1; break;
            case '7d': daysLimit = 7; break;
            case '30d': daysLimit = 30; break;
            case '3m': daysLimit = 90; break;
            case '1y': daysLimit = 365; break;
        }

        const startDateObj = new Date(now.getTime() - daysLimit * 24 * 60 * 60 * 1000);
        startDate = startDateObj.toISOString().split('T')[0];
    }

    const topicsDisplay = selectedTopics.join(', ');
    console.log('Loading insights for topics:', topicsDisplay, 'date range:', startDate, 'to', endDate, 'days:', daysLimit);

    // Save selected topics to localStorage
    try {
        localStorage.setItem('newsFeedTopics', JSON.stringify(selectedTopics));
    } catch (e) {
        console.error('Error saving topics to localStorage:', e);
    }

    // Load all insights including incident tracking
    await Promise.all([
        loadArticleInsights(selectedTopics, startDate, endDate, daysLimit, forceRegenerate),
        loadCategoryInsights(selectedTopics, startDate, endDate, daysLimit, forceRegenerate),
        loadIncidentTracking(selectedTopics, startDate, endDate, daysLimit, forceRegenerate)
    ]);

    // After generating insights, update cache state and button
    await checkInsightsCache();
    updateInsightsButton();

    // Show save/export buttons for insights
    showInsightsSaveButtons();

    showNotification(`Insights generated for ${selectedTopics.length} topic(s)!`, 'success');
}
// Add this function to your JavaScript section:

async function analyzeRealTimeSignals() {
    const loadingEl = document.getElementById('realtime-signals-loading');
    const errorEl = document.getElementById('realtime-signals-error');
    const containerEl = document.getElementById('realtime-signals-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        const topicSelect = document.getElementById('topic-select');
        const selectedTopic = topicSelect ? (topicSelect.value || '').trim() : '';
        if (!selectedTopic) {
            errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>Select a topic to analyze signals.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Get the selected model from feed configuration
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';

        // Build request for signal analysis
        const drSel = document.getElementById('date-range-select');
        const drVal = drSel ? drSel.value : '7d'; // Default to 7 days for signals
        
        let requestBody = {
            topic: selectedTopic,
            max_articles: 50,
            model: selectedModel,
            force_regenerate: true  // Always force regenerate for real-time signals
        };
        
        switch (drVal) {
            case '24h': requestBody.days_limit = 1; break;
            case '7d': requestBody.days_limit = 7; break;
            case '30d': requestBody.days_limit = 30; break;
            case 'custom':
                const customDate = document.getElementById('custom-date-input')?.value || document.getElementById('selected-date')?.value;
                if (customDate) {
                    requestBody.start_date = customDate;
                    requestBody.end_date = customDate;
                } else {
                    requestBody.days_limit = 7;
                }
                break;
            default:
                requestBody.days_limit = 7;
        }
        
        const response = await fetch('/api/real-time-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.signals || data.signals.length === 0) {
            const message = data.message || 'No signals detected';
            errorEl.innerHTML = `<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>${message}</div>`;
            errorEl.style.display = 'block';
            return;
        }
        
        renderRealTimeSignals(data);
        
    } catch (error) {
        console.error('Error analyzing real-time signals:', error);
        errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Failed to analyze signals: ${error.message}</div>`;
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function renderRealTimeSignals(data) {
    const container = document.getElementById('realtime-signals-container');
    container.innerHTML = '';
    
    if (!data.signals || data.signals.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No signals detected for this period.</div>';
        return;
    }
    
    // Add summary header
    const detectedCount = data.signals.filter(s => s.signal_detected).length;
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'alert alert-info mb-3';
    summaryDiv.innerHTML = `
        <h6><i class="fas fa-radar me-2"></i>Signal Analysis Results</h6>
        <p class="mb-1">Analyzed ${data.total_articles} articles with ${data.instructions_used} signal instructions</p>
        <p class="mb-0"><strong>${detectedCount} of ${data.signals.length} signals detected</strong></p>
    `;
    container.appendChild(summaryDiv);
    
    data.signals.forEach((signal, index) => {
        const card = document.createElement('div');
        card.className = 'insight-item-card';
        
        if (signal.signal_detected) {
            card.style.borderLeft = '4px solid var(--colors-error-9)'; // Red border for detected signals
        }
        
        const threatBadgeColor = signal.threat_level === 'high' ? 'danger' : 
                               signal.threat_level === 'medium' ? 'warning' : 'success';
        
        // Build matching articles list
        let articlesHtml = '';
        if (signal.matching_articles && signal.matching_articles.length > 0) {
            articlesHtml = `
                <div class="mt-2">
                    <small class="text-muted fw-bold">Matching Articles (${signal.matching_articles.length}):</small>
                    <ul class="list-unstyled mt-1 mb-0 small">
                        ${signal.matching_articles.slice(0, 3).map(uri => {
                            const article = window.lastArticlesData?.items?.find(a => a.uri === uri);
                            if (article) {
                                return `<li class="mb-1"><a href="${uri}" target="_blank" rel="noopener">${article.title}</a></li>`;
                            }
                            return `<li class="mb-1"><a href="${uri}" target="_blank" rel="noopener">View Article</a></li>`;
                        }).join('')}
                        ${signal.matching_articles.length > 3 ? `<li class="text-muted">... and ${signal.matching_articles.length - 3} more</li>` : ''}
                    </ul>
                </div>
            `;
        }

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 ${signal.signal_detected ? 'text-danger' : 'text-muted'}">${signal.instruction_name}</h6>
                <div class="d-flex gap-1">
                    ${signal.signal_detected ? '<span class="badge bg-danger">DETECTED</span>' : '<span class="badge bg-secondary">Clear</span>'}
                    <span class="badge bg-${threatBadgeColor}">${signal.threat_level?.toUpperCase() || 'UNKNOWN'}</span>
                    <span class="badge bg-info">${Math.round((signal.confidence || 0) * 100)}%</span>
                </div>
            </div>
            <p class="mb-1 small">${signal.summary || 'No summary available'}</p>
            ${signal.recommended_action ? `<p class="mb-1 small"><strong>Recommended Action:</strong> ${signal.recommended_action}</p>` : ''}
            ${articlesHtml}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(signal.instruction_name)}', 'signal_investigation')">
                    <i class="fas fa-search me-1"></i>Deep Dive
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

// ===== CACHE MANAGEMENT FUNCTIONS =====

function clearRealTimeSignalsCache() {
    // This function clears any cached real-time signals when instructions change
    const container = document.getElementById('realtime-signals-container');
    if (container) {
        container.innerHTML = `
            <div class="text-center p-4 w-100">
                <i class="fas fa-radar fa-3x text-muted mb-3"></i>
                <h5>Real-time Signals</h5>
                <p class="text-muted">Signal instructions updated. Click "Analyze Signals" to run analysis with new instructions.</p>
            </div>
        `;
    }
}

// ===== REAL-TIME SIGNALS ANALYSIS FUNCTIONS =====

async function analyzeRealTimeSignals() {
    const loadingEl = document.getElementById('realtime-signals-loading');
    const errorEl = document.getElementById('realtime-signals-error');
    const containerEl = document.getElementById('realtime-signals-container');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        const topicSelect = document.getElementById('topic-select');
        const selectedTopic = topicSelect ? (topicSelect.value || '').trim() : '';
        if (!selectedTopic) {
            errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>Select a topic to analyze signals.</div>`;
            errorEl.style.display = 'block';
            return;
        }

        // Get the selected model from feed configuration
        const modelSelect = document.getElementById('model-select');
        const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';

        // Build request for signal analysis
        const drSel = document.getElementById('date-range-select');
        const drVal = drSel ? drSel.value : '7d';
        
        let requestBody = {
            topic: selectedTopic,
            max_articles: 50,
            model: selectedModel
        };
        
        switch (drVal) {
            case '24h': requestBody.days_limit = 1; break;
            case '7d': requestBody.days_limit = 7; break;
            case '30d': requestBody.days_limit = 30; break;
            case 'custom':
                const customDate = document.getElementById('custom-date-input')?.value || document.getElementById('selected-date')?.value;
                if (customDate) {
                    requestBody.start_date = customDate;
                    requestBody.end_date = customDate;
                } else {
                    requestBody.days_limit = 7;
                }
                break;
            default:
                requestBody.days_limit = 7;
        }
        
        const response = await fetch('/api/real-time-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.signals || data.signals.length === 0) {
            const message = data.message || 'No signals detected';
            errorEl.innerHTML = `<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>${message}</div>`;
            errorEl.style.display = 'block';
            return;
        }
        
        renderRealTimeSignals(data);
        
    } catch (error) {
        console.error('Error analyzing real-time signals:', error);
        errorEl.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Failed to analyze signals: ${error.message}</div>`;
        errorEl.style.display = 'block';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function renderRealTimeSignals(data) {
    const container = document.getElementById('realtime-signals-container');
    container.innerHTML = '';
    
    if (!data.signals || data.signals.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No signals detected for this period.</div>';
        return;
    }
    
    // Add summary header
    const detectedCount = data.signals.filter(s => s.signal_detected).length;
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'alert alert-info mb-3';
    summaryDiv.innerHTML = `
        <h6><i class="fas fa-radar me-2"></i>Signal Analysis Results</h6>
        <p class="mb-1">Analyzed ${data.total_articles} articles with ${data.instructions_used} signal instructions</p>
        <p class="mb-0"><strong>${detectedCount} of ${data.signals.length} signals detected</strong></p>
    `;
    container.appendChild(summaryDiv);
    
    data.signals.forEach((signal, index) => {
        const card = document.createElement('div');
        card.className = 'insight-item-card';
        
        if (signal.signal_detected) {
            card.style.borderLeft = '4px solid var(--colors-error-9)'; // Red border for detected signals
        }
        
        const threatBadgeColor = signal.threat_level === 'high' ? 'danger' : 
                               signal.threat_level === 'medium' ? 'warning' : 'success';
        
        // Build matching articles list
        let articlesHtml = '';
        if (signal.matching_articles && signal.matching_articles.length > 0) {
            articlesHtml = `
                <div class="mt-2">
                    <small class="text-muted fw-bold">Matching Articles (${signal.matching_articles.length}):</small>
                    <ul class="list-unstyled mt-1 mb-0 small">
                        ${signal.matching_articles.slice(0, 3).map(uri => {
                            const article = window.lastArticlesData?.items?.find(a => a.uri === uri);
                            if (article) {
                                return `<li class="mb-1"><a href="${uri}" target="_blank" rel="noopener">${article.title}</a></li>`;
                            }
                            return `<li class="mb-1"><a href="${uri}" target="_blank" rel="noopener">View Article</a></li>`;
                        }).join('')}
                        ${signal.matching_articles.length > 3 ? `<li class="text-muted">... and ${signal.matching_articles.length - 3} more</li>` : ''}
                    </ul>
                </div>
            `;
        }

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 ${signal.signal_detected ? 'text-danger' : 'text-muted'}">${signal.instruction_name}</h6>
                <div class="d-flex gap-1">
                    ${signal.signal_detected ? '<span class="badge bg-danger">DETECTED</span>' : '<span class="badge bg-secondary">Clear</span>'}
                    <span class="badge bg-${threatBadgeColor}">${signal.threat_level?.toUpperCase() || 'UNKNOWN'}</span>
                    <span class="badge bg-info">${Math.round((signal.confidence || 0) * 100)}%</span>
                </div>
            </div>
            <p class="mb-1 small">${signal.summary || 'No summary available'}</p>
            ${signal.recommended_action ? `<p class="mb-1 small"><strong>Recommended Action:</strong> ${signal.recommended_action}</p>` : ''}
            ${articlesHtml}
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(signal.instruction_name)}', 'signal_investigation')">
                    <i class="fas fa-search me-1"></i>Deep Dive
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

// ===== SIGNAL FLAGS FOR ARTICLES =====

function addSignalFlagsToArticles(articles) {
    // Add signal flag badges to articles after they're rendered
    articles.forEach(article => {
        const flagsContainer = document.getElementById(`signal-flags-${article.uri.replace(/[^a-zA-Z0-9]/g, '_')}`);
        if (flagsContainer && article.tags) {
            let tags = [];
            if (Array.isArray(article.tags)) {
                tags = article.tags;
            } else if (typeof article.tags === 'string') {
                tags = article.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            }
            
            const signalTags = tags.filter(tag => tag.startsWith('signal:'));
            if (signalTags.length > 0) {
                const signalBadges = signalTags.map(tag => {
                    const signalName = tag.replace('signal:SIGNAL_', '').replace(/_/g, ' ');
                    return `<span class="badge bg-danger text-white ms-1" style="font-size: 8px;" title="Flagged by signal: ${escapeHTML(signalName)}"><i class="fas fa-flag me-1"></i>${escapeHTML(signalName)}</span>`;
                }).join('');
                flagsContainer.innerHTML = signalBadges;
            }
        }
    });
}

// ===== SIGNAL TOPIC MANAGEMENT =====

function handleSignalTopicChange() {
    // Reload signal instructions when topic changes
    loadSignalInstructions();
    
    // Update article count for new topic
    updateSignalArticleCount();
    
    // Clear alerts since we're changing topic context
    const container = document.getElementById('signal-alerts-list');
    if (container) {
        container.innerHTML = `
            <div class="text-center p-3 text-muted">
                <i class="fas fa-info-circle me-2"></i>Topic changed. Run signal instructions to generate alerts for this topic.
            </div>
        `;
    }
}

function handleSignalConfigChange() {
    // Update article count when date range changes
    updateSignalArticleCount();
}

async function updateSignalArticleCount() {
    try {
        const signalTopicSelect = document.getElementById('signal-topic-select');
        const signalDaysSelect = document.getElementById('signal-days-select');
        const countBadge = document.getElementById('signal-article-count');
        
        const selectedTopic = signalTopicSelect ? signalTopicSelect.value : null;
        const daysBack = signalDaysSelect ? parseInt(signalDaysSelect.value) : 7;
        
        if (!countBadge) return;
        
        countBadge.textContent = 'loading...';
        
        // Calculate date range
        const endDate = new Date();
        const startDate = new Date(endDate.getTime() - daysBack * 24 * 60 * 60 * 1000);
        
        // Use the debug endpoint to get article count
        const params = new URLSearchParams();
        if (selectedTopic) {
            params.append('topic', selectedTopic);
        }
        
        const response = await fetch(`/api/debug-articles?${params}`);
        if (response.ok) {
            const data = await response.json();
            const totalArticles = data.date_range_info?.total_articles || 0;
            countBadge.textContent = `${totalArticles} articles`;
            countBadge.className = totalArticles > 0 ? 'badge bg-success text-white' : 'badge bg-warning text-dark';
        } else {
            countBadge.textContent = '? articles';
            countBadge.className = 'badge bg-secondary';
        }
        
    } catch (error) {
        console.error('Error updating signal article count:', error);
        const countBadge = document.getElementById('signal-article-count');
        if (countBadge) {
            countBadge.textContent = 'error';
            countBadge.className = 'badge bg-danger';
        }
    }
}

async function loadTopicsForSignals() {
    try {
        const response = await fetch('/api/topics');
        const topics = await response.json();
        
        const signalTopicSelect = document.getElementById('signal-topic-select');
        const signalModalSelect = document.getElementById('signalTopic');
        
        if (signalTopicSelect && topics) {
            const currentValue = signalTopicSelect.value;
            signalTopicSelect.innerHTML = '<option value="">All Topics</option>' +
                topics.map(t => `<option value="${t.name.trim()}">${t.name.trim()}</option>`).join('');
            signalTopicSelect.value = currentValue; // Restore selection
        }

        if (signalModalSelect && topics) {
            const currentValue = signalModalSelect.value;
            signalModalSelect.innerHTML = '<option value="">All Topics (Global Signal)</option>' +
                topics.map(t => `<option value="${t.name.trim()}">${t.name.trim()}</option>`).join('');
            signalModalSelect.value = currentValue; // Restore selection
        }
        
    } catch (error) {
        console.error('Error loading topics for signals:', error);
    }
}

// ===== INDEPENDENT SIGNAL RUNNER FUNCTIONS =====

async function runSingleSignal(instructionId) {
    // Use the signal topic selector for more targeted analysis
    const signalTopicSelect = document.getElementById('signal-topic-select');
    const selectedTopic = signalTopicSelect ? signalTopicSelect.value : null;
    const signalDaysSelect = document.getElementById('signal-days-select');
    const daysBack = signalDaysSelect ? parseInt(signalDaysSelect.value) : 7;
    const modelSelect = document.getElementById('model-select');
    const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
    
    try {
        showNotification(`Running signal instruction for last ${daysBack} days...`, 'info');
        
        const response = await fetch('/api/run-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                instruction_ids: [instructionId],
                topic: selectedTopic,
                days_back: daysBack,
                max_articles: 100,
                model: selectedModel,
                tag_flagged_articles: true
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`Signal run complete: ${result.total_matches} matches found`, 'success');
            loadSignalAlerts(); // Refresh alerts dashboard
        } else {
            showNotification(`Signal run failed: ${result.message}`, 'warning');
        }
        
    } catch (error) {
        console.error('Error running single signal:', error);
        showNotification(`Failed to run signal: ${error.message}`, 'error');
    }
}

async function runAllSignals() {
    // Use the signal topic selector for more targeted analysis
    const signalTopicSelect = document.getElementById('signal-topic-select');
    const selectedTopic = signalTopicSelect ? signalTopicSelect.value : null;
    const signalDaysSelect = document.getElementById('signal-days-select');
    const daysBack = signalDaysSelect ? parseInt(signalDaysSelect.value) : 7;
    const modelSelect = document.getElementById('model-select');
    const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o-mini';
    
    try {
        // Get all active instructions first
        const params = new URLSearchParams();
        if (selectedTopic) {
            params.append('topic', selectedTopic);
        }
        params.append('active_only', 'true');
        
        const instructionsResponse = await fetch(`/api/signal-instructions?${params}`);
        if (!instructionsResponse.ok) {
            throw new Error('Failed to get signal instructions');
        }
        
        const instructionsData = await instructionsResponse.json();
        
        if (!instructionsData.instructions || instructionsData.instructions.length === 0) {
            showNotification(`No active signal instructions found for ${selectedTopic || 'all topics'}`, 'warning');
            return;
        }
        
        const instructionIds = instructionsData.instructions.map(inst => inst.id);
        
        showNotification(`Running ${instructionIds.length} signal instructions for last ${daysBack} days...`, 'info');
        
        const response = await fetch('/api/run-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                instruction_ids: instructionIds,
                topic: selectedTopic,
                days_back: daysBack,
                max_articles: 100,
                model: selectedModel,
                tag_flagged_articles: true
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`All signals run complete: ${result.total_matches} total matches found`, 'success');
            loadSignalAlerts(); // Refresh alerts dashboard
        } else {
            showNotification(`Signal run failed: ${result.message}`, 'warning');
        }
        
    } catch (error) {
        console.error('Error running all signals:', error);
        showNotification(`Failed to run signals: ${error.message}`, 'error');
    }
}

// Pagination variables for alerts
let currentAlertsPage = 1;
const alertsPerPage = 10;

// Alert filtering
let alertFilters = {
    instructions: new Set(),
    threatLevels: new Set()
};
let allAlerts = []; // Store all alerts for filtering

// Incident filtering
let incidentFilters = {
    types: new Set(),
    significance: new Set(),
    status: new Set()
};
let allIncidents = []; // Store all incidents for filtering

// Entity grouping function
function groupIncidentsByEntity(incidents) {
    if (!incidents || incidents.length === 0) return [];

    const entityGroups = new Map();

    incidents.forEach(incident => {
        const entityName = extractPrimaryEntity(incident);

        if (!entityGroups.has(entityName)) {
            entityGroups.set(entityName, {
                entityName: entityName,
                incidents: [],
                totalArticles: 0,
                maxSignificance: 'low',
                timelineRange: null
            });
        }

        const group = entityGroups.get(entityName);
        group.incidents.push(incident);

        // Update group metadata
        if (incident.article_uris) {
            group.totalArticles += incident.article_uris.length;
        }

        // Track highest significance
        if (incident.significance === 'high' ||
            (incident.significance === 'medium' && group.maxSignificance === 'low')) {
            group.maxSignificance = incident.significance;
        }

        // Track timeline range
        if (Array.isArray(incident.timeline) && incident.timeline.length > 0) {
            const startDate = new Date(incident.timeline[0]);
            const endDate = new Date(incident.timeline[incident.timeline.length - 1]);

            if (!group.timelineRange) {
                group.timelineRange = { start: startDate, end: endDate };
            } else {
                if (startDate < group.timelineRange.start) group.timelineRange.start = startDate;
                if (endDate > group.timelineRange.end) group.timelineRange.end = endDate;
            }
        }
    });

    // Convert to array and sort by significance and incident count
    return Array.from(entityGroups.values()).sort((a, b) => {
        // Sort by significance first
        const sigOrder = { 'high': 3, 'medium': 2, 'low': 1 };
        const sigDiff = sigOrder[b.maxSignificance] - sigOrder[a.maxSignificance];
        if (sigDiff !== 0) return sigDiff;

        // Then by number of incidents
        return b.incidents.length - a.incidents.length;
    });
}

function extractPrimaryEntity(incident) {
    if (!incident) return 'Unknown Entity';

    // Try to extract from related_entities first
    if (Array.isArray(incident.related_entities) && incident.related_entities.length > 0) {
        console.log('Entity from related_entities:', incident.related_entities[0]);
        return incident.related_entities[0];
    }

    // Extract from incident name using common patterns
    const name = incident.name || '';
    console.log('Extracting entity from name:', name);

    // Enhanced entity patterns to extract - more comprehensive
    const entityPatterns = [
        /(Tesla|OpenAI|Microsoft|Google|Amazon|Apple|Meta|Netflix|Uber|SpaceX|Elon\s+Musk|ChatGPT|X\.com)/i,  // Known entities - expanded
        /^([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:launches|announces|reports|develops|releases|faces|customers|caught|fires?|sues?|delivers?)/i,  // Company action patterns
        /([A-Z][A-Za-z]+)(?:'s|\s+(?:CEO|CFO|CTO|executives?|shareholders?|Megapacks?))/i,  // Possessive or related patterns
        /^([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+/,  // Any capitalized words at start
    ];

    for (const pattern of entityPatterns) {
        const match = name.match(pattern);
        if (match && match[1]) {
            const entity = match[1].trim();
            console.log('Extracted entity:', entity, 'from pattern:', pattern);
            return entity;
        }
    }

    // Fallback: use first significant word that looks like a company name
    const words = name.split(/\s+/).filter(word =>
        word.length > 2 &&
        word[0] === word[0].toUpperCase() &&
        !['The', 'And', 'For', 'With', 'From', 'Two', 'Three'].includes(word)
    );

    const entity = words[0] || 'Other';
    console.log('Fallback entity:', entity, 'from words:', words);
    return entity;
}

async function loadSignalAlerts(page = 1) {
    currentAlertsPage = page;
    
    try {
        const params = new URLSearchParams();
        // Don't filter by topic for now to see all alerts
        params.append('acknowledged', 'false'); // Show unacknowledged alerts by default
        params.append('limit', '50'); // Reasonable limit
        
        console.log('Loading signal alerts with params:', params.toString());
        
        const response = await fetch(`/api/signal-alerts?${params}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Signal alerts response:', data);
        
        const container = document.getElementById('signal-alerts-list');
        
        console.log('Alerts data structure:', data);
        console.log('Alerts array:', data.alerts);
        console.log('Alerts length:', data.alerts ? data.alerts.length : 'undefined');
        
        if (!data.alerts || data.alerts.length === 0) {
            console.log('No alerts found - showing empty message');
            container.innerHTML = `
                <div class="text-center p-3 text-muted">
                    <i class="fas fa-info-circle me-2"></i>No unacknowledged alerts. Run signal instructions to generate alerts.
                    <br><small>Debug: API returned ${data.total || 0} alerts</small>
                </div>
            `;
            // Hide filter section when no alerts
            document.getElementById('signal-alert-filters').style.display = 'none';
            return;
        }
        
        // Store all alerts for filtering
        allAlerts = data.alerts;
        
        // Build filter badges
        buildAlertFilterBadges(data.alerts);
        
        // Apply current filters
        const filteredAlerts = applyAlertFilters(data.alerts);
        
        console.log('Rendering', filteredAlerts.length, 'filtered alerts out of', data.alerts.length, 'total');
        
        // Implement pagination on filtered alerts
        const totalAlerts = filteredAlerts.length;
        const totalPages = Math.ceil(totalAlerts / alertsPerPage);
        const start = (currentAlertsPage - 1) * alertsPerPage;
        const end = start + alertsPerPage;
        const pageAlerts = filteredAlerts.slice(start, end);
        
        // Update pagination info
        document.getElementById('alerts-start').textContent = totalAlerts > 0 ? start + 1 : 0;
        document.getElementById('alerts-end').textContent = Math.min(end, totalAlerts);
        document.getElementById('alerts-total').textContent = totalAlerts;
        document.getElementById('current-alerts-page').textContent = currentAlertsPage;
        document.getElementById('total-alerts-pages').textContent = totalPages;
        
        // Update button states
        document.getElementById('prev-alerts-btn').disabled = currentAlertsPage <= 1;
        document.getElementById('next-alerts-btn').disabled = currentAlertsPage >= totalPages;
        
        // Show/hide pagination
        const paginationContainer = document.getElementById('signal-alerts-pagination');
        if (paginationContainer) {
            paginationContainer.style.display = totalAlerts > alertsPerPage ? 'flex' : 'none';
        }
        
        let html = '';
        pageAlerts.forEach(alert => {
            const threatBadgeColor = alert.threat_level === 'high' ? 'danger' : 
                                   alert.threat_level === 'medium' ? 'warning' : 'success';
            
            const detectedTime = new Date(alert.detected_at).toLocaleString();
            
            html += `
                <div class="card mb-2 ${alert.threat_level === 'high' ? 'border-danger' : ''}">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <h6 class="mb-0 me-2">${escapeHTML(alert.instruction_name)}</h6>
                                    <span class="badge bg-${threatBadgeColor}">${alert.threat_level.toUpperCase()}</span>
                                    <span class="badge bg-info ms-1">${Math.round(alert.confidence * 100)}%</span>
                                </div>
                                <p class="mb-1 small">${escapeHTML(alert.summary)}</p>
                                <div class="small text-muted">
                                    <strong>Article:</strong> 
                                    <a href="${alert.article_uri}" target="_blank" rel="noopener">
                                        ${(() => { try { if (alert.article_title) return escapeHTML(alert.article_title); const u = new URL(alert.article_uri); const last = decodeURIComponent((u.pathname.split('/').filter(Boolean).pop()||'').replace(/[-_]/g,' ')).trim(); return escapeHTML(last || 'Article'); } catch(_) { return 'Article'; } })()}
                                    </a>
                                    <span class="ms-2">â€¢ ${formatSource(alert.article_source, alert.article_uri)}</span>
                                    <span class="ms-2">â€¢ ${detectedTime}</span>
                                </div>
                            </div>
                            <div class="btn-group-vertical btn-group-sm ms-2">
                                <button class="btn btn-outline-success btn-sm" onclick="acknowledgeAlert(${alert.id})" title="Acknowledge">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading signal alerts:', error);
        const container = document.getElementById('signal-alerts-list');
        container.innerHTML = `<div class="alert alert-danger">Failed to load signal alerts: ${error.message}</div>`;
    }
}

async function acknowledgeAlert(alertId) {
    try {
        const response = await fetch(`/api/acknowledge-alert/${alertId}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        loadSignalAlerts(); // Refresh alerts
        showNotification('Alert acknowledged', 'success');
        
    } catch (error) {
        console.error('Error acknowledging alert:', error);
        showNotification(`Failed to acknowledge alert: ${error.message}`, 'error');
    }
}

async function acknowledgeAllAlerts() {
    if (!confirm('Mark all alerts as acknowledged?')) {
        return;
    }
    
    try {
        // Get current alerts and acknowledge each one
        const topicSelect = document.getElementById('topic-select');
        const currentTopic = topicSelect ? topicSelect.value : null;
        
        const params = new URLSearchParams();
        if (currentTopic) {
            params.append('topic', currentTopic);
        }
        params.append('acknowledged', 'false');
        
        const alertsResponse = await fetch(`/api/signal-alerts?${params}`);
        if (!alertsResponse.ok) {
            throw new Error('Failed to get alerts');
        }
        
        const alertsData = await alertsResponse.json();
        
        if (alertsData.alerts && alertsData.alerts.length > 0) {
            // Acknowledge each alert
            const acknowledgePromises = alertsData.alerts.map(alert => 
                fetch(`/api/acknowledge-alert/${alert.id}`, { method: 'POST' })
            );
            
            await Promise.all(acknowledgePromises);
            
            loadSignalAlerts(); // Refresh alerts
            showNotification(`${alertsData.alerts.length} alerts acknowledged`, 'success');
        } else {
            showNotification('No alerts to acknowledge', 'info');
        }
        
    } catch (error) {
        console.error('Error acknowledging all alerts:', error);
        showNotification(`Failed to acknowledge alerts: ${error.message}`, 'error');
    }
}

function previousAlertsPage() {
    if (currentAlertsPage > 1) {
        loadSignalAlerts(currentAlertsPage - 1);
    }
}

function nextAlertsPage() {
    const totalPages = Math.ceil(document.getElementById('alerts-total').textContent / alertsPerPage);
    if (currentAlertsPage < totalPages) {
        loadSignalAlerts(currentAlertsPage + 1);
    }
}

// Alert filter functions
function buildAlertFilterBadges(alerts) {
    // Collect unique values
    const instructionNames = new Set();
    const threatLevels = new Set();
    
    alerts.forEach(alert => {
        if (alert.instruction_name) instructionNames.add(alert.instruction_name);
        if (alert.threat_level) threatLevels.add(alert.threat_level);
    });
    
    // Build instruction filter badges
    const instructionContainer = document.getElementById('instruction-filters');
    instructionContainer.innerHTML = '';
    instructionNames.forEach(instruction => {
        const badge = document.createElement('button');
        badge.className = `btn btn-sm btn-outline-primary filter-badge ${alertFilters.instructions.has(instruction) ? 'active' : ''}`;
        badge.textContent = instruction;
        badge.onclick = () => toggleAlertFilter('instructions', instruction);
        instructionContainer.appendChild(badge);
    });
    
    // Build threat level filter badges
    const threatContainer = document.getElementById('threat-level-filters');
    threatContainer.innerHTML = '';
    threatLevels.forEach(level => {
        const badge = document.createElement('button');
        const levelColor = level === 'high' ? 'btn-outline-danger' : 
                          level === 'medium' ? 'btn-outline-warning' : 'btn-outline-success';
        badge.className = `btn btn-sm ${levelColor} filter-badge ${alertFilters.threatLevels.has(level) ? 'active' : ''}`;
        badge.textContent = level.toUpperCase();
        badge.onclick = () => toggleAlertFilter('threatLevels', level);
        threatContainer.appendChild(badge);
    });
    
    // Show filter section if we have filters
    if (instructionNames.size > 0 || threatLevels.size > 0) {
        document.getElementById('signal-alert-filters').style.display = 'block';
    }
}

function toggleAlertFilter(filterType, value) {
    if (alertFilters[filterType].has(value)) {
        alertFilters[filterType].delete(value);
    } else {
        alertFilters[filterType].add(value);
    }
    
    // Re-render alerts with new filters
    if (allAlerts.length > 0) {
        const filteredAlerts = applyAlertFilters(allAlerts);
        renderFilteredAlerts(filteredAlerts);
        
        // Update badge styling
        buildAlertFilterBadges(allAlerts);
    }
}

function applyAlertFilters(alerts) {
    return alerts.filter(alert => {
        // Check instruction filter
        if (alertFilters.instructions.size > 0 && !alertFilters.instructions.has(alert.instruction_name)) {
            return false;
        }
        
        // Check threat level filter
        if (alertFilters.threatLevels.size > 0 && !alertFilters.threatLevels.has(alert.threat_level)) {
            return false;
        }
        
        return true;
    });
}

function renderFilteredAlerts(filteredAlerts) {
    // Reset pagination to page 1 when filtering
    currentAlertsPage = 1;
    
    const totalAlerts = filteredAlerts.length;
    const totalPages = Math.ceil(totalAlerts / alertsPerPage);
    const start = (currentAlertsPage - 1) * alertsPerPage;
    const end = start + alertsPerPage;
    const pageAlerts = filteredAlerts.slice(start, end);
    
    // Update pagination info
    document.getElementById('alerts-start').textContent = totalAlerts > 0 ? start + 1 : 0;
    document.getElementById('alerts-end').textContent = Math.min(end, totalAlerts);
    document.getElementById('alerts-total').textContent = totalAlerts;
    document.getElementById('current-alerts-page').textContent = currentAlertsPage;
    document.getElementById('total-alerts-pages').textContent = Math.max(1, totalPages);
    
    // Update pagination buttons
    document.getElementById('prev-alerts-btn').disabled = currentAlertsPage <= 1;
    document.getElementById('next-alerts-btn').disabled = currentAlertsPage >= totalPages;
    
    // Show/hide pagination
    const paginationEl = document.getElementById('signal-alerts-pagination');
    if (totalAlerts > alertsPerPage) {
        paginationEl.style.display = 'flex';
    } else {
        paginationEl.style.display = 'none';
    }
    
    // Render alerts
    const container = document.getElementById('signal-alerts-list');
    if (totalAlerts === 0) {
        container.innerHTML = `
            <div class="text-center p-3 text-muted">
                <i class="fas fa-filter me-2"></i>No alerts match the current filters.
                <br><small>Try clearing some filters to see more results.</small>
            </div>
        `;
        return;
    }
    
    let html = '';
    pageAlerts.forEach(alert => {
        const threatBadgeColor = alert.threat_level === 'high' ? 'danger' : 
                               alert.threat_level === 'medium' ? 'warning' : 'success';
        
        const detectedTime = new Date(alert.detected_at).toLocaleString();
        
        html += `
            <div class="card mb-2 ${alert.threat_level === 'high' ? 'border-danger' : ''}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <h6 class="mb-0 me-2">${escapeHTML(alert.instruction_name)}</h6>
                                <span class="badge bg-${threatBadgeColor}">${alert.threat_level.toUpperCase()}</span>
                                <span class="badge bg-info ms-1">${Math.round(alert.confidence * 100)}%</span>
                            </div>
                            <p class="mb-1 small">${escapeHTML(alert.summary)}</p>
                            <div class="small text-muted">
                                <strong>Article:</strong> 
                                <a href="${alert.article_uri}" target="_blank" rel="noopener">
                                    ${(() => { try { if (alert.article_title) return escapeHTML(alert.article_title); const u = new URL(alert.article_uri); const last = decodeURIComponent((u.pathname.split('/').filter(Boolean).pop()||'').replace(/[-_]/g,' ')).trim(); return escapeHTML(last || 'Article'); } catch(_) { return 'Article'; } })()}
                                </a>
                                <span class="ms-2">â€¢ ${formatSource(alert.article_source, alert.article_uri)}</span>
                                <span class="ms-2">â€¢ ${detectedTime}</span>
                            </div>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-2">
                            <button class="btn btn-outline-success btn-sm" onclick="acknowledgeAlert(${alert.id})" title="Acknowledge">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function clearAlertFilters() {
    alertFilters.instructions.clear();
    alertFilters.threatLevels.clear();
    
    if (allAlerts.length > 0) {
        buildAlertFilterBadges(allAlerts);
        renderFilteredAlerts(allAlerts);
    }
}

// Incident filter functions
function buildIncidentFilterBadges(incidents) {
    // No-op stub: Filter containers were removed in toolbar redesign.
    // Filters now handled via toolbar dropdown in toggleFilterDropdown().
    // Kept as stub for backward compatibility with existing code that calls this.
}

function toggleIncidentFilter(filterType, value) {
    if (incidentFilters[filterType].has(value)) {
        incidentFilters[filterType].delete(value);
    } else {
        incidentFilters[filterType].add(value);
    }
    
    // Re-render incidents with new filters
    if (allIncidents.length > 0) {
        const filteredIncidents = applyIncidentFilters(allIncidents);
        renderIncidentTrackingFiltered(filteredIncidents);
        
        // Update badge styling
        buildIncidentFilterBadges(allIncidents);
    }
}

function applyIncidentFilters(incidents) {
    console.log('Applying incident filters:', {
        types: Array.from(incidentFilters.types),
        significance: Array.from(incidentFilters.significance),
        totalIncidents: incidents.length
    });
    
    const filtered = incidents.filter(incident => {
        // Check type filter - ensure exact match
        if (incidentFilters.types.size > 0) {
            const incidentType = String(incident.type || '').toLowerCase().trim();
            const hasTypeMatch = Array.from(incidentFilters.types).some(filterType => 
                String(filterType).toLowerCase().trim() === incidentType
            );
            if (!hasTypeMatch) {
                console.log('Filtered out by type:', incident.name, 'type:', incident.type, 'expected:', Array.from(incidentFilters.types));
                return false;
            }
        }
        
        // Check significance filter - ensure exact match
        if (incidentFilters.significance.size > 0) {
            const incidentSignificance = String(incident.significance || '').toLowerCase().trim();
            const hasSignificanceMatch = Array.from(incidentFilters.significance).some(filterSig => 
                String(filterSig).toLowerCase().trim() === incidentSignificance
            );
            if (!hasSignificanceMatch) {
                console.log('Filtered out by significance:', incident.name, 'significance:', incident.significance, 'expected:', Array.from(incidentFilters.significance));
                return false;
            }
        }
        
        // Check status filter - ensure exact match
        if (incidentFilters.status.size > 0) {
            const incidentStatus = String(incident.status || 'active').toLowerCase().trim();
            const hasStatusMatch = Array.from(incidentFilters.status).some(filterStatus => 
                String(filterStatus).toLowerCase().trim() === incidentStatus
            );
            if (!hasStatusMatch) {
                console.log('Filtered out by status:', incident.name, 'status:', incident.status, 'expected:', Array.from(incidentFilters.status));
                return false;
            }
        }
        
        return true;
    });
    
    console.log('Filtered incidents:', filtered.length, 'out of', incidents.length);
    return filtered;
}

function renderIncidentTrackingFiltered(filteredIncidents) {
    const container = document.getElementById('incident-tracking-container');

    // Clear container but preserve controls
    const existingControls = container.querySelector('.insight-item-card');
    container.innerHTML = '';
    if (existingControls) {
        container.appendChild(existingControls);
    }
    
    // Get quality toggle state
    const toggleId = 'incident-hide-low-toggle';
    let hideLow = true;
    try { 
        const saved = localStorage.getItem(toggleId); 
        if (saved !== null) hideLow = saved === 'true'; 
    } catch(_) {}
    
    // Apply quality filter on top of badge filters
    const riskFlags = new Set(['extraordinary_claim','no_independent_verification','low_factuality_source','low_credibility_source','fringe_bias']);
    const qualityFiltered = hideLow
        ? filteredIncidents.filter(inc => {
            if (!inc) return false;
            const plaus = String(inc.plausibility || '').toLowerCase();
            const quality = String(inc.source_quality || '').toLowerCase();
            const flags = Array.isArray(inc.misinfo_flags) ? inc.misinfo_flags.map(f => String(f).toLowerCase()) : [];
            const hasLowFlags = flags.some(f => f === 'low_factuality_source' || f === 'low_credibility_source' || f === 'fringe_bias');
            return plaus !== 'implausible' && quality !== 'low' && !hasLowFlags;
        })
        : filteredIncidents;
    
    // Apply sorting
    const finalFiltered = sortIncidents([...qualityFiltered]);

    if (!finalFiltered || finalFiltered.length === 0) {
        const message = filteredIncidents.length === 0 ?
            'No incidents match the current filters.' :
            'No high-quality incidents match the current filters.';
        container.insertAdjacentHTML('beforeend', `<div class="text-muted p-2 small w-100 text-center">${message}</div>`);
        return;
    }

    // Render based on current view
    if (currentIncidentView === 'table') {
        renderIncidentTable(finalFiltered);
        return;
    }
    
    // Compute global timeline range for ruler scaling
    let globalMin = null, globalMax = null;
    finalFiltered.forEach(inc => {
        if (Array.isArray(inc?.timeline) && inc.timeline.length > 0) {
            const first = new Date(inc.timeline[0]).getTime();
            const last = new Date(inc.timeline[inc.timeline.length - 1]).getTime();
            if (!isNaN(first) && !isNaN(last)) {
                globalMin = (globalMin === null) ? first : Math.min(globalMin, first);
                globalMax = (globalMax === null) ? last : Math.max(globalMax, last);
            }
        }
    });
    if (globalMin !== null && globalMax !== null && globalMax < globalMin) {
        const t = globalMin; globalMin = globalMax; globalMax = t;
    }

    // Render individual incident cards (card view)
    finalFiltered.forEach((incident, index) => {
        const incidentCard = createIndividualIncidentCard(incident, globalMin, globalMax);
        container.appendChild(incidentCard);
    });
}

function createIndividualIncidentCard(incident, globalMin, globalMax) {
    // Removed Bootstrap column wrapper - cards now use flexbox container
    const card = document.createElement('div');
    card.className = 'insight-item-card';
        
        // Check for low quality and add visual indicator
        let isLowQuality = false;
        if (incident.article_uris && incident.article_uris.length > 0) {
            const firstUri = incident.article_uris[0];
            const article = window.lastArticlesData?.items?.find(a => a.uri === firstUri);
            if (article) {
                const factual = (article.factual_reporting || '').toLowerCase();
                const mbfc = (article.mbfc_credibility_rating || '').toLowerCase();
                const bias = (article.bias || '').toLowerCase();
                
                isLowQuality = factual.includes('low') || factual.includes('mixed') ||
                              mbfc.includes('low') || mbfc.includes('mixed') ||
                              bias.includes('extreme') || bias.includes('conspiracy') || bias.includes('fringe');
            }
        }
        
        // Also check AI-derived quality
        if (!isLowQuality) {
            const sourceQuality = String(incident.source_quality || '').toLowerCase();
            const plausibility = String(incident.plausibility || '').toLowerCase();
            isLowQuality = sourceQuality === 'low' || plausibility === 'implausible' ||
                          (Array.isArray(incident.misinfo_flags) && incident.misinfo_flags.some(f => 
                              f.includes('low_factuality') || f.includes('low_credibility') || f.includes('fringe_bias')));
        }
        
        // Add border styling for low quality incidents
        if (isLowQuality) {
            card.style.borderLeft = '4px solid var(--colors-error-9)';
            card.style.backgroundColor = 'var(--colors-white)5f5';
        }
        
        // Determine badge color based on type and significance (updated for 7-type system)
        const typeBadgeColor = incident.type === 'incident' ? 'danger' : 
                              incident.type === 'entity' ? 'primary' : 
                              incident.type === 'expertise' ? 'warning' :
                              incident.type === 'informed_insider' ? 'dark' :
                              incident.type === 'trend_signal' ? 'info' :
                              incident.type === 'strategic_shift' ? 'secondary' : 'success';
        const significanceBadgeColor = incident.significance === 'high' ? 'danger' : 
                                     incident.significance === 'medium' ? 'warning' : 'info';
        
        // Build investigation leads HTML (clickable buttons)
        let leadsHtml = '';
        if (Array.isArray(incident.investigation_leads) && incident.investigation_leads.length > 0) {
            leadsHtml = `
                <div class="mt-2 mb-2">
                    <small class="text-muted fw-bold">Leads:</small>
                    <div class="d-flex gap-1 flex-wrap mt-1" style="max-width: 100%; overflow: hidden; word-break: break-word;">
                        ${incident.investigation_leads.map(lead => `
                            <button class="btn btn-outline-primary btn-sm"
                                    onclick="launchAuspexResearchFromInsight('${escapeHTML(lead)}', 'investigation_lead')"
                                    title="Launch Auspex research on: ${escapeHTML(lead)}"
                                    style="font-size: 10px; padding: 2px 6px; border-radius: 12px; max-width: 100%; text-overflow: ellipsis; overflow: hidden;">
                                <i class="fas fa-search me-1"></i>${escapeHTML(lead.length > 20 ? lead.substring(0, 20) + '...' : lead)}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Build timeline visualization
        let timelineHtml = '';
        if (Array.isArray(incident.timeline) && incident.timeline.length > 0) {
            const events = incident.timeline.map(t => new Date(t).getTime()).filter(t => !isNaN(t)).sort((a,b) => a - b);
            if (events.length > 0) {
                if (events.length === 1) {
                    // Single date - show as badge
                    timelineHtml = `
                        <div class="mt-2 mb-2">
                            <small class="text-muted fw-bold">Date:</small>
                            <span class="badge bg-primary ms-2">${new Date(events[0]).toLocaleDateString()}</span>
                        </div>
                    `;
                } else if (globalMin !== null && globalMax !== null) {
                    // Multiple dates - show timeline ruler
                    const range = Math.max(1, globalMax - globalMin);
                    const positions = events.map(t => Math.max(0, Math.min(100, ((t - globalMin) / range) * 100)));
                    timelineHtml = `
                        <div class="mt-2 mb-2">
                            <small class="text-muted fw-bold">Timeline:</small>
                            <div class="timeline-ruler" style="position: relative; height: 8px; background: var(--colors-neutral-4); border-radius: 4px; margin-top: 4px;">
                                ${positions.map(pos => `<div style="position: absolute; left: ${pos}%; width: 3px; height: 8px; background: var(--colors-info-5); border-radius: 1px;"></div>`).join('')}
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">${new Date(events[0]).toLocaleDateString()}</small>
                                <small class="text-muted">${new Date(events[events.length - 1]).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Determine status styling
        const status = incident.status || 'active';
        const statusBadgeColor = status === 'seen' ? 'secondary' : 'success';
        const cardOpacity = status === 'seen' ? 'opacity-75' : '';
        
        // Build topic badge HTML if topic is present
        let topicBadgeHtml = '';
        if (incident.topic) {
            const topicColor = getTopicColor(incident.topic);
            topicBadgeHtml = `<span class="badge me-1" style="background-color: ${topicColor}; font-size: 10px;" title="Topic">${escapeHTML(incident.topic)}</span>`;
        }

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2" style="gap: 8px;">
                <div class="d-flex align-items-center gap-2 flex-wrap" style="flex: 1; min-width: 0;">
                    <h6 class="mb-0" style="word-break: break-word;">${escapeHTML(incident.name || 'Unnamed Incident')}</h6>
                    ${topicBadgeHtml}
                    ${status === 'seen' ? `<span class="badge bg-${statusBadgeColor}"><i class="fas fa-eye me-1"></i>Seen</span>` : ''}
                </div>
                <div class="d-flex gap-1 flex-shrink-0" style="margin-left: auto;">
                    <span class="badge bg-${typeBadgeColor}">${incident.type || 'Unknown'}</span>
                    <span class="badge bg-${significanceBadgeColor}">${incident.significance || 'Unknown'}</span>
                </div>
            </div>
            <p class="mb-2 small">${escapeHTML(incident.description || 'No description available.')}</p>
            ${incident.organizational_relevance ? `
            <div class="alert alert-info py-2 mb-2">
                <small><strong><i class="fas fa-building me-1"></i>Why This Matters:</strong> ${escapeHTML(incident.organizational_relevance)}</small>
            </div>` : ''}
            ${incident.credibility_summary ? `
            <div class="mt-2 mb-2 p-2 bg-light rounded">
                <small class="text-muted fw-bold">Credibility Assessment:</small>
                <p class="small text-secondary mb-0">${escapeHTML(incident.credibility_summary)}</p>
            </div>` : ''}
            ${timelineHtml}
            ${incident.article_uris && incident.article_uris.length > 0 ? `
            <div class="mt-2 mb-2">
                <small class="text-muted fw-bold">Source Articles (${incident.article_uris.length}):</small>
                <ul class="list-unstyled mt-1 mb-0 small">
                    ${incident.article_uris.slice(0, 3).map((uri, idx) => {
                        // First try to get metadata from incident.article_metadata (enriched by backend)
                        let metadata = null;
                        if (incident.article_metadata && incident.article_metadata[idx]) {
                            metadata = incident.article_metadata[idx];
                        }

                        // Fallback to searching in window.lastArticlesData
                        const article = window.lastArticlesData?.items?.find(a => a.uri === uri);

                        let title = 'View Article';
                        let source = 'Unknown Source';
                        let hasMBFC = false;

                        if (metadata && metadata.title) {
                            // Use backend-provided metadata
                            title = metadata.title;
                            source = metadata.news_source || 'Unknown Source';
                            hasMBFC = !!(metadata.factual_reporting || metadata.mbfc_credibility_rating || metadata.bias);
                        } else if (article) {
                            // Use article from current dataset
                            title = article.title || 'Untitled Article';
                            source = article.news_source || 'Unknown Source';
                            hasMBFC = !!(article.factual_reporting || article.mbfc_credibility_rating || article.bias);
                        } else {
                            // Last resort: extract from URI
                            try {
                                const url = new URL(uri);
                                const pathParts = url.pathname.split('/').filter(Boolean);
                                const lastPart = pathParts[pathParts.length - 1] || '';
                                const cleaned = decodeURIComponent(lastPart.replace(/[-_]/g, ' ')).trim();
                                if (cleaned && cleaned.length > 5) {
                                    title = cleaned.substring(0, 50) + (cleaned.length > 50 ? '...' : '');
                                }
                                source = url.hostname.replace(/^www\./, '');
                            } catch (e) {
                                console.warn('Could not parse URI for title:', uri);
                            }
                        }

                        // Add MBFC quality indicators or AI-derived flag
                        let qualityBadges = '';
                        const sourceData = metadata || article; // Use metadata first, fallback to article

                        if (sourceData && hasMBFC) {
                            const badges = [];
                            if (sourceData.factual_reporting) {
                                badges.push(`<span class="badge ${getFactualityClass(sourceData.factual_reporting)}" style="font-size: 8px;" title="MBFC Factual Reporting">${sourceData.factual_reporting}</span>`);
                            }
                            if (sourceData.mbfc_credibility_rating) {
                                badges.push(`<span class="badge ${getMBFCCredibilityClass(sourceData.mbfc_credibility_rating)}" style="font-size: 8px;" title="MBFC Credibility Rating">${sourceData.mbfc_credibility_rating}</span>`);
                            }
                            if (sourceData.bias) {
                                badges.push(`<span class="badge ${getBiasClass(sourceData.bias)}" style="font-size: 8px;" title="MBFC Bias Rating">${sourceData.bias}</span>`);
                            }
                            if (badges.length > 0) {
                                qualityBadges = `<br>${badges.join(' ')}`;
                            }
                        } else {
                            // Flag when MBFC is missing and AI is rating
                            qualityBadges = `<br><span class="badge bg-warning text-dark" style="font-size: 8px;" title="No MBFC data available - quality assessment by AI">ðŸ“Š AI-Rated</span>`;
                        }
                        
                        return `<li class="mb-1">
                            <a href="${uri}" target="_blank" rel="noopener" class="text-decoration-none">${escapeHTML(title)}</a>
                            <small class="text-muted d-block">${escapeHTML(source)}</small>
                            ${qualityBadges}
                        </li>`;
                    }).join('')}
                    ${incident.article_uris.length > 3 ? `<li class="text-muted small">... and ${incident.article_uris.length - 3} more articles</li>` : ''}
                </ul>
            </div>` : ''}
            ${leadsHtml}
            <div class="mt-2">
                <!-- Analysis Tools -->
                <div class="mb-2">
                    <small class="text-muted fw-bold d-block mb-1">Analysis</small>
                    <div class="d-flex flex-wrap gap-1">
                        <button class="btn btn-sm btn-outline-primary" onclick="launchAuspexResearchFromInsight('${escapeHTML(incident.name)}', 'incident')" title="Investigate">
                            <i class="fas fa-search"></i>
                        </button>
                        ${incident.article_uris && incident.article_uris.length > 0 ? `
                            <button class="btn btn-sm btn-outline-secondary" onclick="launchConsensusAnalysis('${incident.article_uris[0]}')" title="Consensus">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>

                <!-- Admin Actions -->
                <div>
                    <small class="text-muted fw-bold d-block mb-1">Actions</small>
                    <div class="d-flex flex-wrap gap-1">
                        ${incident.article_uris && incident.article_uris.length > 0 ? `
                            <button class="btn btn-sm btn-outline-success" onclick="openAnnotationModal('${incident.article_uris[0]}')" title="Annotate">
                                <i class="fas fa-sticky-note"></i>
                            </button>
                        ` : ''}
                        ${status !== 'seen' ? `
                            <button class="btn btn-sm btn-outline-info" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'seen')" title="Mark as seen">
                                <i class="fas fa-eye"></i>
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-secondary" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'active')" title="Mark as unseen">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                        `}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteIncident('${escapeHTML(incident.name)}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
    // Apply opacity for seen incidents
    if (status === 'seen') {
        card.classList.add('opacity-75');
    }

    return card;  // Return card directly without column wrapper
}


function clearIncidentFilters() {
    incidentFilters.types.clear();
    incidentFilters.significance.clear();
    incidentFilters.status.clear();
    
    if (allIncidents.length > 0) {
        buildIncidentFilterBadges(allIncidents);
        renderIncidentTrackingFiltered(allIncidents);
    }
}

// Incident status management functions
async function updateIncidentStatus(incidentName, status) {
    try {
        const topicSelect = document.getElementById('topic-select');
        const currentTopic = topicSelect ? topicSelect.value : 'AI and Machine Learning';
        
        const response = await fetch(`/api/incident-status/${encodeURIComponent(incidentName)}?status=${status}&topic=${encodeURIComponent(currentTopic)}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Update the incident in allIncidents array
            const incident = allIncidents.find(inc => inc.name === incidentName);
            if (incident) {
                incident.status = status;
            }
            
            // Re-render with current filters
            const filteredIncidents = applyIncidentFilters(allIncidents);
            renderIncidentTrackingFiltered(filteredIncidents);
            
            const statusText = status === 'seen' ? 'seen' : 'active';
            showNotification(`Incident marked as ${statusText}`, 'success');
        } else {
            throw new Error(result.message || 'Failed to update status');
        }
        
    } catch (error) {
        console.error('Error updating incident status:', error);
        showNotification(`Failed to update incident status: ${error.message}`, 'error');
    }
}

async function deleteIncident(incidentName) {
    if (!confirm(`Are you sure you want to delete the incident "${incidentName}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const topicSelect = document.getElementById('topic-select');
        const currentTopic = topicSelect ? topicSelect.value : 'AI and Machine Learning';
        
        const response = await fetch(`/api/incident-status/${encodeURIComponent(incidentName)}?status=deleted&topic=${encodeURIComponent(currentTopic)}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Remove the incident from allIncidents array
            const incidentIndex = allIncidents.findIndex(inc => inc.name === incidentName);
            if (incidentIndex !== -1) {
                allIncidents.splice(incidentIndex, 1);
            }
            
            // Re-render with current filters
            const filteredIncidents = applyIncidentFilters(allIncidents);
            renderIncidentTrackingFiltered(filteredIncidents);
            
            // Update filter badges since we removed an incident
            buildIncidentFilterBadges(allIncidents);
            
            showNotification('Incident deleted successfully', 'success');
        } else {
            throw new Error(result.message || 'Failed to delete incident');
        }
        
    } catch (error) {
        console.error('Error deleting incident:', error);
        showNotification(`Failed to delete incident: ${error.message}`, 'error');
    }
}

// Incident analysis functions
async function toggleIncidentAnalysis(incidentName, articleUri, buttonElement) {
    const analysisId = `incident-analysis-${incidentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const analysisDiv = document.getElementById(analysisId);
    const icon = buttonElement.querySelector('i');
    
    if (!analysisDiv) return;
    
    if (analysisDiv.style.display === 'none') {
        // Expand
        analysisDiv.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
        buttonElement.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Hide Analysis';
        buttonElement.classList.remove('btn-outline-primary');
        buttonElement.classList.add('btn-success');
        
        // Generate analysis
        await generateIncidentArticleAnalysis(incidentName, articleUri);
        
    } else {
        // Collapse
        analysisDiv.style.display = 'none';
        icon.className = 'fas fa-chevron-right';
        buttonElement.innerHTML = '<i class="fas fa-chevron-right me-1"></i>Show Analysis';
        buttonElement.classList.remove('btn-success');
        buttonElement.classList.add('btn-outline-primary');
    }
}

async function generateIncidentArticleAnalysis(incidentName, articleUri) {
    const analysisContentId = `incident-article-analysis-${incidentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const analysisDiv = document.getElementById(analysisContentId);
    
    if (!analysisDiv) return;
    
    // Show loading state
    analysisDiv.innerHTML = `
        <div class="analysis-text bg-light p-2 rounded small text-muted">
            <i class="fas fa-spinner fa-spin me-2"></i>Generating analysis...
        </div>
    `;
    
    try {
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Use the same analysis endpoint as the Articles tab
        const response = await fetch('/api/vector-summary-raw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ids: [articleUri], 
                model: selectedModel
            })
        });
        
        if (!response.ok) {
            throw new Error(`Analysis failed: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.analysis) {
            // Convert markdown to HTML using marked.js
            const htmlContent = marked.parse(data.analysis);
            analysisDiv.innerHTML = `
                <div class="analysis-text small">
                    ${htmlContent}
                </div>
                <div class="mt-2 text-muted small">
                    <i class="fas fa-robot me-1"></i>Analysis by ${selectedModel}
                </div>
            `;
        } else {
            throw new Error('No analysis content received');
        }
        
    } catch (error) {
        console.error('Error generating incident analysis:', error);
        analysisDiv.innerHTML = `
            <div class="analysis-text bg-danger text-white p-2 rounded small">
                <i class="fas fa-exclamation-triangle me-2"></i>Failed to generate analysis: ${error.message}
            </div>
        `;
    }
}

// Incident-specific Auspex research functions with well-formed prompts
async function launchIncidentDeepDive(incidentName, articleUri) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Create chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Deep Dive: ${incidentName}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build focused deep dive prompt
        const researchPrompt = `Conduct a comprehensive deep dive analysis of the incident/entity: "${incidentName}"

CONTEXT:
This incident was identified through AI-powered threat hunting analysis. The primary article URI is: ${articleUri}

DEEP DIVE FOCUS: "${incidentName}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for comprehensive background information on "${incidentName}"
2. Analyze the primary themes, entities, and implications involved
3. Investigate historical context and related developments
4. Assess current status, recent activities, and future implications
5. Identify key stakeholders, organizations, and decision-makers
6. Evaluate strategic risks, opportunities, and potential outcomes
7. Provide actionable intelligence and strategic recommendations

Conduct a thorough investigation using your structured analysis format. Focus on providing comprehensive strategic intelligence about this specific incident/entity.`;
        
        await launchAuspexWithPrompt(chatId, researchPrompt, selectedModel, actualTopic, 'Incident Deep Dive');
        
    } catch (error) {
        console.error('Error launching incident deep dive:', error);
        showNotification(`Failed to launch deep dive: ${error.message}`, 'error');
    }
}

async function launchIncidentConsensus(incidentName, articleUri) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Create chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Consensus Check: ${incidentName}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build consensus analysis prompt
        const researchPrompt = `Analyze the claims and assertions related to: "${incidentName}" and compare them to broader consensus

CONTEXT:
This incident was identified through threat hunting analysis. The primary article URI is: ${articleUri}

CONSENSUS ANALYSIS FOCUS: "${incidentName}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for multiple sources reporting on "${incidentName}"
2. Identify the key claims, assertions, or releases being made
3. Compare these claims across different sources and perspectives
4. Assess the credibility and consistency of the information
5. Identify any contradictions, disputes, or verification issues
6. Evaluate the overall consensus or lack thereof on key points
7. Highlight any outlier claims that require additional verification

Focus on fact-checking and consensus-building analysis. Provide a balanced assessment of information reliability and source agreement.`;
        
        await launchAuspexWithPrompt(chatId, researchPrompt, selectedModel, actualTopic, 'Consensus Analysis');
        
    } catch (error) {
        console.error('Error launching incident consensus:', error);
        showNotification(`Failed to launch consensus analysis: ${error.message}`, 'error');
    }
}

async function launchIncidentAdjacent(incidentName, articleUri) {
    try {
        const actualTopic = getCurrentTopic() || 'AI and Machine Learning';
        const selectedModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Create chat session
        const response = await fetch('/api/auspex/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: actualTopic,
                title: `Adjacent Topics: ${incidentName}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create chat session: ${response.status}`);
        }
        
        const sessionData = await response.json();
        const chatId = sessionData.chat_id;
        
        // Build adjacent topics analysis prompt
        const researchPrompt = `Explore adjacent and related themes connected to: "${incidentName}"

CONTEXT:
This incident was identified through threat hunting analysis. The primary article URI is: ${articleUri}

ADJACENT TOPICS FOCUS: "${incidentName}"
TOPIC AREA: "${actualTopic}"

Please use your tools to:
1. Search for related themes and adjacent topics connected to "${incidentName}"
2. Identify upstream causes, downstream effects, and parallel developments
3. Explore connected entities, technologies, or policy areas
4. Analyze broader ecosystem implications and interdependencies
5. Investigate similar incidents or patterns in related domains
6. Map the strategic landscape and competitive dynamics
7. Identify emerging themes that intersect with this incident

Focus on expanding the analysis beyond the immediate incident to understand the broader strategic context and related opportunities or threats.`;
        
        await launchAuspexWithPrompt(chatId, researchPrompt, selectedModel, actualTopic, 'Adjacent Topics Analysis');
        
    } catch (error) {
        console.error('Error launching adjacent topics analysis:', error);
        showNotification(`Failed to launch adjacent topics analysis: ${error.message}`, 'error');
    }
}

// Update the realtime-signals-nav click handler to load alerts
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    document.getElementById('realtime-signals-nav')?.addEventListener('click', function() {
        loadTopicsForSignals(); // Load available topics first
        updateSignalArticleCount(); // Update article count
        loadSignalInstructions();
        loadSignalAlerts(); // Also load alerts when tab is opened
    });
});

// ===== Six Articles Configuration Modal Functions =====

// Default Six Articles configuration
const DEFAULT_SIX_ARTICLES_PROMPT = `ðŸŽ¯ {persona} Daily Top-{article_count} AI Articles â€” Analyst Prompt

You are an analyst selecting the {article_count} most important articles published in the last 24 hours for {persona_description} interested in AI's strategic, technical, and societal impacts, with specific focus on {persona_focus}.
{starred_instruction}

{audience_profile}

## Selection Rules
Choose exactly {article_count} articles from the provided corpus (news, filings, research, regulator posts). Each must score high on at least two:
1) Strategic relevance, 2) Novelty, 3) Credibility, 4) Representativeness (captures a bigger debate/trend).

- **Diversity**: Cover â‰¥3 domains (e.g., policy, business/market, tech/R&D, workforce/society).
- **No redundancy**: Don't select multiple pieces on the same event unless they provide non-overlapping value.
- **Recency**: Past 24 hours only.

## Article Corpus
{articles_summary}

## Required Output Format
Return ONLY a valid JSON array with exactly these fields for each article:
- title, source, date, url
- executive_takeaway (â‰¤20 words)
- summary (2-3 sentences)
- strategic_relevance (1 paragraph)
- time_horizon (Immediate/Medium/Long-term)
- risk_opportunity (risk/opportunity/mixed)
- signal_strength (weak/moderate/strong)
- executive_action (array of 1-2 action items)
- category (policy/market/tech/workforce/security/society)
- scores (object with relevance, novelty, credibility, representativeness: 0-5)

CRITICAL: Response MUST start with [ and end with ] - NO other text. No markdown formatting. Parseable by JSON.parse().`;

const DEFAULT_SIX_ARTICLES_PERSONAS = {
    CEO: {
        priorities: "Regulation, enterprise adoption, scaling limits, market dynamics, security/safety, workforce impact, strategic partnerships",
        riskAppetite: "moderate",
        focus: "business strategy, market positioning, competitive advantage, and regulatory compliance"
    },
    CMO: {
        priorities: "Market trends, customer behavior, brand impact, advertising innovation, customer experience, competitive positioning",
        riskAppetite: "high",
        focus: "marketing strategies, customer engagement, brand differentiation, and market opportunities"
    },
    CTO: {
        priorities: "Technical breakthroughs, infrastructure, scalability, development tools, architecture patterns, security vulnerabilities",
        riskAppetite: "high",
        focus: "technical architecture, development practices, technology stack decisions, and engineering excellence"
    },
    CISO: {
        priorities: "Security threats, vulnerabilities, compliance requirements, risk management, data protection, incident response",
        riskAppetite: "low",
        focus: "security risks, compliance requirements, threat mitigation, and data protection"
    }
};

const DEFAULT_SIX_ARTICLES_FORMAT = `[
  {
    "title": "Full headline (Source, YYYY-MM-DD, Author if available)",
    "source": "Publisher name only",
    "date": "YYYY-MM-DD",
    "url": "Clean URL without tracking parameters",
    "executive_takeaway": "One sentence under 20 words with critical insight",
    "summary": "2-3 sentences of core facts and developments",
    "strategic_relevance": "One paragraph on why this matters for executive decisions",
    "time_horizon": "Immediate",
    "risk_opportunity": "risk",
    "signal_strength": "strong",
    "executive_action": [
      "First actionable item for executives",
      "Second actionable item if relevant"
    ],
    "category": "policy",
    "scores": {"relevance": 5, "novelty": 4, "credibility": 5, "representativeness": 4}
  }
]`;

// Global config object
let sixArticlesConfig = {
    systemPrompt: DEFAULT_SIX_ARTICLES_PROMPT,
    personas: DEFAULT_SIX_ARTICLES_PERSONAS,
    formatSpec: DEFAULT_SIX_ARTICLES_FORMAT
};

// Show Six Articles configuration modal
function showSixArticlesConfigModal() {
    loadSixArticlesConfiguration();
    const modal = new bootstrap.Modal(document.getElementById('sixArticlesConfigModal'));

    // Auto-load "Why Six Articles?" tab when modal opens
    const modalElement = document.getElementById('sixArticlesConfigModal');
    modalElement.addEventListener('shown.bs.modal', function() {
        const rationaleTab = document.getElementById('six-rationale-tab');
        if (rationaleTab) {
            const tab = new bootstrap.Tab(rationaleTab);
            tab.show();
        }
    }, { once: true });

    modal.show();
}

// Load Six Articles configuration
async function loadSixArticlesConfiguration() {
    try {
        // Try to load from API first
        const response = await fetch('/api/news-feed/six-articles/config');
        if (response.ok) {
            const config = await response.json();
            sixArticlesConfig = { ...sixArticlesConfig, ...config };
        }
    } catch (error) {
        console.log('No saved Six Articles configuration found, using defaults');
    }

    // Load from localStorage as fallback
    const saved = localStorage.getItem('sixArticlesConfig');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            sixArticlesConfig = { ...sixArticlesConfig, ...parsed };
        } catch (error) {
            console.error('Error parsing saved Six Articles configuration:', error);
        }
    }

    // Populate form fields
    document.getElementById('sixArticlesSystemPrompt').value = sixArticlesConfig.systemPrompt || DEFAULT_SIX_ARTICLES_PROMPT;
    document.getElementById('sixArticlesFormatSpec').value = sixArticlesConfig.formatSpec || DEFAULT_SIX_ARTICLES_FORMAT;

    // Populate persona fields
    const personas = sixArticlesConfig.personas || DEFAULT_SIX_ARTICLES_PERSONAS;

    // CEO
    document.getElementById('ceoPersonaPriorities').value = personas.CEO?.priorities || DEFAULT_SIX_ARTICLES_PERSONAS.CEO.priorities;
    document.getElementById('ceoRiskAppetite').value = personas.CEO?.riskAppetite || DEFAULT_SIX_ARTICLES_PERSONAS.CEO.riskAppetite;
    document.getElementById('ceoFocus').value = personas.CEO?.focus || DEFAULT_SIX_ARTICLES_PERSONAS.CEO.focus;

    // CMO
    document.getElementById('cmoPersonaPriorities').value = personas.CMO?.priorities || DEFAULT_SIX_ARTICLES_PERSONAS.CMO.priorities;
    document.getElementById('cmoRiskAppetite').value = personas.CMO?.riskAppetite || DEFAULT_SIX_ARTICLES_PERSONAS.CMO.riskAppetite;
    document.getElementById('cmoFocus').value = personas.CMO?.focus || DEFAULT_SIX_ARTICLES_PERSONAS.CMO.focus;

    // CTO
    document.getElementById('ctoPersonaPriorities').value = personas.CTO?.priorities || DEFAULT_SIX_ARTICLES_PERSONAS.CTO.priorities;
    document.getElementById('ctoRiskAppetite').value = personas.CTO?.riskAppetite || DEFAULT_SIX_ARTICLES_PERSONAS.CTO.riskAppetite;
    document.getElementById('ctoFocus').value = personas.CTO?.focus || DEFAULT_SIX_ARTICLES_PERSONAS.CTO.focus;

    // CISO
    document.getElementById('cisoPersonaPriorities').value = personas.CISO?.priorities || DEFAULT_SIX_ARTICLES_PERSONAS.CISO.priorities;
    document.getElementById('cisoRiskAppetite').value = personas.CISO?.riskAppetite || DEFAULT_SIX_ARTICLES_PERSONAS.CISO.riskAppetite;
    document.getElementById('cisoFocus').value = personas.CISO?.focus || DEFAULT_SIX_ARTICLES_PERSONAS.CISO.focus;
}

// Save Six Articles configuration
async function saveSixArticlesConfiguration() {
    try {
        // Collect values from form
        sixArticlesConfig = {
            systemPrompt: document.getElementById('sixArticlesSystemPrompt').value,
            formatSpec: document.getElementById('sixArticlesFormatSpec').value,
            personas: {
                CEO: {
                    priorities: document.getElementById('ceoPersonaPriorities').value,
                    riskAppetite: document.getElementById('ceoRiskAppetite').value,
                    focus: document.getElementById('ceoFocus').value
                },
                CMO: {
                    priorities: document.getElementById('cmoPersonaPriorities').value,
                    riskAppetite: document.getElementById('cmoRiskAppetite').value,
                    focus: document.getElementById('cmoFocus').value
                },
                CTO: {
                    priorities: document.getElementById('ctoPersonaPriorities').value,
                    riskAppetite: document.getElementById('ctoRiskAppetite').value,
                    focus: document.getElementById('ctoFocus').value
                },
                CISO: {
                    priorities: document.getElementById('cisoPersonaPriorities').value,
                    riskAppetite: document.getElementById('cisoRiskAppetite').value,
                    focus: document.getElementById('cisoFocus').value
                }
            }
        };

        // Save to localStorage
        localStorage.setItem('sixArticlesConfig', JSON.stringify(sixArticlesConfig));

        // Try to save to API
        try {
            const response = await fetch('/api/news-feed/six-articles/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sixArticlesConfig)
            });

            if (!response.ok) {
                throw new Error('API save failed');
            }
        } catch (error) {
            console.log('API save not available, using localStorage only');
        }

        showNotification('Six Articles configuration saved successfully', 'success');

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('sixArticlesConfigModal'));
        modal.hide();

    } catch (error) {
        console.error('Error saving Six Articles configuration:', error);
        showNotification('Failed to save configuration: ' + error.message, 'error');
    }
}

// Reset Six Articles to defaults
function resetSixArticlesToDefaults() {
    if (!confirm('Reset all Six Articles settings to defaults? This cannot be undone.')) {
        return;
    }

    // Reset to defaults
    document.getElementById('sixArticlesSystemPrompt').value = DEFAULT_SIX_ARTICLES_PROMPT;
    document.getElementById('sixArticlesFormatSpec').value = DEFAULT_SIX_ARTICLES_FORMAT;

    // Reset personas
    document.getElementById('ceoPersonaPriorities').value = DEFAULT_SIX_ARTICLES_PERSONAS.CEO.priorities;
    document.getElementById('ceoRiskAppetite').value = DEFAULT_SIX_ARTICLES_PERSONAS.CEO.riskAppetite;
    document.getElementById('ceoFocus').value = DEFAULT_SIX_ARTICLES_PERSONAS.CEO.focus;

    document.getElementById('cmoPersonaPriorities').value = DEFAULT_SIX_ARTICLES_PERSONAS.CMO.priorities;
    document.getElementById('cmoRiskAppetite').value = DEFAULT_SIX_ARTICLES_PERSONAS.CMO.riskAppetite;
    document.getElementById('cmoFocus').value = DEFAULT_SIX_ARTICLES_PERSONAS.CMO.focus;

    document.getElementById('ctoPersonaPriorities').value = DEFAULT_SIX_ARTICLES_PERSONAS.CTO.priorities;
    document.getElementById('ctoRiskAppetite').value = DEFAULT_SIX_ARTICLES_PERSONAS.CTO.riskAppetite;
    document.getElementById('ctoFocus').value = DEFAULT_SIX_ARTICLES_PERSONAS.CTO.focus;

    document.getElementById('cisoPersonaPriorities').value = DEFAULT_SIX_ARTICLES_PERSONAS.CISO.priorities;
    document.getElementById('cisoRiskAppetite').value = DEFAULT_SIX_ARTICLES_PERSONAS.CISO.riskAppetite;
    document.getElementById('cisoFocus').value = DEFAULT_SIX_ARTICLES_PERSONAS.CISO.focus;

    showNotification('Six Articles configuration reset to defaults', 'info');
}

// Load default prompt
function loadDefaultSixArticlesPrompt() {
    document.getElementById('sixArticlesSystemPrompt').value = DEFAULT_SIX_ARTICLES_PROMPT;
    showNotification('Prompt reset to default', 'info');
}

// Preview prompt with sample data
function previewSixArticlesPrompt() {
    const promptTemplate = document.getElementById('sixArticlesSystemPrompt').value;
    const persona = document.getElementById('six-articles-persona')?.value || 'CEO';
    const articleCount = document.getElementById('six-articles-count')?.value || 6;

    // Sample data for preview
    const sampleData = {
        persona: persona,
        article_count: articleCount,
        persona_description: `${persona}s and senior decision-makers`,
        persona_focus: 'business strategy and competitive advantage',
        starred_instruction: '',
        audience_profile: '## Audience Defaults\n- Risk appetite: Moderate\n- Priorities: Regulation, market dynamics\n- Time: Will only read ' + articleCount + ' items/day',
        articles_summary: '1. Sample Article Title (TechCrunch, 2025-10-30)\nSummary: This is a sample article...\n\n2. Another Article (WSJ, 2025-10-30)\nSummary: Another sample...'
    };

    // Replace placeholders
    let preview = promptTemplate;
    for (const [key, value] of Object.entries(sampleData)) {
        preview = preview.replaceAll(`{${key}}`, value);
    }

    // Show in alert (could be improved with a modal)
    const previewModal = `
        <div class="modal fade" id="promptPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Prompt Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 70vh; overflow-y: auto;">${preview}</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing preview modal if present
    const existingPreview = document.getElementById('promptPreviewModal');
    if (existingPreview) {
        existingPreview.remove();
    }

    // Add and show preview modal
    document.body.insertAdjacentHTML('beforeend', previewModal);
    const modal = new bootstrap.Modal(document.getElementById('promptPreviewModal'));
    modal.show();

    // Clean up after modal is hidden
    document.getElementById('promptPreviewModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Validate prompt template
function validateSixArticlesPrompt() {
    const promptTemplate = document.getElementById('sixArticlesSystemPrompt').value;

    // Check for required placeholders
    const requiredPlaceholders = ['{persona}', '{article_count}', '{articles_summary}'];
    const missingPlaceholders = requiredPlaceholders.filter(ph => !promptTemplate.includes(ph));

    if (missingPlaceholders.length > 0) {
        showNotification('Warning: Missing required placeholders: ' + missingPlaceholders.join(', '), 'warning');
        return false;
    }

    // Check minimum length
    if (promptTemplate.length < 100) {
        showNotification('Warning: Prompt seems too short (< 100 characters)', 'warning');
        return false;
    }

    showNotification('Prompt template validation passed âœ“', 'success');
    return true;
}

// ===== Incident Configuration Modal Functions =====

// Global configuration state
let incidentConfig = {
    systemPrompt: '',
    userPrompt: '',
    baseOntology: '',
    domainKey: '',
    domainOverlay: '',
    ontologyExamples: '',
    analysisInstructions: '',
    qualityGuidelines: '',
    outputFormat: '',
    profileContextTemplate: '',
    enableProfileIntegration: true
};

// Default templates
const DEFAULT_SYSTEM_PROMPT = `You are a threat intelligence analyst tracking incidents, entities, and events in {topic}.

IMPORTANT: Assess credibility and plausibility. Treat extraordinary, self-reported breakthroughs with skepticism.
Use factual_reporting, MBFC credibility, and bias indicators. Down-rank or flag items from low/mixed credibility or fringe bias sources.

{profile_context}

{analysis_instructions}

{quality_guidelines}

{ontology_text}

Required fields for each item:
- name
- type: incident | entity | event | expertise | informed_insider | trend_signal | strategic_shift
- subtype: from the allowed list for the chosen type
- description
- article_uris
- timeline
- significance: low | medium | high (reduce if credibility concerns exist)
- investigation_leads
- related_entities
- plausibility: likely | questionable | implausible
- source_quality: high | mixed | low
- misinfo_flags: [] e.g., "extraordinary_claim", "no_independent_verification", "low_factuality_source", "fringe_bias"
- credibility_summary: 1-2 sentence rationale

Devil's Advocate Smell Test:
- Add a "devils_advocate" field with brief caution if the claim appears hyperbolic or extraordinary relative to typical evidence.
- Use label "Hyperbolic Claim" when applicable.

Output a pure JSON array only.`;

const DEFAULT_USER_PROMPT = `Analyze these {topic} articles for threat hunting incidents, entities, and events:

{articles_text}`;

const DEFAULT_BASE_ONTOLOGY = `ONTOLOGY â€” Types and Subtypes
Valid types: incident | event | entity | expertise | informed_insider | trend_signal | strategic_shift

Definitions:
- incident: Discrete occurrence with material operational/strategic/risk impact that may warrant response, remediation, or escalation.
- event: Noteworthy occurrence (signals, milestones, announcements) that informs context or trends but is not itself a disruptive incident.
- entity: Organization, person, product, venue, dataset (things we track, not occurrences).
- expertise: Expert analysis, predictions, or authoritative insights from recognized industry leaders, analysts, or researchers.
- informed_insider: Insider perspectives, leaked information, or privileged insights from people with direct access to relevant information.
- trend_signal: Market trends, behavioral shifts, or emerging patterns that indicate future developments.
- strategic_shift: Major strategic changes, policy pivots, or directional changes by key organizations or governments.

Recommended subtypes:
- incident: regulatory_action, compliance_breach, data_security, legal_ip, mna, layoffs, funding_cut, rd_spend_change, governance_change, market_disruption
- event: product_launch, feature_update, partnership_mou, funding_round, hiring, award, conference_announcement, roadmap_teaser, benchmark_result, pilot_program
- entity: company, person, product, dataset, venue, regulator, research_institution, government_agency
- expertise: industry_analysis, market_prediction, technical_assessment, strategic_forecast, expert_warning, research_finding
- informed_insider: leaked_strategy, internal_memo, insider_trading, confidential_roadmap, private_meeting, executive_communication
- trend_signal: adoption_trend, market_shift, behavioral_change, technology_uptake, regulatory_momentum, competitive_dynamic
- strategic_shift: policy_pivot, strategic_realignment, market_repositioning, technology_focus_change, regulatory_approach_change

Assignment rules:
- Use 'incident' for events requiring immediate attention or response (layoffs, breaches, regulatory actions, major failures).
- Use 'event' for announcements and developments (product launches, funding, partnerships, pilot programs).
- Use 'entity' for organizations, people, or products being tracked.
- Use 'expertise' when article features expert analysis, predictions, or authoritative insights from recognized leaders.
- Use 'informed_insider' when article contains insider information, leaks, or privileged access insights.
- Use 'trend_signal' when article identifies emerging patterns, market trends, or behavioral shifts.
- Use 'strategic_shift' when article describes major strategic changes, policy pivots, or directional changes.
- Always include a 'subtype' from the lists above.
- Be inclusive rather than restrictive - classify newsworthy content appropriately.`;

const DEFAULT_ONTOLOGY_EXAMPLES = `Labeling examples (JSON objects):
{"name": "SoftBank Vision Fund layoffs amid AI strategy shift", "type": "incident", "subtype": "layoffs"}
{"name": "US risks losing AI leadership to China", "type": "incident", "subtype": "governance_change"}
{"name": "Citi launches agentic AI pilot program", "type": "event", "subtype": "pilot_program"}
{"name": "OpenAI CEO discusses quantum computing partnership", "type": "event", "subtype": "partnership_mou"}
{"name": "Eric Schmidt warns about AI competitiveness", "type": "expertise", "subtype": "expert_warning"}
{"name": "Inside Tony Blair Institute AI strategy discussions", "type": "informed_insider", "subtype": "private_meeting"}
{"name": "Growing enterprise adoption of agentic AI", "type": "trend_signal", "subtype": "adoption_trend"}
{"name": "SoftBank shifts focus from consumer to enterprise AI", "type": "strategic_shift", "subtype": "strategic_realignment"}
{"name": "SoftBank Vision Fund", "type": "entity", "subtype": "company"}
{"name": "Eric Schmidt", "type": "entity", "subtype": "person"}
{"name": "Tony Blair Institute", "type": "entity", "subtype": "research_institution"}`;

const DEFAULT_ANALYSIS_INSTRUCTIONS = `Focus on extracting actionable intelligence from news articles. Prioritize:

1. Material business impacts and strategic changes (layoffs, restructuring, major funding changes)
2. Regulatory actions and compliance issues (government policies, regulatory warnings)
3. Security incidents and data breaches (cybersecurity events, data leaks)
4. Significant funding, M&A, or operational changes (acquisitions, major investments, closures)
5. Technology launches and competitive developments (new products, platform launches, AI model releases)
6. Leadership changes and strategic pivots (CEO changes, strategic direction shifts)
7. Market warnings and competitive threats (expert warnings, competitive analysis)

Classification Guidelines:
- INCIDENT: Events requiring immediate attention or response (layoffs, breaches, regulatory actions, major failures)
- EVENT: Significant announcements and developments (product launches, funding rounds, partnerships, strategic initiatives)  
- ENTITY: Organizations, people, or products being tracked (companies mentioned, key executives, new technologies)

Be inclusive rather than restrictive - if an article discusses something newsworthy, classify it appropriately.`;

const DEFAULT_QUALITY_GUIDELINES = `Credibility Assessment:
- High credibility: Major news outlets, verified sources, multiple independent confirmations
- Mixed credibility: Single source reporting, unverified claims, industry blogs
- Low credibility: Social media rumors, fringe sources, extraordinary claims without evidence

Extraordinary Claims Protocol:
- Flag claims that seem too good to be true or represent major breakthroughs
- Require independent verification for significant technical achievements
- Down-rank significance for self-reported successes without third-party validation`;

const DEFAULT_OUTPUT_FORMAT = `Output must be a valid JSON array with each incident object containing all required fields.
Ensure proper JSON escaping of quotes and special characters.
Do not include any explanatory text outside the JSON array.`;

const DEFAULT_PROFILE_CONTEXT_TEMPLATE = `ORGANIZATIONAL CONTEXT:
Organization: {profile_name} ({organization_type} in {industry})
Region: {region}
Risk Tolerance: {risk_tolerance} | Innovation Appetite: {innovation_appetite}
Decision Making: {decision_making_style}

Key Concerns: {key_concerns}
Strategic Priorities: {strategic_priorities}
Key Stakeholders: {stakeholder_focus}
Competitive Landscape: {competitive_landscape}
Regulatory Environment: {regulatory_environment}

Custom Context: {custom_context}

ANALYSIS INSTRUCTIONS:
- Prioritize incidents and events that align with the organization's key concerns and strategic priorities
- Assess significance based on the organization's risk tolerance and decision-making style  
- Consider impact on key stakeholders and competitive positioning
- Account for relevant regulatory and compliance implications
- Tailor investigation leads to organizational context and priorities`;

// Show the incident configuration modal
function showIncidentConfigModal() {
    loadIncidentConfiguration();
    const modal = new bootstrap.Modal(document.getElementById('incidentConfigModal'));

    // Auto-load Info tab when modal opens (same pattern as Six Articles)
    const modalElement = document.getElementById('incidentConfigModal');
    modalElement.addEventListener('shown.bs.modal', function() {
        const infoTab = document.getElementById('info-tab');
        if (infoTab) {
            const tab = new bootstrap.Tab(infoTab);
            tab.show();
        }
    }, { once: true });

    modal.show();
}

// Load configuration from localStorage or defaults
async function loadIncidentConfiguration() {
    try {
        // Try to load from API first (future enhancement)
        const response = await fetch('/api/incident-config');
        if (response.ok) {
            const config = await response.json();
            incidentConfig = { ...incidentConfig, ...config };
        }
    } catch (error) {
        console.log('No saved configuration found, using defaults');
    }

    // Load from localStorage as fallback
    const saved = localStorage.getItem('incidentTrackingConfig');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            incidentConfig = { ...incidentConfig, ...parsed };
        } catch (error) {
            console.error('Error parsing saved configuration:', error);
        }
    }

    // Get the currently selected organizational profile from news feed
    const currentProfile = await getCurrentOrganizationalProfile();
    
    // Populate form fields with current config or defaults
    document.getElementById('incidentSystemPrompt').value = incidentConfig.systemPrompt || DEFAULT_SYSTEM_PROMPT;
    document.getElementById('incidentUserPrompt').value = incidentConfig.userPrompt || DEFAULT_USER_PROMPT;
    document.getElementById('baseOntology').value = incidentConfig.baseOntology || DEFAULT_BASE_ONTOLOGY;
    document.getElementById('domainKey').value = incidentConfig.domainKey || '';
    document.getElementById('domainOverlay').value = incidentConfig.domainOverlay || '';
    document.getElementById('ontologyExamples').value = incidentConfig.ontologyExamples || DEFAULT_ONTOLOGY_EXAMPLES;
    document.getElementById('analysisInstructions').value = incidentConfig.analysisInstructions || DEFAULT_ANALYSIS_INSTRUCTIONS;
    document.getElementById('qualityGuidelines').value = incidentConfig.qualityGuidelines || DEFAULT_QUALITY_GUIDELINES;
    document.getElementById('outputFormat').value = incidentConfig.outputFormat || DEFAULT_OUTPUT_FORMAT;
    
    // Use profile-specific context template if we have a current profile
    let profileTemplate = incidentConfig.profileContextTemplate || DEFAULT_PROFILE_CONTEXT_TEMPLATE;
    if (currentProfile) {
        profileTemplate = generateProfileContextFromData(currentProfile);
    }
    document.getElementById('profileContextTemplate').value = profileTemplate;
    document.getElementById('enableProfileIntegration').checked = incidentConfig.enableProfileIntegration !== false;
    
    // Show profile info if one is selected
    showCurrentProfileInfo(currentProfile);
}

// Save configuration
async function saveIncidentConfiguration() {
    try {
        // Collect values from form
        incidentConfig = {
            systemPrompt: document.getElementById('incidentSystemPrompt').value,
            userPrompt: document.getElementById('incidentUserPrompt').value,
            baseOntology: document.getElementById('baseOntology').value,
            domainKey: document.getElementById('domainKey').value,
            domainOverlay: document.getElementById('domainOverlay').value,
            ontologyExamples: document.getElementById('ontologyExamples').value,
            analysisInstructions: document.getElementById('analysisInstructions').value,
            qualityGuidelines: document.getElementById('qualityGuidelines').value,
            outputFormat: document.getElementById('outputFormat').value,
            profileContextTemplate: document.getElementById('profileContextTemplate').value,
            enableProfileIntegration: document.getElementById('enableProfileIntegration').checked
        };

        // Save to localStorage
        localStorage.setItem('incidentTrackingConfig', JSON.stringify(incidentConfig));

        // Try to save to API (future enhancement)
        try {
            await fetch('/api/incident-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(incidentConfig)
            });
        } catch (error) {
            console.log('API save not available, using localStorage only');
        }

        showNotification('Incident configuration saved successfully', 'success');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('incidentConfigModal'));
        modal.hide();
        
    } catch (error) {
        console.error('Error saving configuration:', error);
        showNotification('Failed to save configuration: ' + error.message, 'error');
    }
}

// Reset all to defaults
function resetAllToDefaults() {
    if (confirm('Are you sure you want to reset all configuration to defaults? This will overwrite your current settings.')) {
        document.getElementById('incidentSystemPrompt').value = DEFAULT_SYSTEM_PROMPT;
        document.getElementById('incidentUserPrompt').value = DEFAULT_USER_PROMPT;
        document.getElementById('baseOntology').value = DEFAULT_BASE_ONTOLOGY;
        document.getElementById('domainKey').value = '';
        document.getElementById('domainOverlay').value = '';
        document.getElementById('ontologyExamples').value = DEFAULT_ONTOLOGY_EXAMPLES;
        document.getElementById('analysisInstructions').value = DEFAULT_ANALYSIS_INSTRUCTIONS;
        document.getElementById('qualityGuidelines').value = DEFAULT_QUALITY_GUIDELINES;
        document.getElementById('outputFormat').value = DEFAULT_OUTPUT_FORMAT;
        document.getElementById('profileContextTemplate').value = DEFAULT_PROFILE_CONTEXT_TEMPLATE;
        document.getElementById('enableProfileIntegration').checked = true;
        
        showNotification('Configuration reset to defaults', 'info');
    }
}

// Load default prompt template
function loadDefaultPromptTemplate() {
    if (confirm('Reset prompt templates to defaults?')) {
        document.getElementById('incidentSystemPrompt').value = DEFAULT_SYSTEM_PROMPT;
        document.getElementById('incidentUserPrompt').value = DEFAULT_USER_PROMPT;
        showNotification('Prompt templates reset to defaults', 'info');
    }
}

// Load default ontology
function loadDefaultOntology() {
    if (confirm('Reset ontology to defaults?')) {
        document.getElementById('baseOntology').value = DEFAULT_BASE_ONTOLOGY;
        document.getElementById('domainKey').value = '';
        document.getElementById('domainOverlay').value = '';
        document.getElementById('ontologyExamples').value = DEFAULT_ONTOLOGY_EXAMPLES;
        showNotification('Ontology reset to defaults', 'info');
    }
}

// Preview prompt with sample data
function previewPrompt() {
    const systemPrompt = document.getElementById('incidentSystemPrompt').value;
    const userPrompt = document.getElementById('incidentUserPrompt').value;
    const baseOntology = document.getElementById('baseOntology').value;
    
    // Sample data for preview
    const sampleTopic = 'AI and Machine Learning';
    const sampleOntology = baseOntology || DEFAULT_BASE_ONTOLOGY;
    const sampleArticles = `Article 1:
Title: OpenAI Announces GPT-5 with Revolutionary Capabilities
Source: TechCrunch
Date: 2024-01-15
Category: Technology | Sentiment: Positive
Summary: OpenAI unveiled GPT-5, claiming breakthrough performance in reasoning and multimodal tasks.`;

    // Get actual profile context (will use real profile data if available)
    const profileTemplate = document.getElementById('profileContextTemplate').value || DEFAULT_PROFILE_CONTEXT_TEMPLATE;
    
    // If the template contains actual profile data, use it as-is
    // Otherwise, use sample data for preview
    let sampleProfileContext = profileTemplate;
    if (profileTemplate === DEFAULT_PROFILE_CONTEXT_TEMPLATE) {
        sampleProfileContext = profileTemplate
            .replace(/{profile_name}/g, 'TechCorp Analytics (Sample)')
            .replace(/{organization_type}/g, 'Enterprise')
            .replace(/{industry}/g, 'Technology')
            .replace(/{region}/g, 'North America')
            .replace(/{risk_tolerance}/g, 'Medium')
            .replace(/{innovation_appetite}/g, 'Moderate')
            .replace(/{decision_making_style}/g, 'Data-driven')
            .replace(/{key_concerns}/g, 'AI safety, competitive intelligence, regulatory compliance')
            .replace(/{strategic_priorities}/g, 'Market leadership, innovation, risk management')
            .replace(/{stakeholder_focus}/g, 'Executives, product teams, compliance')
            .replace(/{competitive_landscape}/g, 'Google, Microsoft, OpenAI')
            .replace(/{regulatory_environment}/g, 'EU AI Act, US AI governance frameworks')
            .replace(/{custom_context}/g, 'Focus on enterprise AI applications and B2B market dynamics');
    }
    // If it's not the default template, it means we have real profile data, so use it as-is

    // Get AI guidance components
    const analysisInstructions = document.getElementById('analysisInstructions').value || DEFAULT_ANALYSIS_INSTRUCTIONS;
    const qualityGuidelines = document.getElementById('qualityGuidelines').value || DEFAULT_QUALITY_GUIDELINES;

    // Replace placeholders
    const previewSystem = systemPrompt
        .replace(/{topic}/g, sampleTopic)
        .replace(/{ontology_text}/g, sampleOntology)
        .replace(/{profile_context}/g, sampleProfileContext)
        .replace(/{analysis_instructions}/g, analysisInstructions)
        .replace(/{quality_guidelines}/g, qualityGuidelines);
    
    const previewUser = userPrompt
        .replace(/{topic}/g, sampleTopic)
        .replace(/{articles_text}/g, sampleArticles);

    // Show preview in new modal with both prompt and expected output
    const previewContent = `SYSTEM PROMPT:\n${previewSystem}\n\nUSER PROMPT:\n${previewUser}`;
    
    // Expected output based on sample data
    const expectedOutput = `EXPECTED OUTPUT (Sample):
[
  {
    "name": "OpenAI GPT-5 Revolutionary Capabilities Announcement",
    "type": "event",
    "subtype": "product_launch",
    "description": "OpenAI unveiled GPT-5 with claimed breakthrough performance in reasoning and multimodal tasks",
    "article_uris": ["https://techcrunch.com/sample-gpt5"],
    "timeline": ["2024-01-15"],
    "significance": "high",
    "investigation_leads": ["GPT-5 performance benchmarks", "competitive response analysis", "market impact assessment"],
    "related_entities": ["OpenAI", "GPT-5"],
    "plausibility": "likely",
    "source_quality": "high",
    "misinfo_flags": [],
    "credibility_summary": "TechCrunch is a reputable technology publication with high factual reporting standards."
  }
]`;
    
    // Create a simple preview modal
    const previewModal = document.createElement('div');
    previewModal.innerHTML = `
        <div class="modal fade" id="promptPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Prompt Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="previewTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#preview-prompt">Prompt</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#preview-output">Expected Output</a>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            <div class="tab-pane fade show active" id="preview-prompt">
                                <pre style="white-space: pre-wrap; font-size: 11px; max-height: 400px; overflow-y: auto;">${escapeHTML(previewContent)}</pre>
                            </div>
                            <div class="tab-pane fade" id="preview-output">
                                <pre style="white-space: pre-wrap; font-size: 11px; max-height: 400px; overflow-y: auto;">${escapeHTML(expectedOutput)}</pre>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(previewModal);
    const modal = new bootstrap.Modal(previewModal.querySelector('.modal'));
    modal.show();
    
    // Clean up when modal is closed
    previewModal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(previewModal);
    });
}

// Validate prompt template
async function validatePromptTemplate() {
    try {
        // Collect current configuration
        const config = {
            systemPrompt: document.getElementById('incidentSystemPrompt').value,
            userPrompt: document.getElementById('incidentUserPrompt').value,
            baseOntology: document.getElementById('baseOntology').value,
            domainKey: document.getElementById('domainKey').value,
            domainOverlay: document.getElementById('domainOverlay').value,
            ontologyExamples: document.getElementById('ontologyExamples').value,
            analysisInstructions: document.getElementById('analysisInstructions').value,
            qualityGuidelines: document.getElementById('qualityGuidelines').value,
            outputFormat: document.getElementById('outputFormat').value,
            profileContextTemplate: document.getElementById('profileContextTemplate').value,
            enableProfileIntegration: document.getElementById('enableProfileIntegration').checked
        };
        
        // Client-side validation
        const issues = [];
        
        // Check for required placeholders in system prompt
        const systemPrompt = config.systemPrompt;
        if (!systemPrompt.includes('{topic}')) {
            issues.push('System prompt missing {topic} placeholder');
        }
        if (!systemPrompt.includes('{ontology_text}')) {
            issues.push('System prompt missing {ontology_text} placeholder');
        }
        
        // Check for required placeholders in user prompt
        const userPrompt = config.userPrompt;
        if (!userPrompt.includes('{topic}')) {
            issues.push('User prompt missing {topic} placeholder');
        }
        if (!userPrompt.includes('{articles_text}')) {
            issues.push('User prompt missing {articles_text} placeholder');
        }
        
        // Validate ontology structure
        const ontology = config.baseOntology;
        if (!ontology.includes('incident') || !ontology.includes('event') || !ontology.includes('entity')) {
            issues.push('Base ontology missing required types (incident, event, entity)');
        }
        
        // Validate profile template if profile integration is enabled
        if (config.enableProfileIntegration && config.profileContextTemplate) {
            const template = config.profileContextTemplate;
            const currentProfile = await getCurrentOrganizationalProfile();
            
            if (currentProfile) {
                // For real profiles, template should already be populated (not contain placeholders)
                const hasPlaceholders = template.includes('{profile_name}') || 
                                      template.includes('{industry}') || 
                                      template.includes('{organization_type}');
                
                if (hasPlaceholders) {
                    // Template has placeholders but we have a real profile - try to populate it
                    try {
                        const testContext = generateProfileContextFromData(currentProfile);
                        if (!testContext || testContext === template) {
                            issues.push('Profile context template could not be populated with current profile data');
                        }
                    } catch (e) {
                        issues.push('Profile context template has formatting errors');
                    }
                } else {
                    // Template is already populated - check if it contains organization info
                    if (!template.includes(currentProfile.name)) {
                        issues.push('Profile context template does not appear to contain current organization information');
                    }
                }
            } else {
                // No profile selected - template should have placeholders for future use
                const hasPlaceholders = template.includes('{profile_name}') || 
                                      template.includes('{industry}') || 
                                      template.includes('{organization_type}');
                
                if (!hasPlaceholders) {
                    issues.push('No organizational profile selected. Template should contain placeholders like {profile_name}, {industry}, {organization_type} for future use.');
                }
            }
        }
        
        if (issues.length === 0) {
            showNotification('Configuration validation passed âœ“', 'success');
        } else {
            showNotification(`Validation issues found:\\nâ€¢ ${issues.join('\\nâ€¢ ')}`, 'warning');
        }
        
    } catch (error) {
        console.error('Error validating configuration:', error);
        showNotification('Failed to validate configuration: ' + error.message, 'error');
    }
}

// Validate ontology structure
function validateOntology() {
    const baseOntology = document.getElementById('baseOntology').value;
    const examples = document.getElementById('ontologyExamples').value;
    
    const issues = [];
    
    // Check for required types
    if (!baseOntology.toLowerCase().includes('incident')) {
        issues.push('Base ontology missing "incident" type definition');
    }
    if (!baseOntology.toLowerCase().includes('event')) {
        issues.push('Base ontology missing "event" type definition');
    }
    if (!baseOntology.toLowerCase().includes('entity')) {
        issues.push('Base ontology missing "entity" type definition');
    }
    
    // Check examples format
    if (examples) {
        try {
            const lines = examples.split('\\n').filter(line => line.trim());
            for (const line of lines) {
                if (line.trim().startsWith('{')) {
                    JSON.parse(line.trim());
                }
            }
        } catch (error) {
            issues.push('Invalid JSON format in examples');
        }
    }
    
    if (issues.length === 0) {
        showNotification('Ontology validation passed', 'success');
    } else {
        showNotification('Validation issues found:\\nâ€¢ ' + issues.join('\\nâ€¢ '), 'warning');
    }
}

// Add domain overlay helper
function addDomainOverlay() {
    const domainKey = document.getElementById('domainKey').value.trim();
    if (!domainKey) {
        showNotification('Please enter a domain key first', 'warning');
        return;
    }
    
    const template = `
Domain overlay â€” ${domainKey}:
- Treat as incident: [specific incident criteria for this domain]
- Treat as event: [specific event criteria for this domain]
Examples:
  - '[Example incident]' â†’ type=incident, subtype=[subtype], significance=[level].
  - '[Example event]' â†’ type=event, subtype=[subtype], significance=[level].
`;
    
    document.getElementById('domainOverlay').value = template;
    showNotification('Domain overlay template added', 'info');
}

// Upgrade to extended 7-type ontology
function upgradeToExtendedOntology() {
    if (confirm('Upgrade to the new 7-type ontology with Expertise, Informed Insider, Trend Signal, and Strategic Shift types? This will replace your current ontology configuration.')) {
        // Update to the new extended ontology
        document.getElementById('baseOntology').value = DEFAULT_BASE_ONTOLOGY;
        document.getElementById('ontologyExamples').value = DEFAULT_ONTOLOGY_EXAMPLES;
        document.getElementById('analysisInstructions').value = DEFAULT_ANALYSIS_INSTRUCTIONS;
        
        showNotification('Upgraded to extended 7-type ontology! This should capture more nuanced intelligence from your articles.', 'success');
    }
}

// Test with sample articles
async function testWithSampleArticles() {
    try {
        showNotification('Running test analysis with sample articles...', 'info');
        
        // Get current configuration
        const config = {
            systemPrompt: document.getElementById('incidentSystemPrompt').value,
            userPrompt: document.getElementById('incidentUserPrompt').value,
            baseOntology: document.getElementById('baseOntology').value,
            profileContextTemplate: document.getElementById('profileContextTemplate').value,
            enableProfileIntegration: document.getElementById('enableProfileIntegration').checked
        };
        
        // Get 5 most recent articles from current news feed
        let sampleArticles = [];
        
        try {
            // First try to use articles already loaded in the news feed
            const currentArticles = window.lastArticlesData?.items || [];
            if (currentArticles.length >= 5) {
                sampleArticles = currentArticles.slice(0, 5).map(article => ({
                    title: article.title || 'Untitled Article',
                    news_source: article.news_source || 'Unknown Source', // Use news_source, not source
                    summary: article.summary || 'No summary available',
                    uri: article.uri || '',
                    category: article.category || 'Uncategorized',
                    sentiment: article.sentiment || 'Neutral',
                    bias: article.bias || 'Unknown',
                    factual_reporting: article.factual_reporting || 'Unknown',
                    publication_date: article.publication_date || new Date().toISOString().split('T')[0]
                }));
                console.log('Using 5 most recent articles from current news feed for testing');
            } else {
                // Fallback: fetch fresh articles from API
                console.log('Fetching fresh articles for testing...');
                const currentTopic = document.getElementById('topic-select')?.value || 'AI and Machine Learning';
                const response = await fetch(`/api/news-feed/articles?topic=${encodeURIComponent(currentTopic)}&per_page=5&page=1`);
                
                if (response.ok) {
                    const data = await response.json();
                    const articles = data.articles?.items || [];
                    
                    if (articles.length > 0) {
                        sampleArticles = articles.map(article => ({
                            title: article.title || 'Untitled Article',
                            news_source: article.news_source || 'Unknown Source', // Use news_source, not source
                            summary: article.summary || 'No summary available',
                            uri: article.uri || '',
                            category: article.category || 'Uncategorized',
                            sentiment: article.sentiment || 'Neutral',
                            bias: article.bias || 'Unknown',
                            factual_reporting: article.factual_reporting || 'Unknown',
                            publication_date: article.publication_date || new Date().toISOString().split('T')[0]
                        }));
                        console.log(`Fetched ${sampleArticles.length} fresh articles for testing`);
                    }
                }
            }
        } catch (error) {
            console.warn('Failed to get real articles, using fallback samples:', error);
        }
        
        // Fallback to mock data if we couldn't get real articles
        if (sampleArticles.length === 0) {
            console.log('Using fallback mock articles for testing');
            sampleArticles = [
                {
                    title: "OpenAI Announces GPT-5 with Revolutionary Capabilities",
                    news_source: "TechCrunch", // Use news_source, not source
                    summary: "OpenAI unveiled GPT-5, claiming breakthrough performance in reasoning and multimodal tasks.",
                    uri: "https://techcrunch.com/sample-gpt5",
                    category: "Technology",
                    sentiment: "Positive",
                    bias: "Least Biased",
                    factual_reporting: "High",
                    publication_date: "2024-01-15"
                },
                {
                    title: "EU Proposes Stricter AI Regulations Following Safety Concerns", 
                    news_source: "Reuters", // Use news_source, not source
                    summary: "European Union lawmakers are drafting additional AI safety regulations after reports of bias in large language models.",
                    uri: "https://reuters.com/sample-eu-regs",
                    category: "Policy",
                    sentiment: "Critical", 
                    bias: "Least Biased",
                    factual_reporting: "Very High",
                    publication_date: "2024-01-14"
                },
                {
                    title: "Tesla's AI Chip Division Reports Record Quarterly Revenue",
                    news_source: "Bloomberg", // Use news_source, not source
                    summary: "Tesla's semiconductor division exceeded expectations with $2.1B in Q4 revenue, driven by demand for AI training chips.",
                    uri: "https://bloomberg.com/sample-tesla",
                    category: "Business",
                    sentiment: "Positive",
                    bias: "Least Biased", 
                    factual_reporting: "High",
                    publication_date: "2024-01-13"
                }
            ];
        }
        
        // Show test results modal
        showTestResults(config, sampleArticles);
        
    } catch (error) {
        console.error('Error running test:', error);
        showNotification('Test failed: ' + error.message, 'error');
    }
}

// Show test results in modal
function showTestResults(config, sampleArticles) {
    // Create test modal to show results
    const testModal = document.createElement('div');
    testModal.innerHTML = `
        <div class="modal fade" id="testResultsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-flask me-2"></i>Test Analysis Results
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Sample Articles Used</h6>
                                <div class="bg-light p-3 rounded mb-3" style="max-height: 300px; overflow-y: auto;">
                                    ${sampleArticles.map((article, index) => `
                                        <div class="mb-2 pb-2 ${index < sampleArticles.length - 1 ? 'border-bottom' : ''}">
                                            <strong>${index + 1}. ${article.title}</strong><br>
                                            <small class="text-muted">${article.news_source}</small><br>
                                            <small>${article.summary}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">Configuration Status</h6>
                                <div class="mb-3">
                                    <div class="alert alert-info py-2">
                                        <strong>System Prompt:</strong> ${config.systemPrompt.length} characters<br>
                                        <strong>Profile Integration:</strong> ${config.enableProfileIntegration ? 'Enabled' : 'Disabled'}<br>
                                        <strong>Ontology:</strong> ${config.baseOntology.length} characters
                                    </div>
                                </div>
                                
                                <h6 class="text-warning">Expected Output</h6>
                                <div class="bg-light p-3 rounded">
                                    <small class="text-muted">
                                        Expected classifications:
                                        <ul class="mt-2 mb-0">
                                            <li><strong>Incident:</strong> EU regulatory action</li>
                                            <li><strong>Event:</strong> GPT-5 announcement</li>
                                            <li><strong>Entity:</strong> Tesla AI division</li>
                                        </ul>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary">Test Results</h6>
                                <div id="testAnalysisResults" class="bg-white border rounded p-3">
                                    <div class="text-center text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Running analysis simulation...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" onclick="runAnotherTest()">
                            <i class="fas fa-redo me-1"></i>Run Another Test
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(testModal);
    const modal = new bootstrap.Modal(testModal.querySelector('.modal'));
    modal.show();
    
    // Clean up when modal is closed
    testModal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(testModal);
    });
    
    // Run actual test analysis with the real articles
    setTimeout(() => runRealTestAnalysis(sampleArticles), 1500);
}

// Run actual test analysis with real articles
async function runRealTestAnalysis(articles) {
    const resultsDiv = document.getElementById('testAnalysisResults');
    if (!resultsDiv || !articles || articles.length === 0) {
        runSimulatedAnalysis(); // Fallback to simulation
        return;
    }
    
    try {
        resultsDiv.innerHTML = `
            <div class="text-center text-muted">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Running real incident analysis on ${articles.length} articles...
            </div>
        `;
        
        // Get current topic and model
        const currentTopic = document.getElementById('topic-select')?.value || 'AI and Machine Learning';
        const currentModel = document.getElementById('model-select')?.value || 'gpt-4o-mini';
        
        // Get selected profile ID
        const profileSelect = document.getElementById('profile-select');
        const selectedProfileId = profileSelect && profileSelect.value ? parseInt(profileSelect.value) : null;
        
        // Build request for real incident tracking analysis
        const testRequest = {
            topic: currentTopic, // Use exact topic, not modified with "(Test)"
            days_limit: 7,
            max_articles: Math.max(10, Math.min(300, articles.length)), // Ensure within valid range
            model: currentModel,
            force_regenerate: true,
            test_articles: articles // Pass the actual articles for testing
        };
        
        // Add profile_id if selected
        if (selectedProfileId) {
            testRequest.profile_id = selectedProfileId;
            console.log(`Running test with organizational profile ID: ${selectedProfileId}`);
        }
        
        console.log('Test request payload:', testRequest);
        console.log('Articles being tested:', articles.map(a => ({ title: a.title, news_source: a.news_source, category: a.category })));
        
        // Add timeout to prevent infinite waiting (increased for LLM processing)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.error('Test request timed out after 60 seconds');
        }, 60000); // Increased to 60 seconds for LLM processing
        
        console.log('Calling /api/incident-tracking endpoint...');
        
        // Quick connectivity test first
        try {
            console.log('Testing API connectivity...');
            const pingResponse = await fetch('/api/incident-config/defaults', { 
                method: 'GET',
                signal: AbortSignal.timeout(5000) 
            });
            console.log('API connectivity test:', pingResponse.ok ? 'SUCCESS' : 'FAILED');
        } catch (pingError) {
            console.warn('API connectivity test failed:', pingError.message);
        }
        
        // Call the actual incident tracking API
        const response = await fetch('/api/incident-tracking', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testRequest),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        console.log('Response received:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorDetail = errorData.detail || response.statusText;
            console.error('API Error Details:', errorData);
            throw new Error(`API call failed: ${response.status} - ${errorDetail}`);
        }
        
        const result = await response.json();
        console.log('Real incident analysis results:', result);
        
        // Display real results
        if (result.incidents && result.incidents.length > 0) {
            let html = '<div class="alert alert-success py-2 mb-3">';
            html += `<strong>âœ… Real Analysis Complete!</strong> Found ${result.incidents.length} incidents/entities/events from your actual articles`;
            html += '<br><small class="text-muted">This analysis used real articles from your database with your current configuration</small>';
            html += '</div>';
            
            html += '<div class="row g-2">';
            result.incidents.forEach((incident, index) => {
                const typeColor = incident.type === 'incident' ? 'danger' : 
                                 incident.type === 'entity' ? 'primary' : 'success';
                const sigColor = incident.significance === 'high' ? 'danger' : 
                               incident.significance === 'medium' ? 'warning' : 'info';
                
                html += `
                    <div class="col-md-6">
                        <div class="card border-${typeColor} h-100">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 small">${escapeHTML(incident.name || 'Unnamed')}</h6>
                                    <div>
                                        <span class="badge bg-${typeColor}">${incident.type}</span>
                                        <span class="badge bg-${sigColor}">${incident.significance}</span>
                                    </div>
                                </div>
                                <p class="card-text small text-muted mb-2">${escapeHTML(incident.description || 'No description')}</p>
                                
                                ${incident.plausibility ? `
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <strong>Plausibility:</strong> ${incident.plausibility} | 
                                            <strong>Source Quality:</strong> ${incident.source_quality || 'Unknown'}
                                        </small>
                                    </div>
                                ` : ''}
                                
                                ${incident.investigation_leads && incident.investigation_leads.length > 0 ? `
                                    <div class="mb-2">
                                        <small class="text-muted fw-bold">Leads:</small>
                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                            ${incident.investigation_leads.map(lead => `
                                                <span class="badge bg-light text-dark" style="font-size: 9px;">${escapeHTML(lead)}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${incident.article_uris && incident.article_uris.length > 0 ? `
                                    <div class="mb-1">
                                        <small class="text-muted">
                                            <strong>Related Articles:</strong> ${incident.article_uris.length}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Add analysis summary with real data
            html += '<div class="mt-3 alert alert-light">';
            html += '<h6 class="text-primary">Real Analysis Summary</h6>';
            html += `<div class="row text-center">`;
            
            const incidentCount = result.incidents.filter(i => i.type === 'incident').length;
            const entityCount = result.incidents.filter(i => i.type === 'entity').length;
            const eventCount = result.incidents.filter(i => i.type === 'event').length;
            const highSigCount = result.incidents.filter(i => i.significance === 'high').length;
            
            html += `
                <div class="col-3">
                    <div class="h5 text-danger mb-0">${incidentCount}</div>
                    <small class="text-muted">Incidents</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-primary mb-0">${entityCount}</div>
                    <small class="text-muted">Entities</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-success mb-0">${eventCount}</div>
                    <small class="text-muted">Events</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-warning mb-0">${highSigCount}</div>
                    <small class="text-muted">High Priority</small>
                </div>
            `;
            html += '</div></div>';
            
            resultsDiv.innerHTML = html;
            showNotification('Real incident analysis completed successfully!', 'success');
            
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h6>âš ï¸ No Incidents Found in Real Articles</h6>
                    <p class="mb-2">The analysis of your ${articles.length} real articles didn't identify any incidents. This could indicate:</p>
                    <ul class="mb-2">
                        <li>Your current articles don't contain incident-worthy events</li>
                        <li>The ontology or quality guidelines are too restrictive</li>
                        <li>The analysis instructions need adjustment for your content</li>
                    </ul>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Articles analyzed:</strong> ${articles.map(a => a.title.substring(0, 50) + '...').join(', ')}
                        </small>
                    </div>
                </div>
            `;
            showNotification('Real analysis completed but found no incidents', 'warning');
        }
        
    } catch (error) {
        console.error('Error running real test analysis:', error);
        
        let errorMessage = error.message;
        let errorAdvice = 'Check the browser console for detailed error information.';
        
        if (error.name === 'AbortError') {
            errorMessage = 'Request timed out after 60 seconds';
            errorAdvice = 'The LLM analysis is taking longer than expected. This can happen with complex articles or slower AI models. Try using a faster model like gpt-4o-mini or reduce the number of articles.';
        } else if (errorMessage.includes('Failed to fetch')) {
            errorMessage = 'Network connection failed';
            errorAdvice = 'Check if the server is running and accessible. Verify the API endpoint is working.';
        }
        
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>âŒ Real Analysis Failed</h6>
                <p class="mb-2"><strong>Error:</strong> ${errorMessage}</p>
                <p class="mb-2"><small class="text-muted">${errorAdvice}</small></p>
                <p class="mb-2">Falling back to simulated analysis...</p>
            </div>
        `;
        
        // Fallback to simulation if real analysis fails
        setTimeout(() => runSimulatedAnalysis(), 1000);
        
        showNotification('Real analysis failed, using simulation: ' + errorMessage, 'warning');
    }
}

// Run simulated analysis for testing
function runSimulatedAnalysis() {
    const resultsDiv = document.getElementById('testAnalysisResults');
    if (!resultsDiv) return;
    
    // Simulate successful analysis results
    const mockResults = [
        {
            name: "EU AI Regulation Enforcement Action",
            type: "incident",
            description: "European Union implementing stricter AI safety regulations",
            significance: "high",
            investigation_leads: ["EU AI Act timeline", "Compliance costs", "Safety testing"]
        },
        {
            name: "OpenAI GPT-5 Launch",
            type: "event",
            description: "Major AI model release with breakthrough capabilities",
            significance: "high", 
            investigation_leads: ["Performance benchmarks", "Market impact", "Competitive response"]
        },
        {
            name: "Tesla AI Chip Division",
            type: "entity",
            description: "Tesla's semiconductor business unit in AI training chips",
            significance: "medium",
            investigation_leads: ["Chip technology", "Market trends", "Competition"]
        }
    ];
    
    let html = '<div class="alert alert-success py-2 mb-3">';
    html += `<strong>âœ… Test Simulation Complete!</strong> Found ${mockResults.length} classifications`;
    html += '<br><small class="text-muted">This demonstrates how your configuration would classify the sample articles</small>';
    html += '</div>';
    
    html += '<div class="row g-2">';
    mockResults.forEach((result, index) => {
        const typeColor = result.type === 'incident' ? 'danger' : 
                         result.type === 'entity' ? 'primary' : 'success';
        const sigColor = result.significance === 'high' ? 'danger' : 'warning';
        
        html += `
            <div class="col-md-4">
                <div class="card border-${typeColor} h-100">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0 small">${result.name}</h6>
                            <div>
                                <span class="badge bg-${typeColor}">${result.type}</span>
                                <span class="badge bg-${sigColor}">${result.significance}</span>
                            </div>
                        </div>
                        <p class="card-text small text-muted mb-2">${result.description}</p>
                        <div class="mb-2">
                            <small class="text-muted fw-bold">Leads:</small>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                ${result.investigation_leads.map(lead => `
                                    <span class="badge bg-light text-dark" style="font-size: 9px;">${lead}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    // Add summary stats
    const incidentCount = mockResults.filter(r => r.type === 'incident').length;
    const entityCount = mockResults.filter(r => r.type === 'entity').length; 
    const eventCount = mockResults.filter(r => r.type === 'event').length;
    
    html += `
        <div class="mt-3 alert alert-light">
            <div class="row text-center">
                <div class="col-4">
                    <div class="h5 text-danger mb-0">${incidentCount}</div>
                    <small class="text-muted">Incidents</small>
                </div>
                <div class="col-4">
                    <div class="h5 text-primary mb-0">${entityCount}</div>
                    <small class="text-muted">Entities</small>
                </div>
                <div class="col-4">
                    <div class="h5 text-success mb-0">${eventCount}</div>
                    <small class="text-muted">Events</small>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
    showNotification('Test simulation completed successfully!', 'success');
}

// Run another test helper
function runAnotherTest() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('testResultsModal'));
    if (modal) modal.hide();
    setTimeout(() => testWithSampleArticles(), 500);
}

// Show guidance examples
function showGuidanceExamples() {
    const examples = `
ANALYSIS QUALITY EXAMPLES:

Good Analysis:
- "Patent lawsuit filed by TechCorp against StartupAI for alleged IP infringement of neural network architecture patents filed 2019-2021"
- Significance: high (potential injunction could halt product development)
- Investigation leads: ["TechCorp patent portfolio analysis", "StartupAI product roadmap impact"]

Poor Analysis:
- "Legal issue between companies"
- Significance: unknown
- Investigation leads: []

CLASSIFICATION EXAMPLES:

Incident (Material Impact):
- Data breach exposing customer information
- Regulatory action resulting in fines
- Major layoffs or restructuring
- Significant funding cuts

Event (Informational):
- Product feature announcement
- Conference presentation
- Partnership MOU signing
- Award recognition
`;

    // Show examples in modal
    const examplesModal = document.createElement('div');
    examplesModal.innerHTML = `
        <div class="modal fade" id="guidanceExamplesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Analysis Guidance Examples</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <pre style="white-space: pre-wrap; font-size: 12px;">${examples}</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(examplesModal);
    const modal = new bootstrap.Modal(examplesModal.querySelector('.modal'));
    modal.show();
    
    // Clean up when modal is closed
    examplesModal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(examplesModal);
    });
}

// Get the currently selected organizational profile
async function getCurrentOrganizationalProfile() {
    try {
        const profileSelect = document.getElementById('profile-select');
        if (!profileSelect || !profileSelect.value) {
            return null;
        }
        
        const profileId = profileSelect.value;
        const response = await fetch('/api/organizational-profiles');
        const data = await response.json();
        
        if (data.success && data.profiles) {
            const profile = data.profiles.find(p => p.id.toString() === profileId);
            if (profile) {
                console.log('Found current organizational profile:', profile.name);
                return profile;
            }
        }
        
        return null;
    } catch (error) {
        console.error('Error getting current organizational profile:', error);
        return null;
    }
}

// Generate profile context from profile data
function generateProfileContextFromData(profile) {
    if (!profile) return DEFAULT_PROFILE_CONTEXT_TEMPLATE;
    
    // Convert arrays to comma-separated strings
    const keyConcerns = Array.isArray(profile.key_concerns) ? profile.key_concerns.join(', ') : (profile.key_concerns || '');
    const strategicPriorities = Array.isArray(profile.strategic_priorities) ? profile.strategic_priorities.join(', ') : (profile.strategic_priorities || '');
    const stakeholderFocus = Array.isArray(profile.stakeholder_focus) ? profile.stakeholder_focus.join(', ') : (profile.stakeholder_focus || '');
    const competitiveLandscape = Array.isArray(profile.competitive_landscape) ? profile.competitive_landscape.join(', ') : (profile.competitive_landscape || '');
    const regulatoryEnvironment = Array.isArray(profile.regulatory_environment) ? profile.regulatory_environment.join(', ') : (profile.regulatory_environment || '');
    
    return `ORGANIZATIONAL CONTEXT:
Organization: ${profile.name} (${profile.organization_type || 'Organization'} in ${profile.industry || 'General'})
Region: ${profile.region || 'Not specified'}
Risk Tolerance: ${profile.risk_tolerance || 'Medium'} | Innovation Appetite: ${profile.innovation_appetite || 'Moderate'}
Decision Making: ${profile.decision_making_style || 'Collaborative'}

Key Concerns: ${keyConcerns || 'General business concerns'}
Strategic Priorities: ${strategicPriorities || 'Growth and sustainability'}
Key Stakeholders: ${stakeholderFocus || 'Customers and employees'}
Competitive Landscape: ${competitiveLandscape || 'Industry competitors'}
Regulatory Environment: ${regulatoryEnvironment || 'Standard regulations'}

Custom Context: ${profile.custom_context || 'No additional context specified'}

ANALYSIS INSTRUCTIONS:
- Prioritize incidents and events that align with ${profile.name}'s key concerns: ${keyConcerns}
- Assess significance based on ${profile.risk_tolerance || 'medium'} risk tolerance and ${profile.decision_making_style || 'collaborative'} decision-making style
- Consider impact on key stakeholders: ${stakeholderFocus}
- Account for competitive positioning relative to: ${competitiveLandscape}
- Evaluate regulatory implications considering: ${regulatoryEnvironment}
- Tailor investigation leads to ${profile.industry || 'industry'} context and organizational priorities`;
}

// Show current profile information in the modal
function showCurrentProfileInfo(profile) {
    // Add profile info section to the modal if profile exists
    const promptPanel = document.getElementById('prompt-panel');
    if (promptPanel && profile) {
        // Check if profile info already exists
        let profileInfo = promptPanel.querySelector('.current-profile-info');
        if (!profileInfo) {
            profileInfo = document.createElement('div');
            profileInfo.className = 'current-profile-info alert alert-success py-2 mb-3';
            promptPanel.insertBefore(profileInfo, promptPanel.firstChild);
        }
        
        profileInfo.innerHTML = `
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <strong><i class="fas fa-building me-2"></i>Using Profile: ${profile.name}</strong>
                    <small class="d-block text-muted">${profile.industry || 'General'} â€¢ ${profile.organization_type || 'Organization'} â€¢ ${profile.risk_tolerance || 'Medium'} Risk Tolerance</small>
                </div>
                <button class="btn btn-outline-success btn-sm" onclick="refreshProfileIntegration()" title="Refresh profile integration">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
            </div>
        `;
    } else if (promptPanel) {
        // Remove profile info if no profile selected
        const existingInfo = promptPanel.querySelector('.current-profile-info');
        if (existingInfo) {
            existingInfo.remove();
        }
    }
}

// Incident view and sorting functions
let currentIncidentView = 'cards';
let currentIncidentSort = 'significance_desc';

function toggleIncidentView(viewType) {
    currentIncidentView = viewType;
    
    // Update button states
    document.getElementById('incident-card-view-btn').classList.toggle('active', viewType === 'cards');
    document.getElementById('incident-table-view-btn').classList.toggle('active', viewType === 'table');
    
    // Re-render with current view
    if (allIncidents.length > 0) {
        const filteredIncidents = applyIncidentFilters(allIncidents);
        renderIncidentTrackingFiltered(filteredIncidents);
    }
}

function handleIncidentSortChange() {
    currentIncidentSort = document.getElementById('incident-sort-select').value;
    
    // Re-render with new sort order
    if (allIncidents.length > 0) {
        const filteredIncidents = applyIncidentFilters(allIncidents);
        renderIncidentTrackingFiltered(filteredIncidents);
    }
}

function sortIncidents(incidents) {
    return incidents.sort((a, b) => {
        switch (currentIncidentSort) {
            case 'significance_desc':
                const sigOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                return (sigOrder[b.significance] || 0) - (sigOrder[a.significance] || 0);
            case 'significance_asc':
                const sigOrderAsc = { 'high': 3, 'medium': 2, 'low': 1 };
                return (sigOrderAsc[a.significance] || 0) - (sigOrderAsc[b.significance] || 0);
            case 'type_asc':
                return (a.type || '').localeCompare(b.type || '');
            case 'type_desc':
                return (b.type || '').localeCompare(a.type || '');
            case 'name_asc':
                return (a.name || '').localeCompare(b.name || '');
            case 'name_desc':
                return (b.name || '').localeCompare(a.name || '');
            case 'entity_asc':
                const entityA = extractPrimaryEntity(a);
                const entityB = extractPrimaryEntity(b);
                return entityA.localeCompare(entityB);
            case 'entity_desc':
                const entityDescA = extractPrimaryEntity(a);
                const entityDescB = extractPrimaryEntity(b);
                return entityDescB.localeCompare(entityDescA);
            case 'timeline_desc':
                const aDate = Array.isArray(a.timeline) && a.timeline.length > 0 ? new Date(a.timeline[0]) : new Date(0);
                const bDate = Array.isArray(b.timeline) && b.timeline.length > 0 ? new Date(b.timeline[0]) : new Date(0);
                return bDate - aDate;
            case 'timeline_asc':
                const aDateAsc = Array.isArray(a.timeline) && a.timeline.length > 0 ? new Date(a.timeline[0]) : new Date(0);
                const bDateAsc = Array.isArray(b.timeline) && b.timeline.length > 0 ? new Date(b.timeline[0]) : new Date(0);
                return aDateAsc - bDateAsc;
            default:
                return 0;
        }
    });
}

function renderIncidentTable(incidents) {
    const container = document.getElementById('incident-tracking-container');

    if (!incidents || incidents.length === 0) {
        container.innerHTML = '<div class="text-muted p-2 small w-100 text-center">No incidents match the current filters.</div>';
        return;
    }

    // Check if we should group by entity (when entity sorting is selected)
    const sortSelect = document.getElementById('incident-sort-select');
    const currentSort = sortSelect ? sortSelect.value : 'significance_desc';
    const groupByEntity = currentSort.startsWith('entity_');

    console.log('Table render - Sort:', currentSort, 'Group by entity:', groupByEntity, 'View:', currentIncidentView);

    if (groupByEntity) {
        renderTableGroupedByEntity(incidents, container);
    } else {
        renderTableUngrouped(incidents, container);
    }
}

function renderTableGroupedByEntity(incidents, container) {
    // Group incidents by entity
    console.log('Grouping incidents for table view:', incidents.length);
    const entityGroups = groupIncidentsByEntity(incidents);
    console.log('Created entity groups:', entityGroups.length, entityGroups);

    let html = `
        <div class="table-responsive">
            <table class="table table-hover table-sm" style="min-width: 1400px;">
                <thead class="table-light sticky-top">
                    <tr>
                        <th style="width: 250px; min-width: 250px;">Entity/Incident</th>
                        <th style="width: 80px; min-width: 80px;">Type</th>
                        <th style="width: 90px; min-width: 90px;">Significance</th>
                        <th style="width: 120px; min-width: 120px;">Timeline</th>
                        <th style="width: 140px; min-width: 140px;">MBFC Quality</th>
                        <th style="width: 400px; min-width: 400px;">Description</th>
                        <th style="width: 120px; min-width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    entityGroups.forEach((group, groupIndex) => {
        // Entity group header row
        const significanceBadgeColor = group.maxSignificance === 'high' ? 'danger' :
                                     group.maxSignificance === 'medium' ? 'warning' : 'info';

        html += `
            <tr class="table-primary" style="background: linear-gradient(135deg, #e3f2fd 0%, var(--colors-neutral-2) 100%);">
                <td colspan="8">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-building me-2"></i>
                            <strong>${escapeHTML(group.entityName)}</strong>
                            <span class="badge bg-${significanceBadgeColor} ms-2">${group.maxSignificance.toUpperCase()}</span>
                            <small class="text-muted ms-2">
                                ${group.incidents.length} incident${group.incidents.length !== 1 ? 's' : ''} â€¢
                                ${group.totalArticles} article${group.totalArticles !== 1 ? 's' : ''}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTableGroupExpansion('entity-group-${groupIndex}')">
                            <i class="fas fa-chevron-down" id="entity-group-${groupIndex}-icon"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;

        // Entity incidents (collapsible)
        html += `<tbody id="entity-group-${groupIndex}" class="collapse show">`;

        group.incidents.forEach(incident => {
            html += renderTableRow(incident, true);
        });

        html += `</tbody>`;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // Initialize Bootstrap tooltips
    setTimeout(() => {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }, 100);
}

function renderTableUngrouped(incidents, container) {
    let html = `
        <div class="table-responsive">
            <table class="table table-hover table-sm" style="min-width: 1400px;">
                <thead class="table-light sticky-top">
                    <tr>
                        <th style="width: 250px; min-width: 250px;">Name</th>
                        <th style="width: 80px; min-width: 80px;">Type</th>
                        <th style="width: 90px; min-width: 90px;">Significance</th>
                        <th style="width: 120px; min-width: 120px;">Timeline</th>
                        <th style="width: 140px; min-width: 140px;">MBFC Quality</th>
                        <th style="width: 400px; min-width: 400px;">Description</th>
                        <th style="width: 120px; min-width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    incidents.forEach((incident, index) => {
        html += renderTableRow(incident, false);
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // Initialize Bootstrap tooltips
    setTimeout(() => {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }, 100);
}

// Render individual table row
function renderTableRow(incident, isGrouped = false) {
    const typeBadgeColor = incident.type === 'incident' ? 'danger' :
                          incident.type === 'entity' ? 'primary' :
                          incident.type === 'expertise' ? 'warning' :
                          incident.type === 'informed_insider' ? 'dark' :
                          incident.type === 'trend_signal' ? 'info' :
                          incident.type === 'strategic_shift' ? 'secondary' : 'success';
    const significanceBadgeColor = incident.significance === 'high' ? 'danger' :
                                 incident.significance === 'medium' ? 'warning' : 'info';

    const plausibility = String(incident.plausibility || '').toLowerCase();
    const sourceQuality = String(incident.source_quality || '').toLowerCase();

    // Helper function to format dates to human-readable format
    function formatTimelineDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return dateStr;

        // Check if it looks like an ISO date (contains T and ends with Z or timezone)
        if (dateStr.includes('T') && (dateStr.endsWith('Z') || /[+-]\d{2}:\d{2}$/.test(dateStr))) {
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {
                console.warn('Error formatting date:', dateStr, e);
            }
        }

        return dateStr; // Return original if not a recognizable ISO date
    }

    // Timeline display - handle both arrays and strings with date formatting
    let timelineDisplay = '';
    if (Array.isArray(incident.timeline) && incident.timeline.length > 0) {
        const validDates = incident.timeline.filter(Boolean);
        if (validDates.length > 0) {
            const start = formatTimelineDate(validDates[0]);
            const end = formatTimelineDate(validDates[validDates.length - 1]);
            timelineDisplay = start === end ? start : `${start} â†’ ${end}`;
        }
    } else if (typeof incident.timeline === 'string' && incident.timeline.trim()) {
        timelineDisplay = formatTimelineDate(incident.timeline.trim());
    } else if (incident.timeline && incident.timeline.summary) {
        timelineDisplay = formatTimelineDate(incident.timeline.summary);
    }

    // MBFC Quality indicators - consistent format for both real and AI-derived
    let qualityHtml = '';
    let hasRealMBFC = false;
    let isLowQuality = false;

    // Check if we have real MBFC data
    if (incident.article_uris && incident.article_uris.length > 0) {
        const firstUri = incident.article_uris[0];
        const article = window.lastArticlesData?.items?.find(a => a.uri === firstUri);
        if (article && (article.factual_reporting || article.mbfc_credibility_rating || article.bias)) {
            hasRealMBFC = true;

            // Check for low quality indicators
            const factual = (article.factual_reporting || '').toLowerCase();
            const mbfc = (article.mbfc_credibility_rating || '').toLowerCase();
            const bias = (article.bias || '').toLowerCase();

            isLowQuality = factual.includes('low') || factual.includes('mixed') ||
                          mbfc.includes('low') || mbfc.includes('mixed') ||
                          bias.includes('extreme') || bias.includes('conspiracy') || bias.includes('fringe');

            // Consistent badge format for real MBFC data with full labels
            const factualBadge = article.factual_reporting ?
                `<span class="badge ${getFactualityClass(article.factual_reporting)}" title="MBFC Factual Reporting">${article.factual_reporting}</span>` : '';
            const mbfcBadge = article.mbfc_credibility_rating ?
                `<span class="badge ${getMBFCCredibilityClass(article.mbfc_credibility_rating)}" title="MBFC Credibility Rating">${article.mbfc_credibility_rating}</span>` : '';
            const biasBadge = article.bias ?
                `<span class="badge ${getBiasClass(article.bias)}" title="MBFC Bias Rating">${article.bias}</span>` : '';

            qualityHtml = [factualBadge, mbfcBadge, biasBadge].filter(Boolean).join('<br>');
        } else {
            // Article found but no MBFC data - flag as AI-rated
            hasRealMBFC = false;
        }
    }

    // AI-derived quality if no real MBFC data - use same format as MBFC
    if (!hasRealMBFC) {
        // Check if AI-derived quality indicates low quality
        isLowQuality = sourceQuality === 'low' || plausibility === 'implausible' ||
                      (Array.isArray(incident.misinfo_flags) && incident.misinfo_flags.some(f =>
                          f.includes('low_factuality') || f.includes('low_credibility') || f.includes('fringe_bias')));

        // Convert AI-derived ratings to MBFC-equivalent format with proper capitalization
        const aiFactualRating = sourceQuality === 'high' ? 'High' :
                               sourceQuality === 'mixed' ? 'Mixed' : 'Low';
        const aiCredibilityRating = plausibility === 'likely' ? 'High' :
                                   plausibility === 'questionable' ? 'Mixed' : 'Low';
        let aiBiasRating = 'Least Biased'; // Default assumption unless flags indicate otherwise

        // Check for bias flags
        if (Array.isArray(incident.misinfo_flags) && incident.misinfo_flags.some(f => f.includes('fringe_bias'))) {
            aiBiasRating = 'Mixed Bias';
        }

        // Use same badge format as real MBFC but with AI indicator
        const factualBadge = `<span class="badge ${getFactualityClass(aiFactualRating)}" title="ðŸ“Š AI-derived factual assessment (no MBFC data)">ðŸ“Š ${aiFactualRating}</span>`;
        const credibilityBadge = `<span class="badge ${getMBFCCredibilityClass(aiCredibilityRating)}" title="ðŸ“Š AI-derived credibility assessment (no MBFC data)">ðŸ“Š ${aiCredibilityRating}</span>`;
        const biasBadge = `<span class="badge ${getBiasClass(aiBiasRating)}" title="ðŸ“Š AI-derived bias assessment (no MBFC data)">ðŸ“Š ${aiBiasRating}</span>`;

        qualityHtml = [factualBadge, credibilityBadge, biasBadge].join('<br>');
    }

    const status = incident.status || 'active';
    let rowClass = status === 'seen' ? 'opacity-75' : '';

    // Add highlighting for low quality incidents in table view
    if (isLowQuality) {
        rowClass += ' table-danger';
    }

    // Why significant explanation
    const whySignificant = incident.organizational_relevance ||
                          incident.credibility_summary ||
                          `${incident.significance || 'medium'} significance incident`;

    const namePrefix = isGrouped ? '&nbsp;&nbsp;â†³ ' : '';

    return `
        <tr class="${rowClass}">
            <td>
                ${namePrefix}<strong>${escapeHTML(incident.name || 'Unnamed Incident')}</strong>
                ${status === 'seen' ? `<br><span class="badge bg-secondary"><i class="fas fa-eye me-1"></i>Seen</span>` : ''}
            </td>
            <td><span class="badge bg-${typeBadgeColor}">${incident.type || 'Unknown'}</span></td>
            <td><span class="badge bg-${significanceBadgeColor}">${incident.significance || 'Unknown'}</span></td>
            <td><small>${timelineDisplay || 'No timeline'}</small></td>
            <td>${qualityHtml || '<small class="text-muted">No quality data</small>'}</td>
            <td>
                <div data-bs-toggle="tooltip" data-bs-placement="top" title="${escapeHTML(whySignificant)}" style="cursor: help;">
                    <small>${escapeHTML((incident.description || 'No description available.').substring(0, 80))}${(incident.description || '').length > 80 ? '...' : ''}</small>
                    ${incident.article_uris && incident.article_uris.length > 0 ? `
                        <br><a href="${incident.article_uris[0]}" target="_blank" rel="noopener" class="small text-primary text-decoration-none">
                            <i class="fas fa-external-link-alt me-1"></i>View Article
                        </a>
                    ` : ''}
                </div>
            </td>
            <td>
                <div class="d-grid gap-1" style="grid-template-columns: 1fr 1fr; max-width: 120px;">
                    <button class="btn btn-outline-primary btn-sm" onclick="launchAuspexResearchFromInsight('${escapeHTML(incident.name)}', 'incident')" title="Investigate">
                        <i class="fas fa-search"></i>
                    </button>
                    ${incident.article_uris && incident.article_uris.length > 0 ? `
                        <button class="btn btn-outline-success btn-sm" onclick="openAnnotationModal('${incident.article_uris[0]}')" title="Annotate">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                    ` : `
                        <div></div>
                    `}
                    ${status !== 'seen' ? `
                        <button class="btn btn-outline-info btn-sm" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'seen')" title="Mark as seen">
                            <i class="fas fa-eye"></i>
                        </button>
                    ` : `
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateIncidentStatus('${escapeHTML(incident.name)}', 'active')" title="Mark as unseen">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    `}
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteIncident('${escapeHTML(incident.name)}')" title="Delete incident">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// Table group expansion toggle
function toggleTableGroupExpansion(groupId) {
    const groupBody = document.getElementById(groupId);
    const icon = document.getElementById(groupId + '-icon');

    if (groupBody.classList.contains('show')) {
        groupBody.classList.remove('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    } else {
        groupBody.classList.add('show');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    }
}

// Refresh profile integration
async function refreshProfileIntegration() {
    try {
        showNotification('Refreshing organizational profile integration...', 'info');
        
        const currentProfile = await getCurrentOrganizationalProfile();
        if (currentProfile) {
            // Update the profile context template with current profile data
            const generatedContext = generateProfileContextFromData(currentProfile);
            document.getElementById('profileContextTemplate').value = generatedContext;
            
            // Update the profile info display
            showCurrentProfileInfo(currentProfile);
            
            showNotification(`Profile integration updated: ${currentProfile.name}`, 'success');
        } else {
            // Reset to default template if no profile selected
            document.getElementById('profileContextTemplate').value = DEFAULT_PROFILE_CONTEXT_TEMPLATE;
            showCurrentProfileInfo(null);
            
            showNotification('No profile selected - using default template', 'info');
        }
    } catch (error) {
        console.error('Error refreshing profile integration:', error);
        showNotification('Failed to refresh profile integration: ' + error.message, 'error');
    }
}

// ============================================
// NEWS TICKER MODULE
// ============================================

/**
 * News Ticker Module
 * Provides horizontally scrolling news ticker with full configurability
 */
const NewsTicker = (function() {
    'use strict';

    // ============================================
    // CONSTANTS
    // ============================================

    const DEFAULTS = {
        count: 10,
        timeRange: '24h',
        topic: '',
        speed: 'lazy',
        refreshInterval: 300, // seconds
        showSource: true,
        showTime: true,
        showTopic: false,
        enabled: true
    };

    const SPEED_MAP = {
        'lazy': 120,   // 120 seconds per cycle
        'slow': 90,    // 90 seconds per cycle
        'medium': 60,  // 60 seconds per cycle
        'fast': 30     // 30 seconds per cycle
    };

    const API_ENDPOINT = '/api/news-feed/articles';
    const STORAGE_KEY = 'newsFeedTickerSettings';
    const CACHE_KEY = 'tickerArticlesCache';
    const CACHE_DURATION = 60000; // 1 minute in milliseconds

    // ============================================
    // STATE
    // ============================================

    const state = {
        articles: [],
        isPaused: false,
        isVisible: false,
        refreshTimer: null,
        settings: { ...DEFAULTS },
        cache: {
            data: null,
            timestamp: 0
        }
    };

    // DOM references (cached for performance)
    const dom = {
        container: null,
        content: null,
        loading: null,
        empty: null,
        pauseBtn: null,
        pauseIcon: null
    };

    // ============================================
    // INITIALIZATION
    // ============================================

    function init() {
        console.log('[Ticker] Initializing...');

        // Cache DOM references
        if (!cacheDOMReferences()) {
            console.error('[Ticker] Failed to cache DOM references');
            return;
        }

        // Load saved settings
        loadSettings();

        // Load topics for filter dropdown
        loadTopics();

        // Set up event listeners
        setupEventListeners();

        // Initialize ticker if enabled
        if (state.settings.enabled) {
            show();
            loadArticles();
            setupAutoRefresh();
        } else {
            // Ticker is disabled, show the "Show Ticker" button
            const showBtn = document.getElementById('show-ticker-btn');
            if (showBtn) showBtn.style.display = 'block';
        }

        console.log('[Ticker] Initialization complete');
    }

    function cacheDOMReferences() {
        dom.container = document.getElementById('news-ticker');
        dom.content = document.getElementById('ticker-content');
        dom.loading = document.getElementById('ticker-loading');
        dom.empty = document.getElementById('ticker-empty');
        dom.pauseBtn = document.getElementById('ticker-pause-btn');
        dom.pauseIcon = document.getElementById('ticker-pause-icon');

        return !!(dom.container && dom.content);
    }

    function setupEventListeners() {
        // Keyboard shortcuts
        document.addEventListener('keydown', handleKeyboard);

        // Visibility change (pause when tab hidden)
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanup);

        // Hover pause/resume
        if (dom.content) {
            dom.content.addEventListener('mouseenter', () => {
                if (!state.isPaused) {
                    dom.content.style.animationPlayState = 'paused';
                }
            });

            dom.content.addEventListener('mouseleave', () => {
                if (!state.isPaused) {
                    dom.content.style.animationPlayState = 'running';
                }
            });
        }
    }

    // ============================================
    // ARTICLE LOADING
    // ============================================

    async function loadArticles() {
        console.log('[Ticker] Loading articles...', state.settings);

        // Check cache first
        if (isCacheValid()) {
            console.log('[Ticker] Using cached articles');
            state.articles = state.cache.data;
            render();
            return;
        }

        showLoading();

        try {
            const params = new URLSearchParams({
                per_page: state.settings.count,
                page: '1'
            });

            // Add time range filter using the date_range parameter
            if (state.settings.timeRange) {
                params.append('date_range', state.settings.timeRange);
            } else {
                params.append('date_range', '7d');  // Default to 7 days
            }

            // Add topic filter
            if (state.settings.topic) {
                params.append('topic', state.settings.topic);
            }

            const url = `${API_ENDPOINT}?${params}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            // Handle news-feed API response structure
            state.articles = data.articles?.items || data.articles || [];

            // Update cache
            state.cache.data = state.articles;
            state.cache.timestamp = Date.now();

            // Persist cache to sessionStorage for page reloads
            try {
                sessionStorage.setItem(CACHE_KEY, JSON.stringify({
                    data: state.articles,
                    timestamp: state.cache.timestamp
                }));
            } catch (e) {
                console.warn('[Ticker] Failed to cache articles:', e);
            }

            console.log(`[Ticker] Loaded ${state.articles.length} articles`);
            render();

        } catch (error) {
            console.error('[Ticker] Failed to load articles:', error);
            handleError(error);
        } finally {
            hideLoading();
        }
    }

    function parseTimeRange(range) {
        const map = {
            '1h': 1,
            '6h': 6,
            '24h': 24,
            '72h': 72,
            '7d': 168
        };
        return map[range] || 24;
    }

    function isCacheValid() {
        if (!state.cache.data || !state.cache.timestamp) {
            return false;
        }

        const age = Date.now() - state.cache.timestamp;
        return age < CACHE_DURATION;
    }

    // ============================================
    // RENDERING
    // ============================================

    function render() {
        if (!dom.content) return;

        if (!state.articles || state.articles.length === 0) {
            showEmpty();
            return;
        }

        hideEmpty();

        // Build HTML for ticker items
        const items = state.articles.map(article => renderArticle(article)).join('');

        // Duplicate for seamless loop
        dom.content.innerHTML = items + items;

        // Update animation speed
        updateSpeed();

        // Announce to screen readers (first article only, to avoid spam)
        if (state.articles[0]) {
            announceNewArticles(state.articles[0]);
        }
    }

    function renderArticle(article) {
        const time = state.settings.showTime ?
            `<span class="ticker-time">${formatTime(article.publication_date)}</span>` : '';

        const source = state.settings.showSource && article.news_source ?
            `<span class="ticker-source">${escapeHtml(article.news_source)}</span>` : '';

        const topic = state.settings.showTopic && article.topic ?
            `<span class="ticker-topic">${escapeHtml(article.topic)}</span>` : '';

        const url = article.uri || article.url || '#';
        const title = escapeHtml(article.title || 'Untitled');

        return `
            <div class="ticker-item">
                <a href="${escapeHtml(url)}"
                   target="_blank"
                   rel="noopener noreferrer"
                   aria-label="Read article: ${title}">
                    ${time}
                    <span>${title}</span>
                    ${source}
                    ${topic}
                </a>
            </div>
        `;
    }

    function updateSpeed() {
        if (!dom.content) return;

        const duration = SPEED_MAP[state.settings.speed] || 60;
        dom.content.style.animationDuration = `${duration}s`;
    }

    // ============================================
    // UI STATE MANAGEMENT
    // ============================================

    function show() {
        if (dom.container) {
            dom.container.classList.add('visible');
            state.isVisible = true;
            state.settings.enabled = true;
            saveSettings();
            // Hide the show button
            const showBtn = document.getElementById('show-ticker-btn');
            if (showBtn) showBtn.style.display = 'none';
        }
    }

    function hide() {
        if (dom.container) {
            dom.container.classList.remove('visible');
            state.isVisible = false;
            // Show the show button
            const showBtn = document.getElementById('show-ticker-btn');
            if (showBtn) showBtn.style.display = 'block';
        }
    }

    function showLoading() {
        if (dom.loading) dom.loading.style.display = 'block';
        if (dom.empty) dom.empty.style.display = 'none';
        if (dom.content) dom.content.style.display = 'none';
    }

    function hideLoading() {
        if (dom.loading) dom.loading.style.display = 'none';
        if (dom.content) dom.content.style.display = 'inline-flex';
    }

    function showEmpty() {
        if (dom.empty) dom.empty.style.display = 'block';
        if (dom.content) dom.content.style.display = 'none';
    }

    function hideEmpty() {
        if (dom.empty) dom.empty.style.display = 'none';
    }

    // ============================================
    // CONTROLS
    // ============================================

    function pauseResume() {
        if (!dom.content || !dom.pauseIcon) return;

        state.isPaused = !state.isPaused;

        if (state.isPaused) {
            dom.content.classList.add('paused');
            dom.pauseIcon.classList.remove('fa-pause');
            dom.pauseIcon.classList.add('fa-play');
            if (dom.pauseBtn) dom.pauseBtn.setAttribute('aria-label', 'Resume ticker');
        } else {
            dom.content.classList.remove('paused');
            dom.pauseIcon.classList.remove('fa-play');
            dom.pauseIcon.classList.add('fa-pause');
            if (dom.pauseBtn) dom.pauseBtn.setAttribute('aria-label', 'Pause ticker');
        }
    }

    function toggle() {
        if (state.isVisible) {
            hide();
            state.settings.enabled = false;
        } else {
            show();
            state.settings.enabled = true;
        }
        saveSettings();
    }

    function refresh() {
        // Invalidate cache
        state.cache.data = null;
        state.cache.timestamp = 0;

        // Reload
        loadArticles();
    }

    // ============================================
    // SETTINGS
    // ============================================

    function loadSettings() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state.settings = { ...DEFAULTS, ...parsed };
                console.log('[Ticker] Settings loaded:', state.settings);
            }
        } catch (error) {
            console.error('[Ticker] Failed to load settings:', error);
        }
    }

    function saveSettings() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.settings));
            console.log('[Ticker] Settings saved');
        } catch (error) {
            console.error('[Ticker] Failed to save settings:', error);
        }
    }

    function showSettings() {
        // Populate form with current settings
        const form = {
            count: document.getElementById('ticker-article-count'),
            timeRange: document.getElementById('ticker-time-range'),
            topic: document.getElementById('ticker-topic-filter'),
            speed: document.getElementById('ticker-speed'),
            refresh: document.getElementById('ticker-refresh-interval'),
            showSource: document.getElementById('ticker-show-source'),
            showTime: document.getElementById('ticker-show-time'),
            showTopic: document.getElementById('ticker-show-topic'),
            enabled: document.getElementById('ticker-enabled')
        };

        if (form.count) form.count.value = state.settings.count;
        if (form.timeRange) form.timeRange.value = state.settings.timeRange;
        if (form.topic) form.topic.value = state.settings.topic;
        if (form.speed) form.speed.value = state.settings.speed;
        if (form.refresh) form.refresh.value = state.settings.refreshInterval;
        if (form.showSource) form.showSource.checked = state.settings.showSource;
        if (form.showTime) form.showTime.checked = state.settings.showTime;
        if (form.showTopic) form.showTopic.checked = state.settings.showTopic;
        if (form.enabled) form.enabled.checked = state.settings.enabled;

        // Show modal
        const modalEl = document.getElementById('tickerSettingsModal');
        if (modalEl && typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    }

    function saveSettingsFromModal() {
        // Get values from form
        const form = {
            count: document.getElementById('ticker-article-count'),
            timeRange: document.getElementById('ticker-time-range'),
            topic: document.getElementById('ticker-topic-filter'),
            speed: document.getElementById('ticker-speed'),
            refresh: document.getElementById('ticker-refresh-interval'),
            showSource: document.getElementById('ticker-show-source'),
            showTime: document.getElementById('ticker-show-time'),
            showTopic: document.getElementById('ticker-show-topic'),
            enabled: document.getElementById('ticker-enabled')
        };

        state.settings.count = parseInt(form.count?.value || DEFAULTS.count);
        state.settings.timeRange = form.timeRange?.value || DEFAULTS.timeRange;
        state.settings.topic = form.topic?.value || '';
        state.settings.speed = form.speed?.value || DEFAULTS.speed;
        state.settings.refreshInterval = parseInt(form.refresh?.value || DEFAULTS.refreshInterval);
        state.settings.showSource = form.showSource?.checked ?? DEFAULTS.showSource;
        state.settings.showTime = form.showTime?.checked ?? DEFAULTS.showTime;
        state.settings.showTopic = form.showTopic?.checked ?? DEFAULTS.showTopic;
        state.settings.enabled = form.enabled?.checked ?? DEFAULTS.enabled;

        // Save to storage
        saveSettings();

        // Apply changes
        if (state.settings.enabled && !state.isVisible) {
            show();
        } else if (!state.settings.enabled && state.isVisible) {
            hide();
        }

        // Reload articles with new settings
        refresh();

        // Update auto-refresh
        setupAutoRefresh();

        // Close modal
        const modalEl = document.getElementById('tickerSettingsModal');
        if (modalEl && typeof bootstrap !== 'undefined') {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        }

        // Show notification
        if (typeof showNotification === 'function') {
            showNotification('Ticker settings saved', 'success');
        }
    }

    function resetSettings() {
        if (!confirm('Reset all ticker settings to defaults?')) {
            return;
        }

        state.settings = { ...DEFAULTS };
        saveSettings();

        // Reload modal if open
        showSettings();

        // Reload ticker
        refresh();
        setupAutoRefresh();
    }

    // ============================================
    // AUTO-REFRESH
    // ============================================

    function setupAutoRefresh() {
        // Clear existing timer
        if (state.refreshTimer) {
            clearInterval(state.refreshTimer);
            state.refreshTimer = null;
        }

        // Set up new timer if enabled
        if (state.settings.refreshInterval > 0) {
            state.refreshTimer = setInterval(
                loadArticles,
                state.settings.refreshInterval * 1000
            );
            console.log(`[Ticker] Auto-refresh enabled: ${state.settings.refreshInterval}s`);
        }
    }

    // ============================================
    // TOPICS
    // ============================================

    async function loadTopics() {
        try {
            const response = await fetch('/api/topics');
            if (!response.ok) return;

            const topics = await response.json();
            const select = document.getElementById('ticker-topic-filter');

            if (!select) return;

            // Clear existing options (except "All Topics")
            while (select.options.length > 1) {
                select.remove(1);
            }

            // Add topic options
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.name;
                option.textContent = topic.name;
                select.appendChild(option);
            });

            console.log(`[Ticker] Loaded ${topics.length} topics`);

        } catch (error) {
            console.error('[Ticker] Failed to load topics:', error);
        }
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================

    function handleKeyboard(event) {
        // Only handle when ticker is visible
        if (!state.isVisible) return;

        // Ignore if user is typing in input
        if (event.target.matches('input, textarea, select')) {
            return;
        }

        switch (event.key) {
            case ' ':  // Space = pause/resume
                event.preventDefault();
                pauseResume();
                break;
            case 'Escape':  // Esc = hide
                event.preventDefault();
                hide();
                break;
        }
    }

    function handleVisibilityChange() {
        if (document.hidden) {
            if (dom.content && !state.isPaused) {
                dom.content.style.animationPlayState = 'paused';
            }
        } else {
            if (dom.content && !state.isPaused) {
                dom.content.style.animationPlayState = 'running';
            }
        }
    }

    function handleError(error) {
        console.error('[Ticker] Error:', error);

        // Show error in ticker
        if (dom.content) {
            dom.content.innerHTML = `
                <div class="ticker-item">
                    <span style="color: #ff6b6b;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load articles. Click Refresh to try again.
                    </span>
                </div>
            `;
        }
    }

    // ============================================
    // UTILITIES
    // ============================================

    function formatTime(timestamp) {
        if (!timestamp) return '';

        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'just now';
        if (diffMins === 1) return '1m ago';
        if (diffMins < 60) return `${diffMins}m ago`;

        const diffHours = Math.floor(diffMins / 60);
        if (diffHours === 1) return '1h ago';
        if (diffHours < 24) return `${diffHours}h ago`;

        const diffDays = Math.floor(diffHours / 24);
        if (diffDays === 1) return '1d ago';
        if (diffDays < 7) return `${diffDays}d ago`;

        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function announceNewArticles(firstArticle) {
        if (!firstArticle || !dom.container) return;

        const liveRegion = dom.container.querySelector('[aria-live]');
        if (liveRegion) {
            // Update aria-label to announce new content
            const announcement = `Latest article: ${firstArticle.title}`;
            liveRegion.setAttribute('aria-label', announcement);
        }
    }

    function cleanup() {
        if (state.refreshTimer) {
            clearInterval(state.refreshTimer);
        }
    }

    // ============================================
    // PUBLIC API
    // ============================================

    return {
        init,
        show,
        hide,
        toggle,
        pauseResume,
        refresh,
        showSettings,
        saveSettings: saveSettingsFromModal,
        resetSettings,
        loadArticles
    };

})();

// ============================================
// GLOBAL FUNCTIONS (for onclick handlers)
// ============================================

function pauseResumeTicker() {
    NewsTicker.pauseResume();
}

function toggleTicker() {
    NewsTicker.toggle();
}

function refreshTicker() {
    NewsTicker.refresh();
}

function showTickerSettings() {
    NewsTicker.showSettings();
}

function saveTickerSettings() {
    NewsTicker.saveSettings();
}

function resetTickerSettings() {
    NewsTicker.resetSettings();
}

// ============================================
// DASHBOARD CACHE AND EXPORT
// ============================================

// Global variables to store dashboard cache keys per type
let lastDashboardCacheKey = null;  // Legacy global for backward compatibility
let dashboardCacheKeys = {
    highlights: null,
    narratives: null,
    six_articles: null,
    news_feed: null
};

/**
 * Auto-save current dashboard to cache (called automatically after generation)
 */
async function autoSaveDashboard(dashboardType, dashboardContent, metadata = {}) {
    try {
        console.log('ðŸ”„ Auto-saving dashboard:', dashboardType, 'Content keys:', Object.keys(dashboardContent));

        // Gather configuration data
        const selectedTopics = getSelectedTopics();
        const dateRangeSelect = document.getElementById('date-range-select');
        const dateRange = dateRangeSelect ? dateRangeSelect.value : '24h';

        // Prepare metadata
        const finalMetadata = {
            article_count: dashboardContent.items?.length || dashboardContent.articles?.length || dashboardContent.incidents?.length || dashboardContent.insights?.length || 0,
            model_used: metadata.model_used || 'gpt-4o-mini',
            view_type: metadata.view_type || dashboardType,
            generated_at: new Date().toISOString(),
            ...metadata
        };

        console.log('ðŸ“¤ Saving with metadata:', finalMetadata);

        // Save to backend
        const response = await fetch('/api/dashboard-cache/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dashboard_type: dashboardType,
                date_range: dateRange,
                content: dashboardContent,
                topic: selectedTopics.length > 0 ? selectedTopics.join(',') : null,
                metadata: finalMetadata
            })
        });

        console.log('ðŸ“¥ Save response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Auto-save failed with status:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();

        if (result.success) {
            lastDashboardCacheKey = result.cache_key;

            // Store cache key for this specific dashboard type
            dashboardCacheKeys[dashboardType] = result.cache_key;

            console.log('âœ… Dashboard auto-saved successfully. Cache key:', result.cache_key);
            console.log('âœ… Stored cache key for type:', dashboardType);
            console.log('âœ… All cache keys:', dashboardCacheKeys);

            // Store in window for debugging
            window._lastDashboardCacheKey = lastDashboardCacheKey;
            window._dashboardCacheKeys = dashboardCacheKeys;
        } else {
            console.warn('âŒ Failed to auto-save dashboard:', result.message || result);
        }

    } catch (error) {
        console.error('âŒ Error auto-saving dashboard:', error);
        console.error('âŒ Error stack:', error.stack);
        // Show notification only in console to not interrupt user experience
        // but make it clear that exports won't work
        console.warn('âš ï¸ Dashboard not saved - PDF/export features will show a warning');
        console.warn('âš ï¸ Error details:', error.message);
        // Show user a subtle notification
        showToast('Warning', 'Dashboard auto-save failed. PDF export will not work.', 'warning');
    }
}

/**
 * Debug helper - check cache key status
 */
function checkCacheKeyStatus() {
    const activeView = document.querySelector('.nav-pills .nav-link.active')?.textContent.trim();
    console.log('=== Cache Key Status ===');
    console.log('Active View:', activeView);
    console.log('lastDashboardCacheKey (legacy):', lastDashboardCacheKey);
    console.log('dashboardCacheKeys:', dashboardCacheKeys);
    console.log('  - highlights:', dashboardCacheKeys.highlights);
    console.log('  - narratives:', dashboardCacheKeys.narratives);
    console.log('  - six_articles:', dashboardCacheKeys.six_articles);
    console.log('  - news_feed:', dashboardCacheKeys.news_feed);
    console.log('window._dashboardCacheKeys:', window._dashboardCacheKeys);
    console.log('======================');
}
window.checkCacheKeyStatus = checkCacheKeyStatus;

/**
 * Export dashboard to PDF (server-side)
 */
async function exportDashboardPDF() {
    try {
        console.log('ðŸ“„ exportDashboardPDF called');

        // Determine which dashboard type is currently active
        const activeView = document.querySelector('.nav-pills .nav-link.active')?.textContent.trim();
        console.log('ðŸ“„ Active view:', activeView);

        // Map view name to dashboard type
        let dashboardType = 'news_feed';
        if (activeView === 'Six Articles') dashboardType = 'six_articles';
        else if (activeView === 'Highlights') dashboardType = 'highlights';
        else if (activeView === 'Narratives') dashboardType = 'narratives';

        console.log('ðŸ“„ Dashboard type:', dashboardType);
        console.log('ðŸ“„ All cache keys:', dashboardCacheKeys);

        // Get the cache key for this specific dashboard type
        let cacheKey = dashboardCacheKeys[dashboardType] || lastDashboardCacheKey || window._lastDashboardCacheKey;
        console.log('ðŸ“„ Cache key from memory for', dashboardType, ':', cacheKey);

        // If no cache key in memory, try to get the latest from the database
        if (!cacheKey) {
            console.log('ðŸ“„ No cache key in memory, fetching latest dashboard from database...');
            showToast('Info', 'Fetching latest dashboard...', 'info');

            try {
                // Get current configuration
                const selectedTopics = getSelectedTopics();
                const dateRangeSelect = document.getElementById('date-range-select');
                const dateRange = dateRangeSelect ? dateRangeSelect.value : '7d';
                const topic = selectedTopics.length > 0 ? selectedTopics.join(',') : null;

                // Generate cache key format (must match server-side format exactly)
                // Server-side format: dashboard_type:date_range:topic:persona:profile_id
                // For now, we don't use persona or profile_id in cache keys
                const cacheKeyGuess = `${dashboardType}:${dateRange}:${topic || ''}:null:null`;

                console.log('ðŸ“„ Trying cache key:', cacheKeyGuess);

                // Try to fetch with this cache key
                const checkResponse = await fetch(`/api/dashboard-cache/get/${encodeURIComponent(cacheKeyGuess)}`);

                if (checkResponse.ok) {
                    const result = await checkResponse.json();
                    if (result.success && result.dashboard) {
                        cacheKey = cacheKeyGuess;
                        console.log('âœ… Found dashboard in database with key:', cacheKey);
                    }
                }
            } catch (e) {
                console.warn('Could not fetch latest dashboard:', e);
            }
        }

        if (!cacheKey) {
            console.error('âŒ No cache key available for', dashboardType);
            console.log('Try running: checkCacheKeyStatus() in console to debug');
            showToast('Warning', `No ${activeView} dashboard has been generated yet. Please generate ${activeView} first.`, 'warning');
            return;
        }

        console.log('âœ… Exporting PDF with cache key:', cacheKey);
        showToast('Info', 'Generating PDF...', 'info');

        const response = await fetch('/api/dashboard-cache/export/pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cache_key: cacheKey
            })
        });

        if (response.ok) {
            // Download the PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-export-${new Date().toISOString().slice(0,10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showToast('Success', 'PDF exported successfully!', 'success');
        } else {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to export PDF');
        }

    } catch (error) {
        console.error('Error exporting PDF:', error);
        showToast('Error', `Failed to export PDF: ${error.message}`, 'danger');
    }
}

/**
 * Export dashboard to Markdown (client-side)
 */
function exportDashboardMarkdown() {
    // Get current dashboard data
    const activeView = document.querySelector('.nav-pills .nav-link.active')?.textContent.trim();
    let dashboardContent = {};
    let dashboardType = 'news_feed';

    // Collect content based on active view
    if (activeView === 'Six Articles' && window.lastSixArticles) {
        dashboardContent = { articles: window.lastSixArticles };
        dashboardType = 'six_articles';
    } else if (activeView === 'Highlights' && window._lastIncidents) {
        dashboardContent = { incidents: window._lastIncidents };
        dashboardType = 'highlights';
    } else if (activeView === 'Narratives') {
        // Get insights from the container
        const insightsContainer = document.getElementById('article-insights-container');
        if (insightsContainer && insightsContainer.children.length > 0) {
            // Parse insights from rendered cards
            const insights = Array.from(insightsContainer.querySelectorAll('.insight-item-card')).map(card => {
                const themeName = card.querySelector('h6')?.textContent || 'Unknown Theme';
                const themeSummary = card.querySelector('p.small')?.textContent || '';
                const articles = Array.from(card.querySelectorAll('.list-unstyled li a')).map(link => ({
                    title: link.textContent.trim(),
                    uri: link.getAttribute('href')
                }));
                return { theme_name: themeName, theme_summary: themeSummary, articles };
            });
            dashboardContent = { insights };
            dashboardType = 'narratives';
        }
    } else if (window.currentArticlesData) {
        dashboardContent = { items: window.currentArticlesData };
    }

    if (!dashboardContent.articles && !dashboardContent.items && !dashboardContent.incidents && !dashboardContent.insights) {
        showToast('Warning', 'No dashboard content to export. Please generate content first.', 'warning');
        return;
    }

    // Generate Markdown
    const esc = (s) => String(s || '').replace(/[\\`*_{}[\]()#+\-.!]/g, '\\$&');
    let markdown = `# Dashboard Export\n\n`;
    markdown += `**Generated**: ${new Date().toLocaleString()}\n\n`;
    markdown += `**View**: ${activeView || 'News Feed'}\n\n`;
    markdown += `---\n\n`;

    if (dashboardType === 'six_articles' && dashboardContent.articles) {
        markdown += `## Six Most Interesting Articles\n\n`;
        dashboardContent.articles.forEach((article, idx) => {
            markdown += `### ${idx + 1}. ${esc(article.title || 'Untitled')}\n\n`;
            if (article.url || article.uri) {
                markdown += `**Link**: [Read original](${article.url || article.uri})\n\n`;
            }
            if (article.executive_takeaway) {
                markdown += `> **Executive Takeaway**: ${esc(article.executive_takeaway)}\n\n`;
            }
            if (article.summary) {
                markdown += `${esc(article.summary)}\n\n`;
            }
            if (article.source) {
                markdown += `- **Source**: ${esc(article.source)}\n`;
            }
            if (article.date) {
                markdown += `- **Date**: ${esc(article.date)}\n`;
            }
            markdown += `\n---\n\n`;
        });
    } else if (dashboardType === 'highlights' && dashboardContent.incidents) {
        markdown += `## Highlights / Incident Tracking\n\n`;
        markdown += `**Total Incidents**: ${dashboardContent.incidents.length}\n\n`;
        dashboardContent.incidents.forEach((incident, idx) => {
            markdown += `### ${idx + 1}. ${esc(incident.title || incident.name || 'Untitled Incident')}\n\n`;

            // Metadata badges
            if (incident.type) {
                markdown += `- **Type**: ${esc(incident.type)}\n`;
            }
            if (incident.significance) {
                markdown += `- **Significance**: ${esc(incident.significance)}\n`;
            }
            if (incident.plausibility) {
                markdown += `- **Plausibility**: ${esc(incident.plausibility)}\n`;
            }
            if (incident.source_quality) {
                markdown += `- **Source Quality**: ${esc(incident.source_quality)}\n`;
            }

            // Timeline
            if (Array.isArray(incident.timeline) && incident.timeline.length > 0) {
                const dates = incident.timeline.filter(Boolean);
                if (dates.length > 0) {
                    markdown += `- **Timeline**: ${dates[0]}`;
                    if (dates.length > 1 && dates[dates.length - 1] !== dates[0]) {
                        markdown += ` to ${dates[dates.length - 1]}`;
                    }
                    markdown += `\n`;
                }
            } else if (typeof incident.timeline === 'string' && incident.timeline) {
                markdown += `- **Timeline**: ${esc(incident.timeline)}\n`;
            }

            markdown += `\n`;

            // Description
            if (incident.description) {
                markdown += `${esc(incident.description)}\n\n`;
            }

            // Investigation leads
            if (incident.investigation_leads) {
                const leads = Array.isArray(incident.investigation_leads)
                    ? incident.investigation_leads
                    : [incident.investigation_leads];
                if (leads.length > 0) {
                    markdown += `**Investigation Leads**:\n`;
                    leads.forEach(lead => {
                        markdown += `- ${esc(lead)}\n`;
                    });
                    markdown += `\n`;
                }
            }

            // Related articles
            if (incident.article_uris && incident.article_uris.length > 0) {
                markdown += `**Related Articles** (${incident.article_uris.length}):\n`;
                incident.article_uris.slice(0, 10).forEach(uri => {
                    markdown += `- <${uri}>\n`;
                });
                if (incident.article_uris.length > 10) {
                    markdown += `- ... and ${incident.article_uris.length - 10} more\n`;
                }
                markdown += `\n`;
            }

            markdown += `---\n\n`;
        });
    } else if (dashboardType === 'narratives' && dashboardContent.insights) {
        markdown += `## Narratives / Article Insights\n\n`;
        markdown += `**Total Themes**: ${dashboardContent.insights.length}\n\n`;
        dashboardContent.insights.forEach((insight, idx) => {
            markdown += `### ${idx + 1}. ${esc(insight.theme_name || 'Unnamed Theme')}\n\n`;

            if (insight.theme_summary) {
                markdown += `${esc(insight.theme_summary)}\n\n`;
            }

            // Related articles
            if (insight.articles && insight.articles.length > 0) {
                markdown += `**Related Articles** (${insight.articles.length}):\n`;
                insight.articles.forEach(article => {
                    markdown += `- [${esc(article.title || 'Untitled')}](${article.uri})`;
                    if (article.news_source) {
                        markdown += ` - ${esc(article.news_source)}`;
                    }
                    markdown += `\n`;
                });
                markdown += `\n`;
            }

            markdown += `---\n\n`;
        });
    } else if (dashboardContent.items) {
        markdown += `## Articles\n\n`;
        dashboardContent.items.slice(0, 20).forEach((item, idx) => {
            markdown += `### ${idx + 1}. ${esc(item.title || 'Untitled')}\n\n`;
            if (item.summary) {
                markdown += `${esc(item.summary)}\n\n`;
            }
            if (item.source || item.news_source) {
                markdown += `- **Source**: ${esc(item.source || item.news_source)}\n`;
            }
            markdown += `\n`;
        });
    }

    markdown += `\n---\n*Exported from Aunoo AI Dashboard*\n`;

    // Download
    const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
    const urlObj = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlObj;
    a.download = `dashboard-export-${activeView?.toLowerCase().replace(/\s+/g, '-') || 'news-feed'}-${new Date().toISOString().slice(0,10)}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(urlObj);

    showToast('Success', 'Markdown exported successfully!', 'success');
}

/**
 * Export dashboard to PNG image (client-side screenshot placeholder)
 * Note: For true image export, browser extensions or print-to-PDF can be used
 */
function exportDashboardImage() {
    showToast('Info', 'Use browser Print > Save as PDF for best results, or take a screenshot.', 'info');

    // Alternative: trigger print dialog
    // window.print();
}

/**
 * Export dashboard to CSV (client-side)
 */
function exportDashboardCSV() {
    const activeView = document.querySelector('.nav-pills .nav-link.active')?.textContent.trim();

    // CSV export is primarily for Highlights/Incidents
    if (activeView === 'Highlights' && window._lastIncidents) {
        const incidents = window._lastIncidents;

        if (!incidents || incidents.length === 0) {
            showToast('Warning', 'No incidents to export. Please generate insights first.', 'warning');
            return;
        }

        // CSV headers
        const headers = [
            'Title',
            'Type',
            'Significance',
            'Plausibility',
            'Source Quality',
            'Timeline Start',
            'Timeline End',
            'Description',
            'Investigation Leads',
            'Related Articles Count',
            'Related Article URLs'
        ];

        // Build CSV rows
        const rows = [headers];
        incidents.forEach(incident => {
            const escapeCSV = (str) => {
                if (str === null || str === undefined) return '';
                str = String(str);
                // Escape quotes and wrap in quotes if contains comma, quote, or newline
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            // Parse timeline
            let timelineStart = '';
            let timelineEnd = '';
            if (Array.isArray(incident.timeline)) {
                const dates = incident.timeline.filter(Boolean);
                if (dates.length > 0) {
                    timelineStart = dates[0];
                    timelineEnd = dates[dates.length - 1];
                }
            } else if (typeof incident.timeline === 'string') {
                timelineStart = incident.timeline;
            }

            // Parse investigation leads
            let leadsText = '';
            if (incident.investigation_leads) {
                if (Array.isArray(incident.investigation_leads)) {
                    leadsText = incident.investigation_leads.join('; ');
                } else {
                    leadsText = String(incident.investigation_leads);
                }
            }

            // Parse article URIs
            let articlesText = '';
            if (incident.article_uris && Array.isArray(incident.article_uris)) {
                articlesText = incident.article_uris.join('; ');
            }

            const row = [
                escapeCSV(incident.title || incident.name || ''),
                escapeCSV(incident.type || ''),
                escapeCSV(incident.significance || ''),
                escapeCSV(incident.plausibility || ''),
                escapeCSV(incident.source_quality || ''),
                escapeCSV(timelineStart),
                escapeCSV(timelineEnd),
                escapeCSV(incident.description || ''),
                escapeCSV(leadsText),
                escapeCSV(incident.article_uris ? incident.article_uris.length : 0),
                escapeCSV(articlesText)
            ];
            rows.push(row);
        });

        // Convert to CSV string
        const csvContent = rows.map(row => row.join(',')).join('\n');

        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        const urlObj = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = urlObj;
        a.download = `dashboard-export-highlights-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(urlObj);

        showToast('Success', 'CSV exported successfully!', 'success');

    } else if (activeView === 'Narratives') {
        // CSV export for Narratives/Insights
        const insightsContainer = document.getElementById('article-insights-container');
        if (!insightsContainer || insightsContainer.children.length === 0) {
            showToast('Warning', 'No narratives to export. Please generate insights first.', 'warning');
            return;
        }

        // Parse insights from rendered cards
        const insights = Array.from(insightsContainer.querySelectorAll('.insight-item-card')).map(card => {
            const themeName = card.querySelector('h6')?.textContent || 'Unknown Theme';
            const themeSummary = card.querySelector('p.small')?.textContent || '';
            const articles = Array.from(card.querySelectorAll('.list-unstyled li a'));
            return {
                theme_name: themeName,
                theme_summary: themeSummary,
                article_count: articles.length
            };
        });

        // CSV headers
        const headers = ['Theme Name', 'Theme Summary', 'Related Articles Count'];

        // Build CSV rows
        const rows = [headers];
        insights.forEach(insight => {
            const escapeCSV = (str) => {
                if (str === null || str === undefined) return '';
                str = String(str);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            const row = [
                escapeCSV(insight.theme_name),
                escapeCSV(insight.theme_summary),
                escapeCSV(insight.article_count)
            ];
            rows.push(row);
        });

        // Convert to CSV string
        const csvContent = rows.map(row => row.join(',')).join('\n');

        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        const urlObj = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = urlObj;
        a.download = `dashboard-export-narratives-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(urlObj);

        showToast('Success', 'CSV exported successfully!', 'success');

    } else {
        showToast('Info', 'CSV export is available for Highlights and Narratives views.', 'info');
    }
}

/**
 * Show export buttons for Narrative Explorer (Insights)
 */
function showInsightsSaveButtons() {
    const actionButtons = document.getElementById('insights-action-buttons');
    if (actionButtons) {
        actionButtons.style.display = 'flex';
    }
}

/**
 * Helper to show toast notifications
 */
function showToast(title, message, type = 'info') {
    // Use existing toast system if available, or create a simple alert
    if (window.showNotification) {
        window.showNotification(title, message, type);
    } else {
        alert(`${title}: ${message}`);
    }
}

// ============================================
// INITIALIZATION
// ============================================

// Initialize ticker on DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    NewsTicker.init();

    // Initialize Six Articles settings dropdown visual states
    // Set default selections to match the hidden select element defaults
    setTimeout(function() {
        if (typeof setPersona === 'function') {
            setPersona('CEO');
        }
        if (typeof setArticleCount === 'function') {
            setArticleCount(6);
        }
    }, 100); // Small delay to ensure DOM is fully ready
});

</script>

{% endblock %}
