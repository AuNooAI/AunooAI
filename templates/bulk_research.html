{% extends "base.html" %}
{% block title %}FNA - Bulk Research{% endblock %}
{% block content %}
<h1>Bulk Research</h1>
<form id="bulkResearchForm" enctype="multipart/form-data">
    <!-- Add Topic Selection -->
    <div class="mb-3">
        <label for="topicSelect" class="form-label">Select Topic</label>
        <select class="form-select" id="topicSelect" name="topic" required>
            <option value="">Select a topic</option>
        </select>
    </div>
    <!-- Configure Multiselect Options-->
    <div class="mb-3">
        <label for="urlList" class="form-label">Enter URLs (one per line)</label>
        <textarea class="form-control" id="urlList" rows="5"></textarea>
    </div>
    <div class="mb-3">
        <label for="urlFile" class="form-label">Or upload a file with URLs</label>
        <input class="form-control" type="file" id="urlFile" accept=".txt">
    </div>
    <div class="mb-3">
        <label for="summaryLength" class="form-label">Summary Length</label>
        <select class="form-select" id="summaryLength" name="summaryLength" required>
            <option value="40">40 words</option>
            <option value="50" selected>50 words</option>
            <option value="75">75 words</option>
            <option value="100">100 words</option>
            <option value="custom">Custom</option>
        </select>
        <div id="customSummaryLengthField" class="custom-field mt-2" style="display: none;">
            <input type="number" class="form-control" id="customSummaryLength" name="customSummaryLength" placeholder="Enter custom summary length">
        </div>
    </div>
    <div class="mb-3">
        <label for="summaryVoice" class="form-label">Summary Voice</label>
        <select class="form-select" id="summaryVoice" name="summaryVoice" required>
            <option value="business_analyst">Business Analyst</option>
            <option value="industry_analyst">Industry Analyst</option>
            <option value="tech_journalist">Tech Journalist</option>
            <option value="investment_advisor">Investment Advisor</option>
            <option value="principal_security_engineer">Principal Security Engineer</option>
            <option value="ciso">CISO</option>
            <option value="custom">Custom</option>
        </select>
        <div id="customVoiceField" class="custom-field mt-2" style="display: none;">
            <input type="text" class="form-control" id="customVoice" name="customVoice" placeholder="Enter custom voice">
        </div>
    </div>
    <div class="mb-3">
        <label for="summaryType" class="form-label">Summary Type</label>
        <select class="form-select" id="summaryType" name="summaryType" required>
            <option value="curious_ai">Curious AI Long</option>
            <option value="axios">Axios</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="modelName" class="form-label">AI Model</label>
        <select class="form-select" id="modelName" name="modelName" required>
            <!-- This will be populated dynamically -->
        </select>
    </div>
    <div class="mb-3">
        <label for="articleCountSlider" class="form-label">Number of Articles to Analyze</label>
        <input type="range" class="form-range" id="articleCountSlider" name="articleCount" min="1" max="25" value="20" oninput="updateArticleCountLabel(this.value)">
        <span id="articleCountLabel">20</span>
    </div>
    <button type="submit" class="btn btn-primary">Analyze</button>
</form>

<!-- Add this results container -->
<div id="results" class="mt-4"></div>

<!-- Results table -->
<div id="resultsTable" class="mt-4" style="display: none;">
    <h2>Analysis Results</h2>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Select</th>
                <th>URL</th>
                <th>Title</th>
                <th>Summary</th>
                <th>News Source</th>
                <th>Category</th>
                <th>Time to Impact</th>
                <th>Time to Impact Explanation</th>
                <th>Sentiment</th>
                <th> Sentiment Explanation</th>
                <th>Future Signal</th>
                <th>Future Signal Explanation</th>
                <th>Driver Type</th>
                <th>Driver Type Explanation</th>
                <th>Publication Date</th>
                <th>Submission Date</th>
                <th>Tags</th>
            </tr>
        </thead>
        <tbody id="resultsBody">
            <!-- Rows will be dynamically added here -->
        </tbody>
    </table>
    <button id="saveAllButton" class="btn btn-primary mt-3">Save All Articles</button>
</div>

<style>
    #bulkResearchForm {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #bulkResearchForm .form-label {
        font-weight: bold;
        color: #333;
    }

    #bulkResearchForm .form-control, #bulkResearchForm .form-select {
        border-radius: 4px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
    }

    #bulkResearchForm .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        transition: background-color 0.3s ease;
    }

    #bulkResearchForm .btn-primary:hover {
        background-color: #0056b3;
    }

    .form-control, .form-select {
        margin-bottom: 10px;
    }
    .form-control {
        width: 100%;
    }
    .form-select {
        width: 100%;
    }
    textarea.form-control {
        resize: vertical;
    }
    table.table {
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        padding: 8px;
        text-align: left;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTopics();
    loadAvailableModels();
    setUpCustomFields();
    document.getElementById('bulkResearchForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('saveAllButton').addEventListener('click', saveAllArticles);
});

function loadTopics() {
    fetch('/api/topics')
        .then(response => response.json())
        .then(topics => {
            const topicSelect = document.getElementById('topicSelect');
            topicSelect.innerHTML = '<option value="">Select a topic</option>';
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.name;
                option.textContent = topic.name;
                topicSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading topics:', error));
}

function loadAvailableModels() {
    fetch('/api/available_models')
        .then(response => response.json())
        .then(models => {
            const modelSelect = document.getElementById('modelName');
            modelSelect.innerHTML = '';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.provider})`;
                modelSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading available models:', error));
}

function setUpCustomFields() {
    const summaryLengthSelect = document.getElementById('summaryLength');
    const customSummaryLengthField = document.getElementById('customSummaryLengthField');
    summaryLengthSelect.addEventListener('change', function() {
        customSummaryLengthField.style.display = this.value === 'custom' ? 'block' : 'none';
    });

    const summaryVoiceSelect = document.getElementById('summaryVoice');
    const customVoiceField = document.getElementById('customVoiceField');
    summaryVoiceSelect.addEventListener('change', function() {
        customVoiceField.style.display = this.value === 'custom' ? 'block' : 'none';
    });
}

async function analyzeBulkUrls(requestData) {
    try {
        console.log('Sending request data:', requestData);
        const response = await fetch('/api/bulk-research', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', Object.fromEntries(response.headers));

        const responseText = await response.text();
        console.log('Raw response text:', responseText);

        let data;
        try {
            data = JSON.parse(responseText);
            console.log('Parsed response data:', data);
        } catch (error) {
            console.error('JSON parse error:', error);
            throw new Error(`Failed to parse response: ${responseText.substring(0, 100)}...`);
        }

        if (!response.ok) {
            console.error('Response not OK:', data);
            throw new Error(data.error || `Server error: ${response.status}`);
        }

        if (!data || typeof data !== 'object') {
            console.error('Invalid response data type:', typeof data);
            throw new Error('Server returned invalid data type');
        }

        // Check if data is an array (direct results) or has a results property
        const results = Array.isArray(data) ? data : data.results;
        
        if (!results) {
            console.error('No results found in response:', data);
            throw new Error('Server returned no results array');
        }

        return results;
    } catch (error) {
        console.error('Error in analyzeBulkUrls:', error);
        throw error;
    }
}

async function handleFormSubmit(event) {
    event.preventDefault();
    const submitButton = document.querySelector('button[type="submit"]');
    const resultsContainer = document.getElementById('results');
    const resultsTable = document.getElementById('resultsTable');
    
    try {
        // Disable submit button and show loading state
        submitButton.disabled = true;
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="alert alert-info">Processing...</div>';
        }
        if (resultsTable) {
            resultsTable.style.display = 'none';
        }

        const topic = document.getElementById('topicSelect').value;
        if (!topic) {
            throw new Error('Please select a topic before analyzing articles');
        }

        const urlList = document.getElementById('urlList').value;
        const urlFile = document.getElementById('urlFile').files[0];
        
        let urls = [];
        if (urlList) {
            urls = urlList.split('\n').filter(url => url.trim() !== '');
        } else if (urlFile) {
            const fileContent = await urlFile.text();
            urls = fileContent.split('\n').filter(url => url.trim() !== '');
        }

        if (urls.length === 0) {
            throw new Error('Please enter URLs or upload a file containing URLs.');
        }

        const requestData = {
            urls,
            summaryType: document.getElementById('summaryType').value,
            modelName: document.getElementById('modelName').value,
            summaryLength: getSummaryLength(),
            summaryVoice: getSummaryVoice(),
            topic
        };

        const results = await analyzeBulkUrls(requestData);
        
        // Display results in both containers
        if (resultsContainer) {
            displayResults(results);
        }
        if (resultsTable) {
            displayResultsTable(results);
            resultsTable.style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error:', error);
        if (resultsContainer) {
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    ${error.message}
                </div>`;
        }
        if (resultsTable) {
            resultsTable.style.display = 'none';
        }
    } finally {
        submitButton.disabled = false;
    }
}

function getSummaryLength() {
    const summaryLengthSelect = document.getElementById('summaryLength');
    if (summaryLengthSelect.value === 'custom') {
        return document.getElementById('customSummaryLength').value;
    }
    return summaryLengthSelect.value;
}

function getSummaryVoice() {
    const summaryVoiceSelect = document.getElementById('summaryVoice');
    if (summaryVoiceSelect.value === 'custom') {
        return document.getElementById('customVoice').value;
    }
    return summaryVoiceSelect.value;
}

function displayResults(results) {
    const resultsContainer = document.getElementById('results');
    if (!resultsContainer) return;

    if (!Array.isArray(results) || results.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-info">
                No results to display
            </div>`;
        return;
    }

    const resultsList = document.createElement('div');
    resultsList.className = 'results-list';

    results.forEach(result => {
        const resultElement = document.createElement('div');
        resultElement.className = 'result-item card mb-3';
        resultElement.innerHTML = `
            <div class="card-body">
                <h3 class="card-title">${result.title || 'No title'}</h3>
                <p class="card-text"><strong>URL:</strong> ${result.uri}</p>
                <p class="card-text"><strong>Summary:</strong> ${result.summary}</p>
                <p class="card-text"><strong>Sentiment:</strong> ${result.sentiment}</p>
                <p class="card-text"><strong>Category:</strong> ${result.category}</p>
                <p class="card-text"><strong>Future Signal:</strong> ${result.future_signal}</p>
                <p class="card-text"><strong>Tags:</strong> ${Array.isArray(result.tags) ? result.tags.join(', ') : result.tags || 'No tags'}</p>
            </div>
        `;
        resultsList.appendChild(resultElement);
    });

    resultsContainer.innerHTML = '';
    resultsContainer.appendChild(resultsList);
}

function displayResultsTable(results) {
    const resultsBody = document.getElementById('resultsBody');
    if (!resultsBody) return;

    if (!Array.isArray(results) || results.length === 0) {
        resultsBody.innerHTML = '<tr><td colspan="14" class="text-center">No results to display</td></tr>';
        return;
    }

    resultsBody.innerHTML = '';
    results.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="article-checkbox" data-uri="${result.uri}"></td>
            <td><input type="text" value="${result.uri || ''}" class="form-control"></td>
            <td><input type="text" value="${result.title || 'N/A'}" class="form-control"></td>
            <td><textarea class="form-control">${result.summary || 'N/A'}</textarea></td>
            <td><input type="text" value="${result.news_source || 'N/A'}" class="form-control"></td>
            <td>
                <select class="form-select">
                    ${getOptions('category', result.category)}
                </select>
            </td>
            <td>
                <select class="form-select">
                    ${getOptions('time_to_impact', result.time_to_impact)}
                </select>
            </td>
            <td><textarea class="form-control">${result.time_to_impact_explanation || ''}</textarea></td>
            <td>
                <select class="form-select">
                    ${getOptions('sentiment', result.sentiment)}
                </select>
            </td>
            <td><textarea class="form-control">${result.sentiment_explanation || ''}</textarea></td>
            <td>
                <select class="form-select">
                    ${getOptions('future_signal', result.future_signal)}
                </select>
            </td>
            <td><textarea class="form-control">${result.future_signal_explanation || ''}</textarea></td>
            <td>
                <select class="form-select">
                    ${getOptions('driver_type', result.driver_type)}
                </select>
            </td>
            <td><textarea class="form-control">${result.driver_type_explanation || ''}</textarea></td>
            <td><input type="date" value="${result.publication_date || 'N/A'}" class="form-control"></td>
            <td><input type="date" value="${result.submission_date || 'N/A'}" class="form-control"></td>
            <td><input type="text" value="${Array.isArray(result.tags) ? result.tags.join(', ') : 'N/A'}" class="form-control"></td>
        `;
        resultsBody.appendChild(row);
    });
}

function getOptions(type, selectedValue) {
    const options = {
        category: ['Category1', 'Category2', 'Category3'], // Replace with actual categories
        time_to_impact: ['Immediate', 'Short-term', 'Mid-term', 'Long-term'],
        sentiment: ['Positive', 'Neutral', 'Negative'],
        future_signal: ['Signal1', 'Signal2', 'Signal3'], // Replace with actual signals
        driver_type: ['Catalyst', 'Accelerator', 'Delayer', 'Blocker', 'Initiator', 'Terminator', 'Unknown']
    };

    return options[type].map(option => 
        `<option value="${option}" ${option === selectedValue ? 'selected' : ''}>${option}</option>`
    ).join('');
}

function collectSelectedArticles() {
    const selectedCheckboxes = document.querySelectorAll('#resultsBody .article-checkbox:checked');
    const articles = Array.from(selectedCheckboxes).map(checkbox => {
        const row = checkbox.closest('tr');
        return {
            uri: row.cells[1].querySelector('input').value.trim(),
            title: row.cells[2].querySelector('input').value.trim(),
            summary: row.cells[3].querySelector('textarea').value.trim(),
            news_source: row.cells[4].querySelector('input').value.trim(),
            category: row.cells[5].querySelector('select').value,
            time_to_impact: row.cells[6].querySelector('select').value,
            time_to_impact_explanation: row.cells[7].querySelector('textarea').value.trim(),
            sentiment: row.cells[8].querySelector('select').value,
            sentiment_explanation: row.cells[9].querySelector('textarea').value.trim(),
            future_signal: row.cells[10].querySelector('select').value,
            future_signal_explanation: row.cells[11].querySelector('textarea').value.trim(),
            driver_type: row.cells[12].querySelector('select').value,
            driver_type_explanation: row.cells[13].querySelector('textarea').value.trim(),
            publication_date: row.cells[14].querySelector('input').value.trim(),
            submission_date: row.cells[15].querySelector('input').value.trim(),
            tags: row.cells[16].querySelector('input').value.trim().split(',').map(tag => tag.trim()),
            topic: document.getElementById('topicSelect').value
        };
    });
    return articles;
}

async function saveAllArticles() {
    const articles = collectSelectedArticles();
    console.log('Articles to save:', articles); // Debug log

    const response = await fetch('/api/save-bulk-articles', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ articles }),
    });
    const result = await response.json();
    
    if (result.errors.length > 0) {
        const errorMessage = result.errors.map(error => `${error.uri}: ${error.error}`).join('\n');
        alert(`Some articles could not be saved:\n${errorMessage}`);
    }
    
    if (result.success.length > 0) {
        alert(`${result.success.length} article(s) saved successfully!`);
    }
    
    console.log(result);
}

function displayAxiosSummary(result) {
    let summary = `<strong>Main Point:</strong> ${result.summary}<br>`;
    if (result.key_takeaways) {
        summary += '<strong>Key Takeaways:</strong><ul>';
        result.key_takeaways.forEach(takeaway => {
            summary += `<li>${takeaway}</li>`;
        });
        summary += '</ul>';
    }
    if (result.go_deeper) {
        summary += `<strong>Go deeper:</strong> ${result.go_deeper}`;
    }
    return summary;
}

function editArticle(url) {
    // Implement edit functionality
    console.log('Edit article:', url);
}

function deleteArticle(url) {
    // Implement delete functionality
    console.log('Delete article:', url);
}

function updateArticleCountLabel(value) {
    document.getElementById('articleCountLabel').textContent = value;
}

async function loadDefaultValuesForTopic(topic) {
    const response = await fetch('/api/config');
    const config = await response.json();
    const topicConfig = config.topics.find(t => t.name === topic);

    if (topicConfig) {
        // Populate default values in the form
        document.getElementById('categorySelect').value = topicConfig.categories[0];
        document.getElementById('timeToImpactSelect').value = topicConfig.time_to_impact[0];
        document.getElementById('sentimentSelect').value = topicConfig.sentiment[0];
        document.getElementById('futureSignalSelect').value = topicConfig.future_signals[0];
        document.getElementById('driverTypeSelect').value = topicConfig.driver_types[0];
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const topicSelect = document.getElementById('topicSelect');
    topicSelect.addEventListener('change', function() {
        loadDefaultValuesForTopic(this.value);
    });
});
</script>
{% endblock %}
