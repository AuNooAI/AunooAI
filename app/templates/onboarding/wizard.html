{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Welcome to AunooAI</h1>
        
        <!-- Progress Steps -->
        <div class="flex justify-between mb-8">
            <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">API Keys</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Topic Setup</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Keywords</div>
            </div>
        </div>

        <!-- Step 1: API Keys -->
        <div class="step-content" id="step1">
            <h2 class="text-2xl font-semibold mb-4">Set Up API Keys</h2>
            <p class="mb-4">Let's configure the necessary API keys to get started.</p>
            
            <!-- NewsAPI Key -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">NewsAPI Key</label>
                <div class="flex gap-2">
                    <input type="password" id="newsapi_key" class="form-input flex-1" placeholder="Enter NewsAPI key">
                    <button onclick="testApiKey('newsapi')" class="btn btn-secondary">Test</button>
                </div>
            </div>

            <!-- LLM Key -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">LLM Provider</label>
                <select id="llm_provider" class="form-select mb-2">
                    <option value="openai">OpenAI (GPT-4o-mini)</option>
                    <option value="anthropic">Anthropic (Claude 3.5 Sonnet)</option>
                </select>
                <div class="flex gap-2">
                    <input type="password" id="llm_key" class="form-input flex-1" placeholder="Enter API key">
                    <button onclick="testApiKey('llm')" class="btn btn-secondary">Test</button>
                </div>
            </div>

            <!-- Firecrawl Key -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">Firecrawl Key</label>
                <div class="flex gap-2">
                    <input type="password" id="firecrawl_key" class="form-input flex-1" placeholder="Enter Firecrawl key">
                    <button onclick="testApiKey('firecrawl')" class="btn btn-secondary">Test</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Topic Setup -->
        <div class="step-content hidden" id="step2">
            <h2 class="text-2xl font-semibold mb-4">Set Up Your Topic</h2>
            <p class="mb-4">Configure your first monitoring topic.</p>

            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">Topic Type</label>
                <select id="topic_type" class="form-select" onchange="handleTopicTypeChange()">
                    <option value="custom">Create Custom Topic</option>
                    <option value="existing">Use Existing Topic</option>
                </select>
            </div>

            <!-- Custom Topic Form -->
            <div id="custom_topic_form">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Topic Name</label>
                    <p class="text-sm text-gray-600 mb-2">A clear description that could be a question, market, field, or group. Examples: "Is AI Hype?", "Cloud Service Providers", or "Quantum Computing".</p>
                    <input type="text" id="topic_name" class="form-input w-full" placeholder="Enter topic name">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Description (optional)</label>
                    <p class="text-sm text-gray-600 mb-2">Provide details about what you're trying to monitor or understand. The more specific you are, the better the suggestions will be.</p>
                    <textarea id="topic_description" class="form-textarea w-full" rows="3" placeholder="Describe what you want to track or understand about this topic"></textarea>
                </div>
                
                <div class="flex gap-2 mb-6">
                    <button onclick="suggestAttributes()" class="btn btn-secondary">Get Suggestions</button>
                    <button id="regenerateBtn" onclick="regenerateSuggestions()" class="btn btn-outline" disabled>Regenerate</button>
                </div>
                
                <div id="explanation_container" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                    <h3 class="font-medium mb-2">Why these suggestions?</h3>
                    <p id="explanation_text" class="text-sm text-gray-700"></p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Future Signals</label>
                    <p class="text-sm text-gray-600 mb-2">Future Signals are scenarios that suggest potential directions for a topic. For instance, signals for an AI hype model could range from <span class="text-blue-600">"AI is hype"</span> and <span class="text-blue-600">"AI is evolving gradually"</span>, to <span class="text-blue-600">"AI is accelerating"</span>.</p>
                    <div id="signals_container">
                        <input type="text" class="form-input w-full mb-2" placeholder="Add signal">
                        <button onclick="addSignal()" class="btn btn-secondary">+ Add Signal</button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Categories</label>
                    <p class="text-sm text-gray-600 mb-2">Each topic is broken down into categories, making it easier to organize and analyze data. For example, a topic on AI might include subcategories like <span class="text-blue-600">AI in Finance</span> or <span class="text-blue-600">Cloud Quarterly Earnings</span>.</p>
                    <div id="categories_container">
                        <input type="text" class="form-input w-full mb-2" placeholder="Add category">
                        <button onclick="addCategory()" class="btn btn-secondary">+ Add Category</button>
                    </div>
                </div>

                <!-- Default Attributes -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Sentiment</label>
                    <p class="text-sm text-gray-600 mb-2">AuNoo goes beyond basic positive, neutral, and negative sentiment analysis. It can detect tones such as <span class="text-blue-600">mocking</span>, <span class="text-blue-600">critical</span>, <span class="text-blue-600">hyperbolic</span>, or <span class="text-blue-600">optimistic</span>, providing a nuanced understanding of public and media sentiment.</p>
                    <select multiple id="sentiment" class="form-multiselect w-full">
                        <option selected>Positive</option>
                        <option selected>Negative</option>
                        <option selected>Neutral</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Time to Impact</label>
                    <p class="text-sm text-gray-600 mb-2">Time to Impact helps assess when the impact of a trend is expected—<span class="text-blue-600">immediate</span>, <span class="text-blue-600">short-term (3–18 months)</span>, <span class="text-blue-600">mid-term (18–60 months)</span>, or <span class="text-blue-600">long-term (5+ years)</span>. This allows decision-makers to prioritize their strategies effectively. It is based on the Three Horizon Model.</p>
                    <select multiple id="time_to_impact" class="form-multiselect w-full">
                        <option selected>Immediate (0-6 months)</option>
                        <option selected>Short-term (6-18 months)</option>
                        <option selected>Mid-term (18-60 months)</option>
                        <option selected>Long-term (60+ months)</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Drivers</label>
                    <p class="text-sm text-gray-600 mb-2">AuNoo categorizes data points based on their impact on a topic, using types like:
                        <span class="block mt-1 ml-2 text-blue-600">• <strong>Accelerator</strong>: Speeds up the development or impact of a trend.</span>
                        <span class="block ml-2 text-blue-600">• <strong>Delayer</strong>: Slows down progress.</span>
                        <span class="block ml-2 text-blue-600">• <strong>Blocker</strong>: Prevents a trend from advancing.</span>
                        <span class="block ml-2 text-blue-600">• <strong>Catalyst</strong>: Significantly amplifies or transforms the trajectory of a trend.</span>
                    </p>
                    <select multiple id="drivers" class="form-multiselect w-full">
                        <option selected>Accelerator</option>
                        <option selected>Delayer</option>
                        <option selected>Blocker</option>
                        <option selected>Catalyst</option>
                    </select>
                </div>
            </div>

            <!-- Existing Topic Selection -->
            <div id="existing_topic_form" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Select Topic</label>
                    <select id="existing_topic" class="form-select w-full">
                        <!-- Will be populated via JavaScript -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Step 3: Keywords -->
        <div class="step-content hidden" id="step3">
            <h2 class="text-2xl font-semibold mb-4">Set Up Keywords</h2>
            <p class="mb-4">Add keywords to monitor for your topic.</p>

            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-6">
                <h3 class="font-medium mb-2">About Keywords</h3>
                <p class="text-sm text-gray-700">Keywords are specific searchable terms used to find relevant content about your topic. They help the system find and classify articles that are relevant to your monitoring needs.</p>
                <div class="mt-2">
                    <p class="text-sm text-gray-700"><strong>Effective keywords include:</strong></p>
                    <ul class="list-disc ml-5 text-sm text-gray-700">
                        <li>Company names (e.g., <span class="text-blue-600">"OpenAI"</span>, <span class="text-blue-600">"Microsoft"</span>)</li>
                        <li>Technologies (e.g., <span class="text-blue-600">"Quantum Computing"</span>, <span class="text-blue-600">"5G"</span>)</li>
                        <li>People (e.g., <span class="text-blue-600">"Sundar Pichai"</span>, <span class="text-blue-600">"Sam Altman"</span>)</li>
                        <li>Technical terms (e.g., <span class="text-blue-600">"Transformer models"</span>, <span class="text-blue-600">"Cloud repatriation"</span>)</li>
                    </ul>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">Keywords</label>
                <p class="text-sm text-gray-600 mb-2">These keywords will be used to search for news articles, research papers, and other content related to your topic. We've suggested a few based on your topic setup.</p>
                <div id="keywords_container">
                    <div class="flex gap-2 mb-2">
                        <input type="text" class="form-input flex-1" placeholder="Enter keyword or phrase">
                        <button onclick="removeKeyword(this)" class="btn btn-danger">Remove</button>
                    </div>
                </div>
                <button onclick="addKeyword()" class="btn btn-secondary">+ Add Keyword</button>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8">
            <button id="prevBtn" onclick="prevStep()" class="btn btn-secondary" disabled>Previous</button>
            <button id="nextBtn" onclick="nextStep()" class="btn btn-primary">Next</button>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 3;

// API Key Testing
async function testApiKey(keyType) {
    const key = document.getElementById(`${keyType}_key`).value;
    if (!key) {
        alert('Please enter an API key');
        return;
    }

    const provider = keyType === 'llm' ? document.getElementById('llm_provider').value : null;
    
    try {
        const response = await fetch('/api/onboarding/validate-api-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                key_type: keyType,
                api_key: key,
                provider: provider
            })
        });

        if (response.ok) {
            alert('API key is valid!');
        } else {
            const data = await response.json();
            alert(`Invalid API key: ${data.detail}`);
        }
    } catch (error) {
        alert('Error testing API key');
        console.error(error);
    }
}

// Topic Type Handling
function handleTopicTypeChange() {
    const type = document.getElementById('topic_type').value;
    document.getElementById('custom_topic_form').style.display = type === 'custom' ? 'block' : 'none';
    document.getElementById('existing_topic_form').style.display = type === 'existing' ? 'block' : 'none';
    
    if (type === 'existing') {
        loadExistingTopics();
    }
}

async function loadExistingTopics() {
    try {
        const response = await fetch('/api/topics');
        const topics = await response.json();
        
        const select = document.getElementById('existing_topic');
        select.innerHTML = topics.map(topic => 
            `<option value="${topic.name}">${topic.name}</option>`
        ).join('');
    } catch (error) {
        console.error('Error loading topics:', error);
    }
}

// Topic Attributes
async function suggestAttributes() {
    const topicName = document.getElementById('topic_name').value;
    if (!topicName) {
        alert('Please enter a topic name');
        return;
    }
    
    // Show loading state
    document.getElementById('regenerateBtn').disabled = true;
    const suggestBtn = document.querySelector('button[onclick="suggestAttributes()"]');
    const originalText = suggestBtn.textContent;
    suggestBtn.textContent = 'Loading...';
    suggestBtn.disabled = true;

    try {
        const topicDescription = document.getElementById('topic_description').value;
        
        const response = await fetch('/api/onboarding/suggest-topic-attributes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                topic_name: topicName,
                description: topicDescription
            })
        });

        if (response.ok) {
            const suggestions = await response.json();
            
            // Clear existing categories and signals
            document.getElementById('categories_container').innerHTML = '';
            document.getElementById('signals_container').innerHTML = '';
            
            // Add suggested categories
            suggestions.categories.forEach(category => {
                addCategory(category);
            });
            
            // Add suggested signals
            suggestions.future_signals.forEach(signal => {
                addSignal(signal);
            });
            
            // Show explanation at the top
            const explanationContainer = document.getElementById('explanation_container');
            explanationContainer.classList.remove('hidden');
            document.getElementById('explanation_text').textContent = suggestions.explanation;
            
            // Enable regenerate button
            document.getElementById('regenerateBtn').disabled = false;
        }
    } catch (error) {
        alert('Error getting suggestions');
        console.error(error);
    } finally {
        // Reset button state
        suggestBtn.textContent = originalText;
        suggestBtn.disabled = false;
    }
}

function addCategory(value = '') {
    const container = document.getElementById('categories_container');
    const div = document.createElement('div');
    div.className = 'flex gap-2 mb-2';
    div.innerHTML = `
        <input type="text" class="form-input flex-1" value="${value}" placeholder="Add category">
        <button onclick="this.parentElement.remove()" class="btn btn-danger">Remove</button>
    `;
    container.insertBefore(div, container.lastElementChild);
}

function addSignal(value = '') {
    const container = document.getElementById('signals_container');
    const div = document.createElement('div');
    div.className = 'flex gap-2 mb-2';
    div.innerHTML = `
        <input type="text" class="form-input flex-1" value="${value}" placeholder="Add signal">
        <button onclick="this.parentElement.remove()" class="btn btn-danger">Remove</button>
    `;
    container.insertBefore(div, container.lastElementChild);
}

// Keywords
function addKeyword(value = '') {
    const container = document.getElementById('keywords_container');
    const div = document.createElement('div');
    div.className = 'flex gap-2 mb-2';
    div.innerHTML = `
        <input type="text" class="form-input flex-1" value="${value}" placeholder="Enter keyword or phrase">
        <button onclick="this.parentElement.remove()" class="btn btn-danger">Remove</button>
    `;
    container.appendChild(div);
}

function removeKeyword(btn) {
    btn.parentElement.remove();
}

function regenerateSuggestions() {
    suggestAttributes();
}

// Navigation
function updateStepDisplay() {
    document.querySelectorAll('.step-content').forEach((el, i) => {
        el.classList.toggle('hidden', i + 1 !== currentStep);
    });
    
    document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('active', i + 1 <= currentStep);
    });
    
    document.getElementById('prevBtn').disabled = currentStep === 1;
    document.getElementById('nextBtn').textContent = currentStep === totalSteps ? 'Finish' : 'Next';
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
    }
}

async function nextStep() {
    if (currentStep < totalSteps) {
        if (currentStep === 1) {
            // Validate API keys are set
            const newsapiKey = document.getElementById('newsapi_key').value;
            const llmKey = document.getElementById('llm_key').value;
            const firecrawlKey = document.getElementById('firecrawl_key').value;
            
            if (!newsapiKey || !llmKey || !firecrawlKey) {
                alert('Please set all required API keys');
                return;
            }
        } else if (currentStep === 2) {
            // Validate topic setup
            const topicType = document.getElementById('topic_type').value;
            if (topicType === 'custom') {
                const topicName = document.getElementById('topic_name').value;
                if (!topicName) {
                    alert('Please enter a topic name');
                    return;
                }
                
                // Save topic configuration
                await saveTopic();
            }
        }
        
        currentStep++;
        
        // Special handling for Step 3 to prepopulate keywords
        if (currentStep === 3) {
            prepareKeywordsStep();
        }
        
        updateStepDisplay();
    } else {
        // Final step - save keywords and complete
        await saveKeywords();
        await completeOnboarding();
        window.location.href = '/';
    }
}

async function saveTopic() {
    const topicType = document.getElementById('topic_type').value;
    if (topicType === 'custom') {
        const topicData = {
            name: document.getElementById('topic_name').value,
            categories: Array.from(document.querySelectorAll('#categories_container input')).map(input => input.value).filter(val => val.trim() !== ''),
            future_signals: Array.from(document.querySelectorAll('#signals_container input')).map(input => input.value).filter(val => val.trim() !== ''),
            sentiment: Array.from(document.getElementById('sentiment').selectedOptions).map(option => option.value),
            time_to_impact: Array.from(document.getElementById('time_to_impact').selectedOptions).map(option => option.value),
            driver_types: Array.from(document.getElementById('drivers').selectedOptions).map(option => option.value),
            keywords: []  // Will be saved separately in Step 3
        };
        
        try {
            const response = await fetch('/api/onboarding/save-topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(topicData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to save topic');
            }
            
            // Store any suggested keywords to be used in Step 3
            const explanation = document.getElementById('explanation_text').textContent;
            if (explanation) {
                localStorage.setItem('topic_name', topicData.name);
                // If we have suggested keywords from the explanation, prepare them for Step 3
                sessionStorage.setItem('suggested_keywords', JSON.stringify(
                    Array.from(document.querySelectorAll('#signals_container input'))
                    .map(input => input.value.trim())
                    .filter(val => val !== '')
                    .slice(0, 3) // Use the first 3 signals as keywords
                ));
            }
        } catch (error) {
            alert('Error saving topic');
            console.error(error);
            throw error;
        }
    }
}

async function saveKeywords() {
    // Clear existing keywords container first to prevent duplicates
    document.getElementById('keywords_container').innerHTML = '';
    
    // Check if we have suggested keywords from Step 2
    const suggestedKeywords = JSON.parse(sessionStorage.getItem('suggested_keywords') || '[]');
    
    // Add suggested keywords
    suggestedKeywords.forEach(keyword => {
        addKeyword(keyword);
    });
    
    // Always add at least one empty field
    if (document.querySelectorAll('#keywords_container input').length === 0) {
        addKeyword();
    }
    
    const keywords = Array.from(document.querySelectorAll('#keywords_container input')).map(input => input.value).filter(val => val.trim() !== '');
    const topicName = document.getElementById('topic_type').value === 'custom' 
        ? document.getElementById('topic_name').value 
        : document.getElementById('existing_topic').value;
        
    try {
        const response = await fetch('/api/keyword-monitor/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic: topicName,
                keywords: keywords
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to save keywords');
        }
    } catch (error) {
        alert('Error saving keywords');
        console.error(error);
        throw error;
    }
}

async function completeOnboarding() {
    try {
        const response = await fetch('/api/onboarding/complete', {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to complete onboarding');
        }
    } catch (error) {
        alert('Error completing onboarding');
        console.error(error);
        throw error;
    }
}

// Function to prepare the keywords step
function prepareKeywordsStep() {
    // Clear existing keywords container
    document.getElementById('keywords_container').innerHTML = '';
    
    // Get keywords from the suggestion if available
    const suggestedKeywords = JSON.parse(sessionStorage.getItem('suggested_keywords') || '[]');
    
    // Add suggested keywords
    suggestedKeywords.forEach(keyword => {
        addKeyword(keyword);
    });
    
    // Always ensure at least one empty field
    if (document.querySelectorAll('#keywords_container input').length === 0) {
        addKeyword();
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateStepDisplay();
});
</script>

<style>
.step {
    flex: 1;
    text-align: center;
    position: relative;
}

.step:not(:last-child):after {
    content: '';
    position: absolute;
    top: 15px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: #e5e7eb;
}

.step.active:not(:last-child):after {
    background: #3b82f6;
}

.step-circle {
    width: 30px;
    height: 30px;
    background: #e5e7eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    color: #6b7280;
}

.step.active .step-circle {
    background: #3b82f6;
    color: white;
}

.step-label {
    color: #6b7280;
}

.step.active .step-label {
    color: #3b82f6;
}
</style>
{% endblock %} 