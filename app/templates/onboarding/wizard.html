{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Welcome to AunooAI</h1>
        
        <!-- Progress Steps -->
        <div class="flex justify-between mb-8">
            <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">API Keys</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Topic Setup</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Keywords</div>
            </div>
        </div>

        <!-- Step 1: API Keys -->
        <div class="step-content" id="step1">
            <h2 class="text-2xl font-semibold mb-4">Set Up API Keys</h2>
            <p class="mb-4">Let's configure the necessary API keys to get started.</p>
            
            <!-- NewsAPI Key -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">NewsAPI Key</label>
                <div class="flex gap-2">
                    <input type="password" id="newsapi_key" class="form-input flex-1" placeholder="Enter NewsAPI key">
                    <button onclick="testApiKey('newsapi')" class="btn btn-secondary">Test</button>
                </div>
            </div>

            <!-- LLM Key -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">LLM Provider</label>
                <select id="llm_provider" class="form-select mb-2">
                    <option value="openai">OpenAI (GPT-4o-mini)</option>
                    <option value="anthropic">Anthropic (Claude 3.5 Sonnet)</option>
                </select>
                <div class="flex gap-2">
                    <input type="password" id="llm_key" class="form-input flex-1" placeholder="Enter API key">
                    <button onclick="testApiKey('llm')" class="btn btn-secondary">Test</button>
                </div>
            </div>

            <!-- Firecrawl Key -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">Firecrawl Key</label>
                <div class="flex gap-2">
                    <input type="password" id="firecrawl_key" class="form-input flex-1" placeholder="Enter Firecrawl key">
                    <button onclick="testApiKey('firecrawl')" class="btn btn-secondary">Test</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Topic Setup -->
        <div class="step-content hidden" id="step2">
            <h2 class="text-2xl font-semibold mb-4">Set Up Your Topic</h2>
            <p class="mb-4">Configure your first monitoring topic.</p>

            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">Topic Type</label>
                <select id="topic_type" class="form-select" onchange="handleTopicTypeChange()">
                    <option value="custom">Create Custom Topic</option>
                    <option value="existing">Use Existing Topic</option>
                </select>
            </div>

            <!-- Custom Topic Form -->
            <div id="custom_topic_form">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Topic Name</label>
                    <input type="text" id="topic_name" class="form-input w-full" placeholder="Enter topic name">
                    <button onclick="suggestAttributes()" class="btn btn-secondary mt-2">Get Suggestions</button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Categories</label>
                    <div id="categories_container">
                        <input type="text" class="form-input w-full mb-2" placeholder="Add category">
                        <button onclick="addCategory()" class="btn btn-secondary">+ Add Category</button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Future Signals</label>
                    <div id="signals_container">
                        <input type="text" class="form-input w-full mb-2" placeholder="Add signal">
                        <button onclick="addSignal()" class="btn btn-secondary">+ Add Signal</button>
                    </div>
                </div>

                <!-- Default Attributes -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Sentiment</label>
                    <select multiple id="sentiment" class="form-multiselect w-full">
                        <option selected>Positive</option>
                        <option selected>Negative</option>
                        <option selected>Neutral</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Time to Impact</label>
                    <select multiple id="time_to_impact" class="form-multiselect w-full">
                        <option selected>Immediate (0-6 months)</option>
                        <option selected>Short-term (6-18 months)</option>
                        <option selected>Mid-term (18-60 months)</option>
                        <option selected>Long-term (60+ months)</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Drivers</label>
                    <select multiple id="drivers" class="form-multiselect w-full">
                        <option selected>Initiator</option>
                        <option selected>Accelerator</option>
                        <option selected>Catalyst</option>
                        <option selected>Inhibitor</option>
                        <option selected>Blocker</option>
                        <option selected>Terminator</option>
                        <option selected>Validator</option>
                    </select>
                </div>
            </div>

            <!-- Existing Topic Selection -->
            <div id="existing_topic_form" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Select Topic</label>
                    <select id="existing_topic" class="form-select w-full">
                        <!-- Will be populated via JavaScript -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Step 3: Keywords -->
        <div class="step-content hidden" id="step3">
            <h2 class="text-2xl font-semibold mb-4">Set Up Keywords</h2>
            <p class="mb-4">Add keywords to monitor for your topic.</p>

            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">Keywords</label>
                <div id="keywords_container">
                    <div class="flex gap-2 mb-2">
                        <input type="text" class="form-input flex-1" placeholder="Enter keyword or phrase">
                        <button onclick="removeKeyword(this)" class="btn btn-danger">Remove</button>
                    </div>
                </div>
                <button onclick="addKeyword()" class="btn btn-secondary">+ Add Keyword</button>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8">
            <button id="prevBtn" onclick="prevStep()" class="btn btn-secondary" disabled>Previous</button>
            <button id="nextBtn" onclick="nextStep()" class="btn btn-primary">Next</button>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 3;

// API Key Testing
async function testApiKey(keyType) {
    const key = document.getElementById(`${keyType}_key`).value;
    if (!key) {
        alert('Please enter an API key');
        return;
    }

    const provider = keyType === 'llm' ? document.getElementById('llm_provider').value : null;
    
    try {
        const response = await fetch('/api/onboarding/validate-api-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                key_type: keyType,
                api_key: key,
                provider: provider
            })
        });

        if (response.ok) {
            alert('API key is valid!');
        } else {
            const data = await response.json();
            alert(`Invalid API key: ${data.detail}`);
        }
    } catch (error) {
        alert('Error testing API key');
        console.error(error);
    }
}

// Topic Type Handling
function handleTopicTypeChange() {
    const type = document.getElementById('topic_type').value;
    document.getElementById('custom_topic_form').style.display = type === 'custom' ? 'block' : 'none';
    document.getElementById('existing_topic_form').style.display = type === 'existing' ? 'block' : 'none';
    
    if (type === 'existing') {
        loadExistingTopics();
    }
}

async function loadExistingTopics() {
    try {
        const response = await fetch('/api/topics');
        const topics = await response.json();
        
        const select = document.getElementById('existing_topic');
        select.innerHTML = topics.map(topic => 
            `<option value="${topic.name}">${topic.name}</option>`
        ).join('');
    } catch (error) {
        console.error('Error loading topics:', error);
    }
}

// Topic Attributes
async function suggestAttributes() {
    const topicName = document.getElementById('topic_name').value;
    if (!topicName) {
        alert('Please enter a topic name');
        return;
    }

    try {
        const response = await fetch('/api/onboarding/suggest-topic-attributes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ topic_name: topicName })
        });

        if (response.ok) {
            const suggestions = await response.json();
            
            // Clear existing categories and signals
            document.getElementById('categories_container').innerHTML = '';
            document.getElementById('signals_container').innerHTML = '';
            
            // Add suggested categories
            suggestions.categories.forEach(category => {
                addCategory(category);
            });
            
            // Add suggested signals
            suggestions.future_signals.forEach(signal => {
                addSignal(signal);
            });
            
            // Show explanation
            alert(suggestions.explanation);
        }
    } catch (error) {
        alert('Error getting suggestions');
        console.error(error);
    }
}

function addCategory(value = '') {
    const container = document.getElementById('categories_container');
    const div = document.createElement('div');
    div.className = 'flex gap-2 mb-2';
    div.innerHTML = `
        <input type="text" class="form-input flex-1" value="${value}" placeholder="Add category">
        <button onclick="this.parentElement.remove()" class="btn btn-danger">Remove</button>
    `;
    container.insertBefore(div, container.lastElementChild);
}

function addSignal(value = '') {
    const container = document.getElementById('signals_container');
    const div = document.createElement('div');
    div.className = 'flex gap-2 mb-2';
    div.innerHTML = `
        <input type="text" class="form-input flex-1" value="${value}" placeholder="Add signal">
        <button onclick="this.parentElement.remove()" class="btn btn-danger">Remove</button>
    `;
    container.insertBefore(div, container.lastElementChild);
}

// Keywords
function addKeyword() {
    const container = document.getElementById('keywords_container');
    const div = document.createElement('div');
    div.className = 'flex gap-2 mb-2';
    div.innerHTML = `
        <input type="text" class="form-input flex-1" placeholder="Enter keyword or phrase">
        <button onclick="this.parentElement.remove()" class="btn btn-danger">Remove</button>
    `;
    container.appendChild(div);
}

function removeKeyword(btn) {
    btn.parentElement.remove();
}

// Navigation
function updateStepDisplay() {
    document.querySelectorAll('.step-content').forEach((el, i) => {
        el.classList.toggle('hidden', i + 1 !== currentStep);
    });
    
    document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('active', i + 1 <= currentStep);
    });
    
    document.getElementById('prevBtn').disabled = currentStep === 1;
    document.getElementById('nextBtn').textContent = currentStep === totalSteps ? 'Finish' : 'Next';
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
    }
}

async function nextStep() {
    if (currentStep < totalSteps) {
        if (currentStep === 1) {
            // Validate API keys are set
            const newsapiKey = document.getElementById('newsapi_key').value;
            const llmKey = document.getElementById('llm_key').value;
            const firecrawlKey = document.getElementById('firecrawl_key').value;
            
            if (!newsapiKey || !llmKey || !firecrawlKey) {
                alert('Please set all required API keys');
                return;
            }
        } else if (currentStep === 2) {
            // Validate topic setup
            const topicType = document.getElementById('topic_type').value;
            if (topicType === 'custom') {
                const topicName = document.getElementById('topic_name').value;
                if (!topicName) {
                    alert('Please enter a topic name');
                    return;
                }
                
                // Save topic configuration
                await saveTopic();
            }
        }
        
        currentStep++;
        updateStepDisplay();
    } else {
        // Final step - save keywords and complete
        await saveKeywords();
        await completeOnboarding();
        window.location.href = '/';
    }
}

async function saveTopic() {
    const topicType = document.getElementById('topic_type').value;
    if (topicType === 'custom') {
        const topicData = {
            name: document.getElementById('topic_name').value,
            categories: Array.from(document.querySelectorAll('#categories_container input')).map(input => input.value),
            future_signals: Array.from(document.querySelectorAll('#signals_container input')).map(input => input.value),
            sentiment: Array.from(document.getElementById('sentiment').selectedOptions).map(option => option.value),
            time_to_impact: Array.from(document.getElementById('time_to_impact').selectedOptions).map(option => option.value),
            driver_types: Array.from(document.getElementById('drivers').selectedOptions).map(option => option.value)
        };
        
        try {
            const response = await fetch('/api/onboarding/save-topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(topicData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to save topic');
            }
        } catch (error) {
            alert('Error saving topic');
            console.error(error);
            throw error;
        }
    }
}

async function saveKeywords() {
    const keywords = Array.from(document.querySelectorAll('#keywords_container input')).map(input => input.value);
    const topicName = document.getElementById('topic_type').value === 'custom' 
        ? document.getElementById('topic_name').value 
        : document.getElementById('existing_topic').value;
        
    try {
        const response = await fetch('/api/keyword-monitor/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic: topicName,
                keywords: keywords
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to save keywords');
        }
    } catch (error) {
        alert('Error saving keywords');
        console.error(error);
        throw error;
    }
}

async function completeOnboarding() {
    try {
        const response = await fetch('/api/onboarding/complete', {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to complete onboarding');
        }
    } catch (error) {
        alert('Error completing onboarding');
        console.error(error);
        throw error;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateStepDisplay();
});
</script>

<style>
.step {
    flex: 1;
    text-align: center;
    position: relative;
}

.step:not(:last-child):after {
    content: '';
    position: absolute;
    top: 15px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: #e5e7eb;
}

.step.active:not(:last-child):after {
    background: #3b82f6;
}

.step-circle {
    width: 30px;
    height: 30px;
    background: #e5e7eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    color: #6b7280;
}

.step.active .step-circle {
    background: #3b82f6;
    color: white;
}

.step-label {
    color: #6b7280;
}

.step.active .step-label {
    color: #3b82f6;
}
</style>
{% endblock %} 